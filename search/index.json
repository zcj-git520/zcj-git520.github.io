[{"content":"æ·±å…¥æ¢ç´¢ LangGraph åœ¨äººå·¥æ™ºèƒ½å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œæ„å»ºèƒ½å¤Ÿè‡ªä¸»å†³ç­–ã€çµæ´»è°ƒç”¨å·¥å…·çš„æ™ºèƒ½ä»£ç†æˆä¸ºäº†è®¸å¤šå¼€å‘è€…çš„ç›®æ ‡ã€‚LangGraph ä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†æ„å»ºè¿™ç±»ä»£ç†çš„ç†æƒ³å·¥å…·ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ LangGraph çš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„è®¾è®¡ä»¥åŠå®é™…åº”ç”¨ï¼Œå¸®åŠ©ä½ å¿«é€ŸæŒæ¡è¿™ä¸€æ¡†æ¶çš„ä½¿ç”¨ã€‚\nä»€ä¹ˆæ˜¯ LangGraphï¼Ÿ LangGraph æ˜¯ä¸€ä¸ªåŸºäºå›¾è®ºçš„æ¡†æ¶ï¼Œç”¨äºæ„å»ºå…·æœ‰å¤æ‚å†³ç­–èƒ½åŠ›çš„æ™ºèƒ½ä»£ç†ã€‚å®ƒå…è®¸å¼€å‘è€…å°†ä»£ç†çš„è¡Œä¸ºå»ºæ¨¡ä¸ºä¸€ä¸ªçŠ¶æ€å›¾ï¼Œå…¶ä¸­åŒ…å«èŠ‚ç‚¹ï¼ˆä»£è¡¨è®¡ç®—æ­¥éª¤ï¼‰å’Œè¾¹ï¼ˆä»£è¡¨èŠ‚ç‚¹é—´çš„è¿æ¥ï¼‰ã€‚è¿™ç§ç»“æ„ä½¿å¾—ä»£ç†èƒ½å¤Ÿæ ¹æ®å½“å‰çŠ¶æ€åšå‡ºå†³ç­–ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·ï¼Œå¹¶åœ¨å¿…è¦æ—¶è°ƒæ•´å…¶è¡Œä¸ºã€‚\nä¸ä¼ ç»Ÿçš„çº¿æ€§å·¥ä½œæµä¸åŒï¼ŒLangGraph æä¾›çš„å›¾ç»“æ„èµ‹äºˆäº†ä»£ç†æ›´å¼ºçš„çµæ´»æ€§å’Œè‡ªä¸»æ€§ã€‚ä»£ç†å¯ä»¥æ ¹æ®è¾“å…¥åŠ¨æ€é€‰æ‹©æ‰§è¡Œè·¯å¾„ï¼Œå¤šæ¬¡è°ƒç”¨ä¸åŒå·¥å…·ï¼Œå¹¶åœ¨è·å¾—æ–°ä¿¡æ¯æ—¶è°ƒæ•´å…¶ç­–ç•¥ã€‚\nLangGraph çš„æ ¸å¿ƒæ¦‚å¿µ çŠ¶æ€ï¼ˆStateï¼‰ çŠ¶æ€æ˜¯ LangGraph ä¸­æœ€åŸºç¡€çš„æ¦‚å¿µï¼Œå®ƒè¡¨ç¤ºåº”ç”¨ç¨‹åºåœ¨æŸä¸€æ—¶åˆ»çš„å¿«ç…§ã€‚çŠ¶æ€é€šå¸¸å®šä¹‰ä¸ºä¸€ä¸ª TypedDict æˆ– Pydantic æ¨¡å‹ï¼ŒåŒ…å«ä»£ç†åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦è·Ÿè¸ªçš„æ‰€æœ‰ä¿¡æ¯ã€‚\nclass State(TypedDict):\rmessages: Annotated[list, add_messages]\råœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„çŠ¶æ€ï¼ŒåªåŒ…å«ä¸€ä¸ª messages å­—æ®µï¼Œç”¨äºå­˜å‚¨å¯¹è¯å†å²ã€‚Annotated[list, add_messages] è¡¨ç¤ºè¿™ä¸ªå­—æ®µå°†ä½¿ç”¨ add_messages å½’çº¦å™¨ï¼Œè¿™æ„å‘³ç€æ–°æ¶ˆæ¯ä¼šè¢«æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯æ›¿æ¢æ•´ä¸ªåˆ—è¡¨ã€‚\nèŠ‚ç‚¹ï¼ˆNodesï¼‰ èŠ‚ç‚¹æ˜¯å›¾ä¸­çš„åŸºæœ¬å•ä½ï¼Œä»£è¡¨ä¸€ä¸ªè®¡ç®—æ­¥éª¤æˆ–çŠ¶æ€è½¬æ¢ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥ï¼Œæ‰§è¡ŒæŸäº›æ“ä½œï¼Œå¹¶è¿”å›æ›´æ–°åçš„çŠ¶æ€ã€‚\ndef node(state: State):\rmessages = state[\u0026quot;messages\u0026quot;]\rresponse = model.qwen_llm().invoke(messages)\rreturn {\u0026quot;messages\u0026quot;: [response]}\rè¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªç®€å•çš„èŠ‚ç‚¹ï¼Œå®ƒæ¥æ”¶å½“å‰çŠ¶æ€ä¸­çš„æ¶ˆæ¯ï¼Œè°ƒç”¨è¯­è¨€æ¨¡å‹ç”Ÿæˆå“åº”ï¼Œå¹¶å°†å“åº”æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­ã€‚\nLangGraph æ”¯æŒå¤šç§ç±»å‹çš„èŠ‚ç‚¹ï¼š\n  è®¡ç®—èŠ‚ç‚¹ï¼šæ‰§è¡Œè®¡ç®—æˆ–è½¬æ¢æ“ä½œ\n  æ¡ä»¶èŠ‚ç‚¹ï¼šæ ¹æ®çŠ¶æ€æ¡ä»¶æ‰§è¡Œä¸åŒè·¯å¾„\n  å·¥å…·èŠ‚ç‚¹ï¼šè°ƒç”¨å¤–éƒ¨å·¥å…·ï¼ˆå¦‚ APIã€æ•°æ®åº“ç­‰ï¼‰\n  è¾¹ï¼ˆEdgesï¼‰ è¾¹å®šä¹‰äº†å›¾ä¸­èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼Œæ§åˆ¶ç€ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚LangGraph æä¾›äº†å¤šç§ç±»å‹çš„è¾¹ï¼š\n æ™®é€šè¾¹ï¼šç›´æ¥ä»ä¸€ä¸ªèŠ‚ç‚¹è¿æ¥åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹  graph_builder.add_edge(\u0026quot;node_a\u0026quot;, \u0026quot;node_b\u0026quot;)\r æ¡ä»¶è¾¹ï¼šæ ¹æ®çŠ¶æ€åŠ¨æ€å†³å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹  graph_builder.add_conditional_edges(\r\u0026quot;chatbot\u0026quot;,\rtools_condition,\r)\r å…¥å£ç‚¹ï¼šæŒ‡å®šå›¾çš„èµ·å§‹èŠ‚ç‚¹  graph_builder.add_edge(START, \u0026quot;chatbot\u0026quot;)\rå½’çº¦å™¨ï¼ˆReducersï¼‰ å½’çº¦å™¨å†³å®šäº†å¦‚ä½•å°†èŠ‚ç‚¹è¿”å›çš„éƒ¨åˆ†çŠ¶æ€æ›´æ–°åˆå¹¶åˆ°æ•´ä½“çŠ¶æ€ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½’çº¦å™¨ä¼šè¦†ç›–ç°æœ‰çŠ¶æ€ï¼Œä½†æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å½’çº¦å™¨ä»¥å®ç°æ›´å¤æ‚çš„è¡Œä¸ºã€‚\nclass State(TypedDict):\rfoo: int\rbar: Annotated[list[str], add] # ä½¿ç”¨addå½’çº¦å™¨ï¼Œå°†æ–°å…ƒç´ æ·»åŠ åˆ°åˆ—è¡¨\rbaz: Annotated[str, replace] # ä½¿ç”¨replaceå½’çº¦å™¨ï¼Œæ›¿æ¢ç°æœ‰å€¼\ræ„å»ºä½ çš„ç¬¬ä¸€ä¸ª LangGraph åº”ç”¨ è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥äº†è§£å¦‚ä½•ä½¿ç”¨ LangGraph æ„å»ºä¸€ä¸ªç®€å•çš„æ™ºèƒ½ä»£ç†ã€‚è¿™ä¸ªä»£ç†èƒ½å¤Ÿè¿›è¡Œå¯¹è¯ï¼Œå¹¶åœ¨éœ€è¦æ—¶è°ƒç”¨ç»´åŸºç™¾ç§‘å’Œ IP åœ°å€è§£æå·¥å…·ã€‚\næ­¥éª¤ 1ï¼šå¯¼å…¥å¿…è¦çš„åº“ from langchain_community.tools import WikipediaQueryRun\rfrom langchain_community.utilities import WikipediaAPIWrapper\rfrom langchain_core.messages import HumanMessage\rfrom langgraph.checkpoint.memory import MemorySaver\rfrom langgraph.constants import START\rfrom langgraph.graph import StateGraph\rfrom langgraph.graph.message import add_messages\rfrom langgraph.prebuilt import ToolNode, tools_condition\rfrom sqlalchemy.sql.annotation import Annotated\rfrom typing_extensions import TypedDict\ræ­¥éª¤ 2ï¼šå®šä¹‰çŠ¶æ€ class State(TypedDict):\rmessages: Annotated[list, add_messages]\ræ­¥éª¤ 3ï¼šå®šä¹‰èŠ‚ç‚¹ def node(state: State):\rmessages = state[\u0026quot;messages\u0026quot;]\rresponse = model.qwen_llm().invoke(messages)\rreturn {\u0026quot;messages\u0026quot;: [response]}\ræ­¥éª¤ 4ï¼šå®šä¹‰å·¥å…· def tools():\rapi_wrapper = WikipediaAPIWrapper(top_k_results=1, doc_content_chars_max=100)\rtool = WikipediaQueryRun(api_wrapper=api_wrapper)\rreturn [tool, ip_to_city_tool]\ræ­¥éª¤ 5ï¼šæ„å»ºå›¾ def buildGraph():\rgraph_builder = StateGraph(State)\rmemory = MemorySaver()\rgraph_builder.add_node(\u0026quot;chatbot\u0026quot;, node)\rtool_node = ToolNode(tools=tools())\rgraph_builder.add_conditional_edges(\r\u0026quot;chatbot\u0026quot;,\rtools_condition,\r)\rgraph_builder.add_node(\u0026quot;tools\u0026quot;, tool_node)\rgraph_builder.add_edge(START, \u0026quot;chatbot\u0026quot;)\rgraph = graph_builder.compile(checkpointer=memory)\rtry:\rgraph.get_graph().draw_mermaid_png(output_file_path=\u0026quot;graph.png\u0026quot;, max_retries=5, retry_delay=2.0)\rexcept Exception as e:\rprint(f\u0026quot;æ¸²æŸ“å›¾è¡¨å¤±è´¥: {e}\u0026quot;)\rreturn graph\ræ­¥éª¤ 6ï¼šè¿è¡Œå¯¹è¯ def chat(graph, msg):\rmessage = {\u0026quot;messages\u0026quot;: [HumanMessage(content=msg)]}\rfor event in graph.stream(message):\rfor value in event.values():\rprint(\u0026quot;Assistant:\u0026quot;, value[\u0026quot;messages\u0026quot;][-1].content)\rä»£ç†æ¶æ„ï¼šè¶…è¶Šç®€å•è·¯ç”± LangGraph å…è®¸æˆ‘ä»¬æ„å»ºçœŸæ­£çš„æ™ºèƒ½ä»£ç†ï¼Œè¿™äº›ä»£ç†èƒ½å¤Ÿï¼š\n  åœ¨å¤šæ¡æ½œåœ¨è·¯å¾„ä¹‹é—´è¿›è¡Œè·¯ç”±ï¼šæ ¹æ®è¾“å…¥å’Œå½“å‰çŠ¶æ€é€‰æ‹©æœ€ä½³æ‰§è¡Œè·¯å¾„\n  å†³å®šè°ƒç”¨ä¼—å¤šå·¥å…·ä¸­çš„å“ªä¸€ä¸ªï¼šæ ¹æ®ä»»åŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·\n  åˆ¤æ–­ç”Ÿæˆçš„ç­”æ¡ˆæ˜¯å¦è¶³å¤Ÿï¼šå†³å®šæ˜¯ç›´æ¥å›ç­”è¿˜æ˜¯éœ€è¦è¿›ä¸€æ­¥çš„ä¿¡æ¯æ”¶é›†\n  è¿™ç§æ¶æ„è¶…è¶Šäº†ç®€å•çš„è·¯ç”±æœºåˆ¶ï¼Œå®ç°äº†çœŸæ­£çš„è‡ªä¸»å†³ç­–èƒ½åŠ›ã€‚\nReAct æ¶æ„ ReAct æ˜¯ä¸€ç§æµè¡Œçš„ä»£ç†æ¶æ„ï¼Œå®ƒç»“åˆäº†ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š\n  å·¥å…·è°ƒç”¨ï¼šå…è®¸ LLM æ ¹æ®éœ€è¦é€‰æ‹©å’Œä½¿ç”¨å„ç§å·¥å…·\n  è®°å¿†ï¼šä½¿ä»£ç†èƒ½å¤Ÿä¿ç•™å’Œä½¿ç”¨æ¥è‡ªå…ˆå‰æ­¥éª¤çš„ä¿¡æ¯\n  è§„åˆ’ï¼šä½¿ LLM èƒ½å¤Ÿåˆ›å»ºå¹¶éµå¾ªå¤šæ­¥è®¡åˆ’ä»¥å®ç°ç›®æ ‡\n  LangGraph å®Œç¾æ”¯æŒ ReAct æ¶æ„ï¼Œé€šè¿‡çŠ¶æ€ç®¡ç†å®ç°è®°å¿†ï¼Œé€šè¿‡æ¡ä»¶è¾¹å®ç°å·¥å…·é€‰æ‹©å’Œè§„åˆ’ã€‚\né«˜çº§ç‰¹æ€§ å¹¶è¡Œæ‰§è¡Œ LangGraph æ”¯æŒèŠ‚ç‚¹çš„å¹¶è¡Œæ‰§è¡Œï¼Œè¿™å¯ä»¥æ˜¾è‘—æé«˜å¤æ‚å·¥ä½œæµçš„æ•ˆç‡ã€‚é€šè¿‡ä»ä¸€ä¸ªèŠ‚ç‚¹æ‰‡å‡ºåˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œç„¶åå†æ‰‡å…¥åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚\n# æ‰‡å‡ºåˆ°èŠ‚ç‚¹Bå’ŒCï¼Œç„¶åæ‰‡å…¥åˆ°èŠ‚ç‚¹D\rgraph_builder.add_edge(\u0026quot;A\u0026quot;, \u0026quot;B\u0026quot;)\rgraph_builder.add_edge(\u0026quot;A\u0026quot;, \u0026quot;C\u0026quot;)\rgraph_builder.add_edge(\u0026quot;B\u0026quot;, \u0026quot;D\u0026quot;)\rgraph_builder.add_edge(\u0026quot;C\u0026quot;, \u0026quot;D\u0026quot;)\rèŠ‚ç‚¹ç¼“å­˜ å¯¹äºè®¡ç®—å¯†é›†å‹èŠ‚ç‚¹ï¼ŒLangGraph æä¾›äº†ç¼“å­˜åŠŸèƒ½ï¼Œå¯ä»¥é¿å…é‡å¤è®¡ç®—ï¼š\nfrom langgraph.pregel import CachePolicy\rbuilder.add_node(\u0026quot;expensive_node\u0026quot;, expensive_node, cache_policy=CachePolicy(ttl=300)) # ç¼“å­˜5åˆ†é’Ÿ\rgraph = builder.compile(cache=InMemoryCache())\ré€’å½’é™åˆ¶ ä¸ºäº†é˜²æ­¢æ— é™å¾ªç¯ï¼ŒLangGraph æä¾›äº†é€’å½’é™åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥è®¾ç½®å›¾åœ¨å•æ¬¡æ‰§è¡ŒæœŸé—´å¯ä»¥æ‰§è¡Œçš„æœ€å¤§æ­¥éª¤æ•°ï¼š\ngraph.invoke(inputs, config={\u0026quot;recursion_limit\u0026quot;: 10}) # é™åˆ¶ä¸º10æ­¥\rè¿è¡Œæ—¶é…ç½® LangGraph å…è®¸åœ¨è¿è¡Œæ—¶é…ç½®å›¾çš„è¡Œä¸ºï¼Œä¾‹å¦‚æŒ‡å®šä½¿ç”¨å“ªä¸ªè¯­è¨€æ¨¡å‹ï¼š\nclass ConfigSchema(TypedDict):\rllm: str\rgraph = StateGraph(State, config_schema=ConfigSchema)\r# è°ƒç”¨æ—¶æŒ‡å®šé…ç½®\rgraph.invoke(inputs, config={\u0026quot;configurable\u0026quot;: {\u0026quot;llm\u0026quot;: \u0026quot;gpt-4\u0026quot;}})\ræ€»ç»“ LangGraph ä¸ºæ„å»ºå¤æ‚çš„æ™ºèƒ½ä»£ç†æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„æ¡†æ¶ã€‚é€šè¿‡å°†ä»£ç†è¡Œä¸ºå»ºæ¨¡ä¸ºçŠ¶æ€å›¾ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºèƒ½å¤Ÿè‡ªä¸»å†³ç­–ã€çµæ´»è°ƒç”¨å·¥å…·çš„æ™ºèƒ½ç³»ç»Ÿã€‚æ— è®ºæ˜¯ç®€å•çš„å¯¹è¯ä»£ç†è¿˜æ˜¯å¤æ‚çš„å¤šæ­¥éª¤å·¥ä½œæµï¼ŒLangGraph éƒ½èƒ½æä¾›æ¸…æ™°çš„ç»“æ„å’Œå¼ºå¤§çš„åŠŸèƒ½æ”¯æŒã€‚\né€šè¿‡æœ¬æ–‡çš„ä»‹ç»ï¼Œä½ åº”è¯¥å¯¹ LangGraph çš„æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•æœ‰äº†åŸºæœ¬çš„äº†è§£ã€‚æ¥ä¸‹æ¥ï¼Œä¸å¦¨å°è¯•ä½¿ç”¨ LangGraph æ„å»ºä¸€ä¸ªå±äºä½ è‡ªå·±çš„æ™ºèƒ½ä»£ç†ï¼Œæ¢ç´¢æ›´å¤šé«˜çº§ç‰¹æ€§å’Œåº”ç”¨åœºæ™¯ã€‚\nä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-06-30T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-langgraph/1_huba2bd994f0da4e171194ad980a76e763_1196516_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-langgraph/","title":"æ·±å…¥æ¢ç´¢ LangGraph"},{"content":"LangGraph é¢„æ„å»º Agent æ™ºèƒ½ä»£ç†ï¼ˆAgentï¼‰ç³»ç»Ÿå·²æˆä¸ºè¿æ¥ç”¨æˆ·ä¸å¤æ‚åŠŸèƒ½çš„é‡è¦æ¡¥æ¢ã€‚LangGraph ä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œä¸ºå¼€å‘è€…æä¾›äº†æ„å»ºå¥å£®ã€å¯æŠ•å…¥ç”Ÿäº§çš„ä»£ç†ç³»ç»Ÿçš„ä¸°å¯Œå·¥å…·ã€‚\nä¸€ã€Agent æ ¸å¿ƒç»„ä»¶è§£æ LangGraph é¢„æ„å»ºçš„ Agent ç”±ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†æ„æˆï¼Œå®ƒä»¬ååŒå·¥ä½œï¼Œä½¿ Agent èƒ½å¤Ÿç†è§£ç”¨æˆ·éœ€æ±‚ã€æ‰§è¡Œä»»åŠ¡å¹¶è¿”å›ç»“æœï¼š\n1.å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰\nè¿™æ˜¯ Agent çš„ \u0026ldquo;å¤§è„‘\u0026rdquo;ï¼Œè´Ÿè´£ç†è§£æ–‡æœ¬ã€ç”Ÿæˆå“åº”å¹¶å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚LLM åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¿è¡Œï¼šæ¯æ¬¡è¿­ä»£ä¸­é€‰æ‹©å·¥å…·ã€æä¾›è¾“å…¥ã€æ¥æ”¶ç»“æœï¼ˆè§‚å¯Ÿï¼‰ï¼Œå¹¶æ ¹æ®è§‚å¯ŸæŒ‡å¯¼ä¸‹ä¸€ä¸ªåŠ¨ä½œï¼Œç›´åˆ°æ”¶é›†åˆ°è¶³å¤Ÿä¿¡æ¯å“åº”ç”¨æˆ·ã€‚\n2.å·¥å…·ï¼ˆToolsï¼‰\nå·¥å…·æ˜¯ Agent å¯ä»¥è°ƒç”¨çš„å‡½æ•°æˆ– APIï¼Œç”¨äºæ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚ä¾‹å¦‚ï¼š\n  ç½‘ç»œæœç´¢å·¥å…·\n  æ•°æ®åº“æŸ¥è¯¢å·¥å…·\n  ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨å·¥å…·ï¼ˆå¦‚å¤©æ°”æŸ¥è¯¢ã€IP è§£æç­‰ï¼‰\n  å·¥å…·ä½¿ Agent èƒ½å¤Ÿçªç ´è‡ªèº«çŸ¥è¯†å±€é™ï¼Œè·å–å®æ—¶ä¿¡æ¯æˆ–æ‰§è¡Œå¤æ‚æ“ä½œã€‚\n3.æç¤ºï¼ˆPromptï¼‰\næç¤ºæ˜¯æŒ‡å¯¼ LLM è¡Œä¸ºçš„æ–‡æœ¬æŒ‡ä»¤ã€‚å®ƒå®šä¹‰äº† Agent çš„è§’è‰²ã€ç›®æ ‡å’Œè¡Œä¸ºå‡†åˆ™ã€‚ä¾‹å¦‚ï¼š\u0026ldquo;ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å°åŠ©æ‰‹ï¼Œèƒ½å¤Ÿä½¿ç”¨å·¥å…·å¸®åŠ©ç”¨æˆ·æŸ¥è¯¢å¤©æ°”å’ŒåŸå¸‚ä¿¡æ¯\u0026rdquo;ã€‚\näºŒã€LangGraph çš„æ ¸å¿ƒä¼˜åŠ¿ LangGraph ä¸ºæ„å»º Agent ç³»ç»Ÿæä¾›äº†å¤šé¡¹å…³é”®åŠŸèƒ½ï¼Œä½¿å…¶åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­è¡¨ç°å‡ºè‰²ï¼š\n  å†…å­˜é›†æˆï¼šåŒæ—¶æ”¯æŒçŸ­æœŸï¼ˆä¼šè¯å†…ï¼‰å’Œé•¿æœŸï¼ˆè·¨ä¼šè¯ï¼‰å†…å­˜ï¼Œå®ç°æœ‰çŠ¶æ€è¡Œä¸ºï¼Œè®© Agent èƒ½å¤Ÿè®°ä½å†å²å¯¹è¯å’Œç”¨æˆ·åå¥½ã€‚\n  äººåœ¨å›è·¯æ§åˆ¶ï¼šå…è®¸æ‰§è¡Œè¿‡ç¨‹åœ¨ä»»ä½•ç‚¹æš‚åœï¼Œç­‰å¾…äººå·¥åé¦ˆæˆ–å®¡æ‰¹ï¼Œæ”¯æŒå¼‚æ­¥å¹²é¢„ï¼Œè¿™å¯¹äºéœ€è¦äººå·¥ç¡®è®¤çš„æ•æ„Ÿæ“ä½œè‡³å…³é‡è¦ã€‚\n  æµå¼ä¼ è¾“æ”¯æŒï¼šèƒ½å¤Ÿå®æ—¶æµå¼ä¼ è¾“ Agent çŠ¶æ€ã€æ¨¡å‹è¾“å‡ºå’Œå·¥å…·ç»“æœï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚\n  éƒ¨ç½²å·¥å…·ï¼šæä¾›å®Œæ•´çš„æµ‹è¯•ã€è°ƒè¯•å’Œéƒ¨ç½²å·¥å…·é“¾ï¼Œç®€åŒ–ä»å¼€å‘åˆ°ç”Ÿäº§çš„æµç¨‹ã€‚\n  ä¸‰ã€åˆ›å»ºå’Œé…ç½® Agent ä½¿ç”¨ LangGraph åˆ›å»ºé¢„æ„å»º Agent éå¸¸ç®€å•ï¼Œä»¥ä¸‹æ˜¯åŸºæœ¬æ­¥éª¤ï¼š\n1. å®šä¹‰å·¥å…· é¦–å…ˆï¼Œéœ€è¦å®šä¹‰ Agent å¯ä»¥ä½¿ç”¨çš„å·¥å…·ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º IP è§£æã€å¤©æ°”æŸ¥è¯¢å’ŒåŸå¸‚æœç´¢å·¥å…·ï¼š\ntools = [ ip_to_city_tool, # è§£æIPè·å–åŸå¸‚ search_weather_tool, # æŸ¥è¯¢å¤©æ°” search_city_tool # æœç´¢åŸå¸‚ä¿¡æ¯ ] 2. åˆ›å»ºæç¤º å®šä¹‰æŒ‡å¯¼ Agent è¡Œä¸ºçš„æç¤ºï¼š\nfrom langchain_core.prompts import PromptTemplate prompt = PromptTemplate( input_variables=[], template=\u0026#34;ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å°åŠ©æ‰‹ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·æŸ¥è¯¢IPå¯¹åº”çš„åŸå¸‚ä»¥åŠåŸå¸‚çš„å¤©æ°”ä¿¡æ¯\u0026#34; ) 3. åˆå§‹åŒ– Agent ä½¿ç”¨ create_react_agent å‡½æ•°åˆ›å»º Agentï¼š\nfrom langgraph.prebuilt import create_react_agent\ragent = create_react_agent(\rmodel=model.qwen_llm(), # é…ç½®çš„è¯­è¨€æ¨¡å‹\rtools=tools, # ä¸Šé¢å®šä¹‰çš„å·¥å…·é›†\rprompt=prompt, # æç¤ºæ¨¡æ¿\rparallel_tool_calls=False # ç¦ç”¨å¹¶è¡Œå·¥å…·è°ƒç”¨\r)\rå››ã€è¿è¡Œ Agent çš„ä¸¤ç§æ¨¡å¼ LangGraph Agent æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œä»¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ï¼š\n1. åŒæ­¥æ¨¡å¼ ä½¿ç”¨ .invoke() æˆ– .stream() æ–¹æ³•ï¼š\n# åŒæ­¥è°ƒç”¨\rresult = agent.invoke({\r\u0026quot;messages\u0026quot;: [HumanMessage(content=\u0026quot;ä½ å¥½ï¼Œè¯·é—®æ­å·çš„å¤©æ°”å¦‚ä½•ï¼Ÿ\u0026quot;)]\r})\rprint(result)\r2. å¼‚æ­¥æ¨¡å¼ ä½¿ç”¨ await .ainvoke() æˆ– async for ä¸ .astream()ï¼š\n# å¼‚æ­¥è°ƒç”¨\rasync for event in agent.astream({\r\u0026quot;messages\u0026quot;: [HumanMessage(content=\u0026quot;ä½ å¥½ï¼Œè¯·é—®æ­å·çš„å¤©æ°”å¦‚ä½•ï¼Ÿ\u0026quot;)]\r}):\rprint(event)\räº”ã€è¾“å…¥ä¸è¾“å‡ºæ ¼å¼ è¾“å…¥æ ¼å¼ LangGraph Agent æ”¯æŒå¤šç§è¾“å…¥æ ¼å¼ï¼Œæä¾›çµæ´»æ€§ï¼š\n  å­—ç¬¦ä¸²ï¼š{\u0026ldquo;messages\u0026rdquo;: \u0026ldquo;Hello\u0026rdquo;}ï¼ˆè§£é‡Šä¸ºç”¨æˆ·æ¶ˆæ¯ï¼‰\n  æ¶ˆæ¯å­—å…¸ï¼š{\u0026ldquo;messages\u0026rdquo;: {\u0026ldquo;role\u0026rdquo;: \u0026ldquo;user\u0026rdquo;, \u0026ldquo;content\u0026rdquo;: \u0026ldquo;Hello\u0026rdquo;}}\n  æ¶ˆæ¯åˆ—è¡¨ï¼š{\u0026ldquo;messages\u0026rdquo;: [{\u0026ldquo;role\u0026rdquo;: \u0026ldquo;user\u0026rdquo;, \u0026ldquo;content\u0026rdquo;: \u0026ldquo;Hello\u0026rdquo;}]}\n  å¸¦è‡ªå®šä¹‰çŠ¶æ€ï¼š{\u0026ldquo;messages\u0026rdquo;: [\u0026hellip;], \u0026ldquo;user_name\u0026rdquo;: \u0026ldquo;Alice\u0026rdquo;}ï¼ˆé€‚ç”¨äºè‡ªå®šä¹‰çŠ¶æ€ï¼‰\n  è¾“å‡ºæ ¼å¼ Agent çš„è¾“å‡ºæ˜¯ä¸€ä¸ªåŒ…å«ä»¥ä¸‹é”®çš„å­—å…¸ï¼š\n  messagesï¼šæ‰§è¡ŒæœŸé—´çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨æˆ·è¾“å…¥ã€åŠ©æ‰‹å›å¤ã€å·¥å…·è°ƒç”¨ï¼‰\n  structured_responseï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœé…ç½®äº†ç»“æ„åŒ–è¾“å‡º\n  è‡ªå®šä¹‰å­—æ®µï¼ˆå¯é€‰ï¼‰ï¼šåŸºäºè‡ªå®šä¹‰çŠ¶æ€ schema å®šä¹‰çš„é¢å¤–é”®\n  å…­ã€æ§åˆ¶ Agent æ‰§è¡Œæµç¨‹ ä¸ºé¿å…æ— é™å¾ªç¯æˆ–å¤±æ§æ‰§è¡Œï¼ŒLangGraph æä¾›äº†å¤šç§æ§åˆ¶æœºåˆ¶ï¼š\n1. è®¾ç½®æœ€å¤§è¿­ä»£æ¬¡æ•° é€šè¿‡é…ç½®é€’å½’é™åˆ¶ï¼Œå®šä¹‰ Agent å¯æ‰§è¡Œçš„æœ€å¤§æ­¥éª¤æ•°ï¼š\n# è¿è¡Œæ—¶é…ç½®\rmax_iterations = 3\rrecursion_limit = 2 * max_iterations + 1\rresult = agent.invoke(\r{\u0026quot;messages\u0026quot;: [HumanMessage(content=\u0026quot;Hello\u0026quot;)]},\r{\u0026quot;recursion_limit\u0026quot;: recursion_limit}\r)\ræˆ–åœ¨åˆ›å»ºæ—¶é…ç½®ï¼š\nagent = create_react_agent(\rllm=model.qwen_llm(), tools=tools, prompt=prompt\r).with_config(recursion_limit=recursion_limit)\r2. å·¥å…·è°ƒç”¨æ§åˆ¶   ç¦ç”¨å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼šparallel_tool_calls=False\n  ç›´æ¥è¿”å›å·¥å…·ç»“æœï¼šåœ¨å·¥å…·å®šä¹‰ä¸­ä½¿ç”¨ return_direct=Trueï¼Œä½¿ Agent åœ¨å·¥å…·æ‰§è¡Œåç«‹å³åœæ­¢\n  å¼ºåˆ¶ä½¿ç”¨å·¥å…·ï¼šforce_tool=Trueï¼Œç¡®ä¿ Agent å¿…é¡»è°ƒç”¨å·¥å…·æ‰èƒ½å“åº”ï¼ˆéœ€é…åˆé˜²æŠ¤æªæ–½é¿å…æ— é™å¾ªç¯ï¼‰\n  ä¸ƒã€æµå¼ä¼ è¾“åŠŸèƒ½ æµå¼ä¼ è¾“æ˜¯æ„å»ºå“åº”å¼åº”ç”¨çš„å…³é”®ï¼ŒLangGraph æ”¯æŒå¤šç§æµå¼ä¼ è¾“ç±»å‹ï¼š\n1. Agent è¿›åº¦æµ è·å–æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåçš„æ›´æ–°ï¼š\nfor event in agent.stream(\r{\u0026quot;messages\u0026quot;: [HumanMessage(content=\u0026quot;ä½ å¥½\u0026quot;)]}, stream_mode=\u0026quot;updates\u0026quot;\r):\rprint(event)\rprint(\u0026quot;=\u0026quot;*20)\r2. LLM ä»¤ç‰Œæµ å®æ—¶è·å–è¯­è¨€æ¨¡å‹ç”Ÿæˆçš„ä»¤ç‰Œï¼š\nfor token, metadata in agent.stream(\r{\u0026quot;messages\u0026quot;: [HumanMessage(content=\u0026quot;è·å–è¿™ä¸ªipï¼š115.239.210.27çš„åŸå¸‚ä¿¡æ¯\u0026quot;)]}, stream_mode=\u0026quot;messages\u0026quot;\r):\rprint(\u0026quot;Token\u0026quot;, token)\rprint(\u0026quot;Metadata\u0026quot;, metadata)\rå…«ã€ä¸Šä¸‹æ–‡ç®¡ç† Agent é€šå¸¸éœ€è¦é™¤æ¶ˆæ¯ä¹‹å¤–çš„æ›´å¤šä¿¡æ¯æ‰èƒ½æœ‰æ•ˆå·¥ä½œï¼ŒLangGraph æä¾›äº†ä¸‰ç§ä¸Šä¸‹æ–‡ç®¡ç†æ–¹å¼ï¼š\n   ç±»å‹ æè¿° å¯å˜æ€§ ç”Ÿå‘½å‘¨æœŸ     é…ç½® è¿è¡Œå¼€å§‹æ—¶ä¼ å…¥çš„é™æ€æ•°æ® âŒ æ¯æ¬¡è¿è¡Œ   çŠ¶æ€ æ‰§è¡Œä¸­å¯æ›´æ”¹çš„åŠ¨æ€æ•°æ® âœ… æ¯æ¬¡è¿è¡Œæˆ–å¯¹è¯   é•¿æœŸè®°å¿† è·¨å¯¹è¯å…±äº«çš„æ•°æ® âœ… è·¨å¯¹è¯    1. é…ç½®ï¼ˆé™æ€ä¸Šä¸‹æ–‡ï¼‰ åœ¨è¿è¡Œæ—¶ä¼ å…¥ä¸å¯å˜æ•°æ®ï¼š\ndata = agent.invoke(\r{\u0026quot;messages\u0026quot;: [HumanMessage(content=\u0026quot;è·å–è¿™ä¸ªåŸå¸‚ä¿¡æ¯\u0026quot;)]},\rconfig={\u0026quot;configurable\u0026quot;: {\u0026quot;ip\u0026quot;: \u0026quot;115.239.210.27\u0026quot;}}\r)\r2. çŠ¶æ€ï¼ˆåŠ¨æ€ä¸Šä¸‹æ–‡ï¼‰ å®šä¹‰è‡ªå®šä¹‰çŠ¶æ€è·Ÿè¸ªé¢å¤–ä¿¡æ¯ï¼š\nclass CustomState(AgentState):\ruser_name: str # è·Ÿè¸ªç”¨æˆ·å\ragent = create_react_agent(\r# å…¶ä»–å‚æ•°...\rstate_schema=CustomState,\r)\r3. é•¿æœŸè®°å¿†ï¼ˆå­˜å‚¨ï¼‰ åœ¨å¯¹è¯ä¹‹é—´æŒä¹…åŒ–æ•°æ®ï¼š\nfrom langgraph.store.memory import InMemoryStore\r# åˆå§‹åŒ–å­˜å‚¨\rstore = InMemoryStore()\r# å­˜å‚¨ç”¨æˆ·ä¿¡æ¯\rstore.put(\r(\u0026quot;users\u0026quot;,),\r\u0026quot;user_123\u0026quot;,\r{\r\u0026quot;name\u0026quot;: \u0026quot;John Smith\u0026quot;,\r\u0026quot;language\u0026quot;: \u0026quot;English\u0026quot;,\r}\r)\r# åˆ›å»ºä½¿ç”¨å­˜å‚¨çš„Agent\ragent = create_react_agent(\rmodel=model.qwen_llm(),\rtools=tools,\rstore=store\r)\rä¹ã€äººæœºåä½œ LangGraph å†…ç½®äº†äººæœºåä½œï¼ˆHILï¼‰åŠŸèƒ½ï¼Œå…è®¸åœ¨ Agent æ‰§è¡Œè¿‡ç¨‹ä¸­åŠ å…¥äººå·¥å®¡æŸ¥æ­¥éª¤ï¼š\ndef book_hotel(hotel_name: str):\r# æš‚åœæ‰§è¡Œï¼Œç­‰å¾…äººå·¥å®¡æ‰¹\rresponse = interrupt(\rf\u0026quot;å°è¯•è°ƒç”¨ `book_hotel`ï¼Œå‚æ•°ä¸º {{'hotel_name': {hotel_name}}}ã€‚è¯·æ‰¹å‡†æˆ–å»ºè®®ä¿®æ”¹ã€‚\u0026quot;\r)\r# æ ¹æ®äººå·¥åé¦ˆç»§ç»­æ‰§è¡Œ\rif response[\u0026quot;type\u0026quot;] == \u0026quot;accept\u0026quot;:\rpass # æ‰§è¡Œé¢„è®¢\relif response[\u0026quot;type\u0026quot;] == \u0026quot;edit\u0026quot;:\rhotel_name = response[\u0026quot;args\u0026quot;][\u0026quot;hotel_name\u0026quot;] # ä½¿ç”¨ä¿®æ”¹åçš„å‚æ•°\relse:\rraise ValueError(f\u0026quot;æœªçŸ¥å“åº”ç±»å‹: {response['type']}\u0026quot;)\rreturn f\u0026quot;æˆåŠŸé¢„è®¢ {hotel_name} çš„ä½å®¿ã€‚\u0026quot;\rè¿™ç§æœºåˆ¶ä½¿ Agent èƒ½å¤Ÿåœ¨å…³é”®æ“ä½œå¤„æš‚åœï¼Œç­‰å¾…äººå·¥ç¡®è®¤ï¼Œå¤§å¤§æé«˜äº†ç³»ç»Ÿçš„å¯é æ€§å’Œå®‰å…¨æ€§ã€‚\nåã€å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ å¯¹äºå¤æ‚ä»»åŠ¡ï¼Œå•ä¸ª Agent å¯èƒ½éš¾ä»¥åº”å¯¹ï¼Œæ­¤æ—¶å¯ä»¥æ„å»ºå¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€‚LangGraph æ”¯æŒä¸¤ç§ä¸»è¦æ¶æ„ï¼š\n1. ä¸»ç®¡æ¶æ„ ç”±ä¸€ä¸ªä¸­å¤®ä¸»ç®¡ Agent åè°ƒå¤šä¸ªä¸“ä¸š Agentï¼š\nfrom langgraph_supervisor import create_supervisor\r# åˆ›å»ºä¸“ä¸šAgent\rsearch_city_agent = create_react_agent(...)\rweather_agent = create_react_agent(...)\rip_agent = create_react_agent(...)\r# åˆ›å»ºä¸»ç®¡Agent\rsupervisor = create_supervisor(\rmodel=model.qwen_llm(),\ragents=[search_city_agent, weather_agent, ip_agent],\rprompt=\u0026quot;ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ä½“åè°ƒå™¨ï¼Œæ ¹æ®ç”¨æˆ·é—®é¢˜è°ƒç”¨åˆé€‚çš„æ™ºèƒ½ä½“\u0026quot;\r).compile()\r2. ç¾¤ç»„æ¶æ„ Agent ä¹‹é—´æ ¹æ®ä¸“ä¸šæ€§åŠ¨æ€ç§»äº¤æ§åˆ¶æƒï¼š\nfrom langgraph.prebuilt import create_swarm\r# åˆ›å»ºå¤šä¸ªAgent\ragent1 = create_react_agent(...)\ragent2 = create_react_agent(...)\ragent3 = create_react_agent(...)\r# åˆ›å»ºç¾¤ç»„\rswarm = create_swarm(\ragents=[agent1, agent2, agent3],\rdefault_active_agent=\u0026quot;agent1\u0026quot; # é»˜è®¤æ¿€æ´»çš„Agent\r).compile()\rå¤šæ™ºèƒ½ä½“ç³»ç»Ÿé€šè¿‡ç§»äº¤ï¼ˆhandoffsï¼‰ æœºåˆ¶å®ç°é€šä¿¡ï¼Œä¸€ä¸ª Agent å¯ä»¥å°†æ§åˆ¶æƒç§»äº¤ç»™å¦ä¸€ä¸ª Agentï¼Œå¹¶ä¼ é€’å¿…è¦çš„ä¿¡æ¯ã€‚\næ€»ç»“ LangGraph é¢„æ„å»º Agent ä¸ºå¼€å‘è€…æä¾›äº†æ„å»ºå¼ºå¤§æ™ºèƒ½ä»£ç†ç³»ç»Ÿçš„ä¾¿æ·é€”å¾„ã€‚é€šè¿‡å…¶ä¸°å¯Œçš„åŠŸèƒ½ç‰¹æ€§ â€”â€” åŒ…æ‹¬çµæ´»çš„å·¥å…·é›†æˆã€å®Œå–„çš„ä¸Šä¸‹æ–‡ç®¡ç†ã€å¯é çš„æ‰§è¡Œæ§åˆ¶å’Œå¤šæ™ºèƒ½ä½“åä½œèƒ½åŠ› â€”â€” å¼€å‘è€…å¯ä»¥å¿«é€Ÿæ„å»ºå‡ºé€‚åº”å„ç§åœºæ™¯çš„æ™ºèƒ½åº”ç”¨ã€‚\næ— è®ºæ˜¯ç®€å•çš„ä¿¡æ¯æŸ¥è¯¢è¿˜æ˜¯å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡å¤„ç†ï¼ŒLangGraph éƒ½èƒ½æä¾›åšå®çš„æŠ€æœ¯æ”¯æŒï¼Œå¸®åŠ©ä½ æ‰“é€ é«˜æ•ˆã€å¯é ä¸”ç”¨æˆ·å‹å¥½çš„æ™ºèƒ½ç³»ç»Ÿã€‚\næƒ³è¦äº†è§£æ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥è®¿é—® LangGraph å®˜æ–¹æ–‡æ¡£ã€‚\nä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-06-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/langgraph%E9%A2%84%E6%9E%84%E5%BB%BAagent/1_hufc87676f5c03c42ba4fd49855ef25156_1205177_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/langgraph%E9%A2%84%E6%9E%84%E5%BB%BAagent/","title":"LangGraphé¢„æ„å»ºAgent"},{"content":"æ„å»ºæ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿï¼šåŸºäº Streamlit ä¸ LangChain çš„å®ç°æ–¹æ¡ˆ åœ¨ä¿¡æ¯çˆ†ç‚¸çš„æ—¶ä»£ï¼Œå¦‚ä½•é«˜æ•ˆç®¡ç†å’Œæ£€ç´¢æ–‡æ¡£ä¸­çš„çŸ¥è¯†æˆä¸ºä¸€é¡¹é‡è¦éœ€æ±‚ã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ä¸ªåŸºäº Streamlit å’Œ LangChain æ„å»ºçš„æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿæ”¯æŒå¤šç§æ ¼å¼æ–‡æ¡£çš„ä¸Šä¼ ã€è§£æä¸æ£€ç´¢ï¼Œèƒ½å¤Ÿé€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’ä¸ºç”¨æˆ·æä¾›ç²¾å‡†çš„çŸ¥è¯†é—®ç­”æœåŠ¡ã€‚\nç³»ç»Ÿæ¶æ„æ¦‚è§ˆ è¯¥æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¨¡å—æ„æˆï¼š\n ç”¨æˆ·ç•Œé¢å±‚ï¼šåŸºäº Streamlit æ„å»ºçš„ Web äº¤äº’ç•Œé¢ æ–‡æ¡£å¤„ç†å±‚ï¼šè´Ÿè´£è§£æå¤šç§æ ¼å¼çš„æ–‡æ¡£å†…å®¹ å‘é‡æ•°æ®åº“å±‚ï¼šä½¿ç”¨ ChromaDB å­˜å‚¨æ–‡æ¡£å‘é‡ï¼Œæ”¯æŒé«˜æ•ˆæ£€ç´¢ æ™ºèƒ½é—®ç­”å±‚ï¼šåŸºäº LangChain çš„ Agent æœºåˆ¶å®ç°é—®ç­”é€»è¾‘  ç³»ç»Ÿçš„æ ¸å¿ƒæµç¨‹æ˜¯ï¼šç”¨æˆ·ä¸Šä¼ æ–‡æ¡£ â†’ ç³»ç»Ÿè§£æå¹¶å­˜å‚¨æ–‡æ¡£å‘é‡ â†’ ç”¨æˆ·æé—® â†’ ç³»ç»Ÿæ£€ç´¢ç›¸å…³æ–‡æ¡£ â†’ ç”Ÿæˆå›ç­”ã€‚\n\r\næ ¸å¿ƒä»£ç è§£æ ç±»ç»“æ„è®¾è®¡ ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½å°è£…åœ¨KnowledgeBaseSystemç±»ä¸­ï¼Œè¯¥ç±»é€šè¿‡ç»„åˆæ¨¡å¼æ•´åˆäº†æ¨¡å‹ã€æ•°æ®åº“å’Œæ–‡æ¡£å¤„ç†å™¨ï¼š\nclass KnowledgeBaseSystem: def __init__(self, model, chromadb: ChromaDB, document_processor: Knowledge): self.chromadb = chromadb self.model = model self.document_processor = document_processor é¡µé¢é…ç½®ä¸åˆå§‹åŒ– setup_page_configæ–¹æ³•è´Ÿè´£åˆå§‹åŒ– Streamlit é¡µé¢é…ç½®å’Œä¼šè¯çŠ¶æ€ï¼š\ndef setup_page_config(self): \u0026#34;\u0026#34;\u0026#34;è®¾ç½®é¡µé¢é…ç½®\u0026#34;\u0026#34;\u0026#34; st.set_page_config( page_title=\u0026#34;æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ\u0026#34;, layout=\u0026#34;wide\u0026#34;, page_icon=\u0026#34;ğŸ“š\u0026#34; ) st.title(\u0026#34;ğŸ“š æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ\u0026#34;) st.sidebar.header(\u0026#34;æ–‡æ¡£ä¸Šä¼ \u0026#34;) # åˆå§‹åŒ–æˆ–é‡ç½®èŠå¤©è®°å½• if \u0026#34;messages\u0026#34; not in st.session_state or st.sidebar.button(\u0026#34;æ¸…ç©ºèŠå¤©è®°å½•\u0026#34;): st.session_state[\u0026#34;messages\u0026#34;] = [ { \u0026#34;role\u0026#34;: \u0026#34;assistant\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„çŸ¥è¯†æ£€ç´¢åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ\u0026#34; } ] æ–‡æ¡£ä¸Šä¼ ä¸å¤„ç† handle_file_uploadæ–¹æ³•å®ç°äº†å¤šæ ¼å¼æ–‡æ¡£çš„ä¸Šä¼ ä¸å¤„ç†åŠŸèƒ½ï¼Œæ”¯æŒ TXTã€PDFã€Wordã€Excelã€PPT å’Œå›¾ç‰‡ç­‰å¤šç§æ ¼å¼ï¼š\ndef handle_file_upload(self): \u0026#34;\u0026#34;\u0026#34;å¤„ç†æ–‡ä»¶ä¸Šä¼ \u0026#34;\u0026#34;\u0026#34; files = st.sidebar.file_uploader( label=\u0026#34;æ”¯æŒä¸Šä¼ TXTã€PDFã€Wordã€Excelã€PPTå’Œå›¾ç‰‡æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§200MB\u0026#34;, type=[\u0026#34;txt\u0026#34;, \u0026#34;pdf\u0026#34;, \u0026#34;docx\u0026#34;, \u0026#34;xlsx\u0026#34;, \u0026#34;pptx\u0026#34;, \u0026#34;png\u0026#34;, \u0026#34;jpg\u0026#34;, \u0026#34;jpeg\u0026#34;], accept_multiple_files=True ) if not files: return for file in files: try: # å¤„ç†æ–‡ä»¶å¹¶å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ file_type = file.name.split(\u0026#34;.\u0026#34;)[-1].lower() with tempfile.NamedTemporaryFile(delete=False, suffix=f\u0026#39;.{file_type}\u0026#39;) as tmp_file: tmp_file.write(file.getvalue()) tmp_file_path = tmp_file.name with st.spinner(f\u0026#34;æ­£åœ¨å¤„ç† {file.name}...\u0026#34;): documents = self.document_processor.load_files([tmp_file_path], file_type) self.chromadb.add(documents) st.sidebar.success(f\u0026#34;{file.name}ä¸Šä¼ æˆåŠŸ\u0026#34;) except Exception as e: st.sidebar.error(f\u0026#34;å¤„ç† {file.name}æ—¶å‡ºé”™: {str(e)}\u0026#34;) finally: # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ if os.path.exists(tmp_file_path): os.remove(tmp_file_path) è¿™æ®µä»£ç çš„å…³é”®åœ¨äºï¼š\n ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å¤„ç†ä¸Šä¼ çš„æ–‡æ¡£ é€šè¿‡æ–‡æ¡£å¤„ç†å™¨è§£æä¸åŒæ ¼å¼çš„æ–‡ä»¶ å°†è§£æåçš„æ–‡æ¡£å†…å®¹æ·»åŠ åˆ°å‘é‡æ•°æ®åº“ å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†  \r\næ™ºèƒ½é—®ç­”ä»£ç†çš„åˆ›å»º ç³»ç»Ÿçš„æ ¸å¿ƒæ™ºèƒ½é—®ç­”åŠŸèƒ½é€šè¿‡create_agentæ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•åˆ©ç”¨ LangChain æ„å»ºäº†ä¸€ä¸ªå…·æœ‰æ£€ç´¢èƒ½åŠ›çš„æ™ºèƒ½ä»£ç†ï¼š\ndef create_agent(self) -\u0026gt; AgentExecutor: \u0026#34;\u0026#34;\u0026#34;åˆ›å»ºä»£ç†æ‰§è¡Œå™¨\u0026#34;\u0026#34;\u0026#34; # åˆ›å»ºæ£€ç´¢å™¨ï¼Œè®¾ç½®è¿”å›3ä¸ªæœ€ç›¸å…³çš„ç»“æœ retriever = self.chromadb.as_retriever(search_kwargs={\u0026#34;k\u0026#34;: 3}) # åˆ›å»ºæ£€ç´¢å·¥å…· tool = create_retriever_tool( retriever, name=\u0026#34;çŸ¥è¯†åº“æ£€ç´¢\u0026#34;, description=\u0026#34;ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯æ¥å›ç­”é—®é¢˜\u0026#34; ) # è®¾ç½®èŠå¤©å†å²å­˜å‚¨ msgs = StreamlitChatMessageHistory() memory = ConversationBufferMemory( chat_memory=msgs, return_messages=True, memory_key=\u0026#34;chat_history\u0026#34;, output_key=\u0026#34;output\u0026#34; ) # å®šä¹‰ä»£ç†çš„æŒ‡ä»¤å’Œæç¤ºæ¨¡æ¿ instructions = \u0026#34;\u0026#34;\u0026#34; æ‚¨æ˜¯ä¸€ä¸ªè®¾è®¡ç”¨äºæŸ¥è¯¢æ£€ç´¢çŸ¥è¯†åº“å¹¶å›ç­”é—®é¢˜çš„ä»£ç†; æ‚¨å¯ä»¥ä½¿ç”¨æ£€ç´¢å·¥å…·ï¼Œå¹¶åŸºäºæ£€ç´¢å†…å®¹æ¥å›ç­”é—®é¢˜; æ‚¨å¯ä»¥é€šè¿‡ä¸æŸ¥è¯¢æ–‡æ¡£å°±çŸ¥é“ç­”æ¡ˆï¼Œä½†æ‚¨ä»ç„¶éœ€è¦é€šè¿‡æŸ¥è¯¢æ–‡æ¡£æ¥è·å–ç­”æ¡ˆ; å¦‚æœæ‚¨ä»æ–‡æ¡£ä¸­æ‰¾ä¸åˆ°ä»»ä½•ä¿¡æ¯ç”¨äºå›ç­”é—®é¢˜ï¼Œåˆ™åªéœ€è¿”å›â€œæŠ±æ­‰ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘è¿˜ä¸çŸ¥é“â€ä½œä¸ºç­”æ¡ˆã€‚ \u0026#34;\u0026#34;\u0026#34; # åˆ›å»ºæç¤ºæ¨¡æ¿ base_prompt_template = \u0026#34;\u0026#34;\u0026#34; {instructions}TOOLS: ------ You have access to the following tools: {tools}To use a tool,please use the following format: Thought: Do I need to use a tool? Yes Action: the action to take,should be one of [{tool_names}] Action Input: {input}Observations: the result of the action When you have a response to say to the Human,or if you do not need to use a tool,you MUST use the format: Thought: Do I need to use a tool: No Final Answer:[your response here] Begin! Previous conversation history: {chat_history}New input:{input}{agent_scratchpad}\u0026#34;\u0026#34;\u0026#34; base_prompt = PromptTemplate.from_template(template=base_prompt_template) prompt = base_prompt.partial(instructions=instructions) # åˆ›å»ºREACTä»£ç† agent = create_react_agent( self.model, [tool], prompt ) # è¿”å›ä»£ç†æ‰§è¡Œå™¨ return AgentExecutor( agent=agent, tools=[tool], memory=memory, verbose=True, handle_parsing_errors=True, max_iterations=5 ) è¿™æ®µä»£ç çš„æ ¸å¿ƒæ˜¯æ„å»ºäº†ä¸€ä¸ªåŸºäº REACT æ€ç»´é“¾çš„æ™ºèƒ½ä»£ç†ï¼Œå®ƒèƒ½å¤Ÿï¼š\n ä½¿ç”¨æ£€ç´¢å·¥å…·ä»çŸ¥è¯†åº“è·å–ç›¸å…³ä¿¡æ¯ ç»´æŠ¤å¯¹è¯å†å²ï¼Œæ”¯æŒä¸Šä¸‹æ–‡æ„ŸçŸ¥ éµå¾ªç‰¹å®šçš„æ€è€ƒå’Œè¡ŒåŠ¨æ ¼å¼ å¤„ç†è§£æé”™è¯¯å¹¶é™åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°  èŠå¤©äº¤äº’å¤„ç† handle_user_queryæ–¹æ³•å®ç°äº†ç”¨æˆ·è¾“å…¥çš„å¤„ç†å’Œå›ç­”çš„ç”Ÿæˆï¼š\ndef handle_user_query(self, agent_executor: AgentExecutor): \u0026#34;\u0026#34;\u0026#34;å¤„ç†ç”¨æˆ·æŸ¥è¯¢\u0026#34;\u0026#34;\u0026#34; user_query = st.chat_input(placeholder=\u0026#34;è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...\u0026#34;) if not user_query: return # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ä¼šè¯çŠ¶æ€å¹¶æ˜¾ç¤º st.session_state.messages.append({\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: user_query}) st.chat_message(\u0026#34;user\u0026#34;).write(user_query) # ç”Ÿæˆå¹¶æ˜¾ç¤ºå›ç­” with st.chat_message(\u0026#34;assistant\u0026#34;): st_cb = StreamlitCallbackHandler(st.container()) response = agent_executor.invoke( {\u0026#34;input\u0026#34;: user_query}, {\u0026#34;callbacks\u0026#34;: [st_cb]} ) answer = response.get(\u0026#34;output\u0026#34;, \u0026#34;æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚\u0026#34;) st.session_state.messages.append({\u0026#34;role\u0026#34;: \u0026#34;assistant\u0026#34;, \u0026#34;content\u0026#34;: answer}) st.write(answer) \r\nç³»ç»Ÿè¿è¡Œå…¥å£ runæ–¹æ³•ä½œä¸ºç³»ç»Ÿçš„å…¥å£ç‚¹ï¼Œåè°ƒå„ä¸ªæ¨¡å—çš„æ‰§è¡Œï¼š\ndef run(self): \u0026#34;\u0026#34;\u0026#34;è¿è¡ŒçŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ\u0026#34;\u0026#34;\u0026#34; self.setup_page_config() self.display_chat_history() self.handle_file_upload() try: agent_executor = self.create_agent() self.handle_user_query(agent_executor) except Exception as e: st.error(f\u0026#34;ç³»ç»Ÿé”™è¯¯: {str(e)}\u0026#34;) st.session_state.messages.append({ \u0026#34;role\u0026#34;: \u0026#34;assistant\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;æŠ±æ­‰ï¼Œç³»ç»Ÿå‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚\u0026#34; }) ç³»ç»Ÿå¯åŠ¨ä¸é…ç½® ä¸»ç¨‹åºé€šè¿‡ä»¥ä¸‹ä»£ç å¯åŠ¨ç³»ç»Ÿï¼š\nif __name__ == \u0026#39;__main__\u0026#39;: model_type = ModelType.QWEN config = Config(\u0026#34;conf/config.yml\u0026#34;) model = Model(config) chromadb = ChromaDB(config, model_type) document_processor = Knowledge() system = KnowledgeBaseSystem(model.qwen_llm(), chromadb, document_processor) system.run() è¿™é‡Œä½¿ç”¨äº† Qwen æ¨¡å‹ä½œä¸ºåŸºç¡€å¤§è¯­è¨€æ¨¡å‹ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œç³»ç»Ÿå‚æ•°çš„ç®¡ç†ï¼Œå¹¶åˆå§‹åŒ–äº†å‘é‡æ•°æ®åº“å’Œæ–‡æ¡£å¤„ç†å™¨ã€‚\nä»£ç ç¤ºä¾‹ import os import tempfile import streamlit as st from langchain.agents import AgentExecutor, create_react_agent from langchain.memory import ConversationBufferMemory from langchain_community.callbacks import StreamlitCallbackHandler from langchain_community.chat_message_histories import StreamlitChatMessageHistory from langchain_core.prompts import PromptTemplate from langchain_core.tools import create_retriever_tool from DB.chroma import ChromaDB from common.modeCommon import Model from config.config import Config from enums.model_enums import ModelType from knowledge import Knowledge class KnowledgeBaseSystem: def __init__(self, model, chromadb: ChromaDB, document_processor: Knowledge): self.chromadb = chromadb self.model = model self.document_processor = document_processor def setup_page_config(self): \u0026#34;\u0026#34;\u0026#34;è®¾ç½®é¡µé¢é…ç½®\u0026#34;\u0026#34;\u0026#34; st.set_page_config( page_title=\u0026#34;æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ\u0026#34;, layout=\u0026#34;wide\u0026#34;, page_icon=\u0026#34;ğŸ“š\u0026#34; ) st.title(\u0026#34;ğŸ“š æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ\u0026#34;) st.sidebar.header(\u0026#34;æ–‡æ¡£ä¸Šä¼ \u0026#34;) if \u0026#34;messages\u0026#34; not in st.session_state or st.sidebar.button(\u0026#34;æ¸…ç©ºèŠå¤©è®°å½•\u0026#34;): st.session_state[\u0026#34;messages\u0026#34;] = [ { \u0026#34;role\u0026#34;: \u0026#34;assistant\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„çŸ¥è¯†æ£€ç´¢åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ\u0026#34; } ] def display_chat_history(self): \u0026#34;\u0026#34;\u0026#34;æ˜¾ç¤ºèŠå¤©å†å²\u0026#34;\u0026#34;\u0026#34; # æ˜¾ç¤ºèŠå¤©å†å² for msg in st.session_state.messages: st.chat_message(msg[\u0026#34;role\u0026#34;]).write(msg[\u0026#34;content\u0026#34;]) def handle_file_upload(self): \u0026#34;\u0026#34;\u0026#34;å¤„ç†æ–‡ä»¶ä¸Šä¼ \u0026#34;\u0026#34;\u0026#34; files = st.sidebar.file_uploader( label=\u0026#34;æ”¯æŒä¸Šä¼ TXTã€PDFã€Wordã€Excelã€PPTå’Œå›¾ç‰‡æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§200MB\u0026#34;, # ä¸»æ ‡ç­¾æ”¹ä¸ºä¸­æ–‡ type=[\u0026#34;txt\u0026#34;, \u0026#34;pdf\u0026#34;, \u0026#34;docx\u0026#34;, \u0026#34;xlsx\u0026#34;, \u0026#34;pptx\u0026#34;, \u0026#34;png\u0026#34;, \u0026#34;jpg\u0026#34;, \u0026#34;jpeg\u0026#34;], # æ”¯æŒçš„æ–‡ä»¶ç±»å‹ accept_multiple_files=True, # å…è®¸ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ # help=\u0026#34;æ”¯æŒä¸Šä¼ TXTã€PDFã€Wordã€Excelã€PPTå’Œå›¾ç‰‡æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§200MB\u0026#34; # å¸®åŠ©æ–‡æœ¬æ”¹ä¸ºä¸­æ–‡ ) if not files: return for file in files: try: file_type = file.name.split(\u0026#34;.\u0026#34;)[-1].lower() with tempfile.NamedTemporaryFile(delete=False, suffix=f\u0026#39;.{file_type}\u0026#39;) as tmp_file: tmp_file.write(file.getvalue()) tmp_file_path = tmp_file.name with st.spinner(f\u0026#34;æ­£åœ¨å¤„ç† {file.name}...\u0026#34;): documents = self.document_processor.load_files([tmp_file_path], file_type) self.chromadb.add(documents) st.sidebar.success(f\u0026#34;{file.name}ä¸Šä¼ æˆåŠŸ\u0026#34;) except Exception as e: st.sidebar.error(f\u0026#34;å¤„ç† {file.name}æ—¶å‡ºé”™: {str(e)}\u0026#34;) finally: if os.path.exists(tmp_file_path): os.remove(tmp_file_path) def create_agent(self) -\u0026gt; AgentExecutor: \u0026#34;\u0026#34;\u0026#34;åˆ›å»ºä»£ç†æ‰§è¡Œå™¨\u0026#34;\u0026#34;\u0026#34; retriever = self.chromadb.as_retriever(search_kwargs={\u0026#34;k\u0026#34;: 3}) tool = create_retriever_tool( retriever, name=\u0026#34;çŸ¥è¯†åº“æ£€ç´¢\u0026#34;, description=\u0026#34;ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯æ¥å›ç­”é—®é¢˜\u0026#34; ) msgs = StreamlitChatMessageHistory() memory = ConversationBufferMemory( chat_memory=msgs, return_messages=True, memory_key=\u0026#34;chat_history\u0026#34;, output_key=\u0026#34;output\u0026#34; ) instructions = \u0026#34;\u0026#34;\u0026#34; æ‚¨æ˜¯ä¸€ä¸ªè®¾è®¡ç”¨äºæŸ¥è¯¢æ£€ç´¢çŸ¥è¯†åº“å¹¶å›ç­”é—®é¢˜çš„ä»£ç†; æ‚¨å¯ä»¥ä½¿ç”¨æ£€ç´¢å·¥å…·ï¼Œå¹¶åŸºäºæ£€ç´¢å†…å®¹æ¥å›ç­”é—®é¢˜; æ‚¨å¯ä»¥é€šè¿‡ä¸æŸ¥è¯¢æ–‡æ¡£å°±çŸ¥é“ç­”æ¡ˆï¼Œä½†æ‚¨ä»ç„¶éœ€è¦é€šè¿‡æŸ¥è¯¢æ–‡æ¡£æ¥è·å–ç­”æ¡ˆ; å¦‚æœæ‚¨ä»æ–‡æ¡£ä¸­æ‰¾ä¸åˆ°ä»»ä½•ä¿¡æ¯ç”¨äºå›ç­”é—®é¢˜ï¼Œåˆ™åªéœ€è¿”å›â€œæŠ±æ­‰ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘è¿˜ä¸çŸ¥é“â€ä½œä¸ºç­”æ¡ˆã€‚ \u0026#34;\u0026#34;\u0026#34; # åŸºç¡€æç¤ºæ¨¡æ¿ base_prompt_template = \u0026#34;\u0026#34;\u0026#34; {instructions}TOOLS: ------ You have access to the following tools: {tools}To use a tool,please use the following format: Thought: Do I need to use a tool? Yes Action: the action to take,should be one of [{tool_names}] Action Input: {input}Observations: the result of the action When you have a response to say to the Human,or if you do not need to use a tool,you MUST use the format: Thought: Do I need to use a tool: No Final Answer:[your response here] Begin! Previous conversation history: {chat_history}New input:{input}{agent_scratchpad}\u0026#34;\u0026#34;\u0026#34; # åˆ›å»ºåŸºç¡€æç¤ºè¯æ¨¡æ¿ base_prompt = PromptTemplate.from_template( template=base_prompt_template ) # åˆ›å»ºéƒ¨åˆ†å¡«å……çš„æç¤ºè¯æ¨¡æ¿ prompt = base_prompt.partial( instructions=instructions ) agent = create_react_agent( self.model, [tool], prompt ) return AgentExecutor( agent=agent, tools=[tool], memory=memory, verbose=True, handle_parsing_errors=True, max_iterations=5 ) def handle_user_query(self, agent_executor: AgentExecutor): \u0026#34;\u0026#34;\u0026#34;å¤„ç†ç”¨æˆ·æŸ¥è¯¢\u0026#34;\u0026#34;\u0026#34; user_query = st.chat_input(placeholder=\u0026#34;è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...\u0026#34;) if not user_query: return st.session_state.messages.append({\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: user_query}) st.chat_message(\u0026#34;user\u0026#34;).write(user_query) with st.chat_message(\u0026#34;assistant\u0026#34;): st_cb = StreamlitCallbackHandler(st.container()) response = agent_executor.invoke( {\u0026#34;input\u0026#34;: user_query}, {\u0026#34;callbacks\u0026#34;: [st_cb]} ) answer = response.get(\u0026#34;output\u0026#34;, \u0026#34;æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚\u0026#34;) st.session_state.messages.append({\u0026#34;role\u0026#34;: \u0026#34;assistant\u0026#34;, \u0026#34;content\u0026#34;: answer}) st.write(answer) def run(self): \u0026#34;\u0026#34;\u0026#34;è¿è¡ŒçŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ\u0026#34;\u0026#34;\u0026#34; self.setup_page_config() self.display_chat_history() self.handle_file_upload() try: agent_executor = self.create_agent() self.handle_user_query(agent_executor) except Exception as e: st.error(f\u0026#34;ç³»ç»Ÿé”™è¯¯: {str(e)}\u0026#34;) st.session_state.messages.append({ \u0026#34;role\u0026#34;: \u0026#34;assistant\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;æŠ±æ­‰ï¼Œç³»ç»Ÿå‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚\u0026#34; }) if __name__ == \u0026#39;__main__\u0026#39;: model_type = ModelType.QWEN config = Config(\u0026#34;conf/config.yml\u0026#34;) model = Model(config) chromadb = ChromaDB(config, model_type) document_processor = Knowledge() system = KnowledgeBaseSystem(model.qwen_llm(), chromadb, document_processor) system.run() ä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-06-02T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E6%99%BA%E8%83%BD%E7%9F%A5%E8%AF%86%E6%A3%80%E7%B4%A2%E7%B3%BB%E7%BB%9F/img_huecad56dbf45667eb4f21f35c2388c063_52872_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%99%BA%E8%83%BD%E7%9F%A5%E8%AF%86%E6%A3%80%E7%B4%A2%E7%B3%BB%E7%BB%9F/","title":"æ™ºèƒ½çŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ"},{"content":"æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ï¼šä»åŸç†åˆ°å·¥ç¨‹å®è·µçš„æ·±åº¦è§£æ åœ¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¿«é€Ÿè¿­ä»£çš„ä»Šå¤©ï¼Œå¦‚ä½•è®©æ¨¡å‹æ—¢å…·å¤‡é€šç”¨æ™ºèƒ½ï¼Œåˆèƒ½ç²¾å‡†è°ƒç”¨ç‰¹å®šé¢†åŸŸçŸ¥è¯†ï¼Œæˆä¸ºä¼ä¸šçº§ AI åº”ç”¨çš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼ŒRAGï¼‰æŠ€æœ¯é€šè¿‡ \u0026ldquo;æ£€ç´¢ + ç”Ÿæˆ\u0026rdquo; çš„ååŒæ¨¡å¼ï¼ŒæˆåŠŸè§£å†³äº†çº¯ LLM åœ¨çŸ¥è¯†æ—¶æ•ˆæ€§ã€å‡†ç¡®æ€§å’Œé¢†åŸŸé€‚é…æ€§ä¸Šçš„çŸ­æ¿ï¼Œæˆä¸ºè¿æ¥é€šç”¨ AI ä¸å‚ç›´ä¸šåŠ¡çš„å…³é”®æ¡¥æ¢ã€‚æœ¬æ–‡å°†ä»æŠ€æœ¯åŸç†å‡ºå‘ï¼Œç»“åˆå®æˆ˜ä»£ç ï¼Œå…¨é¢å‰–æ RAG çš„å®ç°è·¯å¾„ä¸å·¥ç¨‹å®è·µã€‚\nä¸€ã€RAG çš„åŸºæœ¬æ¦‚å¿µå’ŒåŸç† RAG æŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³æºäºä¿¡æ¯æ£€ç´¢ä¸è‡ªç„¶è¯­è¨€ç”Ÿæˆçš„èåˆï¼šåœ¨ç”Ÿæˆå›ç­”å‰ï¼Œå…ˆä»å¤–éƒ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢ä¸é—®é¢˜ç›¸å…³çš„äº‹å®æ€§ä¿¡æ¯ï¼Œå†è®©æ¨¡å‹åŸºäºè¿™äº› \u0026ldquo;è¯æ®\u0026rdquo; è¿›è¡Œæ¨ç†ç”Ÿæˆã€‚è¿™ç§æœºåˆ¶å°† LLM çš„ \u0026ldquo;é—­å·è€ƒè¯•\u0026rdquo; æ¨¡å¼è½¬å˜ä¸º \u0026ldquo;å¼€å·è€ƒè¯•\u0026rdquo;ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š\n çŸ¥è¯†æ—¶æ•ˆæ€§å±€é™ï¼šLLM è®­ç»ƒæ•°æ®å­˜åœ¨æˆªæ­¢æ—¥æœŸï¼Œæ— æ³•åº”å¯¹åŠ¨æ€æ›´æ–°çš„ä¸šåŠ¡çŸ¥è¯†ï¼ˆå¦‚ 2025 å¹´çš„æ–°æ³•è§„ã€ä¼ä¸šå†…éƒ¨æ–‡æ¡£æ›´æ–°ï¼‰ï¼› å¹»è§‰ç”Ÿæˆé£é™©ï¼šæ¨¡å‹å¯èƒ½ç¼–é€ ä¸å­˜åœ¨çš„äº‹å®ï¼ˆå¦‚è™šæ„äº§å“å‚æ•°ã€å­¦æœ¯å¼•ç”¨ï¼‰ï¼Œåœ¨åŒ»ç–—ã€æ³•å¾‹ç­‰é¢†åŸŸå¯èƒ½å¼•å‘ä¸¥é‡åæœï¼› é¢†åŸŸçŸ¥è¯†å£å’ï¼šé€šç”¨æ¨¡å‹å¯¹ä¸“ä¸šé¢†åŸŸï¼ˆå¦‚ç½‘ç»œå®‰å…¨ã€é‡‘èé£æ§ï¼‰çš„æ·±åº¦çŸ¥è¯†æŒæ¡ä¸è¶³ï¼Œéš¾ä»¥ç”Ÿæˆç²¾å‡†å›ç­”ã€‚  ä»æŠ€æœ¯æœ¬è´¨çœ‹ï¼ŒRAG æ˜¯ä¸€ç§æ··åˆå¢å¼ºæ¶æ„ï¼šé€šè¿‡æ£€ç´¢æ¨¡å—å°†å¤–éƒ¨çŸ¥è¯†å¼•å…¥ç”Ÿæˆè¿‡ç¨‹ï¼Œå½¢æˆ \u0026ldquo;çŸ¥è¯†è¾“å…¥ - æ¨¡å‹æ¨ç† - ç»“æœè¾“å‡º\u0026rdquo; çš„é—­ç¯ã€‚è¿™ç§æ¶æ„æ—¢ä¿ç•™äº† LLM çš„ä¸Šä¸‹æ–‡ç†è§£ä¸è‡ªç„¶è¯­è¨€ç”Ÿæˆèƒ½åŠ›ï¼Œåˆé€šè¿‡å¤–éƒ¨çŸ¥è¯†åº“å®ç°äº†çŸ¥è¯†çš„å¯æ§æ›´æ–°ä¸ç²¾å‡†è°ƒç”¨ã€‚\n\ræµç¨‹å›¾\r\nå¯ä»¥åŠ å¯†æ–‡æœ¬å—å’Œå‘é‡ï¼ˆå‘é‡ä¹Ÿå¯èƒ½æ³„éœ²åŸå§‹è¯­ä¹‰ï¼‰ï¼Œä»è€Œä½¿ç”¨å¯†æ–‡è¿›è¡Œå­˜å‚¨ä¸ç½‘ç»œä¼ è¾“ã€‚å¯¹äºå‘é‡åŠ å¯†éœ€é‡‡ç”¨ç‰¹æ®ŠåŠ å¯†ç®—æ³•ä½¿å¾—åŠ å¯†åå‘é‡ä»èƒ½è¿›è¡Œç›¸ä¼¼åº¦æ£€ç´¢ã€‚ \råŠ å¯†æµç¨‹å›¾\r\näºŒã€RAG çš„å·¥ä½œæµç¨‹ ä¸€ä¸ªå®Œæ•´çš„ RAG ç³»ç»Ÿå¯åˆ†ä¸ºç¦»çº¿çŸ¥è¯†åº“æ„å»ºä¸åœ¨çº¿é—®ç­”äº¤äº’ä¸¤å¤§é˜¶æ®µï¼ŒåŒ…å«äº”ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š\n1. ç¦»çº¿çŸ¥è¯†åº“æ„å»º  æ–‡æ¡£é‡‡é›†ï¼šæ”¶é›†ç»“æ„åŒ–ï¼ˆå¦‚ Excel è¡¨æ ¼ï¼‰ã€åŠç»“æ„åŒ–ï¼ˆå¦‚ PDF æ‰‹å†Œï¼‰å’Œéç»“æ„åŒ–ï¼ˆå¦‚å›¾ç‰‡ã€éŸ³é¢‘è½¬æ–‡æœ¬ï¼‰æ•°æ®ï¼› æ–‡æ¡£é¢„å¤„ç†ï¼šå¯¹åŸå§‹æ•°æ®è¿›è¡Œæ¸…æ´—ï¼ˆå»å™ªã€æ ¼å¼ç»Ÿä¸€ï¼‰ã€æ‹†åˆ†ï¼ˆæŒ‰è¯­ä¹‰å•å…ƒåˆ‡å‰²é•¿æ–‡æ¡£ï¼‰ï¼› å‘é‡ç¼–ç ï¼šé€šè¿‡åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰å°†æ–‡æœ¬ç‰‡æ®µè½¬åŒ–ä¸ºé«˜ç»´å‘é‡ï¼Œæ•æ‰è¯­ä¹‰ç‰¹å¾ï¼› å‘é‡å­˜å‚¨ï¼šå°†å‘é‡åŠå…³è”æ–‡æœ¬å­˜å…¥å‘é‡æ•°æ®åº“ï¼Œå»ºç«‹å¯æ£€ç´¢çš„çŸ¥è¯†ç´¢å¼•ã€‚  \r\n2. åœ¨çº¿é—®ç­”äº¤äº’  æŸ¥è¯¢ç†è§£ä¸æ£€ç´¢ï¼šå°†ç”¨æˆ·é—®é¢˜è½¬åŒ–ä¸ºå‘é‡ï¼Œåœ¨å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢æœ€ç›¸ä¼¼çš„æ–‡æœ¬ç‰‡æ®µï¼ˆTop-Kï¼‰ï¼› å¢å¼ºç”Ÿæˆï¼šå°†æ£€ç´¢åˆ°çš„æ–‡æœ¬ä½œä¸ºä¸Šä¸‹æ–‡è¾“å…¥ LLMï¼Œç”ŸæˆåŸºäºäº‹å®çš„å›ç­”ã€‚  \r\nè¿™ç§ \u0026ldquo;ç¦»çº¿å»ºåº“ + åœ¨çº¿è°ƒç”¨\u0026rdquo; çš„æ¨¡å¼ï¼Œæ—¢ä¿è¯äº†çŸ¥è¯†æ›´æ–°çš„çµæ´»æ€§ï¼ˆæ— éœ€é‡æ–°è®­ç»ƒæ¨¡å‹ï¼‰ï¼Œåˆç¡®ä¿äº†é—®ç­”çš„å®æ—¶æ€§ï¼ˆæ£€ç´¢ä¸ç”Ÿæˆå‡ä¸ºæ¯«ç§’çº§æ“ä½œï¼‰\nä¸‰ã€å®ç° RAG çš„å…³é”®æŠ€æœ¯ 1. æ–‡æ¡£åŠ è½½ï¼šå¤šæºæ•°æ®çš„ç»Ÿä¸€æ¥å…¥ æ–‡æ¡£åŠ è½½æ˜¯ RAG çš„å…¥å£ç¯èŠ‚ï¼Œéœ€æ”¯æŒå¤šç§æ ¼å¼æ–‡ä»¶çš„è§£æã€‚ç¤ºä¾‹ä»£ç ä¸­Knowledgeç±»é€šè¿‡loader_mappingå®ç°äº†å¤šç±»å‹æ–‡ä»¶çš„é€‚é…ï¼š\n# æ–‡ä»¶ç±»å‹ä¸åŠ è½½å™¨çš„æ˜ å°„å…³ç³» self.loader_mapping = { \u0026#34;txt\u0026#34;: TextLoader, \u0026#34;pdf\u0026#34;: PyMuPDFLoader, \u0026#34;docx\u0026#34;: Docx2txtLoader, \u0026#34;xlsx\u0026#34;: UnstructuredExcelLoader, \u0026#34;pptx\u0026#34;: UnstructuredPowerPointLoader, \u0026#34;image\u0026#34;: UnstructuredImageLoader, \u0026#34;default\u0026#34;: UnstructuredFileLoader } æŠ€æœ¯è¦ç‚¹ï¼š\n é’ˆå¯¹ PDF ä¼˜å…ˆé€‰æ‹©PyMuPDFLoaderï¼Œæ”¯æŒé«˜æ•ˆè§£æå¸¦æ ¼å¼æ–‡æœ¬ï¼› å›¾ç‰‡æ–‡ä»¶éœ€é…åˆ OCR æŠ€æœ¯ï¼ˆå¦‚UnstructuredImageLoaderï¼‰æå–æ–‡å­—ï¼› å¤§å‹æ–‡æ¡£ï¼ˆå¦‚æ•°ç™¾é¡µ PDFï¼‰éœ€å®ç°æµå¼åŠ è½½ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚  2. æ–‡æœ¬åˆ†å‰²ï¼šè¯­ä¹‰å®Œæ•´ä¸æ£€ç´¢æ•ˆç‡çš„å¹³è¡¡ é•¿æ–‡æ¡£ç›´æ¥ç¼–ç ä¼šå¯¼è‡´è¯­ä¹‰ç¨€é‡Šï¼Œéœ€æŒ‰è¯­ä¹‰å•å…ƒæ‹†åˆ†ã€‚ç¤ºä¾‹ä¸­ä½¿ç”¨RecursiveCharacterTextSplitterï¼š\nself.text_splitter = RecursiveCharacterTextSplitter( chunk_size=4000, # æ¯å—æœ€å¤§é•¿åº¦ chunk_overlap=500, # å—é—´é‡å éƒ¨åˆ†ï¼Œä¿è¯è¯­ä¹‰è¿è´¯æ€§ length_function=len ) åˆ†å‰²ç­–ç•¥ï¼š\n ä¼˜å…ˆæŒ‰è‡ªç„¶åˆ†éš”ç¬¦ï¼ˆæ®µè½ã€å¥å­ï¼‰æ‹†åˆ†ï¼Œé¿å…ç ´åè¯­ä¹‰ï¼› chunk_sizeéœ€æ ¹æ®åµŒå…¥æ¨¡å‹æœ€å¤§è¾“å…¥é•¿åº¦è°ƒæ•´ï¼ˆå¦‚ BERT ç±»æ¨¡å‹é€šå¸¸æ”¯æŒ 512 tokensï¼‰ï¼› é‡å éƒ¨åˆ†ï¼ˆchunk_overlapï¼‰å»ºè®®è®¾ç½®ä¸ºæ€»é•¿åº¦çš„ 10%-20%ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡æ–­è£‚ã€‚  3. å‘é‡æ•°æ®åº“ï¼šé«˜æ•ˆç›¸ä¼¼æ€§æ£€ç´¢ å‘é‡æ•°æ®åº“æ˜¯ RAG çš„ \u0026ldquo;å¤§è„‘\u0026rdquo;ï¼Œè´Ÿè´£å­˜å‚¨å‘é‡å¹¶æ”¯æŒå¿«é€Ÿè¿‘é‚»æ£€ç´¢ã€‚ç¤ºä¾‹ä¸­ChromaDBç±»å®ç°äº†å‘é‡åº“çš„åˆå§‹åŒ–ä¸æ“ä½œï¼š\n# åˆå§‹åŒ–Chromaå‘é‡æ•°æ®åº“ db = Chroma( collection_name=config.chroma_config().get(\u0026#34;collection_name\u0026#34;), client=HttpClient(host=host, port=port), embedding_function=DashScopeEmbeddings( model=embedding_model_name, dashscope_api_key=api_key ) ) é€‰å‹è€ƒé‡ï¼š\n è½»é‡çº§åœºæ™¯å¯é€‰ Chromaã€FAISSï¼ˆé€‚åˆå•æœºéƒ¨ç½²ï¼‰ï¼› å¤§è§„æ¨¡é›†ç¾¤åœºæ™¯æ¨è Milvusã€Weaviateï¼ˆæ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨ä¸æ°´å¹³æ‰©å±•ï¼‰ï¼› éœ€å…³æ³¨å‘é‡æ•°æ®åº“çš„ç´¢å¼•ç±»å‹ï¼ˆå¦‚ HNSWã€IVFï¼‰å¯¹æ£€ç´¢é€Ÿåº¦çš„å½±å“ã€‚  4. æ£€ç´¢ä¸ç”Ÿæˆï¼šç²¾å‡†æ€§ä¸æµç•…æ€§çš„ååŒ æ£€ç´¢é˜¶æ®µéœ€å¹³è¡¡å¬å›ç‡ä¸ç²¾ç¡®ç‡ï¼Œç”Ÿæˆé˜¶æ®µéœ€æ§åˆ¶æ¨¡å‹å¯¹æ£€ç´¢ç»“æœçš„ä¾èµ–åº¦ã€‚ç¤ºä¾‹ä¸­é€šè¿‡ä»¥ä¸‹æµç¨‹å®ç°ï¼š\n æ£€ç´¢ç¯èŠ‚ï¼š  # åŸºäºç”¨æˆ·æŸ¥è¯¢æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£ query = \u0026#34;å·²ç›‘å¬ç«¯å£\u0026#34; docs = chromadb.query(query) # å†…éƒ¨è°ƒç”¨similarity_search retriever = self.chromadb.as_retriever(search_kwargs={\u0026#34;k\u0026#34;: 5}) 2.ç”Ÿæˆç¯èŠ‚ï¼š\ntool = create_retriever_tool( retriever, name=\u0026#34;çŸ¥è¯†åº“æ£€ç´¢\u0026#34;, description=\u0026#34;ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯æ¥å›ç­”é—®é¢˜\u0026#34; ) instructions = \u0026#34;\u0026#34;\u0026#34; æ‚¨æ˜¯ä¸€ä¸ªè®¾è®¡ç”¨äºæŸ¥è¯¢æ£€ç´¢çŸ¥è¯†åº“å¹¶å›ç­”é—®é¢˜çš„ä»£ç†; æ‚¨å¯ä»¥ä½¿ç”¨æ£€ç´¢å·¥å…·ï¼Œå¹¶åŸºäºæ£€ç´¢å†…å®¹æ¥å›ç­”é—®é¢˜; æ‚¨å¯ä»¥é€šè¿‡ä¸æŸ¥è¯¢æ–‡æ¡£å°±çŸ¥é“ç­”æ¡ˆï¼Œä½†æ‚¨ä»ç„¶éœ€è¦é€šè¿‡æŸ¥è¯¢æ–‡æ¡£æ¥è·å–ç­”æ¡ˆ; å¦‚æœæ‚¨ä»æ–‡æ¡£ä¸­æ‰¾ä¸åˆ°ä»»ä½•ä¿¡æ¯ç”¨äºå›ç­”é—®é¢˜ï¼Œåˆ™åªéœ€è¿”å›â€œæŠ±æ­‰ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘è¿˜ä¸çŸ¥é“â€ä½œä¸ºç­”æ¡ˆã€‚ \u0026#34;\u0026#34;\u0026#34; # åŸºç¡€æç¤ºæ¨¡æ¿ base_prompt_template = \u0026#34;\u0026#34;\u0026#34; {instructions}TOOLS: ------ You have access to the following tools: {tools}To use a tool,please use the following format: Thought: Do I need to use a tool? Yes Action: the action to take,should be one of [{tool_names}] Action Input: {input}Observations: the result of the action When you have a response to say to the Human,or if you do not need to use a tool,you MUST use the format: Thought: Do I need to use a tool: No Final Answer:[your response here] Begin! Previous conversation history: {chat_history}New input:{input}{agent_scratchpad}\u0026#34;\u0026#34;\u0026#34; # åˆ›å»ºåŸºç¡€æç¤ºè¯æ¨¡æ¿ base_prompt = PromptTemplate.from_template( template=base_prompt_template ) # åˆ›å»ºéƒ¨åˆ†å¡«å……çš„æç¤ºè¯æ¨¡æ¿ prompt = base_prompt.partial( instructions=instructions ) agent = create_react_agent( self.model, [tool], prompt ) ä¼˜åŒ–æŠ€å·§ï¼š\n é‡‡ç”¨æ··åˆæ£€ç´¢ç­–ç•¥ï¼ˆå…³é”®è¯æ£€ç´¢ + å‘é‡æ£€ç´¢ï¼‰æå‡å¬å›ç‡ï¼› é€šè¿‡search_kwargs={\u0026quot;k\u0026quot;: 5}æ§åˆ¶è¿”å›çš„æ–‡æ¡£æ•°é‡ï¼ˆé€šå¸¸ 5-10 ç¯‡ä¸ºå®œï¼‰ï¼› ç”Ÿæˆé˜¶æ®µä½¿ç”¨æç¤ºè¯å·¥ç¨‹ï¼ˆå¦‚ \u0026ldquo;ä¸¥æ ¼åŸºäºæä¾›çš„ä¿¡æ¯å›ç­”ï¼Œä¸ç¼–é€ å†…å®¹\u0026rdquo;ï¼‰çº¦æŸæ¨¡å‹è¡Œä¸ºã€‚  å››ã€å®Œæ•´ä»£ç ç¤ºä¾‹  ragä»£ç ç¤ºä¾‹  \u0026#34;\u0026#34;\u0026#34; çŸ¥è¯†åº“ RAG \u0026#34;\u0026#34;\u0026#34; import logging from typing import Optional, List from langchain_community.document_loaders import PyMuPDFLoader, TextLoader, Docx2txtLoader, UnstructuredExcelLoader, \\ UnstructuredPowerPointLoader, UnstructuredImageLoader, UnstructuredFileLoader from langchain_core.tools import create_retriever_tool from langchain_text_splitters import RecursiveCharacterTextSplitter from DB.chroma import ChromaDB from config.config import Config from enums.model_enums import ModelType # é…ç½®æ—¥å¿— logging.basicConfig( level=logging.INFO, format=\u0026#39;%(asctime)s- %(name)s- %(levelname)s- %(message)s\u0026#39; ) logger = logging.getLogger(__name__) class Knowledge: \u0026#34;\u0026#34;\u0026#34;æ–‡æ¡£å¤„ç†å™¨ï¼Œè´Ÿè´£åŠ è½½å’Œå¤„ç†å„ç§ç±»å‹çš„æ–‡æ¡£\u0026#34;\u0026#34;\u0026#34; def __init__(self): # åˆå§‹åŒ–æ–‡æœ¬åˆ†å‰²å™¨ self.text_splitter = RecursiveCharacterTextSplitter( chunk_size=4000, # æ¯å—æœ€å¤§é•¿åº¦ chunk_overlap=500, # å—ä¹‹é—´çš„é‡å éƒ¨åˆ† length_function=len, is_separator_regex=False ) # æ–‡ä»¶ç±»å‹ä¸å¯¹åº”åŠ è½½å™¨çš„æ˜ å°„ self.loader_mapping = { \u0026#34;txt\u0026#34;: TextLoader, \u0026#34;pdf\u0026#34;: PyMuPDFLoader, \u0026#34;docx\u0026#34;: Docx2txtLoader, \u0026#34;xlsx\u0026#34;: UnstructuredExcelLoader, \u0026#34;xls\u0026#34;: UnstructuredExcelLoader, \u0026#34;pptx\u0026#34;: UnstructuredPowerPointLoader, \u0026#34;ppt\u0026#34;: UnstructuredPowerPointLoader, \u0026#34;image\u0026#34;: UnstructuredImageLoader, \u0026#34;png\u0026#34;: UnstructuredImageLoader, \u0026#34;jpg\u0026#34;: UnstructuredImageLoader, \u0026#34;jpeg\u0026#34;: UnstructuredImageLoader, \u0026#34;default\u0026#34;: UnstructuredFileLoader # é»˜è®¤åŠ è½½å™¨ } def clean_text(self, text: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;æ¸…ç†æ–‡æœ¬å†…å®¹\u0026#34;\u0026#34;\u0026#34; if not text: return \u0026#34;\u0026#34; # ç§»é™¤å¤šä½™çš„ç©ºæ ¼å’Œæ¢è¡Œ text = \u0026#34; \u0026#34;.join(text.split()) # æˆªæ–­è¶…é•¿æ–‡æœ¬ return text[:8000] if len(text) \u0026gt; 8000 else text def load_single_file(self, file_path: str, file_type: str) -\u0026gt; Optional[List]: \u0026#34;\u0026#34;\u0026#34;åŠ è½½å•ä¸ªæ–‡ä»¶\u0026#34;\u0026#34;\u0026#34; try: # è·å–åˆé€‚çš„åŠ è½½å™¨ loader_class = self.loader_mapping.get(file_type.lower(), self.loader_mapping[\u0026#34;default\u0026#34;]) # ç‰¹æ®Šå¤„ç†ï¼šæ–‡æœ¬æ–‡ä»¶éœ€è¦æŒ‡å®šç¼–ç  if file_type.lower() == \u0026#34;txt\u0026#34;: loader = loader_class(file_path, encoding=\u0026#34;utf-8\u0026#34;) else: loader = loader_class(file_path) return loader.load() except Exception as e: logger.error(f\u0026#34;åŠ è½½æ–‡ä»¶ {file_path}æ—¶å‡ºé”™: {str(e)}\u0026#34;) return None def split_documents(self, documents: List) -\u0026gt; List: \u0026#34;\u0026#34;\u0026#34;åˆ†å‰²æ–‡æ¡£\u0026#34;\u0026#34;\u0026#34; if not documents: return [] try: return self.text_splitter.split_documents(documents) except Exception as e: logger.error(f\u0026#34;åˆ†å‰²æ–‡æ¡£æ—¶å‡ºé”™: {str(e)}\u0026#34;) return documents # å¦‚æœåˆ†å‰²å¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æ¡£ def load_files(self, file_paths: List[str], file_type: str) -\u0026gt; List: \u0026#34;\u0026#34;\u0026#34;åŠ è½½å¹¶å¤„ç†å¤šä¸ªæ–‡ä»¶\u0026#34;\u0026#34;\u0026#34; all_documents = [] for file_path in file_paths: try: logger.info(f\u0026#34;æ­£åœ¨å¤„ç†æ–‡ä»¶: {file_path}\u0026#34;) documents = self.load_single_file(file_path, file_type) if documents: split_docs = self.split_documents(documents) all_documents.extend(split_docs) except Exception as e: logger.error(f\u0026#34;å¤„ç†æ–‡ä»¶ {file_path}æ—¶å‡ºé”™: {str(e)}\u0026#34;) continue return all_documents if __name__ == \u0026#34;__main__\u0026#34;: # files = [\u0026#34;D:\\work\\å®‰æœå·¥ä½œ\\å®‰æœèµ„æ–™\\ç¬¬2ç¯‡ï¼šLinuxå…¥ä¾µæ’æŸ¥.pdf\u0026#34;,\u0026#34;D:\\work\\å®‰æœå·¥ä½œ\\å®‰æœèµ„æ–™\\Webå®‰å…¨å¼€å‘æŒ‡å— ç”µå­ç‰ˆ.pdf\u0026#34;] # document_processor = Knowledge() # documents = document_processor.load_files(files, \u0026#34;pdf\u0026#34;) # print(documents) # #æ‰¹é‡å†™å…¥ config = Config(\u0026#39;conf/config.yml\u0026#39;) chromadb = ChromaDB(config, ModelType.QWEN) # chromadb.add(documents) # # å‘é‡æ•°æ®åº“æŸ¥è¯¢ # query = \u0026#34;å·²ç›‘å¬ç«¯â¼ \u0026#34; # docs = chromadb.query(query) # for doc in docs: # print(doc) retriever = chromadb.as_retriever(search_kwargs={\u0026#34;k\u0026#34;: 3}) tool = create_retriever_tool( retriever, name=\u0026#34;çŸ¥è¯†åº“æ£€ç´¢\u0026#34;, description=\u0026#34;ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯æ¥å›ç­”é—®é¢˜\u0026#34; )  chromaå‘é‡æ•°æ®åº“ä»£ç ç¤ºä¾‹  # chromaå‘é‡æ•°æ®åº“ from chromadb import HttpClient from langchain_chroma import Chroma from langchain_community.embeddings import DashScopeEmbeddings from config.config import Config from enums.model_enums import ModelType class ChromaDB: def __init__(self, config: Config, model_type: ModelType): self.config = config try: client = HttpClient(host=config.chroma_config().get(\u0026#34;host\u0026#34;), port=config.chroma_config().get(\u0026#34;port\u0026#34;)) embedding = DashScopeEmbeddings( model=config.model_config(model_type).get(\u0026#34;embeddingModelName\u0026#34;), dashscope_api_key=config.model_config(model_type).get(\u0026#34;apiKey\u0026#34;) ) db = Chroma( collection_name=config.chroma_config().get(\u0026#34;collection_name\u0026#34;), client=client, embedding_function=embedding # ä¼ å…¥åµŒå…¥å‡½æ•° ) db.get() # å°è¯•è®¿é—®é›†åˆéªŒè¯è¿æ¥ print(\u0026#34;è¿æ¥å‘é‡æ•°æ®åº“æˆåŠŸ..\u0026#34;) self.db = db except Exception as e: # å¼‚å¸¸å¤„ç† raise Exception(f\u0026#34;é“¾æ¥å‘é‡æ•°æ®åº“å¤±è´¥: {str(e)}, è¯·æ£€æŸ¥é…ç½®ä¿¡æ¯\u0026#34;) from e def add(self, documents): # æ–°å¢ï¼šæŒ‰APIé™åˆ¶æ‹†åˆ†æ‰¹æ¬¡ï¼ˆæ¯æ‰¹æœ€å¤š10ä¸ªæ–‡æ¡£ï¼‰ batch_size = 10 for i in range(0, len(documents), batch_size): batch = documents[i:i + batch_size] # æˆªå–æ‰¹æ¬¡æ–‡æ¡£ self.db.add_documents(batch) # åˆ†æ‰¹æ·»åŠ  print(f\u0026#34;å·²æ·»åŠ ç¬¬ {i // batch_size + 1}æ‰¹æ–‡æ¡£ï¼Œå…± {len(batch)}ä¸ª\u0026#34;) # æ–°å¢ï¼šæ·»åŠ æ–‡æ¡£åï¼Œåˆ·æ–°ç´¢å¼• def query(self, query): # æŸ¥è¯¢æ–‡æ¡£ docs = self.db.similarity_search(query) return docs def delete(self, document_id): # åˆ é™¤æ–‡æ¡£ self.db.delete(document_id) print(f\u0026#34;å·²åˆ é™¤æ–‡æ¡£ ID: {document_id}\u0026#34;) def update(self, document_id, doc): # æ›´æ–°æ–‡æ¡£ self.db.update_document(document_id, doc) print(f\u0026#34;å·²æ›´æ–°æ–‡æ¡£ ID: {document_id}\u0026#34;) def list(self): # åˆ—å‡ºæ‰€æœ‰æ–‡æ¡£ return self.db.get() def delete_all(self): # åˆ é™¤æ‰€æœ‰æ–‡æ¡£ self.db.delete_collection() print(\u0026#34;å·²åˆ é™¤æ‰€æœ‰æ–‡æ¡£\u0026#34;) def get_id(self, document_id): return self.db.get(document_id) def as_retriever(self, search_kwargs): return self.db.as_retriever(search_kwargs=search_kwargs) # def db(self): # return self.db # if __name__ == \u0026#39;__main__\u0026#39;: # config = Config(\u0026#39;../conf/config.yml\u0026#39;) # chromadb = ChromaDB(config, ModelType.QWEN) # docs = chromadb.list() # print(docs) # print(chromadb.get_id(\u0026#34;0f506577-1db5-42fb-b70d-fe77fb7fe173\u0026#34;)) äº”ã€ä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-05-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag/img_hufef087fddda0fa8512a3bf0acfa96939_57649_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag/","title":"æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰"},{"content":"LangChain è‡ªå®šä¹‰å·¥å…· å¼•è¨€ åœ¨æ„å»º LangChain ä»£ç†æ—¶ï¼Œå·¥å…·(Tools)æ˜¯æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚å·¥å…·å…è®¸ä»£ç†ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’ï¼Œæ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•åœ¨ LangChain ä¸­åˆ›å»ºå’Œä½¿ç”¨è‡ªå®šä¹‰å·¥å…·ï¼ŒåŒ…æ‹¬å†…ç½®å·¥å…·çš„ä½¿ç”¨å’Œè‡ªå®šä¹‰å·¥å…·çš„å¤šç§å®ç°æ–¹å¼ã€‚\nå·¥å…·çš„åŸºæœ¬ç»„æˆ æ¯ä¸ªå·¥å…·éƒ½åŒ…å«å‡ ä¸ªå…³é”®ç»„ä»¶ï¼š\n name (str): å¿…éœ€ä¸”å¿…é¡»åœ¨å·¥å…·é›†ä¸­å”¯ä¸€ description (str): å¯é€‰ä½†å»ºè®®æä¾›ï¼Œä»£ç†ç”¨å®ƒæ¥å†³å®šå¦‚ä½•ä½¿ç”¨å·¥å…· return_direct (bool): é»˜è®¤ä¸º False args_schema (Pydantic BaseModel): å¯é€‰ä½†å»ºè®®æä¾›ï¼Œå¯ç”¨äºéªŒè¯å‚æ•°æˆ–æä¾›few-shotç¤ºä¾‹  å†…ç½®å·¥å…·çš„ä½¿ç”¨ LangChain æä¾›äº†è®¸å¤šå†…ç½®å·¥å…·ï¼Œè¯·è®¿é—®å·¥å…·é›†æˆæŸ¥çœ‹å¯ç”¨å·¥å…·åˆ—è¡¨ï¼Œåœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ—¶ï¼Œè¯·ç¡®ä¿æ‚¨äº†è§£å·¥å…·çš„å·¥ä½œåŸç†ã€æƒé™æƒ…å†µï¼š\nç»´åŸºç™¾ç§‘æŸ¥è¯¢å·¥å…· def get_wikipedia(query): api_wrapper = WikipediaAPIWrapper(top_k_results=1, doc_content_chars_max=100) tool = WikipediaQueryRun(api_wrapper=api_wrapper) result = tool.run(query) return result Google æ–‡å­—è½¬è¯­éŸ³å·¥å…· def google_tts(text): tts = GoogleCloudTextToSpeechTool() speech_file = tts.run(text) return speech_file è‡ªå®šä¹‰å·¥å…·çš„å®ç°æ–¹å¼ 1. ä½¿ç”¨ @tool è£…é¥°å™¨ è¿™æ˜¯å®šä¹‰è‡ªå®šä¹‰å·¥å…·æœ€ç®€å•çš„æ–¹å¼ï¼š\nfrom langchain_core.tools import tool @tool def search_city_tool(city: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;æœç´¢åŸå¸‚ä¿¡æ¯\u0026#34;\u0026#34;\u0026#34; url = f\u0026#34;https://api.songzixian.com/api/china-city?dataSource=LOCAL_CHINA_CITY\u0026amp;district={city}\u0026#34; response = requests.get(url) if response.status_code == 200: return response.json() else: raise ToolException(f\u0026#34;é”™è¯¯ï¼š{city}ä¸å­˜åœ¨ï¼Œè·å–åŸå¸‚æ•°æ®å¤±è´¥\u0026#34;) ä½¿ç”¨è¯´æ˜ï¼š\n å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²å°†è‡ªåŠ¨ç”¨ä½œå·¥å…·æè¿° ç±»å‹æç¤ºç”¨äºå‚æ•°éªŒè¯ å¯ä»¥æŠ›å‡º ToolException æ¥å¤„ç†é”™è¯¯  2. ä½¿ç”¨ StructuredTool.from_function è¿™ç§æ–¹å¼æä¾›äº†æ›´å¤šé…ç½®é€‰é¡¹ï¼š\nfrom langchain_core.tools import StructuredTool def get_city_by_ip(ip: str): \u0026#34;\u0026#34;\u0026#34;æ ¹æ®IPåœ°å€è·å–åŸå¸‚ä¿¡æ¯\u0026#34;\u0026#34;\u0026#34; url = f\u0026#34;https://whois.pconline.com.cn/ipJson.jsp?ip={ip}\u0026amp;json=true\u0026#34; response = requests.get(url) try: if response.status_code == 200: return response.json() except Exception as e: raise ToolException(f\u0026#34;é”™è¯¯ï¼šipè·å–åŸå¸‚æ•°æ®å¤±è´¥ï¼Œ{ip}\u0026#34;) def ip_to_city_tool(ip: str): calculator = StructuredTool.from_function( func=get_city_by_ip, handle_tool_error=\u0026#34;ipè·å–åŸå¸‚æ•°æ®å¤±è´¥\u0026#34; ) try: calculator.invoke({\u0026#34;ip\u0026#34;:ip}) return calculator except Exception as e: print(e) return \u0026#34;\u0026#34; ä¼˜åŠ¿ï¼š\n å¯ä»¥è‡ªå®šä¹‰é”™è¯¯å¤„ç† æ”¯æŒæ›´å¤æ‚çš„å‚æ•°é…ç½® å¯ä»¥æ·»åŠ é¢å¤–çš„å…ƒæ•°æ®  å·¥å…·çš„é”™è¯¯å¤„ç† è‰¯å¥½çš„é”™è¯¯å¤„ç†å¯¹å·¥å…·è‡³å…³é‡è¦ï¼š\n@tool def search_weather_tool(city_code: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;æœç´¢å¤©æ°”ä¿¡æ¯\u0026#34;\u0026#34;\u0026#34; url = f\u0026#34;http://t.weather.itboy.net/api/weather/city/{city_code}\u0026#34; response = requests.get(url) if response.status_code == 200: return response.json() else: raise ToolException(f\u0026#34;é”™è¯¯ï¼š{city_code}ä¸å­˜åœ¨ï¼Œè·å–åŸå¸‚å¤©æ°”æ•°æ®æ•°æ®å¤±è´¥\u0026#34;) æœ€ä½³å®è·µï¼š\n ä½¿ç”¨ ToolException æŠ›å‡ºæ˜ç¡®çš„é”™è¯¯ æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯ è€ƒè™‘æ·»åŠ é‡è¯•é€»è¾‘  å®é™…åº”ç”¨ç¤ºä¾‹ åŸå¸‚ä¿¡æ¯æŸ¥è¯¢ç³»ç»Ÿ # è·å–åŸå¸‚ä»£ç  city_data = search_city_tool(\u0026#34;åŒ—äº¬\u0026#34;) city_code = city_data[\u0026#34;code\u0026#34;] # è·å–å¤©æ°”ä¿¡æ¯ weather_data = search_weather_tool(city_code) # è½¬æ¢ä¸ºè¯­éŸ³ speech_file = google_tts(f\u0026#34;å½“å‰å¤©æ°”ï¼š{weather_data[\u0026#39;weather\u0026#39;]}\u0026#34;) å·¥å…·çš„é«˜çº§ç”¨æ³•  å‚æ•°éªŒè¯ï¼šä½¿ç”¨ Pydantic æ¨¡å‹éªŒè¯è¾“å…¥å‚æ•° Few-shot ç¤ºä¾‹ï¼šåœ¨ args_schema ä¸­æ·»åŠ ç¤ºä¾‹ å·¥å…·ç»„åˆï¼šå°†å¤šä¸ªå·¥å…·ç»„åˆæˆå·¥å…·åŒ… å¼‚æ­¥æ”¯æŒï¼šå®ç°å¼‚æ­¥ç‰ˆæœ¬çš„å·¥å…·  æ€§èƒ½ä¼˜åŒ–å»ºè®®  ä¸ºç½‘ç»œè¯·æ±‚æ·»åŠ è¶…æ—¶è®¾ç½® å®ç°ç¼“å­˜æœºåˆ¶ è€ƒè™‘æ‰¹é‡å¤„ç†è¯·æ±‚ ç›‘æ§å·¥å…·ä½¿ç”¨æƒ…å†µ  æ€»ç»“ LangChain çš„å·¥å…·ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼Œå…è®¸å¼€å‘è€…ï¼š\n è½»æ¾é›†æˆç°æœ‰APIå’ŒæœåŠ¡ æ„å»ºå¤æ‚çš„ä»£ç†å·¥ä½œæµ å®ç°è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ å¤„ç†å„ç§è¾¹ç¼˜æƒ…å†µ  é€šè¿‡åˆç†è®¾è®¡å·¥å…·ï¼Œå¯ä»¥å¤§å¤§å¢å¼ºä»£ç†çš„èƒ½åŠ›å’Œå¯é æ€§\nä»£ç ç¤ºä¾‹ # è‡ªå®šä¹‰å·¥å…·è°ƒç”¨ \u0026#34;\u0026#34;\u0026#34; å½“æ„å»ºè‡ªå·±çš„ä»£ç†æ—¶ï¼Œæ‚¨éœ€è¦ä¸ºå…¶æä¾›ä¸€ç»„å·¥å…·åˆ—è¡¨ï¼Œä»£ç†å¯ä»¥ä½¿ç”¨è¿™äº›å·¥å…·ã€‚é™¤äº†è°ƒç”¨çš„å®é™…å‡½æ•°ä¹‹å¤–ï¼Œå·¥å…·ç”±å‡ ä¸ªç»„ä»¶ç»„æˆï¼š nameï¼ˆstrï¼‰ï¼Œæ˜¯å¿…éœ€çš„ï¼Œå¹¶ä¸”åœ¨æä¾›ç»™ä»£ç†çš„å·¥å…·é›†ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ descriptionï¼ˆstrï¼‰ï¼Œæ˜¯å¯é€‰çš„ä½†å»ºè®®çš„ï¼Œå› ä¸ºä»£ç†ä½¿ç”¨å®ƒæ¥ç¡®å®šå·¥å…·çš„ä½¿ç”¨æ–¹å¼ return_directï¼ˆboolï¼‰ï¼Œé»˜è®¤ä¸º False args_schemaï¼ˆPydantic BaseModelï¼‰ï¼Œæ˜¯å¯é€‰çš„ä½†å»ºè®®çš„ï¼Œå¯ä»¥ç”¨äºæä¾›æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œfew-shot ç¤ºä¾‹ï¼‰æˆ–ç”¨äºéªŒè¯é¢„æœŸå‚æ•°ã€‚ \u0026#34;\u0026#34;\u0026#34; import requests from charset_normalizer.api import handler from langchain_community.tools import WikipediaQueryRun from langchain_community.utilities import WikipediaAPIWrapper from langchain_community.tools import GoogleCloudTextToSpeechTool from langchain_core.tools import tool, StructuredTool, ToolException \u0026#34;\u0026#34;\u0026#34; å†…ç½®å·¥å…·åŒ… \u0026#34;\u0026#34;\u0026#34; def get_wikipedia(query): api_wrapper = WikipediaAPIWrapper(top_k_results=1, doc_content_chars_max=100) tool = WikipediaQueryRun(api_wrapper=api_wrapper) result = tool.run(query) return result def google_tts(text): tts = GoogleCloudTextToSpeechTool() speech_file = tts.run(text) return speech_file \u0026#34;\u0026#34;\u0026#34; è‡ªå®šä¹‰å·¥å…·è°ƒç”¨ \u0026#34;\u0026#34;\u0026#34; # ä½¿ç”¨@toolè£…é¥°å™¨ -- å®šä¹‰è‡ªå®šä¹‰å·¥å…·çš„æœ€ç®€å•æ–¹å¼ã€‚ @tool def search_city_tool(city: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;æœç´¢åŸå¸‚ä¿¡æ¯\u0026#34;\u0026#34;\u0026#34; url = f\u0026#34;https://api.songzixian.com/api/china-city?dataSource=LOCAL_CHINA_CITY\u0026amp;district={city}\u0026#34; response = requests.get(url) if response.status_code == 200: return response.json() else: raise ToolException(f\u0026#34;é”™è¯¯ï¼š{city}ä¸å­˜åœ¨ï¼Œè·å–åŸå¸‚æ•°æ®å¤±è´¥\u0026#34;) @tool def search_weather_tool(city_code: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;æœç´¢å¤©æ°”ä¿¡æ¯\u0026#34;\u0026#34;\u0026#34; url = f\u0026#34;http://t.weather.itboy.net/api/weather/city/{city_code}\u0026#34; response = requests.get(url) if response.status_code == 200: return response.json() else: raise ToolException(f\u0026#34;é”™è¯¯ï¼š{city_code}ä¸å­˜åœ¨ï¼Œè·å–åŸå¸‚å¤©æ°”æ•°æ®æ•°æ®å¤±è´¥\u0026#34;) # return \u0026#34;\u0026#34; # StructuredTool.from_function ç±»æ–¹æ³•æä¾›äº†æ¯”@toolè£…é¥°å™¨æ›´å¤šçš„å¯é…ç½®æ€§ï¼Œè€Œæ— éœ€å¤ªå¤šé¢å¤–çš„ä»£ç ã€‚ def get_city_by_ip(ip: str): \u0026#34;\u0026#34;\u0026#34; æ ¹æ®IPåœ°å€è·å–åŸå¸‚ä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; url = f\u0026#34;https://whois.pconline.com.cn/ipJson.jsp?ip={ip}\u0026amp;json=true\u0026#34; response = requests.get(url) try: if response.status_code == 200: return response.json() except Exception as e: # print(e) raise ToolException(f\u0026#34;é”™è¯¯ï¼šipè·å–åŸå¸‚æ•°æ®å¤±è´¥ï¼Œ{ip}\u0026#34;) def ip_to_city_tool(ip: str): calculator = StructuredTool.from_function(func=get_city_by_ip, handle_tool_error=\u0026#34;ipè·å–åŸå¸‚æ•°æ®å¤±è´¥\u0026#34;) try: calculator.invoke({\u0026#34;ip\u0026#34;:ip}) return calculator except Exception as e: print(e) return \u0026#34;\u0026#34; if __name__ == \u0026#39;__main__\u0026#39;: print(search_city_tool.name) print(search_city_tool.description) print(search_city_tool.args_schema) print(search_city_tool(\u0026#34;å°åŒ—11111\u0026#34;)) print(search_weather_tool(\u0026#34;101260207\u0026#34;)) # print(ip_to_city_tool(\u0026#34;123.123.123\u0026#34;)) ä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-03-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/langchain-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7/1_hudd76169eaa14e4b46869a65a4bae705b_986909_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/langchain-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7/","title":"LangChain è‡ªå®šä¹‰å·¥å…·"},{"content":"LangChain å¤šæ¨¡æ€è¾“å…¥å¤„ç† å¼•è¨€ éšç€å¤§æ¨¡å‹æŠ€æœ¯çš„å‘å±•ï¼Œå¤šæ¨¡æ€èƒ½åŠ›å·²æˆä¸ºAIåº”ç”¨çš„é‡è¦æ–¹å‘ã€‚LangChainæä¾›äº†å¼ºå¤§çš„å¤šæ¨¡æ€å¤„ç†èƒ½åŠ›ï¼Œå…è®¸å¼€å‘è€…å°†æ–‡æœ¬ã€å›¾åƒã€PDFç­‰å¤šç§è¾“å…¥ç±»å‹ç»“åˆä½¿ç”¨ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨LangChainä¸­çš„å¤šæ¨¡æ€è¾“å…¥å¤„ç†æœºåˆ¶ã€‚\nå¤šæ¨¡æ€åŸºç¡€æ¦‚å¿µ å¤šæ¨¡æ€(Multimodality)æ˜¯æŒ‡æ¨¡å‹èƒ½å¤ŸåŒæ—¶å¤„ç†å’Œç”Ÿæˆå¤šç§ç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š\n æ–‡æœ¬(Text) å›¾åƒ(Image) éŸ³é¢‘(Audio) è§†é¢‘(Video) æ–‡æ¡£(Document)  LangChainå¤šæ¨¡æ€æ¶æ„ LangChainçš„å¤šæ¨¡æ€å¤„ç†ä¸»è¦åŸºäºä»¥ä¸‹ç»„ä»¶ï¼š\n HumanMessage: æ‰¿è½½å¤šæ¨¡æ€å†…å®¹çš„æ ¸å¿ƒæ¶ˆæ¯ç±» å†…å®¹ç±»å‹æ ‡è¯†(typeå­—æ®µ): æ ‡è¯†ä¸åŒåª’ä½“ç±»å‹ æ•°æ®æ¥æºæ ‡è¯†(source_typeå­—æ®µ): åŒºåˆ†æœ¬åœ°base64æˆ–URL  å¤šæ¨¡æ€è¾“å…¥å®ç°æ–¹å¼ 1. åŸºäºBase64çš„æœ¬åœ°æ–‡ä»¶è¾“å…¥ def input_by_base64(self, prompt_txt, image_data, type): try: message = HumanMessage( content=json.dumps([ {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: prompt_txt}, {\u0026#34;type\u0026#34;: type, \u0026#34;data\u0026#34;: image_data, \u0026#34;source_type\u0026#34;: \u0026#34;base64\u0026#34;}, ]) ) china = self.model.qwen_llm() return china.invoke([message]).content except Exception as e: print(e) return \u0026#34;\u0026#34; ä½¿ç”¨åœºæ™¯ï¼š\n å¤„ç†æœ¬åœ°å­˜å‚¨çš„å›¾ç‰‡ã€PDFç­‰æ–‡ä»¶ éœ€è¦æ•°æ®éšç§ä¿æŠ¤çš„åœºæ™¯ ç¦»çº¿åº”ç”¨ç¯å¢ƒ  2. åŸºäºURLçš„ç½‘ç»œèµ„æºè¾“å…¥ def input_by_url(self, prompt_txt, url, type): try: message = HumanMessage( content=json.dumps([ {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: prompt_txt}, {\u0026#34;type\u0026#34;: type, \u0026#34;data\u0026#34;: url, \u0026#34;source_type\u0026#34;: \u0026#34;url\u0026#34;}, ]) ) china = self.model.qwen_llm() return china.invoke([message]).content except Exception as e: print(e) return \u0026#34;\u0026#34; ä½¿ç”¨åœºæ™¯ï¼š\n å¤„ç†ç½‘ç»œä¸Šçš„å…¬å¼€èµ„æº éœ€è¦åŠ¨æ€åŠ è½½å†…å®¹çš„åœºæ™¯ å‡å°‘æœ¬åœ°å­˜å‚¨å‹åŠ›çš„åº”ç”¨  æ–‡ä»¶ç±»å‹æ”¯æŒ LangChainæ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ï¼Œå¸¸è§çš„æœ‰ï¼š\n   ç±»å‹ MIMEç±»å‹ æè¿°     å›¾ç‰‡ image/png, image/jpeg æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼   PDF application/pdf æ”¯æŒPDFæ–‡æ¡£è§£æ   æ–‡æœ¬æ–‡ä»¶ text/plain çº¯æ–‡æœ¬æ–‡ä»¶   Wordæ–‡æ¡£ application/msword Microsoft Wordæ–‡æ¡£    å®ç”¨å·¥å…·å‡½æ•° æœ¬åœ°æ–‡ä»¶è½¬Base64 import base64 def file_to_base64_by_local(file_path): with open(file_path, \u0026#34;rb\u0026#34;) as file: return base64.b64encode(file.read()).decode(\u0026#39;utf-8\u0026#39;) å›¾ç‰‡å¤„ç†å·¥å…· from PIL import Image import io def process_image(image_data): # ä»base64è§£ç  image_bytes = base64.b64decode(image_data) image = Image.open(io.BytesIO(image_bytes)) # è¿›è¡Œå„ç§å›¾åƒå¤„ç†... å®é™…åº”ç”¨æ¡ˆä¾‹ 1. å›¾ç‰‡å†…å®¹æè¿° image_path = \u0026#34;path/to/image.png\u0026#34; base64_code = images_util.image_to_base64_by_local(image_path) result = multimodal.input_by_base64( \u0026#34;è¿™å¼ å›¾ç‰‡æè¿°äº†ä»€ä¹ˆ,ä¸­æ–‡æè¿°\u0026#34;, base64_code, \u0026#34;image/png\u0026#34; ) 2. PDFæ–‡æ¡£æ‘˜è¦ file_path = \u0026#34;path/to/document.pdf\u0026#34; base64_file = images_util.file_to_base64_by_local(file_path) result = multimodal.input_by_base64( \u0026#34;æ–‡ä»¶ä¸»è¦è®²äº†ä»€ä¹ˆ\u0026#34;, base64_file, \u0026#34;application/pdf\u0026#34; ) 3. ç½‘ç»œå›¾ç‰‡åˆ†æ result = multimodal.input_by_url( \u0026#34;è¿™å¼ å›¾ç‰‡æè¿°äº†ä»€ä¹ˆ,ä¸­æ–‡æè¿°\u0026#34;, \u0026#34;https://img.shetu66.com/2023/04/25/1682391094827084.png\u0026#34;, \u0026#34;image\u0026#34; ) ä»£ç ç¤ºä¾‹ # å¤šæ¨¡æ€è¾“å…¥ import base64 import json from langchain_core.messages import HumanMessage from common.modeCommon import Model from config.config import Config from utils import images_util class Multimodal(object): def __init__(self, model: Model): self.model = model def input_by_base64(self, prompt_txt, image_data, type): try: message = HumanMessage( content=json.dumps([ {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: prompt_txt}, {\u0026#34;type\u0026#34;: type, \u0026#34;data\u0026#34;: image_data, \u0026#34;source_type\u0026#34;: \u0026#34;base64\u0026#34;}, ]) ) china = self.model.qwen_llm() return china.invoke([message]).content except Exception as e: print(e) return \u0026#34;\u0026#34; def input_by_url(self, prompt_txt, url, type): try: message = HumanMessage( content=json.dumps([ {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: prompt_txt}, {\u0026#34;type\u0026#34;: type, \u0026#34;data\u0026#34;: url, \u0026#34;source_type\u0026#34;: \u0026#34;url\u0026#34;}, ]) ) china = self.model.qwen_llm() return china.invoke([message]).content except Exception as e: print(e) return \u0026#34;\u0026#34; if __name__ == \u0026#39;__main__\u0026#39;: config = Config(\u0026#39;conf/config.yml\u0026#39;) # åˆå§‹åŒ–æ¨¡å‹ model = Model(config) multimodal = Multimodal(model) # image_path = \u0026#34;C:\\\\Users\\\\Administrator\\\\Desktop\\\\17536735231103.png\u0026#34; # base64_code = images_util.image_to_base64_by_local(image_path) # result = multimodal.input_by_image_base64(\u0026#34;è¿™å¼ å›¾ç‰‡æè¿°äº†ä»€ä¹ˆ,ä¸­æ–‡æè¿°\u0026#34;, base64_code, \u0026#34;image/png\u0026#34;) # result = multimodal.input_by_url(\u0026#34;è¿™å¼ å›¾ç‰‡æè¿°äº†ä»€ä¹ˆ,ä¸­æ–‡æè¿°\u0026#34;, \u0026#34;https://img.shetu66.com/2023/04/25/1682391094827084.png\u0026#34;, \u0026#34;image\u0026#34;) file_path = \u0026#34;C:\\\\Users\\\\Administrator\\\\Desktop\\\\1.pdf\u0026#34; base64_file = images_util.file_to_base64_by_local(file_path) result = multimodal.input_by_base64(\u0026#34;æ–‡ä»¶ä¸»è¦è®²äº†ä»€ä¹ˆ\u0026#34;, base64_file, \u0026#34;file\u0026#34;) print(result) ä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-02-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/langchain-%E5%A4%9A%E6%A8%A1%E6%80%81%E8%BE%93%E5%85%A5%E5%A4%84%E7%90%86/1_hu4c351f786f8fd3fbb31415493398512f_844896_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/langchain-%E5%A4%9A%E6%A8%A1%E6%80%81%E8%BE%93%E5%85%A5%E5%A4%84%E7%90%86/","title":"LangChain å¤šæ¨¡æ€è¾“å…¥å¤„ç†"},{"content":"LangServe å®è·µ æ ¸å¿ƒåŠŸèƒ½ LangServe æ˜¯ä¸€ä¸ªä¸“ä¸º LangChain è®¾è®¡çš„éƒ¨ç½²å·¥å…·ï¼Œå¯å°† LangChain å¯è¿è¡Œå¯¹è±¡å’Œé“¾å¿«é€Ÿè½¬åŒ–ä¸º REST APIï¼Œä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š\n è‡ªåŠ¨åŒ– API ç”Ÿæˆ\né€šè¿‡ FastAPI + Pydantic è‡ªåŠ¨æ¨æ–­è¾“å…¥/è¾“å‡ºæ¨¡å‹ï¼Œç”Ÿæˆå¸¦æ•°æ®éªŒè¯çš„ REST ç«¯ç‚¹ å¤šåè®®æ”¯æŒ\næä¾› /invokeï¼ˆå•æ¬¡è°ƒç”¨ï¼‰ã€/batchï¼ˆæ‰¹é‡å¤„ç†ï¼‰ã€/streamï¼ˆå®æ—¶æµï¼‰ç­‰æ ‡å‡†åŒ–ç«¯ç‚¹ è°ƒè¯•å‹å¥½  /stream_log å®æ—¶æµå¼ä¼ è¾“ä¸­é—´æ­¥éª¤ 0.0.40+ ç‰ˆæœ¬æ–°å¢ /stream_events ç®€åŒ–æµå¼å¤„ç†   ç”Ÿäº§çº§æ¶æ„\nåŸºäº uvloop å’Œ asyncio å®ç°é«˜å¹¶å‘ï¼Œæ”¯æŒ Swagger è‡ªåŠ¨æ–‡æ¡£  æŠ€æœ¯ä¼˜åŠ¿    ç‰¹æ€§ è¯´æ˜     å£°æ˜å¼éªŒè¯ é€šè¿‡ Pydantic æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆ JSON Schemaï¼Œæä¾›ç±»å‹æ£€æŸ¥å’Œæ¸…æ™°é”™è¯¯æç¤º   æ— ç¼é›†æˆ å†…ç½® LangChain.js å®¢æˆ·ç«¯ï¼Œæ”¯æŒ Python/JavaScript è°ƒç”¨   é›¶æ¨¡æ¿ä»£ç  è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£å’Œ Playground è°ƒè¯•ç•Œé¢    å…¸å‹å·¥ä½œæµ å®šä¹‰ LangChain å¯¹è±¡\nfrom langchain.chains import LLMChain chain = LLMChain(...) éƒ¨ç½²ä¸º API\nfrom langserve import add_routes\radd_routes(app, chain)\rå³æ—¶è·å¾—ï¼š\n âœ… è‡ªåŠ¨ç”Ÿæˆçš„ Swagger æ–‡æ¡£ âœ… å¸¦ç±»å‹æ ¡éªŒçš„ /invoke ç«¯ç‚¹ âœ… å¯è§†åŒ–è°ƒè¯• Playground  é€‚ç”¨åœºæ™¯  ğŸ”§ å¿«é€ŸåŸå‹éªŒè¯ ğŸš€ ç”Ÿäº§ç¯å¢ƒæœåŠ¡éƒ¨ç½² ğŸ”— å¾®æœåŠ¡æ¶æ„é›†æˆ ğŸ§ª äº¤äº’å¼è°ƒè¯•æµ‹è¯•  ä»£ç ç¤ºä¾‹  æœåŠ¡ç«¯  import uvicorn from fastapi import FastAPI from fastapi.responses import RedirectResponse from langchain_core.runnables import RunnableLambda from langserve import add_routes from Prompt import Prompt from common.modeCommon import Model from config.config import Config app = FastAPI(title=\u0026#34;LangChain æœåŠ¡å™¨\u0026#34;, version=\u0026#34;1.0\u0026#34;, description=\u0026#34;ä½¿ç”¨ Langchain çš„ Runnable æ¥å£çš„ç®€å• API æœåŠ¡å™¨\u0026#34;) @app.get(\u0026#34;/\u0026#34;) async def redirect_root_to_docs(): return RedirectResponse(\u0026#34;/docs\u0026#34;) def base_prompt_routes(prompt, model): base_prompt = prompt.base_prompt() llm_chain = model.qwen_llm_china(base_prompt) poetry_func = RunnableLambda(lambda x: llm_chain.invoke(x)) add_routes(app, poetry_func, path=\u0026#34;/base\u0026#34;) def chat_prompt_routes(prompt, model): chat_prompt = prompt.chat_prompt() llm_chain = model.qwen_llm_china(chat_prompt) poetry_func = RunnableLambda(lambda x: llm_chain.invoke(x)) add_routes(app, poetry_func, path=\u0026#34;/chat\u0026#34;) def stream_prompt_routes(prompt, model): llm_chain = model.qwen_llm_stream() poetry_func = RunnableLambda(lambda x: llm_chain.invoke(x)) add_routes(app, poetry_func, path=\u0026#34;/stream\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: # åˆå§‹åŒ–æ¨¡å‹é…ç½® config = Config(\u0026#39;conf/config.yml\u0026#39;) # åˆå§‹åŒ–æ¨¡å‹ model = Model(config) # # è°ƒç”¨qwenæ¨¡å‹ prompt = Prompt() base_prompt_routes(prompt, model) chat_prompt_routes(prompt, model) stream_prompt_routes(prompt, model) uvicorn.run(app, host=\u0026#34;0.0.0.0\u0026#34;, port=8000)  å®¢æˆ·ç«¯ç¤ºä¾‹  from langserve import RemoteRunnable remote_chain = RemoteRunnable(\u0026#34;http://127.0.0.1:8000/base\u0026#34;) response = remote_chain.invoke({ \u0026#34;domain\u0026#34;: \u0026#34;é‡‘è\u0026#34;, \u0026#34;profession\u0026#34;: \u0026#34;é‡‘èåˆ†æå‘˜\u0026#34;, \u0026#34;do\u0026#34;: \u0026#34;è¯„ä¼°æœªæ¥åŠå¹´ä¸­å›½çš„é‡‘èå¸‚åœºæƒ…å†µï¼Œåˆ†æå¸‚åœºè¶‹åŠ¿ï¼Œé¢„æµ‹æœªæ¥çš„å¸‚åœºå˜åŒ–\u0026#34;, \u0026#34;material\u0026#34;: \u0026#34;æ— \u0026#34;, \u0026#34;question\u0026#34;: \u0026#34;ä»¥è¡¨æ ¼çš„å½¢å¼è¾“å‡º\u0026#34;, }) if __name__ == \u0026#39;__main__\u0026#39;: print(response) ä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-01-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/langserve/1_hufacbddd1a7dc2ecd8ed6fcb829415c77_578046_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/langserve/","title":"LangServe"},{"content":"LCELä¸LangChainæµå¼å¤„ç†æŒ‡å— ä»€ä¹ˆæ˜¯LCELï¼Ÿ LCELï¼ˆLangChain Expression Languageï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥ä½œæµç¼–æ’å·¥å…·ï¼Œèƒ½å¤Ÿä»åŸºæœ¬ç»„ä»¶æ„å»ºå¤æ‚ä»»åŠ¡é“¾æ¡(chain)ï¼Œå¹¶å…·æœ‰ä»¥ä¸‹ç”Ÿäº§çº§ç‰¹æ€§ï¼š\n ğŸš€ ä¸€æµçš„æµå¼æ”¯æŒï¼šç›´æ¥ä»LLMæµå¼ä¼ è¾“æ ‡è®°åˆ°è¾“å‡ºè§£æå™¨ âš¡ å¼‚æ­¥æ”¯æŒï¼šåŒä¸€ä»£ç å¯åŒæ­¥/å¼‚æ­¥è¿è¡Œï¼Œé€‚åˆåŸå‹åˆ°ç”Ÿäº§ ğŸ”€ ä¼˜åŒ–çš„å¹¶è¡Œæ‰§è¡Œï¼šè‡ªåŠ¨å¹¶è¡Œå¯å¹¶è¡Œæ­¥éª¤ ğŸ”„ é‡è¯•å’Œå›é€€ï¼šé…ç½®å¯é æ€§æœºåˆ¶ ğŸ” ä¸­é—´ç»“æœè®¿é—®ï¼šå®æ—¶ç›‘æ§å’Œè°ƒè¯• ğŸ“ è¾“å…¥è¾“å‡ºæ¨¡å¼ï¼šè‡ªåŠ¨ç”ŸæˆPydantic/JSONSchemaéªŒè¯  Runnableæ¥å£æ ‡å‡† LangChainç»„ä»¶é€šè¿‡Runnableåè®®å®ç°æ ‡å‡†åŒ–è°ƒç”¨ï¼š\nåŒæ­¥æ–¹æ³•  stream(): æµå¼è¿”å›å“åº”å— invoke(): è°ƒç”¨é“¾å¤„ç†è¾“å…¥ batch(): æ‰¹é‡å¤„ç†è¾“å…¥åˆ—è¡¨  å¼‚æ­¥æ–¹æ³•  astream(): å¼‚æ­¥æµå¼å“åº” ainvoke(): å¼‚æ­¥è°ƒç”¨ abatch(): å¼‚æ­¥æ‰¹é‡å¤„ç† astream_log(): æµå¼ä¸­é—´æ­¥éª¤+æœ€ç»ˆç»“æœ astream_events(): æµå¼é“¾äº‹ä»¶(Beta)  ç»„ä»¶I/Oç±»å‹    ç»„ä»¶ è¾“å…¥ç±»å‹ è¾“å‡ºç±»å‹     æç¤º å­—å…¸ æç¤ºå€¼   èŠå¤©æ¨¡å‹ å­—ç¬¦ä¸²/æ¶ˆæ¯åˆ—è¡¨/æç¤ºå€¼ èŠå¤©æ¶ˆæ¯   LLM å­—ç¬¦ä¸²/æ¶ˆæ¯åˆ—è¡¨/æç¤ºå€¼ å­—ç¬¦ä¸²   è¾“å‡ºè§£æå™¨ LLM/èŠå¤©æ¨¡å‹è¾“å‡º è§£æå™¨ç‰¹å®š   æ£€ç´¢å™¨ å­—ç¬¦ä¸² æ–‡æ¡£åˆ—è¡¨   å·¥å…· å­—ç¬¦ä¸²/å­—å…¸ å·¥å…·ç‰¹å®š    æµå¼å¤„ç†(Stream) æ ¸å¿ƒæ–¹æ³•  åŒæ­¥æµå¼ï¼šstream() å¼‚æ­¥æµå¼ï¼šastream()  å…³é”®ç‰¹æ€§  å®æ—¶è¿”å›æ¯ä¸ªå¤„ç†å— è¦æ±‚æ‰€æœ‰æ­¥éª¤æ”¯æŒæµå¼å¤„ç† å¤æ‚åº¦èŒƒå›´ï¼š  ç®€å•ï¼šLLMä»¤ç‰Œæµ å¤æ‚ï¼šéƒ¨åˆ†JSONç»“æœæµ    æœ€ä½³å®è·µ å»ºè®®ä»LLMç»„ä»¶å¼€å§‹é€æ­¥æ„å»ºæµå¼å¤„ç†é“¾ã€‚\näº‹ä»¶æµ(Stream Events) é«˜çº§æ–¹æ³•  astream_events() (Beta): æµå¼ä¼ è¾“é“¾æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰äº‹ä»¶ astream_log(): æµå¼ä¸­é—´æ­¥éª¤+æœ€ç»ˆè¾“å‡º  å…¸å‹åº”ç”¨åœºæ™¯  å®æ—¶ç”¨æˆ·åé¦ˆ å¤æ‚é“¾è°ƒè¯• è¿›åº¦ç›‘æ§ å¢é‡ç»“æœå±•ç¤º  ä»£ç ç¤ºä¾‹ import asyncio import logging from langchain.chains.llm import LLMChain from langchain_core.output_parsers import StrOutputParser, JsonOutputParser from langchain_core.prompts import ChatPromptTemplate from langchain_core.tools import tool from langchain.chains import SimpleSequentialChain import PromptStudy from common.modeCommon import Model from config.config import Config # LangChainå·¥ä½œæµç¼–æ’ # åŒæ­¥Streamè¿è¡Œ def sync_stream(model: Model, constr): for ch in model.qwen_llm_stream().stream(constr): print(ch.content, end=\u0026#39;|\u0026#39;, flush=True) # @tool # å¼‚æ­¥AStreamè¿è¡Œ async def async_stream(model: Model, constr): async for ch in model.qwen_llm_stream().astream(constr): print(ch.content, end=\u0026#39;|\u0026#39;, flush=True) # Chain async def llm_chain(model: Model, prompt: PromptStudy): # åˆ›å»ºä¸€ä¸ªå·¥ä½œé“¾ base_prompt = prompt.base_prompt() parser = StrOutputParser() stream_model = model.qwen_llm_stream() chain = base_prompt | stream_model | parser # åˆ›å»ºä¸€ä¸ªåˆ›å»ºä¸€ä¸ªå·¥ä½œé“¾ å…ˆæ‰§è¡Œbase_prompt ç„¶åæ‰§è¡Œstream_model æœ€åæ‰§è¡Œparser # è¿è¡Œå·¥ä½œé“¾ async for ch in chain.astream(prompt.base_prompt_invoke(\u0026#34;ç³»ç»Ÿè¿ç»´\u0026#34;, \u0026#34;è¿ç»´é«˜çº§å·¥ç¨‹å¸ˆ\u0026#34;, \u0026#34;æƒ³ç†è§£äº¤æ¢æœºåŸç†\u0026#34;, \u0026#34;æ— \u0026#34;, \u0026#34;ç®€çŸ­æ–‡å­—è¾“å‡º\u0026#34;)): print(ch, end=\u0026#39;|\u0026#39;, flush=True) # åºåˆ—é“¾ï¼ˆSequential Chainsï¼‰ \u0026#34;\u0026#34;\u0026#34; åºåˆ—é“¾æ˜¯ä¸€ç§å°†å¤šä¸ªé“¾æŒ‰ç…§é¡ºåºè¿æ¥åœ¨ä¸€èµ·çš„å·¥ä½œæµã€‚ æ¯ä¸ªé“¾éƒ½å¯ä»¥æ¥æ”¶å‰ä¸€ä¸ªé“¾çš„è¾“å‡ºä½œä¸ºè¾“å…¥ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªé“¾ã€‚ åºåˆ—é“¾å¯ä»¥ç”¨äºæ„å»ºå¤æ‚çš„å·¥ä½œæµï¼Œå…¶ä¸­æ¯ä¸ªé“¾éƒ½æœ‰ç‰¹å®šçš„ä»»åŠ¡å’Œé€»è¾‘ã€‚ åºåˆ—é“¾çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥å°†å¤šä¸ªé“¾ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„å·¥ä½œæµã€‚ åºåˆ—é“¾çš„ä¸»è¦ç¼ºç‚¹æ˜¯æ¯ä¸ªé“¾éƒ½éœ€è¦ç‹¬ç«‹è¿è¡Œï¼Œå› æ­¤å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚ \u0026#34;\u0026#34;\u0026#34; def one_chain(model: Model, prompt: PromptStudy): base_prompt = prompt.base_prompt() parser = JsonOutputParser() stream_model = model.qwen_llm_stream() chain = base_prompt | stream_model | parser return chain def two_chain(model: Model, prompt: PromptStudy): base_prompt = prompt.base_prompt() parser = StrOutputParser() stream_model = model.qwen_llm_stream() chain = base_prompt | stream_model | parser return chain def llm_chain_sequential(model: Model, prompt: PromptStudy): chain_one = one_chain(model, prompt) chain_two = two_chain(model, prompt) overall_chain = chain_one | chain_two # è¿è¡Œå·¥ä½œé“¾ # å°† prompt.base_prompt_invoke çš„è¿”å›å€¼åŒ…è£…æˆå­—å…¸ # input_dict =prompt.base_prompt_invoke(\u0026#34;ç³»ç»Ÿè¿ç»´\u0026#34;, \u0026#34;è¿ç»´é«˜çº§å·¥ç¨‹å¸ˆ\u0026#34;, \u0026#34;æƒ³ç†è§£äº¤æ¢æœºåŸç†\u0026#34;, \u0026#34;æ— \u0026#34;, \u0026#34;ç®€çŸ­æ–‡å­—è¾“å‡º\u0026#34;) # è¿è¡Œå·¥ä½œé“¾ input_dict = { \u0026#34;domain\u0026#34;: \u0026#34;é«˜é“\u0026#34;, \u0026#34;profession\u0026#34;: \u0026#34;è‡ªæ„¿è€…\u0026#34;, \u0026#34;do\u0026#34;: \u0026#34;å»å“ªé‡Œè´­ä¹°é«˜é“ç¥¨ï¼Œæˆ‘åº”è¯¥å»æ‰¾è°\u0026#34;, \u0026#34;material\u0026#34;: \u0026#34;æ— \u0026#34;, \u0026#34;question\u0026#34;: \u0026#34;æŒ‰ç…§ä»¥ä¸‹jsonçš„æ ¼å¼è¾“å‡ºï¼š{\u0026#34; \u0026#34;\\\u0026#34;domain\\\u0026#34;: \\\u0026#34;\\\u0026#34;,\u0026#34; \u0026#34;\\\u0026#34;profession\\\u0026#34;: \\\u0026#34;\\\u0026#34;,\u0026#34; \u0026#34;\\\u0026#34;do\\\u0026#34;: \\\u0026#34;\\\u0026#34;,\u0026#34; \u0026#34;\\\u0026#34;material\\\u0026#34;: \\\u0026#34;\\\u0026#34;, \u0026#34; \u0026#34;\\\u0026#34;question\\\u0026#34;: \\\u0026#34;\\\u0026#34;}\u0026#34; } for ch in overall_chain.stream(input_dict): print(ch, end=\u0026#39;|\u0026#39;, flush=True) #è½¬æ¢é“¾ï¼ˆTransform Chainsï¼‰ï¼š å…è®¸ä½ åœ¨ é“¾ çš„ä¸­é—´æ­¥éª¤ä¸­å¯¹æ•°æ®è¿›è¡Œè½¬æ¢ def transform_chain(model: Model): first_prompt = ChatPromptTemplate.from_template(\u0026#34;æè¿°ä¸€å®¶ç”Ÿäº§{äº§å“}çš„å…¬å¸æœ€å¥½çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿ\u0026#34;) chain_one = model.qwen_llm_china(first_prompt) second_prompt = ChatPromptTemplate.from_template(\u0026#34;ä¸ºä»¥ä¸‹å…¬å¸å†™ä¸€ä¸ª20å­—çš„æè¿°ï¼š{company_name}\u0026#34;) chain_two = model.qwen_llm_china(second_prompt) overall_simple_chain = SimpleSequentialChain(chains=[chain_one, chain_two], verbose=True) product = \u0026#34;å¤–å–å’Œç”µå•†\u0026#34; chain_output = overall_simple_chain.invoke(product) print(chain_output) #æ¡ä»¶é“¾ï¼ˆConditional Chainsï¼‰ï¼š å…è®¸ä½ æ ¹æ®æŸäº›æ¡ä»¶é€‰æ‹©ä¸åŒçš„é“¾æ¥æ‰§è¡Œ #è·¯ç”±é“¾ï¼ˆRouter Chainsï¼‰ï¼š å…è®¸ä½ æ ¹æ®æŸäº›æ¡ä»¶é€‰æ‹©ä¸åŒçš„é“¾æ¥æ‰§è¡Œ #å¤šæ¨¡å‹é“¾ï¼ˆMulti Model Chainsï¼‰ï¼š å…è®¸ä½ åœ¨ä¸åŒçš„æ¨¡å‹ä¹‹é—´åˆ‡æ¢ if __name__ == \u0026#39;__main__\u0026#39;: logging.basicConfig(level=logging.INFO) # åˆå§‹åŒ–æ¨¡å‹é…ç½® config = Config(\u0026#39;conf/config.yml\u0026#39;) # åˆå§‹åŒ–æ¨¡å‹ model = Model(config) # åˆå§‹åŒ–æ¨¡æ¿ prompt = PromptStudy.Prompt() # sync_stream(model, \u0026#34;è´µå·çœçš„ç»„æˆ\u0026#34;) # asyncio.run(async_stream(model, \u0026#34;ä¸Šæµ·æ€ä¹ˆæ ·\u0026#34;)) # asyncio.run(llm_chain(model, prompt)) # llm_chain_sequential(model, prompt) transform_chain(model) ä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-01-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/lcel%E4%B8%8Elangchain%E6%B5%81%E5%BC%8F%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97/1_huc0a8b95b33d8d6a656995fb54ca12c83_153854_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/lcel%E4%B8%8Elangchain%E6%B5%81%E5%BC%8F%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97/","title":"LCELä¸LangChainæµå¼å¤„ç†æŒ‡å—"},{"content":"LangChain æ¡†æ¶è§£æ ä¸€ã€ç®€ä»‹  å®šä¹‰ï¼šå¼€æºPython AIåº”ç”¨å¼€å‘æ¡†æ¶ æ ¸å¿ƒä»·å€¼ï¼šé™ä½åŸºäºLLMçš„AIåº”ç”¨å¼€å‘é—¨æ§› æ ¸å¿ƒåŠŸèƒ½ï¼š  LLMé›†æˆï¼ˆæ–‡æœ¬ç”Ÿæˆ/é—®ç­”/ç¿»è¯‘/å¯¹è¯ï¼‰ åˆ›æ„åº”ç”¨æ„å»º æ ‡å‡†åŒ–AIå·¥ä½œæµ    äºŒã€æ ¸å¿ƒç‰¹æ€§    ç‰¹æ€§ åŠŸèƒ½æè¿° åº”ç”¨åœºæ™¯     LLM \u0026amp; æç¤ºç®¡ç† ç»Ÿä¸€APIæŠ½è±¡å±‚ + æç¤ºæ¨¡æ¿ æ ‡å‡†åŒ–æ¨¡å‹è°ƒç”¨   é“¾(Chain) é¢„å°è£…ä»»åŠ¡å·¥ä½œæµ é—®ç­”ç³»ç»Ÿ/SQLç”Ÿæˆ   LCEL è¡¨è¾¾å¼è¯­è¨€ç¼–æ’ä»»åŠ¡æµ è‡ªå®šä¹‰AIæµç¨‹   RAG å¤–éƒ¨æ•°æ®å¢å¼ºç”Ÿæˆ çŸ¥è¯†åº“é—®ç­”   Agents LLMå†³ç­–+å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ è‡ªåŠ¨åŒ–ä»»åŠ¡æ‰§è¡Œ   æ¨¡å‹è®°å¿† å¯¹è¯å†å²è®°å¿† å¤šè½®å¯¹è¯ç³»ç»Ÿ    LangChain ç‰¹æ€§ï¼š\nâ— LLM å’Œæç¤ºï¼ˆPromptï¼‰ï¼šLangChain å¯¹æ‰€æœ‰ LLM å¤§æ¨¡å‹è¿›è¡Œäº† API æŠ½è±¡ï¼Œç»Ÿä¸€äº†å¤§æ¨¡å‹è®¿é—® APIï¼ŒåŒæ—¶æä¾›äº† Prompt æç¤ºæ¨¡æ¿ç®¡ç†æœºåˆ¶ã€‚\nâ— é“¾ (Chain)ï¼šLangchain å¯¹ä¸€äº›å¸¸è§çš„åœºæ™¯å°è£…äº†ä¸€äº›ç°æˆçš„æ¨¡å—ï¼Œä¾‹å¦‚ï¼šåŸºäºä¸Šä¸‹æ–‡ä¿¡æ¯çš„é—®ç­”ç³»ç»Ÿï¼Œè‡ªç„¶è¯­è¨€ç”Ÿæˆ SQL æŸ¥è¯¢ç­‰ç­‰ï¼Œå› ä¸ºå®ç°è¿™äº›ä»»åŠ¡çš„è¿‡ç¨‹å°±åƒå·¥ä½œæµä¸€æ ·ï¼Œä¸€æ­¥ä¸€æ­¥çš„æ‰§è¡Œï¼Œæ‰€ä»¥å«é“¾ (chain)ã€‚\nâ— LCELï¼šLangChain Expression Language (LCEL)ï¼Œ langchain æ–°ç‰ˆæœ¬çš„æ ¸å¿ƒç‰¹æ€§ï¼Œç”¨äºè§£å†³å·¥ä½œæµç¼–æ’é—®é¢˜ï¼Œé€šè¿‡ LCEL è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»çš„è‡ªå®šä¹‰ AI ä»»åŠ¡å¤„ç†æµç¨‹ï¼Œä¹Ÿå°±æ˜¯çµæ´»è‡ªå®šä¹‰é“¾ (Chain)ã€‚\nâ— æ•°æ®å¢å¼ºç”Ÿæˆ (RAG)ï¼šå› ä¸ºå¤§æ¨¡å‹ (LLM) ä¸äº†è§£æ–°çš„ä¿¡æ¯ï¼Œæ— æ³•å›ç­”æ–°çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æ–°çš„ä¿¡æ¯å¯¼å…¥åˆ° LLMï¼Œç”¨äºå¢å¼º LLM ç”Ÿæˆå†…å®¹çš„è´¨é‡ï¼Œè¿™ç§æ¨¡å¼å«åš RAG æ¨¡å¼(Retrieval Augmented Generation)ã€‚\nâ— Agentsï¼šæ˜¯ä¸€ç§åŸºäºå¤§æ¨¡å‹ï¼ˆLLMï¼‰çš„åº”ç”¨è®¾è®¡æ¨¡å¼ï¼Œåˆ©ç”¨ LLM çš„è‡ªç„¶è¯­è¨€ç†è§£å’Œæ¨ç†èƒ½åŠ›ï¼ˆLLM ä½œä¸ºå¤§è„‘)ï¼‰ï¼Œæ ¹æ®ç”¨æˆ·çš„éœ€æ±‚è‡ªåŠ¨è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿã€è®¾å¤‡å…±åŒå»å®Œæˆä»»åŠ¡ï¼Œä¾‹å¦‚ï¼šç”¨æˆ·è¾“å…¥ â€œæ˜å¤©è¯·å‡ä¸€å¤©â€ï¼Œ å¤§æ¨¡å‹ï¼ˆLLMï¼‰è‡ªåŠ¨è°ƒç”¨è¯·å‡ç³»ç»Ÿï¼Œå‘èµ·ä¸€ä¸ªè¯·å‡ç”³è¯·ã€‚\nâ— æ¨¡å‹è®°å¿†ï¼ˆmemoryï¼‰ï¼šè®©å¤§æ¨¡å‹ (llm) è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œè¿™ç§èƒ½åŠ›æˆä¸ºæ¨¡å‹è®°å¿†ï¼ˆmemoryï¼‰ã€‚\nä¸‰ã€æ¡†æ¶ç»„æˆ 1. æ ¸å¿ƒç»„ä»¶ graph TD\rA[LangChainç”Ÿæ€] --\u0026gt; B[LangChainåº“]\rA --\u0026gt; C[LangChainæ¨¡æ¿]\rA --\u0026gt; D[LangServe]\rA --\u0026gt; E[LangSmith]\r\rå®˜æ–¹æ¡†æ¶å›¾\r\n2. åº“ç»“æ„  langchain-coreï¼šåŸºç¡€æŠ½è±¡/è¡¨è¾¾å¼è¯­è¨€ langchain-communityï¼šç¬¬ä¸‰æ–¹é›†æˆ langchainï¼šé“¾/ä»£ç†/æ£€ç´¢å®ç°  3. æ”¯æŒå·¥å…·  LangServeï¼šå°†é“¾å‘å¸ƒä¸ºREST API LangSmithï¼šäº‘å¹³å°(è°ƒè¯•/ç›‘æ§)  å››ã€ä»»åŠ¡å¤„ç†æµç¨‹ \rå®˜æ–¹æµç¨‹å›¾\r\n\ræµç¨‹å›¾2\r\næ¨¡å‹å°è£…ç±»å‹    ç±»å‹ è¾“å…¥ è¾“å‡º å…¸å‹åœºæ™¯     LLM æ–‡æœ¬ æ–‡æœ¬ åŸºç¡€é—®ç­”   Chat Model æ¶ˆæ¯åˆ—è¡¨ æ¶ˆæ¯ å¯¹è¯ç³»ç»Ÿ    äº”ã€æ ¸å¿ƒæ¦‚å¿µ 1. LLMs (å¤§è¯­è¨€æ¨¡å‹)  å®šä¹‰ï¼šLangChainå°è£…çš„åŸºç¡€æ–‡æœ¬å¤„ç†æ¨¡å‹ è¾“å…¥/è¾“å‡ºï¼šæ¥æ”¶æ–‡æœ¬è¾“å…¥ â†’ è¿”å›æ–‡æœ¬ç»“æœ ç‰¹ç‚¹ï¼šé€šç”¨é—®ç­”æ¨¡å‹ï¼Œé€‚åˆåŸºç¡€æ–‡æœ¬ç”Ÿæˆä»»åŠ¡  2. Chat Models (å¯¹è¯æ¨¡å‹)  å®šä¹‰ï¼šä¸“ä¸ºå¯¹è¯åœºæ™¯è®¾è®¡çš„æ¨¡å‹ è¾“å…¥/è¾“å‡ºï¼šæ¥æ”¶æ¶ˆæ¯åˆ—è¡¨ â†’ è¿”å›å¯¹è¯æ¶ˆæ¯ ç‰¹ç‚¹ï¼šæ”¯æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç†è§£  3. æ¶ˆæ¯ (Message)  å®šä¹‰ï¼šå¯¹è¯æ¨¡å‹çš„æ¶ˆæ¯å†…å®¹è½½ä½“ æ¶ˆæ¯ç±»å‹ï¼š  HumanMessageï¼šç”¨æˆ·è¾“å…¥æ¶ˆæ¯ AIMessageï¼šAIç”Ÿæˆçš„å›å¤æ¶ˆæ¯ SystemMessageï¼šç³»ç»Ÿçº§æŒ‡ä»¤æ¶ˆæ¯ FunctionMessageï¼šå‡½æ•°è°ƒç”¨æ¶ˆæ¯ ToolMessageï¼šå·¥å…·è°ƒç”¨æ¶ˆæ¯    4. æç¤º (Prompts)  åŠŸèƒ½ï¼šæç¤ºè¯ç®¡ç†å·¥å…· æ ¸å¿ƒèƒ½åŠ›ï¼š  æç¤ºæ¨¡æ¿åˆ›å»ºä¸ç®¡ç† åŠ¨æ€å†…å®¹æ ¼å¼åŒ– å¤šå˜é‡æ’å€¼æ”¯æŒ    5. è¾“å‡ºè§£æå™¨ (Output Parsers)  ä½œç”¨ï¼šå¤„ç†LLMè¿”å›çš„æ–‡æœ¬å†…å®¹ è½¬æ¢èƒ½åŠ›ï¼š  æ–‡æœ¬ â†’ JSONæ ¼å¼ æ–‡æœ¬ â†’ Pythonå¯¹è±¡ ç»“æ„åŒ–æ•°æ®æå–    6. Retrievers (æ£€ç´¢å™¨)  ç›®çš„ï¼šå¢å¼ºLLMç§æœ‰æ•°æ®å¤„ç†èƒ½åŠ› åŠŸèƒ½ï¼š  æ–‡æ¡£æ•°æ®åŠ è½½ æ–‡æœ¬åˆ‡å‰²åˆ†å— æ•°æ®å­˜å‚¨ä¸æ£€ç´¢   åº”ç”¨åœºæ™¯ï¼šRAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)æ¶æ„æ ¸å¿ƒç»„ä»¶  7. å‘é‡å­˜å‚¨ (Vector Stores)  ä½œç”¨ï¼šæ”¯æŒè¯­ä¹‰ç›¸ä¼¼æœç´¢ ç‰¹ç‚¹ï¼š  å¤šç§å‘é‡æ•°æ®åº“é›†æˆ é«˜ç»´å‘é‡ç©ºé—´æ•°æ®ç®¡ç† ç›¸ä¼¼å†…å®¹æ£€ç´¢ä¼˜åŒ–    8. Agents (æ™ºèƒ½ä½“)  å®šä¹‰ï¼šLLMé©±åŠ¨çš„åº”ç”¨è®¾è®¡æ¨¡å¼ æ ¸å¿ƒæ¶æ„ï¼š  å†³ç­–å¼•æ“ï¼šLLMä½œä¸º\u0026quot;å¤§è„‘\u0026quot; æ‰§è¡Œç³»ç»Ÿï¼šè‡ªåŠ¨è°ƒç”¨å¤–éƒ¨è®¾å¤‡/API   å·¥ä½œæµç¨‹ï¼š  æ¥æ”¶ç”¨æˆ·ä»»åŠ¡ LLMåˆ†æå†³ç­– è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿæ‰§è¡Œ è¿”å›ç»¼åˆç»“æœ    å…­ã€åº”ç”¨åœºæ™¯  å¯¹è¯æœºå™¨äººï¼šå®¢æœ/èŠå¤©åŠ©æ‰‹ çŸ¥è¯†åº“é—®ç­”ï¼šå¼€æ”¾åŸŸé—®é¢˜è§£ç­” æ™ºèƒ½å†™ä½œï¼š  åˆ›æ„å†™ä½œ æ–‡æœ¬æ‘˜è¦ å†…å®¹ç”Ÿæˆ    ä¸ƒã€å¿«é€Ÿå…¥é—¨ å®‰è£…æ­¥éª¤ # Pipå®‰è£…\rpip install langchain-openai\r# è®¾ç½®APIå¯†é’¥\rexport OPENAI_API_KEY=\u0026quot;sk-...\u0026quot;\råŸºç¡€ä½¿ç”¨ import logging from langchain.prompts import PromptTemplate from common.modeCommon import Model from config.config import Config \u0026#34;\u0026#34;\u0026#34;æç¤ºè¯æ¨¡æ¿ æç¤ºè¯æ¨¡æ¿æœ¬è´¨ä¸Šè·Ÿå¹³æ—¶å¤§å®¶ä½¿ç”¨çš„é‚®ä»¶æ¨¡æ¿ã€çŸ­ä¿¡æ¨¡æ¿æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ¨¡æ¿ï¼Œæ¨¡æ¿å¯ä»¥åŒ…å«ä¸€ç»„æ¨¡æ¿å‚æ•°ï¼Œ é€šè¿‡æ¨¡æ¿å‚æ•°å€¼å¯ä»¥æ›¿æ¢æ¨¡æ¿å¯¹åº”çš„å‚æ•°ã€‚ ä¸€ä¸ªæç¤ºè¯æ¨¡æ¿å¯ä»¥åŒ…å«ä¸‹é¢å†…å®¹ï¼š 1ã€å‘ç»™å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„æŒ‡ä»¤ã€‚ 2ã€ä¸€ç»„é—®ç­”ç¤ºä¾‹ï¼Œä»¥æé†’AIä»¥ä»€ä¹ˆæ ¼å¼è¿”å›è¯·æ±‚ã€‚ 3ã€å‘ç»™è¯­è¨€æ¨¡å‹çš„é—®é¢˜ã€‚ \u0026#34;\u0026#34;\u0026#34; class Prompt: def __init__(self): super(Prompt, self).__init__() def create_prompt(self, template, variables: list) -\u0026gt; PromptTemplate: return PromptTemplate(input_variables=variables, template=template) \u0026#34;\u0026#34;\u0026#34; åˆ›å»ºåŸºç¡€çš„æ¨¡æ¿ 1ã€ä½ æ˜¯è° 2ã€è¦å¹²ä»€ä¹ˆäº‹æƒ… 3ã€å¹²è¿™ä¸ªäº‹æƒ…éœ€è¦çš„ææ–™æ˜¯ä»€ä¹ˆ 4ã€æƒ³è¦ä»€ä¹ˆæ ·çš„ç»“æ„ \u0026#34;\u0026#34;\u0026#34; def base_prompt(self): # å®šä¹‰æç¤ºæ¨¡æ¿ template = \u0026#34;\u0026#34;\u0026#34; ä½ æ˜¯ä¸€ä¸ª{domain}é¢†åŸŸçš„èµ„æ·±{profession}éœ€è¦åšä¸€ä¸‹äº‹æƒ…: {do}ç»™ä½ ç›¸å…³ææ–™ä»¥ä¸‹: {material}éœ€è¦è¿”å›ä»¥ä¸‹ä¿¡æ¯ï¼š {question}\u0026#34;\u0026#34;\u0026#34; return self.create_prompt(variables=[\u0026#34;domain\u0026#34;, \u0026#34;profession\u0026#34;, \u0026#34;do\u0026#34;, \u0026#34;material\u0026#34;, \u0026#34;question\u0026#34;], template=template) def base_prompt_invoke(self, domain, profession, do, material, question): return { \u0026#34;domain\u0026#34;: domain, \u0026#34;profession\u0026#34;: profession, \u0026#34;do\u0026#34;: do, \u0026#34;material\u0026#34;: material, \u0026#34;question\u0026#34;: question, } \u0026#34;\u0026#34;\u0026#34; èŠå¤©æ¨¡å‹ï¼ˆChat Modelï¼‰ä»¥èŠå¤©æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥ï¼Œ è¿™ä¸ªèŠå¤©æ¶ˆæ¯åˆ—è¡¨çš„æ¶ˆæ¯å†…å®¹ä¹Ÿå¯ä»¥é€šè¿‡æç¤ºè¯æ¨¡æ¿è¿›è¡Œç®¡ç†ã€‚ è¿™äº›èŠå¤©æ¶ˆæ¯ä¸åŸå§‹å­—ç¬¦ä¸²ä¸åŒï¼Œå› ä¸ºæ¯ä¸ªæ¶ˆæ¯éƒ½ä¸â€œè§’è‰²(role)â€ç›¸å…³è”ã€‚ 1ã€éœ€è¦ç»™å®šèŠå¤©ä¸­è§’è‰² 2ã€ç»™å®šçš„èŠå¤©å†…å®¹æ˜¯ä»€ä¹ˆ \u0026#34;\u0026#34;\u0026#34; def chat_prompt(self): template = \u0026#34;\u0026#34;\u0026#34;\u0026#34; è¿™ä¸ªä¸€ä¸ªèŠå¤©çš„åœºæ™¯ï¼š (\u0026#34;system\u0026#34;, \u0026#34;ä½ æ˜¯ä¸€ä½{role}\u0026#34;), (\u0026#34;human\u0026#34;, \u0026#34;æˆ‘æ˜¯{human_role}\u0026#34;), (\u0026#34;human\u0026#34;, \u0026#34;{user_input}\u0026#34;), \u0026#34;\u0026#34;\u0026#34; return self.create_prompt(variables=[\u0026#34;role\u0026#34;, \u0026#34;human_role\u0026#34;, \u0026#34;user_input\u0026#34;], template=template) def chat_prompt_invoke(self, role, human_role, user_input): return { \u0026#34;role\u0026#34;: role, \u0026#34;human_role\u0026#34;: human_role, \u0026#34;user_input\u0026#34;: user_input, } if __name__ == \u0026#39;__main__\u0026#39;: logging.basicConfig(level=logging.INFO) # åˆå§‹åŒ–æ¨¡å‹é…ç½® config = Config(\u0026#39;conf/config.yml\u0026#39;) # åˆå§‹åŒ–æ¨¡å‹ model = Model(config) # # è°ƒç”¨qwenæ¨¡å‹ prompt = Prompt() base_prompt = prompt.base_prompt() chain = model.qwen_llm_china(base_prompt) result = (chain.invoke(prompt.base_prompt_invoke(\u0026#34;ç³»ç»Ÿè¿ç»´\u0026#34;, \u0026#34;è¿ç»´é«˜çº§å·¥ç¨‹å¸ˆ\u0026#34;, \u0026#34;æƒ³ç†è§£äº¤æ¢æœºåŸç†\u0026#34;, \u0026#34;æ— \u0026#34;, \u0026#34;ç®€çŸ­æ–‡å­—è¾“å‡º\u0026#34;))) print(result[\u0026#34;text\u0026#34;]) chat_prompt = prompt.chat_prompt() chain = model.qwen_llm_china(chat_prompt) result = chain.invoke(prompt.chat_prompt_invoke(\u0026#34;å¿ƒç†å­¦å®¶\u0026#34;,\u0026#34;å¿ƒç†æ‚£è€…\u0026#34;,\u0026#34;æ€ä¹ˆæ‰èƒ½è®©å¿ƒæƒ…å˜å¥½ï¼Œæ‹’ç»æŠ‘éƒå‘¢\u0026#34;)) print(result[\u0026#34;text\u0026#34;]) LangChain æ€ç»´å¯¼å›¾ \ræ•´ä½“æ€ç»´å¯¼å›¾\r\nä»£ç ä»“åº“è·¯å¾„ zcj-git520/AiLargeModel: å¤§æ¨¡å‹åº”ç”¨å¼€å‘å­¦ä¹ \n","date":"2025-01-18T22:00:38+08:00","image":"https://zcj-git520.github.io/p/langchain-%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90/5.svg","permalink":"https://zcj-git520.github.io/p/langchain-%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90/","title":"LangChain æ¡†æ¶è§£æ"},{"content":"æ·±å…¥è§£æ SNMP Exporter åœ¨ç°ä»£ç½‘ç»œæ¶æ„ä¸­ï¼Œå¯¹äº¤æ¢æœºã€è·¯ç”±å™¨ã€NAS ç­‰ç½‘ç»œè®¾å¤‡çš„ç›‘æ§è‡³å…³é‡è¦ã€‚Prometheus ä½œä¸ºä¸»æµçš„å¼€æºç›‘æ§ç³»ç»Ÿï¼Œä»¥å…¶æ—¶åºæ•°æ®å­˜å‚¨ã€çµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼ˆPromQLï¼‰å’Œä¸°å¯Œçš„ç”Ÿæ€ç»„ä»¶æˆä¸ºç›‘æ§é¢†åŸŸçš„æ ‡æ†ã€‚è€Œ SNMP Exporter ä½œä¸º Prometheus ç”Ÿæ€çš„å…³é”®ä¸€ç¯ï¼Œä¸“é—¨è§£å†³äº†ç½‘ç»œè®¾å¤‡çš„ç›‘æ§æ•°æ®é‡‡é›†é—®é¢˜ã€‚æœ¬æ–‡å°†ç»“åˆ Prometheus çš„æ ¸å¿ƒç‰¹æ€§ï¼Œä»ç»„ä»¶ç®€å†µã€éƒ¨ç½²æ¶æ„ã€é…ç½®æ ¼å¼åˆ°å·¥ä½œæµç¨‹ï¼Œå…¨é¢å‰–æ SNMP Exporter çš„æ ¸å¿ƒä»·å€¼ã€‚\nä¸€ã€SNMP Exporter Prometheus çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æ—¶åºæ•°æ®é‡‡é›†ã€å­˜å‚¨ä¸åˆ†æï¼Œå…¶å·¥ä½œæµç¨‹åŒ…æ‹¬ï¼šé€šè¿‡ exporter ç»„ä»¶é‡‡é›†ç›®æ ‡æŒ‡æ ‡ â†’ å­˜å‚¨åˆ°æ—¶åºæ•°æ®åº“ â†’ é€šè¿‡ PromQL æŸ¥è¯¢åˆ†æ â†’ ç»“åˆ Grafana å¯è§†åŒ–ã€‚ä½†ç½‘ç»œè®¾å¤‡ï¼ˆå¦‚äº¤æ¢æœºã€è·¯ç”±å™¨ï¼‰é€šå¸¸ä¸æ”¯æŒ Prometheus åŸç”Ÿçš„ HTTP æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡ SNMP åè®® æš´éœ²ç›‘æ§æ•°æ®ã€‚\nSNMP Exporter çš„æ ¸å¿ƒä½œç”¨ï¼šä½œä¸º Prometheus ä¸ç½‘ç»œè®¾å¤‡ä¹‹é—´çš„ â€œç¿»è¯‘å®˜â€ï¼Œé€šè¿‡ SNMP åè®®ä»è®¾å¤‡é‡‡é›†æ•°æ®ï¼Œè½¬æ¢ä¸º Prometheus å¯è¯†åˆ«çš„æŒ‡æ ‡æ ¼å¼ï¼ˆå¦‚ cpu_usage{device=\u0026quot;cisco-fw\u0026quot;} 25ï¼‰ï¼Œå®ç°ç½‘ç»œè®¾å¤‡ä¸ Prometheus ç”Ÿæ€çš„æ— ç¼å¯¹æ¥ã€‚\näºŒã€SNMP Exporter ç®€å†µ SNMP Exporter æ˜¯ Prometheus ç”Ÿæ€çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå…¶è®¾è®¡å›´ç»• Prometheus çš„ â€œæ‹‰å–å¼â€ï¼ˆPullï¼‰é‡‡é›†æ¨¡å‹å±•å¼€ï¼Œæ ¸å¿ƒä»·å€¼ä½“ç°åœ¨ä¸‰ä¸ªæ–¹é¢ï¼š\n  æ ‡å‡†åŒ–é‡‡é›†ï¼šé€šè¿‡è‡ªå¸¦çš„ generator å·¥å…·è§£æ MIB æ–‡ä»¶ï¼ˆç½‘ç»œè®¾å¤‡çš„ â€œå­—å…¸â€ï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆ OID ä¸ Prometheus æŒ‡æ ‡çš„æ˜ å°„é…ç½®ï¼ˆsnmp.ymlï¼‰ï¼Œæ”¯æŒå¤šå‚å•†è®¾å¤‡çš„ç»Ÿä¸€é‡‡é›†é€»è¾‘ã€‚\n  çµæ´»éƒ¨ç½²ï¼šæ”¯æŒ Docker å¿«é€Ÿéƒ¨ç½²å’ŒäºŒè¿›åˆ¶é•¿æœŸè¿è¡Œï¼Œå¯ç›´æ¥è¢« Prometheus çš„ scrape_configs é…ç½®é¡¹æŠ“å–ï¼Œæ— éœ€é¢å¤–é€‚é…ã€‚\n  å¹¿æ³›åº”ç”¨ï¼šè¦†ç›– Ciscoã€Arista ç­‰ä¸»æµç½‘ç»œè®¾å¤‡ï¼Œä»¥åŠ Synology NAS ç­‰å­˜å‚¨è®¾å¤‡ï¼Œå®Œç¾å¡«è¡¥äº† Prometheus åœ¨ SNMP è®¾å¤‡ç›‘æ§ä¸­çš„ç©ºç™½ã€‚\n  ä¸‰ã€éƒ¨ç½²æ¶æ„ï¼šSNMP Exporter ä¸ Prometheus çš„é›†æˆ 3.1 éƒ¨ç½²æ–¹å¼ SNMP Exporter æä¾›ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œå‡éœ€ä¸ Prometheus é…ç½®è”åŠ¨ï¼š\n   éƒ¨ç½²æ–¹å¼ é€‚ç”¨åœºæ™¯ æ“ä½œæ­¥éª¤ï¼ˆå« Prometheus é…ç½®ï¼‰     Docker å¿«é€ŸåŸå‹éªŒè¯ 1. å¯åŠ¨ SNMP Exporter å®¹å™¨ï¼šdocker run -d -p 9116:9116 -v ./snmp.yml:/etc/snmp_exporter/snmp.yml prom/snmp-exporter2. åœ¨ Prometheus é…ç½®ä¸­æ·»åŠ æŠ“å–è§„åˆ™ï¼šyaml\u0026lt;br\u0026gt;scrape_configs:\u0026lt;br\u0026gt; - job_name: 'snmp'\u0026lt;br\u0026gt; static_configs:\u0026lt;br\u0026gt; - targets: ['192.168.1.1'] # ç½‘ç»œè®¾å¤‡ IP\u0026lt;br\u0026gt; metrics_path: /snmp\u0026lt;br\u0026gt; params:\u0026lt;br\u0026gt; module: [cisco_firewall] # å¯¹åº” snmp.yml ä¸­çš„æ¨¡å—\u0026lt;br\u0026gt; relabel_configs:\u0026lt;br\u0026gt; - source_labels: [__address__]\u0026lt;br\u0026gt; target_label: __param_target\u0026lt;br\u0026gt; - source_labels: [__param_target]\u0026lt;br\u0026gt; target_label: instance\u0026lt;br\u0026gt; - target_label: __address__\u0026lt;br\u0026gt; replacement: localhost:9116 # SNMP Exporter åœ°å€\u0026lt;br\u0026gt;   äºŒè¿›åˆ¶ ç”Ÿäº§ç¯å¢ƒ 1. ä¸‹è½½äºŒè¿›åˆ¶åŒ…å¹¶è¿è¡Œï¼š./snmp_exporter --config.file=snmp.yml2. åŒä¸Šé…ç½® Prometheus çš„ scrape_configsï¼Œå°† replacement æŒ‡å‘ SNMP Exporter æ‰€åœ¨æœåŠ¡å™¨çš„ IP: ç«¯å£ã€‚    3.2 é›†ç¾¤éƒ¨ç½²ä¸ Prometheus è°ƒåº¦  é«˜å¯ç”¨è®¾è®¡ï¼šSNMP Exporter æœ¬èº«ä¸æ”¯æŒé›†ç¾¤ï¼Œä½†å¯éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œç”± Prometheus é€šè¿‡ scrape_configs é…ç½®å¤šç›®æ ‡æŠ“å–ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚ä¾‹å¦‚ï¼š  scrape_configs: - job_name: \u0026#39;snmp-cluster\u0026#39; static_configs: - targets: [\u0026#39;192.168.1.1\u0026#39;, \u0026#39;192.168.1.2\u0026#39;] # å¤šä¸ªç½‘ç»œè®¾å¤‡ metrics_path: /snmp params: { module: [cisco_firewall] } relabel_configs: - source_labels: [__address__] target_label: __param_target - source_labels: [__param_target] target_label: instance - target_label: __address__ replacement: \u0026#39;snmp-exporter-1:9116,snmp-exporter-2:9116\u0026#39; # å¤šä¸ª Exporter å®ä¾‹  æ€§èƒ½ä¼˜åŒ–ï¼šå•å®ä¾‹é«˜å¹¶å‘é‡‡é›†è¶…æ—¶å¯é€šè¿‡ --snmp.module-concurrency è°ƒæ•´å¹¶å‘æ•°ï¼Œé…åˆ Prometheus çš„ scrape_intervalï¼ˆé‡‡é›†é—´éš”ï¼‰å’Œ timeout å‚æ•°é¿å…æ•°æ®ä¸¢å¤±ã€‚  å››ã€SNMP Exporter é…ç½® SNMP Exporter çš„ snmp.yml é…ç½®ç›´æ¥å†³å®šäº† Prometheus æœ€ç»ˆé‡‡é›†åˆ°çš„æŒ‡æ ‡æ ¼å¼ï¼Œéœ€éµå¾ª Prometheus çš„æŒ‡æ ‡å‘½åè§„èŒƒï¼ˆå¦‚å°å†™å­—æ¯ã€ä¸‹åˆ’çº¿åˆ†éš”ï¼‰ã€‚\n4.1 é…ç½®ç¤ºä¾‹ï¼ˆä¸ Prometheus æŒ‡æ ‡å¯¹åº”ï¼‰ modules:\rcisco_firewall: # é’ˆå¯¹ Cisco é˜²ç«å¢™çš„æ¨¡å—\rwalk: # éå†é‡‡é›†çš„ OID èŒƒå›´\r- 1.3.6.1.2.1.1.3 # sysUpTimeï¼ˆç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼‰\r- 1.3.6.1.4.1.9.9.109.1.1.1.1.5 # CPU ä½¿ç”¨ç‡\rmetrics: # æ˜ å°„ä¸º Prometheus æŒ‡æ ‡\r- name: sys_uptime # Prometheus æŒ‡æ ‡åï¼ˆç¬¦åˆè§„èŒƒï¼‰\roid: 1.3.6.1.2.1.1.3.0\rtype: gauge # Prometheus æŒ‡æ ‡ç±»å‹ï¼ˆgauge æ”¯æŒæ³¢åŠ¨å€¼ï¼‰\rhelp: \u0026quot;ç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰\u0026quot; # å¯¹åº” Prometheus æŒ‡æ ‡çš„ HELP ä¿¡æ¯\r- name: cpu_usage\roid: 1.3.6.1.4.1.9.9.109.1.1.1.1.5\rtype: gauge\rhelp: \u0026quot;CPU ä½¿ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰\u0026quot;\råœ¨ Prometheus ä¸­æŸ¥è¯¢è¯¥æŒ‡æ ‡çš„ç¤ºä¾‹ï¼š\n# æŸ¥çœ‹æ‰€æœ‰ Cisco é˜²ç«å¢™çš„ CPU ä½¿ç”¨ç‡\rcpu_usage{module=\u0026quot;cisco_firewall\u0026quot;}\r# ç­›é€‰ä½¿ç”¨ç‡è¶…è¿‡ 80% çš„è®¾å¤‡\rcpu_usage{module=\u0026quot;cisco_firewall\u0026quot;} \u0026gt; 80\r4.2 æ ¸å¿ƒå­—æ®µä¸ Prometheus æŒ‡æ ‡å…³è”    å­—æ®µ ä¸ Prometheus å…³è”è¯´æ˜     name ç›´æ¥ä½œä¸º Prometheus æŒ‡æ ‡åï¼Œéœ€ç®€æ´ä¸”ç¬¦åˆå‘½åè§„èŒƒï¼ˆå¦‚ network_interface_in_bytesï¼‰ã€‚   type å¯¹åº” Prometheus çš„æŒ‡æ ‡ç±»å‹ï¼šgaugeï¼ˆå¦‚ CPU ä½¿ç”¨ç‡ï¼‰ã€counterï¼ˆå¦‚ç´¯è®¡æµé‡ï¼‰ï¼Œå½±å“ PromQL è®¡ç®—æ–¹å¼ï¼ˆå¦‚ rate() å‡½æ•°é€‚ç”¨äº counterï¼‰ã€‚   help ç”Ÿæˆ Prometheus æŒ‡æ ‡çš„ HELP ä¿¡æ¯ï¼ˆå¦‚ # HELP cpu_usage CPU ä½¿ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼‰ï¼Œæå‡æŒ‡æ ‡å¯è¯»æ€§ã€‚   index_oids ä¸º Prometheus æŒ‡æ ‡æ·»åŠ æ ‡ç­¾ï¼ˆLabelï¼‰ï¼Œå®ç°å¤šç»´åº¦åˆ†æï¼ˆå¦‚ interface æ ‡ç­¾åŒºåˆ†ä¸åŒç½‘å¡ï¼‰ã€‚    äº”ã€Generatorå·¥å…·é…ç½®è§£ææµç¨‹ 5.1å…¨æµç¨‹å›¾ \rimg\r\n5.2è¯¦ç»†æµç¨‹è¯´æ˜ ï¼ˆ1ï¼‰MIBè§£æé˜¶æ®µ  åŸºç¡€MIBåŠ è½½ï¼šä¼˜å…ˆè§£æSNMPv2æ ‡å‡†åº“ï¼ˆSMIå®šä¹‰æ•°æ®ç±»å‹ï¼ŒTCå®šä¹‰æ–‡æœ¬çº¦å®šï¼ŒCONFå®šä¹‰æ¨¡å—åˆè§„æ€§ï¼‰ã€‚ ä¾èµ–åˆ†æï¼šé€’å½’è§£æMIBæ–‡ä»¶é—´çš„IMPORTSä¾èµ–ï¼Œç¡®ä¿å®Œæ•´OIDæ ‘æ„å»ºã€‚ OIDæ ‘æ„å»ºï¼šå°†OIDç»„ç»‡ä¸ºæ ‘çŠ¶ç»“æ„ï¼ˆå¦‚.1.3.6.1.2.1.1å¯¹åº”systemç»„ï¼‰ã€‚ TRAPå¤„ç†ï¼šæå–é€šçŸ¥ç±»å‹å®šä¹‰ï¼ˆå¦‚linkDownï¼‰ï¼Œç”¨äºäº‹ä»¶ç›‘æ§  \rimg\r\nï¼ˆ2ï¼‰OIDè¯­ä¹‰æå–   ç±»å‹è¯†åˆ«\n  Counter32/64 â†’ intç±»å‹\n  Gauge32 â†’ æµ®ç‚¹æ•°\n  OctetString â†’ string\n    æè¿°æ–‡æœ¬è§£æï¼šä»DESCRIPTIONå­—æ®µæå–æŒ‡æ ‡å«ä¹‰ï¼ˆå¦‚sysUpTimeâ†’ç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼‰ã€‚\n  è¡¨ç´¢å¼•å¤„ç†ï¼šè¯†åˆ«ç±»ä¼¼ifIndexçš„ç´¢å¼•é”®ï¼Œå…³è”å¤šç»´åº¦æ•°æ®ï¼ˆå¦‚ç½‘å¡æµé‡è¡¨ï¼‰ã€‚\n  æšä¸¾å€¼è½¬æ¢ï¼šå°†æ•°å­—æšä¸¾æ˜ å°„ä¸ºæ–‡æœ¬ï¼ˆå¦‚ifOperStatusï¼š1=up, 2=downï¼‰\n  \rimg\r\nï¼ˆ3ï¼‰è§„åˆ™åº”ç”¨  generator.yml è‡ªå®šä¹‰æ ¼å¼  modules: \\# æ¨¡å—åç§°ï¼ˆå¯¹åº”è®¾å¤‡ç±»å‹ï¼‰ cisco_asa: walk: \\- 1.3.6.1.2.1.1 # ç³»ç»Ÿç»„ \\- 1.3.6.1.2.1.2 # æ¥å£ç»„ \\# æŒ‡æ ‡é‡å‘½åï¼ˆå®ç°ç»Ÿä¸€å‘½åï¼‰ overrides: ifInOctets: regex_extracts: \u0026#34;\u0026#34;: - value # åŸå§‹ OID \\# æ˜ å°„ä¸ºç»Ÿä¸€æŒ‡æ ‡å name: \u0026#34;network_interface_in_bytes\u0026#34; huawei_firewall: walk: \\- 1.3.6.1.4.1.2011.6 overrides: hwSecurityCpuUsage: name: \u0026#34;system_cpu_usage_percent\u0026#34;  æŒ‡æ ‡é‡å‘½åï¼ˆæ ‡å‡†æŒ‡æ ‡åï¼‰ï¼šå°†å†—é•¿OIDåè½¬ä¸ºç®€æ´æ ‡å‡†PrometheusæŒ‡æ ‡åï¼ˆä¾‹ï¼šUCD-SNMP-MIBâ†’ssCpuIdleï¼‰  \rimg\r\n  ç±»å‹è¦†ç›–ï¼šå¼ºåˆ¶æŒ‡å®šæ•°æ®ç±»å‹ï¼ˆå¦‚å°†è¯¯è¯†åˆ«ä¸ºGaugeçš„Counterä¿®æ­£ï¼‰\n  å€¼è½¬æ¢:\n  scaleï¼šæ•°å€¼å•ä½è½¬æ¢ï¼ˆä¾‹ï¼šscale: 0.001 å°†KBè½¬ä¸ºMBï¼‰\n  regex_extracts: æ•°æ®æ›¿æ¢ç­‰\n  å¦‚ï¼šGenerator.yml\n    \rimg\r\nï¼ˆ4ï¼‰é…ç½®ç”Ÿæˆ \rimg\r\nå…­ã€æ€»ç»“ï¼šSNMP Exporter å¯¹ Prometheus ç”Ÿæ€çš„ä»·å€¼ SNMP Exporter ä½œä¸º Prometheus ç”Ÿæ€çš„é‡è¦è¡¥å……ï¼Œè§£å†³äº†ç½‘ç»œè®¾å¤‡é€šè¿‡ SNMP åè®®æš´éœ²æ•°æ®çš„é‡‡é›†éš¾é¢˜ï¼Œå…¶æ ¸å¿ƒä»·å€¼åœ¨äºï¼š\n  ç”Ÿæ€æ— ç¼å¯¹æ¥ï¼šå°† SNMP æ•°æ®æ ‡å‡†åŒ–ä¸º Prometheus æŒ‡æ ‡ï¼Œè®©ç½‘ç»œè®¾å¤‡ç›‘æ§èå…¥ç»Ÿä¸€çš„æ—¶åºæ•°æ®ä½“ç³»ã€‚\n  çµæ´»é€‚é…å¤šå‚å•†ï¼šé€šè¿‡ MIB è§£æå’Œè§„åˆ™é…ç½®ï¼Œæ”¯æŒä¸åŒå“ç‰Œè®¾å¤‡çš„ç›‘æ§ï¼Œé¿å…é‡å¤å¼€å‘ã€‚\n  å…¼å®¹ Prometheus æœ€ä½³å®è·µï¼šç”Ÿæˆçš„æŒ‡æ ‡æ”¯æŒ Label å¤šç»´åº¦åˆ†æã€PromQL èšåˆè®¡ç®—å’Œ Grafana å¯è§†åŒ–ï¼Œæ„å»ºå®Œæ•´çš„ç›‘æ§é—­ç¯ã€‚\n  ","date":"2023-12-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90-snmp-exporter/1_hu40d5ff5869a4756969dfc1f40badba91_17406_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90-snmp-exporter/","title":"æ·±å…¥è§£æ SNMP Exporter"},{"content":"Prometheus ç›‘æ§ä½“ç³»ï¼šåŸç†ã€å®è·µã€é…ç½®ä¸æ‹“å±• åœ¨ç°ä»£å¤æ‚ç³»ç»Ÿæ¶æ„é‡Œï¼Œç›‘æ§ä½“ç³»æ˜¯ä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œã€å¿«é€Ÿæ’éšœçš„å…³é”®ã€‚Prometheus å‡­å€Ÿæ ‡å‡†åŒ–æ•°æ®æµç¨‹ã€çµæ´»æ‹“å±•èƒ½åŠ›ï¼Œæˆä¸ºäº‘åŸç”Ÿç›‘æ§çš„æ ¸å¿ƒæ–¹æ¡ˆã€‚æœ¬æ–‡ç»“åˆæ¶æ„è®¾è®¡ï¼Œæ·±åº¦æ‹†è§£å…¶åŸç†ã€å®è·µä¸é…ç½®è¦ç‚¹ï¼Œæ•™ä½ æ­å»ºå…¨é“¾è·¯å¯è§‚æµ‹ä½“ç³»ã€‚\nä¸€ã€æ•°æ®æ ¼å¼ï¼šç›‘æ§çš„ â€œé€šç”¨è¯­è¨€â€ Prometheus ç”¨æ ‡å‡†åŒ–æ ¼å¼å®šä¹‰æŒ‡æ ‡ï¼Œè®©ç›‘æ§æ•°æ®æœ‰æ¸…æ™°è¯­ä¹‰ï¼Œæ˜¯åˆ†æçš„åŸºç¡€ã€‚\nï¼ˆä¸€ï¼‰æŒ‡æ ‡æ ‡è¯†è§„åˆ™ æŒ‡æ ‡æ ¼å¼ä¸º {=, \u0026hellip;} ï¼Œæ¯”å¦‚ api_http_requests_total{method=\u0026ldquo;POST\u0026rdquo;, handler=\u0026quot;/messages\u0026quot;} ï¼Œæ‹†è§£æ¥çœ‹ï¼š\n  æŒ‡æ ‡åç§°ï¼šè¦èƒ½ç›´è§‚ä½“ç°ç›‘æ§å†…å®¹ï¼Œåƒ http_request_total å°±æ˜¯è®°å½• HTTP è¯·æ±‚æ€»é‡ ã€‚å‘½åå¾—ç¬¦åˆæ­£åˆ™ [a-zA-Z_:][a-zA-Z0-9_:]* ï¼Œç”¨ ASCII å­—ç¬¦ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€å†’å·ç»„åˆï¼Œåº•å±‚å®é™…å­˜æˆ name=ï¼Œæ–¹ä¾¿ç³»ç»Ÿè¯†åˆ«ã€‚\n  æ ‡ç­¾ï¼ˆLabelï¼‰ï¼šç”¨æ¥æè¿°æ ·æœ¬ç‰¹å¾ï¼Œæ–¹ä¾¿åç»­è¿‡æ»¤ã€èšåˆæ•°æ®ã€‚åç§°å¾—æ˜¯ [a-zA-Z_][a-zA-Z0-9_]* è§„åˆ™çš„ ASCII ç»„åˆï¼Œ__ å¼€å¤´æ˜¯ç³»ç»Ÿä¿ç•™çš„ï¼Œåˆ«ä¹±ç”¨ï¼›å€¼å°±çµæ´»å¤šäº†ï¼Œä»»æ„ Unicode å­—ç¬¦éƒ½è¡Œï¼Œé€‚é…å„ç§ä¸šåŠ¡åœºæ™¯æ‰“æ ‡ç­¾ã€‚\n  ï¼ˆäºŒï¼‰æ—¶é—´åºåˆ—ä¸æ ·æœ¬æ„æˆ Prometheus æŠŠç›‘æ§æ•°æ®å­˜æˆæ—¶é—´åºåˆ—ï¼ˆtime-seriesï¼‰ï¼Œæ¯ä¸ªåºåˆ—ç”± â€œæŒ‡æ ‡åç§° + æ ‡ç­¾é›†â€ å”¯ä¸€ç¡®å®šã€‚åºåˆ—é‡Œçš„ ** æ ·æœ¬ï¼ˆsampleï¼‰** åŒ…å«ä¸‰éƒ¨åˆ†ï¼š\n  æŒ‡æ ‡ï¼ˆmetricï¼‰ï¼šåç§°åŠ æ ‡ç­¾é›†ï¼Œç²¾å‡†æè¿°æ ·æœ¬ç‰¹å¾ï¼›\n  æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ï¼šç²¾ç¡®åˆ°æ¯«ç§’ï¼Œè®°å½•æ•°æ®äº§ç”Ÿçš„æ—¶åˆ»ï¼›\n  æ ·æœ¬å€¼ï¼ˆvalueï¼‰ï¼šç”¨ float64 æµ®ç‚¹å‹ï¼Œå­˜å…·ä½“çš„ç›‘æ§æ•°å€¼ã€‚\n  ï¼ˆä¸‰ï¼‰å››ç§æ ¸å¿ƒæŒ‡æ ‡ç±»å‹ ä¸ºäº†è¦†ç›–ä¸åŒç›‘æ§åœºæ™¯ï¼ŒPrometheus è®¾è®¡äº†å››ç±»æŒ‡æ ‡ï¼š\n  Counterï¼ˆè®¡æ•°å™¨ï¼‰ï¼šåªä¼šå•è°ƒé€’å¢ï¼Œé€‚åˆç»Ÿè®¡è¯·æ±‚æ•°ã€ä»»åŠ¡å®Œæˆæ•°ã€é”™è¯¯æ¬¡æ•°è¿™äº›ï¼Œä¸€ç›´å¾€ä¸ŠåŠ ï¼Œä¸ä¼šé™ã€‚æ¯”å¦‚ç»Ÿè®¡ httpè¯·æ±‚æ€»æ•° ï¼Œå°±ç”¨å®ƒã€‚\n  Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ï¼šæ•°å€¼å¯å¢å¯å‡ï¼Œåƒå†…å­˜ä½¿ç”¨ç‡ã€å½“å‰å¹¶å‘è¯·æ±‚æ•°è¿™ç§åŠ¨æ€å˜åŒ–çš„ï¼Œå°±ç”¨å®ƒã€‚è¿˜æ”¯æŒåšæ±‚å’Œã€ç®—å‡å€¼ã€æ‰¾æå€¼è¿™äº›è®¡ç®—ï¼Œæ¯”å¦‚ node_memory_MemFree çœ‹ä¸»æœºç©ºé—²å†…å­˜ ã€‚\n  Histogramï¼ˆç›´æ–¹å›¾ï¼‰ï¼šä¸»è¦ç”¨æ¥åˆ†æè¯·æ±‚è€—æ—¶ã€å“åº”å¤§å°è¿™ç±»æ•°æ®çš„åˆ†å¸ƒã€‚é€šè¿‡ â€œå­˜å‚¨æ¡¶ï¼ˆbucketï¼‰â€ ç»Ÿè®¡ï¼Œèƒ½è®°å½•æ ·æœ¬æ€»å’Œï¼ˆsumï¼‰ã€æ¬¡æ•°ï¼ˆcountï¼‰è¿˜æœ‰æ¡¶çš„è¾¹ç•Œï¼Œåƒåˆ†æç£ç›˜ä½¿ç”¨ç‡ã€è¯·æ±‚æ€»æ¬¡æ•°åˆ†å¸ƒï¼Œå°±é å®ƒã€‚\n  Summaryï¼ˆæ‘˜è¦ï¼‰ï¼šç›´æ¥å­˜åˆ†ä½æ•°ï¼ˆå®¢æˆ·ç«¯è‡ªå·±ç®—å¥½ï¼‰ï¼Œä¸ç”¨åƒ Histogram é‚£æ ·ä¾èµ–å‡½æ•°ç®—ã€‚è¦æ˜¯æƒ³ç²¾å‡†ç»Ÿè®¡è¯·æ±‚è€—æ—¶ã€å“åº”å¤§å°çš„åˆ†ä½æƒ…å†µï¼Œæ¯”å¦‚ go_gc_duration_seconds_count çœ‹ GC æ€»æ¬¡æ•° ï¼Œç”¨å®ƒå°±å¾ˆæ–¹ä¾¿ã€‚\n  äºŒã€ä¼ è¾“åè®®ä¸æ–¹å¼ï¼šæ•°æ®æ€ä¹ˆ â€œè·‘â€ èµ·æ¥ ç›‘æ§æ•°æ®è¦åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ è¾“ï¼Œå¾—ç¡®å®šå¥½åè®®å’Œæ–¹å¼ï¼Œä¿è¯é‡‡é›†é«˜æ•ˆã€ç¨³å®šã€‚\nï¼ˆä¸€ï¼‰ä¼ è¾“åè®® Prometheus æœ€å¸¸ç”¨çš„æ˜¯ HTTP åè®® æ¥æ‹‰æ•°æ®ï¼Œé…ç½®å¥½ agent çš„ HTTP æ¥å£ï¼Œå®šæ—¶å‘ GET è¯·æ±‚å»é‡‡é›†ã€‚å½“ç„¶ï¼Œä¹Ÿæ”¯æŒæœ¬åœ°æ–‡ä»¶ã€RPCã€é˜Ÿåˆ—è¿™äº›æ–¹å¼ï¼Œçµæ´»é€‚é…ä¸åŒéƒ¨ç½²æƒ…å†µã€‚æ¯”å¦‚ç›‘æ§æœåŠ¡å’Œ agent åœ¨åŒä¸€å°æœºå™¨ï¼Œå°±å¯ä»¥æœ¬åœ°è¯»æ–‡ä»¶ï¼›è·¨æœºå™¨éƒ¨ç½²ï¼Œå°±ç”¨ç½‘ç»œåè®®ä¼ è¾“ã€‚\nï¼ˆäºŒï¼‰ä¼ è¾“æ–¹å¼ ä»ç›‘æ§æœåŠ¡å™¨çš„è§’åº¦çœ‹ï¼Œæœ‰ä¸¤ç§ä¼ è¾“æ¨¡å¼ï¼š\n  ä¸»åŠ¨æ‹‰å–ï¼ˆPullï¼‰ï¼šPrometheus ä¸»åŠ¨å‡ºå‡»ï¼Œå®šæ—¶è°ƒç”¨ agent çš„ HTTP æ¥å£æˆ–è€… RPC æ–¹æ³•ï¼ŒæŠŠæ•°æ®æ‹¿è¿‡æ¥ã€‚åƒç”¨ node_exporter æ‹‰å–ä¸»æœºæŒ‡æ ‡ï¼Œå°±æ˜¯å…¸å‹çš„ä¸»åŠ¨æ‹‰å–ã€‚\n  è¢«åŠ¨æ¨é€ï¼ˆPushï¼‰ï¼šagent ä¸»åŠ¨æŠŠæ•°æ®æ¨åˆ°é˜Ÿåˆ—æˆ–è€…æ•°æ®åº“é‡Œï¼ŒPrometheus å†å®šæ—¶ä»è¿™äº›åœ°æ–¹æŠŠæ•°æ®æå‡ºæ¥ã€‚è¿™ç§é€‚åˆé‚£äº›æ²¡åŠæ³•ä¸»åŠ¨æš´éœ²æ¥å£çš„åœºæ™¯ï¼Œæ¯”å¦‚æœ‰äº›ç¬¬ä¸‰æ–¹æœåŠ¡çš„ç›‘æ§ã€‚\n  ä¸‰ã€æ‹“å±•ç›‘æ§å¯¹è±¡ï¼šè®©ç›‘æ§ â€œè§¦è§’â€ æ›´å…¨ ç³»ç»Ÿé‡Œçš„ç›‘æ§å¯¹è±¡å¤šç§å¤šæ ·ï¼Œå¾—é’ˆå¯¹æ€§å¤„ç†ï¼Œä¿è¯ç›‘æ§ä½“ç³»èƒ½æ‰©å±•ã€‚\nï¼ˆä¸€ï¼‰ä¸¤ç±»ç›‘æ§å¯¹è±¡çš„é€‚é…æ–¹æ³•   èƒ½éƒ¨ç½² agent çš„åœºæ™¯ï¼šåƒå¾®æœåŠ¡è¿™ç§ï¼Œç›´æ¥åœ¨è¦ç›‘æ§çš„å¯¹è±¡ä¸Šè£… agentï¼ˆæ¯”å¦‚ exporter ï¼‰ã€‚agent è´Ÿè´£é‡‡é›†è¿è¡Œæ•°æ®ï¼ŒæŒ‰ç…§ Prometheus çš„æ ¼å¼æ‰“åŒ…å¥½ï¼Œå†é€šè¿‡ä¸»åŠ¨æˆ–è€…è¢«åŠ¨çš„æ–¹å¼ï¼ŒæŠŠæ•°æ®ä¼ ç»™æœåŠ¡ç«¯ã€‚\n  å—é™åœºæ™¯ï¼ˆæ²¡æ³•éƒ¨ç½² / æ”¹ä»£ç ï¼‰ï¼šåƒ MySQLã€Redis è¿™äº›ä¸­é—´ä»¶ï¼Œæˆ–è€…æ·˜å®ã€ç™¾åº¦è¿™ç±»ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå°±å¾—ç”¨ â€œä¸­é—´ agentâ€ã€‚ä¸­é—´ agent å»è¿æ¥ç›®æ ‡æœåŠ¡ï¼ˆæ¯”å¦‚ç”¨ MySQL åè®®ã€è°ƒç”¨ç¬¬ä¸‰æ–¹ API ï¼‰ï¼ŒæŠŠè¿è¡ŒçŠ¶æ€ï¼ˆè¿æ¥æ•°ã€å¥åº·çŠ¶æ€è¿™äº› ï¼‰é‡‡é›†è¿‡æ¥ï¼Œå†æŒ‰ç…§ Prometheus çš„æ ¼å¼å°è£…å¥½ï¼Œæä¾›æ¥å£è®© Prometheus æ‹‰å–ï¼Œæˆ–è€…ç›´æ¥ä¸»åŠ¨æŠŠæ•°æ®æ¨è¿‡å»ã€‚\n  ï¼ˆäºŒï¼‰æ‹“å±•çš„æ ¸å¿ƒæ¡ä»¶ ä¸ç®¡ç›‘æ§å•¥å¯¹è±¡ï¼Œæƒ³æ‹“å±•ç›‘æ§ä½“ç³»ï¼Œå¾—æ»¡è¶³è¿™äº›æ¡ä»¶ï¼š\n  agent ä¾èµ–ï¼šç›®æ ‡å¯¹è±¡å¾—èƒ½è¢« agent é‡‡é›†åˆ°ï¼Œè¦ä¹ˆç›´æ¥è£… agentï¼Œè¦ä¹ˆé€šè¿‡ä¸­é—´ agent ä»£ç†ï¼›\n  æ ¼å¼ç»Ÿä¸€ï¼šæ•°æ®å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ Prometheus çš„æŒ‡æ ‡æ ¼å¼æ¥ï¼Œè¿™æ ·æ‰èƒ½è¢«è¯†åˆ«ï¼›\n  åè®®å’Œæ–¹å¼ä¸€è‡´ï¼šä¼ è¾“ç”¨çš„åè®®ï¼ˆHTTP/RPC è¿™äº› ï¼‰ã€ä¼ è¾“æ–¹å¼ï¼ˆæ‹‰å–è¿˜æ˜¯æ¨é€ ï¼‰ï¼Œå¾—å’Œæ•´ä¸ªç›‘æ§ä½“ç³»åŒ¹é…ä¸Šï¼›\n  æœåŠ¡ç«¯é…ç½®ï¼šPrometheus è¿™è¾¹å¾—é…ç½®å¥½å¯¹åº”çš„é‡‡é›†æ¥å£ã€å®šæ—¶ä»»åŠ¡ï¼Œä¿è¯èƒ½æŒç»­æ‹¿åˆ°æ•°æ®ã€‚è¦æ˜¯åŠ¨æ€æ›´æ–°ç›‘æ§å¯¹è±¡ï¼Œè¿˜å¾—é€šè¿‡é…ç½®æœåŠ¡å®ç°çƒ­åŠ è½½ã€‚\n  å››ã€Prometheus ä¸ Grafana äº¤äº’ï¼šè®©æ•°æ® â€œçœ‹å¾—è§â€ Grafana æ˜¯å¯è§†åŒ–çš„å¥½å¸®æ‰‹ï¼Œå’Œ Prometheus é…åˆèµ·æ¥ï¼Œèƒ½æŠŠç›‘æ§æ•°æ®å˜æˆç›´è§‚çš„å›¾è¡¨ã€‚ä»¥ç›‘æ§ä¸»æœºä¸ºä¾‹ï¼Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š\nï¼ˆä¸€ï¼‰éƒ¨ç½² exporter åœ¨ä¸»æœºä¸Šè£… node_exporter ï¼Œå®ƒä¼šé‡‡é›†ä¸»æœºçš„å„ç§ä¿¡æ¯ï¼Œåƒ CPUã€å†…å­˜ã€ç£ç›˜è¿™äº›ï¼Œç„¶åæš´éœ²ä¸€ä¸ª HTTP æ¥å£ï¼ŒæŠŠ metrics æ•°æ®æä¾›å‡ºå»ã€‚\n\r\nï¼ˆäºŒï¼‰Prometheus é…ç½® åœ¨ Prometheus æœåŠ¡ç«¯ï¼ŒæŠŠ node_exporter çš„æ¥å£é…ç½®å¥½ï¼Œå®šæ—¶å»æ‹‰å–æ•°æ®ã€‚æ‹‰å›æ¥ä¹‹åï¼Œå…ˆæ ¼å¼åŒ–å¤„ç†ï¼Œå†å­˜åˆ°å†…å­˜æ•°æ®åº“é‡Œï¼ˆä¹Ÿä¼šæŒä¹…åŒ–åˆ°ç¡¬ç›˜ ï¼‰ã€‚\n\r\nï¼ˆä¸‰ï¼‰Grafana å¯¹æ¥ Grafana çš„åç«¯è¦é…ç½® Prometheus ä½œä¸ºæ•°æ®æºï¼Œæ ¹æ®å¯è§†åŒ–çš„éœ€æ±‚ï¼ˆæ¯”å¦‚åšä¸ªå¤§å±æ¨¡æ¿ ï¼‰ï¼Œä» Prometheus é‡ŒæŠŠæŒ‡æ ‡æ•°æ®æ‹‰è¿‡æ¥ã€‚å‰ç«¯å†æŠŠè¿™äº›æ•°æ®æ¸²æŸ“å‡ºæ¥ï¼Œç›´è§‚åœ°å±•ç¤ºåœ¨ç›‘æ§å¤§å±ä¸Šï¼Œå®Œæˆ â€œæ•°æ®é‡‡é›†â†’å­˜å‚¨â†’å¯è§†åŒ–â€ çš„é—­ç¯ã€‚å¦å¤–ï¼ŒPrometheus å’Œ Grafana éƒ½æœ‰ APIï¼Œæ”¯æŒè‡ªå®šä¹‰çš„æ•°æ®äº¤äº’ï¼Œæ¯”å¦‚äºŒæ¬¡å¼€å‘ã€å¯¼å‡ºæ•°æ®å•¥çš„ã€‚\n\r\näº”ã€åŠ¨æ€æ›´æ–°ç›‘æ§å¯¹è±¡ï¼šè®©ç›‘æ§ â€œæ›´èªæ˜â€ Prometheus éœ€è¦åŠ¨æ€é€‚åº”ç›‘æ§å¯¹è±¡çš„å˜åŒ–ï¼Œå®ç°çƒ­åŠ è½½ï¼Œè¿™æ ·ä¸ç”¨é‡å¯æœåŠ¡ï¼Œå°±èƒ½æ›´æ–°ç›‘æ§é…ç½®ã€‚\nï¼ˆä¸€ï¼‰é…ç½®æœåŠ¡æ”¯æ’‘ é€šè¿‡é…ç½®æœåŠ¡æš´éœ²ä¸€ä¸ª HTTP æ¥å£ï¼Œè¿™ä¸ªæ¥å£è¿”å›çš„æ˜¯å½“å‰éœ€è¦ç›‘æ§çš„å¯¹è±¡ä¿¡æ¯ã€‚æ¯”å¦‚ç³»ç»Ÿæ–°å¢äº†ä¸€ä¸ªå¾®æœåŠ¡ï¼Œé…ç½®æœåŠ¡é‡Œçš„ç›‘æ§åˆ—è¡¨å°±ä¼šæ›´æ–°ï¼ŒæŠŠæ–°æœåŠ¡çš„ä¿¡æ¯åŠ ä¸Šã€‚\n job_name: \u0026quot;ä¸»æœºç›‘æ§\u0026quot;\rhttp_sd_configs:\r- url: \u0026quot;http://xxxxxx/xxxxxx\u0026quot;\rrefresh_interval: 5s\rï¼ˆäºŒï¼‰å®šæ—¶æ‹‰å–æ›´æ–° Prometheus ä¼šå®šæ—¶å»è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œæ‹¿åˆ°æœ€æ–°çš„ç›‘æ§å¯¹è±¡åˆ—è¡¨ï¼Œè‡ªåŠ¨æ›´æ–°è‡ªå·±çš„é‡‡é›†é…ç½®ã€‚è¿™æ ·ä¸ç®¡æ˜¯æ–°å¢ã€åˆ é™¤è¿˜æ˜¯ä¿®æ”¹ç›‘æ§å¯¹è±¡ï¼Œéƒ½èƒ½å®æ—¶è·Ÿä¸Šï¼Œä¿è¯ç›‘æ§ä¸è„±èŠ‚ã€‚\nå…­ã€é…ç½®è¯´æ˜ï¼šè®©ç›‘æ§ä½“ç³» â€œç¨³å‡†ç‹ â€ ï¼ˆä¸€ï¼‰Prometheus é…ç½®è¦ç‚¹  é™æ€é…ç½®ï¼šåœ¨ prometheus.yml é‡Œï¼Œç›´æ¥å†™æ­»è¦ç›‘æ§çš„ç›®æ ‡ã€‚æ¯”å¦‚ç›‘æ§ä¸»æœºï¼Œå°±é…ç½® node_exporter çš„åœ°å€ï¼š  scrape_configs:\r- job_name: 'node'\rstatic_configs:\r- targets: ['localhost:9100'] # node_exporteré»˜è®¤ç«¯å£\r åŠ¨æ€å‘ç°é…ç½®ï¼šé€‚åˆç›‘æ§å¯¹è±¡ç»å¸¸å˜åŒ–çš„åœºæ™¯ï¼Œæ¯”å¦‚åŸºäºæ–‡ä»¶ã€DNSã€Consul è¿™äº›æ–¹å¼è‡ªåŠ¨å‘ç°ã€‚ä»¥ Consul ä¸ºä¾‹ï¼š  scrape_configs:\r- job_name: 'consul-services'\rconsul_sd_configs:\r- server: 'localhost:8500'\rservices: [] # å¯æŒ‡å®šæœåŠ¡ï¼Œç©ºåˆ™å‘ç°æ‰€æœ‰\r é‡‡é›†å‘¨æœŸä¸è¶…æ—¶ï¼šè°ƒæ•´ scrape_intervalï¼ˆé‡‡é›†é—´éš” ï¼‰å’Œ scrape_timeoutï¼ˆè¶…æ—¶æ—¶é—´ ï¼‰ï¼Œé€‚é…ä¸åŒç›‘æ§éœ€æ±‚ï¼š  global:\rscrape_interval: 15s # é»˜è®¤15ç§’æ‹‰ä¸€æ¬¡\rscrape_timeout: 10s # æ‹‰å–è¶…æ—¶æ—¶é—´\rï¼ˆäºŒï¼‰Grafana é…ç½®å…³é”®   æ•°æ®æºé…ç½®ï¼šåœ¨ Grafana é‡Œæ·»åŠ  Prometheus æ•°æ®æºï¼Œå¡«å¥½åœ°å€ï¼ˆæ¯”å¦‚ http://prometheus:9090 ï¼‰ï¼Œä¿å­˜æµ‹è¯•ï¼Œç¡®ä¿èƒ½è¿é€šã€‚\n  ä»ªè¡¨ç›˜ï¼ˆDashboardï¼‰é…ç½®ï¼šå¯ä»¥è‡ªå·±åˆ›å»ºï¼Œä¹Ÿèƒ½å¯¼å…¥ç¤¾åŒºæ¨¡æ¿ï¼ˆæ¯”å¦‚ ID ä¸º 8919 çš„ Node Exporter æ¨¡æ¿ ï¼‰ã€‚é…ç½®çš„æ—¶å€™ï¼Œé€‰å¥½æ•°æ®æºï¼Œå†™ PromQL æŸ¥è¯¢è¯­å¥ï¼ˆæ¯”å¦‚ node_cpu_seconds_total{mode=\u0026ldquo;idle\u0026rdquo;} çœ‹ CPU ç©ºé—²æ—¶é—´ ï¼‰ï¼Œè®¾ç½®å›¾è¡¨ç±»å‹ï¼ˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ç­‰ ï¼‰ï¼Œè®©æ•°æ®å¯è§†åŒ–æ›´ç›´è§‚ã€‚\n  ï¼ˆä¸‰ï¼‰Agent ä¸ä¸­é—´ä»¶é…ç½®  Exporter é…ç½®ï¼šä¸åŒçš„ exporter æœ‰ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚æ¯”å¦‚ node_exporter å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è°ƒæ•´é‡‡é›†é¡¹ï¼ˆå¦‚ \u0026ndash;no-collector.diskstats å…³é—­ç£ç›˜ç»Ÿè®¡ ï¼‰ï¼›mysql_exporter éœ€è¦é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œå¡«å¥½ç”¨æˆ·åã€å¯†ç ã€åœ°å€ï¼š  [client]\ruser = prometheus\rpassword = yourpassword\rhost = localhost\rport = 3306\rä¸­é—´ agent é…ç½®ï¼šé’ˆå¯¹ç¬¬ä¸‰æ–¹æœåŠ¡çš„ä¸­é—´ agentï¼Œè¦é…ç½®å¥½è¿æ¥ç›®æ ‡æœåŠ¡çš„å‚æ•°ï¼ˆå¦‚ API å¯†é’¥ã€è®¿é—®åœ°å€ ï¼‰ï¼Œè¿˜æœ‰æ•°æ®è½¬æ¢è§„åˆ™ï¼Œç¡®ä¿é‡‡é›†çš„æ•°æ®ç¬¦åˆ Prometheus æ ¼å¼ã€‚\n","date":"2023-11-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/prometheus-%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB/1_hu7bc2e2363b789d26ffbef1b3568d6ac2_1191273_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/prometheus-%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB/","title":"Prometheus ç›‘æ§ä½“ç³»"},{"content":"åç«¯çš„å®‰å…¨  åœ¨åç«¯çš„åº”ç”¨ç¨‹åºä¸­çš„å®‰å…¨é—®é¢˜éƒ½æ˜¯äº²ä¿¡äº†ç¬¬ä¸‰æ–¹æä¾›çš„æ•°æ®é€ æˆçš„ï¼Œä¾‹å¦‚ï¼šå¯¹äºç”¨æˆ·è¾“å…¥çš„æ•°æ®ã€‚åœ¨å¯¹å…¶è¿›è¡ŒéªŒè¯ä¹‹å‰éƒ½åº”è¯¥è§†ä¸ºä¸å®‰å…¨çš„æ•°æ®ï¼ŒæŠŠä¸å®‰å…¨çš„æ•°æ®ç”¨äºæ•°æ®åº“çš„æŸ¥è¯¢å°±å¯èƒ½ä¼šé€ æˆsqlæ³¨å…¥çš„é—®é¢˜  é¢„é˜²CSRFæ”»å‡» CSRF(è·¨ç«™è¯·æ±‚ä¼ªé€ )ï¼šæ”»å‡»è€…å¯ä»¥ç›—ç”¨ä½ çš„ç™»å½•ä¿¡æ¯ï¼Œä»¥ä½ çš„èº«ä»½æ¨¡æ‹Ÿå‘é€å„ç§è¯·æ±‚ï¼Œæ‰€ä»¥é‡åˆ°CSRFæ”»å‡»æ—¶ï¼Œå°†å¯¹ç»ˆç«¯ç”¨æˆ·æ•°æ®å’Œæ“ä½œæŒ‡ä»¤æ„æˆä¸¥é‡çš„å¨èƒï¼Œå½“å—æ”»å‡»çš„ç»ˆç«¯å…·å¤‡ç®¡ç†è´¦å·æ—¶ï¼ŒCSRFæ”»å‡»éƒ½ä¼šå±åŠæ•´ä¸ªåç«¯çš„åº”ç”¨\nâ€‹\t\r\nCSRFçš„å·¥ä½œåŸç†ï¼š   CSRFæ”»å‡»ä¸»è¦æ˜¯å› ä¸ºwebçš„éšå¼èº«ä»½éªŒè¯æœºåˆ¶ï¼Œwebçš„èº«ä»½éªŒè¯æœºåˆ¶å¯ä»¥ä¿è¯ä¸€ä¸ªè¯·æ±‚æ˜¯æ¥è‡ªæŸä¸€ä¸ªæœåŠ¡å™¨ã€‚ä½†å´æ— æ³•ä¿è¯è¯¥è¯·æ±‚æ˜¯ç”¨æˆ·æ‰¹å‡†å‘é€çš„\n  CSRFçš„æ”»å‡»è¿‡ç¨‹å¯åˆ†ä¸ºï¼š\n ç™»å½•å—ä¿¡ä»»çš„ç½‘ç«™A,å¹¶åœ¨æœ¬åœ°ç”Ÿæˆcookie åœ¨ä¸é€€å‡ºAçš„æƒ…å†µä¸‹ï¼Œè®¿é—®äº†å±é™©çš„ç½‘ç«™B    CSRFçš„é¢„é˜²  å¯ä»¥ä»æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤ä¸ªæ–¹å‘å…¥æ‰‹  æœåŠ¡ç«¯çš„é¢„é˜²ï¼š  æ­£ç¡®çš„ä½¿ç”¨GET,POST,å’ŒCOOKie åœ¨éGETè¯·æ±‚ä¸­å¢åŠ ä¼ªéšæœºæ•° åœ¨éGETæ–¹å¼çš„è¯·æ±‚ä¸­å¢åŠ ä¼ªéšæœºæ•°æœ‰ä¸‰ç§æ–¹å¼ï¼š ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·ç”Ÿæˆå”¯ä¸€çš„cookie tokenï¼Œæ‰€æœ‰çš„è¡¨å•éƒ½åŒ…å«åŒä¸€ä¸ªä¼ªéšæœºæ•° æ¯ä¸€ä¸ªè¯·æ±‚ä½¿ç”¨çš„éªŒè¯ç  åœ¨ä¸åŒè¡¨å•åŒ…å«ä¸€ä¸ªä¸åŒçš„ä¼ªéšæœºæ•°   ç¡®ä¿è¾“å…¥çš„è¿‡æ»¤ï¼šè¿‡æ»¤ç”¨æˆ·æ•°æ®æ˜¯ååç«¯çš„åŸºç¡€ï¼Œå®ƒæ˜¯éªŒè¯æ•°æ®çš„åˆæ³•æ€§çš„è¿‡ç¨‹ï¼š  è¯†åˆ«æ•°æ®ï¼Œå³ç¡®å®šæ•°æ®çš„æ¥æº è¿‡æ»¤æ•°æ®ï¼Œå³ç¡®ä¿éœ€è¦çš„æ•°æ®å…¥åº“ ç¡®å®šæ•°æ®ï¼Œå³ç¡®å®šæ•°æ®çš„å®‰å…¨      é¿å…XSSçš„æ”»å‡» â€‹\txss(è·¨ç«™è„šæœ¬æ”»å‡»)ï¼šæ˜¯ä¸€ç§å¸¸è§çš„webå®‰å…¨æ¼æ´ï¼Œå®ƒå…è®¸æ”»å‡»è€…å°†æ¶æ„ä»£ç æ¤å…¥åˆ°æä¾›ç»™å…¶ä»–ç”¨æˆ·ä½¿ç”¨çš„é¡µé¢ä¸­ï¼Œä¸åŒäºå¤§å¤šæ•°æ”»å‡»ä¸€èˆ¬åªæ¶‰åŠæ”»å‡»è€…å’Œå—å®³è€…ï¼Œxssæ¶‰åŠåˆ°ä¸‰æ–¹ï¼Œå³æ”»å‡»è€…ï¼Œå®¢æˆ·ç«¯å’Œåç«¯æœåŠ¡å™¨ï¼Œxssæ”»å‡»ç›®æ ‡ä¸ºç›—å–å­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„cookieæˆ–è€…å…¶ä»–ç½‘ç«™ç”¨æˆ·è¯†åˆ«å®¢æˆ·ç«¯èº«ä»½çš„æ•æ„Ÿä¿¡æ¯ï¼Œä¸€æ—¦è·å–åˆ°åˆæ³•çš„ç”¨æˆ·ä¿¡æ¯åï¼Œæ”»å‡»è€…ç”šè‡³å¯ä»¥å‡å†’åˆæ³•äºç½‘ç«™è¿›è¡Œäº¤äº’\nxss åˆ†ç±»   å­˜å‚¨å‹xss:ä¸»è¦æ˜¯å‡ºç°è®©ç”¨æˆ·è¾“å…¥æ•°æ®ï¼Œåº”ç”¨ç¨‹åºä»æ•°æ®åº“æŸ¥æ•°æ®ï¼Œåœ¨é¡µé¢ä¸­æ˜¾ç¤ºï¼Œæ”»å‡»è€…åœ¨ç›¸å…³é¡µé¢ä¸­è¾“å…¥æ¶æ„çš„è„šæœ¬æ•°æ®åï¼Œç”¨æˆ·æµè§ˆæ—¶ï¼Œå°±å¯èƒ½ä¼šå—åˆ°æ”»å‡»\n\r\n  åå°„æ€§xss:ä¸»è¦åšæ³•æ˜¯å°†è„šæœ¬ä»£ç åŠ å…¥urlåœ°å€çš„è¯·æ±‚å‚æ•°ä¸­ï¼Œè¯·æ±‚å‚æ•°è¿›å…¥ç¨‹åºååœ¨é¡µé¢ç›´æ¥è¾“å‡ºï¼Œç”¨æˆ·ç‚¹å‡»ç±»ä¼¼é“¾æ¥å¯èƒ½ä¼šå—åˆ°æ”»å‡»\n\r\n  xssåŸç†  åç«¯åº”ç”¨åœ¨æœªå¯¹ç”¨æˆ·æäº¤è¯·æ±‚çš„æ•°æ®åšå……åˆ†çš„æ£€æŸ¥è¿‡æ»¤ï¼Œå…è®¸ç”¨æˆ·åœ¨æäº¤æ•°æ®ä¸­å‚å…¥htmlä»£ç ï¼Œå¹¶å°†æœªç»è¿‡è½¬ä¹‰çš„æ¶æ„çš„ä»£ç è¾“å‡ºåˆ°ç¬¬ä¸‰æ–¹çš„åº”ç”¨çš„æµè§ˆå™¨è§£é‡Šæ‰§è¡Œï¼Œæ˜¯å¯¼è‡´xssæ¼æ´çš„ä¸»è¦äº§ç”ŸåŸå›   é¢„é˜²xss  åšå†³ä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„ä»»ä½•è¾“å…¥å¹¶è¿‡æ»¤è¾“å…¥ä¸­çš„æ‰€æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œç›®å‰æœ‰ä¸¤ç§æ–¹æ³•ï¼š  è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ ä½¿ç”¨httpå¤´æŒ‡å®šç±»å‹    é¿å…sqlæ³¨å…¥  sqlæ³¨å…¥æ˜¯åç«¯å¼€å‘ä¸­æœ€å¸¸è§çš„ä¸€ç§å®‰å…¨æ¼æ´ï¼Œå¯ä»¥ä½¿ç”¨å®ƒè·å–æ•°æ®åº“ä¸­çš„è·å–æ•æ„Ÿçš„ä¿¡æ¯ï¼Œæˆ–è€…åˆ©ç”¨æ•°æ®åº“çš„çƒ­ç‰¹æ€§æ‰§è¡Œæ·»åŠ ç”¨æˆ·ï¼Œå¯¼å‡ºæ–‡ä»¶ç­‰ä¸€ç³»åˆ—æ¶æ„ï¼Œæ“ä½œç”šè‡³å¯èƒ½è·å–æ•°æ®åº“æˆ–è€…ç³»ç»Ÿçš„ç”¨æˆ·çš„æœ€é«˜æƒé™ é€ æˆsqlæ³¨å…¥çš„åŸå› æ˜¯å› ä¸ºç¨‹åºæ²¡æœ‰æœ‰æ•ˆçš„è¿‡æ»¤ï¼Œç”¨æˆ·è¾“å…¥æ—¶æ”»å‡»è€…æˆåŠŸå‘æœåŠ¡å™¨æäº¤æ¶æ„ä»£ç çš„sqlæŸ¥è¯¢ä»£ç ï¼Œç¨‹åºåœ¨æ¥æ”¶åˆ°é”™è¯¯åçš„å°†æ”»å‡»è€…çš„è¾“å…¥ä½œä¸ºæŸ¥è¯¢è¯­å¥çš„ä¸€éƒ¨åˆ†ï¼Œå¯¼è‡´åŸå§‹æŸ¥è¯¢é€»è¾‘è¢«è¿«æ”¹å˜ã€‚é¢å¤–æ‰§è¡Œä¾›æ”»å‡»è€…ç²¾å¿ƒæ„é€ çš„æ¶æ„ä»£ç  sqlæŸ¥è¯¢æ˜¯å¯ä»¥è¢«ä¿®æ”¹ï¼ŒsqlæŸ¥è¯¢æ˜¯å¯ä»¥ç»•å¼€è®¿é—®çš„æ§åˆ¶ï¼Œä»è€Œç»•è¿‡èº«ä»½éªŒè¯å’Œæƒé™æ£€æŸ¥ï¼Œæœ‰å¯èƒ½sqlæŸ¥è¯¢å»ä¸è¿è¡Œä¸»æœºç³»ç»Ÿçº§åˆ«çš„å‘½ä»¤  é¢„é˜²sql  ä¸¥æ ¼é™åˆ¶åç«¯åº”ç”¨çš„æ•°æ®åº“çš„æƒé™ï¼Œç»™ç”¨æˆ·æä¾›æ»¡è¶³åŠŸèƒ½å³å¯ æ£€æŸ¥è¾“å…¥çš„æ•°æ®æ˜¯å¦å…·æœ‰æ‰€æœ‰çš„æœŸæœ›æ ¼å¼ã€‚ä¸¥æ ¼æ§åˆ¶å˜é‡ç±»å‹ å¯¹æ•°æ®åº“çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼Œæˆ–è€…ç¼–ç è½¬æ¢ æ‰€æœ‰çš„æŸ¥è¯¢è¯­å¥ï¼Œå»ºè®®ä½¿ç”¨æ•°æ®åº“æä¾›å“¦é‚£ä¸ªçš„å‚æ•°åŒ–çš„æ¥å£ã€‚è€Œä¸æ˜¯å°†è¾“å…¥çš„å˜é‡åµŒå…¥åˆ°sqlè¯­å¥ä¸­ï¼Œå³ä¸è¦æ‹¼æ¥sqlè¯­å¥ åœ¨åº”ç”¨å‘å¸ƒå‰ï¼Œå»ºè®®ä½¿ç”¨ä¸“ä¸šçš„sqlæ³¨å…¥æ£€æŸ¥å·¥å…·è¿›è¡Œæ£€æµ‹ä»¥åŠæ—¶ä¿®è¡¥å¹¶å‘ç°sqlæ³¨å…¥çš„æ¼æ´ é¿å…å‰ç«¯æ‰“å°sqlé”™è¯¯ï¼Œæ¯”å¦‚ç±»å‹é”™è¯¯ï¼Œå­æ®µä¸åŒ¹é…ç­‰æš´éœ²sqlè¯­å¥  å­˜å‚¨å¯†ç   æ™®é€šæ–¹æ¡ˆï¼šå¸¸ç”¨çš„å¯†ç å­˜å‚¨æ–¹æ¡ˆæ˜¯å°†æ˜æ–‡å¯†ç åšå•å‘çš„å“ˆå¸Œåå­˜é”™ï¼Œå•å‘å“ˆå¸Œç®—æ³•æœ‰ä¸€ç‰¹å¾ï¼šæ— æ³•é€šè¿‡å“ˆå¸Œåçš„æ‘˜è¦æ¢å¤å‡ºåŸå§‹æ•°æ®ï¼Œå¸¸ç”¨çš„é¢å•å‘å“ˆå¸Œç®—æ³•åŒ…æ‹¬ï¼šSHA-256,SHA-1  å•å‘å“ˆå¸Œçš„ä¸¤å¤§ç‰¹æ€§ï¼š  åŒä¸€å¯†ç è¿›è¡Œå“ˆå¸Œåï¼Œå¾—åˆ°çš„å”¯ä¸€ç¡®å®šçš„æ‘˜è¦ è®¡ç®—é€Ÿåº¦å¿«   ç»“åˆå•å‘å“ˆå¸Œçš„ä¸¤å¤§ç‰¹æ€§ï¼šæ”»å‡»è€…å¯ä»¥å°†æ‰€æœ‰çš„å¯†ç å¸¸è§çš„ç»„åˆè¿›è¡Œå•å‘å“ˆå¸Œï¼Œå¾—åˆ°ä¸€ä¸ªæ‘˜è¦ç»„åˆ(rainbow table), ç„¶åäºæ•°æ®åº“ä¸­çš„è¿›è¡Œå¯¹æ¯”å³å¯å¾—åˆ°å¯†ç    è¿›é˜¶æ–¹æ¡ˆï¼šå…ˆå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç è¿›è¡Œå•å‘å“ˆå¸ŒåŠ å¯†ï¼Œåœ¨å°†è·å–çš„æ‘˜è¦çš„å‰ååŠ ä¸Šåªæœ‰ç®¡ç†å‘˜çŸ¥é“çš„éšæœºæ•°ï¼Œåœ¨è¿›è¡Œå•å‘å“ˆå¸Œ ä¸“å®¶æ–¹æ¡ˆï¼šæ•…æ„å¢åŠ å¯†ç è®¡ç®—æ‰€æ¶ˆè€—çš„èµ„æºå’Œæ—¶é—´ï¼Œä½¿å¾—ä»»ä½•äººéƒ½ä¸å¯èƒ½è·å–åˆ°ç›¸åŒçš„èµ„æºï¼Œå»ºç«‹æ‰€éœ€è¦çš„(rainbow table)  ","date":"2023-01-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E5%90%8E%E7%AB%AF%E7%9A%84%E5%AE%89%E5%85%A8%E5%92%8C%E5%8A%A0%E5%AF%86/1_hu87659f1a5244bdf4eaa7c124361acc46_915216_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E5%90%8E%E7%AB%AF%E7%9A%84%E5%AE%89%E5%85%A8%E5%92%8C%E5%8A%A0%E5%AF%86/","title":"åç«¯çš„å®‰å…¨å’ŒåŠ å¯†"},{"content":"ç´¢å¼•æœºåˆ¶  ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç´¢å¼•æœºåˆ¶æ˜¯æœ‰å­˜å‚¨å¼•æ“å®ç°ï¼Œåˆ›å»ºç´¢å¼•ä¼šåŸºäºåŸæœ‰è¡¨çš„æ•°æ®ï¼Œä»æ–°åœ¨ç£ç›˜ä¸Šåˆ›å»ºæ–°çš„æœ¬åœ°ç´¢å¼•æ–‡ä»¶ mysqlç´¢å¼•æœºåˆ¶çš„ä¼˜åŠ¿ï¼š  æé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼Œæ•°é‡è¶Šå¤§ï¼Œæ•ˆæœè¶Šæ˜æ˜¾ å»ºç«‹å”¯ä¸€çš„ç´¢å¼•ï¼Œå¯ç¡®ä¿æ•°æ®è¡¨ä¸­çš„æ•°æ®å”¯ä¸€æ€§ï¼Œæ— éœ€é¢å¤–çš„åˆ›å»ºå”¯ä¸€çš„çº¦æŸ åœ¨ä½¿ç”¨åˆ†ç»„ä¸æ’åºæ—¶ï¼Œå¯æ˜¾è‘—å‡å°‘æŸ¥è¯¢çš„åˆ†ç»„å’Œæ’åºçš„æ—¶é—´ åœ¨å¤šè¡¨æŸ¥è¯¢æ—¶ï¼ŒåŸºäºä¸»å¤–é”®å­—æ®µå»ºç«‹ç´¢å¼•ï¼Œå¯å¸¦æ¥ååˆ†æ˜æ˜¾çš„æ€§èƒ½çš„æå‡ ç´¢å¼•é»˜è®¤æ˜¯B+æ ‘æœ‰åºæœºæ„ï¼Œæ•ˆç‡ä¼šæ˜æ˜¾æé«˜ å°±æ•´ä¸ªæ•°æ®åº“è€Œè¨€ï¼Œå‡å°‘sqlæ‰§è¡Œæ—¶é—´ï¼Œå¯æé«˜æ•°æ®åº“æ•´ä½“çš„ååé‡   mysqlç´¢å¼•æœºåˆ¶çš„å¼Šç«¯ï¼š  å»ºç«‹ç´¢å¼•ä¼šç”Ÿæˆæœ¬åœ°ç£ç›˜æ–‡ä»¶ï¼Œéœ€è¦é¢å¤–çš„ç©ºé—´å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œç£ç›˜å ç”¨ç‡ä¼šå˜é«˜ å†™å…¥æ•°æ®æ—¶ï¼Œéœ€è¦é¢å¤–çš„ç»´æŠ¤ç´¢å¼•ç»“æ„ï¼Œåœ¨å¢åˆ ä¿®æ”¹æ•°æ®æ—¶ï¼Œéƒ½éœ€è¦é¢å¤–çš„æ“ä½œç´¢å¼• å†™å…¥æ•°æ®æ—¶ï¼Œç»´æŠ¤ç´¢å¼•éœ€è¦é¢å¤–çš„æ—¶é—´å¼€é”€ï¼Œæ‰§è¡Œsqlæ—¶æ•ˆç‡ä¼šé™ä½ï¼Œæ€§èƒ½ä¼šä¸‹é™   ä¸»é”®ç´¢å¼•å­˜åœ¨çš„é™·é˜±  ä¸»é”®ä¸€èˆ¬ä¼šä½¿ç”¨è‡ªå¢çš„id,å¯ç¡®ä¿ä¸»é”®ä¸é‡å¤ä»¥åŠä¸»é”®çš„å”¯ä¸€æ€§ï¼Œä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œä½¿ç”¨ b+æ ‘çš„ç´¢å¼•çš„å­˜å‚¨ç»“æ„ä¸»é”®ç´¢å¼•æ˜¯æœ‰åºçš„ï¼Œè‹¥ä¸»é”®é‡‡ç”¨çš„æ˜¯æ— åºæ—¶ï¼Œåœ¨æ’å…¥æ•°æ®å¯èƒ½ä¼šå¯¼è‡´ç´¢å¼•ç»“æ„çš„è°ƒæ•´ å› æ­¤ï¼Œä¸»é”®ç´¢å¼•æœ€å¥½é€‰ç”¨é¡ºåºçš„å€¼ï¼Œè€Œééšæœºå€¼   è”åˆç´¢å¼•å­˜åœ¨çš„çŸ›ç›¾  åœ¨è”åˆæŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢æ¡ä»¶å¿…é¡»åŒ…å«ç´¢å¼•çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œåœ¨å»ºç«‹è”åˆç´¢å¼•æ—¶ï¼Œè¦ç¡®ä¿å»ºç«‹é™¤çš„æ¥è”åˆç´¢å¼•å‘½ä¸­é«˜ï¼Œå³å¿…é¡»åŒ…å« ç¬¬ä¸€ä¸ªå­—æ®µ   å‰ç¼€ç´¢å¼•: å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå­—æ®µçš„å‰Nä¸ªå­—ç¬¦åˆ›å»ºç´¢å¼•ï¼Œå¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œä½†ä¸èƒ½ä½¿ç”¨åˆ†ç»„ï¼Œæ’åºå·¥ä½œï¼Œæ— æ³•å®Œæˆè¦†ç›–æ‰«æç­‰å·¥ä½œ å…¨æ–‡ç´¢å¼•å­˜åœ¨çš„ç¡¬ä¼¤  å…¨æ–‡ç´¢å¼•æ˜¯åŸºäºåˆ†ç»„å®ç°ï¼Œåˆ†è¯ä¹Ÿä¼šè¢«å­˜å‚¨ï¼Œä¼šé€ æˆé¢å¤–çš„æ–‡ä»¶ï¼Œè¿˜å­˜åœ¨åœ¨æ›´æ–°æ•°æ®ä¹‹åï¼Œç´¢å¼•çš„å­˜å‚¨ä¸æ›´æ–°çš„é—®é¢˜   å”¯ä¸€ç´¢å¼•å­˜åœ¨çš„å¿«æ…¢çš„é—®é¢˜  å”¯ä¸€ç´¢å¼•æŸ¥è¯¢æ•°æ®æ¯”æ™®é€šç´¢å¼•æ•ˆç‡é«˜ï¼Œå› ä¸ºæ™®é€šç´¢å¼•ä¼šæŸ¥è¯¢æ•´ä¸ªç´¢å¼•æ•°ï¼Œå”¯ä¸€ç´¢å¼•ä¼šå¼•èµ·ç«‹é©¬åœæ­¢æ£€ç´¢ï¼Œä½†æ’å…¥æ•°æ®åˆ™ç›¸å   ç´¢å¼•æœºåˆ¶ä¸­ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯  æŸ¥è¯¢è¯­å¥ä¸­å¸¦æœ‰orä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ æ¨¡ç³ŠæŸ¥è¯¢è¯­å¥ä¸­likeä»¥%å¼€å¤´å¯¼è‡´ç´¢å¼•å¤±æ•ˆ å­—ç¬¦ç±»å‹æŸ¥è¯¢æ—¶ä¸å¸¦å¼•å·å¯¼è‡´ç´¢å¼•å¤±æ•ˆ ç´¢å¼•å­—æ®µå‚ä¸è®¡ç®—å¯¼è‡´ç´¢å¼•å¤±æ•ˆ å­—æ®µè¢«ç”¨äºå‡½æ•°è®¡ç®—å¯¼è‡´ç´¢å¼•å¤±æ•ˆ è¿èƒŒæœ€å·¦å‰ç¼€åŸåˆ™å¯¼è‡´ç´¢å¼•å¤±æ•ˆ ä¸åŒå­—æ®µå€¼å¯¹æ¯”å¯¼è‡´ç´¢å¼•æ˜¯å¤±æ•ˆ åå‘èŒƒå›´æ“ä½œå¯¼è‡´ç´¢å¼•å¤±æ•ˆ    MVCCæœºåˆ¶  mvccæœºåˆ¶ï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŠ€æœ¯ï¼Œä¸»è¦æé«˜æ•°æ®å¹¶å‘æ€§èƒ½è€Œè®¾è®¡ï¼Œé‡‡ç”¨æ›´å¥½çš„æ–¹å¼å¤„ç†äº† è¯»å†™å¹¶å‘å†²çªçš„é—®é¢˜ï¼Œåœ¨æœ‰è¯»å†™æ“ä½œæ—¶ï¼Œä¹Ÿä¸åŠ é”ï¼Œç¡®ä¿è¯»æ“ä½œçš„éé˜»å¡çš„  mvccå®ç°åŸç†  mvcc æ˜¯é€šè¿‡éšè—å­—æ®µã€undo-logã€readViewä¸‰ä¸ªå®ç°  éšè—å­—æ®µï¼šä½¿ç”¨innodbå¼•æ“å»ºç«‹ä¸€å¼ è¡¨åï¼Œæ•°æ®åº“é™¤äº†æ„å»ºæ˜¾ç¤ºå­—æ®µå¤–ï¼Œé€šå¸¸è¿˜ä¼šæ„å»ºéšè—å­—æ®µä¸»è¦åŒ…æ‹¬ï¼š  DB_ROW_ID: éšè—ä¸»é”®ï¼Œå½“mysqlæœªå®šä¹‰ä¸»é”®æ—¶ï¼Œä¼šä½¿ç”¨ROW_IDæ¥ä½œä¸ºèšç°‡ç´¢å¼•åˆ— DB_Deleted_Bitï¼šåˆ é™¤æ ‡è¯†ï¼Œå½“æ‰§è¡Œdeleteè¯­å¥æ—¶ï¼Œä¼šå°†è¿™ä¸ªæ ‡è¯†deleted_Bitè®¾ç½®ä¸ºï¼štrue/1,è‹¥åç»­äº‹åŠ¡å›æ»šæ—¶ï¼Œä¼š å°†deleted_Bitè®¾ç½®ä¸ºfalse/0,è¿™æ ·å°±èƒ½é¿å…æ ‘ç»“æ„çš„è°ƒæ•´ï¼ŒåŒæ—¶ä¹Ÿä¼šä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è‡ªåŠ¨æ¸…ç†deleted_Bitä¸ºtrue/1çš„è¡Œæ•°æ® DB_TRX_IDï¼šæœ€è¿‘äº‹åŠ¡ID,æ¯åˆ›å»ºäº‹åŠ¡ï¼Œéƒ½ä¼šåˆ†é…ä¸€ä¸ªäº‹åŠ¡ID,éµå¾ªé¡ºåºé€’å¢çš„ç‰¹æ€§ï¼Œä½†åˆ é™¤çš„IDä¸ºï¼š0 DB_ROLL_PTRï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘undo-logæ—¥å¿—ä¸­æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼Œé€šè¿‡æ­¤æ¥æ‰¾åˆ°æ”¹åŠ¨å‰çš„æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼Œ mvccå°±æ˜¯åˆ©ç”¨è¿™ä¸€ç‚¹å®ç°è¡Œæ•°æ®çš„å¤šç‰ˆæœ¬   undo-log: å­˜å‚¨ä¸ä»…ä»…ä¸€æ¡æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼Œè€Œæ˜¯å­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬é“¾ \r readView: å¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶ï¼Œæ ¹æ®æŸ¥è¯¢æ—¶æœºæ¥é€‰æ‹©ä¸€ä¸ªå½“å‰äº‹åŠ¡å¯è§çš„æ—§ç‰ˆæœ¬æ•°æ®ï¼Œ é€šå¸¸ä¸€ä¸ªäº‹åŠ¡ä¸ä¸€ä¸ªreadViewå±äºä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œä¸€èˆ¬åŒ…æ‹¬å››ä¸ªæ ¸å¿ƒå†…å®¹ï¼š  creator_trx_id: ä»£è¡¨åˆ›å»ºå½“å‰è¿™ä¸ªreadViewçš„äº‹åŠ¡ID trx_id: ä»£è¡¨åœ¨ç”Ÿæˆå½“å‰äº‹åŠ¡readViewæ—¶ï¼Œç³»ç»Ÿå†…æ´»åŠ¨çš„äº‹åŠ¡idåˆ—è¡¨ up_limit_id: æ´»è·ƒçš„äº‹åŠ¡ä¸­æœ€å°çš„ID low_limit_id: ç”Ÿæˆå½“å‰readViewæ—¶ï¼Œç³»ç»Ÿç»™ä¸€ä¸ªäº‹åŠ¡åˆ†é…çš„ID \r     å®ç°åŸç†å’Œè¿‡ç¨‹  å½“ä¸€ä¸ªäº‹åŠ¡å°è¯•æ”¹åŠ¨æŸä¸€æ¡æ•°æ®æ—¶ï¼Œä¼šå°†åŸæœ¬è¡¨ä¸­çš„æ•°æ®æ”¾å…¥undo_logæ—¥å¿—ä¸­ å½“ä¸€ä¸ªäº‹åŠ¡å°è¯•æŸ¥è¯¢æŸä¸€æ¡æ•°æ®æ—¶ï¼Œmvccä¼šç”Ÿæˆä¸€ä¸ªreadViewå¿«ç…§ å…·ä½“å®ç°è¿‡ç¨‹ï¼š  å½“äº‹åŠ¡ä¸­å‡ºç°selectè¯­å¥æ—¶ï¼Œä¼šæ ¹æ®å½“å‰è¿è¡Œæƒ…å†µç”Ÿæˆä¸€ä¸ªreadView åˆ¤æ–­è¡Œæ•°æ®ä¸­çš„éšè—åˆ—tex_idæœ€è¿‘äº‹åŠ¡idä¸readViewä¸­çš„å½“å‰readViewçš„IDæ˜¯å¦ä¸€è‡´  è‹¥ç›¸åŒï¼šè¯»å–æœ€æ–°ç‰ˆæœ¬çš„æ•°æ® è‹¥ä¸ç›¸åŒï¼šä»£è¡¨ç›®å‰è¦æŸ¥è¯¢çš„æ•°æ®æ˜¯è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¿‡ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œ   åˆ¤æ–­æœ€è¿‘äº‹åŠ¡idæ˜¯å¦å°äºreadViewä¸­çš„æœ€æ´»è·ƒçš„Id  å°äºï¼š ä»£è¡¨æ”¹åŠ¨çš„æ•°æ®çš„äº‹åŠ¡åœ¨åˆ›å»ºå¿«ç…§å‰å°±ç»“æŸäº†ï¼Œå¯è¯»å–æœ€æ–°æ•°æ® ä¸å°äºï¼šè¡¨ç¤ºæ”¹åŠ¨çš„è¡Œæ•°æ®çš„äº‹åŠ¡è¿˜åœ¨æ‰§è¡Œï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œ   åˆ¤æ–­æœ€è¿‘äº‹åŠ¡idæ˜¯å¦å°äºäº‹åŠ¡readViewä¸­çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡id  å¤§äºç­‰äºï¼š ä»£è¡¨æ”¹åŠ¨çš„è¡Œæ•°æ®çš„äº‹åŠ¡æ˜¯ç”Ÿæˆå¿«ç…§ä¹‹ååœ¨å¼€å¯çš„ï¼Œä¸èƒ½è®¿é—®æœ€æ–°æ•°æ® å°äºï¼šä»£è¡¨æ”¹åŠ¨çš„è¡Œæ•°æ®çš„äº‹åŠ¡idåœ¨æœ€å°æ´»è·ƒIDå’Œä¸‹ä¸€ä¸ªäº‹åŠ¡çš„IDä¹‹é—´ï¼Œéœ€è¦è¿›ä¸€æ­¥çš„åˆ¤æ–­   åˆ¤æ–­å½“å‰å¿«ç…§idæ˜¯å¦åœ¨ç³»ç»Ÿæ´»è·ƒçš„äº‹åŠ¡idåˆ—è¡¨ä¸­  æ˜¯ï¼šè¡¨ç¤ºæ”¹åŠ¨çš„è¡Œæ•°æ®çš„äº‹åŠ¡ä¾æ—§åœ¨æ‰§è¡Œï¼Œä¸èƒ½è®¿é—®æ–°æ•°æ® ä¸æ˜¯ï¼šè¡¨ç¤ºæ”¹åŠ¨è¡Œæ•°æ®çš„äº‹åŠ¡å·²ç»ç»“æŸï¼Œå¯ä»¥è®¿é—®æœ€å°æ•°æ®     è‹¥ä¸èƒ½è®¿é—®æœ€æ–°ç‰ˆæœ¬æ•°æ®æ—¶ï¼Œåˆ™ä¼šè®¿é—®undo-logè·å–æ—§ç‰ˆæœ¬ä¸­çš„æœ€æ–°æ•°æ® è‹¥å­˜åœ¨ç‰ˆæœ¬é“¾ï¼Œé€šè¿‡roll_ptr(å›æ»šæŒ‡é’ˆ)æ‰¾åˆ°ç‰ˆæœ¬é“¾çš„è¡¨å¤´ï¼Œç„¶åéå†é“¾è¡¨ï¼Œé€šè¿‡å°±ç‰ˆæœ¬æ•°æ®ï¼Œå…¶éšè—åˆ—æœ€è¿‘äº‹åŠ¡id ä¸èƒ½åœ¨å¿«ç…§ç³»ç»Ÿå†…æ´»åŠ¨äº‹åŠ¡çš„idä¸­çš„æ¡ä»¶è¿”å›å°±ç‰ˆæœ¬çš„æ•°æ® \r     MVCCåœ¨äº‹åŠ¡éš”ç¦»ä¸­æœºåˆ¶ä¸­çš„ä½œç”¨  åœ¨äº‹åŠ¡éš”ç¦»ä¸­åªæœ‰RC(è¯»å·²æäº¤)å’ŒRR(å¯é‡å¤è¯»)ä¸¤ä¸ªçº§åˆ«ä¸­æœ‰è¿ç”¨MVCCæœºåˆ¶  åœ¨RCçº§åˆ«ä¸‹ï¼ŒMVCCæœºåˆ¶æ˜¯åœ¨æ¯æ¬¡select(æŸ¥è¯¢è¯­å¥)æ‰§è¡Œå‰ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæœ€æ–°çš„readView, è§£å†³äº†æ•°æ®åº“ä¸­çš„è„è¯»çš„é—®é¢˜ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸å¯é‡å¤è¯»çš„é—®é¢˜ åœ¨RRçº§åˆ«ä¸‹ï¼ŒMVCCæœºåˆ¶æ˜¯ä¸€ä¸ªäº‹åŠ¡åªä¼šåœ¨é¦–æ¬¡æ‰§è¡Œselect(æŸ¥è¯¢è¯­å¥)ä¹‹å‰ï¼Œæ‰ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„readView, åç»­æ‰€æœ‰æŸ¥è¯¢æ“ä½œéƒ½ä¼šåŸºäºç€ReadViewè¿›è¡Œåˆ¤æ–­ï¼Œè§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜      ","date":"2022-10-10T22:00:38+08:00","image":"https://zcj-git520.github.io/p/mysql%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6%E4%B8%8Emvcc%E6%9C%BA%E5%88%B6/3_hu64a5aef98438ba0332762595f5f39464_60269_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/mysql%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6%E4%B8%8Emvcc%E6%9C%BA%E5%88%B6/","title":"mysqlä¹‹æ•°æ®åº“ç´¢å¼•æœºåˆ¶ä¸MVCCæœºåˆ¶"},{"content":"äº‹åŠ¡çš„ACIDåŸåˆ™  äº‹åŠ¡ä¸€èˆ¬è¦æ»¡è¶³ACIDåŸåˆ™ï¼š  A(atomicity): åŸå­æ€§ C(consistency): ä¸€è‡´æ€§ I(isolation): ç‹¬ç«‹æ€§/éš”ç¦»æ€§ D(Durability): æŒä¹…æ€§   åŸå­æ€§ï¼šæŒ‡ä¸€ä¸ªäº‹åŠ¡ç»„æˆçš„ä¸€ç»„sqlè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ ä¸€è‡´æ€§ï¼šä¸ç®¡äº‹åŠ¡å‘ç”Ÿå‰åï¼ŒåŸæœ¬çš„æ•°æ®å˜åŒ–éƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åº“ä¸­çš„æ•°æ®åªå…è®¸ä»ä¸€ä¸ªä¸€è‡´æ€§ çŠ¶æ€å˜åŒ–ä¸ºå¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ï¼Œå³ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆä¸€èµ·æ”¹å˜æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œè¦ä¹ˆéƒ½ä¸å˜ï¼Œå¯¹äºå…¶ä»–äº‹åŠ¡è€Œè¨€ï¼Œæ•°æ® å˜åŒ–æ˜¯ä¸€è‡´çš„ ç‹¬ç«‹æ€§/éš”ç¦»æ€§: å¤šä¸ªäº‹åŠ¡ä¹‹é—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ä¸å½±å“ï¼Œæ˜¯åŸºäºé”çš„æœºåˆ¶å’Œmvccæœºåˆ¶å®ç°çš„ æŒä¹…æ€§ï¼šæŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå®ƒä¼šä¿æŒæ°¸ä¹…æ€§ï¼Œå³æ‰€æœ‰æ›´æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®éƒ½ä¼šè¢«å†™å…¥ç£ç›˜åšæŒä¹…åŒ–å¤„ç† ç›¸å…³å‘½ä»¤ï¼š  å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼šstart transaction| begin | begin work å›æ»šäº‹åŠ¡ï¼šrollback æäº¤äº‹åŠ¡ï¼šcommit å…³é—­æˆ–å¼€å¯è‡ªåŠ¨æäº¤: SET autocommit = 0|1|ON|OFF   äº‹åŠ¡å›æ»šç‚¹ï¼šå½“åç»­æ“ä½œå¤±è´¥æ—¶ï¼Œå°±ä¼šå›æ»šåˆ°è¯¥ä½ç½®ï¼ˆå½“å‰æˆåŠŸçš„ä½ç½®ï¼‰  ç›¸å…³å‘½ä»¤ï¼š  æ·»åŠ äº‹åŠ¡å›æ»šç‚¹: savepoint point_name å›æ»šåˆ°æŒ‡å®šçš„å›æ»šç‚¹ï¼šrollback point_name      mysqläº‹åŠ¡éš”ç¦»æœºåˆ¶  äº‹åŠ¡éš”ç¦»æœºåˆ¶å¯åˆ†ä¸ºå››ä¸ªçº§åˆ«ï¼š  RU(read uncommitted): è¯»æœªæäº¤ RC(read committed): è¯»å·²æäº¤ RR(repeatable read): å¯é‡å¤è¯» serializable: åºåˆ—åŒ–/ä¸²è¡ŒåŒ–   é»˜è®¤éš”ç¦»çº§åˆ«ä¸ºï¼šå¯é‡å¤è¯» -è„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»ã€è„å†™é—®é¢˜  è„è¯»ï¼šè„è¯»æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å…¶ä»–äº‹åŠ¡è¿˜æ²¡æäº¤çš„æ•°æ®ï¼Œå³å½“å‰äº‹åŠ¡è¯»åˆ°çš„æ•°æ®æ˜¯å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ® å¹»è¯»ï¼šæŒ‡åŒä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢è¿”å›çš„ç»“æœé›†ä¸ä¸€æ ·ã€‚æ¯”å¦‚åŒä¸€ä¸ªäº‹åŠ¡Aï¼Œåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢è¡¨çš„æ•°æ®è¡Œæ•°æ—¶ï¼Œå‘ç°è¡¨ä¸­æœ‰næ¡è¡Œè®°å½•ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡ä»¥åŒç­‰æ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œå´å‘ç°æœ‰n+1æ¡è®°å½•ï¼Œè¿™å°±å¥½åƒäº§ç”Ÿäº†å¹»è§‰ ä¸å¯é‡å¤è¯»: æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¤šæ¬¡è¯»å–åŒä¸€ä¸ªæ•°æ®ï¼Œå…ˆåè¯»å–æ•°æ®ä¸ä¸€è‡´ è„å†™ï¼šæŒ‡åŒä¸€ä¸ªäº‹åŠ¡åŒæ—¶æ“ä½œåŒä¸€æ¡æ•°æ®   äº‹åŠ¡éš”ç¦»æœºåˆ¶å®ç°  è¯»æœªæäº¤  å¤„äºè¯¥çº§åˆ«çš„æ•°æ®åº“ï¼Œè„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»éƒ½å¯èƒ½å‘ç”Ÿ å®ç°æœºåˆ¶ï¼šè¯¥çº§åˆ«æ˜¯åŸºäºå†™äº’æ–¥é”å®ç°çš„ï¼Œè¿™ä¸ªçº§åˆ«åœ¨å†™æ•°æ®æ—¶ï¼Œé‡‡ç”¨äº†äº’æ–¥é”ï¼Œè§£å†³è„å†™çš„é—®é¢˜ ä½†æ˜¯è¯»æ“ä½œä¸æ˜¯äº’æ–¥çš„ï¼Œå¯¼è‡´å…¶ä»–äº‹åŠ¡å¯ä»¥è¯»åˆ°è¯¥äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œä»è€Œå¯¼è‡´äº†è„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»çš„å‘ç”Ÿ   è¯»å·²æäº¤  å¤„äºè¯¥çº§åˆ«çš„æ•°æ®åº“ï¼Œè§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä¸å¯é‡å¤çš„å’Œå¹»è¯»çš„é—®é¢˜åŒæ ·å­˜åœ¨ å®ç°æœºåˆ¶ï¼šè¯¥çº§åˆ«åœ¨åŸºäºå†™äº’æ–¥é”çš„åŸºç¡€ä¸Šï¼Œæ‰é‡‡ç”¨äº†mvccå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶å³ä½¿è¿›è¡Œè¯»æ“ä½œå¤„ç†ï¼Œ å³mvccç‰ˆæœ¬æ§åˆ¶ä¸ä¼šè®©å¦ä¸€ä¸ªäº‹åŠ¡è¯»å–å¦ä¸€ä¸ªæ­£åœ¨ä¿®æ”¹ï¼ˆæœªæäº¤ï¼‰çš„æ•°æ®ï¼Œè€Œæ˜¯è¿”å›ä¿®æ”¹ä¹‹é—´çš„æ•°æ®ï¼ˆè€ç‰ˆæœ¬çš„æ•°æ®ï¼‰ å³æ²¡æœ‰è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œmvccç‰ˆæœ¬æœºåˆ¶ä¼šæ ¹æ®äº‹åŠ¡ä¸­çš„æŸ¥è¯¢å‘½ä»¤å¿«é€Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„readView,è¯»å–åˆ°çš„æ•°æ®å°±æ˜¯æ–°çš„æ•°æ®   å¯é‡è¯»è¯»  å¤„äºè¯¥çº§åˆ«çš„æ•°æ®åº“ï¼Œè§£å†³äº†è„è¯»ã€ä¸å¯é‡è¯»è¯»çš„é—®é¢˜ï¼Œå¹»è¯»çš„é—®é¢˜åŒæ ·å­˜åœ¨ å®ç°æœºåˆ¶ï¼šçº§åˆ«åœ¨åŸºäºè¯»å·²ä½“æäº¤çš„åŸºç¡€ä¸Šï¼Œå¯¹mvccè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå³åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ä¸ä¼šæ ¹æ®æ¯ä¸€æ¬¡æŸ¥è¯¢éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„readView è€Œæ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åªæœ‰ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ‰åˆ›å»ºä¸€ä¸ªreadView,åç»­æŸ¥è¯¢éƒ½ä½¿ç”¨è¿™ä¸ªreadViewçš„æ•°æ®,è§£å†³äº†ä¸å¯é‡è¯»è¯»çš„é—®é¢˜   åºåˆ—åŒ–/ä¸²è¡ŒåŒ–çº§åˆ«  å¤„äºè¯¥çº§åˆ«çš„æ•°æ®åº“ï¼Œè§£å†³äº†è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»é—®é¢˜ å®ç°æœºåˆ¶ï¼šåºåˆ—åŒ–æ„æ€æ˜¯å°†æ‰€æœ‰çš„äº‹åŠ¡æŒ‰åºæ’é˜Ÿåä¸²è¡ŒåŒ–å¤„ç†ï¼Œä¹Ÿå°±æ˜¯æ“ä½œåŒä¸€å¼ è¡¨çš„äº‹åŠ¡åªèƒ½ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œï¼Œäº‹åŠ¡åœ¨æ‰§è¡Œå‰éœ€è¦å…ˆè·å–è¡¨çº§åˆ«çš„é”èµ„æºï¼Œæ‹¿åˆ°é”èµ„æºçš„äº‹åŠ¡æ‰èƒ½æ‰§è¡Œï¼Œå…¶ä½™äº‹åŠ¡åˆ™é™·å…¥é˜»å¡ï¼Œç­‰å¾…å½“å‰äº‹åŠ¡é‡Šæ”¾é”     äº‹åŠ¡éš”ç¦»æœºåˆ¶çš„å‘½ä»¤  æŸ¥è¯¢å½“å‰æ•°æ®åº“çš„éš”ç¦»çº§åˆ«:  SELECT @@tx_isolation; show variables like \u0026lsquo;%tx_isolation%';   è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºRUçº§åˆ«ï¼ˆå½“å‰è¿æ¥ç”Ÿæ•ˆï¼‰  set transaction isolation level read uncommitted;   è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºRCçº§åˆ«ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰  set global transaction isolation level read committed;   è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºRRçº§åˆ«ï¼ˆå½“å‰è¿æ¥ç”Ÿæ•ˆï¼‰  set tx_isolation = \u0026lsquo;repeatable-read\u0026rsquo;;   è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºæœ€é«˜çš„serializableçº§åˆ«ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰  set global.tx_isolation = \u0026lsquo;serializable\u0026rsquo;;      MySQL æ—¥å¿—  å¸¸ç”¨MySQLæ—¥å¿—å¯åˆ†ä¸ºï¼šundo-log,redo-log,bin-log   undo-log  undo-logæ˜¯æ’¤é”€æ—¥å¿—ï¼Œä¸»è¦å®ç°åœ¨äº‹åŠ¡å›æ»šå’Œmvccæœºåˆ¶ä¸­ å½“å†™å…¥ç±»å‹çš„sqlæ‰§è¡Œæ—¶ï¼Œéƒ½ä¼šè®°å½•undo-logæ—¥å¿—ï¼Œä¼šç”Ÿæˆç›¸åº”çš„åsqlæ”¾å…¥undo-logä¸­ åœ¨mvccæœºåˆ¶ä¸­ï¼Œundo-logä¸­è®°å½•çš„æ—§æ•°æ®å¹¶ä¸æ­¢æ˜¯ä¸€æ¡ï¼Œè€Œæ˜¯å¯èƒ½å­˜åœ¨å¤šæ¡ä¸åŒç‰ˆæœ¬çš„undo-logè®°å½• ï¼Œå…¶å†…éƒ¨é€šè¿‡roll_prtå›æ»šæŒ‡é’ˆç»„æˆä½†é“¾è¡¨ï¼Œè€Œè¯¥é“¾è¡¨ä¹Ÿç§°ä¸ºç‰ˆæœ¬é“¾   redo-log  redo-logæ˜¯é‡åšæ—¥å¿—ï¼Œç”¨æ¥å®ç°æ•°æ®çš„æ¢å¤ redo-logæ˜¯ä¸€ç§é¢„å†™å¼æ—¥å¿—ï¼Œå³åœ¨å‘å†…å­˜å†™æ•°æ®ä¹‹å‰ï¼Œå…ˆå†™å…¥æ—¥å¿—ï¼Œå½“åç»­æ•°æ®æœªè¢«åˆ·åˆ°ç£ç›˜æˆ– mysqlå´©æºƒæ—¶å¯ä»¥é€šè¿‡æ—¥å¿—æ¥å¿«é€Ÿæ¢å¤æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰çš„æ•°æ®éƒ½èƒ½è¢«æŒä¹…åŒ–ï¼ˆé‡‡ç”¨åˆ·ç›˜ç­–ç•¥ï¼‰   bin-log  ç§°ä¸ºäºŒè¿›åˆ¶æ—¥å¿—ï¼Œä¸»è¦è®°å½•æ‰€æœ‰å¯¹æ•°æ®åº“è¡¨ç»“æ„çš„å˜æ›´å’Œè¡¨æ•°æ®çš„ä¿®æ”¹çš„æ“ä½œ     redo-logå’Œbin-logçš„åŒºåˆ«  ç”Ÿæ•ˆèŒƒå›´ä¸åŒï¼Œredo-logæ˜¯innodbå¼•æ“ç‹¬æœ‰ï¼Œè€Œbin-logæ˜¯æ‰€æœ‰å¼•æ“éƒ½é€šç”¨ å†™å…¥æ–¹å¼ä¸åŒï¼Œredo-logæ˜¯é‡‡ç”¨ä¸¤æ–‡ä»¶å¾ªç¯å†™ï¼Œè€Œbin-logæ˜¯ä¸æ–­åˆ›å»ºæ–°æ–‡ä»¶åè¿½åŠ  æ–‡ä»¶æ ¼å¼ä¸åŒï¼Œredo-logæ˜¯è®°å½•æ‰€æœ‰å˜æ›´åçš„æ•°æ®ï¼Œè€Œbin-logæ˜¯è®°å½•æ˜¯å˜æ›´åçš„sql ä½¿ç”¨åœºæ™¯ä¸åŒï¼Œredo-logä¸»è¦å®ç°æ•…éšœæƒ…å†µä¸‹çš„æ•°æ®æ¢å¤ï¼Œè€Œbin-logåˆ™æ˜¯ç”¨äºæ•°æ®ç¾å¤‡åŒæ­¥   æ—¥å¿—çš„ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼š  undo-log: ä¸»è¦å®ç°äº‹åŠ¡çš„ACIDå’Œmvccæœºåˆ¶ redo-log: ä¸»è¦æ˜¯å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ï¼Œç¡®ä¿äº‹åŠ¡æäº¤åä¸ä¼šä¸¢å¤± bin-log: ä¸»è¦ç»“åˆredo-logå®ç°äº‹åŠ¡åŸåˆ™ä¸­çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿äº‹åŠ¡æäº¤åæ•°æ®æ˜¯ä¸€è‡´çš„    äº‹åŠ¡æ€»ç»“  undo-logã€redo-logæ—¥å¿—æ¥çœ‹å¾…ACIDçš„å››å¤§ç‰¹æ€§ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§   åŸå­æ€§  åŸå­æ€§è¦æ±‚äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ å®ç°åŸç†ï¼šåŸºäºundo-logæ¥å®ç°ï¼Œåœ¨è¯¥æ—¥å¿—ä¸­ç”Ÿæˆç›¸åº”çš„åsql,æ‰§è¡Œå¤±è´¥æ—¶ï¼Œåˆ©ç”¨è¯¥æ—¥å¿—å›æ»šæ‰€æœ‰å†™æ“ä½œ   æŒä¹…æ€§  ä¸€è‡´æ€§è¦æ±‚æ‰€æœ‰çš„æ•°æ®éœ€è¦ä¿å­˜åœ¨ç£ç›˜ä¸­ å®ç°åŸç†ï¼šè¿™ä¸€ç‚¹æ˜¯åŸºäºredo-logå®ç°   éš”ç¦»æ€§  éš”ç¦»æ€§è¦æ±‚ä¸€ä¸ªäº‹åŠ¡ä¸ä¼šå—åˆ°å¦ä¸€ä¸ªäº‹åŠ¡çš„å½±å“ä¸€ä¸ªäº‹åŠ¡ä¸ä¼šå—åˆ°å¦ä¸€ä¸ªäº‹åŠ¡çš„å½±å“ -å®ç°åŸç†ï¼šé€šè¿‡é”æœºåˆ¶å’Œmvccæœºåˆ¶å®ç°   ä¸€è‡´æ€§  æ•°æ®åº“çš„æ•´ä½“æ•°æ®å˜åŒ–ï¼Œåªèƒ½ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ï¼Œå…¶å®å‰é¢çš„åŸå­æ€§ã€æŒä¹…æ€§ã€éš”ç¦»æ€§éƒ½æ˜¯ä¸ºäº†ç¡®ä¿è¿™ç‚¹è€Œå­˜åœ¨çš„    \r\n","date":"2022-09-30T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/1_hu0ba8fce09208969ff6b2aee6fef01bdc_192508_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/","title":"æ•°æ®åº“ä¹‹äº‹åŠ¡æœºåˆ¶åŸç†"},{"content":"å¤šè¡¨æŸ¥è¯¢  å¤šè¡¨ä¸€èˆ¬æ˜¯ä¸»è¡¨ï¼Œä¸»è¦å­˜å‚¨æ•°æ®çš„åœ°æ–¹ï¼Œæ¯ä¸€ä¸ªå­—æ®µéƒ½å¯ä»¥é‡å¤ï¼Œæ²¡æœ‰ä¸»é”®ï¼Œ æ— æ³•æ ¹æ®æŸä¸ªå­—æ®µå®šä½åˆ°å‡†ç¡®çš„è®°å½• ä¸€è¡¨ä¸€èˆ¬æ˜¯ä»è¡¨ï¼Œä¸»è¦å­˜å‚¨è¾…åŠ©æ•°æ®ï¼Œé€šè¿‡ä¸»é”®ä¸ä¸»è¡¨è¿æ¥ï¼Œå­˜å‚¨çš„è®°å½•æ˜¯ä¸å¯é‡å¤çš„ï¼Œå¯ä»¥é€šè¿‡ä¸»é”®å®šä½åˆ°è®°å½• å·¦è¿æ¥ï¼šå·¦è¿æ¥æ˜¯ä»¥å·¦è¡¨å–å‡ºæ‰€æœ‰è®°å½•ä¸å³è¡¨åŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä»¥nullå€¼ä»£è¡¨å³è¾¹çš„åˆ— å³è¿æ¥ï¼šå³è¿æ¥æ˜¯ä»¥å³è¡¨å–å‡ºæ‰€æœ‰çš„è®°å½•ï¼Œä¸å·¦è¡¨è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä»¥nullå€¼ä»£è¡¨å·¦è¾¹çš„åˆ— å†…è¿æ¥ï¼šç­‰å€¼è¿æ¥ï¼Œæ˜¯å¤šè¡¨çš„äº¤é›† äº¤å‰è¿æ¥ï¼šè¿”å›ä¸¤è¡¨çš„ç¬›å¡å°”ä¹˜ç§¯ï¼Œä½œç”¨æ˜¯è®¡ç®—ä¸¤ä¸ªè¡¨ä¹‹é—´å¯èƒ½çš„å­˜åœ¨çš„ç»„åˆï¼Œç»“æœæ˜¯é›†ä¸­çš„è®°å½•ç­‰äºä¸¤å¼ å„è‡ªè®°å½•æ•°çš„ä¹˜ç§¯  æ•°æ®åº“èŒƒå¼  èŒƒå¼ï¼šèŒƒå¼æ˜¯å€¼åœ¨è®¾è®¡æ•°æ®åº“è¡¨æ—¶ï¼Œéœ€è¦éµå¾ªçš„ä¸€äº›åŸåˆ™ï¼Œç›®çš„æ˜¯è®©è®¾è®¡çš„æ•°æ®åº“è¡¨ç»“æ„æ›´ä¸ºåˆç†å’Œä¼˜é›…ï¼Œå¸¸è§çš„æ•°æ®åº“èŒƒå¼ä¸ºï¼šæ•°æ®åº“ä¸‰å¤§èŒƒå¼ï¼ˆ1NFã€2NFã€3NFï¼‰ å’Œå·´æ–¯-ç§‘å¾·èŒƒå¼ï¼ˆBCNFï¼‰  æ•°æ®åº“çš„ä¸‰å¤§èŒƒå¼  ä¸‰å¤§èŒƒå¼ä¸ºé€’è¿›å…³ç³»ï¼Œå³åç»­èŒƒå¼æ˜¯å‰èŒƒå¼ä¸ºåŸºç¡€ä¸Šä¼˜åŒ–æˆ–è€…åç»­èŒƒå¼æ˜¯å‰èŒƒå¼çš„ä¼˜åŒ–  ç¬¬ä¸€èŒƒå¼  ç¬¬ä¸€èŒƒå¼ï¼šç¡®ä¿æ•°æ®çš„åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨çš„æ•°æ®å…·å¤‡ä¸å¯åœ¨åˆ†æ€§ åŸå­æ€§ï¼šåŸå­æ€§è§„å®šä¸€ä¸ªå­—æ®µæ˜¯åŸå­ï¼Œä¸èƒ½åœ¨è¿›è¡Œæ‹†åˆ†æˆå¤šä¸ªå­—æ®µ ç¬¬ä¸€èŒƒå¼é™¤äº†å¯¹åˆ—çº§åˆ«çš„æ•°æ®ç”Ÿæ•ˆå¤–ï¼Œå¯¹è¡Œçº§æ•°æ®å¤„ç†ä¸€æ ·ï¼Œå³è¡Œæ•°æ®ä¹‹é—´ç›¸ä¸å½±å“ï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„æ•´ä½“ è‹¥æ•°æ®åº“æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„å½±å“å¦‚ä¸‹ï¼š  å®¢æˆ·ç«¯è¯­è¨€ä¸è¡¨ä¹‹é—´æ— æ³•å¾ˆå¥½çš„ç”Ÿæˆæ˜ å°„å…³ç³» æŸ¥è¯¢å¾—åˆ°çš„æ•°æ®åœ¨è¿›è¡Œæ•°æ®å¤„ç†æ—¶ï¼Œéœ€è¦å¯¹å­—æ®µæ•°æ®è¿›è¡Œé¢å¤–çš„æ‹†åˆ† æ’å…¥æ•°æ®æ—¶ï¼Œéœ€è¦å¯¹å­—æ®µå€¼è¿›è¡Œé¢å¤–æ‹¼æ¥åæ‰èƒ½å†™å…¥åˆ°æ•°æ®åº“ \r    ç¬¬äºŒèŒƒå¼  ç¬¬äºŒèŒƒå¼ï¼šåœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚æ‰€æœ‰çš„è¡¨ä¸­çš„æ‰€æœ‰åˆ—ï¼Œå…¶æ•°æ®éƒ½éœ€è¦ä¾èµ–äºä¸»é”®ï¼Œä¹Ÿå°±æ˜¯ä¸€å¼ è¡¨åªå­˜å‚¨åŒç±»å‹çš„æ•°æ®ï¼Œä¸èƒ½å­˜åœ¨åŒå¼ è¡¨ä¸­å­˜åœ¨ä¸ä¸»é”®æ²¡æœ‰å…³ç³»çš„æ•°æ® ç”±äºæ•°æ®å­˜åœ¨ä¸ä¸»é”®æ•°æ®ä¹‹é—´æ²¡æœ‰å…³è”æ€§ï¼Œå¯¼è‡´è¡¨ä¸­çš„æ•°æ®å­˜åœ¨å†—ä½™çš„æƒ…å†µ ç¬¬äºŒèŒƒå¼è¦æ±‚ï¼šæ¯å¼ è¡¨çš„ä¸šåŠ¡å±æ€§å…·å¤‡â€œå”¯ä¸€æ€§â€ï¼Œé¿å…å­˜åœ¨ä¸€å¼ è¡¨å­˜åœ¨å¤šç§ä¸šåŠ¡å±æ€§çš„æƒ…å†µï¼Œå³â€œä¸€å¼ è¡¨åªæè¿°ä¸€ä»¶äº‹æƒ…â€ \r  ç¬¬ä¸‰èŒƒå¼  ç¬¬ä¸‰èŒƒå¼ï¼šåœ¨ç¬¬ä¸€ï¼Œç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚è¡¨ä¸­çš„æ¯ä¸€åˆ—æ•°æ®ä¸èƒ½ä¸ä¸»é”®å¤–çš„å­—æ®µå­˜åœ¨å…³ç³» ç¬¬ä¸‰èŒƒå¼æ»¡è¶³ï¼šè¡¨ä¸­çš„æ¯ä¸ªéä¸»é”®å­—æ®µä¸å…¶ä»–éä¸»é”®å­—æ®µä¹‹é—´ï¼Œéƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¹‹é—´ä¸å­˜åœ¨ç›¸äº’ä¾èµ–çš„å…³ç³»ï¼Œæ‰€æœ‰å­—æ®µéƒ½ä¾èµ–ä¸»é”® åœ¨è®¾è®¡è¡¨ç»“æ„ä¸­ï¼Œå¦‚ä¸æ»¡è¶³ç¬¬ä¸‰èŒƒå¼ï¼Œåœ¨æ“ä½œè¡¨æ—¶å°±ä¼šå‡ºç°å¼‚å¸¸ï¼Œä½¿å¾—è¡¨éš¾ä»¥ç»´æŠ¤ï¼Œç›¸åé€šè¿‡ç¬¬ä¸‰èŒƒå¼ä¼˜åŒ–åï¼Œè¡¨ç»“æ„ä¼šæ›´åŠ ä¼˜é›…çµæ´»ï¼Œä¹Ÿå®¹æ˜“ ç»´æŠ¤ \r  å·´æ–¯-ç§‘å¾·èŒƒå¼  åœ¨è¡¨ä¸­é™¤äº†ä¸»é”®å¤–ï¼Œè¿˜æœ‰è”åˆä¸»é”®ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šä¸ªåˆ—ç»„æˆçš„ä¸»é”® å·´æ–¯-ç§‘å¾·èŒƒå¼ä¹Ÿç§°ä¸ºï¼š3.5èŒƒå¼ï¼Œå®ƒæ˜¯ç¬¬ä¸‰èŒƒå¼çš„è¡¥å……ï¼Œç¬¬ä¸‰èŒƒå¼è¦æ±‚æ˜¯ï¼šä»»ä½•éä¸»é”®å­—æ®µä¸å…¶ä»–éä¸»é”®å­—æ®µä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå³ è¦æ±‚éä¸»é”®ä¹‹é—´å…·å¤‡ç‹¬ç«‹æ€§ï¼Œå·´æ–¯-ç§‘å¾·èŒƒå¼è¦æ±‚ï¼šä»»ä½•ä¸»å±æ€§ä¸èƒ½å¯¹å…¶ä»–ä¸»é”®å­é›†å­˜åœ¨å…³ç³»ï¼Œå³è”åˆä¸»é”®ä¸­çš„æŸåˆ—å€¼ï¼Œä¸èƒ½ä¸è”åˆä¸»é”®çš„ å…¶ä»–åˆ—å­˜åœ¨ä¾èµ–å…³ç³» å·´æ–¯-ç§‘å¾·èŒƒå¼è§„å®šè”åˆä¸»é”®ä¹‹é—´çš„ä¸å­˜åœ¨ä¾èµ–ï¼Œå³æ»¡è¶³ä¸»é”®çš„ç‹¬ç«‹æ€§ ä¾‹å¦‚ï¼šä»¥classesç­çº§å­—æ®µã€class_adviserç­ä¸»ä»»å­—æ®µã€nameå­¦ç”Ÿå§“åå­—æ®µï¼Œç»„åˆæˆä¸€ä¸ªè”åˆä¸»é”®ï¼Œå°±ä¸ç¬¦åˆå·´æ–¯-ç§‘å¾·èŒƒå¼ \r  èŒƒå¼æ€»ç»“  ç¬¬ä¸€èŒƒå¼ï¼šç¡®ä¿åŸå­æ€§ï¼Œå³ä¿è¯è¡¨ä¸­çš„æ¯ä¸€åˆ—æ•°æ®éƒ½æ˜¯ä¸å¯åœ¨åˆ†çš„å­—æ®µ ç¬¬äºŒèŒƒå¼ï¼šç¡®ä¿å”¯ä¸€æ€§ï¼Œå³ä¿è¯æ¯å¼ è¡¨åªæè¿°ä¸€ç§ä¹‰åŠ¡ï¼Œä¸€å¼ è¡¨åªæè¿°ä¸€ä»¶äº‹æƒ… ç¬¬ä¸‰èŒƒå¼ï¼šç¡®ä¿éä¸»é”®å­—æ®µçš„ç‹¬ç«‹æ€§ï¼Œå³è¡¨ä¸­é™¤ä¸»é”®å¤–ï¼Œæ¯ä¸ªå­—æ®µä¹‹é—´ä¸å­˜åœ¨ä»»ä½•çš„ä¾èµ–æ€§ï¼Œå­—æ®µä¹‹é—´æ˜¯ç‹¬ç«‹çš„ å·´æ–¯-ç§‘å¾·èŒƒå¼ï¼šç¡®ä¿ä¸»é”®å­—æ®µ(è”åˆå­—æ®µ)çš„ç‹¬ç«‹æ€§,å³ä»»ä½•ä¸»å±æ€§ä¸èƒ½å¯¹å…¶å®ƒä¸»é”®å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œè”åˆä¸»é”®ä¹‹é—´ç›¸äº’ç‹¬ç«‹  æ•°æ®åº“é”æœºåˆ¶ æ•°æ®åº“é”æœºåˆ¶ æ•°æ®åº“é”åˆ†ç±»  æŒ‰ç…§é¢—ç²’åº¦åˆ†ç±»ï¼š  è¡¨çº§é”ï¼šå…±äº«è¯»é”å’Œç‹¬å å†™é” è¡Œçº§é”ï¼šå…±äº«é”(s)å’Œæ’ä»–é”(x) é¡µçº§é”   æŒ‰ç…§ä½¿ç”¨æ–¹å¼åˆ†ç±»ï¼š  ä¹è§‚é” æ‚²è§‚é”    è¡¨çº§é”  å¼€é”€å°ï¼ŒåŠ é”å¿«ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”ï¼Œé”å®šé¢—ç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼Œmylsamå’ŒinnoDBéƒ½æ˜¯æ”¯æŒçš„ï¼Œ è¯»è¯»ä¸é˜»ï¼Œå†™å†™é˜»ï¼Œè¯»å†™äº’æ–¥ï¼Œè¯»å†™é”æ˜¯ä¸²è¡Œçš„ï¼Œå†™é”ä¼˜äºè¯»é”  è¡Œçº§é”  å¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼Œä¼šå‘ç”Ÿæ­»é”ï¼Œé”å®šé¢—ç²’åº¦å°ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡ä½ï¼Œå¹¶å‘åº¦é«˜ã€‚innoDBæ”¯æŒï¼Œå› innodb çš„è¡Œé”æ˜¯åŸºäºç´¢å¼•çš„ å…±äº«é”(sé”)ä¹Ÿå«è¯»é”ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡è¯»å–åŒä¸€ä¸ªèµ„æºï¼Œä¸å…è®¸ä¿®æ”¹ æ’ä»–é”(xé”)å…è®¸è·å–æ’ä»–é”çš„äº‹åŠ¡æ›´æ–°æ•°æ®ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å–ç›¸åŒæ•°æ®çš„è¯»é”å’Œæ’ä»–é”ï¼›  ä¹è§‚é”  ä¸é‡‡ç”¨æ•°æ®åº“è‡ªèº«åŠ é”çš„æ–¹å¼ï¼Œé€šè¿‡ç”¨æˆ·ç¨‹åºæ¥å®ç°ï¼Œä¸€èˆ¬é‡‡ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ–è€…æ—¶é—´è¹‰çš„æœºåˆ¶  æ‚²è§‚é”  å¯¹æ•°æ®è¢«å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹ä¿æŒä¿å®ˆçŠ¶æ€ï¼Œä¼šé€šè¿‡æ•°æ®åº“è‡ªèº«åŠ é”çš„æœºåˆ¶å®ç°ï¼Œä»è€Œä¿è¯æ•°æ®æ“ä½œçš„æ’ä»–æ€§  é—´éš™é”  ä½¿ç”¨èŒƒå›´æŸ¥è¯¢è€Œéç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œå¹¶è¯·æ±‚å…±äº«æˆ–è€…æ’ä»–é”æ—¶ï¼Œä¼šç»™ç¬¦åˆèŒƒå›´æ¡ä»¶çš„å·²æœ‰æ•°æ®è®°å½•çš„ç´¢å¼•åŠ é”ï¼Œå¯¹äºé”®å€¼ åœ¨æ¡ä»¶èŒƒå›´å†…ï¼Œä½†ä¸å­˜åœ¨çš„è®°å½•å«åšé—´éš™é”ï¼ˆpapé”ï¼‰ é—´éš™é”å¯é˜²æ­¢å¹»è¯»å’Œæ»¡è¶³æ¢å¤å’Œå¤åˆ¶çš„éœ€è¦  æ•°æ®åº“æ­»é”  æ­»é”ç°è±¡: å¹¶å‘äº‹åŠ¡ï¼Œæœ¬è´¨æ˜¯æ•°æ®åº“å¤šæ¡çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œéœ€è¦å…·å¤‡å®Œå–„çš„é”æœºåˆ¶æ¥é¿å…çº¿ç¨‹çš„ä¸å®‰å…¨ ä½†æ˜¯ä¹Ÿä¼šé€ æˆæ­»é”çš„ç°è±¡ è§£å†³æ­»é”é—®é¢˜  é”è¶…æ—¶æœºåˆ¶ï¼šäº‹åŠ¡/çº¿ç¨‹åœ¨ç­‰å¾…èµ„æºæ—¶ï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´åè‡ªåŠ¨æ”¾å¼ƒç­‰å¾…å¹¶è¿”å› å¤–åŠ›ä»‹å…¥ï¼šå¤–éƒ¨æ¥å…¥ï¼Œå°†æ­»é”æƒ…å†µä¸­çš„æŸä¸ªäº‹åŠ¡/çº¿ç¨‹å¼ºåˆ¶ç»“æŸï¼Œè®©å…¶ä»–äº‹åŠ¡ç»§ç»­æ‰§è¡Œ mysqlçš„é”è¶…æ—¶æœºåˆ¶ï¼šä¸€ä¸ªäº‹åŠ¡åœ¨é•¿æ—¶é—´å†…æ— æ³•è·å–åˆ°é”æ—¶ï¼Œå°±ä¸»åŠ¨æ”¾å¼ƒç­‰å¾…ï¼Œé»˜è®¤é”è¶…æ—¶æ—¶é—´ä¸º50S mysqlæ­»é”æ£€æµ‹ç®—æ³•ï¼š  wait-for graph,å¯åŠ¨åä¼šæ”¶é›†ä¸¤ä¸ªä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯é”çš„ä¿¡æ¯é“¾è¡¨ï¼šç›®å‰æŒæ¯ä¸ªé”çš„äº‹åŠ¡æ˜¯è°ï¼Œ å¦ä¸€ä¸ªæ˜¯ç­‰å¾…é“¾è¡¨ï¼šé˜»å¡çš„äº‹åŠ¡è¦ç­‰å¾…çš„é”æ˜¯è° ç®—æ³•ä¼šä»ä¹‹å‰çš„äº‹åŠ¡ä½œä¸ºèµ·ç‚¹ï¼Œç„¶åä»é”çš„ä¿¡æ¯é“¾è¡¨ä¸­æ‰¾åˆ°å¯¹åº”é”çš„ä¿¡æ¯ï¼Œç„¶åæ ¹æ®é”çš„çš„æŒæœ‰ç€ï¼Œ åœ¨äº‹åŠ¡ç­‰å¾…é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œçœ‹æŒæœ‰ç€çš„äº‹åŠ¡æ˜¯å¦åœ¨ç­‰å¾…è·å–å…¶ä»–é”ï¼Œå¦‚æœæ˜¯åˆ™çœ‹å¦ä¸€ä¸ªæŒæœ‰é”çš„äº‹åŠ¡æ˜¯å¦åœ¨ç­‰å¾…å…¶ä»–é”â€¦â€¦ ç›´åˆ°é”çš„ä¿¡æ¯é“¾è¡¨ä¸­åï¼Œæ˜¯å¦å­˜åœ¨é—­ç¯ï¼Œè‹¥å‡ºç°åˆ™ä»‹å…¥ï¼ˆå¼ºåˆ¶å›æ»šå…¶ä¸­çš„ä¸€ä¸ªäº‹åŠ¡æ¥è¾¾åˆ°è§£é™¤æ­»é”çš„é—®é¢˜ï¼‰ \r å›æ»šäº‹åŠ¡æ—¶ï¼Œä¸€èˆ¬ä¼šåœ¨undo-logæ—¥å¿—ä¸­å›æ»šundoé‡å°‘çš„äº‹åŠ¡ï¼Œå›æ»šä»£ä»·å°‘ é€šè¿‡innodb_deadlock_detect=on/offæ¥æ§åˆ¶æ˜¯å¦å¼€å¯äº†æ­»é”æ£€æµ‹æœºåˆ¶     é˜²æ­¢æ­»é”  ä»¥å›ºå®šçš„é¡ºåºè®¿é—®è¡¨å’Œè¡Œ å¤§äº‹åŠ¡è¿›è¡Œæ‹†åˆ† åŒä¸€äº‹åŠ¡ï¼Œå°½å¯èƒ½çš„ä¸€æ¬¡é”å®š é™ä½éš”ç¦»çº§åˆ« ä¸ºè¡¨æ·»åŠ åˆç†çš„ç´¢å¼• \r    ","date":"2022-09-21T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/5_hu897c59d3d00f9ccd7837ef1ecd5c493a_1058366_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","title":"æ•°æ®åº“ä¹‹åŸºç¡€çŸ¥è¯†"},{"content":"linux å¸¸ç”¨æŸ¥çœ‹å¯æ‰§è¡Œå·¥å…·   readelfï¼šå¯ä»¥æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶ç›¸å…³ä¿¡æ¯\n readif -h æŸ¥çœ‹å¤´ä¿¡æ¯ \r readelf â€“d æŸ¥çœ‹åŠ¨æ€åº“ä¾èµ– \r    File:\n file [å¯è¡Œæ”¿æ–‡ä»¶] æ‰§è¡Œæ–‡ä»¶æ¶æ„ä¿¡æ¯ã€åŠ¨æ€ã€é™æ€ \r ldd æŸ¥çœ‹åŠ¨æ€åº“ \r    Strip\n -I \u0026ndash;input-target= å‡å®šè¾“å…¥æ–‡ä»¶çš„æ ¼å¼ä¸º -O \u0026ndash;output-target= ä»¥æ ¼å¼åˆ›å»ºè¾“å‡ºæ–‡ä»¶ -F \u0026ndash;target= è®¾ç½®è¾“å…¥ã€è¾“å‡ºçš„æ–‡ä»¶æ ¼å¼ä¸º -p \u0026ndash;preserve-dates å¤åˆ¶ä¸Šæ¬¡ä¿®æ”¹æˆ–è€…æ“ä½œçš„æ—¶é—´åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ -R \u0026ndash;remove-section= åˆ é™¤è¾“å‡ºæ–‡ä»¶ä¸­æ®µä¿¡æ¯ -s \u0026ndash;strip-all åˆ é™¤æ‰€æœ‰ç¬¦å·ä¿¡æ¯å’Œé‡å®šä½ä¿¡æ¯ -g -S -d \u0026ndash;strip-debug åˆ é™¤æ‰€æœ‰è°ƒè¯•ä¿¡æ¯å’Œæ®µä¿¡æ¯ \u0026ndash;strip-unneeded åˆ é™¤æ‰€æœ‰é‡å®šä½ä¸­ä¸éœ€è¦çš„ç¬¦å·ä¿¡æ¯ \u0026ndash;only-keep-debug åˆ é™¤è°ƒè¯•ä¿¡æ¯ä»¥å¤–çš„å…¶ä»–æ‰€æœ‰ä¿¡æ¯ -N \u0026ndash;strip-symbol= ä¸æ‹·è´ç¬¦å·ä¿¡æ¯ -K \u0026ndash;keep-symbol= ä¸å»é™¤ç¬¦å·ä¿¡æ¯ -w \u0026ndash;wildcard åœ¨ç¬¦å·ä¸­ä½¿ç”¨é€šé…ç¬¦ -x \u0026ndash;discard-all å»é™¤æ‰€æœ‰éå…¨å±€ç¬¦å·    Linux è¿›ç¨‹è°ƒè¯•å·¥å…·  pidof æŸ¥å‘½ä»¤å¯¹åº”çš„è¿›ç¨‹ç¼–å· (pidof bash) \r Ps  åŸºç¡€å‚æ•°  -A, -e é€‰æ‹©æ‰€æœ‰è¿›ç¨‹ -a é€‰æ‹©é™¤äº†ä¼šè¯é¢†å¯¼å’Œä¸ç»ˆç«¯æ— å…³çš„è¿›ç¨‹ä»¥å¤–çš„æ‰€æœ‰è¿›ç¨‹ã€‚ a BSDæ ¼å¼ï¼Œé€šå¸¸ä¸xåŒæ—¶å‡ºç°ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹   é€‰æ‹©æ€§å‚æ•°  -C æ ¹æ®cmdlistä¸­çš„å‘½ä»¤ è¾“å‡º -p, \u0026ndash;pid æ ¹æ®è¿›ç¨‹idè¿›è¡Œé€‰æ‹©è¾“å‡º \u0026ndash;ppid æ ¹æ®çˆ¶è¿›ç¨‹IDé€‰æ‹©è¾“å‡º -U, \u0026ndash;User æ ¹æ®çœŸå®ç”¨æˆ·ID(RUID)æˆ–ç”¨æˆ·åé€‰æ‹©   æ˜¾ç¤ºçº¿ç¨‹  -L æ˜¾ç¤ºçº¿ç¨‹ç›¸å…³ä¿¡æ¯   æ‚é¡¹  L åˆ—å‡ºæ‰€ä»¥æ”¯æŒçš„æ ¼å¼ï¼ˆåº”ç”¨ä¸-oä¸­çš„è¾“å‡ºæ ¼å¼ï¼‰ e è¾“å‡ºç¯å¢ƒå˜é‡ï¼ˆåœ¨æŒ‡ä»¤åé¢ï¼‰   å¾—åˆ°çº¿ç¨‹ä¿¡æ¯  ps -eLf \r     Pstree  æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„çˆ¶å­å…³ç³» \r   top \r   ç¬¬ä¸€è¡Œæ˜¾ç¤ºçš„æ˜¯ç³»ç»Ÿçš„æ¦‚å†µï¼š\n å½“å‰æ—¶é—´ã€ç³»ç»Ÿçš„è¿è¡Œæ—¶é—´ã€ç™»å½•çš„ç”¨æˆ·æ•°ä»¥åŠç³»ç»Ÿçš„å¹³å‡è´Ÿè½½ã€‚ å¹³å‡è´Ÿè½½æœ‰3ä¸ªå€¼ï¼šæœ€è¿‘1åˆ†é’Ÿçš„ï¼Œæœ€è¿‘5åˆ†é’Ÿçš„ï¼Œæœ€è¿‘15åˆ†é’Ÿçš„å¹³å‡è´Ÿè½½ã€‚ load average æ•°æ®æ¯éš”5ç§’é’Ÿæ£€æŸ¥ä¸€æ¬¡æ´»è·ƒçš„è¿›ç¨‹æ•°ï¼Œå¯ä»¥çœ‹å‡ºç‚¹é—®é¢˜ã€‚ å¤ªé«˜è‚¯å®šä¸è¡Œäº†ã€‚    ç¬¬äºŒè¡Œæ˜¾ç¤ºäº†è¿›ç¨‹:\n topå‘½ä»¤çš„è¾“å‡ºä¸­å°†è¿›ç¨‹å«ä½œä»»åŠ¡ï¼ˆtaskï¼‰ï¼š æ€»è¿›ç¨‹ï¼Œè¿è¡Œã€ä¼‘çœ ã€åœæ­¢æˆ–æ˜¯åƒµåŒ–çŠ¶æ€ï¼ˆåƒµåŒ–çŠ¶æ€æ˜¯æŒ‡è¿›ç¨‹å®Œæˆäº†ï¼Œä½†çˆ¶è¿›ç¨‹æ²¡æœ‰å“åº”ï¼‰ã€‚    ç¬¬ä¸‰è¡Œæ˜¾ç¤ºCPUä¿¡æ¯:\n topæ ¹æ®è¿›ç¨‹çš„å±ä¸»ï¼ˆç”¨æˆ·è¿˜æ˜¯ç³»ç»Ÿï¼‰å’Œè¿›ç¨‹çš„çŠ¶æ€ï¼ˆè¿è¡Œã€ ç©ºé—²è¿˜æ˜¯ç­‰å¾…ï¼‰å°†CPUåˆ©ç”¨ç‡åˆ†æˆå‡ ç±»è¾“å‡ºã€‚ 0.0%usã€user spaceã€‘â€” ç”¨æˆ·ç©ºé—´å ç”¨CPUçš„ç™¾åˆ†æ¯”ã€‚ 1.5%syã€sysctlã€‘â€” å†…æ ¸ç©ºé—´å ç”¨CPUçš„ç™¾åˆ†æ¯”ã€‚ 0.0%niã€ã€‘â€” æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨CPUçš„ç™¾åˆ†æ¯” 98.5%idã€idoltã€‘â€” ç©ºé—²CPUç™¾åˆ†æ¯” 0.0%waã€waitã€‘â€” IOç­‰å¾…å ç”¨CPUçš„ç™¾åˆ†æ¯” 0.0%hiã€Hardware IRQã€‘â€” ç¡¬ä¸­æ–­å ç”¨CPUçš„ç™¾åˆ†æ¯” 0.0%siã€Software Interruptsã€‘â€” è½¯ä¸­æ–­å ç”¨CPUçš„ç™¾åˆ†æ¯”    ç¬¬å››è¡Œæ˜¾ç¤ºå†…å­˜ä¿¡æ¯ï¼š\n total æ€»å†…å­˜ free ç©ºé—²å†…å­˜ used å·²ä½¿ç”¨ buff/cache ç¼“å­˜çš„å†…å­˜é‡    ç¬¬äº”è¡Œæ˜¾ç¤ºswapäº¤æ¢åˆ†åŒºä¿¡æ¯ï¼š\n  totalæ€»å¤§å°\n  freeç©ºé—²\n  used å·²ä½¿ç”¨\n  avail Mem ç¼“å†²çš„äº¤æ¢åŒºæ€»é‡\n  å¯ç”¨å†…å­˜=free + buffer + cached\n  PIDï¼šè¿›ç¨‹çš„IDã€‚\n  USERï¼šè¿›ç¨‹å±ä¸»çš„åå­—ã€‚\n  PRï¼šè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚\n  NIï¼šè¿›ç¨‹çš„è°¦è®©åº¦å€¼ã€‚\n  VIRTï¼šè¿›ç¨‹å ç”¨çš„è™šæ‹Ÿå†…å­˜æ€»é‡ã€‚\n  RESï¼šè¿›ç¨‹å ç”¨çš„ç‰©ç†å†…å­˜æ€»é‡ã€‚\n  SHRï¼šè¿›ç¨‹å’Œå…¶ä»–è¿›ç¨‹å…±äº«çš„å†…å­˜æ€»é‡ã€‚\n  Sï¼šè¿›ç¨‹çš„çŠ¶æ€ï¼ˆDä»£è¡¨å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒRä»£è¡¨åœ¨è¿è¡ŒçŠ¶æ€ï¼ŒSä»£è¡¨ä¼‘çœ çŠ¶æ€ï¼ŒTä»£è¡¨è·Ÿè¸ªçŠ¶æ€æˆ–åœæ­¢çŠ¶æ€ï¼ŒZä»£è¡¨åƒµåŒ–çŠ¶æ€ï¼‰ã€‚\n  %CPUï¼šè¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ¯”ä¾‹ã€‚\n  %MEMï¼šè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜å å¯ç”¨å†…å­˜çš„æ¯”ä¾‹ã€‚\n  TIME+ï¼šè‡ªè¿›ç¨‹å¯åŠ¨åˆ°ç›®å‰ä¸ºæ­¢çš„CPUæ—¶é—´æ€»é‡ã€‚\n  COMMANDï¼šè¿›ç¨‹æ‰€å¯¹åº”çš„å‘½ä»¤è¡Œåç§°ï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨çš„ç¨‹åºåã€‚\n  mï¼šæ˜¾ç¤ºå†…å­˜\n  H: æ˜¾ç¤ºçº¿ç¨‹\n    å…¶ä»–\n M æ ¹æ®é©»ç•™å†…å­˜å¤§å°è¿›è¡Œæ’åº P æ ¹æ®CPUä½¿ç”¨ç™¾åˆ†æ¯”å¤§å°è¿›è¡Œæ’åº T æ ¹æ®æ—¶é—´/ç´¯è®¡æ—¶é—´è¿›è¡Œæ’åº q:é€€å‡º      linuxè¿›ç¨‹procè¯¦è§£  è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤è¡Œ  /proc/[pid]/cmdline   è¿›ç¨‹å  /proc/[pid]/comm   è¿›ç¨‹ç¯å¢ƒå˜é‡  /proc/[pid]/environ   è¿›ç¨‹å¯æ‰§è¡Œæ–‡ä»¶  /proc/[pid]/exe   æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦  /proc/[pid]/fd   æ‰“å¼€æ–‡ä»¶ä¿¡æ¯  /proc/pid/fdinfo   å†…å­˜æ˜ å°„æ–‡ä»¶  /proc/[pid]/map_files/   IOæ–‡ä»¶  /proc/[pid]/io   æ˜“äºé˜…è¯»çš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯  /proc/[pid]/status   è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ï¼Œç”¨äºpsæŒ‡ä»¤  /proc/[pid]/stat   è¿›ç¨‹å†…å­˜ä½¿ç”¨ä¿¡æ¯  /proc/pid/statm    linux å†…å­˜æ£€æµ‹å·¥å…·  Memwatch  åŒé‡é‡Šæ”¾ é”™è¯¯é‡Šæ”¾ æ²¡æœ‰é‡Šæ”¾çš„å†…å­˜ æº¢å‡ºå’Œä¸‹æº¢   Yamd  å†…å­˜æ³„æ¼ åŒé‡é‡Šæ”¾ é”™è¯¯é‡Šæ”¾ è¶Šç•Œè®¿é—®    linux æ€§èƒ½æ£€æµ‹å·¥å…· è¿›ç¨‹ç›¸å…³ä¼˜åŒ–å·¥å…·  ltrace \r  è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿç›¸å…³ä¼˜åŒ–å·¥å…·  lsof  -a åˆ—å‡ºæ‰“å¼€æ–‡ä»¶å­˜åœ¨çš„è¿›ç¨‹ -c\u0026lt;è¿›ç¨‹å\u0026gt; åˆ—å‡ºæŒ‡å®šè¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶ -g åˆ—å‡ºGIDå·è¿›ç¨‹è¯¦æƒ… -d\u0026lt;æ–‡ä»¶å·\u0026gt; åˆ—å‡ºå ç”¨è¯¥æ–‡ä»¶å·çš„è¿›ç¨‹ +d\u0026lt;ç›®å½•\u0026gt; åˆ—å‡ºç›®å½•ä¸‹è¢«æ‰“å¼€çš„æ–‡ä»¶ +D\u0026lt;ç›®å½•\u0026gt; é€’å½’åˆ—å‡ºç›®å½•ä¸‹è¢«æ‰“å¼€çš„æ–‡ä»¶ -n\u0026lt;ç›®å½•\u0026gt; åˆ—å‡ºä½¿ç”¨NFSçš„æ–‡ä»¶ -i\u0026lt;æ¡ä»¶\u0026gt; åˆ—å‡ºç¬¦åˆæ¡ä»¶çš„è¿›ç¨‹ã€‚ï¼ˆ4ã€6ã€åè®®ã€:ç«¯å£ã€ @ip ï¼‰ -p\u0026lt;è¿›ç¨‹å·\u0026gt; åˆ—å‡ºæŒ‡å®šè¿›ç¨‹å·æ‰€æ‰“å¼€çš„æ–‡ä»¶ -u åˆ—å‡ºUIDå·è¿›ç¨‹è¯¦æƒ… -h æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ -v æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ \r    ç½‘ç»œç›¸å…³ä¼˜åŒ–å·¥å…·  netstat  -a æ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨çš„è¿æ¥ä»¥åŠæœ¬æœºä¾¦å¬çš„TCPã€UDPç«¯å£ -l æ˜¾ç¤ºç›‘å¬çš„server port -n ç›´æ¥ä½¿ç”¨IPåœ°å€ï¼Œä¸é€šè¿‡åŸŸåæœåŠ¡å™¨ -p æ­£åœ¨ä½¿ç”¨Socketçš„ç¨‹åºPIDå’Œç¨‹åºåç§° -r æ˜¾ç¤ºè·¯ç”±è¡¨ -t æ˜¾ç¤ºTCPä¼ è¾“åè®®çš„è¿çº¿çŠ¶å†µ -u æ˜¾ç¤ºUDPä¼ è¾“åè®®çš„è¿çº¿çŠ¶å†µ -w æ˜¾ç¤ºRAWä¼ è¾“åè®®çš„è¿çº¿çŠ¶å†µ \r   ss  -aæ˜¾ç¤ºæ‰€æœ‰çš„sockets-læ˜¾ç¤ºæ­£åœ¨ç›‘å¬çš„ -næ˜¾ç¤ºæ•°å­—IPå’Œç«¯å£ï¼Œä¸é€šè¿‡åŸŸåæœåŠ¡å™¨ -pæ˜¾ç¤ºä½¿ç”¨socketçš„å¯¹åº”çš„ç¨‹åº -tåªæ˜¾ç¤ºTCP sockets-uåªæ˜¾ç¤ºUDP sockets -4 -6 åªæ˜¾ç¤ºv4æˆ–v6Vç‰ˆæœ¬çš„sockets -sæ‰“å°å‡ºç»Ÿè®¡ä¿¡æ¯ã€‚ -0 æ˜¾ç¤ºPACKET sockets -w åªæ˜¾ç¤ºRAW sockets -xåªæ˜¾ç¤ºUNIXåŸŸsockets -rå°è¯•è¿›è¡ŒåŸŸåè§£æï¼Œåœ°å€/ç«¯å£ \r    ","date":"2022-09-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-%E6%80%A7%E8%83%BD%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF/3_hu5bc4d06a19d5d5d7b7fe871d036ee380_38629_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-%E6%80%A7%E8%83%BD%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF/","title":"linux æ€§èƒ½è°ƒè¯•æŠ€æœ¯"},{"content":"æŸ¥è¯¢å‘½ä»¤ï¼ˆselectï¼‰  æŸ¥çœ‹è¡¨ç»“æ„ï¼šdesc æˆ–åˆ™show columns from tables; æŸ¥è¯¢ç‰¹å®šçš„åˆ—ï¼šselect column, another_column,â€¦â€¦ FROM table; æŸ¥è¯¢æ‰€æœ‰*ï¼šselect *from table; å¸¦çº¦æŸæŸ¥è¯¢ï¼šSELECT column, another_column, â€¦ FROM table WHERE *condition* AND/OR *another_condition* AND/OR â€¦**; \r \rimage-20221023144431347\r  å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œç­›é€‰å’Œæ’åºï¼š   SQL æä¾›äº†ä¸€ç§ä½¿ç”¨å…³é”®å­—ä¸¢å¼ƒå…·æœ‰é‡å¤åˆ—å€¼çš„è¡Œçš„ä¾¿æ·æ–¹æ³•(DISTINCT):\nSELECT**DISTINCT**column,another_column,â€¦FROMmytableWHERE*condition(s)*;  SQL æä¾›äº†ä¸€ç§ä½¿ç”¨å­å¥æŒ‰ç»™å®šåˆ—æŒ‰å‡åºæˆ–é™åºå¯¹ç»“æœè¿›è¡Œæ’åºçš„æ–¹æ³•(ORDER BY):\nSELECTcolumn,another_column,â€¦FROMmytableWHERE*condition(s)***ORDERBYcolumnASC/DESC**;  å°†ç»“æœé™åˆ¶ä¸ºå­é›†(ORDER BYLIMITOFFSETLIMITOFFSET):\nSELECTcolumn,another_column,â€¦FROMmytableWHERE*condition(s)*ORDERBYcolumnASC/DESC**LIMITnum_limitOFFSETnum_offset**;  ä¿®æ”¹è¡¨åï¼šalter table old_table_name rename to new_name_name;\n  å¢åŠ è¡¨æ³¨é‡Šï¼šalter table table_name comment \u0026ldquo;æ³¨é‡Š\u0026rdquo;ï¼›\n  å¢åŠ è¡¨å­—æ®µæ³¨é‡Šï¼šalter table table_name colunm modify å­—æ®µå ç±»å‹ comment \u0026ldquo;æ³¨é‡Š\u0026rdquo;ï¼›\n  ä½¿ç”¨ JOIN çš„å¤šè¡¨æŸ¥è¯¢ï¼šå…±äº«æœ‰å…³å•ä¸ªå®ä½“çš„ä¿¡æ¯çš„è¡¨éœ€è¦å…·æœ‰ä¸€ä¸ªä¸»é”®ï¼Œç”¨äºåœ¨æ•°æ®åº“ä¸­å”¯ä¸€æ ‡è¯†è¯¥å®ä½“ã€‚ä¸€ç§å¸¸è§çš„ä¸»é”®ç±»å‹æ˜¯è‡ªåŠ¨é€’å¢çš„æ•´æ•°ï¼ˆå› ä¸ºå®ƒä»¬èŠ‚çœç©ºé—´ï¼‰ï¼Œä½†å®ƒä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œæ•£åˆ—å€¼ï¼Œåªè¦å®ƒæ˜¯å”¯ä¸€çš„ã€‚\nSELECTcolumn,another_table_column,â€¦FROMmytableINNERJOINanother_tableONmytable.id=another_table.idWHEREcondition(s)ORDERBYcolumn,â€¦ASC/DESCLIMITnum_limitOFFSETnum_offset;  å¤–éƒ¨è¿æ¥ï¼šåœ¨å¤šä¸ªè¡¨ä¸Šä½¿ç”¨å·¦/å³/å…¨è”åé€‰æ‹©æŸ¥è¯¢ï¼š\nSELECTcolumn,another_column,â€¦FROMmytableINNER/LEFT/RIGHT/FULLJOINanother_tableONmytable.id=another_table.matching_idWHEREcondition(s)ORDERBYcolumn,â€¦ASC/DESCLIMITnum_limitOFFSETnum_offset;  ä½¿ç”¨è¡¨è¾¾å¼è¿›è¡ŒæŸ¥è¯¢ï¼š\n  é™¤äº†ä½¿ç”¨ SQL æŸ¥è¯¢å’Œå¼•ç”¨åŸå§‹åˆ—æ•°æ®å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼å¯¹æŸ¥è¯¢ä¸­çš„åˆ—å€¼ç¼–å†™æ›´å¤æ‚çš„é€»è¾‘ã€‚è¿™äº›è¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨æ•°å­¦ å­—ç¬¦ä¸²å‡½æ•°ä»¥åŠåŸºæœ¬ç®—æœ¯ï¼Œç”¨äºåœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶è½¬æ¢å€¼\nSELECTparticle_speed/2.0AShalf_particle_speedFROMphysics_dataWHEREABS(particle_position)*10.0\u0026gt;500;  é€‰æ‹©å…·æœ‰è¡¨è¾¾å¼åˆ«åçš„æŸ¥è¯¢\nSELECTcol_expressionASexpr_description,â€¦FROMmytable;    ä½¿ç”¨èšåˆçš„æŸ¥è¯¢ï¼šSQL è¿˜æ”¯æŒä½¿ç”¨ å…è®¸æ‚¨æ±‡æ€»æœ‰å…³ä¸€ç»„è¡Œçš„ä¿¡æ¯çš„èšåˆè¡¨è¾¾å¼ï¼ˆæˆ–å‡½æ•°ï¼‰ çš„æ•°æ®\nSELECTAGG_FUNC(column_or_expression)ASaggregate_description,â€¦FROMmytableWHEREconstraint_expression;\r\n  GROUP BYï¼šæŒ‡å®šåˆ—ä¸­å…·æœ‰ç›¸åŒå€¼çš„è¡Œè¿›è¡Œåˆ†ç»„\n  SELECTAGG_FUNC(column_or_expression)ASaggregate_description,â€¦FROMmytableWHEREconstraint_expressionGROUPBYcolumn;  HAVING GROUP BY:å­å¥çº¦æŸçš„ç¼–å†™æ–¹å¼ä¸å­å¥çº¦æŸç›¸åŒï¼Œå¹¶ä¸” åº”ç”¨äºåˆ†ç»„è¡Œ\nSELECTgroup_by_column,AGG_FUNC(column_expression)ASaggregate_result_alias,â€¦FROMmytableWHEREconditionGROUPBYcolumnHAVINGgroup_condition;  æ’å…¥æ•°æ® æ’å…¥æ•°æ®ï¼šå°†æ•°æ®æ’å…¥æ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ anstatementï¼Œå®ƒå£°æ˜å“ªä¸ªè¡¨ è¦å†™å…¥çš„ï¼Œæˆ‘ä»¬æ­£åœ¨å¡«å……çš„æ•°æ®åˆ—ï¼Œä»¥åŠè¦æ’å…¥çš„ä¸€è¡Œæˆ–å¤šè¡Œæ•°æ®ã€‚åœ¨ é€šå¸¸ï¼Œæ’å…¥çš„æ¯ä¸€è¡Œæ•°æ®éƒ½åº”åŒ…å«è¡¨ä¸­æ¯ä¸ªç›¸åº”åˆ—çš„å€¼ã€‚ æ‚¨å¯ä»¥é€šè¿‡æŒ‰é¡ºåºåˆ—å‡ºæ¥ä¸€æ¬¡æ’å…¥å¤šè¡Œã€‚INSERT\nINSERTINTOmytableVALUES(value_or_expr,another_value_or_expr,â€¦),(value_or_expr_2,another_value_or_expr_2,â€¦),â€¦;-- æ’å…¥å…·æœ‰ç‰¹å®šåˆ—çš„è¯­å¥ INSERTINTOmytable(column,another_column,â€¦)VALUES(value_or_expr,another_value_or_expr,â€¦),(value_or_expr_2,another_value_or_expr_2,â€¦),â€¦;æ›´æ–°æ•°æ®ï¼šUPDATE UPDATEmytableSETcolumn=value_or_expr,other_column=another_value_or_expr,â€¦WHEREcondition;åˆ é™¤è¡Œ:DELETE,WHERE DELETEFROMmytableWHEREcondition;ä¸»é”®ä¸å¤–é”®   ä¸»é”®(primary key)ï¼šè¡¨ä¸­å”¯ä¸€æ ‡è¯†çš„ä¸€æ¡è®°å½•ï¼Œä¸èƒ½é‡å¤ï¼Œä¸èƒ½ä¸ºnull, ç”¨æ¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§\n  å¤–é”®(FOREIGN KEY)ï¼šæ˜¯å¦ä¸€å¼ è¡¨ä¸­çš„ä¸»é”®ï¼Œå¤–é”®å¯ä»¥é‡å¤ï¼Œå¯ä»¥ä¸ºnull,ç”¨æ¥å’Œå…¶ä»–è¡¨å»ºç«‹è”ç³»ï¼Œå­˜å‚¨å¼•æ“ä¸ºï¼šinnodb\n å¤–é”®æ•°æ®ç±»å‹å¿…é¡»è¦ä¸çˆ¶è¡¨ä¸­çš„ä¸»é”®çš„ç±»å‹å®Œå…¨ä¸€è‡´ ä¸€å¼ è¡¨ä¸­çš„å¤–é”®åå­—ä¸èƒ½é‡å¤ å¢åŠ å¤–é”®å­—æ®µï¼ˆæ•°æ®å­˜åœ¨ï¼‰ï¼Œå¿…é¡»ä¿è¯æ•°æ®ä¸çˆ¶è¡¨ä¸­çš„ä¸»é”®è¦æ±‚å¯¹åº”    å¤–é”®çš„ä½œç”¨ï¼šå¯¹å­è¡¨å’Œçˆ¶è¡¨çš„çº¦æŸ\n å¯¹å­è¡¨çš„çº¦æŸï¼šåœ¨å­è¡¨è¿›è¡Œæ’å…¥ï¼ˆå¢å’Œä¿®æ”¹ï¼‰æ“ä½œæ—¶ï¼Œå¦‚æœå¯¹åº”çš„å¤–é”®å­—æ®µåœ¨çˆ¶è¡¨æ‰¾ä¸åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œé‚£ä¹ˆæ’å…¥ä¼šå¤±è´¥ å¯¹çˆ¶è¡¨çš„çº¦æŸï¼šåœ¨çˆ¶è¡¨ä¸­è¿›è¡Œæ’å…¥(åˆ å’Œä¿®æ”¹ï¼šå¿…é¡»æ˜¯æ¶‰åŠåˆ°ä¸»é”®ï¼‰æ“ä½œæ—¶ï¼Œå¦‚æœå¯¹åº”çš„ä¸»é”®åœ¨å­è¡¨ä¸­ä¹Ÿè¢«æ•°æ®æ‰€å¼•ç”¨ï¼Œé‚£ä¹ˆæ’å…¥æ“ä½œå°±ä¼šå¤±è´¥ï¼›    å¤–é”®çš„çº¦æŸï¼Œéƒ½æ˜¯é’ˆå¯¹çˆ¶è¡¨ï¼š\n distrist:ä¸¥æ ¼æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šçˆ¶è¡¨ä¸èƒ½è¿›è¡Œæ’å…¥æ“ä½œæ—¶ï¼ˆå¢åŠ æˆ–ä¿®æ”¹ï¼Œé’ˆå¯¹ç€ä¸»é”®ï¼‰ï¼Œå¯¹åº”ä¸»é”®åœ¨å­è¡¨ä¸­è¢«å¼•ç”¨çš„è®°å½• cascade:çº§è”æ¨¡å¼ï¼šçˆ¶è¡¨æ“ä½œåï¼Œå¯¹åº”çš„å­è¡¨ä¹Ÿä¼šè·Ÿç€åˆ é™¤ set null:ç½®ç©ºæ¨¡å¼ï¼šçˆ¶è¡¨æ“ä½œåï¼Œå¯¹åº”çš„å­è¡¨çš„å¤–é”®å­—æ®µä¹Ÿä¼šè¢«è®¾ç½®ä¸ºç©º åˆç†çš„å¤–é”®çº¦æŸæ¨¡å¼ä¸ºï¼šåˆ é™¤æ—¶å­è¡¨è®¾ç½®ä¸ºç©ºï¼ˆç½®ç©ºæ¨¡å¼ï¼‰ï¼Œæ›´æ–°æ—¶å­è¡¨çº§è”æ¨¡å¼ è¯­æ³•ï¼šforeign key(å¤–é”®å­—æ®µ) references çˆ¶è¡¨ï¼ˆä¸»é”®å­—æ®µï¼‰on delete set null on update cascade;    è”åˆæŸ¥è¯¢ä¸å­æŸ¥è¯¢   è”åˆæŸ¥è¯¢ï¼šå°†å¤šæ¬¡æŸ¥è¯¢ï¼Œåœ¨è®°å½•ä¸Šè¿›è¡Œæ‹¼æ¥ï¼ˆå­—æ®µä¸ä¼šå¢åŠ ï¼‰ï¼Œæ¯ä¸€æ¬¡select è¯­å¥è·å–çš„å­—æ®µæ•°å¿…é¡»ä¸¥æ ¼ä¸€è‡´ï¼ˆä½†æ˜¯å­—æ®µç±»å‹æ— å…³ï¼‰\n è¯­æ³•ï¼šselect è¯­å¥1 union [union é€‰é¡¹] select è¯­å¥ â€¦â€¦ union é€‰é¡¹ï¼šselecté€‰é¡¹ä¸€æ ·ï¼š  All ä¿ç•™æ‰€æœ‰ï¼ˆä¸ç®¡é‡å¤ï¼‰ distinct å»é‡ï¼ˆæ•´ä¸ªé‡å¤ï¼‰ï¼Œé»˜è®¤   æ„ä¹‰ï¼š  å•è¡¨æŸ¥è¯¢ï¼šæŸ¥è¯¢åŒä¸€å¼ è¡¨ï¼Œä½†éœ€æ±‚ä¸åŒ å¤šè¡¨æŸ¥è¯¢ï¼šå¤šå¼ è¡¨çš„ç»“æ„å’Œæ•°æ®ï¼ˆç»“æ„ï¼‰å®Œå…¨æ˜¯ä¸€è‡´   åœ¨è”åˆæŸ¥è¯¢ä¸­ä½¿ç”¨order by æ—¶ï¼Œéœ€è¦å¯¹æŸ¥è¯¢è¯­å¥ä½¿ç”¨æ‹¬å·ï¼Œä¸”éœ€è¦ä½¿ç”¨limit    å­æŸ¥è¯¢ï¼šæŸ¥è¯¢çš„ç»“æ„æ˜¯åœ¨æŸä¸€ä¸ªæŸ¥è¯¢ä¹‹ä¸Šï¼ˆä¸€å¤©selectè¯­å¥ä¸­åŒ…å«å¦ä¸€æ¡selectï¼‰\n å­æŸ¥è¯¢åˆ†ç±»ï¼š  æŒ‰ä½ç½®åˆ†ç±»ï¼šå­æŸ¥è¯¢è¯­å¥ï¼ˆselectï¼‰åœ¨å¤–éƒ¨æŸ¥è¯¢è¯­å¥ï¼ˆselectï¼‰çš„ä½ç½®ï¼š  from å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢è·Ÿåœ¨fromä¹‹å where å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢è·Ÿåœ¨whereæ¡ä»¶ä¸­ exists å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢æ˜¯åœ¨existsä¸­   æŒ‰ç…§ç»“æœåˆ†ç±»ï¼šæŒ‰ç…§å­æŸ¥è¯¢çš„æ•°æ®è¿›è¡Œåˆ†ç±»ï¼ˆæŸ¥è¯¢çš„ç»“æ„éƒ½å¯ä»¥ç†è§£ä¸ºäºŒç»´è¡¨ï¼‰  æ ‡é‡å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢æŸ¥è¯¢çš„ç»“æœä¸ºä¸€è¡Œä¸€åˆ— åˆ—å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢æŸ¥è¯¢çš„ç»“æ„ä¸ºä¸€åˆ—å¤šè¡Œ è¡Œå­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢æŸ¥è¯¢çš„ç»“æ„ä¸ºä¸€è¡Œå¤šåˆ—ï¼ˆå¤šè¡Œå¤šåˆ—ï¼‰ï¼Œéœ€è¦å¤Ÿç€è¡Œå…ƒç´ ï¼ˆå¤šä¸ªå­—æ®µæ„æˆï¼šeg(id, name)=(select )ï¼‰ï¼Œ ä»¥ä¸Šä½ç½®éƒ½æ˜¯åœ¨whereæ¡ä»¶è¯­å¥ä¸­ è¡¨å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢æŸ¥è¯¢çš„ç»“æœä¸ºå¤šè¡Œå¤šåˆ—ï¼ˆä½ç½®åœ¨fromä¹‹åï¼‰        è§†å›¾   è§†å›¾view ï¼šæ˜¯ä¸€ç§æœ‰ç»“æ„ï¼ˆäºŒç»´è¡¨ï¼‰ä½†æ˜¯æ²¡ç»“æœï¼ˆç»“æ„ä¸­ä¸çœŸå®å­˜æ”¾æ•°æ®ï¼‰çš„è™šæ‹Ÿè¡¨ï¼Œç»“æ„æ¥æºäºå¯¹åº”çš„åŸºè¡¨ï¼ˆè§†å›¾çš„æ•°æ®æ¥æºï¼‰ï¼›\n åˆ›å»ºè§†å›¾ï¼šcreate view view_name as select è¯­å¥ï¼Œåˆ›å»ºå®Œæˆåå¾ˆç”Ÿæˆå¯¹åº”çš„frmç»“æ„æ–‡ä»¶ï¼›  å•è¡¨è§†å›¾ï¼šåŸºè¡¨æ¥æºåªæœ‰ä¸€ä¸ª å¤šè¡¨è§†å›¾ï¼šåŸºè¡¨æ¥æºè‡³å°‘ä¸¤ä¸ªï¼Œå­—æ®µåä¸èƒ½é‡å¤ï¼›   æŸ¥çœ‹è§†å›¾ï¼šæ‰€æœ‰æŸ¥çœ‹è¡¨çš„æ–¹å¼éƒ½é€‚ç”¨äºè§†å›¾ ä½¿ç”¨è§†å›¾ï¼šä¸»è¦æ˜¯æŸ¥è¯¢ä½¿ç”¨ï¼Œå°†è§†å›¾å½“ä½œè¡¨ä¸€æ ·æŸ¥è¯¢å³å¯ï¼Œæœ¬è´¨æ˜¯æ‰§è¡Œåˆ†è£…çš„selectè¯­å¥ï¼› ä¿®æ”¹è§†å›¾ï¼šè§†å›¾æœ¬èº«ä¸å¯ä¿®æ”¹ï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹è§†å›¾çš„æ¥æº(select)ï¼›alter view view_name as æ–°çš„select è¯­å¥ï¼› åˆ é™¤è§†å›¾ï¼šdrop view view_name; è§†å›¾çš„æ„ä¹‰ï¼š  èŠ‚çœsqlè¯­å¥ï¼Œå°†å¤æ‚çš„sqlè¯­å¥ä¿å­˜ä¸ºè§†å›¾ï¼Œå¯ä»¥ç›´æ¥å¯¹è§†å›¾è¿›è¡Œæ“ä½œ æ•°æ®å®‰å…¨ï¼ˆç›¸å¯¹ï¼‰ï¼šè§†å›¾æ“ä½œä¸»è¦æ˜¯æŸ¥è¯¢ä½¿ç”¨ï¼Œåˆ é™¤è§†å›¾åªæ˜¯åˆ é™¤ç»“æ„ï¼Œä¸ä¼šå½±å“åŸºè¡¨çš„æ•°æ®ï¼›ï¼Œå¯ä»¥å¯¹å¤–æä¾›æœ‰ç”¨æ•°æ®ï¼Œéšè—æ— ç”¨çš„æ•°æ® é€šå¸¸åœ¨å¤§é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œè€Œä¸”æ˜¯åœ¨å¤šç³»ç»Ÿä¸­ä½¿ç”¨ï¼› è§†å›¾å¯ä»¥å¯¹å¤–å‹å¥½å‹ï¼Œä¸åŒçš„ç”¨æˆ·ä½¿ç”¨ä¸åŒçš„è§†å›¾,æä¾›ä¸åŒçš„æ•°æ®ï¼› è§†å›¾æ›´å®¹æ˜“è¿›è¡Œæƒé™æ§åˆ¶ï¼›   è§†å›¾æ•°æ®æ“ä½œï¼šè§†å›¾å¯ä»¥è¿›è¡Œå†™æ“ä½œï¼Œä½†æ˜¯å­˜åœ¨é™åˆ¶ï¼Œæ•°æ®åœ¨è§†å›¾ä¸­è¿›è¡Œæ“ä½œ  è§†å›¾æ–°å¢æ•°æ®ï¼šç›´æ¥å¯¹è§†å›¾æ•°æ®è¿›è¡Œæ–°å¢  å¤šè¡¨è§†å›¾ä¸èƒ½æ–°å¢ï¼Œåˆ é™¤æ•°æ®ï¼Œå¯æ›´æ–°æ•°æ®ï¼› å¯ä»¥å‘å•è¡¨ä¸­æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤æ•°æ®ï¼Œä½†æ˜¯è¯•å›¾ä¸­åŒ…å«çš„å­—æ®µå¿…é¡»åœ¨åŸºè¡¨ä¸­æ‰€æœ‰ä¸èƒ½ä¸ºnullæˆ–è€…æ²¡æœ‰é»˜è®¤å€¼çš„å­—æ®µ æ›´æ–°è§†å›¾é™åˆ¶ï¼šwith check option,å¦‚æœå¯¹è§†å›¾æ›´æ–°çš„æ—¶å€™ï¼Œ é™å®šäº†æŸä¸ªå­—æ®µï¼Œé‚£ä¹ˆåœ¨è§†å›¾æ›´æ–°æ•°æ®çš„æ—¶ï¼Œç³»ç»Ÿä¼šè¿›è¡ŒéªŒè¯ï¼Œä¿è¯æ•°æ®åœ¨æ›´æ–°ä¹‹åï¼Œæ•°æ®ä¾ç„¶èƒ½è¢«å®ä½“æŸ¥è¯¢å‡ºæ¥ï¼Œå¦åˆ™ä¸èƒ½æ›´æ–° è§†å›¾ç®—æ³•ï¼šç³»ç»Ÿå¯¹è§†å›¾ä»¥åŠå¤–éƒ¨æŸ¥è¯¢è§†å›¾çš„selectè¯­å¥çš„ä¸€ç§è§£ææ–¹å¼  undefinedï¼šæœªå®šä¹‰ï¼ˆé»˜è®¤ï¼‰ temptable:ä¸´æ—¶è¡¨ç®—æ³•ï¼Œç³»ç»Ÿå…ˆæ‰§è¡Œè§†å›¾çš„select è¯­å¥ï¼Œç„¶ååœ¨æ‰§è¡Œå¤–éƒ¨æŸ¥è¯¢è¯­å¥select merge:åˆå¹¶ç®—æ³•ï¼Œç³»ç»Ÿå°†è§†å›¾çš„selectè¯­å¥å’Œå¤–éƒ¨çš„æŸ¥è¯¢è¯­å¥selectåˆå¹¶åœ¨æ‰§è¡Œï¼Œæ•ˆç‡é«˜ï¼› ç®—æ³•æŒ‡å®šï¼šåœ¨åˆ›å»ºè§†å›¾çš„æ—¶æŒ‡å®šcreate algorithm=æŒ‡å®šç®—æ³• view view_name as select;          æ•°æ®çš„å¤‡ä»½ä¸è¿˜åŸ   å•è¡¨å¤‡ä»½ï¼šæ¯æ¬¡åªèƒ½å¤‡ä»½ä¸€å¼ è¡¨ï¼Œåªèƒ½å¤‡ä»½æ•°æ®ï¼ˆä¸èƒ½å¤‡ä»½è¡¨ç»“æ„ï¼‰ï¼Œé€šå¸¸å°†è¡¨æ•°æ®å¯¼å‡ºåˆ°æ–‡ä»¶ï¼›\n  å¤–éƒ¨å¯¼å‡ºï¼šselect å­—æ®µå into outfile è·¯å¾„ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰ from æ•°æ®æº\n  æ•°æ®å¯¼å…¥ï¼šload data infile è·¯å¾„ into table table_nameï¼›\u0026ndash; æ€ä¹ˆå¤‡ä»½æ€ä¹ˆè¿˜åŸ\n    sqlçš„å¤‡ä»½ä¸è¿˜åŸï¼šç³»ç»Ÿä¼šå¯¹è¡¨ç»“æ„å’Œæ•°æ®è¿›è¡Œå¤„ç†æˆsqlè¯­å¥ï¼Œç„¶åè¿›è¡Œå¤‡ä»½ï¼›è¿˜åŸï¼šæ‰§è¡Œsqlè¯­å¥å³å¯ï¼ˆä¸»è¦æ˜¯å¤‡ä»½è¡¨ç»“æ„ï¼‰ï¼›\n  å¤‡ä»½ï¼š\n  æ²¡æœ‰å¯¹åº”çš„æŒ‡ä»¤ï¼Œéœ€è¦mysqldump.exe;\n  mysqldump -hPup æ•°æ®åº“åå­— [æ•°æ®è¡¨åå­— â€¦â€¦] \u0026gt;å¤–éƒ¨æ–‡ä»¶ç›®å½•\n  æ•´ä¸ªåº“å¤‡ä»½ï¼šmysqldump -hPup æ•°æ®åº“åå­—\n    è¿˜åŸï¼š\n  mysql -hPup æ•°æ®åº“åå­— \u0026lt;å¤‡ä»½åŸä»¶ï¼›\n  ä½¿ç”¨sql æŒ‡ä»¤ï¼›source å¤‡ä»½åŸä»¶;\n    ä¼˜ç¼ºç‚¹\n å¯ä»¥å¤‡ä»½ç»“æ„ æµªè´¹ç©ºé—´      å¢é‡å¤‡ä»½ï¼šæŒ‡å®šæ—¶é—´æ®µå¼€å§‹å¤‡ä»½ï¼Œå¤‡ä»½æ•°æ®ä¸é‡å¤ï¼Œå¹¶ä¸”æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šè¢«å¤‡ä»½ï¼›\n  äº‹åŠ¡  äº‹åŠ¡æ˜¯ä¸€ç³»åˆ—è¦å‘ç”Ÿçš„æ“ä½œ äº‹åŠ¡å®‰å…¨æ˜¯ä¿æŠ¤è¿ç»­æ“ä½œåŒæ—¶æ»¡è¶³çš„ä¸€ç§æœºåˆ¶ äº‹åŠ¡å®‰å…¨çš„æ„ä¹‰ï¼šä¿è¯æ•°æ®å®‰å…¨çš„å®Œæ•´æ€§ äº‹åŠ¡çš„æ“ä½œï¼š  è‡ªåŠ¨äº‹åŠ¡  ç”¨æˆ·æ“ä½œå®Œï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®è¡¨ä¸­ï¼› ç³»ç»Ÿé€šè¿‡ï¼šautocommit å˜é‡æ§åˆ¶ å¼€å¯æˆ–è€…å…³é—­ï¼šset autocommit = on/1 or off /0   æ‰‹åŠ¨äº‹åŠ¡  å¼€å¯äº‹åŠ¡ï¼š æ‰€æœ‰çš„äº‹åŠ¡æ“ä½œå…ˆä¿å­˜åœ¨æ—¥å¿—ï¼ˆredo.logï¼‰å‘½ä»¤ï¼šstart transaction begin æ‰§è¡Œäº‹åŠ¡ï¼šä¸€äº›åˆ—å†™æ“ä½œ å…³é—­äº‹åŠ¡ï¼šé€‰æ‹©æ€§çš„å°†æ—¥å¿—æ–‡ä»¶ä¸­çš„ç»“æœåŒæ­¥åˆ°æ•°æ®è¡¨æˆ–è€…æ¸…ç©ºæ—¥å¿—æ–‡ä»¶ä¸­çš„æ“ä½œ  åŒæ­¥äº‹åŠ¡ï¼šåŒæ­¥æ•°æ®åˆ°æ•°æ®è¡¨ï¼Œå‘½ä»¤ï¼šcommit; å›æ»šäº‹åŠ¡ï¼šç›´æ¥æ¸…ç©ºæ—¥å¿—ï¼Œrollback;   äº‹åŠ¡åŸç†ï¼šå¼€å¯äº‹åŠ¡ä¹‹åï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½ä¼šä¸´æ—¶ä¿å­˜åœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œåªæœ‰åœ¨commit ä¹‹åæ‰èƒ½åŒæ­¥åˆ°æ•°æ®è¡¨ï¼Œå…¶ä»–æƒ…å†µä¼šæ¸…ç©ºæ—¥å¿— å›æ»šç‚¹ï¼šå½“äº‹åŠ¡å¼€å¯ä¹‹åï¼Œåœ¨æŸä¸€ä¸ªæ“ä½œæˆåŠŸä¹‹åï¼Œå¯ä»¥è®¾ç½®æˆåŠŸçš„ä½ç½®ï¼Œå¯ä»¥æä¾›åç»­æ“ä½œå¤±è´¥åï¼Œè¿”å›è¯¥ä½ç½®ï¼Œè€Œéå…¨éƒ¨å›æ»šï¼Œ  è®¾ç½®å›æ»šç‚¹ï¼šsavepoint å›æ»šç‚¹åå­—ï¼› å›æ»šåˆ°å›æ»šç‚¹ï¼šrollback å›æ»šç‚¹åå­—ï¼›        ç´¢å¼•   ç´¢å¼•æ˜¯æ•°æ®åº“ä¸­å¸¸ç”¨æ¥æé«˜æŸ¥è¯¢æ€§èƒ½çš„å·¥å…·\n  ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“ä¸­å®ç°ï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å±‚ä¸­å®ç°ï¼Œæ¯ç§å¼•æ“çš„ç´¢å¼•å¹¶ä¸ç›¸åŒ\n  æ™®é€šç´¢å¼•normal:\n ç›´æ¥åˆ›å»ºç´¢å¼•ï¼šcreate index index_name on table_name (åˆ—å[len()]â€¦â€¦) ä¿®æ”¹è¡¨æ—¶åˆ›å»ºï¼šalter table table_name add index index_name (åˆ—å[len()â€¦â€¦]) åˆ›å»ºè¡¨æ—¶åˆ›å»ºï¼šcreate table table_name (â€¦â€¦ï¼Œindex index_name (åˆ—å[(len)]â€¦â€¦)    å”¯ä¸€ç´¢å¼• unique:åˆ›å»ºæ–¹å¼å’Œä¸Šæ–¹çš„æ™®é€šç´¢å¼•ç±»ä¼¼ã€‚å³ï¼šå°†æ™®é€šç´¢å¼•çš„â€œindexâ€æ”¹ä¸ºâ€œunique index,åŒºåˆ«åœ¨ï¼šç´¢å¼•çš„æ‰€æœ‰åˆ—çš„æ‰€æœ‰å€¼éƒ½å¿…é¡»æ˜¯å”¯ä¸€\n  ä¸»é”®ç´¢å¼•ï¼šä¸»é”®æ˜¯ä¸€ç§ç‰¹æ®Šçš„å”¯ä¸€ç´¢å¼•ï¼Œä¸€èˆ¬åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®š\n  å…¨æ–‡ç´¢å¼•fulltext:åˆ›å»ºæ–¹å¼å’Œä¸Šæ–¹çš„æ™®é€šç´¢å¼•ç±»ä¼¼ã€‚å³ï¼šå°†æ™®é€šç´¢å¼•çš„â€œindexâ€æ”¹ä¸ºâ€œfulltext indexâ€ã€‚\n  æŸ¥çœ‹ç´¢å¼•ï¼šshow index from table_name;\n  åˆ é™¤ç´¢å¼•ï¼šdrop index index_name on table_name æˆ–è€…alter table table_name drop index index_name;\n  ç¦ç”¨ç´¢å¼•ï¼šalter table table_name disable kyes;\n  å¯ç”¨ç´¢å¼•ï¼šalter table table_name enable keys;\n\rimage-20221113154139517\r\n  \rimage-20221113154151478\r\n\rimage-20221113154538952\r\n\rimage-20221113154558884\r\n","date":"2022-09-01T22:00:38+08:00","image":"https://zcj-git520.github.io/p/mysql-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8/image-20221113154558884_hue265424d23ed96ee9701c444ec0fad6e_286244_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/mysql-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8/","title":"mysql å¸¸ç”¨å‘½ä»¤ä½¿ç”¨"},{"content":"å‰ç¼€æ ‘ã€ä¹Ÿç§°å­—å…¸æ ‘ï¼ˆTrieï¼‰ for go  å‰ç¼€æ ‘æ˜¯ä¸€ç§å¤šå‰æ ‘ç»“æ„ï¼Œç»å¸¸ç”¨æ¥åšå¿«é€Ÿæ£€ç´¢ å‰ç¼€æ ‘ï¼ˆTrieæ ‘ï¼‰ï¼Œå³å­—å…¸æ ‘ï¼Œåˆç§°å•è¯æŸ¥æ‰¾æ ‘æˆ–é”®æ ‘ï¼Œ å®ƒæ˜¯ä¸€ç§ä¸“é—¨å¤„ç†å­—ç¬¦ä¸²åŒ¹é…çš„æ•°æ®ç»“æ„ã€‚ å‰ç¼€æ ‘å¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘æ— è°“çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ ç‰¹ç‚¹ï¼š  æ ¹èŠ‚ç‚¹ä¸åŒ…å«ä»»ä½•key æ¯ä¸ªå­èŠ‚ç‚¹åŒ…å«çš„keyéƒ½ä¸ç›¸åŒ    ä»£ç å®ç°å¦‚ä¸‹ package Trie import ( \u0026#34;fmt\u0026#34; ) // å®šä¹‰å‰ç¼€æ ‘çš„èŠ‚ç‚¹ é€šè¿‡map  type trieNode struct { ChildNodes map[rune]*trieNode // å®šä¹‰å­èŠ‚ç‚¹  //CharCount int // å­—ç¬¦ç»Ÿè®¡  EndNode bool // æ˜¯å¦ä¸ºå­èŠ‚ç‚¹  StrData string // æœ€åèŠ‚ç‚¹æ—¶ï¼Œè¯¥æ•°æ®  } // å‰ç¼€æ ‘çš„å®šä¹‰  type trieTree struct { root *trieNode // æ ¹èŠ‚ç‚¹  WordCount int // è¯æ•°çš„æ•°é‡  } // åˆ›å»ºèŠ‚ç‚¹  func creatNode() *trieNode{ node := make(map[rune]*trieNode) return \u0026amp;trieNode{ ChildNodes: node, //CharCount: 0,  EndNode: false, StrData: \u0026#34;\u0026#34;, } } // è¯æ•°çš„æ•°é‡  func (t *trieTree)len() int{ return t.WordCount } // æ·»åŠ èŠ‚ç‚¹  func (t *trieTree)insertData(data string) error{ if len(data) == 0{ return fmt.Errorf(\u0026#34;æ’å…¥æ•°æ®ä¸ºç©º\u0026#34;) } nodeNext := t.root for _, cha := range data{ _, ok := nodeNext.ChildNodes[cha] // æ˜¯å¦å­˜åœ¨  if !ok{ // åˆ›å»ºèŠ‚ç‚¹  nodeNext.ChildNodes[cha] = creatNode() } nodeNext = nodeNext.ChildNodes[cha] //nodeNext.CharCount++  } // åˆ¤æ–­æ˜¯å¦ä¸ºæœ€åçš„èŠ‚ç‚¹  if !nodeNext.EndNode{ nodeNext.EndNode = true nodeNext.StrData = data t.WordCount ++ } return nil } // æŸ¥è¯¢æŸä¸ªå€¼æ˜¯å¦å­˜åœ¨  func (t *trieTree)FindData(data string) bool{ if t.root == nil || data == \u0026#34;\u0026#34;{ return false } nodeNext := t.root for _, cha := range data { _, ok := nodeNext.ChildNodes[cha] if !ok{ return false } nodeNext = nodeNext.ChildNodes[cha] } if nodeNext.StrData != data{ return false } return true } // éå†æ ‘  func(t *trieTree)traverseData() ([]string, error){ returnData := make([]string,0) if t.root == nil{ return returnData, fmt.Errorf(\u0026#34;æ•°æ®ä¸ºç©º\u0026#34;) } nodeNext := t.root for _, node := range nodeNext.ChildNodes{ t.getData(node, \u0026amp;returnData) } return returnData, nil } // ä½¿ç”¨é€’å½’éå†  func (t *trieTree)getData(nodeNext *trieNode, triData *[]string) { if nodeNext.EndNode{ *triData = append(*triData, nodeNext.StrData) if nodeNext.ChildNodes == nil{ return } } for _, node := range nodeNext.ChildNodes{ t.getData(node, triData) } } // æ¸…ç©ºæ ‘  func (t *trieTree)Clear(){ t.root = nil t.WordCount = 0 } // åˆ é™¤æ•°æ®  func (t *trieTree)DeleteData(data string) error{ if t.root == nil || data == \u0026#34;\u0026#34;{ return fmt.Errorf(\u0026#34;æ•°æ®ä¸ºç©º\u0026#34;) } ok := t.FindData(data) if !ok{ return fmt.Errorf(\u0026#34;%vï¼šæ•°æ®ä¸å­˜åœ¨\u0026#34;, data) } nextNode := t.root t.delete(nextNode, data) return nil } func (t *trieTree)delete(node *trieNode, data string) { // ä»å¤´å¼€å§‹éå†  for _, cha := range data{ node = node.ChildNodes[cha] // å¦‚æœèŠ‚ç‚¹ä¸ºçš„chaçš„ä¸ªæ•°ä¸º1æ—¶ï¼Œç›´æ¥åˆ é™¤èŠ‚ç‚¹  if node.ChildNodes == nil { delete(node.ChildNodes, cha) return } // è¿˜å­˜åœ¨åç»­èŠ‚ç‚¹æ—¶ï¼Œåˆ™å°†æ­¤èŠ‚ç‚¹ä¸åœ¨è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹  if node.EndNode{ node.EndNode = false } } } // æ ¹æ®å‰ç¼€è¿”å›  func (t *trieTree)TrieData(data string) ([]string, error) { returnData := make([]string,0) if t.root == nil || data == \u0026#34;\u0026#34;{ return returnData, fmt.Errorf(\u0026#34;æ•°æ®ä¸ºç©º\u0026#34;) } nodeNext := t.root for _, cha := range data { nodeNext = nodeNext.ChildNodes[cha] } t.getData(nodeNext, \u0026amp;returnData) return returnData, nil } // åˆå§‹åŒ–æ ‘  func InitTrie() *trieTree { node := creatNode() return \u0026amp;trieTree{ root: node, WordCount: 0, } } æµ‹è¯•ä»£ç å¦‚ä¸‹ package Trie import ( \u0026#34;fmt\u0026#34; \u0026#34;testing\u0026#34; ) func TestInsertData(t *testing.T) { trie := InitTrie() var testStr = []string{\u0026#34;zc\u0026#34;, \u0026#34;zzc\u0026#34;, \u0026#34;zcj\u0026#34;,\u0026#34;rr\u0026#34;,\u0026#34;å¥½çš„\u0026#34;, \u0026#34;zdd\u0026#34;, \u0026#34;zcf\u0026#34;, \u0026#34;æ‰¾è½¦ä¼°è®¡\u0026#34;,\u0026#34;å¼ ä¼Ÿ\u0026#34;} for _, str := range testStr{ err := trie.insertData(str) if err != nil { t.Error(err) } } //trie.Clear()  dataS, err := trie.traverseData() if err != nil { t.Error(err) } fmt.Println(dataS) ok := trie.FindData(\u0026#34;zcj1\u0026#34;) if !ok { fmt.Println(\u0026#34;zcj is not exist\u0026#34; ) }else{ fmt.Println(\u0026#34;zcj is exist\u0026#34; ) } //err = trie.DeleteData(\u0026#34;rr\u0026#34;)  //if err != nil {  //\tt.Error(err)  //}  dataS, err = trie.traverseData() if err != nil { t.Error(err) } fmt.Println(dataS) fmt.Println(\u0026#34;****************************\u0026#34;) dataS, err = trie.TrieData(\u0026#34;z\u0026#34;) if err != nil { t.Error(err) } fmt.Println(dataS) } æºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/tree/Trie  ","date":"2022-08-25T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-trie-tree-go%E5%AE%9E%E7%8E%B0/1_hu0a2d209b387a8817d63fbca7ab1b3342_170472_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-trie-tree-go%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-Trie tree goå®ç°"},{"content":"RSAåŠ å¯†ç®—æ³•çš„ä½¿ç”¨  ç”Ÿæˆå…¬ç§é’¥ ä¿å­˜æ–‡ä»¶æˆ–è€…ä¿å­˜åœ¨å†…å­˜ä¸­ è®¾ç½®æ—¶é—´æœ‰æ•ˆæœŸï¼Œé•¿æœŸæœ‰æ•ˆæˆ–è€…è¶…æ—¶é‡åˆ›å»ºå…¬ç§é’¥  ä»£ç å¦‚ä¸‹ package zcj_rsa import ( \u0026#34;crypto/rand\u0026#34; \u0026#34;crypto/rsa\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;encoding/base64\u0026#34; \u0026#34;encoding/pem\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;path\u0026#34; \u0026#34;time\u0026#34; ) const ( BITS = 2048 // è¯ä¹¦å¤§å°  SAVEKEYPATH = \u0026#34;./\u0026#34; // é»˜è®¤ä¿å­˜å…¬ç§é’¥çš„è·¯å¾„  ) type signData struct { publicKey string // å…¬é’¥  privateKey string // ç§é’¥  generateTime time.Time // ç”Ÿæˆæ—¶é—´  isCreate bool // æ˜¯å¦åˆ›å»ºå…¬ç§é’¥  Timeout int // è¯ä¹¦è¶…æ—¶æ—¶é—´ å•ä½æ—¶é—´ä¸ºåˆ†é’Ÿ \u0026lt;= 0 è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ  SaveMode bool // true ä¿å­˜ä¸ºæ–‡ä»¶ï¼ŒFalseä¿å­˜åœ¨å†…å­˜ä¸­  PublicKeyPath string // ä¿å­˜å…¬é’¥çš„è·¯å¾„  PrivateKeyPath string // ä¿å­˜ç§é’¥çš„è·¯å¾„  } // åˆ›å»ºå…¬ç§é’¥å¯¹  func (s *signData)creatKey() error { if s.isEffectiveKey(){ return fmt.Errorf(\u0026#34;å…¬ç§é’¥å·²å­˜åœ¨\u0026#34;) } // åˆ›å»ºç§é’¥  prvKey, err := rsa.GenerateKey(rand.Reader, BITS) if err != nil { return err } //é€šè¿‡x509æ ‡å‡†å°†å¾—åˆ°çš„rasç§é’¥åºåˆ—åŒ–ä¸ºASN.1 çš„ DERç¼–ç å­—ç¬¦ä¸²  x509PrivateKey := x509.MarshalPKCS1PrivateKey(prvKey) privateKeyBlock := \u0026amp;pem.Block{ Type:\u0026#34;RSA Private key\u0026#34;, Bytes: x509PrivateKey, } //å¤„ç†å…¬é’¥,å…¬é’¥åŒ…å«åœ¨ç§é’¥ä¸­  pubKey := prvKey.PublicKey //é€šè¿‡x509æ ‡å‡†å°†å¾—åˆ°çš„raså…¬é’¥åºåˆ—åŒ–ä¸ºASN.1 çš„ DERç¼–ç å­—ç¬¦ä¸²  x509PublicKey, err := x509.MarshalPKIXPublicKey(\u0026amp;pubKey) if err != nil { return err } publicKeyBlock := \u0026amp;pem.Block{ Type:\u0026#34;RSA Public key\u0026#34;, Bytes: x509PublicKey, } if s.SaveMode{ publicFile, err := os.Create(path.Join(s.PublicKeyPath, \u0026#34;public.pem\u0026#34;)) if err!=nil{ return err } privateKeyFile, err := os.Create(path.Join(s.PrivateKeyPath, \u0026#34;privateKey.pem\u0026#34;)) if err!=nil{ return err } defer publicFile.Close() defer privateKeyFile.Close() //ä¿å­˜åˆ°æ–‡ä»¶  err = pem.Encode(privateKeyFile,privateKeyBlock) if err!=nil{ return err } err = pem.Encode(publicFile,publicKeyBlock) if err!=nil{ return err } }else{ s.publicKey = string(pem.EncodeToMemory(publicKeyBlock)) s.privateKey = string(pem.EncodeToMemory(privateKeyBlock)) } s.generateTime = time.Now() s.isCreate = true return nil } // åˆ¤æ–­å…¬ç§é’¥æ˜¯å¦æœ‰æ•ˆ  func (s *signData)isEffectiveKey()bool{ if s.isCreate{ if s.Timeout \u0026lt;= 0{ //log.Info(\u0026#34;å…¬ç§é’¥åˆ›å»ºï¼Œä¸”æ°¸ä¹…æœ‰æ•ˆ\u0026#34;)  return true } duration := time.Now().Sub(s.generateTime).Minutes() if int(duration) \u0026lt;= s.Timeout{ //log.Info(\u0026#34;å…¬ç§é’¥åˆ›å»ºï¼Œä¸”åœ¨æœ‰æ•ˆæœŸ\u0026#34;)  return true } } return false } // ä½¿ç”¨ç§é’¥è¿›è¡Œè§£å¯†  func (s *signData)RSADecryption(cipherText string)(string, error){ // ä¿å­˜åœ¨å†…å­˜ä¸­è¿›è¡Œåˆ¤æ–­  if !s.SaveMode \u0026amp;\u0026amp; !s.isEffectiveKey(){ return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;å…¬ç§é’¥æœªåˆ›å»º\u0026#34;) } cipherBuf, err := base64.StdEncoding.DecodeString(cipherText) if err != nil { return \u0026#34;\u0026#34;, err } var buf []byte if s.SaveMode{ file,err:=os.Open(path.Join(s.PrivateKeyPath, \u0026#34;privateKey.pem\u0026#34;)) if err!=nil{ panic(err) } defer file.Close() //è¯»å–æ–‡ä»¶çš„å†…å®¹  info, _ := file.Stat() buf =make([]byte,info.Size()) file.Read(buf) }else{ buf = []byte(s.privateKey) } block, _ := pem.Decode(buf) if block == nil{ return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;pem decode fild\u0026#34;) } privateKey, err := x509.ParsePKCS1PrivateKey(block.Bytes) if err != nil { return \u0026#34;\u0026#34;, err } plainText, err := rsa.DecryptPKCS1v15(rand.Reader, privateKey, cipherBuf) if err != nil { return \u0026#34;\u0026#34;, err } return string(plainText), err } // ä½¿ç”¨å…¬é’¥åŠ å¯†  func (s *signData)RSAEncryption(plainText string)(string, error){ // ä¿å­˜åœ¨å†…å­˜ä¸­è¿›è¡Œåˆ¤æ–­  if !s.SaveMode \u0026amp;\u0026amp; !s.isEffectiveKey(){ return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;å…¬ç§é’¥æœªåˆ›å»º\u0026#34;) } var buf []byte if s.SaveMode{ file,err:=os.Open(path.Join(s.PrivateKeyPath, \u0026#34;public.pem\u0026#34;)) if err!=nil{ panic(err) } defer file.Close() //è¯»å–æ–‡ä»¶çš„å†…å®¹  info, _ := file.Stat() buf =make([]byte,info.Size()) file.Read(buf) }else{ buf = []byte(s.publicKey) } block, _ := pem.Decode(buf) if block == nil{ return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;pem decode fild\u0026#34;) } //x509è§£ç   publicKeyInterface, err := x509.ParsePKIXPublicKey(block.Bytes) if err!=nil{ return \u0026#34;\u0026#34;, nil } //ç±»å‹æ–­è¨€  publicKey:=publicKeyInterface.(*rsa.PublicKey) //å¯¹æ˜æ–‡è¿›è¡ŒåŠ å¯†  cipherText, err := rsa.EncryptPKCS1v15(rand.Reader, publicKey, []byte(plainText)) if err!=nil{ return \u0026#34;\u0026#34;, nil } strCipher := base64.StdEncoding.EncodeToString(cipherText) return strCipher, nil } func RsaInit(saveMode bool, timeOut int, publicKeyPath, privateKeyPath string) *signData { if publicKeyPath == \u0026#34;\u0026#34;{ publicKeyPath = SAVEKEYPATH } if privateKeyPath == \u0026#34;\u0026#34;{ privateKeyPath = SAVEKEYPATH } return \u0026amp;signData{ isCreate:\tfalse, Timeout: timeOut, SaveMode: saveMode, PublicKeyPath: publicKeyPath, PrivateKeyPath: privateKeyPath, } } æµ‹è¯•å¦‚ä¸‹ package zcj_rsa import ( \u0026#34;fmt\u0026#34; \u0026#34;testing\u0026#34; ) // åˆ›å»ºrsaä¿å­˜åœ¨æ–‡ä»¶  func TestRsaFile(t *testing.T) { rsa := RsaInit(true, 1, \u0026#34;./\u0026#34;, \u0026#34;./\u0026#34;) err := rsa.creatKey() if err != nil { t.Errorf(\u0026#34;å…¬ç§é’¥åˆ›å»ºå¤±è´¥: %v\u0026#34;, err) } // åŠ å¯†  cipherText, err := rsa.RSAEncryption(\u0026#34;zcj\u0026#34;) if err != nil { t.Errorf(\u0026#34;åŠ å¯†å¤±è´¥ï¼š%v\u0026#34;, err) } // è§£å¯†  planinText, err := rsa.RSADecryption(cipherText) if err != nil { t.Errorf(\u0026#34;è§£å¯†å¤±è´¥ï¼š%v\u0026#34;, err) } fmt.Printf(\u0026#34;å¯†æ–‡ï¼š%v \\n\u0026#34;, cipherText) fmt.Printf(\u0026#34;åŸç ï¼š%v \\n\u0026#34;, planinText) } // ä¿å­˜rsaåœ¨å†…å­˜  func TestRsa(t *testing.T) { rsa := RsaInit(false, 1, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;) err := rsa.creatKey() if err != nil { t.Errorf(\u0026#34;å…¬ç§é’¥åˆ›å»ºå¤±è´¥: %v\u0026#34;, err) } // åŠ å¯†  cipherText, err := rsa.RSAEncryption(\u0026#34;zcj\u0026#34;) if err != nil { t.Errorf(\u0026#34;åŠ å¯†å¤±è´¥ï¼š%v\u0026#34;, err) } // è§£å¯†  planinText, err := rsa.RSADecryption(cipherText) if err != nil { t.Errorf(\u0026#34;è§£å¯†å¤±è´¥ï¼š%v\u0026#34;, err) } fmt.Printf(\u0026#34;å¯†æ–‡ï¼š%v \\n\u0026#34;, cipherText) fmt.Printf(\u0026#34;åŸç ï¼š%v \\n\u0026#34;, planinText) } æºç ä»“åº“  æˆ‘çš„github:https://github.com/zcj-git520/zcj_rsa  ","date":"2022-08-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/rsa%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/1_hu90b9af4bc0d9f7c3043b63f92872793b_76034_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/rsa%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/","title":"RSAåŠ å¯†ç®—æ³•çš„ä½¿ç”¨"},{"content":"proto3 è¯­æ³•å­¦ä¹  åŸºæœ¬è§„èŒƒ   æ–‡ä»¶ä»¥.protoä¸ºæ–‡ä»¶åç¼€ï¼Œé™¤äº†ç»“æ„ä½“å¤–ï¼Œå…¶ä»–è¯­å¥ä»¥åˆ†å·ç»“æŸ\n  ç»“æ„å®šä¹‰å¯ä»¥åŒ…å«ï¼šmessageã€serviceã€enum\n  rpcæ–¹æ³•å®šä¹‰ç»“å°¾çš„åˆ†å·å¯æœ‰å¯æ— \n  Messageå‘½åé‡‡ç”¨é©¼å³°å‘½åæ–¹å¼ï¼Œå­—æ®µå‘½åé‡‡ç”¨å°å†™å­—æ¯åŠ ä¸‹åˆ’çº¿åˆ†éš”æ–¹å¼ï¼›ä¸¾ä¾‹ï¼š\nmessage ServerMessage{\trequired string server_name = server1;}  Enumsç±»å‹åé‡‡ç”¨é©¼å³°å‘½åæ–¹å¼ï¼Œå­—æ®µåé‡‡ç”¨å¸¦å¤§å†™å­—æ¯åŠ ä¸‹åˆ’çº¿åˆ†éš”æ–¹å¼ï¼›ä¸¾ä¾‹ï¼š\nenum Sought{\tFIRST_VALUE = 100;\tSECONED_VALUE = 1200;}  Serviceç±»å‹é‡‡ç”¨é©¼å³°å‘½åæ–¹å¼ï¼›ä¸¾ä¾‹ï¼š\nservice UserService{ rpc Login(LoginRequest)return(LoginResponse);}å­—æ®µè§„åˆ™   å­—æ®µæ ¼å¼ï¼šé™å®šä¿®é¥°ç¬¦|æ•°æ®ç±»å‹|å­—æ®µåç§°|=|å­—æ®µç¼–ç å€¼|[å­—æ®µé»˜è®¤å€¼]\n  é™å®šä¿®é¥°ç¬¦å· required\\optional\\repeated\n required:è¡¨ç¤ºæ˜¯ä¸€ä¸ªå¿…é¡»çš„å­—æ®µï¼Œå¿…é¡»è¦å‘é€ç»™å¯¹æ–¹ï¼Œåœ¨å‘é€ä¹‹å‰å¿…é¡»è®¾ç½®è¯¥å­—æ®µçš„å€¼ï¼Œå¯¹äºæ¥æ”¶æ–¹ï¼Œå¿…é¡»èƒ½å¤Ÿè¯†åˆ«è¯¥å­—æ®µçš„æ„æ€ï¼Œåœ¨å‘é€ä¹‹å‰æ²¡æœ‰è®¾ç½®requiredå­—æ®µæˆ–è€…æ— æ³•è¯†åˆ«è¯¥å­—æ®µéƒ½ä¼šå¼•èµ·ç¼–ç å¼‚å¸¸ï¼Œå¯¼è‡´æ¶ˆæ¯è¢«ä¸¢å¼ƒ optional:è¡¨ç¤ºä¸ºå¯é€‰å­—æ®µï¼Œå¯¹äºå‘é€æ–¹ï¼Œåœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥é€‰æ‹©æ€§è®¾ç½®æˆ–è€…ä¸è®¾ç½®è¯¥å­—æ®µå€¼ï¼Œå¯¹äºæ¥æ”¶æ–¹ï¼Œå¦‚æœèƒ½å¤Ÿè¯†åˆ«å¯é€‰å­—æ®µå°±è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå¦‚æœæ— æ³•è¯†åˆ«ï¼Œåˆ™å°±å¿½ç•¥è¯¥å­—æ®µï¼Œæ¶ˆæ¯ä¸­çš„å…¶ä»–å­—æ®µæ­£å¸¸å¤„ç†ã€‚å› ä¸ºoptionalå­—æ®µçš„ç‰¹æ€§ï¼Œå¾ˆå¤šæ¥å£åœ¨å‡çº§ç‰ˆæœ¬ä¸­æŠŠåé¢æ·»åŠ å¤§çš„å­—æ®µéƒ½ç»Ÿä¸€è®¾ç½®ä¸ºoptionalå­—æ®µï¼Œè¿™æ ·åœ¨è€ç‰ˆæœ¬æ— æ³•å‡çº§çš„æ—¶ï¼Œä¹Ÿèƒ½æ­£å¸¸äºæ–°çš„è½¯ä»¶è¿›è¡Œé€šä¿¡ï¼Œåªä¸è¿‡æ–°çš„å­—æ®µæ— æ³•è¯†åˆ«è€Œå·²ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ–°çš„åŠŸèƒ½ï¼Œå› æ­¤å¯ä»¥åšåˆ°æŒ‰éœ€å‡çº§å’Œå¹³æ»‘è¿‡æ¸¡ repeated:è¡¨ç¤ºè¯¥å­—æ®µå¯ä»¥åŒ…å«0-nä¸ªå…ƒç´ ï¼Œå…¶ç‰¹æ€§å’Œoptionalä¸€æ ·ï¼Œä½†æ˜¯æ¯ä¸€æ¬¡å¯ä»¥åŒ…å«ä¸ªå¤šä¸ªå€¼ï¼Œå¯ä»¥çœ‹ä½œæ˜¯åœ¨ä¼ é€’ä¸€ä¸ªæ•°ç»„çš„å€¼    æ•°æ®ç±»å‹ï¼šprotobufå®šä¹‰äº†ä¸€å¥—åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå‡ ä¹å¯ä»¥æ˜ å°„åˆ°c++\\javaç­‰è¯­è¨€çš„åŸºç¡€æ•°æ®ç±»å‹\n\r\n    å­—æ®µåç§°\n å­—æ®µåç§°çš„å‘½åä¸cã€c++ã€javaç­‰è¯­è¨€çš„å˜é‡å‘½åæ–¹å¼å‡ ä¹ç›¸åŒ protobufå»ºè®®å­—æ®µçš„å‘½åé‡‡ç”¨é‡‡ç”¨ä¸‹æ»‘çº¿åˆ†å‰²çš„é©¼å³°å¼    å­—æ®µç¼–ç å€¼\n æœ‰äº†å­—æ®µç¼–ç å€¼ï¼Œé€šä¿¡åŒæ–¹æ‰èƒ½äº’ç›¸è¯†åˆ«å¯¹æ–¹çš„å­—æ®µï¼Œç›¸åŒçš„ç¼–ç å€¼ï¼Œå…¶é™å®šä¿®é¥°ç¬¦å’Œæ•°æ®ç±»å‹å¿…é¡»ç›¸åŒï¼Œç¼–ç å€¼çš„èŒƒå›´ä¸ºï¼š1-2^32 å…¶ä¸­1-15çš„ç¼–ç æ—¶é—´å’Œç©ºé—´æ•ˆç‡éƒ½å¾ˆé«˜ï¼Œç¼–ç å€¼è¶Šå¤§ï¼Œå…¶ç¼–ç çš„æ˜¯æ—¶é—´å’Œç©ºé—´æ•ˆç‡å°±è¶Šä½ï¼Œæ‰€ä»¥å»ºè®®æŠŠç»å¸¸è¦ä¼ é€’çš„å€¼æŠŠå…¶å­—æ®µç¼–ç è®¾ç½®ä¸º1-15ä¹‹å‰çš„å€¼ 1900-2000ç¼–ç å€¼ä¸ºGoogle protobufç³»ç»Ÿå†…éƒ¨ä¿ç•™å€¼ï¼Œå»ºè®®ä¸è¦ä½¿ç”¨    å­—æ®µé»˜è®¤å€¼\n å½“åœ¨ä¼ é€’æ•°æ®æ—¶ï¼Œå¯¹äºrequiredæ•°æ®ç±»å‹ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®å€¼ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ä¼ é€’åˆ°å¯¹ç«¯    serviceå®šä¹‰   å¦‚æœæƒ³è¦å°†æ¶ˆæ¯ç±»å‹ç”¨åœ¨rpcç³»ç»Ÿä¸­ï¼Œå¯ä»¥åœ¨.protoæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªRPCæœåŠ¡æ¥å£ï¼Œ protocol buffer ç¼–è¯‘å™¨ä¼šæ ¹æ®æ‰€é€‰æ‹©çš„ä¸åŒè¯­è¨€ç”Ÿæˆå¯¹åº”çš„æœåŠ¡å™¨æ¥å£ä»£ç \n  ä¾‹å¦‚ï¼Œæƒ³è¦å®šä¹‰ä¸€ä¸ªRPCæœåŠ¡å¹¶å…·æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶SearchRequestå¹¶è¿”å›ä¸€ä¸ªSearchResponseï¼Œæ­¤æ—¶å¯ä»¥åœ¨.protoæ–‡ä»¶ä¸­è¿›è¡Œå¦‚ä¸‹å®šä¹‰ï¼š\nservice SearchService { rpc Search (SearchRequest) returns (SearchResponse) {} }  ç”Ÿæˆçš„æ¥å£ä»£ç ä½œä¸ºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„çº¦å®šã€‚æœåŠ¡ç«¯å¿…é¡»å®ç°å®šä¹‰çš„æ‰€æœ‰æ¥å£æ–¹æ³•ï¼Œå®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨åŒåæ–¹æ³•å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå³ä½¿ä¸šåŠ¡ä¸Šä¸éœ€è¦å‚æ•°ä¹Ÿå¿…é¡»æŒ‡å®šä¸€ä¸ªè¯·æ±‚æ¶ˆæ¯ï¼Œä¸€èˆ¬ä¼šå®šä¹‰ç©ºçš„message\n  Messageå®šä¹‰   ä¸€ä¸ªmessageç±»å‹å®šä¹‰äº†ä¸€ä¸ªè¯·æ±‚æˆ–è€…å“åº”çš„æ¶ˆæ¯æ ¼å¼ï¼Œå¯ä»¥åŒ…å«å¤šç§ç±»å‹çš„å­—æ®µ\n  å­—æ®µåç”¨å°å†™ï¼Œè½¬ä¸ºgoæ–‡ä»¶æ—¶ä¼šè‡ªåŠ¨è½¬ä¸ºå¤§å†™ï¼Œmessageå°±ç›¸å½“äºç»“æ„ä½“\n  é¦–è¡Œå£°æ˜ä½¿ç”¨çš„protobufç‰ˆæœ¬ä¸ºproto3\nsyntax = \u0026#34;proto3\u0026#34;massage SearchRequest{ string name = \u0026#34;zcj\u0026#34;; // æŸ¥è¯¢çš„åå­—  int32 pirce= 600; //ä»·æ ¼  int32 producet_num = 1; // äº§å“ç¼–å· }  ä¸€ä¸ª.protoæ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰å¤šä¸ªæ¶ˆæ¯ç±»å‹ï¼Œä¸€èˆ¬ç”¨äºåŒæ—¶å®šä¹‰çš„å¤šä¸ªç›¸å…³çš„ä¿¡æ¯\nsyntax = \u0026#34;proto3\u0026#34;massage SearchRequest{ string name = \u0026#34;zcj\u0026#34;; // æŸ¥è¯¢çš„åå­—  int32 pirce= 600; //ä»·æ ¼  int32 producet_num = 1; // äº§å“ç¼–å· }// å“åº” message SearchResponse{// å“åº”ä¿¡æ¯ }  message æ”¯æŒåµŒå¥—ä½¿ç”¨ï¼Œä½œä¸ºå¦ä¸€ä¸ªmessageä¸­çš„å­—æ®µç±»å‹\nmessage Result{ string name = \u0026#34;zcj\u0026#34;; string title = \u0026#34;proto3\u0026#34;; int32 price = 1000;}message SearchResponse{ repeated Result result = 1;}  æ”¯æŒåµŒå¥—ä¿¡æ¯ï¼Œæ¶ˆæ¯å¯ä»¥åŒ…å«å¦ä¸€ä¸ªæ¶ˆæ¯ä½œä¸ºå­—æ®µï¼Œä¹Ÿå¯ä»¥åœ¨æ¶ˆæ¯å†…å®šä¹‰ä¸€ä¸ªæ–°çš„æ¶ˆæ¯\n  å†…éƒ¨å£°æ˜çš„messageç±»å‹æ˜æ˜¾å¯ä»¥åœ¨å†…éƒ¨ç›´æ¥ä½¿ç”¨\nmessage SearchReponse{ message Resylt{ string name = \u0026#34;zcj\u0026#34;; string title = \u0026#34;proto3\u0026#34;; int32 price = 1000; } repeated Resylt re = 1;}  proto3çš„Mapç±»å‹   proto3æ”¯æŒmapç±»å‹å£°æ˜\n  é”®ã€å€¼ç±»å‹å¯ä»¥æ˜¯å†…ç½®çš„ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„messageç±»å‹\n  å­—æ®µä¸æ”¯æŒrepeatedå±æ€§\nmap\u0026lt;key_type, value_type\u0026gt;map_filed = N; //æ”¯æŒå®šä¹‰çš„ç±»å‹  message Produce{ string name = \u0026#34;zcj\u0026#34;; } map\u0026lt;string, Product\u0026gt; pro = 1;proto3æ–‡ä»¶ç¼–è¯‘  é€šè¿‡å®šä¹‰å¥½çš„.protoæ–‡ä»¶ç”Ÿæˆçš„Javaï¼Œpythonï¼Œc/c++ï¼Œ GOç­‰è¯­è¨€çš„ä»£ç ï¼Œéœ€è¦å®‰è£…ç¼–è¯‘å™¨protoc å½“ä½¿ç”¨protocol buffer ç¼–è¯‘å™¨å…è®¸.protoæ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨ç”Ÿæˆæ‰€é€‰æ‹©è¯­è¨€çš„ä»£ç ï¼Œç”¨äºä½¿ç”¨åœ¨.protoæ–‡ä»¶ä¸­å®šä¹‰çš„æ¶ˆæ¯ç±»å‹ï¼ŒæœåŠ¡æ¥å£çº¦å®šç­‰ï¼Œä¸åŒçš„è¯­è¨€ç”Ÿæˆä»£ç æ ¼å¼ä¸åŒï¼š  c++:æ¯ä¸ª.protoæ–‡ä»¶ç”Ÿæˆä¸€ä¸ª.hå’Œä¸€ä¸ª.ccæ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ¶ˆæ¯ç±»å‹å¯¹åº”ä¸€ä¸ªç±» Javaï¼šç”Ÿæˆä¸€ä¸ª.Javaæ–‡ä»¶ï¼ŒåŒæ ·æ¯ä¸ªæ¶ˆæ¯å¯¹åº”ä¸€ä¸ªç±»ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„Builderç±»ç”¨äºåˆ›å»ºä¿¡æ¯æ¥å£ Goï¼šç”Ÿæˆä¸€ä¸ª.pb.goæ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ¶ˆæ¯ç±»å‹å¯¹åº”è¿™ä¸€ä¸ªç»“æ„ä½“ Python: å§¿åŠ¿ä¸å¤ªä¸€æ ·ï¼Œæ¯ä¸ª.protoæ–‡ä»¶ä¸­çš„æ¶ˆæ¯ç±»å‹ç”Ÿæˆä¸€ä¸ªå«æœ‰é™æ€æè¿°ç¬¦çš„æ¨¡å—ï¼Œè¯¥æ¨¡å—ä¸ä¸€ä¸ªå…ƒç±»metaclassåœ¨è¿è¡Œæ—¶åˆ›å»ºéœ€è¦çš„Pythonæ•°æ®è®¿é—®ç±»    importå¯¼å…¥å®šä¹‰  å¯ä»¥ä½¿ç”¨import æ¥å£è¯­å¥å¯¼å…¥ä½¿ç”¨å…¶ä»–æè¿°æ–‡ä»¶ä¸­çš„å£°æ˜çš„ç±»å‹ protobuf æ¥å£æ–‡ä»¶å¯ä»¥åƒCè¯­è¨€çš„#includeæˆ–è€…Javaçš„importçš„è¡Œä¸ºå¤§è‡´ä¸€è‡´ protocol bufferç¼–è¯‘å™¨ä¼šåœ¨-I /\u0026ndash;proto_pathå‚æ•°æŒ‡å®šçš„ç›®å½•ä¸­æŸ¥æ‰¾å¯¼å…¥çš„æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šè¯¥å‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰çš„ç›®å½•æŸ¥æ‰¾  åŒ…çš„ä½¿ç”¨   åœ¨protoæ–‡ä»¶ä¸­ä½¿ç”¨packageå£°æ˜åŒ…ï¼Œé¿å…å‘½åå†²çª\n  åœ¨å…¶ä»–çš„æ¶ˆæ¯æ ¼å¼å®šä¹‰ä¸­å¯ä»¥ä½¿ç”¨åŒ…å+æ¶ˆæ¯åçš„æ–¹å¼ä½¿ç”¨ç±»å‹\n  åœ¨ä¸åŒè¯­è¨€ä¸­ï¼ŒåŒ…å«å®šä¹‰å¯¹ç¼–è¯‘åç”Ÿæˆçš„ä»£ç å½±å“ä¸åŒï¼š\n C++ï¼šå¯¹åº”C++å‘½ä»¤ç©ºé—´ Java ä¸­ï¼špackageä¼šä½œä¸ºJavaåŒ…åï¼Œé™¤éæŒ‡å®šäº†option jave_packageé€‰é¡¹ Python ä¸­ï¼špackageè¢«å¿½ç•¥ Go ä¸­ï¼šé»˜è®¤ä½¿ç”¨packageåä½œä¸ºåŒ…åï¼Œé™¤éæŒ‡å®šäº†option go_packageé€‰é¡¹  æµ‹è¯• message æµ‹è¯•   proto æ–‡ä»¶å†…å®¹\nsyntax = \u0026#34;proto3\u0026#34;; // è¯­æ³•å£°æ˜ package main; // é»˜è®¤ä¸goæ–‡ä»¶ä¸­çš„åŒ…åä¸€è‡´ // option go_package = \u0026#34;zcj_proto\u0026#34;; // ä¸ä¸€è‡´æ—¶ï¼Œå¯ä»¥ä½¿ç”¨go_package // æµ‹è¯•message é‡‡ç”¨ä¸ºé©¼å³°çš„å‘½ä»¤æ–¹å¼  message TestMessage{ string te_name = 1; int32 te_age = 2; int32 te_count = 3; double te_money = 4; float te_score = 5; bool te_fat = 6; bytes te_char = 7; // æšä¸¾ç±»å‹  enum Status{ OK = 0; FAIL = 1; } message TeChild{ string ch_name = 1; string ch_sex = 2; } TeChild childs = 9; // mapç±»å‹  map\u0026lt;string, int32\u0026gt; te_map = 10; }  ç”Ÿæˆgo æ–‡ä»¶å†…å®¹\n// Code generated by protoc-gen-go. DO NOT EDIT. // source: proto3.proto  package test_message import ( fmt \u0026#34;fmt\u0026#34; proto \u0026#34;github.com/golang/protobuf/proto\u0026#34; math \u0026#34;math\u0026#34; ) // Reference imports to suppress errors if they are not otherwise used. var _ = proto.Marshal var _ = fmt.Errorf var _ = math.Inf // This is a compile-time assertion to ensure that this generated file // is compatible with the proto package it is being compiled against. // A compilation error at this line likely means your copy of the // proto package needs to be updated. const _ = proto.ProtoPackageIsVersion3 // please upgrade the proto package  // æšä¸¾ç±»å‹ type TestMessage_Status int32 const ( TestMessage_OK TestMessage_Status = 0 TestMessage_FAIL TestMessage_Status = 1 ) var TestMessage_Status_name = map[int32]string{ 0: \u0026#34;OK\u0026#34;, 1: \u0026#34;FAIL\u0026#34;, } var TestMessage_Status_value = map[string]int32{ \u0026#34;OK\u0026#34;: 0, \u0026#34;FAIL\u0026#34;: 1, } func (x TestMessage_Status) String() string { return proto.EnumName(TestMessage_Status_name, int32(x)) } func (TestMessage_Status) EnumDescriptor() ([]byte, []int) { return fileDescriptor_4fee6d65e34a64b6, []int{0, 0} } // æµ‹è¯•message é‡‡ç”¨ä¸ºé©¼å³°çš„å‘½ä»¤æ–¹å¼ type TestMessage struct { TeName string `protobuf:\u0026#34;bytes,1,opt,name=te_name,json=teName,proto3\u0026#34; json:\u0026#34;te_name,omitempty\u0026#34;` TeAge int32 `protobuf:\u0026#34;varint,2,opt,name=te_age,json=teAge,proto3\u0026#34; json:\u0026#34;te_age,omitempty\u0026#34;` TeCount int32 `protobuf:\u0026#34;varint,3,opt,name=te_count,json=teCount,proto3\u0026#34; json:\u0026#34;te_count,omitempty\u0026#34;` TeMoney float64 `protobuf:\u0026#34;fixed64,4,opt,name=te_money,json=teMoney,proto3\u0026#34; json:\u0026#34;te_money,omitempty\u0026#34;` TeScore float32 `protobuf:\u0026#34;fixed32,5,opt,name=te_score,json=teScore,proto3\u0026#34; json:\u0026#34;te_score,omitempty\u0026#34;` TeFat bool `protobuf:\u0026#34;varint,6,opt,name=te_fat,json=teFat,proto3\u0026#34; json:\u0026#34;te_fat,omitempty\u0026#34;` TeChar []byte `protobuf:\u0026#34;bytes,7,opt,name=te_char,json=teChar,proto3\u0026#34; json:\u0026#34;te_char,omitempty\u0026#34;` Childs *TestMessage_TeChild `protobuf:\u0026#34;bytes,9,opt,name=childs,proto3\u0026#34; json:\u0026#34;childs,omitempty\u0026#34;` // mapç±»å‹  TeMap map[string]int32 `protobuf:\u0026#34;bytes,10,rep,name=te_map,json=teMap,proto3\u0026#34; json:\u0026#34;te_map,omitempty\u0026#34; protobuf_key:\u0026#34;bytes,1,opt,name=key,proto3\u0026#34; protobuf_val:\u0026#34;varint,2,opt,name=value,proto3\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } func (m *TestMessage) Reset() { *m = TestMessage{} } func (m *TestMessage) String() string { return proto.CompactTextString(m) } func (*TestMessage) ProtoMessage() {} func (*TestMessage) Descriptor() ([]byte, []int) { return fileDescriptor_4fee6d65e34a64b6, []int{0} } func (m *TestMessage) XXX_Unmarshal(b []byte) error { return xxx_messageInfo_TestMessage.Unmarshal(m, b) } func (m *TestMessage) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) { return xxx_messageInfo_TestMessage.Marshal(b, m, deterministic) } func (m *TestMessage) XXX_Merge(src proto.Message) { xxx_messageInfo_TestMessage.Merge(m, src) } func (m *TestMessage) XXX_Size() int { return xxx_messageInfo_TestMessage.Size(m) } func (m *TestMessage) XXX_DiscardUnknown() { xxx_messageInfo_TestMessage.DiscardUnknown(m) } var xxx_messageInfo_TestMessage proto.InternalMessageInfo func (m *TestMessage) GetTeName() string { if m != nil { return m.TeName } return \u0026#34;\u0026#34; } func (m *TestMessage) GetTeAge() int32 { if m != nil { return m.TeAge } return 0 } func (m *TestMessage) GetTeCount() int32 { if m != nil { return m.TeCount } return 0 } func (m *TestMessage) GetTeMoney() float64 { if m != nil { return m.TeMoney } return 0 } func (m *TestMessage) GetTeScore() float32 { if m != nil { return m.TeScore } return 0 } func (m *TestMessage) GetTeFat() bool { if m != nil { return m.TeFat } return false } func (m *TestMessage) GetTeChar() []byte { if m != nil { return m.TeChar } return nil } func (m *TestMessage) GetChilds() *TestMessage_TeChild { if m != nil { return m.Childs } return nil } func (m *TestMessage) GetTeMap() map[string]int32 { if m != nil { return m.TeMap } return nil } type TestMessage_TeChild struct { ChName string `protobuf:\u0026#34;bytes,1,opt,name=ch_name,json=chName,proto3\u0026#34; json:\u0026#34;ch_name,omitempty\u0026#34;` ChSex string `protobuf:\u0026#34;bytes,2,opt,name=ch_sex,json=chSex,proto3\u0026#34; json:\u0026#34;ch_sex,omitempty\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } func (m *TestMessage_TeChild) Reset() { *m = TestMessage_TeChild{} } func (m *TestMessage_TeChild) String() string { return proto.CompactTextString(m) } func (*TestMessage_TeChild) ProtoMessage() {} func (*TestMessage_TeChild) Descriptor() ([]byte, []int) { return fileDescriptor_4fee6d65e34a64b6, []int{0, 0} } func (m *TestMessage_TeChild) XXX_Unmarshal(b []byte) error { return xxx_messageInfo_TestMessage_TeChild.Unmarshal(m, b) } func (m *TestMessage_TeChild) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) { return xxx_messageInfo_TestMessage_TeChild.Marshal(b, m, deterministic) } func (m *TestMessage_TeChild) XXX_Merge(src proto.Message) { xxx_messageInfo_TestMessage_TeChild.Merge(m, src) } func (m *TestMessage_TeChild) XXX_Size() int { return xxx_messageInfo_TestMessage_TeChild.Size(m) } func (m *TestMessage_TeChild) XXX_DiscardUnknown() { xxx_messageInfo_TestMessage_TeChild.DiscardUnknown(m) } var xxx_messageInfo_TestMessage_TeChild proto.InternalMessageInfo func (m *TestMessage_TeChild) GetChName() string { if m != nil { return m.ChName } return \u0026#34;\u0026#34; } func (m *TestMessage_TeChild) GetChSex() string { if m != nil { return m.ChSex } return \u0026#34;\u0026#34; } func init() { proto.RegisterEnum(\u0026#34;main.TestMessage_Status\u0026#34;, TestMessage_Status_name, TestMessage_Status_value) proto.RegisterType((*TestMessage)(nil), \u0026#34;main.TestMessage\u0026#34;) proto.RegisterMapType((map[string]int32)(nil), \u0026#34;main.TestMessage.TeMapEntry\u0026#34;) proto.RegisterType((*TestMessage_TeChild)(nil), \u0026#34;main.TestMessage.TeChild\u0026#34;) } func init() { proto.RegisterFile(\u0026#34;proto3.proto\u0026#34;, fileDescriptor_4fee6d65e34a64b6) } var fileDescriptor_4fee6d65e34a64b6 = []byte{ // 333 bytes of a gzipped FileDescriptorProto  0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xff, 0x6c, 0x51, 0x4d, 0x6f, 0xea, 0x30, 0x10, 0x7c, 0x4e, 0x48, 0x02, 0x0b, 0x07, 0x64, 0xbd, 0xa7, 0x67, 0x50, 0x0f, 0x16, 0x27, 0x9f, 0x22, 0x15, 0x2e, 0xb4, 0x37, 0x84, 0x8a, 0x54, 0xb5, 0x69, 0xa5, 0xc0, 0x3d, 0x72, 0xdd, 0x2d, 0x41, 0x25, 0x1f, 0x4a, 0x96, 0x0a, 0x7e, 0x59, 0xff, 0x5e, 0xe5, 0x34, 0xfd, 0x92, 0x7a, 0xb2, 0x47, 0xb3, 0xbb, 0x33, 0x3b, 0x0b, 0x83, 0xb2, 0x2a, 0xa8, 0x98, 0x85, 0xcd, 0xc3, 0x3b, 0x99, 0xde, 0xe5, 0x93, 0x57, 0x17, 0xfa, 0x1b, 0xac, 0x29, 0xc2, 0xba, 0xd6, 0x5b, 0xe4, 0xff, 0x21, 0x20, 0x4c, 0x72, 0x9d, 0xa1, 0x60, 0x92, 0xa9, 0x5e, 0xec, 0x13, 0xde, 0xe9, 0x0c, 0xf9, 0x3f, 0xf0, 0x09, 0x13, 0xbd, 0x45, 0xe1, 0x48, 0xa6, 0xbc, 0xd8, 0x23, 0x5c, 0x6c, 0x91, 0x8f, 0xa0, 0x4b, 0x98, 0x98, 0xe2, 0x90, 0x93, 0x70, 0x1b, 0x22, 0x20, 0x5c, 0x5a, 0xd8, 0x52, 0x59, 0x91, 0xe3, 0x49, 0x74, 0x24, 0x53, 0xcc, 0x52, 0x91, 0x85, 0x2d, 0x55, 0x9b, 0xa2, 0x42, 0xe1, 0x49, 0xa6, 0x1c, 0x4b, 0xad, 0x2d, 0x6c, 0x75, 0x9e, 0x34, 0x09, 0x5f, 0x32, 0xd5, 0xb5, 0x3a, 0x2b, 0x4d, 0xad, 0x2f, 0x93, 0xea, 0x4a, 0x04, 0x92, 0xa9, 0x81, 0xf5, 0xb5, 0x4c, 0x75, 0xc5, 0xcf, 0xc1, 0x37, 0xe9, 0x6e, 0xff, 0x58, 0x8b, 0x9e, 0x64, 0xaa, 0x3f, 0x1d, 0x85, 0x76, 0xaf, 0xf0, 0xdb, 0x4e, 0xe1, 0x06, 0x97, 0xb6, 0x22, 0x6e, 0x0b, 0xf9, 0xac, 0x91, 0xc8, 0x74, 0x29, 0x40, 0xba, 0xaa, 0x3f, 0x3d, 0xfb, 0xad, 0x25, 0xd2, 0xe5, 0x55, 0x4e, 0xd5, 0xc9, 0x1a, 0x88, 0x74, 0x39, 0xbe, 0x80, 0xa0, 0x9d, 0x63, 0xbd, 0x98, 0xf4, 0x47, 0x46, 0x26, 0xfd, 0xc8, 0xc8, 0xa4, 0x49, 0x8d, 0xc7, 0x26, 0xa3, 0x5e, 0xec, 0x99, 0x74, 0x8d, 0xc7, 0xf1, 0x1c, 0xe0, 0x6b, 0x1e, 0x1f, 0x82, 0xfb, 0x8c, 0xa7, 0xb6, 0xd3, 0x7e, 0xf9, 0x5f, 0xf0, 0x5e, 0xf4, 0xfe, 0xf0, 0x99, 0x6c, 0x03, 0x2e, 0x9d, 0x39, 0x9b, 0x8c, 0xc1, 0x5f, 0x93, 0xa6, 0x43, 0xcd, 0x7d, 0x70, 0xee, 0x6f, 0x86, 0x7f, 0x78, 0x17, 0x3a, 0xab, 0xc5, 0xf5, 0xed, 0x90, 0x3d, 0xf8, 0xef, 0xd7, 0x7c, 0x0b, 0x00, 0x00, 0xff, 0xff, 0x30, 0x6b, 0xfd, 0xd9, 0xd6, 0x01, 0x00, 0x00, }   ç”ŸæˆC++ æ–‡ä»¶å†…å®¹\n// Generated by the protocol buffer compiler. DO NOT EDIT!  // source: proto3.proto  #ifndef GOOGLE_PROTOBUF_INCLUDED_proto3_2eproto  #define GOOGLE_PROTOBUF_INCLUDED_proto3_2eproto  #include \u0026lt;limits\u0026gt; #include \u0026lt;string\u0026gt; #include \u0026lt;google/protobuf/port_def.inc\u0026gt; #if PROTOBUF_VERSION \u0026lt; 3021000  #error This file was generated by a newer version of protoc which is  #error incompatible with your Protocol Buffer headers. Please update  #error your headers.  #endif  #if 3021005 \u0026lt; PROTOBUF_MIN_PROTOC_VERSION  #error This file was generated by an older version of protoc which is  #error incompatible with your Protocol Buffer headers. Please  #error regenerate this file with a newer version of protoc.  #endif  #include \u0026lt;google/protobuf/port_undef.inc\u0026gt; #include \u0026lt;google/protobuf/io/coded_stream.h\u0026gt; #include \u0026lt;google/protobuf/arena.h\u0026gt; #include \u0026lt;google/protobuf/arenastring.h\u0026gt; #include \u0026lt;google/protobuf/generated_message_util.h\u0026gt; #include \u0026lt;google/protobuf/metadata_lite.h\u0026gt; #include \u0026lt;google/protobuf/generated_message_reflection.h\u0026gt; #include \u0026lt;google/protobuf/message.h\u0026gt; #include \u0026lt;google/protobuf/repeated_field.h\u0026gt; // IWYU pragma: export #include \u0026lt;google/protobuf/extension_set.h\u0026gt; // IWYU pragma: export #include \u0026lt;google/protobuf/map.h\u0026gt; // IWYU pragma: export #include \u0026lt;google/protobuf/map_entry.h\u0026gt; #include \u0026lt;google/protobuf/map_field_inl.h\u0026gt; #include \u0026lt;google/protobuf/generated_enum_reflection.h\u0026gt; #include \u0026lt;google/protobuf/unknown_field_set.h\u0026gt; // @@protoc_insertion_point(includes)  #include \u0026lt;google/protobuf/port_def.inc\u0026gt; #define PROTOBUF_INTERNAL_EXPORT_proto3_2eproto  PROTOBUF_NAMESPACE_OPEN namespace internal { class AnyMetadata; } // namespace internal  PROTOBUF_NAMESPACE_CLOSE // Internal implementation detail -- do not use these members.  struct TableStruct_proto3_2eproto { static const uint32_t offsets[]; }; extern const ::PROTOBUF_NAMESPACE_ID::internal::DescriptorTable descriptor_table_proto3_2eproto; namespace main { class TestMessage; struct TestMessageDefaultTypeInternal; extern TestMessageDefaultTypeInternal _TestMessage_default_instance_; class TestMessage_TeChild; struct TestMessage_TeChildDefaultTypeInternal; extern TestMessage_TeChildDefaultTypeInternal _TestMessage_TeChild_default_instance_; class TestMessage_TeMapEntry_DoNotUse; struct TestMessage_TeMapEntry_DoNotUseDefaultTypeInternal; extern TestMessage_TeMapEntry_DoNotUseDefaultTypeInternal _TestMessage_TeMapEntry_DoNotUse_default_instance_; } // namespace main  PROTOBUF_NAMESPACE_OPEN template\u0026lt;\u0026gt; ::main::TestMessage* Arena::CreateMaybeMessage\u0026lt;::main::TestMessage\u0026gt;(Arena*); template\u0026lt;\u0026gt; ::main::TestMessage_TeChild* Arena::CreateMaybeMessage\u0026lt;::main::TestMessage_TeChild\u0026gt;(Arena*); template\u0026lt;\u0026gt; ::main::TestMessage_TeMapEntry_DoNotUse* Arena::CreateMaybeMessage\u0026lt;::main::TestMessage_TeMapEntry_DoNotUse\u0026gt;(Arena*); PROTOBUF_NAMESPACE_CLOSE namespace main { enum TestMessage_Status : int { TestMessage_Status_OK = 0, TestMessage_Status_FAIL = 1, TestMessage_Status_TestMessage_Status_INT_MIN_SENTINEL_DO_NOT_USE_ = std::numeric_limits\u0026lt;int32_t\u0026gt;::min(), TestMessage_Status_TestMessage_Status_INT_MAX_SENTINEL_DO_NOT_USE_ = std::numeric_limits\u0026lt;int32_t\u0026gt;::max() }; bool TestMessage_Status_IsValid(int value); constexpr TestMessage_Status TestMessage_Status_Status_MIN = TestMessage_Status_OK; constexpr TestMessage_Status TestMessage_Status_Status_MAX = TestMessage_Status_FAIL; constexpr int TestMessage_Status_Status_ARRAYSIZE = TestMessage_Status_Status_MAX + 1; const ::PROTOBUF_NAMESPACE_ID::EnumDescriptor* TestMessage_Status_descriptor(); template\u0026lt;typename T\u0026gt; inline const std::string\u0026amp; TestMessage_Status_Name(T enum_t_value) { static_assert(::std::is_same\u0026lt;T, TestMessage_Status\u0026gt;::value || ::std::is_integral\u0026lt;T\u0026gt;::value, \u0026#34;Incorrect type passed to function TestMessage_Status_Name.\u0026#34;); return ::PROTOBUF_NAMESPACE_ID::internal::NameOfEnum( TestMessage_Status_descriptor(), enum_t_value); } inline bool TestMessage_Status_Parse( ::PROTOBUF_NAMESPACE_ID::ConstStringParam name, TestMessage_Status* value) { return ::PROTOBUF_NAMESPACE_ID::internal::ParseNamedEnum\u0026lt;TestMessage_Status\u0026gt;( TestMessage_Status_descriptor(), name, value); } // ===================================================================  class TestMessage_TeChild final : public ::PROTOBUF_NAMESPACE_ID::Message /* @@protoc_insertion_point(class_definition:main.TestMessage.TeChild) */ { public: inline TestMessage_TeChild() : TestMessage_TeChild(nullptr) {} ~TestMessage_TeChild() override; explicit PROTOBUF_CONSTEXPR TestMessage_TeChild(::PROTOBUF_NAMESPACE_ID::internal::ConstantInitialized); TestMessage_TeChild(const TestMessage_TeChild\u0026amp; from); TestMessage_TeChild(TestMessage_TeChild\u0026amp;\u0026amp; from) noexcept : TestMessage_TeChild() { *this = ::std::move(from); } inline TestMessage_TeChild\u0026amp; operator=(const TestMessage_TeChild\u0026amp; from) { CopyFrom(from); return *this; } inline TestMessage_TeChild\u0026amp; operator=(TestMessage_TeChild\u0026amp;\u0026amp; from) noexcept { if (this == \u0026amp;from) return *this; if (GetOwningArena() == from.GetOwningArena() #ifdef PROTOBUF_FORCE_COPY_IN_MOVE  \u0026amp;\u0026amp; GetOwningArena() != nullptr #endif // !PROTOBUF_FORCE_COPY_IN_MOVE  ) { InternalSwap(\u0026amp;from); } else { CopyFrom(from); } return *this; } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* descriptor() { return GetDescriptor(); } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* GetDescriptor() { return default_instance().GetMetadata().descriptor; } static const ::PROTOBUF_NAMESPACE_ID::Reflection* GetReflection() { return default_instance().GetMetadata().reflection; } static const TestMessage_TeChild\u0026amp; default_instance() { return *internal_default_instance(); } static inline const TestMessage_TeChild* internal_default_instance() { return reinterpret_cast\u0026lt;const TestMessage_TeChild*\u0026gt;( \u0026amp;_TestMessage_TeChild_default_instance_); } static constexpr int kIndexInFileMessages = 0; friend void swap(TestMessage_TeChild\u0026amp; a, TestMessage_TeChild\u0026amp; b) { a.Swap(\u0026amp;b); } inline void Swap(TestMessage_TeChild* other) { if (other == this) return; #ifdef PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() != nullptr \u0026amp;\u0026amp; GetOwningArena() == other-\u0026gt;GetOwningArena()) { #else // PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() == other-\u0026gt;GetOwningArena()) { #endif // !PROTOBUF_FORCE_COPY_IN_SWAP  InternalSwap(other); } else { ::PROTOBUF_NAMESPACE_ID::internal::GenericSwap(this, other); } } void UnsafeArenaSwap(TestMessage_TeChild* other) { if (other == this) return; GOOGLE_DCHECK(GetOwningArena() == other-\u0026gt;GetOwningArena()); InternalSwap(other); } // implements Message ----------------------------------------------  TestMessage_TeChild* New(::PROTOBUF_NAMESPACE_ID::Arena* arena = nullptr) const final { return CreateMaybeMessage\u0026lt;TestMessage_TeChild\u0026gt;(arena); } using ::PROTOBUF_NAMESPACE_ID::Message::CopyFrom; void CopyFrom(const TestMessage_TeChild\u0026amp; from); using ::PROTOBUF_NAMESPACE_ID::Message::MergeFrom; void MergeFrom( const TestMessage_TeChild\u0026amp; from) { TestMessage_TeChild::MergeImpl(*this, from); } private: static void MergeImpl(::PROTOBUF_NAMESPACE_ID::Message\u0026amp; to_msg, const ::PROTOBUF_NAMESPACE_ID::Message\u0026amp; from_msg); public: PROTOBUF_ATTRIBUTE_REINITIALIZES void Clear() final; bool IsInitialized() const final; size_t ByteSizeLong() const final; const char* _InternalParse(const char* ptr, ::PROTOBUF_NAMESPACE_ID::internal::ParseContext* ctx) final; uint8_t* _InternalSerialize( uint8_t* target, ::PROTOBUF_NAMESPACE_ID::io::EpsCopyOutputStream* stream) const final; int GetCachedSize() const final { return _impl_._cached_size_.Get(); } private: void SharedCtor(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned); void SharedDtor(); void SetCachedSize(int size) const final; void InternalSwap(TestMessage_TeChild* other); private: friend class ::PROTOBUF_NAMESPACE_ID::internal::AnyMetadata; static ::PROTOBUF_NAMESPACE_ID::StringPiece FullMessageName() { return \u0026#34;main.TestMessage.TeChild\u0026#34;; } protected: explicit TestMessage_TeChild(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned = false); public: static const ClassData _class_data_; const ::PROTOBUF_NAMESPACE_ID::Message::ClassData*GetClassData() const final; ::PROTOBUF_NAMESPACE_ID::Metadata GetMetadata() const final; // nested types ----------------------------------------------------  // accessors -------------------------------------------------------  enum : int { kChNameFieldNumber = 1, kChSexFieldNumber = 2, }; // string ch_name = 1;  void clear_ch_name(); const std::string\u0026amp; ch_name() const; template \u0026lt;typename ArgT0 = const std::string\u0026amp;, typename... ArgT\u0026gt; void set_ch_name(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args); std::string* mutable_ch_name(); PROTOBUF_NODISCARD std::string* release_ch_name(); void set_allocated_ch_name(std::string* ch_name); private: const std::string\u0026amp; _internal_ch_name() const; inline PROTOBUF_ALWAYS_INLINE void _internal_set_ch_name(const std::string\u0026amp; value); std::string* _internal_mutable_ch_name(); public: // string ch_sex = 2;  void clear_ch_sex(); const std::string\u0026amp; ch_sex() const; template \u0026lt;typename ArgT0 = const std::string\u0026amp;, typename... ArgT\u0026gt; void set_ch_sex(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args); std::string* mutable_ch_sex(); PROTOBUF_NODISCARD std::string* release_ch_sex(); void set_allocated_ch_sex(std::string* ch_sex); private: const std::string\u0026amp; _internal_ch_sex() const; inline PROTOBUF_ALWAYS_INLINE void _internal_set_ch_sex(const std::string\u0026amp; value); std::string* _internal_mutable_ch_sex(); public: // @@protoc_insertion_point(class_scope:main.TestMessage.TeChild)  private: class _Internal; template \u0026lt;typename T\u0026gt; friend class ::PROTOBUF_NAMESPACE_ID::Arena::InternalHelper; typedef void InternalArenaConstructable_; typedef void DestructorSkippable_; struct Impl_ { ::PROTOBUF_NAMESPACE_ID::internal::ArenaStringPtr ch_name_; ::PROTOBUF_NAMESPACE_ID::internal::ArenaStringPtr ch_sex_; mutable ::PROTOBUF_NAMESPACE_ID::internal::CachedSize _cached_size_; }; union { Impl_ _impl_; }; friend struct ::TableStruct_proto3_2eproto; }; // -------------------------------------------------------------------  class TestMessage_TeMapEntry_DoNotUse : public ::PROTOBUF_NAMESPACE_ID::internal::MapEntry\u0026lt;TestMessage_TeMapEntry_DoNotUse, std::string, int32_t, ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::TYPE_STRING, ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::TYPE_INT32\u0026gt; { public: typedef ::PROTOBUF_NAMESPACE_ID::internal::MapEntry\u0026lt;TestMessage_TeMapEntry_DoNotUse, std::string, int32_t, ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::TYPE_STRING, ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::TYPE_INT32\u0026gt; SuperType; TestMessage_TeMapEntry_DoNotUse(); explicit PROTOBUF_CONSTEXPR TestMessage_TeMapEntry_DoNotUse( ::PROTOBUF_NAMESPACE_ID::internal::ConstantInitialized); explicit TestMessage_TeMapEntry_DoNotUse(::PROTOBUF_NAMESPACE_ID::Arena* arena); void MergeFrom(const TestMessage_TeMapEntry_DoNotUse\u0026amp; other); static const TestMessage_TeMapEntry_DoNotUse* internal_default_instance() { return reinterpret_cast\u0026lt;const TestMessage_TeMapEntry_DoNotUse*\u0026gt;(\u0026amp;_TestMessage_TeMapEntry_DoNotUse_default_instance_); } static bool ValidateKey(std::string* s) { return ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::VerifyUtf8String(s-\u0026gt;data(), static_cast\u0026lt;int\u0026gt;(s-\u0026gt;size()), ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::PARSE, \u0026#34;main.TestMessage.TeMapEntry.key\u0026#34;); } static bool ValidateValue(void*) { return true; } using ::PROTOBUF_NAMESPACE_ID::Message::MergeFrom; ::PROTOBUF_NAMESPACE_ID::Metadata GetMetadata() const final; friend struct ::TableStruct_proto3_2eproto; }; // -------------------------------------------------------------------  class TestMessage final : public ::PROTOBUF_NAMESPACE_ID::Message /* @@protoc_insertion_point(class_definition:main.TestMessage) */ { public: inline TestMessage() : TestMessage(nullptr) {} ~TestMessage() override; explicit PROTOBUF_CONSTEXPR TestMessage(::PROTOBUF_NAMESPACE_ID::internal::ConstantInitialized); TestMessage(const TestMessage\u0026amp; from); TestMessage(TestMessage\u0026amp;\u0026amp; from) noexcept : TestMessage() { *this = ::std::move(from); } inline TestMessage\u0026amp; operator=(const TestMessage\u0026amp; from) { CopyFrom(from); return *this; } inline TestMessage\u0026amp; operator=(TestMessage\u0026amp;\u0026amp; from) noexcept { if (this == \u0026amp;from) return *this; if (GetOwningArena() == from.GetOwningArena() #ifdef PROTOBUF_FORCE_COPY_IN_MOVE  \u0026amp;\u0026amp; GetOwningArena() != nullptr #endif // !PROTOBUF_FORCE_COPY_IN_MOVE  ) { InternalSwap(\u0026amp;from); } else { CopyFrom(from); } return *this; } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* descriptor() { return GetDescriptor(); } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* GetDescriptor() { return default_instance().GetMetadata().descriptor; } static const ::PROTOBUF_NAMESPACE_ID::Reflection* GetReflection() { return default_instance().GetMetadata().reflection; } static const TestMessage\u0026amp; default_instance() { return *internal_default_instance(); } static inline const TestMessage* internal_default_instance() { return reinterpret_cast\u0026lt;const TestMessage*\u0026gt;( \u0026amp;_TestMessage_default_instance_); } static constexpr int kIndexInFileMessages = 2; friend void swap(TestMessage\u0026amp; a, TestMessage\u0026amp; b) { a.Swap(\u0026amp;b); } inline void Swap(TestMessage* other) { if (other == this) return; #ifdef PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() != nullptr \u0026amp;\u0026amp; GetOwningArena() == other-\u0026gt;GetOwningArena()) { #else // PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() == other-\u0026gt;GetOwningArena()) { #endif // !PROTOBUF_FORCE_COPY_IN_SWAP  InternalSwap(other); } else { ::PROTOBUF_NAMESPACE_ID::internal::GenericSwap(this, other); } } void UnsafeArenaSwap(TestMessage* other) { if (other == this) return; GOOGLE_DCHECK(GetOwningArena() == other-\u0026gt;GetOwningArena()); InternalSwap(other); } // implements Message ----------------------------------------------  TestMessage* New(::PROTOBUF_NAMESPACE_ID::Arena* arena = nullptr) const final { return CreateMaybeMessage\u0026lt;TestMessage\u0026gt;(arena); } using ::PROTOBUF_NAMESPACE_ID::Message::CopyFrom; void CopyFrom(const TestMessage\u0026amp; from); using ::PROTOBUF_NAMESPACE_ID::Message::MergeFrom; void MergeFrom( const TestMessage\u0026amp; from) { TestMessage::MergeImpl(*this, from); } private: static void MergeImpl(::PROTOBUF_NAMESPACE_ID::Message\u0026amp; to_msg, const ::PROTOBUF_NAMESPACE_ID::Message\u0026amp; from_msg); public: PROTOBUF_ATTRIBUTE_REINITIALIZES void Clear() final; bool IsInitialized() const final; size_t ByteSizeLong() const final; const char* _InternalParse(const char* ptr, ::PROTOBUF_NAMESPACE_ID::internal::ParseContext* ctx) final; uint8_t* _InternalSerialize( uint8_t* target, ::PROTOBUF_NAMESPACE_ID::io::EpsCopyOutputStream* stream) const final; int GetCachedSize() const final { return _impl_._cached_size_.Get(); } private: void SharedCtor(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned); void SharedDtor(); void SetCachedSize(int size) const final; void InternalSwap(TestMessage* other); private: friend class ::PROTOBUF_NAMESPACE_ID::internal::AnyMetadata; static ::PROTOBUF_NAMESPACE_ID::StringPiece FullMessageName() { return \u0026#34;main.TestMessage\u0026#34;; } protected: explicit TestMessage(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned = false); private: static void ArenaDtor(void* object); public: static const ClassData _class_data_; const ::PROTOBUF_NAMESPACE_ID::Message::ClassData*GetClassData() const final; ::PROTOBUF_NAMESPACE_ID::Metadata GetMetadata() const final; // nested types ----------------------------------------------------  typedef TestMessage_TeChild TeChild; typedef TestMessage_Status Status; static constexpr Status OK = TestMessage_Status_OK; static constexpr Status FAIL = TestMessage_Status_FAIL; static inline bool Status_IsValid(int value) { return TestMessage_Status_IsValid(value); } static constexpr Status Status_MIN = TestMessage_Status_Status_MIN; static constexpr Status Status_MAX = TestMessage_Status_Status_MAX; static constexpr int Status_ARRAYSIZE = TestMessage_Status_Status_ARRAYSIZE; static inline const ::PROTOBUF_NAMESPACE_ID::EnumDescriptor* Status_descriptor() { return TestMessage_Status_descriptor(); } template\u0026lt;typename T\u0026gt; static inline const std::string\u0026amp; Status_Name(T enum_t_value) { static_assert(::std::is_same\u0026lt;T, Status\u0026gt;::value || ::std::is_integral\u0026lt;T\u0026gt;::value, \u0026#34;Incorrect type passed to function Status_Name.\u0026#34;); return TestMessage_Status_Name(enum_t_value); } static inline bool Status_Parse(::PROTOBUF_NAMESPACE_ID::ConstStringParam name, Status* value) { return TestMessage_Status_Parse(name, value); } // accessors -------------------------------------------------------  enum : int { kTeMapFieldNumber = 10, kTeNameFieldNumber = 1, kTeCharFieldNumber = 7, kChildsFieldNumber = 9, kTeAgeFieldNumber = 2, kTeCountFieldNumber = 3, kTeMoneyFieldNumber = 4, kTeScoreFieldNumber = 5, kTeFatFieldNumber = 6, }; // map\u0026lt;string, int32\u0026gt; te_map = 10;  int te_map_size() const; private: int _internal_te_map_size() const; public: void clear_te_map(); private: const ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;\u0026amp; _internal_te_map() const; ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;* _internal_mutable_te_map(); public: const ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;\u0026amp; te_map() const; ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;* mutable_te_map(); // string te_name = 1;  void clear_te_name(); const std::string\u0026amp; te_name() const; template \u0026lt;typename ArgT0 = const std::string\u0026amp;, typename... ArgT\u0026gt; void set_te_name(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args); std::string* mutable_te_name(); PROTOBUF_NODISCARD std::string* release_te_name(); void set_allocated_te_name(std::string* te_name); private: const std::string\u0026amp; _internal_te_name() const; inline PROTOBUF_ALWAYS_INLINE void _internal_set_te_name(const std::string\u0026amp; value); std::string* _internal_mutable_te_name(); public: // bytes te_char = 7;  void clear_te_char(); const std::string\u0026amp; te_char() const; template \u0026lt;typename ArgT0 = const std::string\u0026amp;, typename... ArgT\u0026gt; void set_te_char(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args); std::string* mutable_te_char(); PROTOBUF_NODISCARD std::string* release_te_char(); void set_allocated_te_char(std::string* te_char); private: const std::string\u0026amp; _internal_te_char() const; inline PROTOBUF_ALWAYS_INLINE void _internal_set_te_char(const std::string\u0026amp; value); std::string* _internal_mutable_te_char(); public: // .main.TestMessage.TeChild childs = 9;  bool has_childs() const; private: bool _internal_has_childs() const; public: void clear_childs(); const ::main::TestMessage_TeChild\u0026amp; childs() const; PROTOBUF_NODISCARD ::main::TestMessage_TeChild* release_childs(); ::main::TestMessage_TeChild* mutable_childs(); void set_allocated_childs(::main::TestMessage_TeChild* childs); private: const ::main::TestMessage_TeChild\u0026amp; _internal_childs() const; ::main::TestMessage_TeChild* _internal_mutable_childs(); public: void unsafe_arena_set_allocated_childs( ::main::TestMessage_TeChild* childs); ::main::TestMessage_TeChild* unsafe_arena_release_childs(); // int32 te_age = 2;  void clear_te_age(); int32_t te_age() const; void set_te_age(int32_t value); private: int32_t _internal_te_age() const; void _internal_set_te_age(int32_t value); public: // int32 te_count = 3;  void clear_te_count(); int32_t te_count() const; void set_te_count(int32_t value); private: int32_t _internal_te_count() const; void _internal_set_te_count(int32_t value); public: // double te_money = 4;  void clear_te_money(); double te_money() const; void set_te_money(double value); private: double _internal_te_money() const; void _internal_set_te_money(double value); public: // float te_score = 5;  void clear_te_score(); float te_score() const; void set_te_score(float value); private: float _internal_te_score() const; void _internal_set_te_score(float value); public: // bool te_fat = 6;  void clear_te_fat(); bool te_fat() const; void set_te_fat(bool value); private: bool _internal_te_fat() const; void _internal_set_te_fat(bool value); public: // @@protoc_insertion_point(class_scope:main.TestMessage)  private: class _Internal; template \u0026lt;typename T\u0026gt; friend class ::PROTOBUF_NAMESPACE_ID::Arena::InternalHelper; typedef void InternalArenaConstructable_; typedef void DestructorSkippable_; struct Impl_ { ::PROTOBUF_NAMESPACE_ID::internal::MapField\u0026lt; TestMessage_TeMapEntry_DoNotUse, std::string, int32_t, ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::TYPE_STRING, ::PROTOBUF_NAMESPACE_ID::internal::WireFormatLite::TYPE_INT32\u0026gt; te_map_; ::PROTOBUF_NAMESPACE_ID::internal::ArenaStringPtr te_name_; ::PROTOBUF_NAMESPACE_ID::internal::ArenaStringPtr te_char_; ::main::TestMessage_TeChild* childs_; int32_t te_age_; int32_t te_count_; double te_money_; float te_score_; bool te_fat_; mutable ::PROTOBUF_NAMESPACE_ID::internal::CachedSize _cached_size_; }; union { Impl_ _impl_; }; friend struct ::TableStruct_proto3_2eproto; }; // ===================================================================  // ===================================================================  #ifdef __GNUC__  #pragma GCC diagnostic push  #pragma GCC diagnostic ignored \u0026#34;-Wstrict-aliasing\u0026#34;  #endif // __GNUC__  // TestMessage_TeChild  // string ch_name = 1;  inline void TestMessage_TeChild::clear_ch_name() { _impl_.ch_name_.ClearToEmpty(); } inline const std::string\u0026amp; TestMessage_TeChild::ch_name() const { // @@protoc_insertion_point(field_get:main.TestMessage.TeChild.ch_name)  return _internal_ch_name(); } template \u0026lt;typename ArgT0, typename... ArgT\u0026gt; inline PROTOBUF_ALWAYS_INLINE void TestMessage_TeChild::set_ch_name(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args) { _impl_.ch_name_.Set(static_cast\u0026lt;ArgT0 \u0026amp;\u0026amp;\u0026gt;(arg0), args..., GetArenaForAllocation()); // @@protoc_insertion_point(field_set:main.TestMessage.TeChild.ch_name)  } inline std::string* TestMessage_TeChild::mutable_ch_name() { std::string* _s = _internal_mutable_ch_name(); // @@protoc_insertion_point(field_mutable:main.TestMessage.TeChild.ch_name)  return _s; } inline const std::string\u0026amp; TestMessage_TeChild::_internal_ch_name() const { return _impl_.ch_name_.Get(); } inline void TestMessage_TeChild::_internal_set_ch_name(const std::string\u0026amp; value) { _impl_.ch_name_.Set(value, GetArenaForAllocation()); } inline std::string* TestMessage_TeChild::_internal_mutable_ch_name() { return _impl_.ch_name_.Mutable(GetArenaForAllocation()); } inline std::string* TestMessage_TeChild::release_ch_name() { // @@protoc_insertion_point(field_release:main.TestMessage.TeChild.ch_name)  return _impl_.ch_name_.Release(); } inline void TestMessage_TeChild::set_allocated_ch_name(std::string* ch_name) { if (ch_name != nullptr) { } else { } _impl_.ch_name_.SetAllocated(ch_name, GetArenaForAllocation()); #ifdef PROTOBUF_FORCE_COPY_DEFAULT_STRING  if (_impl_.ch_name_.IsDefault()) { _impl_.ch_name_.Set(\u0026#34;\u0026#34;, GetArenaForAllocation()); } #endif // PROTOBUF_FORCE_COPY_DEFAULT_STRING  // @@protoc_insertion_point(field_set_allocated:main.TestMessage.TeChild.ch_name)  } // string ch_sex = 2;  inline void TestMessage_TeChild::clear_ch_sex() { _impl_.ch_sex_.ClearToEmpty(); } inline const std::string\u0026amp; TestMessage_TeChild::ch_sex() const { // @@protoc_insertion_point(field_get:main.TestMessage.TeChild.ch_sex)  return _internal_ch_sex(); } template \u0026lt;typename ArgT0, typename... ArgT\u0026gt; inline PROTOBUF_ALWAYS_INLINE void TestMessage_TeChild::set_ch_sex(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args) { _impl_.ch_sex_.Set(static_cast\u0026lt;ArgT0 \u0026amp;\u0026amp;\u0026gt;(arg0), args..., GetArenaForAllocation()); // @@protoc_insertion_point(field_set:main.TestMessage.TeChild.ch_sex)  } inline std::string* TestMessage_TeChild::mutable_ch_sex() { std::string* _s = _internal_mutable_ch_sex(); // @@protoc_insertion_point(field_mutable:main.TestMessage.TeChild.ch_sex)  return _s; } inline const std::string\u0026amp; TestMessage_TeChild::_internal_ch_sex() const { return _impl_.ch_sex_.Get(); } inline void TestMessage_TeChild::_internal_set_ch_sex(const std::string\u0026amp; value) { _impl_.ch_sex_.Set(value, GetArenaForAllocation()); } inline std::string* TestMessage_TeChild::_internal_mutable_ch_sex() { return _impl_.ch_sex_.Mutable(GetArenaForAllocation()); } inline std::string* TestMessage_TeChild::release_ch_sex() { // @@protoc_insertion_point(field_release:main.TestMessage.TeChild.ch_sex)  return _impl_.ch_sex_.Release(); } inline void TestMessage_TeChild::set_allocated_ch_sex(std::string* ch_sex) { if (ch_sex != nullptr) { } else { } _impl_.ch_sex_.SetAllocated(ch_sex, GetArenaForAllocation()); #ifdef PROTOBUF_FORCE_COPY_DEFAULT_STRING  if (_impl_.ch_sex_.IsDefault()) { _impl_.ch_sex_.Set(\u0026#34;\u0026#34;, GetArenaForAllocation()); } #endif // PROTOBUF_FORCE_COPY_DEFAULT_STRING  // @@protoc_insertion_point(field_set_allocated:main.TestMessage.TeChild.ch_sex)  } // -------------------------------------------------------------------  // -------------------------------------------------------------------  // TestMessage  // string te_name = 1;  inline void TestMessage::clear_te_name() { _impl_.te_name_.ClearToEmpty(); } inline const std::string\u0026amp; TestMessage::te_name() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_name)  return _internal_te_name(); } template \u0026lt;typename ArgT0, typename... ArgT\u0026gt; inline PROTOBUF_ALWAYS_INLINE void TestMessage::set_te_name(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args) { _impl_.te_name_.Set(static_cast\u0026lt;ArgT0 \u0026amp;\u0026amp;\u0026gt;(arg0), args..., GetArenaForAllocation()); // @@protoc_insertion_point(field_set:main.TestMessage.te_name)  } inline std::string* TestMessage::mutable_te_name() { std::string* _s = _internal_mutable_te_name(); // @@protoc_insertion_point(field_mutable:main.TestMessage.te_name)  return _s; } inline const std::string\u0026amp; TestMessage::_internal_te_name() const { return _impl_.te_name_.Get(); } inline void TestMessage::_internal_set_te_name(const std::string\u0026amp; value) { _impl_.te_name_.Set(value, GetArenaForAllocation()); } inline std::string* TestMessage::_internal_mutable_te_name() { return _impl_.te_name_.Mutable(GetArenaForAllocation()); } inline std::string* TestMessage::release_te_name() { // @@protoc_insertion_point(field_release:main.TestMessage.te_name)  return _impl_.te_name_.Release(); } inline void TestMessage::set_allocated_te_name(std::string* te_name) { if (te_name != nullptr) { } else { } _impl_.te_name_.SetAllocated(te_name, GetArenaForAllocation()); #ifdef PROTOBUF_FORCE_COPY_DEFAULT_STRING  if (_impl_.te_name_.IsDefault()) { _impl_.te_name_.Set(\u0026#34;\u0026#34;, GetArenaForAllocation()); } #endif // PROTOBUF_FORCE_COPY_DEFAULT_STRING  // @@protoc_insertion_point(field_set_allocated:main.TestMessage.te_name)  } // int32 te_age = 2;  inline void TestMessage::clear_te_age() { _impl_.te_age_ = 0; } inline int32_t TestMessage::_internal_te_age() const { return _impl_.te_age_; } inline int32_t TestMessage::te_age() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_age)  return _internal_te_age(); } inline void TestMessage::_internal_set_te_age(int32_t value) { _impl_.te_age_ = value; } inline void TestMessage::set_te_age(int32_t value) { _internal_set_te_age(value); // @@protoc_insertion_point(field_set:main.TestMessage.te_age)  } // int32 te_count = 3;  inline void TestMessage::clear_te_count() { _impl_.te_count_ = 0; } inline int32_t TestMessage::_internal_te_count() const { return _impl_.te_count_; } inline int32_t TestMessage::te_count() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_count)  return _internal_te_count(); } inline void TestMessage::_internal_set_te_count(int32_t value) { _impl_.te_count_ = value; } inline void TestMessage::set_te_count(int32_t value) { _internal_set_te_count(value); // @@protoc_insertion_point(field_set:main.TestMessage.te_count)  } // double te_money = 4;  inline void TestMessage::clear_te_money() { _impl_.te_money_ = 0; } inline double TestMessage::_internal_te_money() const { return _impl_.te_money_; } inline double TestMessage::te_money() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_money)  return _internal_te_money(); } inline void TestMessage::_internal_set_te_money(double value) { _impl_.te_money_ = value; } inline void TestMessage::set_te_money(double value) { _internal_set_te_money(value); // @@protoc_insertion_point(field_set:main.TestMessage.te_money)  } // float te_score = 5;  inline void TestMessage::clear_te_score() { _impl_.te_score_ = 0; } inline float TestMessage::_internal_te_score() const { return _impl_.te_score_; } inline float TestMessage::te_score() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_score)  return _internal_te_score(); } inline void TestMessage::_internal_set_te_score(float value) { _impl_.te_score_ = value; } inline void TestMessage::set_te_score(float value) { _internal_set_te_score(value); // @@protoc_insertion_point(field_set:main.TestMessage.te_score)  } // bool te_fat = 6;  inline void TestMessage::clear_te_fat() { _impl_.te_fat_ = false; } inline bool TestMessage::_internal_te_fat() const { return _impl_.te_fat_; } inline bool TestMessage::te_fat() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_fat)  return _internal_te_fat(); } inline void TestMessage::_internal_set_te_fat(bool value) { _impl_.te_fat_ = value; } inline void TestMessage::set_te_fat(bool value) { _internal_set_te_fat(value); // @@protoc_insertion_point(field_set:main.TestMessage.te_fat)  } // bytes te_char = 7;  inline void TestMessage::clear_te_char() { _impl_.te_char_.ClearToEmpty(); } inline const std::string\u0026amp; TestMessage::te_char() const { // @@protoc_insertion_point(field_get:main.TestMessage.te_char)  return _internal_te_char(); } template \u0026lt;typename ArgT0, typename... ArgT\u0026gt; inline PROTOBUF_ALWAYS_INLINE void TestMessage::set_te_char(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args) { _impl_.te_char_.SetBytes(static_cast\u0026lt;ArgT0 \u0026amp;\u0026amp;\u0026gt;(arg0), args..., GetArenaForAllocation()); // @@protoc_insertion_point(field_set:main.TestMessage.te_char)  } inline std::string* TestMessage::mutable_te_char() { std::string* _s = _internal_mutable_te_char(); // @@protoc_insertion_point(field_mutable:main.TestMessage.te_char)  return _s; } inline const std::string\u0026amp; TestMessage::_internal_te_char() const { return _impl_.te_char_.Get(); } inline void TestMessage::_internal_set_te_char(const std::string\u0026amp; value) { _impl_.te_char_.Set(value, GetArenaForAllocation()); } inline std::string* TestMessage::_internal_mutable_te_char() { return _impl_.te_char_.Mutable(GetArenaForAllocation()); } inline std::string* TestMessage::release_te_char() { // @@protoc_insertion_point(field_release:main.TestMessage.te_char)  return _impl_.te_char_.Release(); } inline void TestMessage::set_allocated_te_char(std::string* te_char) { if (te_char != nullptr) { } else { } _impl_.te_char_.SetAllocated(te_char, GetArenaForAllocation()); #ifdef PROTOBUF_FORCE_COPY_DEFAULT_STRING  if (_impl_.te_char_.IsDefault()) { _impl_.te_char_.Set(\u0026#34;\u0026#34;, GetArenaForAllocation()); } #endif // PROTOBUF_FORCE_COPY_DEFAULT_STRING  // @@protoc_insertion_point(field_set_allocated:main.TestMessage.te_char)  } // .main.TestMessage.TeChild childs = 9;  inline bool TestMessage::_internal_has_childs() const { return this != internal_default_instance() \u0026amp;\u0026amp; _impl_.childs_ != nullptr; } inline bool TestMessage::has_childs() const { return _internal_has_childs(); } inline void TestMessage::clear_childs() { if (GetArenaForAllocation() == nullptr \u0026amp;\u0026amp; _impl_.childs_ != nullptr) { delete _impl_.childs_; } _impl_.childs_ = nullptr; } inline const ::main::TestMessage_TeChild\u0026amp; TestMessage::_internal_childs() const { const ::main::TestMessage_TeChild* p = _impl_.childs_; return p != nullptr ? *p : reinterpret_cast\u0026lt;const ::main::TestMessage_TeChild\u0026amp;\u0026gt;( ::main::_TestMessage_TeChild_default_instance_); } inline const ::main::TestMessage_TeChild\u0026amp; TestMessage::childs() const { // @@protoc_insertion_point(field_get:main.TestMessage.childs)  return _internal_childs(); } inline void TestMessage::unsafe_arena_set_allocated_childs( ::main::TestMessage_TeChild* childs) { if (GetArenaForAllocation() == nullptr) { delete reinterpret_cast\u0026lt;::PROTOBUF_NAMESPACE_ID::MessageLite*\u0026gt;(_impl_.childs_); } _impl_.childs_ = childs; if (childs) { } else { } // @@protoc_insertion_point(field_unsafe_arena_set_allocated:main.TestMessage.childs)  } inline ::main::TestMessage_TeChild* TestMessage::release_childs() { ::main::TestMessage_TeChild* temp = _impl_.childs_; _impl_.childs_ = nullptr; #ifdef PROTOBUF_FORCE_COPY_IN_RELEASE  auto* old = reinterpret_cast\u0026lt;::PROTOBUF_NAMESPACE_ID::MessageLite*\u0026gt;(temp); temp = ::PROTOBUF_NAMESPACE_ID::internal::DuplicateIfNonNull(temp); if (GetArenaForAllocation() == nullptr) { delete old; } #else // PROTOBUF_FORCE_COPY_IN_RELEASE  if (GetArenaForAllocation() != nullptr) { temp = ::PROTOBUF_NAMESPACE_ID::internal::DuplicateIfNonNull(temp); } #endif // !PROTOBUF_FORCE_COPY_IN_RELEASE  return temp; } inline ::main::TestMessage_TeChild* TestMessage::unsafe_arena_release_childs() { // @@protoc_insertion_point(field_release:main.TestMessage.childs)  ::main::TestMessage_TeChild* temp = _impl_.childs_; _impl_.childs_ = nullptr; return temp; } inline ::main::TestMessage_TeChild* TestMessage::_internal_mutable_childs() { if (_impl_.childs_ == nullptr) { auto* p = CreateMaybeMessage\u0026lt;::main::TestMessage_TeChild\u0026gt;(GetArenaForAllocation()); _impl_.childs_ = p; } return _impl_.childs_; } inline ::main::TestMessage_TeChild* TestMessage::mutable_childs() { ::main::TestMessage_TeChild* _msg = _internal_mutable_childs(); // @@protoc_insertion_point(field_mutable:main.TestMessage.childs)  return _msg; } inline void TestMessage::set_allocated_childs(::main::TestMessage_TeChild* childs) { ::PROTOBUF_NAMESPACE_ID::Arena* message_arena = GetArenaForAllocation(); if (message_arena == nullptr) { delete _impl_.childs_; } if (childs) { ::PROTOBUF_NAMESPACE_ID::Arena* submessage_arena = ::PROTOBUF_NAMESPACE_ID::Arena::InternalGetOwningArena(childs); if (message_arena != submessage_arena) { childs = ::PROTOBUF_NAMESPACE_ID::internal::GetOwnedMessage( message_arena, childs, submessage_arena); } } else { } _impl_.childs_ = childs; // @@protoc_insertion_point(field_set_allocated:main.TestMessage.childs)  } // map\u0026lt;string, int32\u0026gt; te_map = 10;  inline int TestMessage::_internal_te_map_size() const { return _impl_.te_map_.size(); } inline int TestMessage::te_map_size() const { return _internal_te_map_size(); } inline void TestMessage::clear_te_map() { _impl_.te_map_.Clear(); } inline const ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;\u0026amp; TestMessage::_internal_te_map() const { return _impl_.te_map_.GetMap(); } inline const ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;\u0026amp; TestMessage::te_map() const { // @@protoc_insertion_point(field_map:main.TestMessage.te_map)  return _internal_te_map(); } inline ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;* TestMessage::_internal_mutable_te_map() { return _impl_.te_map_.MutableMap(); } inline ::PROTOBUF_NAMESPACE_ID::Map\u0026lt; std::string, int32_t \u0026gt;* TestMessage::mutable_te_map() { // @@protoc_insertion_point(field_mutable_map:main.TestMessage.te_map)  return _internal_mutable_te_map(); } #ifdef __GNUC__  #pragma GCC diagnostic pop  #endif // __GNUC__  // -------------------------------------------------------------------  // -------------------------------------------------------------------  // @@protoc_insertion_point(namespace_scope)  } // namespace main  PROTOBUF_NAMESPACE_OPEN template \u0026lt;\u0026gt; struct is_proto_enum\u0026lt; ::main::TestMessage_Status\u0026gt; : ::std::true_type {}; template \u0026lt;\u0026gt; inline const EnumDescriptor* GetEnumDescriptor\u0026lt; ::main::TestMessage_Status\u0026gt;() { return ::main::TestMessage_Status_descriptor(); } PROTOBUF_NAMESPACE_CLOSE // @@protoc_insertion_point(global_scope)  #include \u0026lt;google/protobuf/port_undef.inc\u0026gt; #endif // GOOGLE_PROTOBUF_INCLUDED_GOOGLE_PROTOBUF_INCLUDED_proto3_2eproto   ç”Ÿæˆpython æ–‡ä»¶å†…å®¹\n# -*- coding: utf-8 -*- # Generated by the protocol buffer compiler. DO NOT EDIT! # source: proto3.proto \u0026#34;\u0026#34;\u0026#34;Generated protocol buffer code.\u0026#34;\u0026#34;\u0026#34; from google.protobuf.internal import builder as _builder from google.protobuf import descriptor as _descriptor from google.protobuf import descriptor_pool as _descriptor_pool from google.protobuf import symbol_database as _symbol_database # @@protoc_insertion_point(imports) _sym_db = _symbol_database.Default() DESCRIPTOR = _descriptor_pool.Default().AddSerializedFile(b\u0026#39;\\n\\x0cproto3.proto\\x12\\x04main\\\u0026#34;\\xd4\\x02\\n\\x0bTestMessage\\x12\\x0f\\n\\x07te_name\\x18\\x01\\x01(\\t\\x12\\x0e\\n\\x06te_age\\x18\\x02\\x01(\\x05\\x12\\x10\\n\\x08te_count\\x18\\x03\\x01(\\x05\\x12\\x10\\n\\x08te_money\\x18\\x04\\x01(\\x01\\x12\\x10\\n\\x08te_score\\x18\\x05\\x01(\\x02\\x12\\x0e\\n\\x06te_fat\\x18\\x06\\x01(\\x08\\x12\\x0f\\n\\x07te_char\\x18\\x07\\x01(\\x0c\\x12)\\n\\x06\\x63hilds\\x18\\t\\x01(\\x0b\\x32\\x19.main.TestMessage.TeChild\\x12,\\n\\x06te_map\\x18\\n\\x03(\\x0b\\x32\\x1c.main.TestMessage.TeMapEntry\\x1a*\\n\\x07TeChild\\x12\\x0f\\n\\x07\\x63h_name\\x18\\x01\\x01(\\t\\x12\\x0e\\n\\x06\\x63h_sex\\x18\\x02\\x01(\\t\\x1a,\\n\\nTeMapEntry\\x12\\x0b\\n\\x03key\\x18\\x01\\x01(\\t\\x12\\r\\n\\x05value\\x18\\x02\\x01(\\x05:\\x02\\x38\\x01\\\u0026#34;\\x1a\\n\\x06Status\\x12\\x06\\n\\x02OK\\x10\\x00\\x12\\x08\\n\\x04\\x46\\x41IL\\x10\\x01\\x62\\x06proto3\u0026#39;) _builder.BuildMessageAndEnumDescriptors(DESCRIPTOR, globals()) _builder.BuildTopDescriptorsAndMessages(DESCRIPTOR, \u0026#39;proto3_pb2\u0026#39;, globals()) if _descriptor._USE_C_DESCRIPTORS == False: DESCRIPTOR._options = None _TESTMESSAGE_TEMAPENTRY._options = None _TESTMESSAGE_TEMAPENTRY._serialized_options = b\u0026#39;8\\001\u0026#39; _TESTMESSAGE._serialized_start=23 _TESTMESSAGE._serialized_end=363 _TESTMESSAGE_TECHILD._serialized_start=247 _TESTMESSAGE_TECHILD._serialized_end=289 _TESTMESSAGE_TEMAPENTRY._serialized_start=291 _TESTMESSAGE_TEMAPENTRY._serialized_end=335 _TESTMESSAGE_STATUS._serialized_start=337 _TESTMESSAGE_STATUS._serialized_end=363 # @@protoc_insertion_point(module_scope)   service æµ‹è¯•   proto æ–‡ä»¶å†…å®¹\nsyntax = \u0026#34;proto3\u0026#34;; // è¯­æ³•å£°æ˜  package main; // åŒ…å£°æ˜  service TestService{ // æµ‹è¯•æ–¹æ³•  rpc TestServer(Request) returns (Response){} } // request è¯·æ±‚ç»“æ„ä½“  message Request{ string te_name = 1; } // response å“åº”ç»“æ„ä½“  message Response{ string message = 1; }  ç”Ÿæˆgo æ–‡ä»¶å†…å®¹\n// Code generated by protoc-gen-go. DO NOT EDIT.  // source: service.proto  package main import ( fmt \u0026#34;fmt\u0026#34; proto \u0026#34;github.com/golang/protobuf/proto\u0026#34; math \u0026#34;math\u0026#34; ) // Reference imports to suppress errors if they are not otherwise used.  var _ = proto.Marshal var _ = fmt.Errorf var _ = math.Inf // This is a compile-time assertion to ensure that this generated file  // is compatible with the proto package it is being compiled against.  // A compilation error at this line likely means your copy of the  // proto package needs to be updated.  const _ = proto.ProtoPackageIsVersion3 // please upgrade the proto package  // request è¯·æ±‚ç»“æ„ä½“  type Request struct { TeName string `protobuf:\u0026#34;bytes,1,opt,name=te_name,json=teName,proto3\u0026#34; json:\u0026#34;te_name,omitempty\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } func (m *Request) Reset() { *m = Request{} } func (m *Request) String() string { return proto.CompactTextString(m) } func (*Request) ProtoMessage() {} func (*Request) Descriptor() ([]byte, []int) { return fileDescriptor_a0b84a42fa06f626, []int{0} } func (m *Request) XXX_Unmarshal(b []byte) error { return xxx_messageInfo_Request.Unmarshal(m, b) } func (m *Request) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) { return xxx_messageInfo_Request.Marshal(b, m, deterministic) } func (m *Request) XXX_Merge(src proto.Message) { xxx_messageInfo_Request.Merge(m, src) } func (m *Request) XXX_Size() int { return xxx_messageInfo_Request.Size(m) } func (m *Request) XXX_DiscardUnknown() { xxx_messageInfo_Request.DiscardUnknown(m) } var xxx_messageInfo_Request proto.InternalMessageInfo func (m *Request) GetTeName() string { if m != nil { return m.TeName } return \u0026#34;\u0026#34; } // response å“åº”ç»“æ„ä½“  type Response struct { Message string `protobuf:\u0026#34;bytes,1,opt,name=message,proto3\u0026#34; json:\u0026#34;message,omitempty\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } func (m *Response) Reset() { *m = Response{} } func (m *Response) String() string { return proto.CompactTextString(m) } func (*Response) ProtoMessage() {} func (*Response) Descriptor() ([]byte, []int) { return fileDescriptor_a0b84a42fa06f626, []int{1} } func (m *Response) XXX_Unmarshal(b []byte) error { return xxx_messageInfo_Response.Unmarshal(m, b) } func (m *Response) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) { return xxx_messageInfo_Response.Marshal(b, m, deterministic) } func (m *Response) XXX_Merge(src proto.Message) { xxx_messageInfo_Response.Merge(m, src) } func (m *Response) XXX_Size() int { return xxx_messageInfo_Response.Size(m) } func (m *Response) XXX_DiscardUnknown() { xxx_messageInfo_Response.DiscardUnknown(m) } var xxx_messageInfo_Response proto.InternalMessageInfo func (m *Response) GetMessage() string { if m != nil { return m.Message } return \u0026#34;\u0026#34; } func init() { proto.RegisterType((*Request)(nil), \u0026#34;main.Request\u0026#34;) proto.RegisterType((*Response)(nil), \u0026#34;main.Response\u0026#34;) } func init() { proto.RegisterFile(\u0026#34;service.proto\u0026#34;, fileDescriptor_a0b84a42fa06f626) } var fileDescriptor_a0b84a42fa06f626 = []byte{ // 147 bytes of a gzipped FileDescriptorProto  0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xff, 0xe2, 0xe2, 0x2d, 0x4e, 0x2d, 0x2a, 0xcb, 0x4c, 0x4e, 0xd5, 0x2b, 0x28, 0xca, 0x2f, 0xc9, 0x17, 0x62, 0xc9, 0x4d, 0xcc, 0xcc, 0x53, 0x52, 0xe2, 0x62, 0x0f, 0x4a, 0x2d, 0x2c, 0x4d, 0x2d, 0x2e, 0x11, 0x12, 0xe7, 0x62, 0x2f, 0x49, 0x8d, 0xcf, 0x4b, 0xcc, 0x4d, 0x95, 0x60, 0x54, 0x60, 0xd4, 0xe0, 0x0c, 0x62, 0x2b, 0x49, 0xf5, 0x4b, 0xcc, 0x4d, 0x55, 0x52, 0xe1, 0xe2, 0x08, 0x4a, 0x2d, 0x2e, 0xc8, 0xcf, 0x2b, 0x4e, 0x15, 0x92, 0xe0, 0x62, 0xcf, 0x4d, 0x2d, 0x2e, 0x4e, 0x4c, 0x87, 0x29, 0x82, 0x71, 0x8d, 0x6c, 0xb8, 0xb8, 0x43, 0x52, 0x8b, 0x4b, 0x82, 0x21, 0x96, 0x08, 0xe9, 0x72, 0x71, 0xc1, 0xb8, 0xa9, 0x45, 0x42, 0xbc, 0x7a, 0x20, 0xdb, 0xf4, 0xa0, 0x56, 0x49, 0xf1, 0xc1, 0xb8, 0x10, 0x53, 0x95, 0x18, 0x92, 0xd8, 0xc0, 0x8e, 0x32, 0x06, 0x04, 0x00, 0x00, 0xff, 0xff, 0xc6, 0x10, 0x76, 0x3d, 0xa5, 0x00, 0x00, 0x00, }   ç”ŸæˆC++ æ–‡ä»¶å†…å®¹\n// Generated by the protocol buffer compiler. DO NOT EDIT!  // source: service.proto  #ifndef GOOGLE_PROTOBUF_INCLUDED_service_2eproto  #define GOOGLE_PROTOBUF_INCLUDED_service_2eproto  #include \u0026lt;limits\u0026gt; #include \u0026lt;string\u0026gt; #include \u0026lt;google/protobuf/port_def.inc\u0026gt; #if PROTOBUF_VERSION \u0026lt; 3021000  #error This file was generated by a newer version of protoc which is  #error incompatible with your Protocol Buffer headers. Please update  #error your headers.  #endif  #if 3021005 \u0026lt; PROTOBUF_MIN_PROTOC_VERSION  #error This file was generated by an older version of protoc which is  #error incompatible with your Protocol Buffer headers. Please  #error regenerate this file with a newer version of protoc.  #endif  #include \u0026lt;google/protobuf/port_undef.inc\u0026gt; #include \u0026lt;google/protobuf/io/coded_stream.h\u0026gt; #include \u0026lt;google/protobuf/arena.h\u0026gt; #include \u0026lt;google/protobuf/arenastring.h\u0026gt; #include \u0026lt;google/protobuf/generated_message_util.h\u0026gt; #include \u0026lt;google/protobuf/metadata_lite.h\u0026gt; #include \u0026lt;google/protobuf/generated_message_reflection.h\u0026gt; #include \u0026lt;google/protobuf/message.h\u0026gt; #include \u0026lt;google/protobuf/repeated_field.h\u0026gt; // IWYU pragma: export #include \u0026lt;google/protobuf/extension_set.h\u0026gt; // IWYU pragma: export #include \u0026lt;google/protobuf/unknown_field_set.h\u0026gt; // @@protoc_insertion_point(includes)  #include \u0026lt;google/protobuf/port_def.inc\u0026gt; #define PROTOBUF_INTERNAL_EXPORT_service_2eproto  PROTOBUF_NAMESPACE_OPEN namespace internal { class AnyMetadata; } // namespace internal  PROTOBUF_NAMESPACE_CLOSE // Internal implementation detail -- do not use these members.  struct TableStruct_service_2eproto { static const uint32_t offsets[]; }; extern const ::PROTOBUF_NAMESPACE_ID::internal::DescriptorTable descriptor_table_service_2eproto; namespace main { class Request; struct RequestDefaultTypeInternal; extern RequestDefaultTypeInternal _Request_default_instance_; class Response; struct ResponseDefaultTypeInternal; extern ResponseDefaultTypeInternal _Response_default_instance_; } // namespace main  PROTOBUF_NAMESPACE_OPEN template\u0026lt;\u0026gt; ::main::Request* Arena::CreateMaybeMessage\u0026lt;::main::Request\u0026gt;(Arena*); template\u0026lt;\u0026gt; ::main::Response* Arena::CreateMaybeMessage\u0026lt;::main::Response\u0026gt;(Arena*); PROTOBUF_NAMESPACE_CLOSE namespace main { // ===================================================================  class Request final : public ::PROTOBUF_NAMESPACE_ID::Message /* @@protoc_insertion_point(class_definition:main.Request) */ { public: inline Request() : Request(nullptr) {} ~Request() override; explicit PROTOBUF_CONSTEXPR Request(::PROTOBUF_NAMESPACE_ID::internal::ConstantInitialized); Request(const Request\u0026amp; from); Request(Request\u0026amp;\u0026amp; from) noexcept : Request() { *this = ::std::move(from); } inline Request\u0026amp; operator=(const Request\u0026amp; from) { CopyFrom(from); return *this; } inline Request\u0026amp; operator=(Request\u0026amp;\u0026amp; from) noexcept { if (this == \u0026amp;from) return *this; if (GetOwningArena() == from.GetOwningArena() #ifdef PROTOBUF_FORCE_COPY_IN_MOVE  \u0026amp;\u0026amp; GetOwningArena() != nullptr #endif // !PROTOBUF_FORCE_COPY_IN_MOVE  ) { InternalSwap(\u0026amp;from); } else { CopyFrom(from); } return *this; } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* descriptor() { return GetDescriptor(); } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* GetDescriptor() { return default_instance().GetMetadata().descriptor; } static const ::PROTOBUF_NAMESPACE_ID::Reflection* GetReflection() { return default_instance().GetMetadata().reflection; } static const Request\u0026amp; default_instance() { return *internal_default_instance(); } static inline const Request* internal_default_instance() { return reinterpret_cast\u0026lt;const Request*\u0026gt;( \u0026amp;_Request_default_instance_); } static constexpr int kIndexInFileMessages = 0; friend void swap(Request\u0026amp; a, Request\u0026amp; b) { a.Swap(\u0026amp;b); } inline void Swap(Request* other) { if (other == this) return; #ifdef PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() != nullptr \u0026amp;\u0026amp; GetOwningArena() == other-\u0026gt;GetOwningArena()) { #else // PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() == other-\u0026gt;GetOwningArena()) { #endif // !PROTOBUF_FORCE_COPY_IN_SWAP  InternalSwap(other); } else { ::PROTOBUF_NAMESPACE_ID::internal::GenericSwap(this, other); } } void UnsafeArenaSwap(Request* other) { if (other == this) return; GOOGLE_DCHECK(GetOwningArena() == other-\u0026gt;GetOwningArena()); InternalSwap(other); } // implements Message ----------------------------------------------  Request* New(::PROTOBUF_NAMESPACE_ID::Arena* arena = nullptr) const final { return CreateMaybeMessage\u0026lt;Request\u0026gt;(arena); } using ::PROTOBUF_NAMESPACE_ID::Message::CopyFrom; void CopyFrom(const Request\u0026amp; from); using ::PROTOBUF_NAMESPACE_ID::Message::MergeFrom; void MergeFrom( const Request\u0026amp; from) { Request::MergeImpl(*this, from); } private: static void MergeImpl(::PROTOBUF_NAMESPACE_ID::Message\u0026amp; to_msg, const ::PROTOBUF_NAMESPACE_ID::Message\u0026amp; from_msg); public: PROTOBUF_ATTRIBUTE_REINITIALIZES void Clear() final; bool IsInitialized() const final; size_t ByteSizeLong() const final; const char* _InternalParse(const char* ptr, ::PROTOBUF_NAMESPACE_ID::internal::ParseContext* ctx) final; uint8_t* _InternalSerialize( uint8_t* target, ::PROTOBUF_NAMESPACE_ID::io::EpsCopyOutputStream* stream) const final; int GetCachedSize() const final { return _impl_._cached_size_.Get(); } private: void SharedCtor(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned); void SharedDtor(); void SetCachedSize(int size) const final; void InternalSwap(Request* other); private: friend class ::PROTOBUF_NAMESPACE_ID::internal::AnyMetadata; static ::PROTOBUF_NAMESPACE_ID::StringPiece FullMessageName() { return \u0026#34;main.Request\u0026#34;; } protected: explicit Request(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned = false); public: static const ClassData _class_data_; const ::PROTOBUF_NAMESPACE_ID::Message::ClassData*GetClassData() const final; ::PROTOBUF_NAMESPACE_ID::Metadata GetMetadata() const final; // nested types ----------------------------------------------------  // accessors -------------------------------------------------------  enum : int { kTeNameFieldNumber = 1, }; // string te_name = 1;  void clear_te_name(); const std::string\u0026amp; te_name() const; template \u0026lt;typename ArgT0 = const std::string\u0026amp;, typename... ArgT\u0026gt; void set_te_name(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args); std::string* mutable_te_name(); PROTOBUF_NODISCARD std::string* release_te_name(); void set_allocated_te_name(std::string* te_name); private: const std::string\u0026amp; _internal_te_name() const; inline PROTOBUF_ALWAYS_INLINE void _internal_set_te_name(const std::string\u0026amp; value); std::string* _internal_mutable_te_name(); public: // @@protoc_insertion_point(class_scope:main.Request)  private: class _Internal; template \u0026lt;typename T\u0026gt; friend class ::PROTOBUF_NAMESPACE_ID::Arena::InternalHelper; typedef void InternalArenaConstructable_; typedef void DestructorSkippable_; struct Impl_ { ::PROTOBUF_NAMESPACE_ID::internal::ArenaStringPtr te_name_; mutable ::PROTOBUF_NAMESPACE_ID::internal::CachedSize _cached_size_; }; union { Impl_ _impl_; }; friend struct ::TableStruct_service_2eproto; }; // -------------------------------------------------------------------  class Response final : public ::PROTOBUF_NAMESPACE_ID::Message /* @@protoc_insertion_point(class_definition:main.Response) */ { public: inline Response() : Response(nullptr) {} ~Response() override; explicit PROTOBUF_CONSTEXPR Response(::PROTOBUF_NAMESPACE_ID::internal::ConstantInitialized); Response(const Response\u0026amp; from); Response(Response\u0026amp;\u0026amp; from) noexcept : Response() { *this = ::std::move(from); } inline Response\u0026amp; operator=(const Response\u0026amp; from) { CopyFrom(from); return *this; } inline Response\u0026amp; operator=(Response\u0026amp;\u0026amp; from) noexcept { if (this == \u0026amp;from) return *this; if (GetOwningArena() == from.GetOwningArena() #ifdef PROTOBUF_FORCE_COPY_IN_MOVE  \u0026amp;\u0026amp; GetOwningArena() != nullptr #endif // !PROTOBUF_FORCE_COPY_IN_MOVE  ) { InternalSwap(\u0026amp;from); } else { CopyFrom(from); } return *this; } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* descriptor() { return GetDescriptor(); } static const ::PROTOBUF_NAMESPACE_ID::Descriptor* GetDescriptor() { return default_instance().GetMetadata().descriptor; } static const ::PROTOBUF_NAMESPACE_ID::Reflection* GetReflection() { return default_instance().GetMetadata().reflection; } static const Response\u0026amp; default_instance() { return *internal_default_instance(); } static inline const Response* internal_default_instance() { return reinterpret_cast\u0026lt;const Response*\u0026gt;( \u0026amp;_Response_default_instance_); } static constexpr int kIndexInFileMessages = 1; friend void swap(Response\u0026amp; a, Response\u0026amp; b) { a.Swap(\u0026amp;b); } inline void Swap(Response* other) { if (other == this) return; #ifdef PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() != nullptr \u0026amp;\u0026amp; GetOwningArena() == other-\u0026gt;GetOwningArena()) { #else // PROTOBUF_FORCE_COPY_IN_SWAP  if (GetOwningArena() == other-\u0026gt;GetOwningArena()) { #endif // !PROTOBUF_FORCE_COPY_IN_SWAP  InternalSwap(other); } else { ::PROTOBUF_NAMESPACE_ID::internal::GenericSwap(this, other); } } void UnsafeArenaSwap(Response* other) { if (other == this) return; GOOGLE_DCHECK(GetOwningArena() == other-\u0026gt;GetOwningArena()); InternalSwap(other); } // implements Message ----------------------------------------------  Response* New(::PROTOBUF_NAMESPACE_ID::Arena* arena = nullptr) const final { return CreateMaybeMessage\u0026lt;Response\u0026gt;(arena); } using ::PROTOBUF_NAMESPACE_ID::Message::CopyFrom; void CopyFrom(const Response\u0026amp; from); using ::PROTOBUF_NAMESPACE_ID::Message::MergeFrom; void MergeFrom( const Response\u0026amp; from) { Response::MergeImpl(*this, from); } private: static void MergeImpl(::PROTOBUF_NAMESPACE_ID::Message\u0026amp; to_msg, const ::PROTOBUF_NAMESPACE_ID::Message\u0026amp; from_msg); public: PROTOBUF_ATTRIBUTE_REINITIALIZES void Clear() final; bool IsInitialized() const final; size_t ByteSizeLong() const final; const char* _InternalParse(const char* ptr, ::PROTOBUF_NAMESPACE_ID::internal::ParseContext* ctx) final; uint8_t* _InternalSerialize( uint8_t* target, ::PROTOBUF_NAMESPACE_ID::io::EpsCopyOutputStream* stream) const final; int GetCachedSize() const final { return _impl_._cached_size_.Get(); } private: void SharedCtor(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned); void SharedDtor(); void SetCachedSize(int size) const final; void InternalSwap(Response* other); private: friend class ::PROTOBUF_NAMESPACE_ID::internal::AnyMetadata; static ::PROTOBUF_NAMESPACE_ID::StringPiece FullMessageName() { return \u0026#34;main.Response\u0026#34;; } protected: explicit Response(::PROTOBUF_NAMESPACE_ID::Arena* arena, bool is_message_owned = false); public: static const ClassData _class_data_; const ::PROTOBUF_NAMESPACE_ID::Message::ClassData*GetClassData() const final; ::PROTOBUF_NAMESPACE_ID::Metadata GetMetadata() const final; // nested types ----------------------------------------------------  // accessors -------------------------------------------------------  enum : int { kMessageFieldNumber = 1, }; // string message = 1;  void clear_message(); const std::string\u0026amp; message() const; template \u0026lt;typename ArgT0 = const std::string\u0026amp;, typename... ArgT\u0026gt; void set_message(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args); std::string* mutable_message(); PROTOBUF_NODISCARD std::string* release_message(); void set_allocated_message(std::string* message); private: const std::string\u0026amp; _internal_message() const; inline PROTOBUF_ALWAYS_INLINE void _internal_set_message(const std::string\u0026amp; value); std::string* _internal_mutable_message(); public: // @@protoc_insertion_point(class_scope:main.Response)  private: class _Internal; template \u0026lt;typename T\u0026gt; friend class ::PROTOBUF_NAMESPACE_ID::Arena::InternalHelper; typedef void InternalArenaConstructable_; typedef void DestructorSkippable_; struct Impl_ { ::PROTOBUF_NAMESPACE_ID::internal::ArenaStringPtr message_; mutable ::PROTOBUF_NAMESPACE_ID::internal::CachedSize _cached_size_; }; union { Impl_ _impl_; }; friend struct ::TableStruct_service_2eproto; }; // ===================================================================  // ===================================================================  #ifdef __GNUC__  #pragma GCC diagnostic push  #pragma GCC diagnostic ignored \u0026#34;-Wstrict-aliasing\u0026#34;  #endif // __GNUC__  // Request  // string te_name = 1;  inline void Request::clear_te_name() { _impl_.te_name_.ClearToEmpty(); } inline const std::string\u0026amp; Request::te_name() const { // @@protoc_insertion_point(field_get:main.Request.te_name)  return _internal_te_name(); } template \u0026lt;typename ArgT0, typename... ArgT\u0026gt; inline PROTOBUF_ALWAYS_INLINE void Request::set_te_name(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args) { _impl_.te_name_.Set(static_cast\u0026lt;ArgT0 \u0026amp;\u0026amp;\u0026gt;(arg0), args..., GetArenaForAllocation()); // @@protoc_insertion_point(field_set:main.Request.te_name)  } inline std::string* Request::mutable_te_name() { std::string* _s = _internal_mutable_te_name(); // @@protoc_insertion_point(field_mutable:main.Request.te_name)  return _s; } inline const std::string\u0026amp; Request::_internal_te_name() const { return _impl_.te_name_.Get(); } inline void Request::_internal_set_te_name(const std::string\u0026amp; value) { _impl_.te_name_.Set(value, GetArenaForAllocation()); } inline std::string* Request::_internal_mutable_te_name() { return _impl_.te_name_.Mutable(GetArenaForAllocation()); } inline std::string* Request::release_te_name() { // @@protoc_insertion_point(field_release:main.Request.te_name)  return _impl_.te_name_.Release(); } inline void Request::set_allocated_te_name(std::string* te_name) { if (te_name != nullptr) { } else { } _impl_.te_name_.SetAllocated(te_name, GetArenaForAllocation()); #ifdef PROTOBUF_FORCE_COPY_DEFAULT_STRING  if (_impl_.te_name_.IsDefault()) { _impl_.te_name_.Set(\u0026#34;\u0026#34;, GetArenaForAllocation()); } #endif // PROTOBUF_FORCE_COPY_DEFAULT_STRING  // @@protoc_insertion_point(field_set_allocated:main.Request.te_name)  } // -------------------------------------------------------------------  // Response  // string message = 1;  inline void Response::clear_message() { _impl_.message_.ClearToEmpty(); } inline const std::string\u0026amp; Response::message() const { // @@protoc_insertion_point(field_get:main.Response.message)  return _internal_message(); } template \u0026lt;typename ArgT0, typename... ArgT\u0026gt; inline PROTOBUF_ALWAYS_INLINE void Response::set_message(ArgT0\u0026amp;\u0026amp; arg0, ArgT... args) { _impl_.message_.Set(static_cast\u0026lt;ArgT0 \u0026amp;\u0026amp;\u0026gt;(arg0), args..., GetArenaForAllocation()); // @@protoc_insertion_point(field_set:main.Response.message)  } inline std::string* Response::mutable_message() { std::string* _s = _internal_mutable_message(); // @@protoc_insertion_point(field_mutable:main.Response.message)  return _s; } inline const std::string\u0026amp; Response::_internal_message() const { return _impl_.message_.Get(); } inline void Response::_internal_set_message(const std::string\u0026amp; value) { _impl_.message_.Set(value, GetArenaForAllocation()); } inline std::string* Response::_internal_mutable_message() { return _impl_.message_.Mutable(GetArenaForAllocation()); } inline std::string* Response::release_message() { // @@protoc_insertion_point(field_release:main.Response.message)  return _impl_.message_.Release(); } inline void Response::set_allocated_message(std::string* message) { if (message != nullptr) { } else { } _impl_.message_.SetAllocated(message, GetArenaForAllocation()); #ifdef PROTOBUF_FORCE_COPY_DEFAULT_STRING  if (_impl_.message_.IsDefault()) { _impl_.message_.Set(\u0026#34;\u0026#34;, GetArenaForAllocation()); } #endif // PROTOBUF_FORCE_COPY_DEFAULT_STRING  // @@protoc_insertion_point(field_set_allocated:main.Response.message)  } #ifdef __GNUC__  #pragma GCC diagnostic pop  #endif // __GNUC__  // -------------------------------------------------------------------  // @@protoc_insertion_point(namespace_scope)  } // namespace main  // @@protoc_insertion_point(global_scope)  #include \u0026lt;google/protobuf/port_undef.inc\u0026gt; #endif // GOOGLE_PROTOBUF_INCLUDED_GOOGLE_PROTOBUF_INCLUDED_service_2eproto    ç”Ÿæˆpython æ–‡ä»¶å†…å®¹\n# -*- coding: utf-8 -*- # Generated by the protocol buffer compiler. DO NOT EDIT! # source: service.proto \u0026#34;\u0026#34;\u0026#34;Generated protocol buffer code.\u0026#34;\u0026#34;\u0026#34; from google.protobuf.internal import builder as _builder from google.protobuf import descriptor as _descriptor from google.protobuf import descriptor_pool as _descriptor_pool from google.protobuf import symbol_database as _symbol_database # @@protoc_insertion_point(imports) _sym_db = _symbol_database.Default() DESCRIPTOR = _descriptor_pool.Default().AddSerializedFile(b\u0026#39;\\n\\rservice.proto\\x12\\x04main\\\u0026#34;\\x1a\\n\\x07Request\\x12\\x0f\\n\\x07te_name\\x18\\x01\\x01(\\t\\\u0026#34;\\x1b\\n\\x08Response\\x12\\x0f\\n\\x07message\\x18\\x01\\x01(\\t2\u0026lt;\\n\\x0bTestService\\x12-\\n\\nTestServer\\x12\\r.main.Request\\x1a\\x0e.main.Response\\\u0026#34;\\x00\\x62\\x06proto3\u0026#39;) _builder.BuildMessageAndEnumDescriptors(DESCRIPTOR, globals()) _builder.BuildTopDescriptorsAndMessages(DESCRIPTOR, \u0026#39;service_pb2\u0026#39;, globals()) if _descriptor._USE_C_DESCRIPTORS == False: DESCRIPTOR._options = None _REQUEST._serialized_start=23 _REQUEST._serialized_end=49 _RESPONSE._serialized_start=51 _RESPONSE._serialized_end=78 _TESTSERVICE._serialized_start=80 _TESTSERVICE._serialized_end=140 # @@protoc_insertion_point(module_scope)       ","date":"2022-08-05T22:00:38+08:00","image":"https://zcj-git520.github.io/p/proto3-%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/1_hud944d25af46653be6ac685099ccea094_87560_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/proto3-%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/","title":"proto3 è¯­æ³•å­¦ä¹ "},{"content":"go è¯­è¨€åŸç”Ÿçš„rpcçš„å®è·µ  go åŸç”Ÿçš„rpcæ˜¯ä½¿ç”¨çš„net/rpcåº“ï¼Œä½¿ç”¨encoding/gobè¿›è¡Œç¼–è§£ç ï¼Œæ”¯æŒtcpå’Œhttpæ•°æ®ä¼ è¾“æ–¹å¼ æä¾›äº†net/rpc/jsonrpcåº“å®ç°RPCæ–¹æ³•ï¼Œjsonrpcé‡‡ç”¨JSONè¿›è¡Œæ•°æ®ç¼–è§£ç ï¼Œå› è€Œæ”¯æŒè·¨è¯­è¨€è°ƒç”¨ï¼Œ ç›®å‰jsonrpcåº“æ˜¯åŸºäºtcpåè®®å®ç°çš„ï¼Œæš‚ä¸æ”¯æŒhttpä¼ è¾“æ–¹å¼  æœåŠ¡å™¨ç«¯ å¿…é¡»ç¬¦åˆ4ä¸ªåŸºæœ¬æ¡ä»¶  ç»“æ„ä½“å­—æ®µé¦–å­—æ¯è¦å¤§å†™ï¼Œå¯ä»¥åˆ«äººè°ƒç”¨ å‡½æ•°åå¿…é¡»é¦–å­—æ¯å¤§å†™ å‡½æ•°ç¬¬ä¸€å‚æ•°æ˜¯æ¥æ”¶å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿”å›ç»™å®¢æˆ·ç«¯çš„å‚æ•°ï¼Œå¿…é¡»æ˜¯æŒ‡é’ˆç±»å‹ å‡½æ•°è¿˜å¿…é¡»æœ‰ä¸€ä¸ªè¿”å›å€¼error  æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š é€šè¿‡åŠ å¯†æ¥å®è·µrpc\npackage main import ( \u0026#34;crypto/hmac\u0026#34; \u0026#34;crypto/md5\u0026#34; \u0026#34;crypto/sha512\u0026#34; \u0026#34;encoding/base64\u0026#34; \u0026#34;encoding/hex\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;golang.org/x/crypto/bcrypt\u0026#34; \u0026#34;io\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;net/rpc\u0026#34; ) // å®ä¾‹ å­—ç¬¦ä¸²åŠ å¯† // é‡‡ç”¨å“ˆå¸Œ/md5/base64/sha512/hmac const HMACKEY = \u0026#34;ZCJ\u0026#34; type DeEncryptionPram struct { CodeStr string // å¾…åŠ å¯†/è§£å¯†çš„å­—ç¬¦ä¸² \tCodeType string // åŠ è§£ç çš„ç±»å‹ } type Encryption struct { } // å“ˆå¸ŒåŠ å¯† func hasEncryption(codeStr string)string{ bytes, err := bcrypt.GenerateFromPassword([]byte(codeStr), bcrypt.DefaultCost) if err != nil { log.Println(\u0026#34;has åŠ å¯†å¤±è´¥\u0026#34;) return \u0026#34;\u0026#34; } return string(bytes) } // MD5åŠ å¯† func md5Encryption(codeStr string) string { data := md5.Sum([]byte(codeStr)) hexStr := fmt.Sprintf(\u0026#34;%x\u0026#34;, data) return hexStr } // base64åŠ å¯† func base64Encryption(codeStr string) string { return base64.StdEncoding.EncodeToString([]byte(codeStr)) } // base64 è§£å¯† func base64Decryption(codeStr string)(string, error){ by, err := base64.StdEncoding.DecodeString(codeStr) if err != nil { return \u0026#34;\u0026#34;, err } return string(by), nil } // sha512åŠ å¯† func sha512Encryption(codeStr string)string { w := sha512.New() io.WriteString(w, codeStr) bw := w.Sum(nil) return hex.EncodeToString(bw) } // ä½¿ç”¨hmac è¿›è¡ŒåŠ å¯† func hmacEncryption(codeStr string)string { hw := hmac.New(md5.New, []byte(HMACKEY)) hw.Write([]byte(codeStr)) return hex.EncodeToString(hw.Sum([]byte(\u0026#34;\u0026#34;))) } func (e *Encryption)OptEncryption(pram *DeEncryptionPram, returnData *string) error { if pram.CodeStr == \u0026#34;\u0026#34;{ returnData = nil return fmt.Errorf(\u0026#34;åŠ å¯†å­—ç¬¦ä¸²ä¸ºç©º\u0026#34;) } switch pram.CodeType { case \u0026#34;HAS\u0026#34;: *returnData = hasEncryption(pram.CodeStr) case \u0026#34;MD5\u0026#34;: *returnData = md5Encryption(pram.CodeStr) case \u0026#34;BASE64\u0026#34;: *returnData = base64Encryption(pram.CodeStr) case \u0026#34;SHA512\u0026#34;: *returnData = sha512Encryption(pram.CodeStr) case \u0026#34;HMAC\u0026#34;: *returnData = hmacEncryption(pram.CodeStr) default: *returnData = hasEncryption(pram.CodeStr) } log.Printf(\u0026#34;åŠ å¯†ç±»å‹ä¸º%v, åŠ å¯†æ•°æ®ä¸ºï¼š%v, åŠ å¯†ç»“æœä¸ºï¼š%v\u0026#34;, pram.CodeType, pram.CodeStr, *returnData) return nil } func (e *Encryption)OptDecryption(pram *DeEncryptionPram, returnData *string) error { if pram.CodeStr == \u0026#34;\u0026#34;{ returnData = nil return fmt.Errorf(\u0026#34;è§£å¯†å­—ç¬¦ä¸²ä¸ºç©º\u0026#34;) } if pram.CodeType == \u0026#34;BASE64\u0026#34;{ str, err := base64Decryption(pram.CodeStr) if err != nil { *returnData = \u0026#34;\u0026#34; return err } *returnData = str log.Printf(\u0026#34;è§£å¯†ç±»å‹ä¸º%v, è§£å¯†æ•°æ®ä¸ºï¼š%v, è§£å¯†ç»“æœä¸ºï¼š%v\u0026#34;, pram.CodeType, pram.CodeStr, *returnData) return nil } *returnData = \u0026#34;\u0026#34; return fmt.Errorf(\u0026#34;è§£å¯†ç±»å‹åªæ”¯æŒï¼šbase64\u0026#34;) } func main() { enc := new(Encryption) // æ³¨å†ŒæœåŠ¡ \terr := rpc.Register(enc) if err != nil { log.Fatal(\u0026#34;æœåŠ¡æ³¨å†Œå¤±è´¥\u0026#34;) } // ä½¿ç”¨http \trpc.HandleHTTP() // ç›‘å¬æœåŠ¡ \tlog.Println(\u0026#34;ç›‘å¬æœåŠ¡...........\u0026#34;) err = http.ListenAndServe(\u0026#34;:8000\u0026#34;, nil) if err != nil { log.Panicln(err) } } å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š package main import ( \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/rpc\u0026#34; ) // å®¢æˆ·ç«¯å¼€å§‹è¯·æ±‚  type DeEncryptionPram struct { CodeStr string // å¾…åŠ å¯†/è§£å¯†çš„å­—ç¬¦ä¸² \tCodeType string // åŠ è§£ç çš„ç±»å‹ } func main() { // è¿æ¥http \tconn, err := rpc.DialHTTP(\u0026#34;tcp\u0026#34;, \u0026#34;:8000\u0026#34;) if err != nil { log.Panic(err) } pram := \u0026amp;DeEncryptionPram{ CodeStr: \u0026#34;zcj2565554485\u0026#34;, CodeType: \u0026#34;HAS\u0026#34;, } var HASData string err = conn.Call(\u0026#34;Encryption.OptEncryption\u0026#34;, pram, \u0026amp;HASData) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Encryption data is :\u0026#34;, HASData) pram = \u0026amp;DeEncryptionPram{ CodeStr: \u0026#34;zcj2565554485\u0026#34;, CodeType: \u0026#34;MD5\u0026#34;, } var MD5Data string err = conn.Call(\u0026#34;Encryption.OptEncryption\u0026#34;, pram, \u0026amp;MD5Data) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Encryption data is :\u0026#34;, MD5Data) pram = \u0026amp;DeEncryptionPram{ CodeStr: \u0026#34;zcj2565554485\u0026#34;, CodeType: \u0026#34;SHA512\u0026#34;, } var SHA512Data string err = conn.Call(\u0026#34;Encryption.OptEncryption\u0026#34;, pram, \u0026amp;SHA512Data) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Encryption data is :\u0026#34;, SHA512Data) pram = \u0026amp;DeEncryptionPram{ CodeStr: \u0026#34;zcj2565554485\u0026#34;, CodeType: \u0026#34;HMAC\u0026#34;, } var HMACData string err = conn.Call(\u0026#34;Encryption.OptEncryption\u0026#34;, pram, \u0026amp;HMACData) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Encryption data is :\u0026#34;, HMACData) pram = \u0026amp;DeEncryptionPram{ CodeStr: \u0026#34;zcj2565554485\u0026#34;, CodeType: \u0026#34;BASE64\u0026#34;, } var returnData string err = conn.Call(\u0026#34;Encryption.OptEncryption\u0026#34;, pram, \u0026amp;returnData) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Encryption data is :\u0026#34;, returnData) pram = \u0026amp;DeEncryptionPram{ CodeStr: returnData, CodeType: \u0026#34;BASE64\u0026#34;, } returnData = \u0026#34;\u0026#34; err = conn.Call(\u0026#34;Encryption.OptDecryption\u0026#34;, pram, \u0026amp;returnData) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Decryption data is :\u0026#34;, returnData) pram = \u0026amp;DeEncryptionPram{ CodeStr: returnData, CodeType: \u0026#34;HMAC\u0026#34;, } returnData = \u0026#34;\u0026#34; err = conn.Call(\u0026#34;Encryption.OptDecryption\u0026#34;, pram, \u0026amp;returnData) if err != nil { log.Println(err) } fmt.Println(\u0026#34;Decryption data is :\u0026#34;, returnData) } æµ‹è¯•ç»“æœ E:\\GO_Rroject\\rpc_zcj\\go_native_rpc\u0026gt;go run client.go Encryption data is : $2a$10$IaSoHv0OpVBZNk3zfx1Ct.dKLZJwU5of6qoKf2bABA7aKEQvObYLm Encryption data is : 2cb48591141c092db41a3edaf2bbbfdb Encryption data is : 0d7e532c800ee449a5eab309d1916e1f6ff4ffa0738d7e9aa06adae93154842f22896575c50e711f10d1 869b7945377c46ac7211d4aa919a0bed41ef2d806327 Encryption data is : fcba1e90c88b18eb08e59467f36bd202 Encryption data is : emNqMjU2NTU1NDQ4NQ== Decryption data is : zcj2565554485 2022/08/13 21:58:23 è§£å¯†ç±»å‹åªæ”¯æŒï¼šbase64 Decryption data is : \r\n","date":"2022-08-01T22:00:38+08:00","image":"https://zcj-git520.github.io/p/prc-go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%E4%B8%80/2_hu9db44f85261860f0cd6b40f5490959f6_304073_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/prc-go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%E4%B8%80/","title":"PRC go è¯­è¨€å®è·µä¸€"},{"content":"è®¾ç½®è‡ªå·±çš„ç¼–è¾‘å™¨ ç®€å•ä»‹ç»  åŸºäºvim è®¾è®¡è‡ªå·±çš„ç¼–è¾‘å™¨ ä½¿ç”¨vimæ’ä»¶ ä»¥ä¸‹æ˜¯ç¼–è¾‘å™¨çš„.vimrc  é…ç½®å¦‚ä¸‹ set nocompatible \u0026quot; be iMproved, required filetype off \u0026quot; required \u0026quot; set the runtime path to include Vundle and initialize set rtp+=~/.vim/bundle/Vundle.vim call vundle#begin() \u0026quot; alternatively, pass a path where Vundle should install plugins \u0026quot;call vundle#begin('~/some/path/here') \u0026quot; let Vundle manage Vundle, required Plugin 'VundleVim/Vundle.vim' Plugin 'dense-analysis/ale' Plugin 'preservim/nerdtree' Plugin 'preservim/nerdcommenter' Plugin 'ludovicchabant/vim-gutentags' Plugin 'Valloric/YouCompleteMe' Plugin 'Shougo/neocomplete.vim' Plugin 'vim-scripts/taglist.vim' \u0026quot; Plugin 'rstacruz/sparkup', {'rtp': 'vim/'} call vundle#end() \u0026quot; required filetype plugin indent on \u0026quot; required set sw=4 set ts=4 set et set smarttab set smartindent set lbr set fo+=mB set sm set selection=inclusive set wildmenu set mousemodel=popup \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;ale \u0026quot;å§‹ç»ˆå¼€å¯æ ‡å¿—åˆ— let g:ale_sign_column_always = 1 let g:ale_set_highlights = 0 \u0026quot;è‡ªå®šä¹‰errorå’Œwarningå›¾æ ‡ let g:ale_sign_error = 'âœ—' let g:ale_sign_warning = 'âš¡' \u0026quot;åœ¨vimè‡ªå¸¦çš„çŠ¶æ€æ ä¸­æ•´åˆale let g:ale_statusline_format = ['âœ— %d', 'âš¡ %d', 'âœ” OK'] \u0026quot;æ˜¾ç¤ºLinteråç§°,å‡ºé”™æˆ–è­¦å‘Šç­‰ç›¸å…³ä¿¡æ¯ let g:ale_echo_msg_error_str = 'E' let g:ale_echo_msg_warning_str = 'W' let g:ale_echo_msg_format = '[%linter%] %s [%severity%]' \u0026quot;æ™®é€šæ¨¡å¼ä¸‹ï¼Œspå‰å¾€ä¸Šä¸€ä¸ªé”™è¯¯æˆ–è­¦å‘Šï¼Œsnå‰å¾€ä¸‹ä¸€ä¸ªé”™è¯¯æˆ–è­¦å‘Š nmap sp (ale_previous_wrap) nmap sn (ale_next_wrap) \u0026quot;sè§¦å‘/å…³é—­è¯­æ³•æ£€æŸ¥ nmap s :ALEToggle \u0026quot;aæŸ¥çœ‹é”™è¯¯æˆ–è­¦å‘Šçš„è¯¦ç»†ä¿¡æ¯ nmap a :ALEDetail let g:ale_linters = { \\ 'c++': ['clang'], \\ 'c': ['clang'], \\ 'python': ['pylint'], \\ 'golang':['golangci-lint'], \\} \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;å°†è¯¥é…ç½®å†™è¿›.vimrcæ–‡ä»¶ä¸­\u0026quot; nnoremap \u0026lt;C-n\u0026gt; :NERDTreeToggle\u0026lt;CR\u0026gt; \u0026quot;æ‰“å¼€NERDTree,åœ¨nodeä¸­é€‰ä¸­å½“å‰æ–‡ä»¶\u0026quot; nnoremap \u0026lt;C-f\u0026gt; :NERDTreeFind\u0026lt;CR\u0026gt; \u0026quot;vimæ‰“å¼€æ—¶ï¼Œè‡ªåŠ¨æ‰“å¼€NERDTree,å¹¶ä¸”å°†å…‰æ ‡æ”¾åœ¨æ–‡ä»¶çª—å£\u0026quot; \u0026quot;autocmd VimEnter * NERDTree | wincmd p \u0026quot;å½“NERDTreeæ˜¯å”¯ä¸€çš„çª—å£æ—¶é€€å‡ºvim\u0026quot; autocmd BufEnter * if tabpagenr('$') == 1 \u0026amp;\u0026amp; winnr('$') == 1 \u0026amp;\u0026amp; exists('b:NERDTree') \u0026amp;\u0026amp; b:NERDTree.isTabTree() | quit | endif \u0026quot;åœ¨æ¯ä¸€ä¸ªæ–°çš„new tabæ‰“å¼€å­˜åœ¨çš„NERDTree\u0026quot; autocmd BufWinEnter * silent NERDTreeMirror \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot; Add spaces after comment delimiters by default let g:NERDSpaceDelims = 1 \u0026quot; Use compact syntax for prettified multi-line comments let g:NERDCompactSexyComs = 1 \u0026quot; Align line-wise comment delimiters flush left instead of following code indentation let g:NERDDefaultAlign = 'left' \u0026quot; Set a language to use its alternate delimiters by default let g:NERDAltDelims_java = 1 \u0026quot; Add your own custom formats or override the defaults let g:NERDCommentEmptyLines = 1 \u0026quot; Enable trimming of trailing whitespace when uncommenting let g:NERDTrimTrailingWhitespace = 1 \u0026quot; Enable NERDCommenterToggle to check all selected lines is commented or not let g:NERDToggleCheckAllLines = 1 \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot; gutentagsæœç´¢å·¥ç¨‹ç›®å½•çš„æ ‡å¿—ï¼Œç¢°åˆ°è¿™äº›æ–‡ä»¶/ç›®å½•åå°±åœæ­¢å‘ä¸Šä¸€çº§ç›®å½•é€’å½’ \u0026quot; let g:gutentags_project_root = ['.root', '.svn', '.git', '.project'] \u0026quot; æ‰€ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶çš„åç§° \u0026quot; let g:gutentags_ctags_tagfile = '.tags' \u0026quot; å°†è‡ªåŠ¨ç”Ÿæˆçš„ tags æ–‡ä»¶å…¨éƒ¨æ”¾å…¥ ~/.cache/tags ç›®å½•ä¸­ï¼Œé¿å…æ±¡æŸ“å·¥ç¨‹ç›®å½• \u0026quot; let s:vim_tags = expand('~/.cache/tags') let g:gutentags_cache_dir = s:vim_tags \u0026quot; æ£€æµ‹ ~/.cache/tags ä¸å­˜åœ¨å°±æ–°å»º \u0026quot; if !isdirectory(s:vim_tags) silent! call mkdir(s:vim_tags, 'p') endif \u0026quot; é…ç½® ctags çš„å‚æ•° \u0026quot; let g:gutentags_ctags_extra_args = ['--fields=+niazS', '--extra=+q'] let g:gutentags_ctags_extra_args += ['--c++-kinds=+pxI'] let g:gutentags_ctags_extra_args += ['--c-kinds=+px'] \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot; Use neocomplete. let g:neocomplete#enable_at_startup = 1 \u0026quot; Use smartcase. let g:neocomplete#enable_smart_case = 1 \u0026quot; Set minimum syntax keyword length. let g:neocomplete#sources#syntax#min_keyword_length = 3 let g:neocomplete#lock_buffer_name_pattern = '\\*ku\\*' \u0026quot; Define dictionary. let g:neocomplete#sources#dictionary#dictionaries = { \\ 'default' : '', \\ 'vimshell' : $HOME.'/.vimshell_hist', \\ 'scheme' : $HOME.'/.gosh_completions' \\ } \u0026quot; Define keyword. if !exists('g:neocomplete#keyword_patterns') let g:neocomplete#keyword_patterns = {} endif let g:neocomplete#keyword_patterns['default'] = '\\h\\w*' \u0026quot; Plugin key-mappings. inoremap \u0026lt;expr\u0026gt;\u0026lt;C-g\u0026gt; neocomplete#undo_completion() inoremap \u0026lt;expr\u0026gt;\u0026lt;C-l\u0026gt; neocomplete#complete_common_string() \u0026quot; Recommended key-mappings. \u0026quot; \u0026lt;CR\u0026gt;: close popup and save indent. inoremap \u0026lt;silent\u0026gt; \u0026lt;CR\u0026gt; \u0026lt;C-r\u0026gt;=\u0026lt;SID\u0026gt;my_cr_function()\u0026lt;CR\u0026gt; function! s:my_cr_function() return neocomplete#close_popup() . \u0026quot;\\\u0026lt;CR\u0026gt;\u0026quot; \u0026quot; For no inserting \u0026lt;CR\u0026gt; key. \u0026quot;return pumvisible() ? neocomplete#close_popup() : \u0026quot;\\\u0026lt;CR\u0026gt;\u0026quot; endfunction \u0026quot; \u0026lt;TAB\u0026gt;: completion. inoremap \u0026lt;expr\u0026gt;\u0026lt;TAB\u0026gt; pumvisible() ? \u0026quot;\\\u0026lt;C-n\u0026gt;\u0026quot; : \u0026quot;\\\u0026lt;TAB\u0026gt;\u0026quot; \u0026quot; \u0026lt;C-h\u0026gt;, \u0026lt;BS\u0026gt;: close popup and delete backword char. inoremap \u0026lt;expr\u0026gt;\u0026lt;C-h\u0026gt; neocomplete#smart_close_popup().\u0026quot;\\\u0026lt;C-h\u0026gt;\u0026quot; inoremap \u0026lt;expr\u0026gt;\u0026lt;BS\u0026gt; neocomplete#smart_close_popup().\u0026quot;\\\u0026lt;C-h\u0026gt;\u0026quot; inoremap \u0026lt;expr\u0026gt;\u0026lt;C-y\u0026gt; neocomplete#close_popup() inoremap \u0026lt;expr\u0026gt;\u0026lt;C-e\u0026gt; neocomplete#cancel_popup() \u0026quot; Enable omni completion. autocmd FileType css setlocal omnifunc=csscomplete#CompleteCSS autocmd FileType html,markdown setlocal omnifunc=htmlcomplete#CompleteTags autocmd FileType javascript setlocal omnifunc=javascriptcomplete#CompleteJS autocmd FileType python setlocal omnifunc=pythoncomplete#Complete autocmd FileType xml setlocal omnifunc=xmlcomplete#CompleteTags \u0026quot; Enable heavy omni completion. if !exists('g:neocomplete#sources#omni#input_patterns') let g:neocomplete#sources#omni#input_patterns = {} endif \u0026quot; For perlomni.vim setting. \u0026quot; https://github.com/c9s/perlomni.vim let g:neocomplete#sources#omni#input_patterns.perl = '\\h\\w*-\u0026gt;\\h\\w*\\|\\h\\w*::' \u0026quot; æ˜¾ç¤ºç›¸å…³ \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; syntax on set nobackup \u0026quot;å–æ¶ˆè‡ªåŠ¨å¤‡ä»½ï¼Œç¦æ­¢ç”Ÿæˆä¸´æ—¶æ–‡ä»¶ set noswapfile set nocompatible \u0026quot;å…³é—­å…¼å®¹æ¨¡å¼ set incsearch \u0026quot;å¼€å¯å®æ—¶æœç´¢åŠŸèƒ½ set ignorecase \u0026quot;æœç´¢å¿½ç•¥å¤§å°å†™ set wildmenu \u0026quot;vimå‘½ä»¤è‡ªåŠ¨è¡¥å…¨ set autoread \u0026quot;æ–‡ä»¶è‡ªåŠ¨æ›´æ–° set gcr=a:block-blinkon0 \u0026quot;ç¦æ­¢å…³é—­é—ªçƒ set laststatus=2 \u0026quot;æ€»æ˜¯æ˜¾ç¤ºçŠ¶æ€æ  set ruler \u0026quot;æ˜¾ç¤ºå…‰æ ‡ä½ç½® set nu \u0026quot;æ˜¾ç¤ºè¡Œå· \u0026quot; set relativenumber \u0026quot;æ˜¾ç¤ºç›¸å¯¹è¡Œå· set cuc \u0026quot;æµ…è‰²æ˜¾ç¤ºå½“å‰è¡Œ set cul \u0026quot;æµ…è‰²æ˜¾ç¤ºå½“å‰è¡Œ set showcmd \u0026quot;è¾“å…¥çš„å‘½ä»¤æ˜¾ç¤ºå‡ºæ¥ set cmdheight=2 \u0026quot;å‘½ä»¤è¡Œé«˜åº¦ set nofoldenable set foldmethod=manual \u0026quot;å…è®¸æ‰‹åŠ¨æŠ˜å  set cul \u0026quot;é«˜äº®å…‰æ ‡æ‰€åœ¨è¡Œ set cuc set shortmess=atI \u0026quot; å¯åŠ¨çš„æ—¶å€™ä¸æ˜¾ç¤ºé‚£ä¸ªæ´åŠ©ä¹Œå¹²è¾¾å„¿ç«¥çš„æç¤º set go= \u0026quot; ä¸è¦å›¾å½¢æŒ‰é’® \u0026quot;color desert \u0026quot; è®¾ç½®èƒŒæ™¯ä¸»é¢˜ color ron \u0026quot; è®¾ç½®èƒŒæ™¯ä¸»é¢˜ autocmd InsertEnter * se cul \u0026quot; ç”¨æµ…è‰²é«˜äº®å½“å‰è¡Œ set ruler \u0026quot; æ˜¾ç¤ºæ ‡å°º set showcmd \u0026quot; è¾“å…¥çš„å‘½ä»¤æ˜¾ç¤ºå‡ºæ¥ï¼Œçœ‹çš„æ¸…æ¥šäº› set scrolloff=3 \u0026quot; å…‰æ ‡ç§»åŠ¨åˆ°bufferçš„é¡¶éƒ¨å’Œåº•éƒ¨æ—¶ä¿æŒ3è¡Œè·ç¦» set statusline=%F%m%r%h%w\\ [FORMAT=%{\u0026amp;ff}]\\ [TYPE=%Y]\\ [POS=%l,%v][%p%%]\\ %{strftime(\\\u0026quot;%d/%m/%y\\ -\\ %H:%M\\\u0026quot;)} \u0026quot;çŠ¶æ€è¡Œæ˜¾ç¤ºçš„å†…å®¹ set laststatus=2 \u0026quot; å¯åŠ¨æ˜¾ç¤ºçŠ¶æ€è¡Œ(1),æ€»æ˜¯æ˜¾ç¤ºçŠ¶æ€è¡Œ(2) set nocompatible \u0026quot;å»æ‰è®¨åŒçš„æœ‰å…³viä¸€è‡´æ€§æ¨¡å¼ï¼Œé¿å…ä»¥å‰ç‰ˆæœ¬çš„ä¸€äº›bugå’Œå±€é™ \u0026quot; æ˜¾ç¤ºä¸­æ–‡å¸®åŠ© if version \u0026gt;= 603 set helplang=cn set encoding=utf-8 endif \u0026quot; è‡ªåŠ¨ç¼©è¿› set autoindent set cindent \u0026quot; Tabé”®çš„å®½åº¦ set tabstop=4 \u0026quot; ç»Ÿä¸€ç¼©è¿›ä¸º4 set softtabstop=4 set shiftwidth=4 \u0026quot; ä½¿ç”¨ç©ºæ ¼ä»£æ›¿åˆ¶è¡¨ç¬¦ set expandtab \u0026quot; åœ¨è¡Œå’Œæ®µå¼€å§‹å¤„ä½¿ç”¨åˆ¶è¡¨ç¬¦ set smarttab \u0026quot; æ˜¾ç¤ºè¡Œå· set number \u0026quot; å†å²è®°å½•æ•° set history=1000 \u0026quot;æœç´¢é€å­—ç¬¦é«˜äº® set hlsearch set incsearch \u0026quot;è¯­è¨€è®¾ç½® set langmenu=zh_CN.UTF-8 set helplang=cn \u0026quot; æ€»æ˜¯æ˜¾ç¤ºçŠ¶æ€è¡Œ set cmdheight=2 \u0026quot; ä¾¦æµ‹æ–‡ä»¶ç±»å‹ filetype on \u0026quot; è½½å…¥æ–‡ä»¶ç±»å‹æ’ä»¶ filetype plugin on \u0026quot; ä¸ºç‰¹å®šæ–‡ä»¶ç±»å‹è½½å…¥ç›¸å…³ç¼©è¿›æ–‡ä»¶ filetype indent on \u0026quot; ä¿å­˜å…¨å±€å˜é‡ set viminfo+=! \u0026quot; å¸¦æœ‰å¦‚ä¸‹ç¬¦å·çš„å•è¯ä¸è¦è¢«æ¢è¡Œåˆ†å‰² set iskeyword+=_,$,@,%,#,- \u0026quot; å­—ç¬¦é—´æ’å…¥çš„åƒç´ è¡Œæ•°ç›® \u0026quot;markdowné…ç½® au BufRead,BufNewFile *.{md,mdown,mkd,mkdn,markdown,mdwn} set filetype=mkd au BufRead,BufNewFile *.{go} set filetype=go au BufRead,BufNewFile *.{js} set filetype=javascript \u0026quot;rkdown to HTML nmap md :!~/.vim/markdown.pl % \u0026gt; %.html \u0026lt;CR\u0026gt;\u0026lt;CR\u0026gt; nmap fi :!firefox %.html \u0026amp; \u0026lt;CR\u0026gt;\u0026lt;CR\u0026gt; nmap \\ \\cc vmap \\ \\cc \u0026quot;å°†tabæ›¿æ¢ä¸ºç©ºæ ¼ nmap tt :%s/\\t/ /g\u0026lt;CR\u0026gt; \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;æ–°æ–‡ä»¶æ ‡é¢˜ \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;æ–°å»º.c,.h,.sh,.javaæ–‡ä»¶ï¼Œè‡ªåŠ¨æ’å…¥æ–‡ä»¶å¤´ autocmd BufNewFile *.cpp,*.[ch],*.sh,*.rb,*.java,*.py exec \u0026quot;:call SetTitle()\u0026quot; \u0026quot;\u0026quot;å®šä¹‰å‡½æ•°SetTitleï¼Œè‡ªåŠ¨æ’å…¥æ–‡ä»¶å¤´ func SetTitle() \u0026quot;å¦‚æœæ–‡ä»¶ç±»å‹ä¸º.shæ–‡ä»¶ if \u0026amp;filetype == 'sh' call setline(1,\u0026quot;\\#!/bin/bash\u0026quot;) call append(line(\u0026quot;.\u0026quot;), \u0026quot;\u0026quot;) elseif \u0026amp;filetype == 'python' call setline(1,\u0026quot;#!/usr/bin/env python\u0026quot;) call append(line(\u0026quot;.\u0026quot;),\u0026quot;# coding=utf-8\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+1, \u0026quot;\u0026quot;) elseif \u0026amp;filetype == 'ruby' call setline(1,\u0026quot;#!/usr/bin/env ruby\u0026quot;) call append(line(\u0026quot;.\u0026quot;),\u0026quot;# encoding: utf-8\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+1, \u0026quot;\u0026quot;) \u0026quot; elseif \u0026amp;filetype == 'mkd' \u0026quot; call setline(1,\u0026quot;\u0026lt;head\u0026gt;\u0026lt;meta charset=\\\u0026quot;UTF-8\\\u0026quot;\u0026gt;\u0026lt;/head\u0026gt;\u0026quot;) else call setline(1, \u0026quot;/*************************************************************************\u0026quot;) call append(line(\u0026quot;.\u0026quot;), \u0026quot; \u0026gt; File Name: \u0026quot;.expand(\u0026quot;%\u0026quot;)) call append(line(\u0026quot;.\u0026quot;)+1, \u0026quot; \u0026gt; Author: username\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+2, \u0026quot; \u0026gt; Mail: 111111111@qq.com\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+3, \u0026quot; \u0026gt; Created Time: \u0026quot;.strftime(\u0026quot;%c\u0026quot;)) call append(line(\u0026quot;.\u0026quot;)+4, \u0026quot; ************************************************************************/\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+5, \u0026quot;\u0026quot;) endif if expand(\u0026quot;%:e\u0026quot;) == 'cpp' call append(line(\u0026quot;.\u0026quot;)+6, \u0026quot;#include \u0026lt;iostream\u0026gt;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+7, \u0026quot;using std::cin;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+8, \u0026quot;using std::cout;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+9, \u0026quot;using std::endl;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+10, \u0026quot;using namespace std;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+11, \u0026quot;\u0026quot;) endif if \u0026amp;filetype == 'c' call append(line(\u0026quot;.\u0026quot;)+6, \u0026quot;#include \u0026lt;stdio.h\u0026gt;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+7, \u0026quot;\u0026quot;) endif if expand(\u0026quot;%:e\u0026quot;) == 'h' call append(line(\u0026quot;.\u0026quot;)+6, \u0026quot;#ifndef _\u0026quot;.toupper(expand(\u0026quot;%:r\u0026quot;)).\u0026quot;_H\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+7, \u0026quot;#define _\u0026quot;.toupper(expand(\u0026quot;%:r\u0026quot;)).\u0026quot;_H\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+8, \u0026quot;#endif\u0026quot;) endif if \u0026amp;filetype == 'java' call append(line(\u0026quot;.\u0026quot;)+6,\u0026quot;public class \u0026quot;.expand(\u0026quot;%:r\u0026quot;)) call append(line(\u0026quot;.\u0026quot;)+7,\u0026quot;\u0026quot;) if \u0026amp;filetype == 'go' call append(line(\u0026quot;.\u0026quot;)+6,\u0026quot;package main\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+7,\u0026quot;\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+8,\u0026quot;func main() {\u0026quot;) call append(line(\u0026quot;.\u0026quot;)+9,\u0026quot;}\u0026quot;) endif \u0026quot;æ–°å»ºæ–‡ä»¶åï¼Œè‡ªåŠ¨å®šä½åˆ°æ–‡ä»¶æœ«å°¾ endfunc autocmd BufNewFile * normal G command WQ wq command Wq wq \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;é”®ç›˜å‘½ä»¤ \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; :nmap \u0026lt;silent\u0026gt; \u0026lt;F9\u0026gt; \u0026lt;ESC\u0026gt;:Tlist\u0026lt;RETURN\u0026gt; \u0026quot; shift tab pages map \u0026lt;S-Left\u0026gt; :tabp\u0026lt;CR\u0026gt; map \u0026lt;S-Right\u0026gt; :tabn\u0026lt;CR\u0026gt; map! \u0026lt;C-Z\u0026gt; \u0026lt;Esc\u0026gt;zzi map! \u0026lt;C-O\u0026gt; \u0026lt;C-Y\u0026gt;, map \u0026lt;C-A\u0026gt; ggVG$\u0026quot;+y map \u0026lt;Esc\u0026gt;\u0026lt;Esc\u0026gt; :w\u0026lt;CR\u0026gt; map \u0026lt;F12\u0026gt; gg=G map \u0026lt;C-w\u0026gt; \u0026lt;C-w\u0026gt;w imap \u0026lt;C-k\u0026gt; \u0026lt;C-y\u0026gt;, imap \u0026lt;C-t\u0026gt; \u0026lt;C-q\u0026gt;\u0026lt;TAB\u0026gt; imap \u0026lt;C-j\u0026gt; \u0026lt;ESC\u0026gt; \u0026quot; é€‰ä¸­çŠ¶æ€ä¸‹ Ctrl+c å¤åˆ¶ \u0026quot;map \u0026lt;C-v\u0026gt; \u0026quot;*pa imap \u0026lt;C-v\u0026gt; \u0026lt;Esc\u0026gt;\u0026quot;*pa imap \u0026lt;C-a\u0026gt; \u0026lt;Esc\u0026gt;^ imap \u0026lt;C-e\u0026gt; \u0026lt;Esc\u0026gt;$ vmap \u0026lt;C-c\u0026gt; \u0026quot;+y \u0026quot;set mouse=v \u0026quot;set clipboard=unnamed \u0026quot;å»æ³¨é‡Š nnoremap \u0026lt;F1\u0026gt; :g/^\\s*#/d\u0026lt;CR\u0026gt; \u0026quot;å»ç©ºè¡Œ nnoremap \u0026lt;F2\u0026gt; :g/^\\s*$/d\u0026lt;CR\u0026gt; \u0026quot;æ¯”è¾ƒæ–‡ä»¶ nnoremap \u0026lt;C-F2\u0026gt; :vert diffsplit \u0026quot;nnoremap \u0026lt;Leader\u0026gt;fu :CtrlPFunky\u0026lt;Cr\u0026gt; \u0026quot;nnoremap \u0026lt;C-n\u0026gt; :CtrlPFunky\u0026lt;Cr\u0026gt; \u0026quot;Cï¼ŒC++ æŒ‰F5ç¼–è¯‘è¿è¡Œ map \u0026lt;F5\u0026gt; :call CompileRunGcc()\u0026lt;CR\u0026gt; func! CompileRunGcc() exec \u0026quot;w\u0026quot; if \u0026amp;filetype == 'c' exec \u0026quot;!g++ % -o %\u0026lt;\u0026quot; exec \u0026quot;!time ./%\u0026lt;\u0026quot; elseif \u0026amp;filetype == 'cpp' exec \u0026quot;!g++ % -std=c++11 -o %\u0026lt;\u0026quot; exec \u0026quot;!time ./%\u0026lt;\u0026quot; elseif \u0026amp;filetype == 'java' exec \u0026quot;!javac %\u0026quot; exec \u0026quot;!time java %\u0026lt;\u0026quot; elseif \u0026amp;filetype == 'sh' :!time bash % elseif \u0026amp;filetype == 'python' exec \u0026quot;!time python2.7 %\u0026quot; elseif \u0026amp;filetype == 'html' exec \u0026quot;!firefox % \u0026amp;\u0026quot; elseif \u0026amp;filetype == 'go' \u0026quot; exec \u0026quot;!go build %\u0026lt;\u0026quot; exec \u0026quot;!time go run %\u0026quot; elseif \u0026amp;filetype == 'mkd' exec \u0026quot;!~/.vim/markdown.pl % \u0026gt; %.html \u0026amp;\u0026quot; exec \u0026quot;!firefox %.html \u0026amp;\u0026quot; endif endfunc \u0026quot;C,C++çš„è°ƒè¯• map \u0026lt;F8\u0026gt; :call Rungdb()\u0026lt;CR\u0026gt; func! Rungdb() exec \u0026quot;w\u0026quot; exec \u0026quot;!g++ % -std=c++11 -g -o %\u0026lt;\u0026quot; exec \u0026quot;!gdb ./%\u0026lt;\u0026quot; endfunc \u0026quot;ä»£ç æ ¼å¼ä¼˜åŒ–åŒ– map \u0026lt;F6\u0026gt; :call FormartSrc()\u0026lt;CR\u0026gt;\u0026lt;CR\u0026gt; \u0026quot;å®šä¹‰FormartSrc() func FormartSrc() exec \u0026quot;w\u0026quot; if \u0026amp;filetype == 'c' exec \u0026quot;!astyle --style=ansi -a --suffix=none %\u0026quot; elseif \u0026amp;filetype == 'cpp' || \u0026amp;filetype == 'hpp' exec \u0026quot;r !astyle --style=ansi --one-line=keep-statements -a --suffix=none %\u0026gt; /dev/null 2\u0026gt;\u0026amp;1\u0026quot; elseif \u0026amp;filetype == 'perl' exec \u0026quot;!astyle --style=gnu --suffix=none %\u0026quot; elseif \u0026amp;filetype == 'py'||\u0026amp;filetype == 'python' exec \u0026quot;r !autopep8 -i --aggressive %\u0026quot; elseif \u0026amp;filetype == 'java' exec \u0026quot;!astyle --style=java --suffix=none %\u0026quot; elseif \u0026amp;filetype == 'jsp' exec \u0026quot;!astyle --style=gnu --suffix=none %\u0026quot; elseif \u0026amp;filetype == 'xml' exec \u0026quot;!astyle --style=gnu --suffix=none %\u0026quot; else exec \u0026quot;normal gg=G\u0026quot; return endif exec \u0026quot;e! %\u0026quot; endfunc \u0026quot;ç»“æŸå®šä¹‰FormartSrc \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;\u0026quot;å®ç”¨è®¾ç½® \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; if has(\u0026quot;autocmd\u0026quot;) autocmd BufReadPost * \\ if line(\u0026quot;'\\\u0026quot;\u0026quot;) \u0026gt; 0 \u0026amp;\u0026amp; line(\u0026quot;'\\\u0026quot;\u0026quot;) \u0026lt;= line(\u0026quot;$\u0026quot;) | \\ exe \u0026quot;normal g`\\\u0026quot;\u0026quot; | \\ endif endif \u0026quot;å½“æ‰“å¼€vimä¸”æ²¡æœ‰æ–‡ä»¶æ—¶è‡ªåŠ¨æ‰“å¼€NERDTree autocmd vimenter * if !argc() | NERDTree | endif \u0026quot; åªå‰© NERDTreeæ—¶è‡ªåŠ¨å…³é—­ autocmd bufenter * if (winnr(\u0026quot;$\u0026quot;) == 1 \u0026amp;\u0026amp; exists(\u0026quot;b:NERDTreeType\u0026quot;) \u0026amp;\u0026amp; b:NERDTreeType == \u0026quot;primary\u0026quot;) | q | endif \u0026quot; è®¾ç½®å½“æ–‡ä»¶è¢«æ”¹åŠ¨æ—¶è‡ªåŠ¨è½½å…¥ set autoread \u0026quot; quickfixæ¨¡å¼ autocmd FileType c,cpp map \u0026lt;buffer\u0026gt; \u0026lt;leader\u0026gt;\u0026lt;space\u0026gt; :w\u0026lt;cr\u0026gt;:make\u0026lt;cr\u0026gt; \u0026quot;è‡ªåŠ¨ä¿å­˜ set autowrite \u0026quot;set ruler \u0026quot; æ‰“å¼€çŠ¶æ€æ æ ‡å°º \u0026quot;set cursorline \u0026quot; çªå‡ºæ˜¾ç¤ºå½“å‰è¡Œ set magic \u0026quot; è®¾ç½®é­”æœ¯ set guioptions-=T \u0026quot; éšè—å·¥å…·æ  set guioptions-=m \u0026quot; éšè—èœå•æ  \u0026quot; ä¸è¦ä½¿ç”¨viçš„é”®ç›˜æ¨¡å¼ï¼Œè€Œæ˜¯vimè‡ªå·±çš„ set nocompatible \u0026quot; å»æ‰è¾“å…¥é”™è¯¯çš„æç¤ºå£°éŸ³ set noeb \u0026quot; åœ¨å¤„ç†æœªä¿å­˜æˆ–åªè¯»æ–‡ä»¶çš„æ—¶å€™ï¼Œå¼¹å‡ºç¡®è®¤ set confirm \u0026quot;ç¦æ­¢ç”Ÿæˆä¸´æ—¶æ–‡ä»¶ set nobackup set noswapfile \u0026quot;æœç´¢å¿½ç•¥å¤§å°å†™ set ignorecase set linespace=0 \u0026quot; å¢å¼ºæ¨¡å¼ä¸­çš„å‘½ä»¤è¡Œè‡ªåŠ¨å®Œæˆæ“ä½œ set wildmenu \u0026quot; ä½¿å›æ ¼é”®ï¼ˆbackspaceï¼‰æ­£å¸¸å¤„ç†indent, eol, startç­‰ set backspace=2 \u0026quot; å…è®¸backspaceå’Œå…‰æ ‡é”®è·¨è¶Šè¡Œè¾¹ç•Œ set whichwrap+=\u0026lt;,\u0026gt;,h,l \u0026quot; å¯ä»¥åœ¨bufferçš„ä»»ä½•åœ°æ–¹ä½¿ç”¨é¼ æ ‡ï¼ˆç±»ä¼¼officeä¸­åœ¨å·¥ä½œåŒºåŒå‡»é¼ æ ‡å®šä½ï¼‰ \u0026quot;set mouse=a set selection=exclusive set selectmode=mouse,key \u0026quot; é€šè¿‡ä½¿ç”¨: commandså‘½ä»¤ï¼Œå‘Šè¯‰æˆ‘ä»¬æ–‡ä»¶çš„å“ªä¸€è¡Œè¢«æ”¹å˜è¿‡ set report=0 \u0026quot; åœ¨è¢«åˆ†å‰²çš„çª—å£é—´æ˜¾ç¤ºç©ºç™½ï¼Œä¾¿äºé˜…è¯» set fillchars=vert:\\ ,stl:\\ ,stlnc:\\ \u0026quot; é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ‹¬å· set showmatch \u0026quot; åŒ¹é…æ‹¬å·é«˜äº®çš„æ—¶é—´ï¼ˆå•ä½æ˜¯ååˆ†ä¹‹ä¸€ç§’ï¼‰ set matchtime=1 \u0026quot; å…‰æ ‡ç§»åŠ¨åˆ°bufferçš„é¡¶éƒ¨å’Œåº•éƒ¨æ—¶ä¿æŒ3è¡Œè·ç¦» set scrolloff=3 filetype plugin indent on \u0026quot;æ‰“å¼€æ–‡ä»¶ç±»å‹æ£€æµ‹, åŠ äº†è¿™å¥æ‰å¯ä»¥ç”¨æ™ºèƒ½è¡¥å…¨ set completeopt=longest,menu \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot; CTagsçš„è®¾å®š \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; let Tlist_Sort_Type = \u0026quot;name\u0026quot; \u0026quot; æŒ‰ç…§åç§°æ’åº let Tlist_Use_Right_Window = 1 \u0026quot; åœ¨å³ä¾§æ˜¾ç¤ºçª—å£ let Tlist_Compart_Format = 1 \u0026quot; å‹ç¼©æ–¹å¼ let Tlist_Exist_OnlyWindow = 1 \u0026quot; å¦‚æœåªæœ‰ä¸€ä¸ªbufferï¼Œkillçª—å£ä¹Ÿkillæ‰buffer \u0026quot;\u0026quot;let Tlist_File_Fold_Auto_Close = 0 \u0026quot; ä¸è¦å…³é—­å…¶ä»–æ–‡ä»¶çš„tags \u0026quot;\u0026quot;let Tlist_Enable_Fold_Column = 0 \u0026quot; ä¸è¦æ˜¾ç¤ºæŠ˜å æ ‘ \u0026quot;let Tlist_Show_One_File=1 \u0026quot;ä¸åŒæ—¶æ˜¾ç¤ºå¤šä¸ªæ–‡ä»¶çš„tagï¼Œåªæ˜¾ç¤ºå½“å‰æ–‡ä»¶çš„ \u0026quot;è®¾ç½®tags set tags=tags; \u0026quot;set autochdir \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot;é»˜è®¤æ‰“å¼€Taglist let Tlist_Auto_Open=0 \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; \u0026quot; Tag list (ctags) \u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot;\u0026quot; let Tlist_Ctags_Cmd = '/usr/local/bin/ctags' let Tlist_Show_One_File = 1 \u0026quot;ä¸åŒæ—¶æ˜¾ç¤ºå¤šä¸ªæ–‡ä»¶çš„tagï¼Œåªæ˜¾ç¤ºå½“å‰æ–‡ä»¶çš„ let Tlist_File_Fold_Auto_Close = 1 let Tlist_Exit_OnlyWindow = 1 \u0026quot;å¦‚æœtaglistçª—å£æ˜¯æœ€åä¸€ä¸ªçª—å£ï¼Œåˆ™é€€å‡ºvim let Tlist_Use_Right_Window = 1 \u0026quot;åœ¨å³ä¾§çª—å£ä¸­æ˜¾ç¤ºtaglistçª—å£ \u0026quot; minibufexplæ’ä»¶çš„ä¸€èˆ¬è®¾ç½® let g:miniBufExplMapWindowNavVim = 1 let g:miniBufExplMapWindowNavArrows = 1 let g:miniBufExplMapCTabSwitchBufs = 1 let g:miniBufExplModSelTarget = 1 nmap tl :Tlist\u0026lt;cr\u0026gt; set rtp+=~/.vim/bundle/vundle/ let g:indentLine_char = 'â”Š' \u0026quot; \u0026quot;ctrlpè®¾ç½® \u0026quot; set wildignore+=*/tmp/*,*.so,*.swp,*.zip,*.pyc,*.png,*.jpg,*.gif \u0026quot; MacOSX/Linux set wildignore+=*\\\\tmp\\\\*,*.swp,*.zip,*.exe,*.pyc,*.png,*.jpg,*.gif \u0026quot; Windows let g:ctrlp_custom_ignore = '\\v[\\/]\\.(git|hg|svn)$' let g:ctrlp_custom_ignore = '\\v\\.(exe|so|dll)$' let g:ctrlp_extensions = ['funky'] let NERDTreeIgnore=['\\.pyc'] \u0026quot;, \u0026quot;JavaScript\u0026quot;) } ","date":"2022-07-23T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BC%96%E8%BE%91%E5%99%A8/1_hu3b1364509ee92ba594c04f8ddadc5a1f_100499_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BC%96%E8%BE%91%E5%99%A8/","title":"è®¾ç½®è‡ªå·±çš„ç¼–è¾‘å™¨"},{"content":"redis GOè¯­è¨€å®è·µäºŒ ç®€å•ä»‹ç»  ä½¿ç”¨go è¯­è¨€æ“ä½œredisæ•°æ®åº“ ä½¿ç”¨çš„åº“ä¸ºï¼šgo get -u github.com/go-redis/redis å¯¹redisæ•°æ®åº“çš„mapï¼Œé›†åˆå’Œæœ‰åºé›†åˆçš„æ“ä½œ  ä»£ç å¦‚ä¸‹ /*æ“ä½œhash Mapæ•°æ®ç±»å‹*/ func (r *RedisInfo)OperaHashMap(){ //æ·»åŠ å•ä¸ªæ•°æ® \terr := r.RedisDb.HSet(\u0026#34;hKey\u0026#34;,\u0026#34;filed0\u0026#34;, \u0026#34;value0\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;æ·»åŠ å•ä¸ªæ•°æ®å¤±è´¥\u0026#34;, err) return } // æ‰¹é‡æ·»åŠ æ•°æ® \thData := make(map[string]interface{}) hData[\u0026#34;filed1\u0026#34;] = \u0026#34;value1\u0026#34; hData[\u0026#34;filed2\u0026#34;] = \u0026#34;value2\u0026#34; hData[\u0026#34;filed3\u0026#34;] = \u0026#34;value3\u0026#34; hData[\u0026#34;filed4\u0026#34;] = 20 hData[\u0026#34;filed5\u0026#34;] = 12.5 err = r.RedisDb.HMSet(\u0026#34;hKey\u0026#34;, hData).Err() if err != nil { fmt.Println(\u0026#34;æ‰¹é‡æ·»åŠ æ•°æ®å¤±è´¥\u0026#34;,err) return } // å•ä¸ªè·å–æ•°æ® \tvalue, err := r.RedisDb.HGet(\u0026#34;hKey\u0026#34;, \u0026#34;filed0\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;å•ä¸ªè·å–æ•°å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;value is \u0026#34;, value) // æ•´æ•°æ•°æ®çš„è‡ªå¢ \terr = r.RedisDb.HIncrBy(\u0026#34;hKey\u0026#34;, \u0026#34;filed4\u0026#34;, 50 ).Err() if err != nil { fmt.Println(\u0026#34;æ•´æ•°æ•°æ®çš„è‡ªå¢å¤±è´¥\u0026#34;, err) return } // æµ®ç‚¹æ•°æ•°æ®çš„è‡ªå¢ \terr = r.RedisDb.HIncrByFloat(\u0026#34;hKey\u0026#34;, \u0026#34;filed5\u0026#34;, 52.64).Err() if err != nil { fmt.Println(\u0026#34;æµ®ç‚¹æ•°æ•°æ®çš„è‡ªå¢å¤±è´¥\u0026#34;, err) return } // è·å–æ‰€æœ‰å­—æ®µå \tkeys, _:= r.RedisDb.HKeys(\u0026#34;hKey\u0026#34;).Result() fmt.Println(\u0026#34;keys is \u0026#34;, keys) // è·å–å­—æ®µæ•°é‡ \tkLen, _ := r.RedisDb.HLen(\u0026#34;hKey\u0026#34;).Result() fmt.Println(\u0026#34;kLen is \u0026#34;, kLen) // æ‰¹é‡è·å–æ•°æ® \tvalues, err := r.RedisDb.HMGet(\u0026#34;hKey\u0026#34;, \u0026#34;filed1\u0026#34;, \u0026#34;filed2\u0026#34;,\u0026#34;filed3\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;æ‰¹é‡è·å–æ•°æ®å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;values is \u0026#34;, values) // åˆ é™¤æ•°æ® \terr = r.RedisDb.HDel(\u0026#34;hKey\u0026#34;, \u0026#34;filed1\u0026#34;, \u0026#34;filed0\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;åˆ é™¤æ•°æ®å¤±è´¥\u0026#34;,err) return } // åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ \tok, _ := r.RedisDb.HExists(\u0026#34;hKey\u0026#34;, \u0026#34;filed1\u0026#34;).Result() if ok{ fmt.Println(\u0026#34;filed1 is å­˜åœ¨çš„\u0026#34;) }else{ fmt.Println(\u0026#34;filed1 is ä¸å­˜åœ¨çš„\u0026#34;) } // è·å–æ‰€æœ‰æ•°æ® \tallValues, err := r.RedisDb.HGetAll(\u0026#34;hKey\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;è·å–æ‰€æœ‰æ•°æ®\u0026#34;, err) return } fmt.Println(\u0026#34;allValues is \u0026#34;, allValues) } /*æ“ä½œseté›†åˆ*/ func (r *RedisInfo) OperaSet() { // æ·»åŠ æ•°æ® \terr := r.RedisDb.SAdd(\u0026#34;sKey\u0026#34;, \u0026#34;test1\u0026#34;,\u0026#34;value1\u0026#34;, 10, 25,3.215).Err() err = r.RedisDb.SAdd(\u0026#34;sKey1\u0026#34;, \u0026#34;value1\u0026#34;, 110, 25,3.215, \u0026#34;ff\u0026#34;,\u0026#34;zvj\u0026#34;,25).Err() if err != nil { fmt.Println(\u0026#34;æ·»åŠ æ•°æ®å¤±è´¥\u0026#34;, err) return } // è·å–æ•°æ®ä¸ªæ•° \tcLen, _ := r.RedisDb.SCard(\u0026#34;sKey\u0026#34;).Result() fmt.Println(\u0026#34;cLen is \u0026#34;, cLen) // åˆ é™¤ç¬¬ä¸€ä¸ªæ•°æ® \tfData, _ := r.RedisDb.SPop(\u0026#34;sKey\u0026#34;).Result() fmt.Println(\u0026#34;ç¬¬ä¸€ä¸ªæ•°æ®ä¸ºï¼š\u0026#34;, fData) // åˆ é™¤æŸä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›é›†åˆæ•°é‡ \tcLen, _ = r.RedisDb.SRem(\u0026#34;sKey\u0026#34;, \u0026#34;value1\u0026#34;).Result() fmt.Println(\u0026#34;åˆ é™¤åcLen is \u0026#34;, cLen) // åˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨ \tok, _ := r.RedisDb.SIsMember(\u0026#34;sKey\u0026#34;, \u0026#34;value1\u0026#34;).Result() if ok{ fmt.Println(\u0026#34;value1 is å­˜åœ¨\u0026#34;) }else { fmt.Println(\u0026#34;value1 is ä¸å­˜åœ¨\u0026#34;) } // è·å–æ‰€æœ‰é›†åˆæ•°æ® \tsDataS, _ := r.RedisDb.SMembers(\u0026#34;sKey\u0026#34;).Result() fmt.Println(\u0026#34;sDataS is \u0026#34;, sDataS) // æ±‚äº¤é›†å¹¶ä¿å­˜åœ¨æŸä¸ªé›†åˆä¸­ \tdataLen, _ := r.RedisDb.SInterStore(\u0026#34;sInterStore\u0026#34;, \u0026#34;sKey\u0026#34;, \u0026#34;sKey1\u0026#34;).Result() fmt.Println(\u0026#34;äº¤é›†æ•°æ®ä¸ªæ•°ä¸ºï¼š\u0026#34;, dataLen) // æ±‚å·®é›†å¹¶ä¿å­˜åœ¨æŸä¸ªé›†åˆä¸­ \tdataLen, _ = r.RedisDb.SDiffStore(\u0026#34;sDiffStore\u0026#34;, \u0026#34;sKey\u0026#34;, \u0026#34;sKey1\u0026#34;).Result() fmt.Println(\u0026#34;å·®é›†æ•°æ®ä¸ªæ•°ä¸ºï¼š\u0026#34;, dataLen) // æ±‚å¹¶é›†å¹¶ä¿å­˜åœ¨æŸä¸ªé›†åˆä¸­ \tdataLen, _ = r.RedisDb.SUnionStore(\u0026#34;sUnionStore\u0026#34;, \u0026#34;sKey\u0026#34;, \u0026#34;sKey1\u0026#34;).Result() fmt.Println(\u0026#34;å¹¶é›†æ•°æ®ä¸ªæ•°ä¸ºï¼š\u0026#34;, dataLen) } /*æ“ä½œæœ‰åºé›†åˆ*/ func (r *RedisInfo) OperaSortSet() { // æ·»åŠ æ•°æ® \tlanguages := [] redis.Z{ {Score: 90.0, Member: \u0026#34;Golang\u0026#34;}, {Score: 98.0, Member: \u0026#34;Java\u0026#34;}, {Score: 95.0, Member: \u0026#34;Python\u0026#34;}, {Score: 97.0, Member: \u0026#34;JavaScript\u0026#34;}, {Score: 92.0, Member: \u0026#34;C/C++\u0026#34;}, } num, err := r.RedisDb.ZAdd(\u0026#34;zKey\u0026#34;, languages...).Result() if err != nil { fmt.Println(\u0026#34;æ·»åŠ æ•°æ®\u0026#34;, err) return } fmt.Println(\u0026#34;add æ•°æ®ç»™ä¸ªæ•°ä¸º\u0026#34;, num) // å¢åŠ åˆ†æ—¶ \terr = r.RedisDb.ZIncrBy(\u0026#34;zKey\u0026#34;, 3, \u0026#34;Golang\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;å¢åˆ†æ•°å¤±è´¥\u0026#34;, err) return } // è¿”å›æ•°æ®ä¸ªæ•° \tzLen, _ := r.RedisDb.ZCard(\u0026#34;zKey\u0026#34;).Result() fmt.Println(\u0026#34;zLen is \u0026#34;, zLen) // ç»Ÿè®¡åˆ†æ•°æ®µçš„å…ƒç´ ä¸ªæ•° \tzLen, _ = r.RedisDb.ZCount(\u0026#34;zKey\u0026#34;, \u0026#34;0\u0026#34;, \u0026#34;150\u0026#34;).Result() fmt.Println(\u0026#34;count zLen is \u0026#34;, zLen) // æ’åº \tvalue, _ := r.RedisDb.ZRange(\u0026#34;zKey\u0026#34;, 0,-1).Result() fmt.Println(\u0026#34;value is \u0026#34;, value) // åˆ é™¤æŸä¸ªå…ƒç´  \tr.RedisDb.ZRem(\u0026#34;zKey\u0026#34;, \u0026#34;JavaScript\u0026#34;) } ","date":"2022-07-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/redis-go%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%E4%BA%8C/1_hu38514b36fb33d89c48254822293248c6_47054_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/redis-go%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%E4%BA%8C/","title":"redis GOè¯­è¨€å®è·µäºŒ"},{"content":"redis GOè¯­è¨€å®è·µä¸€ ç®€å•ä»‹ç»  ä½¿ç”¨go è¯­è¨€æ“ä½œredisæ•°æ®åº“ ä½¿ç”¨çš„åº“ä¸ºï¼šgo get -u github.com/go-redis/redis å¯¹redisæ•°æ®åº“çš„è¿æ¥ï¼Œå¯¹å­—ç¬¦ä¸²å’Œåˆ—è¡¨çš„æ“ä½œ  ä»£ç å¦‚ä¸‹ package main import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/go-redis/redis\u0026#34; \u0026#34;log\u0026#34; \u0026#34;time\u0026#34; ) const ( ADDR = \u0026#34;192.168.1.128:6379\u0026#34; PASSWORD = \u0026#34;\u0026#34; DB = 0 ) type RedisInfo struct { Option *redis.Options RedisDb *redis.Client } // è¿æ¥redisæ•°æ®åº“ func (r *RedisInfo)ConnRedis() error{ redisDb := redis.NewClient(r.Option) // åˆ¤æ–­æ˜¯å¦æˆåŠŸè¿æ¥æ•°æ®åº“ \t_, err := redisDb.Ping().Result() if err != nil { return err } r.RedisDb = redisDb return nil } /* æ“ä½œå­—ç¬¦ä¸²ç±»å‹ */ // æ“ä½œset/get func (r *RedisInfo)OperaStringSGet() { // æ·»åŠ key/value å¯è®¾ç½®è¿‡æœŸæ—¶é—´ \terr := r.RedisDb.Set(\u0026#34;Key1\u0026#34;, \u0026#34;value1\u0026#34;, 4*time.Millisecond).Err() if err != nil { fmt.Println(\u0026#34;æ·»åŠ keyå¤±è´¥\u0026#34;, err) return } time.Sleep(4*time.Millisecond) // è·å–keyçš„å€¼ \tvalue, err := r.RedisDb.Get(\u0026#34;Key1\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;è·å–keyçš„å€¼å¤±è´¥\u0026#34;, err) return } if value == \u0026#34;\u0026#34;{ fmt.Println(\u0026#34;key ä¸å­˜åœ¨\u0026#34;) // å¦‚æœä¸å­˜åœ¨åˆ™å°±æ·»åŠ , ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ \tr.RedisDb.SetNX(\u0026#34;Key1\u0026#34;, \u0026#34;setnx value\u0026#34;, 0) }else { fmt.Printf(\u0026#34;è·å¾—valueï¼š%v \\n\u0026#34;, value) } } // æ“ä½œmset/mget func (r *RedisInfo)OperaStringMSGet() { // æ‰¹é‡æ·»åŠ key-value \terr := r.RedisDb.MSet(\u0026#34;key0\u0026#34;, \u0026#34;value0\u0026#34;, \u0026#34;key2\u0026#34;, \u0026#34;value2\u0026#34;, \u0026#34;key3\u0026#34;, \u0026#34;value3\u0026#34;,\u0026#34;key4\u0026#34;, \u0026#34;value4\u0026#34;).Err() if err != nil { fmt.Printf(\u0026#34;æ‰¹é‡æ·»åŠ key-value å¤±è´¥ %v \\n\u0026#34;, err) return } // æ‰¹é‡è·å–value \tvalues, err := r.RedisDb.MGet(\u0026#34;key0\u0026#34;,\u0026#34;key1\u0026#34;,\u0026#34;key2\u0026#34;,\u0026#34;key3\u0026#34;, \u0026#34;key4\u0026#34;).Result() if err != nil { fmt.Printf(\u0026#34;æ‰¹é‡è·å–value å¤±è´¥ï¼š%v \\n\u0026#34;, err) return } fmt.Printf(\u0026#34;values is : %v\\n\u0026#34;, values) // åˆ é™¤keys \terr = r.RedisDb.Del(\u0026#34;key0\u0026#34;).Err() if err != nil { fmt.Printf(\u0026#34;åˆ é™¤keys å¤±è´¥ %v\\n\u0026#34;, err) return } // è·å¾—æŒ‡å®šçš„keys \tkeys, err := r.RedisDb.Keys(\u0026#34;k*\u0026#34;).Result() if err != nil { fmt.Printf(\u0026#34; è·å¾—æŒ‡å®šçš„keys å¤±è´¥ %v\\n\u0026#34;, err) }else{ fmt.Printf(\u0026#34;keys is :%v\\n\u0026#34;, keys) } } // æ“ä½œè‡ªå¢è‡ªå‡ func (r *RedisInfo)OperaStringNcr(){ // å¢åŠ æ•°æ® \terr := r.RedisDb.Set(\u0026#34;score\u0026#34;, 120, 0).Err() if err != nil { fmt.Println(\u0026#34;å¢åŠ æ•°æ®å¤±è´¥\u0026#34;, err) return } //è‡ªå¢æ“ä½œ \terr = r.RedisDb.Incr(\u0026#34;score\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;è‡ªå¢å¤±è´¥\u0026#34;, err) return } value, _ := r.RedisDb.Get(\u0026#34;score\u0026#34;).Result() fmt.Printf(\u0026#34;æˆç»©ä¸º:%v\\n\u0026#34;, value) // æ­¥é•¿å¢åŠ  \terr = r.RedisDb.IncrBy(\u0026#34;score\u0026#34;, 10).Err() if err != nil { fmt.Println(\u0026#34;æ­¥é•¿å¢åŠ å¤±è´¥\u0026#34;, err) return } value, _ = r.RedisDb.Get(\u0026#34;score\u0026#34;).Result() fmt.Printf(\u0026#34;æˆç»©ä¸º:%v\\n\u0026#34;, value) // è‡ªå‡ \terr = r.RedisDb.Decr(\u0026#34;score\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;è‡ªå‡å¤±è´¥\u0026#34;, err) return } value, _ = r.RedisDb.Get(\u0026#34;score\u0026#34;).Result() fmt.Printf(\u0026#34;æˆç»©ä¸º:%v\\n\u0026#34;, value) // æ­¥é•¿å‡å°‘ \terr = r.RedisDb.DecrBy(\u0026#34;score\u0026#34;, -20).Err() if err != nil { fmt.Println(\u0026#34;æ­¥é•¿å‡å°‘å¤±è´¥\u0026#34;, err) return } value, _ = r.RedisDb.Get(\u0026#34;score\u0026#34;).Result() fmt.Printf(\u0026#34;æˆç»©ä¸º:%v\\n\u0026#34;, value) // æµ®ç‚¹æ•°çš„è‡ªå¢/è‡ªå‡ \terr = r.RedisDb.IncrByFloat(\u0026#34;score\u0026#34;, -20.5).Err() if err != nil { fmt.Println(\u0026#34;æµ®ç‚¹æ•°çš„è‡ªå¢/è‡ªå‡å¤±è´¥\u0026#34;, err) return } value, _ = r.RedisDb.Get(\u0026#34;score\u0026#34;).Result() fmt.Printf(\u0026#34;æˆç»©ä¸º:%v\\n\u0026#34;, value) } /* listç±»å‹çš„æ“ä½œ*/ // func (r *RedisInfo)OperaListLData() { // å·¦è¾¹Pushä»»æ„å¢åŠ key-value \terr := r.RedisDb.LPush(\u0026#34;Lkey1\u0026#34;, \u0026#34;Lvalue1\u0026#34;, \u0026#34;Lvalue2\u0026#34;, \u0026#34;Lvalue3\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;å·¦è¾¹Pushå¢åŠ keyå¤±è´¥ï¼š\u0026#34;, err) return } // å·¦è¾¹å¢åŠ æ•°æ®ï¼Œå½“listä¸å­˜åœ¨æ—¶ï¼Œä¸èƒ½å¢åŠ  \terr = r.RedisDb.LPushX(\u0026#34;LXkey\u0026#34;, \u0026#34;LXValue\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;å·¦è¾¹Pushå¢åŠ keyå¤±è´¥ï¼š\u0026#34;, err) return } // è·å¾—listé•¿åº¦ \tLLen, err := r.RedisDb.LLen(\u0026#34;Lkey1\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;è·å¾—listé•¿åº¦å¤±è´¥ï¼š\u0026#34;, err) return } fmt.Println(\u0026#34;Lkey1 list len is :\u0026#34;, LLen) // è·å–åˆ—è¡¨æ•°æ® \tLData, err := r.RedisDb.LRange(\u0026#34;Lkey1\u0026#34;, 0, -1).Result() if err != nil { fmt.Println(\u0026#34;è·å–åˆ—è¡¨æ•°æ®å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;åˆ—è¡¨æ•°æ®ä¸ºï¼š\u0026#34;, LData) // ä¿®æ”¹listä¸­å­˜åœ¨çš„value \terr = r.RedisDb.LSet(\u0026#34;Lkey1\u0026#34;, 1, \u0026#34;updateValue\u0026#34;).Err() if err != nil { fmt.Println(\u0026#34;ä¿®æ”¹å€¼å¤±è´¥\u0026#34;, err) return } // ç§»é™¤å¹¶è¿”å›listå·¦è¾¹ç¬¬ä¸€ä¸ªæ•°æ® \tPData, err := r.RedisDb.LPop(\u0026#34;Lkey1\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;ç§»é™¤æ•°æ®å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;PData is :\u0026#34;, PData) // ç§»é™¤listä¸­é‡å¤çš„value,countä¸º1æ—¶ï¼Œç§»é™¤ä¸€ä¸ª \tcount, err := r.RedisDb.LRem(\u0026#34;Lkey1\u0026#34;, 2,\u0026#34;Lvalue1\u0026#34;).Result() if err != nil { fmt.Println(\u0026#34;ç§»é™¤å¤šä¸ªé‡è¯»çš„valueå€¼å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;count is\u0026#34;, count) // åˆ—è¡¨ç´¢å¼•è·å¾—æ•°æ® \tdata, err := r.RedisDb.LIndex(\u0026#34;Lkey1\u0026#34;, 1).Result() if err != nil { fmt.Println(\u0026#34;è·å¾—æ•°æ®å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;data is \u0026#34;, data) // å°†æŸä¸ªæ•°æ®æ’å…¥åˆ°æŸä¸ªå€¼å‰(before)æ’å…¥åˆ°æŸä¸ªå€¼ä¹‹å(after) \terr = r.RedisDb.LInsert(\u0026#34;Lkey1\u0026#34;, \u0026#34;before\u0026#34;, \u0026#34;updateValue\u0026#34;, \u0026#34;insetData\u0026#34;).Err() //err := r.RedisDb.LInsertBefore(\u0026#34;Lkey1\u0026#34;, \u0026#34;updateValue\u0026#34;, \u0026#34;insetData\u0026#34;).Err() \tif err != nil { fmt.Println(\u0026#34;æ’å…¥æ•°æ®å¤±è´¥\u0026#34;, err) return } // æˆªå–åç§°ä¸ºkeyçš„list \tok, err := r.RedisDb.LTrim(\u0026#34;Lkey1\u0026#34;, 1,3).Result() if err != nil { fmt.Println(\u0026#34;è·å–æ–°çš„listå¤±è´¥\u0026#34;) return } fmt.Println( ok) LData, err = r.RedisDb.LRange(\u0026#34;Lkey1\u0026#34;, 0, -1).Result() if err != nil { fmt.Println(\u0026#34;è·å–åˆ—è¡¨æ•°æ®å¤±è´¥\u0026#34;, err) return } fmt.Println(\u0026#34;åˆ—è¡¨æ•°æ®ä¸ºï¼š\u0026#34;, LData) } func main() { opt := \u0026amp;redis.Options{ Network: \u0026#34;tcp\u0026#34;, // ç½‘ç»œç±»å‹ tcp æˆ–è€… unix. \tAddr: ADDR, OnConnect: nil, // æ–°å»ºä¸€ä¸ªredisè¿æ¥çš„æ—¶å€™ï¼Œä¼šå›è°ƒè¿™ä¸ªå‡½æ•° \tPassword: PASSWORD, // redisæ•°æ®åº“è¿æ¥çš„å¯†ç  \tDB: DB, // redisæ•°æ®åº“ï¼Œåºå·ä»0å¼€å§‹ï¼Œé»˜è®¤æ˜¯0ï¼Œå¯ä»¥ä¸ç”¨è®¾ç½® \tMaxRetries: 5, // redisæ“ä½œå¤±è´¥æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸é‡è¯•ã€‚ \t/* MinRetryBackoff: 0, // æœ€å°é‡è¯•æ—¶é—´é—´éš” é»˜è®¤æ˜¯ 8ms ; -1 è¡¨ç¤ºå…³é—­ MaxRetryBackoff: 0, // æœ€å°é‡è¯•æ—¶é—´é—´éš” é»˜è®¤æ˜¯ 512ms ; -1 è¡¨ç¤ºå…³é—­ DialTimeout: 0, // redisè¿æ¥è¶…æ—¶æ—¶é—´. é»˜è®¤ä¸º5ç§’ ReadTimeout: 0, // socketè¯»å–è¶…æ—¶æ—¶é—´ é»˜è®¤æ—¶é—´ä¸º3ç§’ WriteTimeout: 0, // socketå†™è¶…æ—¶æ—¶é—´ PoolSize: 0, // redisè¿æ¥æ± çš„æœ€å¤§è¿æ¥æ•°.é»˜è®¤è¿æ¥æ± å¤§å°ç­‰äº cpuä¸ªæ•° * 10 MinIdleConns: 0, //redisè¿æ¥æ± æœ€å°ç©ºé—²è¿æ¥æ•°. MaxConnAge: 0, // redisè¿æ¥æœ€å¤§çš„å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤ä¸ä¼šå…³é—­è¿‡æ—¶çš„è¿æ¥. PoolTimeout: 0, // å½“ä½ ä»redisè¿æ¥æ± è·å–ä¸€ä¸ªè¿æ¥ä¹‹åï¼Œè¿æ¥æ± æœ€å¤šç­‰å¾…è¿™ä¸ªæ‹¿å‡ºå»çš„è¿æ¥å¤šé•¿æ—¶é—´ã€‚ é»˜è®¤æ˜¯ç­‰å¾… ReadTimeout + 1 ç§’. IdleTimeout: 0, // redisè¿æ¥æ± å¤šä¹…ä¼šå…³é—­ä¸€ä¸ªç©ºé—²è¿æ¥. é»˜è®¤æ˜¯ 5 åˆ†é’Ÿ. -1 åˆ™è¡¨ç¤ºå…³é—­è¿™ä¸ªé…ç½®é¡¹ IdleCheckFrequency: 0, // å¤šé•¿æ—¶é—´æ£€æµ‹ä¸€ä¸‹ï¼Œç©ºé—²è¿æ¥ é»˜è®¤æ˜¯ 1 åˆ†é’Ÿ. -1 è¡¨ç¤ºå…³é—­ç©ºé—²è¿æ¥æ£€æµ‹ TLSConfig: nil, // è¦ä½¿ç”¨çš„TLSé…ç½®ã€‚è®¾ç½®TLSæ—¶å°†è¿›è¡Œåå•† */ } redisClient := \u0026amp;RedisInfo{ Option: opt, RedisDb: nil, } err := redisClient.ConnRedis() if err != nil { log.Fatal(\u0026#34;redis æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ï¼ï¼\u0026#34;, err) } fmt.Println(\u0026#34;æ•°æ®åº“è¿æ¥æˆåŠŸ\u0026#34;) redisClient.OperaStringSGet() redisClient.OperaStringMSGet() redisClient.OperaStringNcr() redisClient.OperaListLData() } ","date":"2022-07-08T22:00:38+08:00","image":"https://zcj-git520.github.io/p/redis-go%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%E4%B8%80/1_hu92e993ca1384cf9d7fc0be4e9454fb8f_41826_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/redis-go%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%E4%B8%80/","title":"redis GOè¯­è¨€å®è·µä¸€"},{"content":"redis å¸¸ç”¨å‘½ä»¤çš„å®è·µ ç»“æ„åŒ–ä¸éç»“æ„åŒ–   å…³ç³»å‹æ•°æ®åº“\n ç»“æ„åŒ– å…³è”æ€§ sqlæŸ¥è¯¢ æ»¡è¶³äº‹åŠ¡çš„ACID  ![](C:\\Users\\90953\\AppData\\Roaming\n  éå…³ç³»å‹æ•°æ®\n éç»“æ„åŒ– æ— å…³è”æ€§ ésql base(åŸºç¡€æ€§çš„äº‹åŠ¡)    \r\nredis é€šç”¨å‘½ä»¤ é€šç”¨æŒ‡ä»¤æ˜¯éƒ¨åˆ†æ•°æ®ç±»å‹çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œå¸¸è§çš„æœ‰ï¼š\n KEYS:æŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰key delï¼šåˆ é™¤æŒ‡å®šçš„key exists:åˆ¤è¯»keyæ˜¯å¦å­˜åœ¨ expire:ç»™ä¸€ä¸ªå¯ä»¥è®¾ç½®æœ‰æ•ˆæœŸï¼ˆå•ä½æ—¶é—´ä¸ºsï¼‰ï¼Œæœ‰æ•ˆæœŸåˆ°æ—¶ä¼šè‡ªåŠ¨åˆ é™¤key ttl:æŸ¥çœ‹keyçš„æœ‰æ•ˆæœŸ  \r\nstring ç±»å‹å¸¸ç”¨å‘½ä»¤ stringç±»å‹æ˜¯redisä¸­æœ€ç®€å•çš„å­˜å‚¨ç±»å‹ï¼Œå…¶valueæ˜¯å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²å¯ä»¥åˆ†ä¸º3ç±»ï¼š\n  string:æ™®é€šå­—ç¬¦ä¸²\n  intï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥è‡ªå¢æˆ–è‡ªå‡\n  float:æµ®ç‚¹å‹ï¼Œå¯ä»¥è‡ªå¢æˆ–è‡ªå‡\næ— è®ºæ˜¯å“ªä¸€ç§æ ¼å¼ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œåªä¸è¿‡æ˜¯ç¼–ç ä¸åŒï¼Œå­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸è¶…è¿‡512M\n\r\n  å¸¸ç”¨çš„å‘½ä»¤æœ‰ï¼š   set:æ·»åŠ æˆ–è€…ä¿®æ”¹ä¹Ÿå­˜åœ¨çš„çš„ä¸€ä¸ªstringç±»å‹çš„é”®å€¼å¯¹\n  get:æ ¹æ®keyè·å–stringç±»å‹çš„value\n  mset:æ‰¹é‡æ·»åŠ å¤šä¸ªstinglç±»å‹çš„é”®å€¼å¯¹\n  mget:æ ¹æ®å¤šä¸ªkeyè·å–å¤šä¸ªstringç±»å‹çš„value\n  incr:è®©ä¸€ä¸ªintçš„keyè‡ªå¢1\n  incrby:è®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿\n  incrbyfloat:è®©ä¸€ä¸ªæµ®ç‚¹æ•°çš„æ•°å€¼è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿\n  setnx:æ·»åŠ ä¸€ä¸ªstringç±»å‹çš„é”®å€¼å¯¹ï¼Œå½“keyå­˜åœ¨æ—¶ï¼Œä¸æ‰§è¡Œ\n  setex:æ·»åŠ ä¸€ä¸ªstringç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”è®¾ç½®æœ‰æ•ˆæœŸ\n\r\n  keyçš„ç»“æ„ redisçš„keyå…è®¸æœ‰å¤šä¸ªå•è¯å½¢æˆå±‚çº§ç»“æ„ï¼Œæœ‰å¤šä¸ªå•è¯ä¹‹é—´ç”¨â€œï¼šâ€éš”å¼€;\næ ¼å¼å¦‚ä¸‹ï¼šé¡¹ç›®åï¼šä¸šåŠ¡åï¼šç±»å‹ï¼šid;\n ä¾‹å¦‚ï¼šuserç›¸å…³çš„key:sysd:user:1 ä¾‹å¦‚ï¼šäº§å“ç›¸ç›¸å…³çš„key:sysd:product:1  \r\n\r\nHASHç±»å‹ hashç±»å‹æ˜¯å«æ•£åˆ—ï¼Œå…¶valueæ˜¯ä¸€ä¸ªæ— åºçš„å­—å…¸ï¼Œhashçš„ç»“æ„å¯ä»¥å°†å¯¹è±¡çš„æ¯ä¸ªå•ç‹¬çš„å­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥å¯¹æ¯ä¸ªå­—æ®µåšCRUD;\nå¸¸ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š   hset key fileld value :æ·»åŠ æˆ–è€…ä¿®æ”¹hashç±»å‹keyçš„fileldçš„å€¼\n  hget key fileld: è·å–ä¸€ä¸ªhashç±»å‹çš„fileldçš„å€¼\n  hmset: æ‰¹é‡æ·»åŠ å¤šä¸ªhashç±»å‹çš„keyçš„fieldçš„å€¼\n  hmgetï¼šæ‰¹é‡è·å–å¤šä¸ªhashç±»å‹çš„keyde fileldçš„å€¼\n  hgetall:è·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„fileldå’Œvalue\n  hkeys:è·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„filed\n  hvale:è·å–ä¸€ä¸ªhashç±»å‹ä¸­çš„keyçš„æ‰€æœ‰value\n  hincrby:è®©ä¸€ä¸ªhashç±»å‹keyçš„å­—æ®µå€¼è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿\n  hseinx:æ·»åŠ ä¸€ä¸ªhashç±»å‹çš„keyçš„fileldå€¼ï¼Œè‹¥å­˜åœ¨åˆ™æ­¥æ·»åŠ \n\r\n  â€‹\t\r\nLISTç±»å‹ redisä¸­çš„listå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œæ”¯æŒæ­£å‘ä¸åå‘çš„æ£€ç´¢ï¼Œæœ‰ä»¥ä¸‹ç‰¹å¾ï¼š\n æœ‰åº å…ƒç´ å¯ä»¥é‡å¤ æ’å…¥ä¸åˆ é™¤å¿« æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬  å¸¸ç”¨çš„å‘½ä»¤  lpush key valueâ€¦â€¦ ï¼šå‘å·¦æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´  lpop key ï¼šç§»é™¤å·¦è¾¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰å°±è¿”å›nil rpush key valueâ€¦â€¦ï¼šå‘å³æ’å…¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´  Rrpop key:ç§»é™¤å¹¶è¿”å›å³ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰å°±è¿”å›nil lrang key star end:è¿”å›ä¸€æ®µè§’æ ‡èŒƒå›´å†…æ‰€æœ‰å…ƒç´  blpopå’Œbrpop:ä¸lpopå’Œrpopç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…çš„æ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›nil  \r\n\r\nsetç±»å‹ redisä¸­çš„setç»“æ„å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªvalueä¸ºnilçš„hashmapã€‚å…·å¤‡ä¸€ä¸‹ç‰¹å¾ï¼š\n æ— åº å…ƒç´ ä¸å¯é‡å¤ æŸ¥æ‰¾å¿« æ”¯æŒäº¤é›†/å¹¶é›†/å·®é›†ç­‰åŠŸèƒ½  å¸¸ç”¨çš„å‘½ä»¤   sadd key number â€¦â€¦ï¼šå‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ \n  srem key number â€¦â€¦ï¼šç§»é™¤setä¸­æŒ‡å®šçš„å…ƒç´ \n  scard key:è¿”å›setä¸­çš„å…ƒç´ ä¸ªæ•°\n  sismembre key member:åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨ä¸ä¸€ä¸ªsetä¸­\n  smembers:è·å–setä¸­æ‰€æœ‰çš„å…ƒç´ \n  sinter key1 key2â€¦â€¦ï¼šæ±‚é›†åˆä¹‹é—´çš„äº¤é›†\n  sdiff key1 key2â€¦â€¦ï¼šé›†åˆä¹‹é—´çš„å·®é›†\n  sunion key1 key2â€¦â€¦ï¼šé›†åˆä¹‹é—´çš„å¹¶é›†\n\r\n  â€‹\t\r\nSortedSetç±»å‹ redisçš„sortedsetæ˜¯ä¸€ä¸ªæœ‰åºçš„é›†åˆï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ªscoreçš„å±æ€§ï¼Œå¯ä»¥åŸºäºscoreå±æ€§å¯¹å…ƒç´ è¿›è¡Œæ’åºï¼Œå…¶åº•å±‚æ˜¯ä¸€ä¸ªç”±ä¸€ä¸ªè·³è·ƒè¡¨å’Œhashè¡¨å®ç°ï¼Œå…¶å…·å¤‡ä¸€ä¸‹ç‰¹æ€§ï¼š\n å¯æ’åº å…ƒç´ ä¸å¯é‡å¤ æŸ¥è¯¢é€Ÿåº¦å¿«  å¸¸ç”¨å‘½ä»¤   zadd key score member: æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ åˆ°æœ‰åºé›†åˆä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°å…¶score\n  zrem key member:åˆ é™¤æœ‰åºé›†åˆä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ \n  zscore key member:è·å–æŒ‡å®šå…ƒç´ çš„çš„scoreå€¼\n  zrank key member:è·å–æœ‰åºé›†åˆå…ƒç´ çš„æ’å\n  zcard key:è·å–æœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°\n  zcount key min max:ç»Ÿè®¡scoreå€¼åœ¨ç»™å®šèŒƒå›´å†…ä¸­çš„æ‰€æœ‰å…ƒç´ å’Œä¸ªæ•°\n  zincrby key increment member:è®©æœ‰åºé›†åˆä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œæ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼\n  zrange key min max:æŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šæ’åèŒƒå›´çš„å…ƒç´ \n  zrangebyscore key min max:æŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šçš„scoreèŒƒå›´çš„å…ƒç´ \n  zdiff/zinter/zuninon:æ±‚å·®é›†/äº¤é›†/å¹¶é›†\næ³¨æ˜ï¼šæ’åé»˜è®¤ä¸ºå‡åºï¼Œrevä¸ºé™åº\n\r\n  â€‹\t\r\n","date":"2022-07-01T22:00:38+08:00","image":"https://zcj-git520.github.io/p/redis-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E8%B7%B5/image-20220703184326525_hu8f470d54622ce88b90e96a39d1a48252_105753_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/redis-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E8%B7%B5/","title":"redis å¸¸ç”¨å‘½ä»¤çš„å®è·µ"},{"content":"diskText  ç›´æ¥è·³è¿‡æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¹ç£ç›˜æ•°æ®è¿›è¡Œè¯»å†™ï¼Œåˆ¤æ–­ç£ç›˜æµ‹è¯•æ•°æ®è¯»å†™æ ¡éªŒæ•°æ®æ˜¯å¦ä¸¢å¤±  ç£ç›˜ä¿¡æ¯ type DiskSizeInfo struct { DiskPath string // ç£ç›˜å \tSrcMap map[string]string // æµ‹è¯•æ•°æ®é›†(æ–‡ä»¶å¤¹/æ ¡éªŒæ•°æ®) \tSize int // ç£ç›˜åˆ†ç»„å¤§å° \tSeekSize int\t// ç£ç›˜æ•°æ®åç§» \tBlockSize int // è¯»å†™ç£ç›˜æ•°æ®çš„å¤§å° } ä½¿ç”¨ä¸¤ç§æ–¹å¼è·³è¿‡æ–‡ä»¶ç³»ç»Ÿç›´æ¥å¯¹ç£ç›˜è¿›è¡Œè¯»å†™  ç›´æ¥è¯»å†™ç£ç›˜  // ç£ç›˜çš„å†™å…¥ func (d *DiskSizeInfo)DiskWriteByFile(src string) error // è¯»å–ç£ç›˜ func (d *DiskSizeInfo)DiskReadByFile() ([]byte, error) â€‹\t2.é€šè¿‡ddå‘½ä»¤è¡Œå¯¹ç£ç›˜è¿›è¡Œè¯»è€…\n// é€šè¿‡ddå‘½ä»¤å†™äºç£ç›˜ func (d *DiskSizeInfo)WriteDisk(staPos int, iFile string) error // é€šè¿‡ddå‘½ä»¤è¯»å–ç£ç›˜æ•°æ® func (d *DiskSizeInfo)ReadDisk(staPos int, oFile string) error å¯¹ç£ç›˜å·²æœ‰æ•°æ®è¿›è¡Œæ ¡éªŒ func (d *DiskSizeInfo)CheckReadDisk(src string, i int) ç£ç›˜æ ¡éªŒæ•°æ®çš„ç±»å‹çš„è¿”å› func (d *DiskSizeInfo)DiskDatatype( i int) å¾ªç¯é€šè¿‡æ•°æ®é›†è¿›è¡Œæ ¡éªŒ func (d *DiskSizeInfo)Run() error åˆå§‹åŒ–æ ¡éªŒé›†æ•°æ®æ–‡ä»¶ func (d *DiskSizeInfo)initFile()error ç£ç›˜çš„æŒ‚èµ·æˆ–è€…å¸è½½ï¼ˆé’ˆå¯¹ä¸å¸¦æ–‡ä»¶ç³»ç»Ÿï¼‰å’Œç£ç›˜æ¸…é™¤ func (d *DiskSizeInfo)MountDisk(src string) error func (d *DiskSizeInfo)ClearDisk(src string) error åˆå§‹åŒ–æ ¡éªŒé›†æ•°æ®æ–‡ä»¶ func (d *DiskSizeInfo)initFile() å…¶ä»–åŠŸèƒ½ æ–‡ä»¶é€šè¿‡md5æ ¡éªŒæ¯”è¾ƒ func FileCompare(src, dst string) (bool, error) ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œå‡½æ•° func fileCheckSum(fileName string) (string, error) //PathExists åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ //è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼Œæ ¹æ®è¿”å›çš„boolå€¼æ¥åˆ¤æ–­æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ func PathExists(path string) (bool,error) æ ¡éªŒæ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨æ ¡éªŒå€¼ func CheckFileData(data []byte, check string) bool æºç   æˆ‘çš„github:https://github.com/zcj-git520/diskTest  ","date":"2022-06-20T22:00:38+08:00","image":"https://zcj-git520.github.io/p/disk-test/1_hu4b9f21e0357fa4a3de89be2058c4c1e0_86402_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/disk-test/","title":"Disk Test"},{"content":"mdadm mdadmæ˜¯linuxä¸‹çš„ä¸€æ¬¾æ ‡å‡†çš„RAIDçš„ç®¡ç†å·¥å…·\nåŸºæœ¬è¯­æ³• mdadm [mode] [option] ç›®å‰æ”¯æŒ RAID0(striping), RAID1(mirroring), RAID4, RAID5, RAID6, RAID10, MULTIPATHå’ŒFAULTY\næ¨¡å¼  Assembleï¼šåŠ å…¥ä¸€ä¸ªä»¥å‰å®šä¹‰çš„é˜µåˆ— Buildï¼šåˆ›å»ºä¸€ä¸ªæ²¡æœ‰è¶…çº§å—çš„é˜µåˆ— Createï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é˜µåˆ—ï¼Œæ¯ä¸ªè®¾å¤‡å…·æœ‰è¶…çº§å—ï¼› -l,\u0026ndash;level: RAIDçº§åˆ« -n,\u0026ndash;raid-devices: æ´»åŠ¨è®¾å¤‡ä¸ªæ•° -a {yes|no}: æ˜¯å¦è‡ªåŠ¨ä¸ºå…¶åˆ›å»ºè®¾å¤‡æ–‡ä»¶ -c,\u0026ndash;chunk: CHUNKå¤§å°, é»˜è®¤ä¸º64Kï¼Œé‡è¦çš„å‚æ•°,å†³å®šäº†ä¸€æ¬¡å‘é˜µåˆ—ä¸­æ¯ä¸ªç£ç›˜å†™å…¥æ•°æ®çš„å¤§å° -x,\u0026ndash;spare-devices: å¤‡ç”¨ç›˜ä¸ªæ•° Manageï¼š ç®¡ç†é˜µåˆ—(å¦‚æ·»åŠ å’Œåˆ é™¤) Miscï¼šå…è®¸å•ç‹¬å¯¹é˜µåˆ—ä¸­çš„æŸä¸ªè®¾å¤‡è¿›è¡Œæ“ä½œ(å¦‚åœæ­¢é˜µåˆ—) Follow or Monitor:ç›‘æ§RAIDçš„çŠ¶æ€ Growï¼šæ”¹å˜RAIDçš„å®¹é‡æˆ–é˜µåˆ—ä¸­çš„è®¾å¤‡æ•°ç›® ï¼›-n,\u0026ndash;raid-devices=: æ´»åŠ¨è®¾å¤‡ä¸ªæ•°-x,\u0026ndash;spare-devices=ï¼šå¤‡ç”¨ç›˜ä¸ªæ•°-c,\u0026ndash;chunk=: CHUNKå¤§å°, é»˜è®¤ä¸º64Kï¼Œé‡è¦çš„å‚æ•°,å†³å®šäº†ä¸€æ¬¡å‘é˜µåˆ—ä¸­æ¯ä¸ªç£ç›˜å†™å…¥æ•°æ®çš„å¤§å°-z,\u0026ndash;size=ï¼šé˜µåˆ—ä¸­ä»æ¯ä¸ªç£ç›˜è·å–çš„ç©ºé—´æ€»æ•°-l,\u0026ndash;level=: RAIDçº§åˆ«-p,\u0026ndash;layout=ï¼šè®¾å®šraid5 å’Œraid10çš„å¥‡å¶æ ¡éªŒè§„åˆ™ï¼›å¹¶ä¸”æ§åˆ¶æ•…éšœçš„æ•…éšœæ¨¡å¼\u0026ndash;parity: ç±»ä¼¼äº\u0026ndash;layout\u0026ndash;assume-clean:ç›®å‰ä»…ç”¨äº \u0026ndash;build é€‰é¡¹-R \u0026ndash;run: å¼ºåˆ¶æ¿€æ´»RAIDï¼Œä½¿ç”¨è¿™ä¸ªé€‰é¡¹ï¼Œè®¾å¤‡ä¸Šæœ‰æ—§çš„å…ƒæ•°æ®ä¿¡æ¯çš„æç¤ºä¼šè¢«å¿½ç•¥-N \u0026ndash;name=: è®¾å®šé˜µåˆ—çš„åç§°â€“-roundingï¼šåœ¨linear arrayä¸­çš„rounding factorï¼Œç­‰äºæ¡å¸¦å¤§å°ã€‚  å¯ç”¨çš„[options]  -Aï¼Œ\u0026ndash;assembleï¼šåŠ å…¥ä¸€ä¸ªä»¥å‰å®šä¹‰çš„é˜µåˆ— -B,\u0026ndash;build:Build a legacy array without superblocks . -Cï¼Œ\u0026ndash;createï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é˜µåˆ— -Q\u0026ndash;queryï¼šæŸ¥çœ‹ä¸€ä¸ªdeviceï¼Œåˆ¤æ–­å®ƒä¸ºä¸€ä¸ªmd deviceæˆ–æ˜¯ä¸€ä¸ªmdé˜µåˆ—çš„ä¸€éƒ¨åˆ† -Dï¼Œ\u0026ndash;detailï¼šæ‰“å°ä¸€ä¸ªæˆ–å¤šä¸ªmd deviceçš„è¯¦ç»†ä¿¡æ¯ -Eï¼Œ\u0026ndash;examineï¼šæ‰“å°deviceä¸Šçš„md superblock çš„å†…å®¹ -Fï¼Œ\u0026ndash;followï¼Œ\u0026ndash;monitorï¼šé€‰æ‹©Monitoræ¨¡å¼ -Gï¼Œ\u0026ndash;growï¼šæ”¹å˜åœ¨ç”¨é˜µåˆ—çš„å¤§å°æˆ–å½¢æ€ -hï¼Œ\u0026ndash;helpï¼šå¸®åŠ©ä¿¡æ¯ï¼Œç”¨åœ¨ä»¥ä¸Šé€‰é¡¹åï¼Œåˆ™æ˜¾ç¤ºè¯¥é€‰é¡¹ä¿¡æ¯\u0026ndash;help-options -V,\u0026ndash;version -Vï¼Œ\u0026ndash;verboseï¼šæ˜¾ç¤ºç»†èŠ‚ -b,\u0026ndash;briefï¼šè¾ƒå°‘çš„ç»†èŠ‚ã€‚ç”¨äº\u0026ndash;detailå’Œ\u0026ndash;examineé€‰é¡¹ -f,\u0026ndash;force -cï¼Œ\u0026ndash;config=ï¼šæŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œç¼ºçœä¸º/etc/mdadm/mdadm. conf -sï¼Œ\u0026ndash;scanï¼šæ‰«æé…ç½®æ–‡ä»¶æˆ–/proc/mdstatä»¥æœå¯»ä¸¢å¤±çš„ä¿¡æ¯ã€‚é…ç½®æ–‡ä»¶/etc/mdadm/mdadm. conf createæˆ–buildä½¿ç”¨çš„é€‰é¡¹ï¼š -c,\u0026ndash;chunk=:Specify chunk size of kibibytes.ç¼ºçœä¸º64. \u0026ndash;rounding=:Specify rounding factor for linear array(==chunk size) -I,\u0026ndash;level=:è®¾å®šraid level. \u0026ndash;createå¯ç”¨ï¼šlinearï¼Œraid 0ï¼Œ0ï¼Œstripeï¼Œraid 1ï¼Œ1ï¼Œmirrorï¼Œraid 4ï¼Œ4ï¼Œraid 5ï¼Œ5ï¼Œraid 6ï¼Œ6ï¼Œmultipath, mp. \u0026ndash;buildå¯ç”¨ï¼šlinearï¼Œraid 0ï¼Œ0ï¼Œstripe. -pï¼Œ\u0026ndash;parity=ï¼šè®¾å®šraid 5çš„å¥‡å¶æ ¡éªŒè§„åˆ™ï¼šeft- asymmetric ï¼Œleft-symmetricï¼Œright- asymmetric , right-symmetric, la, ra, ls, rs.ç¼ºçœä¸ºleft-symmetric\u0026ndash;layout=ï¼šç±»ä¼¼äº\u0026ndash;parity -nï¼Œ\u0026ndash;raid-devices=ï¼šæŒ‡å®šé˜µåˆ—ä¸­å¯ç”¨deviceæ•°ç›®ï¼Œè¿™ä¸ªæ•°ç›®åªèƒ½ç”±\u0026ndash;growä¿®æ”¹-xï¼Œ\u0026ndash;spare-devices=ï¼šæŒ‡å®šåˆå§‹é˜µåˆ—çš„å¯Œä½™deviceæ•°ç›® -zï¼Œ\u0026ndash;size=ï¼šç»„å»ºRAID1/4/5/6åä»æ¯ä¸ªdeviceè·å–çš„ç©ºé—´æ€»æ•°\u0026ndash;assume-clean:ç›®å‰ä»…ç”¨äº\u0026ndash;buildé€‰é¡¹ -Rï¼Œ-runï¼šé˜µåˆ—ä¸­çš„æŸä¸€éƒ¨åˆ†å‡ºç°åœ¨å…¶ä»–é˜µåˆ—æˆ–æ–‡ä»¶ç³»ç»Ÿä¸­æ—¶ï¼Œm dadmä¼šç¡®è®¤è¯¥é˜µåˆ—ã€‚æ­¤é€‰é¡¹å°†ä¸ä½œç¡®è®¤ã€‚ -f, \u0026ndash;force:é€šå¸¸mdadmä¸å…è®¸åªç”¨ä¸€ä¸ªdeviceåˆ›å»ºé˜µåˆ—ï¼Œè€Œä¸”åˆ›å»ºraid5æ—¶ä¼šä½¿ç”¨ä¸€ä¸ªdeviceä½œä¸ºmissingdriveã€‚æ­¤é€‰é¡¹æ­£ç›¸å -a, \u0026ndash;auto{=no,yes,md,mdp,part,p}{NN}  æµ‹è¯• åˆ›å»ºRAID5é˜µåˆ—   æ‰§è¡Œå‘½ä»¤: mdadm \u0026ndash;create /dev/md0 \u0026ndash;level=5 \u0026ndash;chunk=64 \u0026ndash;raid-devices=4 \u0026ndash;spare-devices=1 /dev/sd[b-f]\n  ä½¿ç”¨cat /proc/mdstatæŸ¥çœ‹RAID5é˜µåˆ—çŠ¶æ€\n  ç»“æœï¼š\nPersonalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] md0 : active raid5 sde[5] sdf[4](S) sdd[2] sdc[1] sdb[0] 328704 blocks super 1.2 level 5, 64k chunk, algorithm 2 [4/4] [UUUU] unused devices: \u0026lt;none\u0026gt; æ˜¾ç¤ºè®¾å¤‡ç›˜ä¸ºsdfä¸ºçƒ­å¤‡ç›˜ï¼Œ ä½¿ç”¨fdisk â€“læŸ¥çœ‹ç£ç›˜é˜µåˆ—, æ˜¾ç¤ºç£ç›˜å¤§å°ä¸ºï¼šDisk /dev/md0: 320 MB   åœæ­¢RAID5é˜µåˆ—   æ‰§è¡Œå‘½ä»¤: sudo mdadm -Ss æˆ–è€… mdadm \u0026ndash;stop /dev/md0\n  ä½¿ç”¨cat /proc/mdstatæŸ¥çœ‹RAID5é˜µåˆ—çŠ¶æ€\n  ç»“æœ\nPersonalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] unused devices: \u0026lt;none\u0026gt; // ç£ç›˜å·²ç»åœæ­¢ mdadm: stopped /dev/md0   å¯åŠ¨RAID5é˜µåˆ—   æ‰§è¡Œå‘½ä»¤: sudo mdadm -As\n  ä½¿ç”¨cat /proc/mdstatæŸ¥çœ‹RAID5é˜µåˆ—çŠ¶æ€\n  ç»“æœ\nmdadm: /dev/md/0 has been started with 4 drives and 1 spare. Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] md0 : active raid5 sdb[0] sdf[4](S) sde[5] sdd[2] sdc[1] 328704 blocks super 1.2 level 5, 64k chunk, algorithm 2 [4/4] [UUUU] unused devices: \u0026lt;none\u0026gt;   æŸ¥çœ‹mdçŠ¶æ€   æ‰§è¡Œå‘½ä»¤ï¼šmdadm -D /dev/md0\n  ç»“æœï¼š\n/dev/md0: Version : 1.2 Creation Time : Wed Jun 8 14:28:56 2022 Raid Level : raid5 Array Size : 328704 (321.00 MiB 336.59 MB) Used Dev Size : 109568 (107.00 MiB 112.20 MB) Raid Devices : 4 Total Devices : 5 Persistence : Superblock is persistent Update Time : Wed Jun 8 14:28:57 2022 State : clean Active Devices : 4 Working Devices : 5 Failed Devices : 0 Spare Devices : 1 Layout : left-symmetric Chunk Size : 64K Consistency Policy : resync Name : zcjubuntu-virtual-machine:0 (local to host zcjubuntu-virtual-machine) UUID : 03cfb72d:971a754f:8236aa23:21b23fd3 Events : 18 Number Major Minor RaidDevice State 0 8 16 0 active sync /dev/sdb 1 8 32 1 active sync /dev/sdc 2 8 48 2 active sync /dev/sdd 5 8 64 3 active sync /dev/sde 4 8 80 - spare /dev/sdf   æ¨¡æ‹ŸæŸå   æ‰§è¡Œå‘½ä»¤ï¼šmdadm /dev/md0 -f /dev/sdf\n  ä½¿ç”¨cat /proc/mdstatæŸ¥çœ‹RAID5é˜µåˆ—çŠ¶æ€\n  ç»“æœ\nPersonalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] md0 : active raid5 sde[5] sdf[4](F) sdd[2] sdc[1] sdb[0] 328704 blocks super 1.2 level 5, 64k chunk, algorithm 2 [4/4] [UUUU] unused devices: \u0026lt;none\u0026gt; /dev/md0: Version : 1.2 Creation Time : Wed Jun 8 14:28:56 2022 Raid Level : raid5 Array Size : 328704 (321.00 MiB 336.59 MB) Used Dev Size : 109568 (107.00 MiB 112.20 MB) Raid Devices : 4 Total Devices : 5 Persistence : Superblock is persistent Update Time : Wed Jun 8 14:44:51 2022 State : clean Active Devices : 4 Working Devices : 4 Failed Devices : 1 Spare Devices : 0 Layout : left-symmetric Chunk Size : 64K Consistency Policy : resync Name : zcjubuntu-virtual-machine:0 (local to host zcjubuntu-virtual-machine) UUID : 03cfb72d:971a754f:8236aa23:21b23fd3 Events : 19 Number Major Minor RaidDevice State 0 8 16 0 active sync /dev/sdb 1 8 32 1 active sync /dev/sdc 2 8 48 2 active sync /dev/sdd 5 8 64 3 active sync /dev/sde 4 8 80 - faulty /dev/sdf   ç§»é™¤æŸåçš„ç£ç›˜   æ‰§è¡Œå‘½ä»¤ï¼šmdadm /dev/md0 -r /dev/sdf\n  ä½¿ç”¨cat /proc/mdstatæŸ¥çœ‹RAID5é˜µåˆ—çŠ¶æ€\n  ç»“æœ\nPersonalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] md0 : active raid5 sde[5] sdd[2] sdc[1] sdb[0] 328704 blocks super 1.2 level 5, 64k chunk, algorithm 2 [4/4] [UUUU] unused devices: \u0026lt;none\u0026gt; /dev/md0: Version : 1.2 Creation Time : Wed Jun 8 14:28:56 2022 Raid Level : raid5 Array Size : 328704 (321.00 MiB 336.59 MB) Used Dev Size : 109568 (107.00 MiB 112.20 MB) Raid Devices : 4 Total Devices : 4 Persistence : Superblock is persistent Update Time : Wed Jun 8 14:49:13 2022 State : clean Active Devices : 4 Working Devices : 4 Failed Devices : 0 Spare Devices : 0 Layout : left-symmetric Chunk Size : 64K Consistency Policy : resync Name : zcjubuntu-virtual-machine:0 (local to host zcjubuntu-virtual-machine) UUID : 03cfb72d:971a754f:8236aa23:21b23fd3 Events : 20 Number Major Minor RaidDevice State 0 8 16 0 active sync /dev/sdb 1 8 32 1 active sync /dev/sdc 2 8 48 2 active sync /dev/sdd 5 8 64 3 active sync /dev/sde   æ·»åŠ æ–°çš„ç¡¬ç›˜åˆ°å·²æœ‰é˜µåˆ—   æ‰§è¡Œå‘½ä»¤ï¼šmdadm /dev/md0 -a /dev/sdf\n  ä½¿ç”¨cat /proc/mdstatæŸ¥çœ‹RAID5é˜µåˆ—çŠ¶æ€\n  ç»“æœ\nmd0 : active raid5 sdf[4](S) sde[5] sdd[2] sdc[1] sdb[0] 328704 blocks super 1.2 level 5, 64k chunk, algorithm 2 [4/4] [UUUU] unused devices: \u0026lt;none\u0026gt; /dev/md0: Version : 1.2 Creation Time : Wed Jun 8 14:28:56 2022 Raid Level : raid5 Array Size : 328704 (321.00 MiB 336.59 MB) Used Dev Size : 109568 (107.00 MiB 112.20 MB) Raid Devices : 4 Total Devices : 5 Persistence : Superblock is persistent Update Time : Wed Jun 8 14:53:45 2022 State : clean Active Devices : 4 Working Devices : 5 Failed Devices : 0 Spare Devices : 1 Layout : left-symmetric Chunk Size : 64K Consistency Policy : resync Name : zcjubuntu-virtual-machine:0 (local to host zcjubuntu-virtual-machine) UUID : 03cfb72d:971a754f:8236aa23:21b23fd3 Events : 21 Number Major Minor RaidDevice State 0 8 16 0 active sync /dev/sdb 1 8 32 1 active sync /dev/sdc 2 8 48 2 active sync /dev/sdd 5 8 64 3 active sync /dev/sde 4 8 80 - spare /dev/sdf   ","date":"2022-06-12T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-mdadm%E5%B7%A5%E5%85%B7%E5%AD%A6%E4%B9%A0/1_hu859ea59f552859095fb986ed5a22b665_11306_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-mdadm%E5%B7%A5%E5%85%B7%E5%AD%A6%E4%B9%A0/","title":"Linux-mdadmå·¥å…·å­¦ä¹ "},{"content":"æ¦‚è¿° Linuxå†…æ ¸åœ¨å¤šå—è®¾å¤‡çš„åŸºç¡€ä¸Šï¼Œæ³¨å†Œäº†ä¸€å—ç‰¹æ®Šçš„è®¾å¤‡ï¼Œç§°ä¸ºä¸ºMDè®¾å¤‡ã€‚è¿™ä¸ªMDè®¾å¤‡å½¢æˆä¸€ä¸ªé€»è¾‘å±‚ï¼Œæ”¯æŒä¸åŒçš„RAIDæŠ€æœ¯\n\r\nMDæ¨¡å—æ˜¯ä¸€ä¸ªè™šæ‹Ÿå—è®¾å¤‡ï¼Œå®ƒå±äºå—i/oå­ç³»ç»Ÿä¸­çš„å—è®¾å¤‡é©±åŠ¨å±‚ï¼Œæ¶æ„äºç‰©ç†å—è®¾å¤‡å±‚ï¼›å…¶æœ‰ä¸¤å±‚ï¼šRAIDå…±æ€§å±‚å’ŒRAIDä¸ªæ€§å±‚\n RAIDå…±æ€§å±‚ï¼šå®ƒæå–å‡ºå„ç§çº§åˆ«çš„RAIDçš„å…¬å…±ç‰¹æ€§ï¼Œä¾ç…§å—è®¾å¤‡çš„å®ç°æ¨¡æ¿å‘ä¸Šå±‚æ³¨å†Œï¼ŒåŒæ—¶å‘RAIDä¸ªæ€§å±‚æä¾›å…¬å…±å‡½æ•°ï¼Œä»¥åŠæ¥å£æ³¨å†Œå‡½æ•° RAIDä¸ªæ€§å±‚ï¼šæ˜¯å„ç§çº§åˆ«RAIDçš„ä¸ªæ€§ä½“ç°ï¼Œå®ƒå‘RAIDå…¬å…±å±‚æ³¨å†Œä¸ªæ€§æ¥å£ï¼Œåˆ©ç”¨RAIDå…¬å…±å±‚æä¾›çš„å…¬å…±å‡½æ•°ï¼ŒåŸºäºä½å±‚å®ç°ä¸ªæ€§åŒ–åŠŸèƒ½  RAIDæ¨¡å—å¯¹è±¡   æ ¸å¿ƒMDè®¾å¤‡ç»“æ„mddevåŠå…¶æˆå‘˜ç£ç›˜è®¾å¤‡ç»“æ„mdk_rdev_tæ˜¯ç³»ç»Ÿä¸­çš„ä¸¤ä¸ªå…³é”®ç»“æ„ã€‚æ ¸å¿ƒMDè®¾å¤‡ç»“æ„mddev_tæ˜¯å†…æ ¸ä¸­RAIDè®¾å¤‡ä¿å­˜è‡ªèº«ä¿¡æ¯çš„ç»“æ„ä½“ï¼Œå®ƒåŒ…æ‹¬äº†å®Œæ•´çš„RAIDè®¾å¤‡çš„ä¿¡æ¯ã€‚æˆå‘˜ç£ç›˜è®¾å¤‡ç»“æ„mdk_rdev_tåæ˜ äº†ç»„æˆMDè®¾å¤‡çš„åº•å±‚å—è®¾å¤‡çš„ä¿¡æ¯ï¼›\n  MDè®¾å¤‡å¤„ç†å¯ä»¥æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªMDä¸ªæ€§ç»“æ„ä½“ï¼Œæœ‰ä¸ªæ€§NDè®¾å¤‡çš„æ“ä½œè¡¨å’Œæ“ä½œçš„æœ€ç»ˆæ•°æ®\n  MDè®¾å¤‡é€šè¿‡å—è®¾å¤‡å·å’Œå—è®¾å¤‡æè¿°ç¬¦ï¼ˆblock_deviceï¼‰å…³è”èµ·æ¥ï¼Œä½å±‚æˆå‘˜ç£ç›˜ä¹ŸæŒ‡å‘å’Œå®ƒç›¸å¯¹åº”çš„å—è®¾å¤‡æè¿°ç¬¦æ­£æ˜¯ä»¥å—è®¾å¤‡æè¿°ç¬¦ä¸ºâ€œçº½å¸¦â€ï¼Œä½¿å¾—MDå¯ä»¥æ„å»ºåœ¨å…¶ä»–çš„ç‰©ç†æˆ–è™šæ‹Ÿç£ç›˜è®¾å¤‡ä¹‹ä¸Šï¼Œæˆä¸ºä¸€ä¸ªâ€œæ ˆå¼â€å—è®¾å¤‡ï¼›\n\r\n  MDæ¨¡å—åˆå§‹åŒ–   MDæ¨¡å—åŠ è½½æ—¶ï¼Œå®ƒçš„åˆå§‹åŒ–å‡½æ•°md_initå°†è¢«æ‰§è¡Œ;\n  __register_blkdevå‡½æ•°:æ˜¯ç»´æŠ¤ä¸»è®¾å¤‡å·å’Œå—è®¾å¤‡åä¹‹é—´çš„å…³è”,æ‰€æœ‰å—è®¾å¤‡æ¨¡å—åˆå§‹åŒ–æ—¶ï¼Œéƒ½åº”è¯¥è°ƒç”¨è¿™ä¸ªå‡½æ•°\nstatic void md_geninit(void) { pr_debug(\u0026quot;md: sizeof(mdp_super_t) = %d\\n\u0026quot;, (int)sizeof(mdp_super_t)); proc_create(\u0026quot;mdstat\u0026quot;, S_IRUGO, NULL, \u0026amp;mdstat_proc_ops); } static int __init md_init(void) { int ret = -ENOMEM; md_wq = alloc_workqueue(\u0026quot;md\u0026quot;, WQ_MEM_RECLAIM, 0); if (!md_wq) goto err_wq; md_misc_wq = alloc_workqueue(\u0026quot;md_misc\u0026quot;, 0, 0); if (!md_misc_wq) goto err_misc_wq; md_rdev_misc_wq = alloc_workqueue(\u0026quot;md_rdev_misc\u0026quot;, 0, 0); if (!md_rdev_misc_wq) goto err_rdev_misc_wq; ret = __register_blkdev(MD_MAJOR, \u0026quot;md\u0026quot;, md_probe); if (ret \u0026lt; 0) goto err_md; ret = __register_blkdev(0, \u0026quot;mdp\u0026quot;, md_probe); if (ret \u0026lt; 0) goto err_mdp; mdp_major = ret; register_reboot_notifier(\u0026amp;md_notifier); raid_table_header = register_sysctl_table(raid_root_table); md_geninit(); return 0; err_mdp: unregister_blkdev(MD_MAJOR, \u0026quot;md\u0026quot;); err_md: destroy_workqueue(md_rdev_misc_wq); err_rdev_misc_wq: destroy_workqueue(md_misc_wq); err_misc_wq: destroy_workqueue(md_wq); err_wq: return ret; }   MDè®¾å¤‡åˆ›å»º   md_probe()å‡½æ•°è´Ÿè´£åˆ›å»ºMDå¯¹è±¡,ç›´æ¥è°ƒç”¨md_allocå‡½æ•°ï¼›\nstatic void md_probe(dev_t dev) { if (MAJOR(dev) == MD_MAJOR \u0026amp;\u0026amp; MINOR(dev) \u0026gt;= 512) return; if (create_on_open) md_alloc(dev, NULL); }   md_open():æ˜¯ç³»ç»Ÿè°ƒç”¨opençš„å®ç°ä»£ç ç»§ç»­æ‰§è¡Œï¼Œè°ƒç”¨å—è®¾å¤‡æ“ä½œè¡¨çš„openå›è°ƒå‡½æ•°çš„å®ä¾‹åŒ–\n  ç”¨æˆ·æ€å‘é€ioctlåˆ›å»ºMD ä½¿ç”¨ç®¡ç†å·¥å…·åˆ›å»ºMDæ˜¯é€šè¿‡ioctlæ¥å®ç°çš„ã€‚åœ¨æ‰“å¼€MDè®¾å¤‡æ–‡ä»¶ï¼ˆå¦‚/dev/md0ï¼‰æƒ…å†µä¸‹ï¼Œæ–‡ä»¶æ“ä½œè¡¨è¢«è®¾ç½®ä¸ºdef_blk_fopsï¼Œå…¶unlocked_ioctlå›è°ƒå‡½æ•°çš„å®ç°ä¸ºblock_ioctlï¼Œè€Œåè€…ç»è°ƒç”¨blkdev_ioctlï¼Œå†è°ƒç”¨__blkdev_driver_ioctlï¼Œæœ€åè°ƒç”¨çš„æ˜¯é€šç”¨ç£ç›˜çš„å—è®¾å¤‡æ“ä½œè¡¨ä¸­çš„ioctlå›è°ƒå‡½æ•°\nå‡½æ•°md_iocal()å¯å¯¹è®¾å¤‡é©±åŠ¨ã€ç£ç›˜ã€è®¾å¤‡è¿›è¡ŒæŸ¥è¯¢ã€æ§åˆ¶å’Œé…ç½®:\n é’ˆå¯¹äºRAIDé©±åŠ¨ç¨‹åºï¼Œè€Œéç‰¹å®šçš„é˜µåˆ—ï¼›ä¾‹å¦‚è·å–RAIDé©±åŠ¨ç¨‹åºç‰ˆæœ¬å·ä»¥åŠæ‰“å°æ‰€æœ‰RAIDé˜µåˆ—ä¿¡æ¯ç­‰ é’ˆå¯¹äºç‰¹å®šé˜µåˆ—ï¼Œä¸»è¦å‘½ä»¤å¦‚ä¸‹ï¼šå¦‚SET_ARRAY_INFOè®¾ç½®MDè®¾å¤‡ä¿¡æ¯ï¼›ADD_NEW_DISKåœ¨MDè®¾å¤‡ä¸­æ·»åŠ ä¸€ä¸ªç£ç›˜è®¾å¤‡ï¼›RUN_ARRAYè¿è¡ŒMDè®¾å¤‡ç­‰ SET_ARRAY_INFOï¼šåœ¨md_ioctlï¼Œå¤„ç†SET_ARRAY_INFOæ§åˆ¶ç çš„ä»£ç é¦–å…ˆä»ç”¨æˆ·ç©ºé—´å¤åˆ¶å‚æ•°ï¼Œç„¶åæ ¹æ®MDè®¾å¤‡æ˜¯å¦å·²ç»å­˜åœ¨åˆ†åˆ«è°ƒç”¨update_array_infoå’Œmd_set_array_infoå‡½æ•°ï¼› ADD_NEW_DISK:åœ¨md_ioctlï¼Œå¤„ç†ADD_NEW_DISKæ§åˆ¶ç çš„ä»£ç é¦–å…ˆä»ç”¨æˆ·ç©ºé—´å¤åˆ¶å‚æ•°ï¼Œç„¶åè°ƒmd_add_new_diskå‡½æ•°; RUN_ARRAY:å¤„ç†RUN_ARRAYæ§åˆ¶ç çš„ä»£ç ç›´æ¥è°ƒç”¨do_md_runå‡½æ•°;  MDè®¾å¤‡è¯·æ±‚æ‰§è¡Œ MDæ¨¡å—ä¸­æä¾›äº†ä¸€ä¸ªé€šç”¨çš„æ¥å£å‡½æ•°md_make_requestä½œä¸ºå„ç§çº§åˆ«RAIDè®¾å¤‡çš„è¯»ï¼å†™è¯·æ±‚çš„å…¥å£;\nåŠ è½½MDæ¨¡å—æ—¶ï¼Œè°ƒç”¨blk_queue_make_requestå‡½æ•°å°†æ‰€æœ‰å¯¹ä¸»è®¾å¤‡å·ä¸ºMD_MAJORçš„è¯»ï¼å†™è¯·æ±‚éƒ½è½¬å‘åˆ°è¿™ä¸ªå‡½æ•°ã€‚ä½†è¿™ä¸ªå‡½æ•°å¹¶ä¸æ‰§è¡ŒçœŸæ­£å¤„ç†ï¼Œåªæ˜¯é€šè¿‡æ˜ å°„æ‰¾åˆ°å—è®¾å¤‡æ¬¡è®¾å¤‡å·å¯¹åº”MDè®¾å¤‡ç»“æ„ï¼Œè¿›è€Œè·å¾—å…¶ä¸ªæ€§åŒ–ç»“æ„æŒ‡é’ˆï¼Œè°ƒç”¨ä¸ªæ€§åŒ–ç»“æ„çš„make_requestï¼Œå³é€šè¿‡å’Œè¯¥RAIDçº§åˆ«å¯¹åº”çš„è¯·æ±‚å¤„ç†å‡½æ•°æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚;\n","date":"2022-05-30T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-multi-disk-md%E6%A8%A1%E5%9D%97/image-20220613151649807_huc45ff52f0cf6b2c13cf0b9e2262e1b7b_66945_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-multi-disk-md%E6%A8%A1%E5%9D%97/","title":"Linux-Multi-Disk (MD)æ¨¡å—"},{"content":"RAID5æ¨¡å— RAID5æ¨¡å—çš„å¯¹è±¡ï¼Œæ¨¡å—çš„æ‰§è¡Œè¿‡ç¨‹åŠå…¶åŒæ­¥å’Œæ¢å¤è¿‡ç¨‹\nRAID5æ¨¡å—å¯¹è±¡ å¯¹äºRAID5ï¼ŒMDè®¾å¤‡æè¿°ç¬¦ï¼ˆmddevï¼‰çš„privateåŸŸæŒ‡å‘RAID5ç§æœ‰é…ç½®ç»“æ„r5confã€‚åè€…åŒ…å«ä¸€ä¸ªæˆå‘˜ç£ç›˜ æ•°ç»„ï¼Œæ¯ä¸€é¡¹éƒ½æŒ‡å‘å¯¹åº”çš„æˆå‘˜ç£ç›˜æè¿°ç¬¦ï¼ˆmdk_rdev_tï¼‰ï¼Œè€Œè¿™äº›æˆå‘˜ç£ç›˜æè¿°ç¬¦è¢«é“¾å…¥MDè®¾å¤‡æè¿°ç¬¦çš„æˆå‘˜ç£ç›˜é“¾è¡¨ï¼Œå¹¶ä¸”æœ‰æŒ‡é’ˆæŒ‡å‘MDè®¾å¤‡ï¼›\n\r\nRAID5æ”¯æŒå†—ä½™ï¼Œåœ¨æ¡å¸¦ä¸­é‡‡ç”¨äº†æ ¡éªŒå’ŒæŠ€æœ¯ã€‚å¯¹RAID5è®¾å¤‡çš„æ­£å¸¸è¯»ï¼å†™å’ŒåŒæ­¥ï¼æ¢å¤ï¼æ‰©å±•ç­‰æ“ä½œéƒ½æ˜¯ä»¥æ¡å¸¦ä¸ºåŸºæœ¬å•ä½å¤„ç†çš„ï¼Œæ¡å¸¦ç®¡ç†ç»“æ„ä¸ºâ€œæ¡å¸¦å¤´â€ï¼ˆstripe_headï¼‰ã€‚æ¯ä¸ªRAID5è®¾å¤‡åˆ†é…æœ‰å›ºå®šæ•°ç›®çš„æ¡å¸¦å¤´ï¼Œéšç€ç³»ç»Ÿè¿è¡Œï¼Œè¿™äº›æ¡å¸¦å¤´å¯èƒ½è¢«æŒ‚è½½åˆ°RAID5è®¾å¤‡çš„ä¸åŒé“¾è¡¨ï¼Œè¢«æ¡å¸¦ä½¿ç”¨ä¸­çš„æ¡å¸¦å¤´ç»“æ„è¿˜ä¼šé“¾å…¥RAID5çš„å“ˆå¸Œè¡¨ä»¥ä¾¿äºæŸ¥æ‰¾\næ¯ä¸ªRAID5è®¾å¤‡è¢«åˆ†é…ä¸€å®šæ•°ç›®çš„æ¡å¸¦ç”¨äºå¤„ç†æäº¤ç»™å®ƒçš„è¯·æ±‚ï¼Œæœ€å¤§æ¡å¸¦æ•°ç›®ç”±max_nr_stripesåŸŸç»™å‡ºã€‚è¿™äº›æ¡å¸¦æ ¹æ®å…¶çŠ¶æ€è¢«é“¾å…¥åˆ°ä¸åŒçš„é“¾è¡¨ã€‚RAID5è®¾å¤‡æœ‰ä»¥ä¸‹äº”ä¸ªä¸åŒçš„é“¾è¡¨\n inactive_listä¸ºç©ºé—²çš„æ¡å¸¦åˆ—è¡¨ï¼šåœ¨RAID5å¼€å§‹è¿è¡Œä¹‹åˆï¼Œæ‰€æœ‰çš„æ¡å¸¦éƒ½åœ¨inactive_listä¸­ã€‚åœ¨æœ‰è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œä¸ºå®ƒåˆ†é…å¹¶å…³è”ä¸€ä¸ªæ¡å¸¦ã€‚æ¡å¸¦å¤„ç†å®Œæˆï¼Œåˆè¢«é‡Šæ”¾å›åˆ°è¿™ä¸ªé“¾è¡¨ï¼› handle_listä¸ºéœ€è¦å¤„ç†çš„æ¡å¸¦åˆ—è¡¨ï¼šè¦å¤„ç†çš„æ¡å¸¦éƒ½ä¼šè¢«æ·»åŠ åˆ°handle_listé“¾è¡¨ï¼ŒRAID5å®ˆæŠ¤çº¿ç¨‹å°±æ˜¯æ ¹æ®è¿™ä¸ªé“¾è¡¨è¿›è¡Œå¤„ç†çš„ã€‚æ¡å¸¦è¢«å¤„ç†æ—¶ï¼Œä¼šè¢«ä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œæš‚æ—¶å¤„äºâ€œæ¸¸ç¦»â€çŠ¶æ€ã€‚ä¸€ä¸ªæ¡å¸¦éœ€è¦å¤šè½®å¤„ç†ï¼Œæ¯ä¸€è½®å¤„ç†å®Œæˆä¹‹åï¼Œéƒ½è¢«é‡æ–°åŠ å…¥æŸä¸ªé“¾è¡¨ï¼Œæœ€ç»ˆåˆä¼šè¢«é‡æ–°åŠ å…¥handle_listé“¾è¡¨ï¼Œå¼€å§‹æ–°ä¸€è½®å¤„ç†ã€‚ bitmap_listä¸ºå› ç­‰å¾…ä½å›¾æ›´æ–°è€Œå»¶è¿Ÿçš„æ¡å¸¦é“¾è¡¨ï¼šå¦‚æœåœ¨å¯¹RAID5è®¾å¤‡è¿›è¡Œå†™æ“ä½œæ—¶çªç„¶æ‰ç”µï¼Œå°±å¯èƒ½é€ æˆæŸäº›æ¡å¸¦çš„ä¸åŒæ­¥ï¼Œæœ‰å¯èƒ½æ•°æ®å·²ç»è¢«å†™å…¥æˆå‘˜ç£ç›˜ï¼Œè€Œæ ¡éªŒå’Œè¿˜æ²¡æœ‰è¢«å†™å…¥ï¼Œåˆæˆ–è€…æ ¡éªŒå’Œå·²ç»è¢«å†™å…¥ï¼Œè€ŒæŸäº›æ•°æ®è¿˜æ²¡æœ‰è¢«å†™å…¥æˆå‘˜ç£ç›˜ã€‚å½“RAID5å†æ¬¡è¢«é‡ç»„ä»¥åï¼Œå°±éœ€è¦è¿›è¡ŒåŒæ­¥å¤„478ç†ï¼Œè€Œè¿™éœ€è¦æˆ‘ä»¬çŸ¥é“å“ªäº›æ¡å¸¦éœ€è¦è¢«åŒæ­¥ï¼Œå¦åˆ™åªèƒ½è¿›è¡Œå…¨é¢çš„åŒæ­¥ï¼Œè¿™æ ·åšæ˜¾ç„¶å¼€é”€éå¸¸å¤§ã€‚ä½å›¾å°±æ˜¯ä¸ºæ­¤ç›®çš„è€Œå¼•å…¥çš„ã€‚å¦‚æœRAID5æ”¯æŒä½å›¾ï¼Œæ¯ä¸€ä¸ªå—ä¼šå¯¹åº”ä¸€ä¸ªä½å›¾ä½ï¼Œåœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œä¼šå…ˆå°†å¯¹åº”çš„ä½å›¾ä½ç½®æˆ1ï¼Œè¿™æ—¶å†™è¯·æ±‚ä¹Ÿè¢«æ”¾å…¥bitmap_listé“¾è¡¨ï¼Œåªæœ‰åœ¨è¯¥ä½å›¾ä½è¢«æˆåŠŸå†²åˆ·åˆ°ç£ç›˜ä¹‹åï¼Œæ‰èƒ½å¤„ç†è¿™ä¸ªå†™è¯·æ±‚ã€‚å½“è¿›è¡ŒåŒæ­¥æ“ä½œçš„æ—¶å€™ï¼Œæ ¹æ®ä½å›¾ä½ï¼ŒåªåŒæ­¥é‚£äº›è¢«ç½®ä¸º1çš„æ¡å¸¦ã€‚é‡‡ç”¨ä½å›¾ç­–ç•¥æœ€å¤§çš„ä¼˜ç‚¹æ˜¯å‡å°‘äº†æ— è°“çš„åŒæ­¥æ“ä½œï¼Œæé«˜äº†åŒæ­¥æ“ä½œæ•ˆç‡ã€‚ delayed_listä¸ºè¢«å»¶è¿Ÿå¤„ç†çš„æ¡å¸¦é“¾è¡¨ï¼šåœ¨æœ‰å†™è¯·æ±‚åˆ°è¾¾æ¡å¸¦çš„æŸä¸ªæˆå‘˜ç£ç›˜æ—¶ï¼Œå¹¶ä¸æ˜¯ç«‹å³å°†è¯·æ±‚æ”¾handle_listå‡†å¤‡å¤„ç†ï¼Œè€Œæ˜¯å…ˆæ”¾å…¥delayed_listé“¾è¡¨å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œå»¶è¿Ÿçš„ç›®çš„æ˜¯ä¸ºäº†ç­‰å¾…â€œå¯èƒ½æœ‰â€æ›´å¤šé’ˆå¯¹è¿™ä¸ªæ¡å¸¦çš„å…¶ä»–æˆå‘˜ç£ç›˜çš„å†™è¯·æ±‚åˆ°æ¥ï¼Œè¿™æ ·åšå¯ä»¥ä»æ•´ä½“ä¸Šå‡å°‘â€œé¢„è¯»â€ï¼ˆæ— è®ºæ˜¯é‡æ„å†™è¿˜æ˜¯è¯»æ”¹å†™ï¼‰çš„æ¬¡æ•°ã€‚åªæœ‰å½“æ¡å¸¦è¢«â€œæ¿€æ´»è¯»â€åï¼Œæ‰å¼€å§‹å°†delayed_listé“¾è¡¨ä¸­çš„æ¡å¸¦è½¬ç§»åˆ°å…¶ä»–é“¾è¡¨è¿›è¡Œå¤„ç†ã€‚ hold_listä¸ºå‡†å¤‡å¥½é¢„è¯»çš„æ¡å¸¦é“¾è¡¨ï¼šå½“å‰çš„Linuxå†…æ ¸ç‰ˆæœ¬ä¸ºäº†é˜²æ­¢delayed_listä¸€è‚¡è„‘å„¿å°†æ‰€æœ‰çš„æ¡å¸¦è½¬ç§»åˆ°handle_listï¼Œåœ¨å…¶ä¸­å¼•å…¥hold_listé“¾è¡¨ï¼Œå»¶è¿Ÿçš„æ¡å¸¦å…ˆè¢«ä¿å­˜åˆ°hold_listé“¾è¡¨ä»¥è¿›ä¸€æ­¥å»¶è¿Ÿï¼Œæ ¹æ®ç‰¹å®šçš„ç®—æ³•ï¼Œhold_listè¢«ç»•è¿‡ï¼Œä¹Ÿæœ‰å¯èƒ½è¢«è½¬ç§»åˆ°handle_listè€Œå¾—åˆ°å¤„ç†ã€‚äº‹å®è¯æ˜ï¼Œè¿™æ ·åšå¯ä»¥æ”¹è¿›å†™æ€§èƒ½  \r\nè¯·æ±‚æ‰§è¡Œè¿‡ç¨‹ RAID5ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨raid5_initï¼Œåœ¨å¸è½½æ—¶è°ƒç”¨raid5_exitã€‚è€Œraid5_initåˆ™æ˜¯é€šè¿‡è°ƒç”¨register_md_personalityæ³¨å†ŒRAID5ä¸ªæ€§åŒ–ï¼ŒåŒ…æ‹¬æ¨¡å—åå’Œä¸€äº›ä¸ªæ€§åŒ–æ–¹æ³•ä¿¡æ¯ã€‚åœ¨raid5_exitä¸­åˆ™è°ƒç”¨unregister_md_personalityæ³¨é”€RAID5ä¸ªæ€§åŒ–ï¼›\n æ¥æ”¶ä¸Šå±‚æäº¤è¯·æ±‚ï¼šä¸Šå±‚æäº¤ç»™MDè®¾å¤‡çš„è¯·æ±‚ï¼Œä¼šè¢«ä¼ é€’ç»™raid5_make_requestå‡½æ•°ï¼› md_write_startå‡½æ•°ï¼Œå®ƒå’Œåé¢çš„md_write_endäº’ä¸ºå¯¹åº”ï¼Œéƒ½æ˜¯MDæ¨¡å—æä¾›çš„å…¬å…±å‡½æ•°ï¼Œä¾›RAID5ç­‰æ”¯æŒå†—ä½™çš„ä¸ªæ€§æ¨¡å—è°ƒç”¨; chunk_aligned_readå‡½æ•°å¤„ç†å¯¹é½è¯»ã€‚æ‰€è°“å¯¹é½è¯»ï¼ˆAlignedReadï¼‰ï¼Œæ˜¯æŒ‡è¦è¯»çš„æ•°æ®åœ¨ä¸€ä¸ªChunkè¾¹ç•Œå†…ï¼Œå› æ­¤åªéœ€è¦ä»æŸä¸ªæˆå‘˜ç£ç›˜è¯»å–å³å¯ï¼Œä¸æ¶‰åŠæ•´ä¸ªæ¡å¸¦çš„é…åˆ;å‡½æ•°æ ¹æ®è¯·æ±‚æ˜¯å¦åœ¨ä¸€ä¸ªChunkè¾¹ç•Œå†…ï¼Œä»¥åŠç›®æ ‡æˆå‘˜ç£ç›˜æ˜¯å¦å¤„åœ¨åŒæ­¥çŠ¶æ€ç­‰ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥æŒ‰å¯¹é½è¯»å¤„ç† raid5_compute_sector:å‡½æ•°è¾“å…¥ä¸€ä¸ªç›¸å¯¹RAID5è®¾å¤‡çš„â€œå¤§çš„â€æ‰‡åŒºç¼–å·ï¼Œè¾“å‡ºæ•°æ®ç£ç›˜å’Œæ ¡éªŒç£ç›˜çš„ç¼–å·ï¼Œä»¥åŠå…¶ä¸Šçš„æ‰‡åŒºç¼–å·ï¼Œå³æ¡å¸¦ç¼–å·ï¼Œæ ¹æ®æ‰‡åŒºç¼–å·è®¡ç®—æ•°æ®ç£ç›˜å’Œæ ¡éªŒç£ç›˜çš„ç¼–å·åŠåœ¨å…¶ä¸Šçš„æ‰‡åŒºç¼–å· raids_compute_sectorå‡½æ•°æœ‰äº”ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªä¸ºæŒ‡å‘r5confæè¿°ç¬¦çš„æŒ‡é’ˆï¼›ç¬¬äºŒä¸ªä¸ºç›®æ ‡æ‰‡åŒºç¼–å·ï¼ˆç›¸å¯¹äºRAID5è®¾å¤‡ï¼‰ï¼›ç¬¬ä¸‰ä¸ªä¸º1è¡¨ç¤ºæ ¹æ®å˜æ›´å‰çš„å‚æ•°è¿›è¡Œè®¡ç®—ï¼Œä¸º0è¡¨ç¤ºæ ¹æ®å˜æ›´åçš„å‚æ•°è¿›è¡Œè®¡ç®—ï¼›ç¬¬å››ä¸ªä¸ºè¾“å‡ºå‚æ•°ï¼Œé€šè¿‡å®ƒè¿”å›æ•°æ®å•å…ƒåœ¨æ¡å¸¦ä¸­çš„ç¼–å·ï¼›ç¬¬äº”ä¸ªä¸ºæŒ‡å‘å¯¹åº”stripe_headæè¿°ç¬¦çš„æŒ‡é’ˆï¼Œè¿™æ—¶è®¡ç®—å¥½çš„Pæ ¡éªŒå•å…ƒç¼–å·ã€Qæ ¡éªŒå•å…ƒç¼–å·ã€ddf_layoutæ ‡å¿—å°†è¢«ä¿å­˜åœ¨å®ƒçš„å¯¹åº”åŸŸï¼Œæˆ–ä¸ºNULLã€‚å‡½æ•°è¿”å›å¯¹åº”æ‰‡åŒºåœ¨æˆå‘˜ç£ç›˜ä¸Šçš„æ‰‡åŒºç¼–å·ï¼Œå³æ¡å¸¦ç¼–å·  RAID5æ ¡éªŒç›˜å’Œæ•°æ®ç›˜ç¼–å·ä¸ç®—æ³• å‡è®¾æ•°æ®å•å…ƒæ ‡å·ä¸ºchunk_numberï¼ŒRAIDç£ç›˜æ•°ä¸ºraid_disksï¼Œæ•°æ®ç›˜æ•°ä¸ºdata_disksï¼Œæ‰€åœ¨æ¡å¸¦ç¼–å·ä¸ºstripe=chunk_number/data_disksã€‚ç„¶åè®¡ç®—åœ¨æ¡å¸¦å†…çš„æ•°æ®ç£ç›˜å’Œæ ¡éªŒç£ç›˜ç¼–å·\nRAID5çš„ç®—æ³•å¦‚ä¸‹ï¼š\n  å‘å·¦ä¸å¯¹ç§°ç®—æ³•ï¼šæ ¡éªŒç›˜ç¼–å·ä¸ºdata_disks-stripe%raid_disksã€‚æ•°æ®ç›˜ç¼–å·ä¸ºchunk_number%data_disksï¼Œå¦‚æœè¯¥å€¼å¤§äºæˆ–ç­‰äºæ ¡éªŒç›˜ç¼–å·ï¼Œåˆ™è¿˜éœ€è¦åŠ 1ï¼›\n  å‘å³ä¸å¯¹ç§°ç®—æ³•ï¼šæ ¡éªŒç›˜ç¼–å·ä¸ºstripe%raid_disksã€‚æ•°æ®ç›˜ç¼–å·ä¸ºchunk_number%data_disksï¼Œå¦‚æœè¯¥å€¼å¤§äºæˆ–ç­‰äºæ ¡éªŒç›˜ç¼–å·ï¼Œåˆ™è¿˜éœ€è¦åŠ 1ï¼›\n  å‘å·¦å¯¹ç§°ç®—æ³•ï¼šæ ¡éªŒç›˜ç¼–å·ä¸ºdata_disks-stripe%raid_disksï¼Œè€Œæ•°æ®ç›˜ç¼–å·ä¸ºï¼ˆæ ¡éªŒç›˜ç¼–å·ï¼‹1ï¼‹chunk_number%data_disksï¼‰%raid_disksï¼›\n  å‘å³å¯¹ç§°ç®—æ³•ï¼šæ ¡éªŒç›˜ç¼–å·ä¸ºstripe%raid_disksï¼Œè€Œæ•°æ®ç›˜ç¼–å·ä¸ºï¼ˆæ ¡éªŒç›˜ç¼–å·ï¼‹1ï¼‹chunk_number%data_disksï¼‰%raid_disksã€‚\n  æœ€åï¼Œç›®æ ‡æ‰‡åŒºåœ¨æ•°æ®ç›˜å’Œæ ¡éªŒç›˜ä¸Šçš„æ‰‡åŒºç¼–å·ä¸ºstripe*sectors_per_chunkï¼‹ chunk_offsetã€‚\n\r\n  ç®¡ç†RAID5æ¡å¸¦èµ„æº æ¡å¸¦å¤´æ˜¯åœ¨RAID5å¼€å§‹è¿è¡Œçš„æ—¶å€™å¼€è¾Ÿçš„ç¼“å†²åŒºï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰é™çš„èµ„æºï¼Œé™¤äº†åœ¨æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­éœ€è¦è°ƒåº¦ä»¥å¤–ï¼Œè¿˜éœ€è¦ä¸€å¥—å®Œæ•´çš„æœºåˆ¶å»ä½¿å¾—è¿™äº›æœ‰é™çš„èµ„æºèƒ½å¤Ÿæ»¡è¶³æ•°æ®è¯·æ±‚å¤„ç†æ‰€éœ€\n raid5_get_active_stripeï¼šå‡½æ•°æœ‰äº”ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªä¸ºæŒ‡å‘RAID5ç§æœ‰æ•°æ®æè¿°ç¬¦çš„æŒ‡é’ˆï¼›ç¬¬äºŒä¸ªä¸ºæ¡å¸¦ç¼–å·ï¼›ç¬¬ä¸‰ä¸ªä¸º1è¡¨ç¤ºæ ¹æ®å˜æ›´å‰çš„å‚æ•°è¿›è¡Œè®¡ç®—ï¼Œä¸º0è¡¨ç¤ºæ ¹æ®å˜æ›´åçš„å‚æ•°è¿›è¡Œè®¡ç®—ï¼›ç¬¬å››ä¸ªä¸º1è¡¨ç¤ºä¸è¦é˜»å¡ï¼Œä¸º0è¡¨ç¤ºé˜»å¡ï¼Œç›´åˆ°è·å¾—ä¸€ä¸ªæ´»åŠ¨æ¡å¸¦ï¼›ç¬¬äº”ä¸ªä¸ºnoquiesceã€‚å‡½æ•°è¿”å›æŒ‡å‘æ¡å¸¦å¤´æè¿°ç¬¦çš„æŒ‡é’ˆï¼Œæˆ–è€…åœ¨å¤±è´¥æ—¶è¿”å›NULL __find_stripeï¼šåœ¨å“ˆå¸Œè¡¨ä¸­æ‰¾çœ‹æŒ‡å®šæ‰‡åŒºçš„æ¡å¸¦æ˜¯å¦å·²ç»å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œå‡½æ•°ä¼šè¿”å›NULL get_free_stripeä»inactive_listé“¾è¡¨å°è¯•è·å¾—ä¸€ä¸ªæ¡å¸¦ï¼› å½“æ¡å¸¦ä½¿ç”¨å®Œæ¯•åï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ¡å¸¦çš„æ—¶å€™ï¼Œä¼šå…ˆå°†inactive_blockedåŸŸç½®1ï¼Œç„¶åè°ƒç”¨wait_event_lock_irqå¼€å§‹ç­‰å¾…ï¼› wait_event_lock_irqï¼šå››ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªä¸ºç­‰å¾…é˜Ÿåˆ—ï¼›ç¬¬äºŒä¸ªä¸ºæ¡ä»¶ï¼›ç¬¬ä¸‰ä¸ªä¸ºé”ï¼›ç¬¬å››ä¸ªä¸ºå‘½ä»¤ã€‚å®ƒçš„è§£é‡Šä¸ºï¼šå¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“æ—¶åœ¨æ”¾å¼ƒæ‰§è¡Œä¹‹å‰ï¼Œè¿˜ä¼šæ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œè¿™é€šå¸¸å°±æ˜¯ç£ä¿ƒå…¶ä»–éƒ¨åˆ†å»èµ¶ç´§å¤„ç†ï¼Œä½¿å¾—ç­‰å¾…çš„æ¡ä»¶å°½æ—©æ»¡è¶³ï¼›ç­‰å¾…æ¡ä»¶æ˜¯ï¼š1.RAID5çš„inactive_listé“¾è¡¨ä¸ä¸ºç©ºï¼›2.RAID5çš„æ´»åŠ¨æ¡å¸¦æ•°åŸŸå°äºå…¶æœ€å¤§æ¡å¸¦æ•°ç›®çš„3/4ï¼Œæˆ–è€…RAID5çš„inactive_blockedä¸º0  RAID5å®ˆæŠ¤çº¿ç¨‹å¤„ç† æ¯ä¸ªRAID4/5/6è®¾å¤‡å¯ä»¥åŒæ—¶å­˜åœ¨ä¸¤ä¸ªMDçº¿ç¨‹ï¼šä¸€ä¸ªåå­—ä¸ºmd#_raid5ï¼Œç§°ä¸ºRAID5å®ˆæŠ¤çº¿ç¨‹ï¼Œå®ƒæ‰§è¡Œçš„å¤„ç†å‡½æ•°ä¸ºraid5dï¼›å¦ä¸€ä¸ªåå­—ä¸ºresyncæˆ–reshapeï¼Œç¬¼ç»Ÿåœ°ç§°ä¸ºRAID5åŒæ­¥çº¿ç¨‹ï¼Œå®ƒæ‰§è¡Œçš„å¤„ç†å‡½æ•°ä¸ºmd_do_sync\nRAID5å®ˆæŠ¤çº¿ç¨‹ï¼Œå®ƒè´Ÿè´£æ¡å¸¦å„ä¸ªè½®æ¬¡çš„å¤„ç†ï¼Œä»æ¥å—ä¸Šå±‚è¯·æ±‚æ—¶å¼€å§‹ï¼Œå¤„ç†è¿‡ç¨‹ä¸­ä¸æ–­æ¨è¿›æ¡å¸¦çŠ¶æ€çš„å˜åŒ–ï¼Œç›´è‡³æœ€ç»ˆå®Œæˆ\n","date":"2022-05-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-raid5%E5%AD%A6%E4%B9%A0/1_hu7e02b142b51acc83a4bc67a855e709b3_49591_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-raid5%E5%AD%A6%E4%B9%A0/","title":"Linux-raid5å­¦ä¹ "},{"content":"æ¦‚è¿° æ–‡ä»¶ç³»ç»Ÿæ˜¯å­˜å‚¨å’Œç»„ç»‡æ–‡ä»¶ï¼Œä»¥ä¾¿å¯ä»¥è®¿é—®å’ŒæŸ¥æ‰¾çš„ä¸€ç§æœºåˆ¶ï¼›ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿæœ‰ä¸åŒçš„å­˜å‚¨å’Œç»„ç»‡æ–¹å¼ï¼›åŸºäºç£ç›˜çš„æœ‰ä¸€ä¸‹å‡ ç§å­˜å‚¨æ–¹å¼ï¼š\n è¿ç»­å­˜å‚¨ï¼šæŠŠæ•°æ®ä½œä¸ºè¿ç»­çš„æ•°æ®å—å­˜å‚¨åˆ°ç£ç›˜ä¸Šï¼›è¿™ä¸€æ–¹æ¡ˆç®€å•ã€å®¹æ˜“å®ç°ï¼Œè®°å½•æ–‡ä»¶ç”¨åˆ°çš„ç£ç›˜å—ä»…éœ€è®°ä½ç¬¬ä¸€å—çš„åœ°å€ï¼Œå¹¶ä¸”æ€§èƒ½è¾ƒå¥½ï¼Œä¸€æ¬¡æ“ä½œå°±å¯è¯»å‡ºæ•´ä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå®ƒæœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·ã€‚åœ¨åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œå¿…é¡»çŸ¥é“æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ï¼Œå¦åˆ™æ— æ³•ç¡®å®šéœ€è¦ä¸ºå®ƒä¿ç•™å¤šå°‘ç£ç›˜ç©ºé—´ã€‚å› æ­¤ï¼Œè¿ç»­å­˜å‚¨ä¸»è¦é€‚åˆäºæ–‡ä»¶æ•°æ®ä¸€æ¬¡æ€§å†™å…¥çš„ç³»ç»Ÿï¼ˆä¾‹å¦‚romfsï¼‰ è¿æ¥è¡¨å­˜å‚¨ï¼šå°†æ¯ä¸ªæ–‡ä»¶ç”¨ç£ç›˜å—é¡ºåºè¿æ¥èµ·æ¥ï¼›è™½ç„¶ç”¨äºé“¾æ¥ç£ç›˜å—çš„æŒ‡é’ˆå¯ä»¥ä½¿ç”¨ç£ç›˜å—æœ¬èº«çš„ç©ºé—´ï¼Œä½†è¿™å°†ä½¿å¾—æ¯ä¸ªç£ç›˜å—å®é™…å­˜å‚¨çš„æ•°æ®å­—èŠ‚æ•°ä¸å†æ˜¯2çš„å¹‚ï¼Œç»™ä¸Šå±‚åº”ç”¨ç¨‹åºå¸¦æ¥ä¸ä¾¿ã€‚æ–‡ä»¶ç³»ç»Ÿä»ç£ç›˜å—ä¸­å–å‡ºä¸€äº›æŒ‡é’ˆï¼Œä½œä¸ºç´¢å¼•å­˜æ”¾åœ¨æ–‡ä»¶åˆ†é…è¡¨FATã€‚åªéœ€è¦è®°å½•æ–‡ä»¶çš„èµ·å§‹ç£ç›˜å—ç¼–å·ï¼Œé¡ºç€æ–‡ä»¶åˆ†é…è¡¨ä¸­ç´¢å¼•æŒ‡é’ˆç»„ç»‡æˆçš„é“¾è¡¨ï¼Œå°±å¯ä»¥æ‰¾åˆ°æ–‡ä»¶çš„æ‰€æœ‰ç£ç›˜å—ã€‚ inodeå­˜å‚¨ï¼šæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªç§°ä¸ºnodeçš„è¡¨ï¼›é€šè¿‡å®ƒè·å–æ‰€æœ‰ç£ç›˜çš„ç¼–å·ï¼›å°æ–‡ä»¶çš„æ‰€æœ‰ç£ç›˜å—ç¼–å·éƒ½ç›´æ¥å­˜æ”¾åœ¨inodeå†…ã€‚ç¨å¤§çš„ä¸€äº›æ–‡ä»¶ï¼Œinodeè®°å½•äº†ä¸€ä¸ªç§°ä¸ºä¸€æ¬¡é—´æ¥å—çš„ç£ç›˜å—ç¼–å·ï¼Œè¿™ä¸ªç£ç›˜å—å­˜æ”¾ç€æ–‡ä»¶çš„å…¶ä»–ç£ ç›˜å—ç¼–å·ã€‚å¦‚æœæ–‡ä»¶å†æ‰©å¤§ï¼Œå¯ä»¥åœ¨inodeä¸­è®°å½•äºŒæ¬¡é—´æ¥å—ç¼–å·ï¼ŒäºŒæ¬¡é—´æ¥å—å­˜æ”¾ç€å¤šä¸ªä¸€æ¬¡é—´æ¥å—çš„ç¼–å·ï¼Œè€Œæ¯ä¸ªä¸€æ¬¡é—´æ¥å—åˆå­˜æ”¾ç€æ–‡ä»¶çš„å…¶ä»–ç£ç›˜å—ç¼–å·ã€‚å¦‚æœè¿™ä¹Ÿä¸å¤Ÿçš„è¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸‰æ¬¡é—´æ¥å—ã€‚æœ¬ç« è¦è®¨è®ºçš„Minixæ–‡ä»¶ç³»ç»Ÿï¼Œå°±ä½¿ç”¨çš„è¿™ç§åˆ†é…æ–¹æ¡ˆ  Linuxå°†æ–‡ä»¶ç³»ç»Ÿåˆ†ä¸ºä¸¤å±‚ï¼š\n  ä¸Šå±‚ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¼€å…³å±‚ï¼Œç®€ç§°ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼šå®ƒæ˜¯å…·ä½“æ–‡ä»¶ç³»ç»Ÿå’Œä¸Šå±‚åº”ç”¨ä¹‹é—´çš„æ¥å£å±‚ï¼Œå°†å„ç§ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå’Œç®¡ç†çº³å…¥ä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ï¼Œä½¿å¾—ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒå„ç§ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ç»†èŠ‚ã€‚VFSç”±è¶…çº§å—ã€inodeã€dentryã€vfsmountç­‰ä¿¡æ¯ç»„æˆ\n  ä¸‹å±‚ä¸ºå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œå¦‚Minixã€EXT2/3/4ã€sysfsç­‰ã€‚å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°ä»£ç ç»„ç»‡æˆæ¨¡å—å½¢å¼ï¼Œå‘Linux VFSæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå¤„ç†å’Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå¯†åˆ‡ç›¸å…³çš„ç»†èŠ‚æ“ä½œ\n\r\n  æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ Linuxæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ä¹‹é—´çš„å…³ç³»å¯ä»¥æ¦‚æ‹¬ä¸ºæ–‡ä»¶ç³»ç»Ÿç±»å‹ã€è¶…çº§å—ã€inodeã€dentryå’Œvfsmountä¹‹é—´çš„å…³ç³»ï¼›\nLinuxæœ‰ä¸€é¢—å…¨å±€æ–‡ä»¶ç³»ç»Ÿæ ‘ï¼Œåæ˜ äº†Linux VFSå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼›\n\r\næ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿè£…è½½å®ä¾‹æœ‰å››ä¸ªå¿…å¤‡å…ƒç´ ï¼švfsmountã€è¶…çº§å—ã€æ ¹inodeå’Œæ ¹dentryã€‚\nè£…è½½æ–‡ä»¶ç³»ç»Ÿ æ–‡ä»¶ç³»ç»Ÿè¦è¢«ä½¿ç”¨å°±åº”è¯¥è¢«è£…è½½ã€‚ä½“ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè£…è½½å®ä¾‹è¦ç´ æ˜¯ï¼švfsmountã€super_blockã€æ ¹dentryå’Œæ ¹inodeï¼›\n\r\nåœ¨å†…æ ¸è§’åº¦ï¼Œè£…è½½è¿‡ç¨‹ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸­çš„get_sbå°†è¢«è°ƒç”¨ï¼Œå®ƒå°†ç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿè£…è½½å¯¹è±¡vfsmountï¼Œå¹¶å’Œè¯¥æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„ä¸€ä¸ªè¶…çº§å—å®ä¾‹å…³è”èµ·æ¥ï¼›\n","date":"2022-05-12T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%80%E9%98%85/1_hudd81952809099175edb54de5cef86875_45536_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%80%E9%98%85/","title":"Linux-æ–‡ä»¶ç³»ç»Ÿ(ç®€é˜…)"},{"content":"raidæ˜¯ä»€ä¹ˆ raidæ˜¯å»‰ä»·å†—ä½™ç£ç›˜é˜µåˆ—ï¼Œç®€ç§°ç£ç›˜é˜µåˆ—ã€‚\nraid:æ˜¯ä¸€ç§æŠŠå¤šå—ç‹¬ç«‹çš„ç‰©ç†ç£ç›˜æŒ‰ä¸åŒçš„æŠ€æœ¯ç»„åˆèµ·æ¥çš„å½¢æˆçš„ä¸€ä¸ªç£ç›˜ç»„ï¼Œåœ¨é€»è¾‘ä¸Šçœ‹èµ·æ¥æ˜¯ä¸€å—å¤§çš„ç£ç›˜ï¼Œå¯ä»¥æä¾›æ¯”è¾ƒå•ä¸ªçš„ç‰©ç†ç£ç›˜æ›´å¤§çš„å­˜å‚¨å®¹é‡æˆ–æ›´é«˜çš„å­˜å‚¨æ€§èƒ½ï¼ŒåŒæ—¶æœ‰èƒ½æä¾›ä¸åŒçº§åˆ«æ•°æ®çš„å†—ä½™å¤‡ä»½çš„ä¸€ç§æŠ€æœ¯\nraidçš„çº§åˆ« æŠŠå¤šä¸ªç‰©ç†ç£ç›˜é€šè¿‡ä¸åŒçš„æŠ€æœ¯æ–¹å¼ç»„æˆçš„ç£ç›˜é˜µåˆ—ï¼Œä¸åŒçš„æŠ€æœ¯ç§°ä¸ºraidçº§åˆ«ã€‚\nçº§åˆ«ä¸€èˆ¬æœ‰ï¼šraid0,raid1,raid0+1(raid10),raid2,raid3,raid4,raid5,raid6,raid7,raid53\nç”Ÿäº§ç¯å¢ƒå¸¸ç”¨çš„çº§åˆ«ä¸ºï¼šraid0,raid1,raid10,raid5\nraidçº§åˆ«çš„æ¯”è¾ƒ    raidçº§åˆ« ä¼˜ç‚¹ ç¼ºç‚¹ å®é™…ä½¿ç”¨åœºæ™¯     raid0 è¯»å†™é€Ÿåº¦å¿« æ²¡æœ‰å†—ä½™ mysql slave,é›†ç¾¤çš„èŠ‚ç‚¹rs   raid1 100%å†—ä½™ï¼Œé•œåƒ è¯»å†™æ€§èƒ½ä¸€èˆ¬ï¼Œæˆæœ¬é«˜ å•ç‹¬çš„ï¼Œæ•°æ®é‡è¦ï¼Œä¸”å®•æœºçš„ä¸šåŠ¡ï¼Œç›‘æ§ï¼Œç³»ç»Ÿç›˜   raid5 å…·å¤‡ä¸€å®šçš„æ€§èƒ½å’Œå†—ä½™ï¼Œå¯åä¸€å—ç›˜ï¼Œè¯»å†™æ€§èƒ½ä¸é”™ å†™å…¥æ€§èƒ½ä¸é«˜ ç”¨äºä¸€èˆ¬çš„ä¸šåŠ¡   raid10 è¯»å†™é€Ÿåº¦å¿«ï¼Œ100%å†—ä½™ æˆæœ¬é«˜ æ€§èƒ½å’Œå†—ä½™çš„ä¸šåŠ¡è¦æ±‚é«˜çš„ä¸šåŠ¡    raidæŠ€æœ¯åˆ†ç±» è½¯raidæŠ€æœ¯ åœ¨linuxä¸­ï¼Œé€šè¿‡è‡ªå¸¦è½¯ä»¶å°±èƒ½å®ç°è½¯raidåŠŸèƒ½ï¼Œå®ƒçš„é…ç½®é«˜ï¼Œç®¡ç†æ–¹ä¾¿ï¼Œå¯ä»¥æ˜¯å®ç°å°†å°†å‡ ä¸ªç‰©ç†ç›˜åˆæˆä¸€ä¸ªæ›´å¤§çš„è™šæ‹Ÿè®¾å¤‡ï¼Œä»è€Œåˆ°è¾¾æ€§èƒ½çš„æ”¹è¿›åˆæ•°æ®çš„å†—ä½™çš„ç›®çš„\nç¡¬raidæŠ€æœ¯ åŸºäºç¡¬ä»¶çš„raidè§£å†³æ–¹æ¡ˆæ¯”åŸºäºè½¯ä»¶çš„raidæŠ€æœ¯åœ¨ä½¿ç”¨çš„æ€§èƒ½åˆæœåŠ¡å™¨ä¸Šæ›´å¥½ï¼Œå…·ä½“è¡¨ç°åœ¨æ£€æµ‹å’Œä¿®å¤å¤šä½é”™è¯¯çš„èƒ½åŠ›ï¼Œé”™è¯¯çš„ç£ç›˜è‡ªåŠ¨æ£€æµ‹å’Œé˜µåˆ—é‡å»ºç­‰æ–¹é¢ï¼Œä»å®‰å…¨æ€§ä¸Šè€ƒè™‘ï¼ŒåŸºäºç¡¬ä»¶çš„raidçš„è§£å†³æ–¹æ¡ˆæ›´åŠ çš„å®‰å…¨\nraid0åŸç†åŠç‰¹ç‚¹ \r\nç‰¹ç‚¹ï¼š  è¯»å†™æ€§èƒ½é«˜ æ²¡æœ‰å†—ä½™ å¯ç”¨ç©ºé—´N*minï¼ˆs1,S2\u0026hellip;ï¼‰ æœ€å°‘ç£ç›˜æ•°ä¸ºï¼Œ2ï¼Œ2+  raid1ç‰¹ç‚¹ \r\nç‰¹ç‚¹  è¯»æ€§èƒ½æå‡ï¼Œå†™æ€§èƒ½é™ä½ å¯ç”¨ç©ºé—´ä¸ºï¼šminï¼ˆs1,S2\u0026hellip;ï¼‰ å¯å†—ä½™ æœ€å°‘ç£ç›˜æ•°ä¸ºï¼š2ï¼Œ2+  raid5ç‰¹ç‚¹ \r\nç‰¹ç‚¹ï¼š  è¯»æ€§èƒ½æœ‰æå‡ï¼Œå†™æ€§èƒ½æœ‰æ‰€æ¬ ç¼º å¯ç”¨ç©ºé—´ä¸ºï¼šï¼ˆn-1ï¼‰*min(s1,s2,\u0026hellip;) æœ‰å†—ä½™ï¼Œæœ‰ä¸€å—ç£ç›˜ æœ€å°‘ç£ç›˜æ•°ï¼š3ï¼Œ3+  raid10ç‰¹ç‚¹ \r\nç‰¹ç‚¹ï¼š  è¯»å†™æ€§èƒ½æœ‰æå‡ å¯ç”¨ç©ºé—´ï¼šN*minï¼ˆs1,s2\u0026hellip;ï¼‰/2 æœ‰å†—ä½™ï¼Œæ¯ç»„æœ€å¤šåä¸€å— æœ€å°‘ç£ç›˜æ•°ä¸ºï¼š4ï¼Œ4+  RAID5çš„åŸºæœ¬æ¶æ„ RAID5çš„è¯»å†™æ“ä½œé‡‡ç”¨çš„æ˜¯stripeçš„åŸºæœ¬ç»“æ„ï¼Œå³ä»¥stripeä¸ºè¯»å†™çš„åŸºæœ¬å•ä½ï¼Œå‡è®¾ä¸€ä¸ª3+1çš„RAID5ï¼Œå³3ä¸ªæ•°æ®ç›˜+1ä¸ªæ ¡éªŒç›˜ï¼Œé‚£ä¹ˆä¸€ä¸ªstripeå°±åŒ…å«3ä¸ªæ•°æ®å—å’Œä¸€ä¸ªæ ¡éªŒå—ï¼›\n\r\nå¦‚å›¾æ‰€ç¤ºï¼Œè¿™æ˜¯ä¸€ä¸ª3+1çš„RAID5ï¼Œå›¾ä¸­çš„æ¯ä¸€ä¸ªæ–¹å—è¡¨ç¤ºä¸€ä¸ªstripeçš„ä¸€ä¸ªåŸºæœ¬å•å…ƒï¼Œåˆç§°ä¸ºchunkï¼›ç›¸åŒé¢œè‰²çš„æ–¹å—ç»„æˆä¸€ä¸ªstripeï¼Œå³æ¯ä¸ªstripeç”±3ä¸ªæ•°æ®chunk(A,B,C)+1ä¸ªæ ¡éªŒchunk(P)ç»„æˆã€‚å…³äºæ ¡éªŒå—çš„ç”Ÿæˆæ–¹æ³•ä»¥åŠæ•°æ®æ¢å¤åŸç†å¦‚ä¸‹ï¼š\n  æ ¡éªŒå—Pçš„ç”Ÿæˆæ–¹æ³•ä¸ºP=AâŠ•BâŠ•C ã€‚(âŠ•è¡¨ç¤ºå¼‚æˆ–è¿ç®—)\n  åŠ å…¥1å·ç›˜åäº†ï¼Œæ­¤æ—¶æœ‰è¯»è¯·æ±‚è¯»B0å—çš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡B0=A0âŠ•C0âŠ•P0 çš„æ–¹æ³• æ¥è¿›è¡Œæ¢å¤\n  ","date":"2022-04-30T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-raid%E5%AD%A6%E4%B9%A0/1_huf00169aa6abc51faa601f0bf72d243b8_76358_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-raid%E5%AD%A6%E4%B9%A0/","title":"Linux-raidå­¦ä¹ "},{"content":"å­˜å‚¨è®¾å¤‡ ç£ç›˜æŸœ ç£ç›˜æŸœä¸€èˆ¬åˆ†ä¸ºç£ç›˜é˜µåˆ—ï¼ˆdisk arrayï¼‰å’Œç£ç›˜æ—ï¼ˆjbodï¼‰ä¸¤ç§ï¼›\nRAIDï¼ˆRedundant Array of Independent Disksï¼‰ï¼Œå³â€œç‹¬ç«‹ç£ç›˜å†—ä½™é˜µåˆ—â€æˆ–è€…ç®€ç§° ä¸ºâ€œç£ç›˜é˜µåˆ—â€ï¼ŒåŸºæœ¬æ€æƒ³å°±æ˜¯æŠŠå¤šä¸ªç‹¬ç«‹çš„ç£ç›˜ç»„åˆèµ·æ¥ï¼Œæˆä¸ºä¸€ä¸ªç£ç›˜é˜µåˆ—ç»„ï¼Œä»¥ è·å¾—ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹é¢çš„å¥½å¤„ï¼šå¢åŠ å®¹é‡ï¼ˆCapacityï¼‰ã€æå‡æ€§èƒ½ï¼ˆPerformanceï¼‰ã€å¢å¼º å®¹é”™æ€§ï¼ˆRedundancyï¼‰å’Œé™ä½æˆæœ¬ï¼ˆCostï¼‰ã€‚ JBODï¼ˆJust a Bundle Of Disksï¼‰è¯‘æˆä¸­æ–‡å¯ä»¥æ˜¯â€œç®€å•ç£ç›˜æ†ç»‘â€æˆ–è€…â€œç£ç›˜ç°‡â€ã€‚åœ¨ Linuxä¸­ï¼Œå®ƒç›¸å½“äºLinear RAIDæ¨¡å¼ï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†çš„RAIDçº§åˆ«ï¼ŒJBODåœ¨é€»è¾‘ä¸ŠæŠŠå‡  ä¸ªç‰©ç†ç£ç›˜ä¸€ä¸ªæ¥ä¸€ä¸ªä¸²è”åˆ°ä¸€èµ·ï¼Œä»è€Œæä¾›ä¸€ä¸ªå¤§çš„é€»è¾‘ç£ç›˜ã€‚\nNASå­˜å‚¨è®¾å¤‡ NASæ˜¯ä¸€ç§å°†å­˜å‚¨è®¾å¤‡å’Œåº”ç”¨æœåŠ¡å™¨åˆ†å¼€çš„æœºåˆ¶ï¼Œå®ƒä½¿ç”¨CIFSå’ŒNFSå‘å®¢æœç«¯æä¾›æ–‡ä»¶çº§æœåŠ¡ã€‚\n\rå›¾(1)\r\niSCSIå­˜å‚¨è®¾å¤‡ isCSIå­˜å‚¨è®¾å¤‡æ—¢ä»¥ç¡¬ä»¶æ–¹å¼æˆ–è€…è½¯ä»¶æ–¹å¼å®ç°IsCSIåè®®ç›®æ ‡ç«¯çš„å­˜å‚¨è®¾å¤‡ã€‚\niSCSIï¼Œå³Internet SCSIæˆ–SCSI over TCP/IPï¼Œæ˜¯IETFåˆ¶å®šçš„ä¸€é¡¹åŸºäºIPçš„å­˜å‚¨ç½‘ç»œæ ‡ å‡†ï¼Œç”¨äºè¿æ¥æ•°æ®å­˜å‚¨è®¾å¤‡ã€‚é€è¿‡åœ¨IPç½‘ç»œä¸Šä¼ è¾“SCSIå‘½ä»¤ï¼ŒiSCSIå¯ä»¥æ‘†è„±SCSIæ€»çº¿ çš„è·ç¦»é™åˆ¶ã€‚iSCSIè¢«ç”¨äºåœ¨å±€åŸŸç½‘ï¼ˆLANï¼‰ã€å¹¿åŸŸç½‘ï¼ˆWANï¼‰æˆ–è€…Internetä¸Šä¼ è¾“æ•° æ®ï¼Œå®ç°ä½ç½®æ— å…³çš„æ•°æ®å­˜å‚¨åŠæ£€ç´¢ã€‚iSCSIæ˜¯ä¸€ä¸ªå¹¿ä¸ºæµè¡Œçš„å­˜å‚¨åŒºåŸŸç½‘ç»œåè®®ï¼Œå… è®¸ä¼ä¸šå°†å­˜å‚¨å½’å¹¶åˆ°æ•°æ®ä¸­å¿ƒï¼ŒåŒæ—¶å‘åº”ç”¨æœåŠ¡å™¨æä¾›æ— åŒºåˆ«äºæœ¬åœ°ç£ç›˜çš„å¹»æƒ³ã€‚å’Œ ä¼ ç»Ÿçš„Fibre Channelä¸åŒï¼ŒiSCSIä¸éœ€è¦ä¸“ç”¨çš„çº¿ç¼†ï¼Œå¯ä»¥åœ¨ç°æœ‰çš„ç½‘ç»œåŸºç¡€è®¾æ–½ä¸Šé•¿ è·ç¦»ä¼ è¾“ã€‚\n\rå›¾(2)\r\nNAS/iSCSIé›†æˆå­˜å‚¨è®¾å¤‡ NAS/iSCSIé›†æˆå­˜å‚¨è®¾å¤‡ç»“åˆäº†NASå­˜å‚¨è®¾å¤‡å’ŒiSCSIå­˜å‚¨ è®¾å¤‡çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶æ”¯æŒiSCSIç£ç›˜å’Œæœ¬åœ°ç£ç›˜ï¼Œå¯¹å¤–æ”¯æŒCIFSåè®®å’ŒiSCSIåè®®ï¼Œå³æ”¯ æŒå—æ•°æ®å’Œæ–‡ä»¶æ•°æ®ï¼Œç†è®ºä¸Šå¯ä»¥æ•´åˆæ— é™çš„å­˜å‚¨å®¹é‡ï¼Œæ„å»ºRAIDå’ŒLVMï¼Œçµæ´»é…ç½® æˆçº¯æ–‡ä»¶æœåŠ¡å™¨ã€çº¯iSCSIç›®æ ‡å™¨ï¼Œæˆ–è€…å°†å­˜å‚¨ç©ºé—´åˆ†åˆ«ç”¨äºæ–‡ä»¶æœåŠ¡å’Œå—æœåŠ¡ã€‚\n\rå›¾(3)\r\nLinux é©±åŠ¨æ¨¡å‹ Linuxå†…æ ¸åŸºäºkobjectå†…æ ¸å¯¹è±¡æœºåˆ¶å°†ç³»ç»Ÿä¸­çš„æ€»çº¿ã€è®¾å¤‡å’Œé©±åŠ¨è®¾å¤‡åˆ†åˆ«ç”¨bus_typeã€deviceå’Œdevice_driverç­‰å¯¹è±¡æè¿°å°†å…¶ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡ç»“æ„çš„ç³»ç»Ÿï¼Œç»Ÿä¸€ç®¡ç†å„ç§å†…åˆ«çš„è®¾å¤‡ä»¥å…¶æ¥å£ï¼ŒåŒæ—¶å€ŸåŠ©sysdfsæ–‡ä»¶ç³»ç»Ÿå°†å…¶å†…æ ¸æ‰€è§çš„è®¾å¤‡å±•ç»™ç”¨æˆ·ç©ºé—´ï¼Œæä¾›ä¸€ä¸ªå®Œå…¨å±‚æ¬¡ç»“æ„çš„ç”¨æˆ·è§†å›¾ã€‚\n\rå›¾(4)\r\nLinuxé©±åŠ¨æ¨¡å‹çš„æ ¸å¿ƒå†…å®¹ç»¼åˆå¦‚ä¸‹ï¼š\n ä»¥å†…æ ¸å¯¹è±¡ä¸ºåŸºç¡€ ç”¨sysfsæ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´ å°†Linuxå­ç³»ç»Ÿè¡¨è¾¾ä¸ºæ€»çº¿ç±»å‹/é©±åŠ¨/è®¾å¤‡/ç±»/æ¥å£çš„å…³ç³»ï¼Œåˆ†åˆ«ç”¨bus_typeã€deviceã€device_driverã€classå’Œclass_interfaceç»“æ„è¡¨ç¤º  å¼•ç”¨è®¡æ•° å¼•ç”¨è®¡æ•°çš„ä¸»è¦åŠŸèƒ½ä¸ºï¼š\n é˜²æ­¢å†…å­˜æ³„æ¼ï¼šç¡®ä¿å·²åˆ†é…çš„å¯¹è±¡æœ€ç»ˆä¼šè¢«é‡Šæ”¾ï¼› é˜²æ­¢è®¿é—®å·²é‡Šæ”¾çš„å†…å­˜ï¼šç¡®ä¿ä¸ä¼šä½¿ç”¨å·²ç»è¢«é‡Šæ”¾çš„å¯¹è±¡  Linuxå†…æ ¸æä¾›äº†ç›¸å…³å‡½æ•°è¿›è¡Œæ“ä½œï¼š\n void kref_init (struct kref *kref);åˆå§‹åŒ–å¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨æ¬¡æ•°è®¾ç½®ä¸º1ï¼Œè€Œä¸æ˜¯0ï¼›è¿™æ˜¯å› ä¸ºç”Ÿæˆè¯¥å¯¹è±¡çš„ä»£ç ä¹Ÿéœ€è¦æœ€åˆçš„å¼•ç”¨ï¼Œä»¥é˜²æ­¢å…¶ä»–éƒ¨åˆ†åœ¨è°ƒç”¨kref_putæ—¶é‡Šæ”¾è¯¥å¯¹è±¡ void kref_get (struct kref *kref); é€’å¢å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚åœ¨è¿™ä¹‹å‰ï¼Œç¡®ä¿å¼•ç”¨æ¬¡æ•°ä¸ä¸º0ï¼Œå¦åˆ™ç­”åº”ä¸€æ¡è­¦å‘Šä¿¡æ¯ã€‚è¿™å¯ä»¥é˜²æ­¢å¸¸è§çš„é”™è¯¯ï¼šä¸å…ˆè°ƒç”¨kref_initï¼Œè€Œç›´æ¥è°ƒç”¨kref_getã€‚ int kref_put (struct kref *kref, void (*release) (struct kref *kref));é€’å‡å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å¦‚æœè¯¥è®¡æ•°å‡ä¸º0ï¼Œåˆ™è¡¨æ˜æ˜¯è¯¥å¯¹è±¡çš„æœ€åä¸€ä¸ªå¼•ç”¨ï¼Œå› æ­¤ä¼ å…¥çš„releaseå‡½æ•°è¢«è°ƒç”¨ï¼Œä»¥å›æ”¶è¿™ä¸ªå¯¹è±¡ç”¨åˆ°çš„å†…å­˜ã€‚  å†…æ ¸å¯¹è±¡åŠé›†åˆ Linuxé©±åŠ¨æ¨¡å‹çš„åŸºç¡€æ˜¯å†…æ ¸å¯¹è±¡ã€‚å®ƒå°†æ€»çº¿ç±»å‹ã€è®¾å¤‡ã€é©±åŠ¨ç­‰éƒ½çœ‹ä½œæ˜¯å†…æ ¸å¯¹ è±¡ã€‚è¡¨ç¤ºå†…æ ¸å¯¹è±¡çš„ç»“æ„æ˜¯kobjectï¼Œç›¸å½“äºLinuxé©±åŠ¨æ¨¡å‹çš„â€œåŸºç±»â€\nåœ¨Linuxå†…æ ¸ä¸­çš„åŒå¾ªç¯é“¾è¡¨å®ç°æ–¹å¼ä¸‹ï¼š â— é“¾è¡¨ç»“æ„ä½œä¸ºä¸€ä¸ªæˆå‘˜åµŒå…¥åˆ°å®¿ä¸»æ•°æ®ç»“æ„å†…ï¼› â— å¯ä»¥å°†é“¾è¡¨ç»“æ„æ”¾åœ¨å®¿ä¸»ç»“æ„å†…çš„ä»»ä½•åœ°æ–¹ï¼› â— å¯ä»¥ä¸ºé“¾è¡¨ç»“æ„å–ä»»ä½•åå­—ï¼› â— å®¿ä¸»ç»“æ„å¯ä»¥æœ‰å¤šä¸ªé“¾è¡¨ç»“æ„ã€‚\n\rå›¾(5)\r\nsysfsæ–‡ä»¶ç³»ç»Ÿ sysfsæ ¸å¿ƒè´Ÿè´£ä¸ºå†…æ ¸ä¸­çš„å†…éƒ¨è¡¨ç¤ºå’Œç”¨æˆ·ç©ºé—´çš„å¤–éƒ¨å‘ˆç°ä¹‹é—´å»ºç«‹å¯¹åº”å…³ç³»ï¼Œä¹Ÿç§°ä¸ºsysfsæ˜ å°„ï¼š\n å†…æ ¸å¯¹è±¡è¢«æ˜ å°„ä¸ºç”¨æˆ·ç©ºé—´çš„ç›®å½• å¯¹è±¡å±æ€§è¢«æ˜ å°„ä¸ºç”¨æˆ·ç©ºé—´çš„å¸¸è§„æ–‡ä»¶ å¯¹è±¡å…³ç³»è¢«æ˜ å°„ä¸ºç”¨æˆ·ç©ºé—´çš„ç¬¦å·é“¾æ¥  sysfsæ ¸å¿ƒç¡®å®å°†å†…æ ¸å¯¹è±¡ã€å¯¹è±¡å±æ€§ä»¥åŠå¯¹è±¡å…³ç³»ä¹Ÿç»„ç»‡æˆæ ‘çš„ç»“æ„ã€‚sysfså†…éƒ¨æ ‘ä¸­æœ‰å››ç§ç±»å‹çš„èŠ‚ç‚¹ï¼šç›®å½•èŠ‚ç‚¹ã€é“¾æ¥èŠ‚ç‚¹ã€å±æ€§èŠ‚ç‚¹å’ŒäºŒè¿›åˆ¶å±æ€§èŠ‚ç‚¹ï¼Œåˆ†åˆ«å’Œå†…æ ¸å¯¹è±¡ã€å¯¹è±¡å…³ç³»ã€å¯¹è±¡å±æ€§ç›¸å¯¹åº”ã€‚\n\rå›¾(6)\r\né©±åŠ¨æ¨¡å‹å¯¹è±¡ Linuxé©±åŠ¨æ¨¡å‹é€‚ç”¨äºlinuxå„ç§å­ç³»ç»Ÿï¼Œå®ƒæè¿°äº†æ€»çº¿ç±»å‹ã€è®¾å¤‡ã€é©±åŠ¨ä»¥åŠç±»å’Œæ¥å£ä¹‹é—´çš„å…³ç³»ã€‚æ¯ä¸€ä¸ªå­ç³»ç»Ÿéƒ½æœ‰å±äºè‡ªå·±çš„å”¯ä¸€çš„æ€»çº¿ç±»å‹ã€‚å®ƒä¸Šé¢é“¾æ¥äº†æ³¨å†Œäº†è¿™ä¸€æ€»çº¿ç±»å‹çš„å¤šä¸ªè®¾å¤‡ã€‚å¦å¤–å®ƒè¿˜æ³¨å†Œäº†åˆ°è¿™ä¸ªæ€»çº¿ç±»å‹çš„å¤šä¸ªé©±åŠ¨é“¾æ¥åœ¨ä¸€èµ·ã€‚\næ€»çº¿ç±»å‹ï¼šLinuxé©±åŠ¨æ¨¡å‹ä¸­çš„æ€»çº¿ç±»å‹ç»“æ„ä½¿ç”¨bus_typeå’Œbus_type_privateä¸¤ä¸ªç»“æ„ä½“æ¥è¡¨ ç¤º\nè®¾å¤‡ï¼šLinuxé©±åŠ¨æ¨¡å‹ä¸­çš„è®¾å¤‡ï¼Œæˆ‘ä»¬æœ‰æ—¶ç®€ç§°ä¸ºé©±åŠ¨æ¨¡å‹è®¾å¤‡ï¼Œä½¿ç”¨deviceå’Œdevice_privateä¸¤ä¸ªç»“æ„ä½“æ¥è¡¨ç¤º\né©±åŠ¨ï¼šåŒæ€»çº¿ç±»å‹å’Œè®¾å¤‡ä¸€æ ·ï¼Œåœ¨Linuxé©±åŠ¨æ¨¡å‹ä¸­è¡¨ç¤ºä¸€ä¸ªé©±åŠ¨ä¹Ÿéœ€è¦ä¸¤ä¸ªç»“æ„ä½“ï¼šdevice_driverå’Œdriver_privateã€‚è¿™ä¸¤ä¸ªç»“æ„ä½“åŒæ—¶å­˜åœ¨ï¼Œå¹¶ä¸”ä¸€ä¸€å¯¹åº”ã€‚\nPCIå­ç³»ç»Ÿ PCIæ˜¯å¤–å›´è®¾å¤‡äº’è”çš„ç®€ç§°ï¼Œæ˜¯ä¸€ç§é€šç”¨æ€»çº¿çš„æ¥å£æ ‡å‡†ã€‚PCIæ€»çº¿æ˜¯ä¸€ç§å¸¸è§çš„ä¸»æœºI/Oæ€»çº¿ï¼Œç”¨äºé“¾æ¥é«˜é€Ÿçš„å¤–éƒ¨è®¾å¤‡ã€‚\nPCIæ€»çº¿ä½“ç³»æ˜¯ç»“æ„æ˜¯ä¸€ç§å±‚æ¬¡å¼çš„ä½“ç³»ç»“æ„ã€‚\n\rå›¾(7)\r\nâ— PCIè®¾å¤‡ï¼šéµå¾ªPCIè§„èŒƒï¼Œå·¥ä½œåœ¨PCIå±€éƒ¨æ€»çº¿ç¯å¢ƒä¸‹çš„è®¾å¤‡ã€‚å…¸å‹çš„PCIè®¾å¤‡ æ˜¯å°è£…åœ¨é›†æˆçº¿è·¯æ¿ï¼ˆIC Packageï¼‰ä¸­ï¼Œæˆ–è€…é›†æˆåˆ°PCIæ‰©å±•å¡ä¸Šçš„å®Œæ•´çš„å¤–å›´å…ƒä»¶é€‚ é…å™¨ã€‚é€šå¸¸è§åˆ°çš„æœ‰ç½‘ç»œã€æ˜¾ç¤ºæˆ–è€…SCSIé€‚é…å™¨ã€‚PCIå±€éƒ¨æ€»çº¿è§„èŒƒæŒ‡å‡ºï¼Œæ¯ä¸ªPCIè®¾ å¤‡å¯ä»¥åŒ…å«æœ€å¤š8ä¸ªPCIåŠŸèƒ½ï¼Œæ¯ä¸ªåŠŸèƒ½æ˜¯ä¸€ä¸ªé€»è¾‘è®¾å¤‡ã€‚ â— PCIæ¡¥è®¾å¤‡ï¼šç”±äºç”µå­è´Ÿè½½é™åˆ¶ï¼Œæ¯æ¡PCIæ€»çº¿ä¸Šå¯ä»¥æŒ‚è½½çš„è®¾å¤‡æ•°ç›®æ˜¯æœ‰é™ çš„ï¼Œå› æ­¤ä½¿ç”¨äº†ä¸€ç§ç‰¹æ®Šçš„è®¾å¤‡ï¼Œå³PCI-PCIæ¡¥è®¾å¤‡ã€‚PCI-PCIæ¡¥ä¸ºä¸¤æ¡ç‹¬ç«‹çš„PCIæ€»çº¿ æä¾›è¿æ¥ã€‚PCI-PCIæ¡¥è®¾å¤‡ä¹Ÿæ˜¯ä¸€ç§å¹¿ä¹‰ä¸Šçš„PCIè®¾å¤‡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼ŒPCI-PCIæ¡¥è®¾å¤‡ç®€ç§° PCIæ¡¥ã€‚ â— ä¸»æ¡¥è®¾å¤‡ï¼šPCIæ¡¥è®¾å¤‡å’ŒPCIè®¾å¤‡æœ€ç»ˆé€šè¿‡Host-PCIæ¡¥è®¾å¤‡è¿æ¥åˆ°CPUï¼Œä½¿æ•´ä¸ª ç³»ç»Ÿçœ‹èµ·æ¥åƒä¸€é¢—å€’ç½®çš„æ ‘çŠ¶ç»“æ„ï¼Œæ ‘çš„é¡¶ç«¯æ˜¯CPUå’Œå†…å­˜ã€‚ç”±Host-PCIæ¡¥è®¾å¤‡å¼•å‡ºçš„ PCIæ€»çº¿ä¹Ÿç§°ä¸ºPCIæ ¹æ€»çº¿ã€‚åœ¨æœ¬æ–‡ä¸­ï¼ŒHost-PCIæ¡¥è®¾å¤‡ç®€ç§°ä¸ºä¸»æ¡¥ã€‚\nPCIå­ç³»ç»Ÿå¯¹è±¡ åœ¨PICå­ç³»ç»Ÿä¸­æœ‰PCIæ€»çº¿å’ŒPCIè®¾å¤‡ï¼ŒåŸºäºè¿™ä¸¤ä¸ªæ ¸å¿ƒçš„xæŠ½è±¡ï¼Œlinux PCIå­ç³»ç»Ÿå®šä¹‰äº†ä¸¤ä¸ªå…³é”®çš„æ•°æ®ç»“æ„ï¼špci_buså’Œpci_dev,ä»¥æ­¤æ¥æè¿°PCIæ€»çº¿å’ŒPCIè®¾å¤‡\n\rå›¾(8)\r\npci_busï¼šPCIæ€»çº¿ï¼špci_busæ˜¯æè¿°PCIæ€»çº¿çš„ç»“æ„ã€‚æ— è®ºæ˜¯æ ¹PCIæ€»çº¿ï¼Œè¿˜æ˜¯éæ ¹PCIæ€»çº¿ï¼Œéƒ½å¯¹åº”ä¸€ä¸ªpci_busæè¿°ç¬¦\npci_devï¼šPCIè®¾å¤‡ï¼šç”±äºæ¯æ¡PCIæ€»çº¿ä¸Šå¯ä»¥æŒ‚è½½çš„ç‰©ç†è®¾å¤‡æ•°ç›®æ˜¯æœ‰é™çš„ï¼Œå› æ­¤ä½œä¸ºæ‰©å±•ï¼Œæ¯ä¸ªç‰©ç†è®¾å¤‡å¯ä»¥åŒ…å«å¤šä¸ªåŠŸèƒ½ï¼Œå³é€»è¾‘è®¾å¤‡ã€‚ä»ç‰©ç†ç¡¬ä»¶çš„è§’åº¦ï¼ŒPCIè®¾å¤‡å®é™…ä¸ŠæŒ‡çš„æ˜¯åŒ…å«ä»ä¸€ä¸ªåˆ°å…«ä¸ªâ€œåŠŸèƒ½â€çš„æŸä¸ªPCIç¡¬ä»¶ï¼Œå®ƒè¢«é›†æˆåˆ°ç³»ç»Ÿä¸»æ¿ä¸Šï¼Œæˆ–è€…å®‰è£…åœ¨æ’æ§½ä¸­ï¼Œè¿™æ˜¯PCIç‰©ç†ç¡¬ä»¶çš„æ¦‚å¿µ\nSCSIå­ç³»ç»Ÿ Linux SCSIå­ç³»ç»Ÿæ˜¯ä¸€ç§åˆ†å±‚çš„æ¶æ„ï¼Œå…±ä¸‰å±‚ã€‚\n  ä½å±‚ï¼šæœ€ä½ä¸€å±‚ä»£è¡¨æ˜¯é€‚ç”¨äºSCSIçš„ç‰©ç†æ¥å£çš„å®é™…é©±åŠ¨å™¨ã€‚\n  ä¸­é—´å±‚ï¼Œä¹Ÿç§°å…¬å…±å±‚æˆ–ç»Ÿä¸€å±‚ï¼Œåœ¨è¿™ä¸€å±‚åŒ…å«SCSIå †æ ˆçš„é«˜å±‚å’Œåº•å±‚çš„å…¬å…±æœåŠ¡å‡½æ•°ã€‚\n  é«˜å±‚ï¼šé«˜å±‚ä»£è¡¨ç€å„ç§SCSIè®¾å¤‡ç±»å‹çš„é©±åŠ¨ã€‚\n\rå›¾(9)\r\n  SCSIå­ç³»ç»Ÿå¯¹è±¡ Scsi_Hostã€scsi_targetå’Œscsi_deviceåˆ†åˆ«æè¿°çš„æ˜¯Linux SCSIæ¨¡å‹ä¸­çš„ä¸»æœºé€‚é…å™¨ã€ç›®æ ‡èŠ‚ç‚¹å’Œé€»è¾‘å•å…ƒã€‚\n\rå›¾(10)\r\n","date":"2022-04-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_hub95fcc2a246a65208e8832126d70bee7_36058_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","title":"Linuxå­˜å‚¨æŠ€æœ¯å­¦ä¹ ç¬”è®°"},{"content":"åŸºæœ¬æ¦‚å¿µ å—è®¾å¤‡ï¼ˆblock deviceï¼‰ æ˜¯ä¸€ç§æœ‰ä¸€å®šç»“æ„çš„éšæœºå­˜å–çš„è®¾å¤‡ï¼Œå¯¹äºè¿™ç§è®¾å¤‡çš„è¯»å†™æ˜¯æŒ‰å—è¿›è¡Œçš„ï¼Œä»–ä½¿ç”¨çš„ç¼“å†²åŒºæ¥å­˜æ”¾æš‚æ—¶çš„æ•°æ®ï¼Œè¾¾åˆ°ä¸€å®šæ¡ä»¶åã€‚ä»ç¼“å­˜ä¸€æ¬¡æ€§å†™å…¥è®¾å¤‡æˆ–è€…ä»è®¾å¤‡ä¸€æ¬¡æ€§è¯»åˆ°ç¼“å†²åŒº\nå­—ç¬¦è®¾å¤‡ï¼ˆcharacter deviceï¼‰ æ˜¯ä¸€ç§é¡ºåºçš„æ•°æ®è®¾å¤‡ï¼Œå¯¹äºè¿™ç§è®¾å¤‡çš„è¯»å†™æ˜¯æŒ‰å­—ç¬¦è¿›è¡Œçš„ï¼Œè¿ç»­çš„å­—ç¬¦ç»„æˆæ•°æ®æµï¼Œæ˜¯æ²¡æœ‰ç¼“å†²åŒºï¼Œæ˜¯åªç”¨å®æ—¶çš„è¯»å†™è®¾å¤‡ï¼›\nå—è®¾å¤‡ä¸å­—ç¬¦è®¾å¤‡ä¹‹é—´çš„åŒºåˆ«  è¯»å†™æ•°æ®çš„å•å…ƒä¸åŒï¼šå—è®¾å¤‡æ˜¯ä»¥å—ä¸ºè¯»å†™å•å…ƒï¼Œè€Œå­—ç¬¦è®¾å¤‡æ˜¯ä»¥å­—ç¬¦ä¸ºè¯»å†™å•å…ƒ å—è®¾å¤‡æ˜¯å¯ä»¥éšæœºè®¿é—®ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½é¡ºåºè®¿é—®  æ‰‡åŒºï¼ˆsectorsï¼‰ æ˜¯å—è®¾å¤‡ç¡¬ä»¶å¯¹æ•°æ®å¤„ç†çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸1æ‰‡åŒº=512byte\nå—ï¼ˆblocksï¼‰ æ˜¯Linuxç§åˆ¶å®šå¯¹å†…æ ¸æˆ–æ–‡ä»¶ç³»ç»Ÿç­‰æ•°æ®å¤„ç†çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸1å—=1ä¸ªæˆ–å¤šä¸ªæ‰‡åŒº\næ®µï¼ˆsegmentsï¼‰ æ˜¯ç”±è‹¥å¹²ä¸ªç›¸é‚»çš„å—ç»„æˆã€‚æ˜¯linuxå†…å­˜ç®¡ç†æœºåˆ¶ä¸­ä¸€ä¸ªå†…å­˜é¡µæˆ–è€…å†…å­˜é¡µä¸­çš„ä¸€éƒ¨åˆ†\né¡µã€æ®µã€å—ã€æ‰‡åŒºä¹‹é—´çš„å…³ç³»å¦‚å›¾ \rå›¾(1)\r\nå—è®¾å¤‡çš„å±‚æ¬¡ \rå›¾(2)\r\n  Linuxæ˜¯æ”¯æŒå¤šç§ä¸åŒå­˜å‚¨ä»‹è´¨ï¼Œåœ¨å†…æ ¸ä¸­é—´éƒ½è¦é€‚é…æœ‰å—è®¾å¤‡é©±åŠ¨ç¨‹åºæ¥è¯»å†™å—è®¾å¤‡ã€‚\n  å¾€ä¸Šæ˜¯ioè°ƒåº¦å±‚ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™è¯·æ±‚è¿›è¡Œç¼–æ’ï¼Œåˆå¹¶ç”¨ä»¥æé«˜ç£ç›˜çš„è¯»å†™æ•ˆç‡ã€‚\n  é€šç”¨å—å±‚ï¼Œå¯¹åº”ä¸bioç»“æ„ã€‚æ˜¯å°†ioè¯·æ±‚çš„æŠ½è±¡ï¼Œæè¿°å¯¹åº”çš„ioæ“ä½œæ¶‰åŠåˆ°å¤šä¸ªé¡µ\nå—è®¾å¤‡çš„åº”ç”¨åœ¨linuxä¸­æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­ç³»ç»Ÿ åœ¨linuxä¸­ï¼Œé©±åŠ¨å¯¹å—è®¾å¤‡çš„ä¸­è¾“å…¥æˆ–è€…è¾“å‡ºï¼ˆioï¼‰æ“ä½œéƒ½ä¼šå‘å—è®¾å¤‡å‘å‡ºè¯·æ±‚ï¼Œåœ¨é©±åŠ¨ä¸­ä½¿ç”¨requestç»“æ„ä½“æè¿°ã€‚\nå¯¹äºä¸€äº›ç£ç›˜è®¾å¤‡è¯·æ±‚çš„é€Ÿåº¦å¾ˆæ…¢ï¼Œå†…æ ¸æä¾›ä¸€ç§é˜Ÿåˆ—çš„æœºåˆ¶ï¼Œå°†è¿™äº›ioè¯·æ±‚æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼ˆå³ï¼šè¯·æ±‚é˜Ÿåˆ—ï¼‰ï¼Œåœ¨é©±åŠ¨ä¸­ä½¿ç”¨request_queueç»“æ„ä½“è¿›è¡Œæè¿°ã€‚åœ¨å‘å—è®¾å¤‡æäº¤è¿™äº›è¯·æ±‚å‰å†…æ ¸ä¼šå…ˆæ‰§è¡Œè¯·æ±‚åˆå¹¶å’Œæ’åºçš„é¢„æ“ä½œï¼Œä»¥æé«˜è®¿é—®çš„æ•ˆç‡ï¼Œç„¶ååœ¨ç”±å†…æ ¸ä¸­çš„ioè°ƒåº¦ç¨‹åºå­ç³»ç»Ÿæ¥è´Ÿè´£æäº¤ioè¯·æ±‚ï¼Œè°ƒåº¦ç¨‹åºå°†ç£ç›˜åˆ†é…ç»™ç³»ç»Ÿä¸­æ‰€æœ‰æŒ‚èµ·çš„å—ioè¯·æ±‚ï¼Œå…¶å·¥ä½œæ˜¯ç®¡ç†å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ã€‚\nåœ¨ç”±é€šç”¨å±‚ï¼ˆgeneric block layerï¼‰è´Ÿè´£ç»´æŒä¸€ä¸ªioè¯·æ±‚åœ¨ä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿä¸åº•å±‚ç‰©ç†ç£ç›˜ä¹‹é—´çš„å…³ç³»ï¼Œåœ¨é€šç”¨å±‚ä¸­ï¼Œé€šå¸¸ç”¨ä¸€ä¸ªbioç»“æ„ä½“æ¥å¯¹åº”ä¸€ä¸ªioè¯·æ±‚ã€‚\nlinuxæä¾›ä¸€ä¸ªgendiskæ•°æ®ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡æˆ–è€…æ˜¯åˆ†åŒºï¼Œç”¨æ¥å¯¹åº•å±‚ç‰©ç†ç£ç›˜çš„è®¿é—®ã€‚åœ¨gendiskä¸­æœ‰ä¸€ä¸ªç±»ä¼¼äºå­—ç¬¦è®¾å¤‡ä¸­çš„file_operationsçš„ç¡¬ä»¶æ“ä½œç»“æ„æŒ‡é’ˆï¼Œæ˜¯block_device_operationsç»“æ„ä½“ã€‚\nå½“å¤šä¸ªè¯·æ±‚åœ¨æäº¤å—è®¾å¤‡æ—¶ã€‚æ‰§è¡Œçš„æ•ˆç‡ä¾èµ–äºè¯·æ±‚çš„é¡ºåºã€‚å¦‚æœè¯·æ±‚çš„é€Ÿåº¦æ˜¯åŒä¸€æ–¹å‘ï¼Œæ‰§è¡Œæ•ˆç‡æœ€å¤§ã€‚å†…æ ¸åœ¨è°ƒç”¨å—è®¾å¤‡é©±åŠ¨ç¨‹åºè¯·æ±‚ä¹‹å‰ï¼Œå…ˆæ”¶é›†ioè¯·æ±‚å¹¶å°†è¯·æ±‚è¿›è¡Œæ’åºï¼Œç„¶åå°†è¿ç»­æ‰‡åŒºæ“ä½œçš„è¯·æ±‚è¿›è¡Œåˆå¹¶ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚\nå—è®¾å¤‡çš„ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´ ç¼“å†²åŒºå¯¹åº”ä¸€ä¸ªç£ç›˜å—ï¼Œå½“ç£ç›˜å—è¢«è°ƒå…¥å†…å­˜æ—¶ï¼Œå°±å­˜å‚¨åœ¨ç¼“å†²åŒºï¼›å—åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ‰‡åŒºï¼Œä¸”ä¸å¤§äºä¸€ä¸ªé¡µï¼Œæ‰€ä»¥ä¸€ä¸ªé¡µå¯ä»¥å®¹çº³ä¸€ä¸ªæˆ–è€…å¤šä¸ªå—ï¼Œå¹¶å­˜å‚¨ä¸€äº›æ§åˆ¶ä¿¡æ¯ã€‚æ§åˆ¶ä¿¡æ¯ä¸€èˆ¬æ˜¯ä½¿ç”¨ç»“æ„ä½“buff-headæ¥è¡¨ç¤ºï¼Œç»“æ„ä½“å¦‚ä¸‹ï¼š\n  struct buffer_head{ unsigned long b_state; /* æ ‡å¿—ä½ */ struct buffer_head *b_this_page; /* é¡µé¢ä¸­çš„ç¼“å†²åŒº */ struct page *b_page; /* å½“å‰é¡µé¢ */ sector_t b_blocknr; /* èµ·å§‹å—å· */ size_t size; /* æ˜ åƒçš„å¤§å° */ char *b_data; /* æ•°æ®æŒ‡é’ˆ */ struct block_device *b_bdev; /* å…³è”çš„å—è®¾å¤‡ */ atomic_t b_count; /* ä½¿ç”¨è®¡æ•° */ ... }; è¯·æ±‚ç»“æ„request ç»“æ„requestä»£è¡¨äº†æŒ‚èµ·çš„ioè¯·æ±‚ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚ç”¨åŒä¸€ä¸ªç»“æ„requestå®ä¾‹è¿›è¡Œæè¿°ï¼Œå­˜æ”¾åœ¨è¯·æ±‚é˜Ÿåˆ—é“¾è¡¨ä¸­ï¼Œç”±ç”µæ¢¯ç®—æ³•è¿›è¡Œæ’åºï¼Œæ¯ä¸€ä¸ªè¯·æ±‚åŒ…å«1ä¸ªæˆ–å¤šä¸ªç»“æ„ä½“bioå®ä¾‹ï¼Œå…¶ç»“æ„ä½“å¦‚ä¸‹ï¼š\nstruct request { //ç”¨äºæŒ‚åœ¨è¯·æ±‚é˜Ÿåˆ—é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œä½¿ç”¨å‡½æ•°blkdev_dequeue_requestè®¿é—®å®ƒï¼Œè€Œä¸èƒ½ç›´æ¥è®¿ é—® struct list_head queuelist; struct list_head donelist; /*ç”¨äºæŒ‚åœ¨å·²å®Œæˆè¯·æ±‚é“¾è¡¨çš„èŠ‚ç‚¹*/ struct request_queue *q; /*æŒ‡å‘è¯·æ±‚é˜Ÿåˆ—*/ unsigned int cmd_flags; /*å‘½ä»¤æ ‡è¯†*/ enum rq_cmd_type_bits cmd_type; /*å‘½ä»¤ç±»å‹*/ /*å„ç§å„æ ·çš„æ‰‡åŒºè®¡æ•°*/ /*ä¸ºæäº¤i/oç»´æŠ¤bioæ¨ªæ–­é¢çš„çŠ¶æ€ä¿¡æ¯ï¼Œhard_*æˆå‘˜æ˜¯å—å±‚å†…éƒ¨ä½¿ç”¨çš„ï¼Œé©±åŠ¨ç¨‹åºä¸åº”è¯¥æ”¹å˜ å®ƒä»¬*/ sector_t sector; /*å°†æäº¤çš„ä¸‹ä¸€ä¸ªæ‰‡åŒº*/ sector_t hard_sector; /* å°†å®Œæˆçš„ä¸‹ä¸€ä¸ªæ‰‡åŒº*/ unsigned long nr_sectors; /* æ•´ä¸ªè¯·æ±‚è¿˜éœ€è¦ä¼ é€çš„æ‰‡åŒºæ•°*/ unsigned long hard_nr_sectors; /* å°†å®Œæˆçš„æ‰‡åŒºæ•°*/ /*åœ¨å½“å‰bioä¸­è¿˜éœ€è¦ä¼ é€çš„æ‰‡åŒºæ•° */ unsigned int current_nr_sectors; /*åœ¨å½“å‰æ®µä¸­å°†å®Œæˆçš„æ‰‡åŒºæ•°*/ unsigned int hard_cur_sectors; struct bio *bio; /*è¯·æ±‚ä¸­ç¬¬ä¸€ä¸ªæœªå®Œæˆæ“ä½œçš„bio*ã€ struct bio *biotail; /*è¯·æ±‚é“¾è¡¨ä¸­æœ«å°¾çš„bio*ã€ struct hlist_node hash; /*èåˆ hash */ /* rb_nodeä»…ç”¨åœ¨I/Oè°ƒåº¦å™¨ä¸­ï¼Œå½“è¯·æ±‚è¢«ç§»åˆ°åˆ†å‘é˜Ÿåˆ—ä¸­æ—¶ï¼Œ è¯·æ±‚å°†è¢«åˆ é™¤ã€‚å› æ­¤ï¼Œè®©completion_dataä¸rb_nodeåˆ†äº«ç©ºé—´*/ union { struct rb_node rb_node; /* æ’åº/æŸ¥æ‰¾*/ void *completion_data; }; bioç»“æ„ä½“ é€šå¸¸1ä¸ªbioå¯¹åº”1ä¸ªioè¯·æ±‚ï¼Œioè°ƒåº¦ç®—æ³•å¯å°†è¿ç»­çš„bioåˆå¹¶æˆ1ä¸ªè¯·æ±‚ã€‚æ‰€ä»¥ä¸€ä¸ªè¯·æ±‚å¯ä»¥åŒ…å«å¤šä¸ªbioã€‚\nbioä¸ºé€šç”¨å±‚çš„ä¸»è¦æ•°æ®ç»“æ„ï¼Œå³æè¿°äº†ç£ç›˜çš„ä½ç½®ï¼Œåˆæè¿°äº†å†…å­˜çš„ä½ç½®ï¼Œæ˜¯ä¸Šå±‚å†…æ ¸vfsä¸ä¸‹å±‚é©±åŠ¨çš„è¿æ¥çº½å¸¦ï¼Œå…¶ç»“æ„ä½“å¦‚ä¸‹ï¼š\nstruct bio { sector_t bi_sector;//è¯¥bioç»“æ„æ‰€è¦ä¼ è¾“çš„ç¬¬ä¸€ä¸ªï¼ˆ512å­—èŠ‚ï¼‰æ‰‡åŒºï¼šç£ç›˜çš„ä½ç½® struct bio *bi_next; //è¯·æ±‚é“¾è¡¨ struct block_device *bi_bdev;//ç›¸å…³çš„å—è®¾å¤‡ unsigned long bi_flags//çŠ¶æ€å’Œå‘½ä»¤æ ‡å¿— unsigned long bi_rw; //è¯»å†™ unsigned short bi_vcnt;//bio_vescåç§»çš„ä¸ªæ•° unsigned short bi_idx; //bi_io_vecçš„å½“å‰ç´¢å¼• unsigned short bi_phys_segments;//ç»“åˆåçš„ç‰‡æ®µæ•°ç›® unsigned short bi_hw_segments;//é‡æ˜ å°„åçš„ç‰‡æ®µæ•°ç›® unsigned int bi_size; //I/Oè®¡æ•° unsigned int bi_hw_front_size;//ç¬¬ä¸€ä¸ªå¯åˆå¹¶çš„æ®µå¤§å°; unsigned int bi_hw_back_size;//æœ€åä¸€ä¸ªå¯åˆå¹¶çš„æ®µå¤§å° unsigned int bi_max_vecs; //bio_vecsæ•°ç›®ä¸Šé™ struct bio_vec *bi_io_vec; //bio_vecé“¾è¡¨ï¼šå†…å­˜çš„ä½ç½® bio_end_io_t *bi_end_io;//I/Oå®Œæˆæ–¹æ³• atomic_t bi_cnt; //ä½¿ç”¨è®¡æ•° void *bi_private; //æ‹¥æœ‰è€…çš„ç§æœ‰æ–¹æ³• bio_destructor_t *bi_destructor; //é”€æ¯æ–¹æ³• }; å†…å­˜æ•°æ®æ®µç»“æ„bio_vec ç»“æ„bio_vecä»£è¡¨äº†å†…å­˜ä¸­çš„ä¸€ä¸ªæ•°æ®æ®µï¼Œæ•°æ®æ®µç”¨é¡µã€åç§»å’Œé•¿åº¦æ è¿°ã€‚I/Oéœ€è¦æ‰§è¡Œçš„å†…å­˜ä½ç½®ç”¨æ®µè¡¨ç¤ºï¼Œç»“æ„bioæŒ‡å‘äº†ä¸€ä¸ªæ®µçš„æ•°ç»„ã€‚ ç»“æ„bio_vecåˆ—å‡ºå¦‚ä¸‹ï¼ˆåœ¨include/linux/bio.hä¸­ï¼‰ï¼š struct bio_vec { struct page *bv_page; /*æ•°æ®æ®µæ‰€åœ¨çš„é¡µ*/ unsigned short bv_len; /*æ•°æ®æ®µçš„é•¿åº¦*/ unsigned short bv_offset; /*æ•°æ®æ®µé¡µå†…åç§»*/ }; å—è®¾å¤‡ç»“æ„ä½“ block_device å†…æ ¸ç”¨ç»“æ„ä½“block_deviceå®ä¾‹ä»£è¡¨ä¸€ä¸ªå—è®¾å¤‡å¯¹è±¡ï¼Œå—è®¾å¤‡çš„ç»“æ„ä½“ä¸ºblock_deviceå¦‚ä¸‹\nstruct block_device { dev_t bd_dev; /* not a kdev_t - it\u0026#39;s a search key */ struct inode * bd_inode; /* åˆ†åŒºèŠ‚ç‚¹ */ struct super_block * bd_super; int bd_openers; struct mutex bd_mutex;/* open/close mutex æ‰“å¼€ä¸å…³é—­çš„äº’æ–¥é‡*/ struct semaphore bd_mount_sem; /*æŒ‚è½½æ“ä½œä¿¡å·é‡*/ struct list_head bd_inodes; void * bd_holder; int bd_holders; #ifdef CONFIG_SYSFS  struct list_head bd_holder_list; #endif  struct block_device * bd_contains; unsigned bd_block_size; /*åˆ†åŒºå—å¤§å°*/ struct hd_struct * bd_part; unsigned bd_part_count; /*æ‰“å¼€æ¬¡æ•°*/ int bd_invalidated; struct gendisk * bd_disk; /*è®¾å¤‡ä¸ºç¡¬ç›˜æ—¶ï¼ŒæŒ‡å‘é€šç”¨ç¡¬ç›˜ç»“æ„*/ struct list_head bd_list; struct backing_dev_info *bd_inode_backing_dev_info; unsigned long bd_private; /* The counter of freeze processes */ int bd_fsfreeze_count; /* Mutex for freeze */ struct mutex bd_fsfreeze_mutex; }; é€šç”¨ç¡¬ç›˜ç»“æ„ gendisk ç»“æ„gendiskä»£è¡¨äº†ä¸€ä¸ªé€šç”¨ç¡¬ç›˜ï¼ˆgenreic hard diskï¼‰å¯¹è±¡ï¼Œå®ƒå­˜å‚¨äº†ä¸€ä¸ªç¡¬ç›˜çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯·æ±‚é˜Ÿåˆ—ï¼Œåˆ†åŒºé“¾è¡¨å’Œå—è®¾å¤‡æ“ä½œå‡½æ•°é›†ç­‰ã€‚å—è®¾å¤‡é©±åŠ¨ç¨‹åºåˆ†é…ç»“æ„gendiskå®ä¾‹ï¼Œè£…è½½åˆ†åŒºè¡¨ï¼Œåˆ†é…è¯·æ±‚é˜Ÿåˆ—å¹¶å¡«å……ç»“æ„çš„å…¶ä»–åŸŸã€‚å…¶ç»“æ„ä½“å¦‚ä¸‹ï¼š\nstruct gendisk { int major; /* é©±åŠ¨ç¨‹åºçš„ä¸»è®¾å¤‡å· */ int first_minor; /*ç¬¬ä¸€ä¸ªæ¬¡è®¾å¤‡å·*/ int minors; /*æ¬¡è®¾å¤‡å·çš„æœ€å¤§æ•°é‡ï¼Œæ²¡æœ‰åˆ†åŒºçš„è®¾å¤‡ï¼Œæ­¤å€¼ä¸º1 */ char disk_name[32]; /* ä¸»è®¾å¤‡å·é©±åŠ¨ç¨‹åºçš„åå­—*/ struct hd_struct **part; /* åˆ†åŒºåˆ—è¡¨ï¼Œç”±æ¬¡è®¾å¤‡å·æ’åº */ struct block_device_operations *fops; /*å—è®¾å¤‡æ“ä½œå‡½æ•°é›†*/ struct request_queue *queue; /*è¯·æ±‚é˜Ÿåˆ—*/ struct blk_scsi_cmd_filter cmd_filter; void *private_data; /*ç§æœ‰æ•°æ®*/ sector_t capacity; /* å‡½æ•°set_capacityè®¾ç½®çš„å®¹é‡ï¼Œä»¥æ‰‡åŒºä¸ºå•ä½*/ int flags; /*è®¾ç½®é©±åŠ¨å™¨çŠ¶æ€çš„æ ‡å¿—ï¼Œå¦‚ï¼šå¯ç§»åŠ¨ä»‹è´¨ä¸º GENHD_FL_REMOVABLE*/ struct device dev; /*ä»è®¾å¤‡é©±åŠ¨æ¨¡å‹åŸºç±»ç»“æ„deviceç»§æ‰¿*/ struct kobject *holder_dir; struct kobject *slave_dir; struct timer_rand_state *random; int policy; atomic_t sync_io; /* RAID */ unsigned long stamp; int in_flight; #ifdef CONFIG_SMP  struct disk_stats *dkstats; #else /*ç¡¬ç›˜ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚ï¼šè¯»æˆ–å†™çš„æ‰‡åŒºæ•°ã€èåˆçš„æ‰‡åŒºæ•°ã€åœ¨è¯·æ±‚é˜Ÿåˆ—çš„æ—¶é—´ç­‰*/ struct disk_stats dkstats; #endif  struct work_struct async_notify; #ifdef CONFIG_BLK_DEV_INTEGRITY  struct blk_integrity *integrity; /*ç”¨äºæ•°æ®å®Œæ•´æ€§æ‰©å±•*/ #endif }; å—è®¾å¤‡å„ä¸ªç»“æ„ä½“é—´çš„å…³ç³» \rå›¾(3)\r\n","date":"2022-04-02T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux%E5%86%85%E6%A0%B8%E4%B8%AD%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/1_huf160ae63de05609269a7d8cc29249a6e_88106_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux%E5%86%85%E6%A0%B8%E4%B8%AD%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/","title":"Linuxå†…æ ¸ä¸­è®¾å¤‡é©±åŠ¨"},{"content":"æ€§èƒ½  é«˜å¹¶å‘å’Œå¿«å“åº”çš„æ€§èƒ½æŒ‡æ ‡æ˜¯æŒ‡ï¼šååå’Œå»¶æ—¶ æ€§èƒ½çš„æœ¬è´¨ï¼šç³»ç»Ÿèµ„æºå·²ç»åˆ°è¾¾ç“¶é¢ˆæ—¶ï¼Œå¤„ç†è¯·æ±‚ä¸å¤Ÿå¿«ï¼Œä¸è¶³ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚ æ€§èƒ½åˆ†æï¼šæ‰¾åˆ°ç³»ç»Ÿæˆ–è€…åº”ç”¨çš„ç“¶é¢ˆï¼Œå°½æœ€å¤§çš„å¯èƒ½é¿å…æˆ–è€…ç¼“è§£è¿™æ ·çš„ç“¶é¢ˆã€‚ å¸¸ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·ï¼š \r  cupä¸Šä¸‹æ–‡åˆ‡æ¢  cupä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå°†ä¸Šä¸€ä¸ªä»»åŠ¡cupçš„ä¸Šä¸‹æ–‡ä¿å­˜ç³»ç»Ÿçš„å†…æ ¸ä¸­ä¼‘çœ ï¼Œç„¶åå°†æ–°ä»»åŠ¡çš„cupä¸Šä¸‹æ–‡è¿›è¡ŒåŠ è½½ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªæ–°ä»»åŠ¡ã€‚ cupçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯åˆ†ä¸ºï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚åœ¨å†…æ ¸ä¸­ä¸­æ–­çš„ç­‰çº§ä¸è¿›ç¨‹å’Œçº¿ç¨‹çš„ç­‰çº§é«˜ï¼Œæ‰€ä»¥ä¿è¯äº†ä¸­æ–­ä¸Šä¸‹æ–‡ åˆ‡æ¢ä¸è¿›ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸åŒæ—¶å‘ç”Ÿã€‚ é€šè¿‡vmstatå¯ä»¥æŸ¥çœ‹ç³»ç»Ÿæ€»ä½“çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µ \r  è¿›ç¨‹ä¸Šä¸‹åˆ‡æ¢   linuxè¿›ç¨‹æŒ‰ç…§ç­‰çº§æƒé™å°†è¿›ç¨‹çš„è¿è¡Œç©ºé—´åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·æ€ç©ºé—´ã€‚å…¶ä¸­ç”¨æˆ·æ€å‘å†…æ ¸æ€è½¬æ¢éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ éœ€è¦è¿›è¡Œä¸¤æ¬¡cpuçš„ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ†åˆ«ä¸ºï¼š\n   CPUå¯„å­˜å™¨ä¸­ç”¨æˆ·æ€çš„æŒ‡ä»¤ä½ç½®å…ˆä¿å­˜èµ·æ¥ï¼ŒCPUå¯„å­˜å™¨æ›´æ–°ä¸ºå†…æ ¸æ€æŒ‡ä»¤çš„ä½ç½®ï¼Œè·³è½¬åˆ°å†…æ ¸æ€è¿è¡Œå†…æ ¸ä»»åŠ¡ï¼›\nç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼ŒCPUå¯„å­˜å™¨æ¢å¤åŸæ¥ä¿å­˜çš„ç”¨æˆ·æ€æ•°æ®ï¼Œå†åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´ç»§ç»­è¿è¡Œã€‚\n   è¿›ç¨‹æ˜¯ç”±å†…æ ¸ç®¡ç†å’Œè°ƒåº¦çš„ï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åªèƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ã€‚å› æ­¤ç›¸æ¯”ç³»ç»Ÿè°ƒç”¨æ¥è¯´ï¼Œåœ¨ä¿å­˜å½“å‰è¿›ç¨‹çš„å†…æ ¸çŠ¶æ€å’ŒCPUå¯„å­˜å™¨ä¹‹å‰ï¼Œéœ€è¦å…ˆæŠŠè¯¥è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ï¼Œæ ˆä¿å­˜ä¸‹æ¥ã€‚å†åŠ è½½æ–°è¿›ç¨‹çš„å†…æ ¸æ€åï¼Œè¿˜è¦åˆ·æ–°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å’Œç”¨æˆ·æ ˆã€‚\n  è¿›ç¨‹åªæœ‰åœ¨è°ƒåº¦åˆ°CPUä¸Šè¿è¡Œæ—¶æ‰éœ€è¦åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œæœ‰ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼šCPUæ—¶é—´ç‰‡è½®æµåˆ†é…ï¼Œç³»ç»Ÿèµ„æºä¸è¶³å¯¼è‡´è¿›ç¨‹æŒ‚èµ·ï¼Œè¿›ç¨‹é€šè¿‡sleepå‡½æ•°ä¸»åŠ¨æŒ‚èµ·ï¼Œé«˜ä¼˜å…ˆçº§è¿›ç¨‹æŠ¢å æ—¶é—´ç‰‡ï¼Œç¡¬ä»¶ä¸­æ–­æ—¶CPUä¸Šçš„è¿›ç¨‹è¢«æŒ‚èµ·è½¬è€Œæ‰§è¡Œå†…æ ¸ä¸­çš„ä¸­æ–­æœåŠ¡ã€‚\n  çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢  åœ¨åŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåˆ‡æ¢æ—¶ï¼Œåªéœ€è¦åˆ‡æ¢çº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€å¯„å­˜å™¨ç­‰ï¼Œæ¶ˆè€—èµ„æºå°‘ã€‚ åœ¨ä¸åŒè¿›ç¨‹çš„ä¸­çš„çº¿ç¨‹è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåˆ‡æ¢ä¸è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸€è‡´ã€‚  ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢  ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢åªåŒ…æ‹¬å†…æ ¸æ€ä¸­æ–­æœåŠ¡ç¨‹åºæ‰§è¡Œæ‰€éœ€è¦çš„çŠ¶æ€ï¼ˆCPUå¯„å­˜å™¨ï¼Œå†…æ ¸å †æ ˆï¼Œç¡¬ä»¶ä¸­æ–­å‚æ•°ç­‰ï¼‰ï¼ˆCPUå¯„å­˜å™¨ï¼Œå†…æ ¸å †æ ˆï¼Œç¡¬ä»¶ä¸­æ–­å‚æ•°ç­‰ï¼‰  å‚è€ƒæ–‡çŒ®ï¼š æé™å¥½æ–‡ï¼Linux æ€§èƒ½ä¼˜åŒ–å…¨æ™¯æŒ‡å—\n","date":"2022-03-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%BA%8C/3_hu66cf5664c43f449fa744670ec4319b24_173122_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%BA%8C/","title":"linux æ€§èƒ½ä¼˜åŒ–(äºŒ)"},{"content":"Linuxå¸¸ç”¨çš„æ€§èƒ½æŸ¥çœ‹å‘½ä»¤ CPU CPUçš„æ€§èƒ½æŒ‡æ ‡  cupçš„ä½¿ç”¨ç‡åˆ†ä¸ºï¼š    ç”¨æˆ·CPUä½¿ç”¨ç‡ï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·æ€å’Œä½ä¼˜å…ˆçº§ç”¨æˆ·æ€ï¼Œååº”çš„æ˜¯åº”ç”¨ç¨‹åºçš„cpuçš„ä½¿ç”¨æƒ…å†µ ç³»ç»ŸCPUä½¿ç”¨ç‡ï¼Œcpuåœ¨å†…æ ¸æ€è¿è¡Œçš„æ—¶é—´ç™¾åˆ†æ¯”,ä¸åŒ…å«ä¸­æ–­ã€‚ååº”çš„æ˜¯å†…æ ¸çš„ä½¿ç”¨æƒ…å†µ ç­‰å¾…IOçš„CPUä½¿ç”¨ç‡ï¼Œååº”çš„æ˜¯ç³»ç»Ÿä¸ç¡¬ä»¶IOçš„äº¤äº’çš„æƒ…å†µ è½¯/ç¡¬ä¸­æ–­CPUçš„ä½¿ç”¨ç‡ï¼Œååº”çš„ä¸­æ–­çš„å‘ç”Ÿçš„æƒ…å†µ steal CPU / guest CPU, è¡¨ç¤ºè™šæ‹Ÿæœºå ç”¨çš„CPUç™¾åˆ†æ¯”.    åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå¹³å‡è´Ÿè½½ç­‰äºé€»è¾‘CPUä¸ªæ•°(å‡ æ ¸çš„CPU),è¡¨ç¤ºæ¯ä¸ªCUPéƒ½è¢«å……åˆ†ä½¿ç”¨ã€‚å¤§äºè¿™ä¸ªé€»è¾‘CPUä¸ªæ•°è¡¨ç¤ºè´Ÿè½½è¾ƒå¤§ CUPç¼“å­˜ç‡æŒ‡çš„æ˜¯CPUç¼“å­˜çš„å¤ç”¨æƒ…å†µã€‚å‘½ä¸­ç‡è¶Šé«˜è¡¨ç¤ºæ€§èƒ½è¶Šå¥½ï¼Œå…¶ä¸­L1/L2å¸¸ç”¨åœ¨å•æ ¸,L3åˆ™ç”¨åœ¨å¤šæ ¸ä¸­  CPUçš„ä¼˜åŒ–  ç”¨æˆ·æ€çš„ä¼˜åŒ–ï¼Œå³åº”ç”¨ç¨‹åºçš„çš„ä¼˜åŒ–ï¼Œå°½å¯èƒ½çš„å‡å°‘cpuçš„ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ å†…æ ¸æ€çš„ä¼˜åŒ–ï¼Œå³å†…æ ¸çš„ä¼˜åŒ–ï¼Œå¯ä»¥CPUç»‘å®šï¼Œè°ƒæ•´æœ‰ä¼˜å…ˆçº§ï¼Œä¸­æ–­çš„è´Ÿè½½å‡è¡¡ç­‰  æ€§èƒ½å·¥å…·  æ ¹æ®ä¸åŒçš„æ€§èƒ½æŒ‡æ ‡æ¥æ‰¾åˆé€‚çš„å·¥å…·\n\r æ ¹æ®æŒ‡æ ‡æŸ¥æ‰¾ \r  CPUæ€§èƒ½æŸ¥çœ‹  ä½¿ç”¨psæŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ \r \r ä½¿ç”¨topæŸ¥çœ‹å„cupçš„ä½¿ç”¨æƒ…å†µã€å¯¹åº”å†…å­˜ä»¥åŠä¸ªè¿›ç¨‹å cpuå’Œä½¿ç”¨å†…å­˜çš„æƒ…å†µ \r vmstatå‘½ä»¤ï¼šæŸ¥çœ‹CPUè´Ÿè½½ \r  å†…å­˜ä½¿ç”¨æƒ…å†µæŸ¥çœ‹  é™¤äº†ä½¿ç”¨topå¯ä»¥æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µå¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨freeå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ \r  ç£ç›˜I/Oæ€§èƒ½æŸ¥çœ‹  å¯ä»¥ä½¿ç”¨df æˆ–è€… df -h æŸ¥çœ‹ç£ç›˜å ç”¨ç”¨æƒ…å†µ \r iostat -d è¿›è¡ŒæŸ¥çœ‹ \r  æŸ¥çœ‹ç½‘ç»œæƒ…å†µ  ä½¿ç”¨ifconfigæŸ¥çœ‹æˆ–è€…ä¿®æ”¹ç½‘ç»œ \r netstatå‘½ä»¤ï¼š-i æŸ¥çœ‹ç½‘ç»œæ¥å£ä¿¡æ¯ï¼Œ-r æ£€æµ‹ç³»ç»Ÿè·¯ç”±è¡¨ä¿¡æ¯ \r  åŠ¨æ€ç›‘æ§æ€§èƒ½  ä½¿ç”¨watchå‘½ä»¤ï¼šåŠ¨æ€ç›‘æ§ï¼Œé»˜è®¤2ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œç»“æœæ›´æ–°åœ¨å±å¹•ä¸Š \r \r  ","date":"2022-03-05T22:00:38+08:00","image":"https://zcj-git520.github.io/p/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%80/3_hu66cf5664c43f449fa744670ec4319b24_173122_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%80/","title":"linux æ€§èƒ½ä¼˜åŒ–(ä¸€)"},{"content":"æ•°æ®åˆ‡åˆ†  å½“æ•°æ®åº“ä¸­çš„æ•°æ®æˆ–è€…å•è¡¨æ•°æ®è¿‡å¤§æ—¶ï¼Œä¼šå½±å“å¯¹æ•°æ®åº“æŸ¥è¯¢ç­‰æ“ä½œçš„æ•ˆç‡ã€‚æ­¤æ—¶å¯ä»¥å‡è½»æ•°æ®åº“çš„è´Ÿæ‹… å¯ä»¥å°†æ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œå³åˆ†åº“åˆ†è¡¨ã€‚æ¥æé«˜æ•°æ®åº“çš„æ•ˆç‡ã€‚ æ•°æ®åº“æœ‰ä¸¤ç§æ‹†åˆ†æ–¹å¼ï¼šæ°´å¹³åˆ‡åˆ†å’Œå‚ç›´åˆ‡åˆ†  å‚ç›´åˆ‡åˆ† å‚ç›´åˆ†åº“  å‚ç›´åˆ†åº“ï¼šæ ¹æ®ä¸šåŠ¡è§£è€¦ï¼Œä»¥è¡¨ä¸ºå•ä½ï¼Œå°†ç›¸åŒä¸šåŠ¡çš„è¡¨å­˜å‚¨åœ¨åŒä¸€æ•°æ®åº“ä¸­ã€‚å°†å¤§æ•°æ®åº“æ‹†åˆ†ä¸ºä¸åŒçš„å°æ•°æ®åº“ã€‚ å°æ•°æ®åº“çš„ç»“æ„å’Œå­˜å‚¨çš„æ•°æ®ä¸ä¸€æ ·ã€‚å°æ•°æ®åº“çš„å¹¶é›†ä¸ºå¤§æ•°æ®åº“ã€‚ \r ä½¿ç”¨åœºæ™¯é«˜å¹¶å‘æ—¶ï¼Œå°†æ•°æ®åˆ†ç±»åˆ°ä¸åŒæ•°æ®åº“ä¸­ï¼Œæå‡æ•°æ®åº“çš„æŸ¥è¯¢æ•ˆç‡  å‚ç›´åˆ†è¡¨  å‚ç›´åˆ†è¡¨ï¼šæ˜¯ä»¥å­—æ®µä¸ºå•ä½ï¼Œå°†è¡¨ä¸­çš„ä¸å¸¸ç”¨çš„å­—æ®µå’Œå­—æ®µåè¾ƒé•¿çš„å­—æ®µæ‹†åˆ†åˆ°æ‰©å±•è¡¨ä¸­ï¼Œå…¶ä½™æ”¾å…¥åˆ°ä¸»è¡¨ä¸­ã€‚ä¹Ÿå¯ä»¥ç»çƒ­æ•°æ®æ”¾å…¥ä¸»è¡¨ï¼Œå†· æ•°æ®æ”¾å…¥æ‹“å±•è¡¨ã€‚ä¸»è¡¨å’Œæ‹“å±•è¡¨çš„æ•°æ®ç»“æ„å’Œå­˜å‚¨çš„æ•°æ®æ˜¯ä¸ä¸€æ ·ã€‚å°†è¡¨ä¸­çš„è¿›è¡Œå†·çƒ­æ•°æ®çš„æ‹†åˆ†ï¼Œå‡å°‘äº†å¯¹ç£ç›˜ioçš„æ“ä½œï¼Œæå‡æ•°æ®åº“çš„æ•ˆç‡ \r ä½¿ç”¨åœºæ™¯ï¼šè¡¨çš„è®°å½•å¹¶ä¸å¤šï¼Œä½†æ˜¯å­—æ®µå¤šï¼Œå¹¶ä¸”çƒ­ç‚¹æ•°æ®å’Œéçƒ­ç‚¹æ•°æ®åœ¨ä¸€èµ·ï¼Œå•è¡Œæ•°æ®æ‰€éœ€çš„å­˜å‚¨ç©ºé—´è¾ƒå¤§ã€‚ä»¥è‡³äºæ•°æ®åº“ç¼“å­˜çš„æ•°æ®è¡Œå‡å°‘ï¼ŒæŸ¥è¯¢æ—¶ä¼šå»è¯»ç£ç›˜æ•°æ®äº§ç”Ÿå¤§é‡çš„éšæœºè¯»IOï¼Œäº§ç”ŸIOç“¶é¢ˆ  ä¼˜ç¼ºç‚¹  ä¼˜ç‚¹ï¼šä¸šåŠ¡è§£è€¦åˆï¼Œæ–¹ä¾¿å¯¹ä¸åŒä¸šåŠ¡è¿›è¡Œç®¡ç†ï¼Œæå‡æ•°æ®åº“çš„æ•ˆç‡ ç¼ºç‚¹ï¼šéƒ¨åˆ†è¡¨ä¸èƒ½join,è¡¨ä¸­çš„çƒ­æ•°æ®å¤ªå¤š  æ°´å¹³åˆ‡åˆ† æ°´å¹³åˆ†åº“å’Œåˆ†è¡¨  éƒ½æ˜¯ä»¥å­—æ®µä¸ºå•ä½ï¼Œé€šè¿‡å“ˆå¸Œå’Œéšæœºç­‰ç­–ç•¥ï¼Œå°†æ•°æ®åˆ†åˆ°ä¸åŒçš„å­åº“æˆ–è€…å­è¡¨ä¸­ã€‚ æ‰€æœ‰çš„å­åº“å’Œå­è¡¨çš„æ•°æ®ç»“æ„ä¸€æ ·å’Œæ•°æ®ä¸ä¸€è‡´ï¼Œå³æ‰€æœ‰å­åº“çš„æ•°æ®ç­‰äºæ•°æ®åº“ä¸­çš„æ•°æ®ã€‚å½¢æˆåˆ†å¸ƒå¼çš„æ•ˆæœã€‚ \r ä½¿ç”¨åœºæ™¯ï¼šæ•°æ®é‡è¡Œæ•°å·¨å¤§ï¼Œå­˜åœ¨å•åº“è¯»å†™ã€å­˜å‚¨æ€§èƒ½ç“¶é¢ˆï¼Œæ•°æ®é‡å¤ªå¤šï¼Œå½±å“äº†SQLæ•ˆç‡ï¼ŒåŠ é‡äº†CPUè´Ÿæ‹…ï¼Œä»¥è‡³äºæˆä¸ºç“¶é¢ˆã€‚  ä¼˜ç¼ºç‚¹  ä¼˜ç‚¹ï¼šæå‡ç³»ç»Ÿç¨³å®šæ€§å’Œè´Ÿè½½èƒ½åŠ› ç¼ºç‚¹ï¼šäº‹åŠ¡ä¸€è‡´æ€§éš¾ä»¥ä¿è¯  æ•°æ®åº“çš„ç“¶é¢ˆ  æ•°æ®åº“çš„ç“¶é¢ˆå¯åˆ†ä¸ºï¼šioç“¶é¢ˆå’Œcpuç“¶é¢ˆ  ioç“¶é¢ˆ  ç£ç›˜è¯»å†™ioç“¶é¢ˆï¼šå½“çƒ­æ•°æ®è¿‡å¤šæ—¶ï¼Œæ•°æ®åº“å†…å­˜(buffer Pool)ä¿å­˜ä¸ä¸‹æ—¶ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„ioã€‚æ­¤æ—¶å°±éœ€è¦è¿›è¡Œåˆ†åº“å’Œå‚ç›´åˆ†è¡¨ã€‚ ç½‘ç»œioç“¶é¢ˆï¼šè¯·æ±‚çš„æ•°æ®å¤ªå¤šï¼Œç½‘ç»œå¸¦å®½ä¸å¤Ÿï¼Œæ­¤æ—¶å°±éœ€è¦åˆ†åº“ã€‚  CPUç“¶é¢ˆ  sqlä¸­ä½¿ç”¨äº†å¤§é‡çš„cpuè¿ç®—çš„æ“ä½œã€‚æ­¤æ—¶éœ€è¦ä¼˜åŒ–sql,å¦‚å¢åŠ ç´¢å¼• å•è¡¨æ•°æ®é‡å¤§æ—¶ï¼Œä¸”è¿›è¡Œå…¨è¡¨æ‰«æï¼ŒæŸ¥è¯¢æ•ˆç‡ä½æ—¶ï¼Œéœ€è¦æ°´å¹³åˆ†è¡¨åˆ†åº“ã€‚   å‚è€ƒæ–‡çŒ®ï¼š æ•°æ®åº“åˆ†åº“åˆ†è¡¨æ€è·¯\n","date":"2022-03-01T22:00:38+08:00","image":"https://zcj-git520.github.io/p/mysql%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/3_hu5261706da37be2572fd4622db307b63b_273707_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/mysql%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/","title":"mysqlæ€§èƒ½è°ƒä¼˜-åˆ†åº“åˆ†è¡¨"},{"content":"äº‹åŠ¡  äº‹åŠ¡å°±æ˜¯ä¸€ç»„åŸå­æ€§çš„SQLè¯­å¥.  buffer Pool  å½“å¯åŠ¨mysqlä¼šå¼€å¯é»˜è®¤ä¸º128Mçš„å†…å­˜ç©ºé—´æ¥ä¿å­˜ä»ç£ç›˜è·å–çš„é¡µçš„æ•°æ®åˆ°è¿™å—å†…å­˜ç©ºé—´ã€‚ \r InnoDBé€šè¿‡freeé“¾è¡¨æ¥ç®¡ç†buffer Poolä¸­çš„ç©ºé—²é¡µï¼Œé€šè¿‡æ§åˆ¶å—æ¥æŒ‡å‘ç©ºç™½é¡µ.å³ä»ç£ç›˜ä¸­çš„è·å–çš„é¡µæ•°æ®é€šè¿‡ æ§åˆ¶å—æ”¾å…¥åˆ°buffer Poolä¸­å¯¹åº”çš„ç©ºé—²é¡µä¸­ã€‚ é€šè¿‡flushé“¾è¡¨æ¥ç®¡ç†buffer Pollä¸­çš„è„é¡µ(é€šè¿‡äº‹åŠ¡ä¿®æ”¹è¿‡çš„é¡µ)ã€‚é€šè¿‡é“¾è¡¨ä¸­æ§åˆ¶å—æŒ‡å‘è„é¡µã€‚ é€šè¿‡lrué“¾è¡¨æ¥å¯¹Buffer Poolä¸­çš„é¡µè¿›è¡Œæ·˜æ±°ã€‚é€šè¿‡å¤´æ’æ³•å°†æœ€æ–°çš„é¡µæ’å…¥åˆ°é“¾è¡¨ä¸­çš„æ§åˆ¶å—ã€‚å½“buffer Poolä¸­çš„é¡µæ»¡åï¼Œåˆ é™¤é“¾è¡¨æœ€åçš„æ§åˆ¶å—ã€‚ ä¹Ÿå­˜åœ¨å½“å…¨è¡¨æ‰«ææ—¶ï¼Œä¹Ÿé€ æˆæ•°æ®çš„è¦†ç›–ï¼Œæ€§èƒ½ä¸‹é™ã€‚å› æ­¤é“¾è¡¨è¢«åˆ’åˆ†ä¸ºçƒ­æ•°æ®åŒºåŸŸ(5/8)å’Œå†·æ•°æ®åŒºåŸŸ(3/8)ã€‚å½“ä¸¤æ¬¡è®¿é—®é¡µçš„æ—¶é—´å¤§äº1ç§’æ—¶ï¼ŒæŠŠé¡µæ”¾å…¥åˆ°çƒ­æ•°æ®çš„æ§åˆ¶å— ï¼Œå¦åˆ™å°±æ”¾å…¥å†·æ•°æ®é¡µï¼Œé¿å…äº†å…¨è¡¨æ‰«æé€ æˆçƒ­æ•°æ®è¢«è¦†ç›–ã€‚ç”Ÿæˆredo logåï¼Œmysqlé€šè¿‡åå°è¿›ç¨‹ç»å°†è„é¡µæŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å½“MySQLæŒ‚äº†ä¹‹åï¼Œ ä¼šé€šè¿‡redo logæ¢å¤æ•°æ®ã€‚ \r \r  äº‹åŠ¡å…·æœ‰çš„ACIDçš„ç‰¹æ€§  åŸå­æ€§:äº‹åŠ¡ä¸­æ‰€æœ‰çš„æ“ä½œé‚£ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»š ä¸€è‡´æ€§ï¼šæ•°æ®åº“æ€»æ˜¯ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€ éš”ç¦»æ€§ï¼šä¸€ä¸ªäº‹åŠ¡åœ¨æ‰€åšä¿®æ”¹åœ¨æäº¤å‰å¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„ æŒä¹…æ€§ï¼šä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œè¯´æœ‰çš„ä¿®æ”¹éƒ½ä¼šæ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­  äº‹åŠ¡çš„éš”ç¦»çº§åˆ«  è¯»æœªæäº¤ï¼šäº‹åŠ¡ä¸­çš„ä¿®æ”¹å³ä½¿æœªæäº¤ä¹Ÿæ˜¯å¯¹å…¶ä»–äº‹åŠ¡å¯è§ï¼Œè¿™çº§åˆ«çš„äº‹åŠ¡éš”ç¦»æœ‰è„è¯»ã€é‡å¤è¯»ã€å¹»è¯»çš„é—®é¢˜ã€‚ è¯»ä¹Ÿæäº¤ï¼šäº‹åŠ¡æäº¤åæ‰€åšçš„ä¿®æ”¹æ‰ä¼šè¢«å¦ä¸€ä¸ªäº‹åŠ¡æ‰€çœ‹è§ï¼Œå¯èƒ½äº§ç”Ÿä¸€ä¸ªäº‹åŠ¡ä¸­ä¸¤æ¬¡æŸ¥è¯¢çš„ç»“æœä¸åŒã€‚ å¯é‡å¤è¯»ï¼š åªæœ‰å½“å‰äº‹åŠ¡æäº¤æ‰èƒ½çœ‹è§å¦ä¸€ä¸ªäº‹åŠ¡çš„ä¿®æ”¹ç»“æœã€‚è§£å†³äº†ä¸€ä¸ªäº‹åŠ¡ä¸­ä¸¤æ¬¡æŸ¥è¯¢çš„ç»“æœä¸åŒçš„é—®é¢˜ã€‚ å¯ä¸²è¡ŒåŒ–ï¼šåªæœ‰ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åæ‰ä¼šæ‰§è¡Œå¦ä¸€ä¸ªäº‹åŠ¡ã€‚ \r  æ­»é”  æ­»é”ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€èµ„æºä¸Šç›¸äº’å ç”¨å¹¶è¯·æ±‚é”å®šå¯¹æ–¹å ç”¨çš„èµ„æºï¼Œä»è€Œå¯¼è‡´æ¶æ€§å¾ªç¯çš„ç°è±¡ã€‚MySQLçš„éƒ¨åˆ†å­˜å‚¨å¼•æ“èƒ½å¤Ÿæ£€æµ‹åˆ°æ­»é”çš„å¾ªç¯ä¾èµ–å¹¶äº§ç”Ÿç›¸åº”çš„é”™è¯¯ã€‚InnoDBå¼•æ“è§£å†³æ­»é”çš„æ–¹æ¡ˆæ˜¯å°†æŒæœ‰æœ€å°‘æ’å®ƒé”çš„äº‹åŠ¡è¿›è¡Œå›æ»š  MVCCåŸç†  mvcc å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼šæŒ‡åœ¨è¯»å–æ•°æ®æ—¶é€šè¿‡ä¸€ç§ç±»ä¼¼å¿«ç…§çš„æ–¹å¼å°†æ•°æ®ä¿å­˜ä¸‹æ¥ï¼Œè¿™æ ·è¯»é”å’Œå†™é”ä¸å†²çªã€‚æ˜¯ innodb å®ç°äº‹åŠ¡å¹¶å‘ä¸å›æ»šçš„é‡è¦åŠŸèƒ½ã€‚  ç‰ˆæœ¬é“¾  æ¯æ¬¡æ›´æ–°åï¼Œéƒ½ä¼šå°†æ—§å€¼æ”¾åˆ°ä¸€æ¡ undo log ä¸­ï¼Œå°±ç®—æ˜¯è¯¥è®°å½•çš„ä¸€ä¸ªæ—§ç‰ˆæœ¬ï¼Œéšç€æ›´æ–°æ¬¡æ•°çš„å¢å¤šï¼Œæ‰€æœ‰çš„ç‰ˆæœ¬éƒ½ä¼šè¢«roll_ptr å±æ€§è¿æ¥æˆä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸ºç‰ˆæœ¬é“¾ï¼Œç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰è®°å½•æœ€æ–°çš„å€¼   trx_idï¼šæ¯æ¬¡ä¸€ä¸ªäº‹åŠ¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠè¯¥äº‹åŠ¡çš„äº‹åŠ¡idèµ‹å€¼ç»™trx_idéšè—åˆ—ã€‚ roll_pointerï¼šæ¯æ¬¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§çš„ç‰ˆæœ¬å†™å…¥åˆ°undoæ—¥å¿—ä¸­ï¼Œç„¶åè¿™ä¸ªéšè—åˆ—å°±ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥æ‰¾åˆ°è¯¥è®°å½•ä¿®æ”¹å‰çš„ä¿¡æ¯ã€‚\n ReadView  InnoDBæå‡ºäº†ä¸€ä¸ªReadViewçš„æ¦‚å¿µï¼Œè¿™ä¸ªReadView ä¸­æœ‰ä¸ª id åˆ—è¡¨ trx_ids æ¥å­˜å‚¨ç³»ç»Ÿä¸­å½“å‰æ´»è·ƒç€çš„è¯»å†™äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ begin äº†è¿˜æœª commit æˆ– rollback çš„äº‹åŠ¡  å‚è€ƒæ–‡çŒ®ï¼š MySQLè¿è¡ŒåŸç†ä¸åŸºç¡€æ¶æ„\n","date":"2022-02-25T22:00:38+08:00","image":"https://zcj-git520.github.io/p/mysql%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/1_hub1d649ce0ea89887083315ebed128a77_18394_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/mysql%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/","title":"mysqläº‹åŠ¡å®ç°åŸºæœ¬åŸç†"},{"content":"ç´¢å¼•  ç´¢å¼•æ˜¯å¸®åŠ©æ•°æ®åº“è·å–æœ‰åºæ•°æ®çš„æ•°æ®ç»“æ„ï¼Œå®ç°å¿«é€Ÿæ£€ç´¢  æ•°æ®åº“ç´¢å¼•çš„æ•°æ®ç»“æ„ å“ˆå¸Œè¡¨(hash)  é€šè¿‡å“ˆå¸Œå‡½æ•°ï¼Œå®ç°key-valueçš„å­˜å‚¨ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨å¼€æ”¾åœ°å€æ³•å’Œæ‹‰é“¾æ³•è§£å†³å“ˆå¸Œå†²çªï¼Œå¯¹æŸ¥è¯¢å•ä¸ªå€¼çš„ æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œä¾‹å¦‚æŸ¥æ‰¾id=1ï¼šselect * from user where id=1 ,ä½†å¯¹èŒƒå›´æŸ¥è¯¢ååˆ†çš„ä¸å‹å¥½,ä¾‹å¦‚æŸ¥æ‰¾èŒƒå›´id\u0026gt;100çš„å€¼ï¼šselect * from user where id \u0026gt;100;  äºŒå‰æ ‘  äºŒå‰æ ‘çš„æ•°æ®ç»“æ„å·¦å°å³å¤§ï¼Œå¯ä»¥é€šè¿‡ä¸­åºéå†ç›´æ¥è·å–æ‰€æœ‰å‡åºçš„æ•°æ®ï¼ŒäºŒå‰æ ‘çš„æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º O(lgn),ç¼ºç‚¹æ˜¯äºŒå‰æ ‘å®¹æ˜“é€€åŒ–é“¾è¡¨ï¼Œå¢åŠ æ•°æ®çš„æŸ¥æ‰¾çš„æ—¶é—´ã€‚åœ¨æœ€åçš„æƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)  å¹³è¡¡äºŒå‰æ ‘(AVL)å’Œçº¢é»‘æ ‘  é€šè¿‡å·¦æ—‹å’Œå³æ—‹ä»¥åŠèŠ‚ç‚¹é¢œè‰²çš„æ”¹å˜ç­‰æ–¹å¼è°ƒæ•´æ ‘é¿å…é€€åŒ–ä¸ºé“¾è¡¨ï¼Œä½¿äºŒå‰æ ‘ä¿æŒå¹³è¡¡è½¬æ€ï¼Œä¿è¯æ ‘çš„æŸ¥æ‰¾æ€§èƒ½ å³æ—¶é—´å¤æ‚åº¦åœ¨O(lgn)ã€‚ä½†æ˜¯äºŒå‰æ ‘ä¸é€‚åˆç”¨åšæ•°æ®çš„åº•å±‚æ•°æ®ç»“æ„åŸå› å¦‚ä¸‹ï¼š   1.æ•°æ®åº“çš„æŸ¥è¯¢çš„ç“¶é¢ˆåœ¨äºå¯¹ç£ç›˜ioçš„æ“ä½œï¼Œå½“å­˜å‚¨å¤§é‡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œè¦ä¿è¯æ ‘çš„å¹³è¡¡çš„æ—¶å€™ï¼Œæ ‘çš„é«˜åº¦ æ˜¯åœ¨ä¸æ–­çš„å¢åŠ ï¼Œåœ¨å¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„æ“ä½œæ—¶ï¼Œå°±æ˜¯å¯¹ç£ç›˜ioçš„æ“ä½œï¼Œå³å¯¹ç£ç›˜ioçš„æ“ä½œè¿‡äºçš„é¢‘ç¹ï¼Œå¢åŠ äº†å¯¹æ•°æ®åº“ æŸ¥è¯¢ç­‰æ—¶é—´ã€‚ 2 æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†é…çš„å†…å­˜æ˜¯16kbçš„æ•°æ®é‡ï¼Œå¯¹äºäºŒå‰æ ‘çš„èŠ‚ç‚¹ä¿æŒçš„æ•°æ®æ˜¯ä¸‹äº16KB,å½“æ•°æ®è¿‡ä½æ—¶ï¼Œä¹Ÿä¼šé€ æˆå†…å­˜çš„æµªè´¹\n Bæ ‘  Bæ ‘æ˜¯ä¸€ç§å¹³è¡¡å¤šåˆ†æ ‘ï¼ŒèŠ‚ç‚¹æœ€å¤šå«æœ‰Né¢—å­æ ‘(æŒ‡é’ˆ)ï¼ŒN-1ä¸ªå…³é”®å­—(æ•°æ®å­˜å‚¨ç©ºé—´) (N\u0026gt;=2);é™¤äº†æ ¹èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹å¤–ï¼Œå…¶å®ƒæ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰M=N/2ä¸ªå­èŠ‚ç‚¹ï¼ŒMå‘ä¸Šå–æ•´ï¼Œå³åˆ†è£‚çš„æ—¶å€™ä»ä¸­é—´åˆ†å¼€ï¼Œåˆ†æˆMæ£µå­æ ‘ï¼› è‹¥æ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­ç»“ç‚¹ï¼Œåˆ™è‡³å°‘æœ‰ä¸¤é¢—å­æ ‘ã€‚Bæ ‘è§£å†³äº†äºŒå‰æ ‘çš„é«˜åº¦é—®é¢˜ï¼Œå³å‡å°‘äº†å¯¹ç£ç›˜ioçš„æ“ä½œï¼Œå‡å°‘äº†æ•°æ®åº“çš„æ—¶é—´,æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º h*O(lgn),hä¸ºæ ‘çš„é«˜åº¦ã€‚ä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€ä¸‹é—®é¢˜   1.ä¸å¤ªé€‚åˆèŒƒå›´çš„æŸ¥è¯¢ï¼Œå­˜åœ¨ç´¢å¼•çš„å¤±æ•ˆ 2.ç¨³å®šæ€§è¾ƒå¼±ï¼ŒèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®è¾ƒå¤§ï¼Œå ç”¨çš„å†…å­˜ç©ºé—´è¾ƒå¤§\n B+æ ‘  B+æ ‘å’ŒBæ ‘ç±»ä¼¼,B+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸ä¼šå­˜å‚¨æ•°æ®ï¼Œåªå­˜å‚¨ç´¢å¼•å€¼(æŒ‡é’ˆåœ°å€)ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†å¢åŠ ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ åº”ä¸ºèŠ‚ç‚¹å­˜å‚¨çš„ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œå¶å­èŠ‚ç‚¹ç”¨äº†é“¾è¡¨è¿æ¥èµ·æ¥ï¼Œè¿™ä¸ªé“¾è¡¨æœ¬èº«å°±æ˜¯æœ‰åºçš„ï¼Œåœ¨æ•°æ®èŒƒå›´æŸ¥æ‰¾æ—¶ï¼Œæ›´å…·å¤‡æ•ˆç‡ ï¼Œä¿è¯äº†å­˜å‚¨ç©ºé—´çš„ä½¿ç”¨ã€‚é«˜åº¦ä¸é«˜ï¼Œå‡å°‘äº†å¯¹ç£ç›˜çš„ioçš„æ“ä½œï¼Œä¿è¯äº†æŸ¥è¯¢çš„æ•ˆç‡ã€‚  å­˜å‚¨å¼•æ“ InnoDBå¼•æ“ å¼•æ“ç‰¹ç‚¹ 1.å°†æ•°æ®å­˜å‚¨åœ¨è¡¨ç©ºé—´ä¸­ï¼Œè¡¨ç©ºé—´ç”±ä¸€ç³»åˆ—çš„æ•°æ®æ–‡ä»¶ç»„æˆï¼Œç”±InnoDBç®¡ç†ï¼›\n2.æ”¯æŒæ¯ä¸ªè¡¨çš„æ•°æ®å’Œç´¢å¼•å­˜æ”¾åœ¨å•ç‹¬æ–‡ä»¶ä¸­(innodb_file_per_table)ï¼›\n3.æ”¯æŒäº‹åŠ¡ï¼Œé‡‡ç”¨MVCCæ¥æ§åˆ¶å¹¶å‘ï¼Œå¹¶å®ç°æ ‡å‡†çš„4ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ”¯æŒå¤–é”®ï¼›\n4.ç´¢å¼•åŸºäºèšç°‡ç´¢å¼•å»ºç«‹ï¼Œå¯¹äºä¸»é”®æŸ¥è¯¢æœ‰è¾ƒé«˜æ€§èƒ½ï¼›\n5.æ•°æ®æ–‡ä»¶çš„å¹³å°æ— å…³æ€§ï¼Œæ”¯æŒæ•°æ®åœ¨ä¸åŒçš„æ¶æ„å¹³å°ç§»æ¤ï¼›\n6.èƒ½å¤Ÿé€šè¿‡ä¸€äº›å·¥å…·æ”¯æŒçœŸæ­£çš„çƒ­å¤‡ã€‚å¦‚XtraBackupç­‰ï¼›\n7.å†…éƒ¨è¿›è¡Œè‡ªèº«ä¼˜åŒ–å¦‚é‡‡å–å¯é¢„æµ‹æ€§é¢„è¯»ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åœ¨å†…å­˜ä¸­åˆ›å»ºhashç´¢å¼•ç­‰ã€‚\nå¼•æ“å®ç°  InnoDBæ˜¯é‡‡ç”¨çš„æ˜¯B+æ ‘ä½œä¸ºç´¢å¼•çš„ç»“æ„ï¼Œå…¶å­˜å‚¨æ–‡ä»¶åˆ†åˆ«æ˜¯.frmè¡¨çš„å®šä¹‰æ–‡ä»¶å’Œ.idbçš„æ•°æ®æ–‡ä»¶ã€‚InnoDBæ˜¯æ”¯æŒè¡Œé”å’Œè¡¨é”çš„ã€‚InnoDB æ”¯æŒäº‹åŠ¡ï¼Œä¸”æ”¯æŒå››ç§éš”ç¦»çº§åˆ«ï¼ˆè¯»æœªæäº¤ã€è¯»å·²æäº¤ã€å¯é‡å¤è¯»ã€ä¸²è¡ŒåŒ–ï¼‰ï¼Œé»˜è®¤çš„ä¸ºå¯é‡å¤è¯» è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰B+Treeç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œè¿™æ£µæ ‘çš„å¶èŠ‚ç‚¹dataåŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚è¿™ä¸ªç´¢å¼•çš„keyæ˜¯æ•°æ®è¡¨çš„ä¸»é”®ï¼Œå› æ­¤InnoDBè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ä¸»ç´¢å¼•ã€‚ \r  MyISAMå¼•æ“ å¼•æ“ç‰¹ç‚¹ 1.MySQL5.1ä¸­é»˜è®¤ï¼Œä¸æ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”ï¼›\n2.æä¾›å¤§é‡ç‰¹æ€§å¦‚å…¨æ–‡ç´¢å¼•ã€ç©ºé—´å‡½æ•°ã€å‹ç¼©ã€å»¶è¿Ÿæ›´æ–°ç­‰ï¼›\n3.æ•°æ®åº“æ•…éšœåï¼Œå®‰å…¨æ¢å¤æ€§å·®ï¼›\n4.å¯¹äºåªè¯»æ•°æ®å¯ä»¥å¿å—æ•…éšœæ¢å¤ï¼ŒMyISAMä¾ç„¶éå¸¸é€‚ç”¨ï¼›\n5.æ—¥å¿—æœåŠ¡å™¨çš„åœºæ™¯ä¹Ÿæ¯”è¾ƒé€‚ç”¨ï¼Œåªéœ€æ’å…¥å’Œæ•°æ®è¯»å–æ“ä½œï¼›\n6.ä¸æ”¯æŒå•è¡¨ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼šå°†æ‰€æœ‰çš„æ•°æ®å’Œç´¢å¼•å†…å®¹åˆ†åˆ«å­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­ï¼›\n7.MyISAMå¯¹æ•´å¼ è¡¨åŠ é”è€Œä¸æ˜¯å¯¹è¡Œï¼Œæ‰€ä»¥ä¸é€‚ç”¨å†™æ“ä½œæ¯”è¾ƒå¤šçš„åœºæ™¯ï¼›\n8.æ”¯æŒç´¢å¼•ç¼“å­˜ä¸æ”¯æŒæ•°æ®ç¼“å­˜ã€‚\nå¼•æ“å®ç° MyISAMå¼•æ“ä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¶èŠ‚ç‚¹çš„dataåŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€ã€‚å…¶å­˜å‚¨çš„æ–‡ä»¶æœ‰ä¸‰ä¸ªåˆ†åˆ«æ˜¯ï¼š.frmè¡¨çš„å®šä¹‰æ–‡ä»¶ã€.MYDä¸ºæ•°æ®æ–‡ä»¶å’Œ.MYLç´¢å¼•æ–‡ä»¶ã€‚ Myisam åªæ”¯æŒè¡¨é”ï¼Œä¸”ä¸æ”¯æŒäº‹åŠ¡ã€‚Myisam ç”±äºæœ‰å•ç‹¬çš„ç´¢å¼•æ–‡ä»¶ï¼Œåœ¨è¯»å–æ•°æ®æ–¹é¢çš„æ€§èƒ½å¾ˆé«˜\n å‚è€ƒæ–‡çŒ®ï¼š MySQLè¿è¡ŒåŸç†ä¸åŸºç¡€æ¶æ„\n","date":"2022-02-20T22:00:38+08:00","image":"https://zcj-git520.github.io/p/mysql%E5%BA%95%E5%B1%82%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/1_huc45b7cee299d4b0bd96f8dd390c7ebfb_163533_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/mysql%E5%BA%95%E5%B1%82%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/","title":"mysqlåº•å±‚åŸºæœ¬åŸç†"},{"content":"å¹³è¡¡äºŒå‰æ ‘ æ•°æ®ç»“æ„å®šä¹‰ // å®šä¹‰æ ‘çš„èŠ‚ç‚¹\rtype AVLTreeNode struct {\rinfo int // å®šä¹‰å­˜å‚¨çš„å†…å®¹\rheight int // æ ‘çš„é«˜åº¦\rright *AVLTreeNode // å³èŠ‚ç‚¹\rleft *AVLTreeNode // å·¦èŠ‚ç‚¹\r}\r// å®šä¹‰æ ‘\rtype AVLTree struct {\rroot *AVLTreeNode // å®šä¹‰æ ¹èŠ‚ç‚¹\r}\r// åˆ›å»ºèŠ‚ç‚¹\rfunc creatNode(data int) *AVLTreeNode{\rreturn \u0026amp;AVLTreeNode{\rinfo: data,\rheight: -1,\rright: nil,\rleft: nil,\r}\r}\ræ•°æ®æ“ä½œ  å¢åˆ æ”¹æŸ¥  æ•°æ®çš„æ’å…¥ \r// æ•°æ®çš„æ’å…¥\rfunc getHeight(node *AVLTreeNode) int {\rif node == nil{\rreturn -1\r}\rreturn node.height\r}\r// å·¦å­æ ‘è°ƒæ•´\rfunc (a *AVLTree)leftTreeAdjust(node *AVLTreeNode, data int) *AVLTreeNode {\r// åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´æ ‘\rif getHeight(node.left) - getHeight(node.right) \u0026gt; 1{\r// æ’å…¥çš„èŠ‚ç‚¹åœ¨å·¦è¾¹ä¸Šï¼Œè¿›å³æ—‹\rif data \u0026lt; node.left.info{\rreturn a.lR(node)\r}else{\r// è¿›è¡Œå·¦å³æ—‹\rreturn a.rLR(node)\r}\r}\rreturn node\r}\r// å³å­æ ‘è°ƒæ•´\rfunc (a *AVLTree)rightTreeAdjust(node *AVLTreeNode, data int) *AVLTreeNode {\r// åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´æ ‘\rif getHeight(node.right) - getHeight(node.left) \u0026gt; 1{\r// æ’å…¥çš„èŠ‚ç‚¹åœ¨å³è¾¹ä¸Šï¼Œè¿›å·¦æ—‹\rif data \u0026gt;= node.right.info{\rreturn a.rR(node)\r}else{\r// è¿›è¡Œå³å·¦æ—‹\rreturn a.lRR(node)\r}\r}\rreturn node\r}\rfunc (a *AVLTree)insertNode(node **AVLTreeNode, data int) {\rif *node == nil{\r*node = creatNode(data)\r(*node).height = maxValue(getHeight((*node).left), getHeight((*node).right)) + 1\rreturn\r}\r// æ’å…¥å·¦å­æ ‘\rif data \u0026lt; (*node).info{\ra.insertNode(\u0026amp;(*node).left, data)\r// è°ƒæ•´æ ‘\r*node = a.leftTreeAdjust(*node, data)\r}else{\r// æ’å…¥å³å­æ ‘\ra.insertNode(\u0026amp;(*node).right, data)\r// è°ƒæ•´æ ‘\r*node = a.rightTreeAdjust(*node, data)\r}\r// è°ƒæ•´èŠ‚ç‚¹çš„é«˜åº¦\r(*node).height = maxValue(getHeight((*node).left), getHeight((*node).right)) + 1\r}\rfunc (a *AVLTree)InsertData(data int ) {\r// å¦‚æœæ ‘ä¸ºç©º\rif a.root == nil{\ra.root = creatNode(data)\ra.root.height = 0\rreturn\r}\ra.insertNode(\u0026amp;a.root, data)\r}\ræ•°æ®çš„åˆ é™¤ // æ¸…ç©ºæ ‘\rfunc (a *AVLTree)Clear(){\ra.root = nil\r}\r// åˆ é™¤èŠ‚ç‚¹\rfunc (a *AVLTree)deleteNode(node **AVLTreeNode, data int) {\rif *node == nil{\rfmt.Printf(\u0026quot;no find data is %d \\n\u0026quot;, data)\rreturn\r}\rif (*node).info == data{\r// å¦‚æœå³èŠ‚ç‚¹ä¸ºnil\rif (*node).right == nil{\r*node = (*node).left\r}else if (*node).left == nil{\r*node = (*node).right\r}else{\r// æ‰¾å‡ºå·¦å­æ ‘çš„æœ€å¤§å€¼\rtemp := (*node).left\rprev := *node // å·¦å­æ ‘æœ€å¤§å€¼çš„æœ€å‰é©±èŠ‚ç‚¹\rfor ; temp.right != nil; temp = temp.right{\rprev = temp\r}\r// å·¦å­æ ‘çš„æœ€å¤§å€¼å¤åˆ¶ç»™node\r(*node).info = temp.info\rif prev == *node{ // å¦‚æœå·¦å­æ ‘çš„æœ€å¤§å€¼ä¸ºnodeçš„nodeçš„å­èŠ‚ç‚¹\rprev.left = temp.left // å…ˆé©±èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹æŒ‡å‘å·¦å­æ ‘æœ€å¤§èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\r}else{\rprev.right = temp.left // å…ˆé©±èŠ‚ç‚¹çš„å³èŠ‚ç‚¹æŒ‡å‘å·¦å­æ ‘æœ€å¤§èŠ‚ç‚¹çš„å³èŠ‚ç‚¹\r}\ra.leftTreeAdjust(*node, data)\r}\rif *node != nil{\r// è°ƒæ•´èŠ‚ç‚¹çš„é«˜åº¦\r(*node).height = maxValue(getHeight((*node).left), getHeight((*node).right)) + 1\r}\rreturn\r}else if (*node).info \u0026gt; data{\ra.deleteNode(\u0026amp;(*node).left, data)\ra.leftTreeAdjust(*node, data)\r}else {\ra.deleteNode(\u0026amp;(*node).right, data)\ra.rightTreeAdjust(*node,data)\r}\r(*node).height = maxValue(getHeight((*node).left), getHeight((*node).right)) + 1\r}\rfunc (a *AVLTree)Remove(data int) {\rif a.root == nil{\rreturn\r}\ra.deleteNode(\u0026amp;a.root, data)\r}\r// å¾—åˆ°æœ€å¤§å€¼\rfunc maxValue(value, value1 int) int {\rif value \u0026gt;= value1{\rreturn value\r}\rreturn value1\r}\ræ•°æ®çš„æŸ¥è¯¢  å‰åºéå†ã€ä¸­åºéå†ã€åç»­éå†ã€å€¼æŸ¥è¯¢  // æ ‘çš„éå†\r// å‰åºéå†\rfunc (a *AVLTree)nLR(node *AVLTreeNode){\r// å¦‚æœèŠ‚ç‚¹ä¸ºç©ºå°±è¿”å›\rif node == nil{\rreturn\r}\rfmt.Printf(\u0026quot;%d-\u0026gt;\u0026quot;, node.info)\r// éå†å·¦å­æ ‘\ra.nLR(node.left)\r// éå†å³å­æ ‘\ra.nLR(node.right)\r}\r// ä¸­åºéå†\rfunc (a *AVLTree)lNR(node *AVLTreeNode){\r// å¦‚æœèŠ‚ç‚¹ä¸ºç©ºå°±è¿”å›\rif node == nil{\rreturn\r}\ra.lNR(node.left)\rfmt.Printf(\u0026quot;%d-\u0026gt;\u0026quot;, node.info)\ra.lNR(node.right)\r}\r// ååºéå†\rfunc (a *AVLTree)lRN(node *AVLTreeNode){\rif node == nil{\rreturn\r}\ra.lRN(node.left)\ra.lRN(node.right)\rfmt.Printf(\u0026quot;%d-\u0026gt;\u0026quot;, node.info)\r}\r// å‰åºæ˜¾ç¤º\rfunc (a *AVLTree)ShowNLR(){\rif a.root == nil{\rfmt.Println(\u0026quot;zhe tree is empty\u0026quot;)\rreturn\r}\rfmt.Print(\u0026quot;NLR:\u0026quot;)\rnode := a.root\ra.nLR(node)\rfmt.Println()\r}\r// ä¸­åºæ˜¾ç¤º\rfunc (a *AVLTree)ShowLNR(){\rif a.root == nil{\rfmt.Println(\u0026quot;zhe tree is empty\u0026quot;)\rreturn\r}\rfmt.Print(\u0026quot;LNR:\u0026quot;)\rnode := a.root\ra.lNR(node)\rfmt.Println()\r}\r// ååºæ˜¾ç¤º\rfunc (a *AVLTree)ShowLRN(){\rif a.root == nil{\rfmt.Println(\u0026quot;zhe tree is empty\u0026quot;)\rreturn\r}\rfmt.Print(\u0026quot;LRN:\u0026quot;)\rnode := a.root\ra.lRN(node)\rfmt.Println()\r}\ræ ‘çš„æ—‹è½¬  å•å·¦æ—‹ å•å³æ—‹ å·¦å³æ—‹ å³å·¦æ—‹  // å•å³æ—‹\rfunc (a *AVLTree)lR(node *AVLTreeNode) *AVLTreeNode {\r// ä¸´æ—¶node æŒ‡å‘èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\rtemp := (*node).left\r// nodeçš„å·¦èŠ‚ç‚¹æŒ‡å‘temp çš„å³èŠ‚ç‚¹\r(*node).left = temp.right\r// temp çš„å³èŠ‚ç‚¹æŒ‡å‘nodeï¼ˆnode ä¸ºtempçš„å³èŠ‚ç‚¹çš„ï¼‰\rtemp.right = node\r// è°ƒæ•´é«˜åº¦\r(*node).height = maxValue(getHeight((*node).left), getHeight((*node).right)) + 1\rtemp.height = maxValue(getHeight(temp.left), getHeight(temp.right)) + 1\rreturn temp\r}\r// å•å·¦æ—‹\rfunc (a *AVLTree)rR(node *AVLTreeNode) *AVLTreeNode {\r// ä¸´æ—¶node æŒ‡å‘èŠ‚ç‚¹çš„å³èŠ‚ç‚¹\rtemp := (*node).right\r// nodeçš„å³èŠ‚ç‚¹æŒ‡å‘tempçš„å·¦èŠ‚ç‚¹\r(*node).right = temp.left\r// tempçš„å·¦èŠ‚ç‚¹æŒ‡å‘node\rtemp.left = node\r// è°ƒæ•´æ ‘çš„é«˜åº¦\r(*node).height = maxValue(getHeight((*node).left), getHeight((*node).right)) + 1\rtemp.height = maxValue(getHeight(temp.left), getHeight(temp.right)) + 1\rreturn temp\r}\r// å·¦å³æ—‹(å…ˆå·¦æ—‹åœ¨å³æ—‹)\rfunc (a *AVLTree)rLR(node *AVLTreeNode) *AVLTreeNode {\rnode.left = a.rR(node.left)\rreturn a.lR(node)\r}\r// å³å·¦æ—‹(å…ˆå³æ—‹å†å·¦æ—‹)\rfunc (a *AVLTree)lRR(node *AVLTreeNode) *AVLTreeNode {\rnode.right = a.lR(node.right)\rreturn a.rR(node)\r}\ræµ‹è¯• \rfunc TestAVRTree_InsertData(t *testing.T) {\ravl := CreatAVLTree()\ravl.InsertData(2)\ravl.InsertData(12)\ravl.InsertData(24)\ravl.InsertData(1)\ravl.InsertData(65)\ravl.InsertData(72)\ravl.InsertData(32)\ravl.InsertData(21)\ravl.ShowNLR()\ravl.ShowLNR()\ravl.ShowLRN()\r}\rfunc TestAVLTree_Remove(t *testing.T) {\ravl := CreatAVLTree()\ravl.InsertData(1)\ravl.InsertData(2)\ravl.InsertData(3)\ravl.InsertData(4)\ravl.InsertData(5)\ravl.InsertData(6)\ravl.InsertData(7)\ravl.InsertData(8)\ravl.ShowNLR()\ravl.ShowLNR()\ravl.ShowLRN()\rfmt.Println(\u0026quot;**********************\u0026quot;)\ravl.Remove(4)\ravl.ShowNLR()\ravl.ShowLNR()\ravl.ShowLRN()\r}\rfunc TestAVLTree_IsValue(t *testing.T) {\ravl := CreatAVLTree()\ravl.InsertData(1)\ravl.InsertData(2)\ravl.InsertData(3)\ravl.InsertData(4)\ravl.InsertData(5)\ravl.InsertData(6)\ravl.InsertData(7)\ravl.InsertData(8)\ravl.ShowNLR()\ravl.ShowLNR()\ravl.ShowLRN()\rdata := 4\ris := avl.IsValue(data)\rif is{\rfmt.Printf(\u0026quot;%d :is exits\\n\u0026quot;, data)\r}else{\rfmt.Printf(\u0026quot;%d :is not exits\\n\u0026quot;, data)\r}\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/tree/AVL_tree  ","date":"2022-02-15T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-avl-tree-go%E5%AE%9E%E7%8E%B0/1_hu627ccad35150ba5c25206c4fe774bc3e_21463_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-avl-tree-go%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-AVL tree goå®ç°"},{"content":"å¹³è¡¡äºŒå‰æ ‘ æ•°æ®ç»“æ„å®šä¹‰ \r// å®šä¹‰æ ‘çš„èŠ‚ç‚¹\rtemplate\u0026lt;class T\u0026gt;\rclass AvrTreeNode\r{\rpublic:\rAvrTreeNode(){};\rAvrTreeNode(T data)\r{\rthis-\u0026gt;data = data;\rleft = 0;\rright = 0;\rhight = -1;\r}\r~AvrTreeNode(){};\rT data; // å­˜å‚¨çš„æ•°æ®\rAvrTreeNode *left; // å·¦å­æ ‘\rAvrTreeNode *right; // å³å­æ ‘\rint hight; // é«˜åº¦ };\r// å®šä¹‰æ ‘\rtemplate\u0026lt;class T\u0026gt;\rclass AvrTree\r{\rprivate:\rAvrTreeNode\u0026lt;T\u0026gt; *root; // å®šä¹‰æ ¹èŠ‚ç‚¹\r// æ’å…¥èŠ‚ç‚¹\rvoid inseartNode(AvrTreeNode\u0026lt;T\u0026gt;*\u0026amp; node, const T data);\rvoid deleteNodeAll(AvrTreeNode\u0026lt;T\u0026gt; *node); // åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹\r// æ˜¾ç¤ºèŠ‚ç‚¹\rvoid DLR(AvrTreeNode\u0026lt;T\u0026gt; *node);\rvoid LDR(AvrTreeNode\u0026lt;T\u0026gt; *node);\rvoid LRD(AvrTreeNode\u0026lt;T\u0026gt; *node);\r// åˆ é™¤*\u0026amp;ä»£è¡¨æŒ‡é’ˆå¼•ç”¨\rbool deleteNode(AvrTreeNode\u0026lt;T\u0026gt;*\u0026amp; node, const T data);\r// void deleteNodeByMerge(AvrTreeNode\u0026lt;T\u0026gt;*\u0026amp; node); // åˆå¹¶åˆ é™¤\r// void deleteNodeByCopy(AvrTreeNode\u0026lt;T\u0026gt;*\u0026amp; node); // å¤åˆ¶åˆ é™¤\r// å•å³æ—‹\rvoid LL(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp;node);\r// å•å·¦æ—‹\rvoid RR(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp;node);\r// å·¦å³æ—‹\rvoid RLR(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp;node);\r// å³å·¦æ—‹\rvoid LRR(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp;node);\r// æ±‚é«˜åº¦çš„æœ€å¤§å€¼\rint maxHight(int h1, int h2)\r{\rreturn h1\u0026gt;h2 ? h1:h2;\r}\r// å¾—åˆ°æ ‘çš„é«˜åº¦\rint getTreeHight(AvrTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{\rreturn -1;\r}\rreturn node-\u0026gt;hight;\r}\rpublic:\rAvrTree(/* args */)\r{\rroot = 0;\r}\r~AvrTree();\r// æ¸…ç©ºæ ‘\rvoid clear();\r// æ˜¯å¦ä¸ºç©ºæ ‘\rbool isEmpty()\r{\rreturn root == 0;\r}\r// æ’å…¥æ•°æ®\rvoid inseartData(const T data);\r// æ·±åº¦ä¼˜å…ˆéå†æ ‘\r// å‰åºéå†(DLR æ ¹-\u0026gt;å·¦-\u0026gt;å³)\rvoid showNodeByDLR();\r// ä¸­åºéå†(LDR å·¦-\u0026gt;æ ¹-\u0026gt;å³)\rvoid showNodeByLDR();\r// ååºéå†(LRD å·¦-\u0026gt;å³-\u0026gt;æ ¹)\rvoid showNodeByLRD();\r// åˆ é™¤èŠ‚ç‚¹çš„æ•°æ®\rbool remove(const T data);\r// LVRæŸ¥æ‰¾æ ‘\rbool LVRSearchData(const T data);\r};\ræ•°æ®æ“ä½œ  å¢åˆ æ”¹æŸ¥  æ•°æ®çš„æ’å…¥ \r// æ•°æ®çš„æ’å…¥\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::inseartNode(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp; node, const T data)\r{\r// å¦‚æœèŠ‚ç‚¹ä¸ºç©º\rif(node == 0)\r{\rnode = new AvrTreeNode\u0026lt;T\u0026gt;(data);\rreturn;\r}\r// æ’å…¥åœ¨å·¦å­æ ‘\rif(data \u0026lt; node-\u0026gt;data)\r{\rinseartNode(node-\u0026gt;left, data);\r// æ ‘ä¸å¹³è¡¡æ—¶\rif(getTreeHight(node-\u0026gt;left) - getTreeHight(node-\u0026gt;right) \u0026gt; 1)\r{\r// å½“å€¼æ¯”å·¦èŠ‚ç‚¹çš„å€¼å°æ—¶ï¼Œåˆ™è¿›è¡Œå•å³æ—‹\rif(data \u0026lt; node-\u0026gt;left-\u0026gt;data)\r{\rLL(node);\r}\r// å¦åˆ™è¿›è¡Œå·¦å³æ—‹\relse\r{\rRLR(node);\r}\r} }\r// æ’å…¥åœ¨å³å­æ ‘\relse\r{\rinseartNode(node-\u0026gt;right, data);\r// æ ‘ä¸å¹³è¡¡æ—¶\rif(getTreeHight(node-\u0026gt;right) - getTreeHight(node-\u0026gt;left) \u0026gt; 1)\r{\r// å½“å€¼æ¯”å³èŠ‚ç‚¹çš„å€¼å¤§æ—¶ï¼Œåˆ™è¿›è¡Œå•å·¦æ—‹\rif(data \u0026gt;= node-\u0026gt;right-\u0026gt;data)\r{\rRR(node);\r}\r// å¦åˆ™è¿›è¡Œå³å·¦æ—‹\relse\r{\rLRR(node);\r}\r}\r}\r// é‡æ–°è®¡ç®—èŠ‚ç‚¹çš„é«˜åº¦ï¼ŒèŠ‚ç‚¹çš„æ·±åº¦+1\rnode-\u0026gt;hight = maxHight(getTreeHight(node-\u0026gt;left), getTreeHight(node-\u0026gt;right)) + 1;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::inseartData(const T data)\r{\r// å¦‚æœä¸ºç©ºæ ‘\rif(isEmpty())\r{\rroot = new AvrTreeNode\u0026lt;T\u0026gt;(data);\rroot-\u0026gt;hight = 0;\rreturn;\r}\rinseartNode(root, data);\r}\ræ•°æ®çš„åˆ é™¤ \r// æ•°æ®çš„åˆ é™¤\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::deleteNodeAll(AvrTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(node == 0)\r{\rreturn;\r}\r// åˆ é™¤å·¦èŠ‚ç‚¹\rdeleteNodeAll(node-\u0026gt;left);\r// åˆ é™¤å³èŠ‚ç‚¹\rdeleteNodeAll(node-\u0026gt;right);\r// é‡Šæ”¾èŠ‚ç‚¹\rdelete node;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::clear()\r{\r// å¦‚æœä¸ºç©ºæ ‘ï¼Œç›´æ¥è¿”å›\rif(root == 0)\r{\rreturn;\r}\rdeleteNodeAll(root);\r}\rtemplate\u0026lt;class T\u0026gt;\rbool AvrTree\u0026lt;T\u0026gt; ::deleteNode(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp; node, const T data)\r{\r// å¦‚æœèŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥è¿”å›ï¼Œè¡¨ç¤ºæœªæ‰¾åˆ°æ•°æ®\rif(!node)\r{\rcout \u0026lt;\u0026lt; \u0026quot;no find:\u0026quot; \u0026lt;\u0026lt; data \u0026lt;\u0026lt; endl;\rreturn false;\r}\r// æ‰¾åˆ°æ•°æ®èŠ‚ç‚¹\rif(data == node-\u0026gt;data)\r{\rAvrTreeNode\u0026lt;T\u0026gt; *temp = node;\r// åªæœ‰å³èŠ‚ç‚¹\rif(!node-\u0026gt;left)\r{\rnode = node-\u0026gt;right;\r}\r// åªæœ‰å·¦èŠ‚ç‚¹\relse if(!node-\u0026gt;right)\r{\rnode = node-\u0026gt;left;\r}\relse\r{\r// é‡‡ç”¨åˆå¹¶çš„æ–¹å¼è¿›è¡Œåˆ é™¤èŠ‚ç‚¹\rtemp = node-\u0026gt;left;\r// æ‰¾åˆ°å·¦å­æ ‘çš„åšå¤§å€¼\rwhile (temp-\u0026gt;right)\r{\rtemp = temp-\u0026gt;right;\r}\rtemp-\u0026gt;right = node-\u0026gt;right;\rtemp = node;\rnode = node-\u0026gt;left;\r// æ˜¯å¦å¯¹æ ‘è¿›è¡Œè°ƒæ•´\rif(getTreeHight(node-\u0026gt;left)-getTreeHight(node-\u0026gt;right) \u0026gt; 1)\r{\r// å€¼æ¯”æœ€å¤§å€¼å¤§æˆ–è€…ç­‰äºï¼Œå°±é‡‡ç”¨å•å·¦æ—‹\rif(data \u0026gt;= node-\u0026gt;right-\u0026gt;data)\r{\rRR(node);\r}\r//é‡‡ç”¨å…ˆå³æ—‹åœ¨å·¦æ—‹\relse\r{\rLRR(node);\r}\r}\r}\r// åˆ é™¤èŠ‚ç‚¹ï¼Œè¿”å›\rdelete temp;\rif(node)\r{\rnode-\u0026gt;hight = maxHight(getTreeHight(node-\u0026gt;right), getTreeHight(node-\u0026gt;right)) + 1;\r}\rreturn true;\r}\r// åœ¨å·¦å­æ ‘æŸ¥æ‰¾\relse if(data \u0026lt; node-\u0026gt;data)\r{\rdeleteNode(node-\u0026gt;left, data);\r// æ˜¯å¦å¯¹æ ‘è¿›è¡Œè°ƒæ•´\rif(getTreeHight(node-\u0026gt;left)-getTreeHight(node-\u0026gt;right) \u0026gt; 1)\r{\r// å¦‚æœå€¼æ¯”å·¦å­æ ‘å°ï¼Œå°±é‡‡ç”¨å•å³æ—‹ï¼Œ\rif(data \u0026lt; node-\u0026gt;left-\u0026gt;data)\r{\rLL(node);\r}\r// é‡‡ç”¨å…ˆå·¦æ—‹åœ¨å³æ—‹\relse\r{\rRLR(node);\r}\r}\r}\r// åœ¨å³å­æ ‘æŸ¥æ‰¾\relse\r{\rdeleteNode(node-\u0026gt;right, data);\r// æ˜¯å¦è¦å¯¹æ ‘è¿›è¡Œè°ƒæ•´\rif(getTreeHight(node-\u0026gt;right) - getTreeHight(node-\u0026gt;left) \u0026gt; 1)\r{\r// å€¼æ¯”æœ€å¤§å€¼å¤§æˆ–è€…ç­‰äºï¼Œå°±é‡‡ç”¨å•å·¦æ—‹\rif(data \u0026gt;= node-\u0026gt;right-\u0026gt;data)\r{\rRR(node);\r}\r// é‡‡ç”¨å…ˆå³æ—‹åœ¨å·¦æ—‹\relse\r{\rLRR(node);\r}\r}\r}\r// å¯¹èŠ‚ç‚¹çš„æ·±åº¦è¿›è¡Œè°ƒæ•´\rnode-\u0026gt;hight = maxHight(getTreeHight(node-\u0026gt;right), getTreeHight(node-\u0026gt;right)) + 1;\r}\rtemplate\u0026lt;class T\u0026gt;\rbool AvrTree\u0026lt;T\u0026gt; ::remove(const T data)\r{\r// å¦‚æœä¸ºç©ºæ ‘\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn false;\r}\rreturn deleteNode(root, data);\r}\ræ•°æ®çš„æŸ¥è¯¢  å‰åºéå†ã€ä¸­åºéå†ã€åç»­éå†ã€å€¼æŸ¥è¯¢  // æ•°æ®çš„æŸ¥è¯¢\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::DLR(AvrTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{ return;\r}\r// å‰åºéå†(DLR)(æ ¹-\u0026gt;å·¦-\u0026gt;å³)\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; \u0026quot;-\u0026gt;\u0026quot;;\rDLR(node-\u0026gt;left);\rDLR(node-\u0026gt;right);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::LDR(AvrTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{\rreturn;\r}\r// ä¸­åºéå†(LDR)(å·¦-\u0026gt;æ ¹-\u0026gt;å³)\rLDR(node-\u0026gt;left);\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; \u0026quot;-\u0026gt;\u0026quot;;\rLDR(node-\u0026gt;right);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::LRD(AvrTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{\rreturn;\r}\r// ååºéå†(LRD)(å·¦-\u0026gt;å³-\u0026gt;æ ¹)\rLRD(node-\u0026gt;left);\rLRD(node-\u0026gt;right);\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; \u0026quot;-\u0026gt;\u0026quot;;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::showNodeByDLR()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\r// éå†æ ‘\rAvrTreeNode\u0026lt;T\u0026gt; *node = root;\rcout \u0026lt;\u0026lt; \u0026quot;DLR: \u0026quot;;\rDLR(node); cout \u0026lt;\u0026lt; endl;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::showNodeByLDR()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\r// éå†æ ‘\rAvrTreeNode\u0026lt;T\u0026gt; *node = root;\rcout \u0026lt;\u0026lt; \u0026quot;LDR: \u0026quot;;\rLDR(node); cout \u0026lt;\u0026lt; endl; }\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::showNodeByLRD()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\r// éå†æ ‘\rAvrTreeNode\u0026lt;T\u0026gt; *node = root;\rcout \u0026lt;\u0026lt; \u0026quot;LRD: \u0026quot;;\rLRD(node); cout \u0026lt;\u0026lt; endl; }\rtemplate\u0026lt;class T\u0026gt;\rbool AvrTree\u0026lt;T\u0026gt; ::LVRSearchData(const T data)\r{\r// å¦‚æœæ ‘ä¸ºç©ºå°±ç›´æ¥è¿”å›\rif(isEmpty())\r{\rreturn false;\r}\rAvrTreeNode\u0026lt;T\u0026gt; *node = root;\rwhile (node)\r{\rif(data == node-\u0026gt;data)\r{\rreturn true;\r}\relse if(data \u0026lt; node-\u0026gt;data)\r{\rnode = node-\u0026gt;left;\r}\relse\r{\rnode = node-\u0026gt;right;\r}\r}\rreturn false;\r}\ræ ‘çš„æ—‹è½¬  å•å·¦æ—‹ å•å³æ—‹ å·¦å³æ—‹ å³å·¦æ—‹  // èŠ‚ç‚¹çš„æ—‹è½¬\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::LL(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp; node)\r{\r// ä¸´æ—¶èŠ‚ç‚¹ä¸ºèŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\rAvrTreeNode\u0026lt;T\u0026gt; *temp = node-\u0026gt;left;\r// èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹æŒ‡å‘ä¸´æ—¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹\rnode-\u0026gt;left = temp-\u0026gt;right;\r// ä¸´æ—¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹æŒ‡å‘èŠ‚ç‚¹(å°†ä¸´æ—¶èŠ‚ç‚¹çš„è®¾ç½®ä¸ºæ ¹)\rtemp-\u0026gt;right = node;\r// é‡æ–°è·å¾—æ ‘çš„é«˜åº¦\rtemp-\u0026gt;hight = maxHight(getTreeHight(temp-\u0026gt;left), getTreeHight(temp-\u0026gt;right)) + 1;\rnode-\u0026gt;hight = maxHight(getTreeHight(node-\u0026gt;left), getTreeHight(node-\u0026gt;right)) + 1;\r// ç»node é‡æ–°æŒ‡å‘temp, å³å°†tempè®¾ç½®ä¸ºæ ¹èŠ‚ç‚¹ï¼Œé˜²æ­¢æ ‘çš„æ–­\rnode = temp; }\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::RR(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp; node)\r{\r// ä¸´æ—¶èŠ‚ç‚¹ä¸ºèŠ‚ç‚¹çš„å³èŠ‚ç‚¹\rAvrTreeNode\u0026lt;T\u0026gt; *temp = node-\u0026gt;right;\r// èŠ‚ç‚¹çš„å³èŠ‚ç‚¹æŒ‡å‘ä¸´æ—¶èŠ‚ç‚¹çš„èŠ‚ç‚¹\rnode-\u0026gt;right = temp-\u0026gt;left;\r// ä¸´æ—¶èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹æŒ‡å‘èŠ‚ç‚¹\rtemp-\u0026gt;left = node;\r// é‡æ–°è®¡ç®—æ ‘çš„é«˜åº¦\rtemp-\u0026gt;hight = maxHight(getTreeHight(temp-\u0026gt;left), getTreeHight(temp-\u0026gt;right)) + 1;\rnode-\u0026gt;hight = maxHight(getTreeHight(node-\u0026gt;left), getTreeHight(node-\u0026gt;right)) + 1;\r// ç»node é‡æ–°æŒ‡å‘temp, å³å°†tempè®¾ç½®ä¸ºæ ¹èŠ‚ç‚¹ï¼Œé˜²æ­¢æ ‘çš„æ–­\rnode = temp;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::RLR(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp; node)\r{\r// å…ˆè¿›è¡Œå·¦æ—‹\rRR(node-\u0026gt;left);\r// åœ¨è¿›è¡Œå³æ—‹\rLL(node);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid AvrTree\u0026lt;T\u0026gt; ::LRR(AvrTreeNode\u0026lt;T\u0026gt; *\u0026amp; node)\r{\r// å…ˆè¿›è¡Œå³æ—‹\rLL(node-\u0026gt;right);\r// åœ¨è¿›è¡Œå·¦æ—‹\rRR(node);\r}\ræµ‹è¯• \rint main(int argc, char const *argv[])\r{\rAvrTree\u0026lt;int\u0026gt; avr;\ravr.inseartData(12);\ravr.inseartData(42);\ravr.inseartData(93);\ravr.inseartData(4);\ravr.inseartData(15);\ravr.inseartData(66);\ravr.inseartData(97);\ravr.showNodeByDLR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLDR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\rbool ok = avr.remove(42);\rcout \u0026lt;\u0026lt; \u0026quot;remove is:\u0026quot; \u0026lt;\u0026lt; ok \u0026lt;\u0026lt; endl;\ravr.showNodeByDLR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLDR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\rbool is = avr.remove(12);\rcout \u0026lt;\u0026lt; \u0026quot;remove is:\u0026quot; \u0026lt;\u0026lt; is \u0026lt;\u0026lt; endl;\ravr.showNodeByDLR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLDR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\rbool is1 = avr.remove(661);\rcout \u0026lt;\u0026lt; \u0026quot;remove1 is:\u0026quot; \u0026lt;\u0026lt; is1 \u0026lt;\u0026lt; endl;\ravr.showNodeByDLR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLDR();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\ravr.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;***********************************\u0026quot; \u0026lt;\u0026lt; endl;\rbool ok_ = avr.LVRSearchData(66);\rcout \u0026lt;\u0026lt; \u0026quot;SearchData is:\u0026quot; \u0026lt;\u0026lt; ok_ \u0026lt;\u0026lt; endl;\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/tree/avr_tree  ","date":"2022-01-10T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-avl-tree-c-%E5%AE%9E%E7%8E%B0/1_hu627ccad35150ba5c25206c4fe774bc3e_21463_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-avl-tree-c-%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-AVL tree c++å®ç°"},{"content":"äºŒå‰æŸ¥æ‰¾æ ‘ æ•°æ®ç»“æ„å®šä¹‰ \r// å®šä¹‰æ ‘çš„èŠ‚ç‚¹\rtype binarySearchTreeNode struct {\rinfo int // å®šä¹‰å­˜å‚¨çš„å†…å®¹\rleft *binarySearchTreeNode // å·¦èŠ‚ç‚¹\rright *binarySearchTreeNode // å³èŠ‚ç‚¹\r}\r// å®šä¹‰æ ‘\rtype BinarySearchTree struct {\rroot *binarySearchTreeNode // å®šä¹‰æ ¹èŠ‚ç‚¹\rnumNodes int // èŠ‚ç‚¹æ ‘\r}\r// åˆ›å»ºèŠ‚ç‚¹\rfunc creatNode(data int) *binarySearchTreeNode{\rreturn \u0026amp;binarySearchTreeNode{\rinfo: data,\rleft: nil,\rright: nil,\r}\r}\r// èŠ‚ç‚¹çš„æ•°é‡\rfunc (b *BinarySearchTree)GetNodeNum()int{\rreturn b.numNodes\r}\ræ•°æ®æ“ä½œ  å¢åˆ æ”¹æŸ¥  æ•°æ®çš„æ’å…¥ \r// èŠ‚ç‚¹çš„æ’å…¥\rfunc (b *BinarySearchTree) InsertNode(data int) {\rnewNode := creatNode(data)\r// å¦‚æœä¸ºç©ºæ ‘\rif b.root == nil{\rb.root = newNode\rb.numNodes++\rreturn\r}\rnode := b.root\rfor {\r// å½“å€¼å°äºèŠ‚ç‚¹çš„å€¼æ—¶ï¼Œå°±å¾€å·¦å­æ ‘æ’å…¥\rif data \u0026lt; node.info{\r// å·¦èŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥æ’å…¥,è·³å‡ºå¾ªç¯\rif node.left == nil{\rnode.left = newNode\rbreak\r}else{\r// å¦åˆ™ç»§ç»­å¾€å·¦å­æ ‘æ’\rnode = node.left\r}\r}else{\r// å½“å€¼å¤§äºç­‰äºèŠ‚ç‚¹çš„å€¼æ—¶ï¼Œå°±å¾€å³å­æ ‘æ’å…¥\r// å³èŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥æ’å…¥,è·³å‡ºå¾ªç¯\rif node.right == nil{\rnode.right = newNode\rbreak\r}else {\r// å¦åˆ™ç»§ç»­å¾€å³å­æ ‘æ’\rnode = node.right\r}\r}\r}\r// èŠ‚ç‚¹æ ‘+1\rb.numNodes++\r}\ræ•°æ®çš„åˆ é™¤  å¤åˆ¶åˆ é™¤æ³•ï¼š   å°†è¢«åˆ é™¤èŠ‚ç‚¹çš„å·¦å­æ ‘çš„æœ€å¤§å€¼æˆ–è€…å³å­æ ‘çš„æœ€å°å€¼å¤åˆ¶ç»™è¢«åˆ é™¤çš„èŠ‚ç‚¹çš„æ•°å€¼ï¼Œ ç„¶ååˆ é™¤å·¦å­æ ‘çš„æœ€å¤§å€¼çš„èŠ‚ç‚¹æˆ–è€…å³å­æ ‘çš„æœ€å°å€¼çš„èŠ‚ç‚¹\n 2.åˆå¹¶åˆ é™¤æ³•ï¼š\n ä»åˆ é™¤çš„èŠ‚ç‚¹çš„ä¸¤æ£µå­æ ‘åˆå¹¶æœªä¸€æ£µæ ‘ï¼Œç„¶åå°†è¿™é¢—æ ‘è¿æ¥åˆ°åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ å…·ä½“æ“ä½œï¼šå·¦å­æ ‘çš„æœ€å¤§å€¼å·¦ä½œä¸ºæœ‰å­æ ‘çš„çˆ¶èŠ‚ç‚¹ï¼Œå·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºè¿™æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ æˆ–å³å­æ ‘çš„æœ€å°å€¼ä½œä¸ºå·¦å­æ ‘çš„çˆ¶èŠ‚ç‚¹ï¼Œå³å­æ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºè¿™æ£µæ ‘çš„æ ¹èŠ‚ç‚¹\n \r// æ¸…ç©ºæ ‘\rfunc (b *BinarySearchTree) Clear(){\rb.root = nil\rb.numNodes = 0\r}\r//åˆå¹¶åˆ é™¤æ³•ï¼š\r//ä»åˆ é™¤çš„èŠ‚ç‚¹çš„ä¸¤æ£µå­æ ‘åˆå¹¶æœªä¸€æ£µæ ‘ï¼Œç„¶åå°†è¿™é¢—æ ‘è¿æ¥åˆ°åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹\r//å…·ä½“æ“ä½œï¼šå·¦å­æ ‘çš„æœ€å¤§å€¼å·¦ä½œä¸ºæœ‰å­æ ‘çš„çˆ¶èŠ‚ç‚¹ï¼Œå·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºè¿™æ£µæ ‘çš„æ ¹èŠ‚ç‚¹\r//æˆ–å³å­æ ‘çš„æœ€å°å€¼ä½œä¸ºå·¦å­æ ‘çš„çˆ¶èŠ‚ç‚¹ï¼Œå³å­æ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºè¿™æ£µæ ‘çš„æ ¹èŠ‚ç‚¹\r//\rfunc (b *BinarySearchTree)deleteByMerge(node **binarySearchTreeNode) {\r// å¦‚æœå³èŠ‚ç‚¹ä¸ºnil\rif (*node).right == nil{\r*node = (*node).left\r}else if (*node).left == nil{\r*node = (*node).right\r}else{\r// æ‰¾å‡ºå·¦å­æ ‘çš„æœ€å¤§å€¼\rtemp := (*node).left\rfor ; temp.right != nil; temp = temp.right{}\r// å·¦å­æ ‘çš„æœ€å¤§å€¼çš„å³èŠ‚ç‚¹æŒ‡å‘å³å­æ ‘\rtemp.right = (*node).right\r// nodeçš„å¤´æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªæ ‘æ—¢æŒ‡å‘å·¦å­æ ‘çš„å¤´èŠ‚ç‚¹\r*node = (*node).left\r}\r}\r// ç§»é™¤èŠ‚ç‚¹ï¼Œé€šè¿‡åˆå¹¶çš„æ–¹æ³•\rfunc (b *BinarySearchTree)RemoveByMerge(data int) bool{\r// å¦‚æœä¸ºç©ºæ ‘\rif b.root == nil{\rreturn false\r}\r// æ‰¾åˆ°å€¼çš„èŠ‚ç‚¹\rnode := b.root\rprev := b.root\rfor {\rif node == nil{\rreturn false\r}\rif node.info == data{\rbreak\r}\rprev = node\rif data \u0026lt; node.info{\rnode = node.left\r}else {\rnode = node.right\r}\r}\rif node == b.root{\rb.deleteByMerge(\u0026amp;b.root)\r}else if node == prev.left{\rb.deleteByMerge(\u0026amp;prev.left)\r}else{\rb.deleteByMerge(\u0026amp;prev.right)\r}\r// èŠ‚ç‚¹æ ‘-1\rb.numNodes--\rreturn true\r}\r/*\rå¤åˆ¶åˆ é™¤æ³•ï¼š\rå°†è¢«åˆ é™¤èŠ‚ç‚¹çš„å·¦å­æ ‘çš„æœ€å¤§å€¼æˆ–è€…å³å­æ ‘çš„æœ€å°å€¼å¤åˆ¶ç»™è¢«åˆ é™¤çš„èŠ‚ç‚¹çš„æ•°å€¼ï¼Œ\rç„¶ååˆ é™¤å·¦å­æ ‘çš„æœ€å¤§å€¼çš„èŠ‚ç‚¹æˆ–è€…å³å­æ ‘çš„æœ€å°å€¼çš„èŠ‚ç‚¹\r*/\rfunc (b *BinarySearchTree)deleteByCopy(node **binarySearchTreeNode) {\r// å¦‚æœå³èŠ‚ç‚¹ä¸ºnil\rif (*node).right == nil{\r*node = (*node).left\r}else if (*node).left == nil{\r*node = (*node).right\r}else{\r// æ‰¾å‡ºå·¦å­æ ‘çš„æœ€å¤§å€¼\rtemp := (*node).left\rprev := *node // å·¦å­æ ‘æœ€å¤§å€¼çš„æœ€å‰é©±èŠ‚ç‚¹\rfor ; temp.right != nil; temp = temp.right{\rprev = temp\r}\r// å·¦å­æ ‘çš„æœ€å¤§å€¼å¤åˆ¶ç»™node\r(*node).info = temp.info\rif prev == *node{ // å¦‚æœå·¦å­æ ‘çš„æœ€å¤§å€¼ä¸ºnodeçš„nodeçš„å­èŠ‚ç‚¹\rprev.left = temp.left // å…ˆé©±èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹æŒ‡å‘å·¦å­æ ‘æœ€å¤§èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\r}else{\rprev.right = temp.left // å…ˆé©±èŠ‚ç‚¹çš„å³èŠ‚ç‚¹æŒ‡å‘å·¦å­æ ‘æœ€å¤§èŠ‚ç‚¹çš„å³èŠ‚ç‚¹\r}\r}\r}\r// ç§»é™¤èŠ‚ç‚¹ï¼Œé€šè¿‡å¤åˆ¶çš„æ–¹æ³•\rfunc (b *BinarySearchTree)RemoveByCopy(data int) bool{\r// å¦‚æœä¸ºç©ºæ ‘\rif b.root == nil{\rreturn false\r}\r// æ‰¾åˆ°å€¼çš„èŠ‚ç‚¹\rnode := b.root\rprev := b.root\rfor {\rif node == nil{\rreturn false\r}\rif node.info == data{\rbreak\r}\rprev = node\rif data \u0026lt; node.info{\rnode = node.left\r}else {\rnode = node.right\r}\r}\r//b.deleteByCopy(\u0026amp;node)\rif node == b.root{\rb.deleteByCopy(\u0026amp;b.root)\r}else if node == prev.left{\rb.deleteByCopy(\u0026amp;prev.left)\r}else{\rb.deleteByCopy(\u0026amp;prev.right)\r}\r// èŠ‚ç‚¹æ ‘-1\rb.numNodes--\rreturn true\r}\ræ•°æ®çš„æŸ¥è¯¢  å‰åºéå†ã€ä¸­åºéå†ã€åç»­éå†ã€å€¼æŸ¥è¯¢  // å‰åºéå†\rfunc (b *BinarySearchTree) nLR(node *binarySearchTreeNode){\rif node == nil{\rreturn\r}\rfmt.Printf(\u0026quot;%d-\u0026gt;\u0026quot;, node.info)\rb.nLR(node.left)\rb.nLR(node.right)\r}\r// ä¸­åºéå†\rfunc (b *BinarySearchTree)lNR(node *binarySearchTreeNode){\rif node == nil{\rreturn\r}\rb.lNR(node.left)\rfmt.Printf(\u0026quot;%d-\u0026gt;\u0026quot;, node.info)\rb.lNR(node.right)\r}\r// ååºéå†\rfunc (b *BinarySearchTree)lRN(node *binarySearchTreeNode){\rif node == nil{\rreturn\r}\rb.lRN(node.left)\rb.lRN(node.right)\rfmt.Printf(\u0026quot;%d-\u0026gt;\u0026quot;, node.info)\r}\r// å‰åºæ˜¾ç¤º\rfunc (b *BinarySearchTree)ShowNLR(){\rif b.root == nil{\rfmt.Println(\u0026quot;zhe tree is empty\u0026quot;)\rreturn\r}\rfmt.Print(\u0026quot;NLR:\u0026quot;)\rnode := b.root\rb.nLR(node)\rfmt.Println()\r}\r// ä¸­åºæ˜¾ç¤º\rfunc (b *BinarySearchTree)ShowLNR(){\rif b.root == nil{\rfmt.Println(\u0026quot;zhe tree is empty\u0026quot;)\rreturn\r}\rfmt.Print(\u0026quot;LNR:\u0026quot;)\rnode := b.root\rb.lNR(node)\rfmt.Println()\r}\r// ååºæ˜¾ç¤º\rfunc (b *BinarySearchTree)ShowLRN(){\rif b.root == nil{\rfmt.Println(\u0026quot;zhe tree is empty\u0026quot;)\rreturn\r}\rfmt.Print(\u0026quot;LRN:\u0026quot;)\rnode := b.root\rb.lRN(node)\rfmt.Println()\r}\r// æŸ¥æ‰¾å€¼æ˜¯å¦å­˜åœ¨\rfunc (b *BinarySearchTree)IsValue(data int) bool {\rif b.root == nil{\rreturn false\r}\rnode := b.root\rfor {\rif node == nil{\rreturn false\r}\rif node.info == data {\rreturn true\r}\rif data \u0026lt; node.info{\rnode = node.left\r}else {\rnode = node.right\r}\r}\r}\ræ ‘çš„åˆ›å»º func NewBinarySearchTree() *BinarySearchTree {\rreturn \u0026amp;BinarySearchTree{\rroot: nil,\rnumNodes: 0,\r}\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/tree/binary_search_tree  ","date":"2022-01-05T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-binary-search-tree-go%E5%AE%9E%E7%8E%B0/1_hu163e0849e6d75821587eb02814146518_65785_120x120_fill_box_smart1.gif","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-binary-search-tree-go%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-Binary search tree goå®ç°"},{"content":"äºŒå‰æŸ¥æ‰¾æ ‘ æ•°æ®ç»“æ„å®šä¹‰ \r// èŠ‚ç‚¹çš„å®šä¹‰\rtemplate\u0026lt;class T\u0026gt;\rclass BinarySearchTreeNode\r{\rpublic:\rBinarySearchTreeNode()\r{\rleft = 0;\rright = 0;\r}\rBinarySearchTreeNode(T data)\r{\rthis-\u0026gt;data = data;\rleft = 0;\rright = 0;\r}\r~BinarySearchTreeNode(){};\rT data; // ä¿å­˜çš„èŠ‚ç‚¹çš„æ•°æ®\rBinarySearchTreeNode *left; // æŒ‡å‘å·¦èŠ‚ç‚¹\rBinarySearchTreeNode *right; // æŒ‡å‘å³èŠ‚ç‚¹\r};\r// æ ‘çš„å®šä¹‰\rtemplate\u0026lt;class T\u0026gt;\rclass BinarySearchTree\r{\rprivate:\rBinarySearchTreeNode\u0026lt;T\u0026gt; *root; // å®šä¹‰å¤´èŠ‚ç‚¹\rint treeNodeNum; // æ ‘çš„èŠ‚ç‚¹æ•°\rvoid deleteNodeAll(BinarySearchTreeNode\u0026lt;T\u0026gt; *node); // åˆ é™¤æ‰€æœ‰èŠ‚ç‚¹\r// æ˜¾ç¤ºèŠ‚ç‚¹\rvoid DLR(BinarySearchTreeNode\u0026lt;T\u0026gt; *node);\rvoid LDR(BinarySearchTreeNode\u0026lt;T\u0026gt; *node);\rvoid LRD(BinarySearchTreeNode\u0026lt;T\u0026gt; *node);\r// åˆ é™¤*\u0026amp;ä»£è¡¨æŒ‡é’ˆå¼•ç”¨\rvoid deleteNodeByMerge(BinarySearchTreeNode\u0026lt;T\u0026gt;*\u0026amp; node); // åˆå¹¶åˆ é™¤\rvoid deleteNodeByCopy(BinarySearchTreeNode\u0026lt;T\u0026gt;*\u0026amp; node); // å¤åˆ¶åˆ é™¤\rpublic:\rBinarySearchTree()\r{\rroot = 0;\rtreeNodeNum = 0;\r};\r~BinarySearchTree();\r// æ¸…ç©ºæ ‘\rvoid clear();\r// èŠ‚ç‚¹çš„ä¸ªæ•°\rint Nodes()\r{\rreturn treeNodeNum;\r}\r// æ˜¯å¦ä¸ºç©ºæ ‘\rbool isEmpty()\r{\rreturn root == 0;\r}\r// æ’å…¥æ•°æ®\rvoid inseartNode(const T data);\r// æ·±åº¦ä¼˜å…ˆéå†æ ‘\r// å‰åºéå†(DLR æ ¹-\u0026gt;å·¦-\u0026gt;å³)\rvoid showNodeByDLR();\r// ä¸­åºéå†(LDR å·¦-\u0026gt;æ ¹-\u0026gt;å³)\rvoid showNodeByLDR();\r// ååºéå†(LRD å·¦-\u0026gt;å³-\u0026gt;æ ¹)\rvoid showNodeByLRD();\r// åˆ é™¤èŠ‚ç‚¹çš„æ•°æ®\r// åˆå¹¶åˆ é™¤\rbool removeNodeMerge(const T data);\r// å¤åˆ¶åˆ é™¤\rbool removeNodeCopy(const T data);\r// æŸ¥æ‰¾æ•°æ®\rbool SearchData(const T data);\r};\ræ•°æ®æ“ä½œ  å¢åˆ æ”¹æŸ¥  æ•°æ®çš„æ’å…¥ template\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::inseartNode(const T data)\r{\rBinarySearchTreeNode\u0026lt;T\u0026gt; *new_node = new BinarySearchTreeNode\u0026lt;T\u0026gt;(data);\r// å¦‚æœä¸ºç©ºæ ‘\rif(isEmpty())\r{\rroot = new_node; // æ–°å»ºèŠ‚ç‚¹è®¾ç½®ä¸ºroot èŠ‚ç‚¹\rtreeNodeNum ++; // æ ‘çš„èŠ‚ç‚¹æ•°+1\rreturn;\r}\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\r// éå†æ ‘ï¼Œ æ‰¾åˆ°æ’å…¥çš„èŠ‚ç‚¹çš„ä½ç½®\rwhile (node != 0)\r{\r// å½“èŠ‚ç‚¹çš„å€¼å¤§äºæ’å…¥çš„å€¼æ—¶ï¼Œå°±æ’å…¥åˆ°å·¦å­æ•°\rif(node-\u0026gt;data \u0026gt; data)\r{\r// å·¦èŠ‚ç‚¹ä¸ºnill, å°†æ–°èŠ‚ç‚¹èµ‹å€¼ç»™èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\rif(node-\u0026gt;left == NULL)\r{\rnode-\u0026gt;left = new_node;\rbreak; // æ¨å‡ºå¾ªç¯\r}\relse\r{\rnode = node-\u0026gt;left;\rcontinue; // ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r}\r}\relse\r{\r// å¦‚æœå³èŠ‚ç‚¹ä¸ºnill, å³èŠ‚ç‚¹-\u0026gt;æ–°èŠ‚ç‚¹\rif(node-\u0026gt;right == NULL)\r{\rnode-\u0026gt;right = new_node;\rbreak;\r}\relse\r{\rnode = node-\u0026gt;right;\rcontinue;\r}\r} }\rtreeNodeNum ++; // æ•°çš„èŠ‚ç‚¹æ•°+1\r}\ræ•°æ®çš„åˆ é™¤ // é‡‡ç”¨é€’å½’çš„æ–¹å¼åˆ é™¤èŠ‚ç‚¹\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::deleteNodeAll(BinarySearchTreeNode\u0026lt;T\u0026gt; *node)\r{\r// å¦‚æœçš„ç©ºæ ‘å°±ç»“æŸé€’å½’\rif(node == 0)\r{\rreturn;\r}\rdeleteNodeAll(node-\u0026gt;left);\rdeleteNodeAll(node-\u0026gt;right);\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; endl;\rdelete node; // é‡Šæ”¾èµ„æº\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::clear()\r{\rdeleteNodeAll(root); // æ¸…ç©ºæ‰€æœ‰èŠ‚ç‚¹\rtreeNodeNum = 0; // æ ‘çš„èŠ‚ç‚¹æ•°ä¸º0\r}\r/*\råˆå¹¶åˆ é™¤æ³•ï¼š\rä»åˆ é™¤çš„èŠ‚ç‚¹çš„ä¸¤æ£µå­æ ‘åˆå¹¶æœªä¸€æ£µæ ‘ï¼Œç„¶åå°†è¿™é¢—æ ‘è¿æ¥åˆ°åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹\rå…·ä½“æ“ä½œï¼šå·¦å­æ ‘çš„æœ€å¤§å€¼å·¦ä½œä¸ºæœ‰å­æ ‘çš„çˆ¶èŠ‚ç‚¹ï¼Œå·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºè¿™æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ æˆ–å³å­æ ‘çš„æœ€å°å€¼ä½œä¸ºå·¦å­æ ‘çš„çˆ¶èŠ‚ç‚¹ï¼Œå³å­æ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºè¿™æ£µæ ‘çš„æ ¹èŠ‚ç‚¹\r*/\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::deleteNodeByMerge(BinarySearchTreeNode\u0026lt;T\u0026gt;*\u0026amp; node)\r{\r// å·¦å­æ ‘ä½œä¸ºrootä½œä¸ºæ ‘çš„root\r/*\rBinarySearchTreeNode\u0026lt;T\u0026gt; *temp = node;\rif(node != 0)\r{\r// å¦‚æœèŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ä¸ºç©º\rif(!node-\u0026gt;left)\r{\rnode = node-\u0026gt;right; //ç›´æ¥æŒ‡å‘nodeçš„å³èŠ‚ç‚¹\r}\r// å¦‚æœå³å­èŠ‚ç‚¹ä¸ºç©º\relse if(!node-\u0026gt;right)\r{\rnode = node-\u0026gt;left; // ç›´æ¥æŒ‡å‘nodeçš„å·¦èŠ‚ç‚¹\r}\relse{\rtemp = node-\u0026gt;left; // temp ä¸ºnodeçš„å·¦èŠ‚ç‚¹\r// æ‰¾å‡ºå·¦èŠ‚ç‚¹ä¸­çš„æœ€å¤§å€¼\rwhile (temp-\u0026gt;right)\r{\rtemp = temp-\u0026gt;right;\r}\rtemp-\u0026gt;right = node-\u0026gt;right; // å·¦å­æ ‘çš„æœ€å¤§å€¼æŒ‡å‘å³èŠ‚ç‚¹\rtemp = node; node = node-\u0026gt;left; // å·¦å­æ ‘ä½œä¸ºä¸¤é¢—æ ‘çš„å¤´èŠ‚ç‚¹\r}\rdelete temp;\r} */\r// å³å­æ ‘çš„rootä½œä¸ºæ ‘çš„root\rBinarySearchTreeNode\u0026lt;T\u0026gt; *temp = node;\rif(node)\r{\rif(!node-\u0026gt;left)\r{\rnode = node-\u0026gt;right;\r}\relse if(!node-\u0026gt;right)\r{\rnode = node-\u0026gt;left;\r}\relse\r{\rtemp = node-\u0026gt;right;\rwhile (temp-\u0026gt;left)\r{\rtemp = temp -\u0026gt;left;\r}\rtemp -\u0026gt;left = node-\u0026gt;left;\rtemp = node;\rnode = node-\u0026gt;right;\r}\rdelete temp;\r}\r}\r/*\rå¤åˆ¶åˆ é™¤æ³•ï¼š\rå°†è¢«åˆ é™¤èŠ‚ç‚¹çš„å·¦å­æ ‘çš„æœ€å¤§å€¼æˆ–è€…å³å­æ ‘çš„æœ€å°å€¼å¤åˆ¶ç»™è¢«åˆ é™¤çš„èŠ‚ç‚¹çš„æ•°å€¼ï¼Œ\rç„¶ååˆ é™¤å·¦å­æ ‘çš„æœ€å¤§å€¼çš„èŠ‚ç‚¹æˆ–è€…å³å­æ ‘çš„æœ€å°å€¼çš„èŠ‚ç‚¹\r*/\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::deleteNodeByCopy(BinarySearchTreeNode\u0026lt;T\u0026gt;*\u0026amp; node)\r{\r// å¤åˆ¶å³å­æ ‘çš„æœ€å°å€¼\r/*\rBinarySearchTreeNode\u0026lt;T\u0026gt; *prev = 0; // å¤åˆ¶èŠ‚ç‚¹(å³å­æ ‘æœ€å°å€¼è¢«åˆ èŠ‚ç‚¹)çš„å‰é©±èŠ‚ç‚¹\rBinarySearchTreeNode\u0026lt;T\u0026gt; *temp = node;\rif(node)\r{\rif(!node-\u0026gt;left)\r{\rnode = node-\u0026gt;right;\r}\relse if(!node-\u0026gt;right)\r{\rnode = node-\u0026gt;left;\r}\relse\r{\rtemp = node-\u0026gt;right;\r// æ‰¾åˆ°å³å­æ ‘çš„æœ€å°å€¼\rwhile (temp-\u0026gt;left)\r{\rprev = temp;\rtemp = temp-\u0026gt;left;\r}\rnode-\u0026gt;data = temp-\u0026gt;data; // å°†å³å­æ ‘çš„æœ€å°å€¼å¤åˆ¶ç»™è¢«åˆ èŠ‚ç‚¹\r// å½“å³å­æ ‘çš„é¦–èŠ‚ç‚¹æ²¡æœ‰å·¦èŠ‚ç‚¹æ—¶\rif(prev == node)\r{\rnode-\u0026gt;right = temp-\u0026gt;right; // ç›´æ¥æŒ‡å‘è¢«åˆ èŠ‚ç‚¹çš„å³èŠ‚ç‚¹\r}\relse\r{\rprev-\u0026gt;left = temp-\u0026gt;right; // å…ˆé©±èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹æŒ‡å‘åˆ é™¤èŠ‚ç‚¹çš„å³èŠ‚ç‚¹\r}\r}\rdelete temp;\r}*/\r// å¤åˆ¶å·¦å­æ ‘çš„æœ€å¤§å€¼\rBinarySearchTreeNode\u0026lt;T\u0026gt; *prev = 0; // å¤åˆ¶èŠ‚ç‚¹(å³å­æ ‘æœ€å°å€¼è¢«åˆ èŠ‚ç‚¹)çš„å‰é©±èŠ‚ç‚¹\rBinarySearchTreeNode\u0026lt;T\u0026gt; *temp = node;\rif(node)\r{\rif(!node-\u0026gt;left)\r{\rnode = node-\u0026gt;right;\r}\relse if(!node-\u0026gt;right)\r{\rnode = node-\u0026gt;left;\r}\relse\r{\rtemp = node-\u0026gt;left;\r// æ‰¾åˆ°å·¦å­æ ‘çš„æœ€å¤§å€¼\rwhile (temp-\u0026gt;right)\r{\rprev = temp;\rtemp = temp-\u0026gt;right;\r}\rnode-\u0026gt;data = temp-\u0026gt;data; // å°†å·¦å­æ ‘çš„æœ€å¤§å€¼å¤åˆ¶ç»™è¢«åˆ èŠ‚ç‚¹\r// å½“å·¦å­æ ‘çš„é¦–èŠ‚ç‚¹æ²¡æœ‰å³èŠ‚ç‚¹æ—¶\rif(prev == node)\r{\rnode-\u0026gt;left = temp-\u0026gt;left; // ç›´æ¥æŒ‡å‘è¢«åˆ èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\r}\relse\r{\rprev-\u0026gt;right = temp-\u0026gt;left; // å…ˆé©±èŠ‚ç‚¹çš„å³èŠ‚ç‚¹æŒ‡å‘åˆ é™¤èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹\r}\r}\rdelete temp;\r}\r}\r// åˆå¹¶åˆ é™¤\rtemplate\u0026lt;class T\u0026gt;\rbool BinarySearchTree\u0026lt;T\u0026gt; ::removeNodeMerge(const T data)\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;the tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn false;\r}\rBinarySearchTreeNode\u0026lt;T\u0026gt; *prev_node = 0; // å¤´èŠ‚ç‚¹\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\r// æ‰¾åˆ°å€¼çš„èŠ‚ç‚¹\rwhile (node)\r{\r// å¦‚æœnodeçš„å€¼ç­‰äºdata\rif(node-\u0026gt;data == data)\r{\rbreak;\r}\rprev_node = node; // nodeçš„å¤´èŠ‚ç‚¹\r// node çš„å€¼å¤§äºdeta å°±å¾€å·¦å­æ ‘æ‰¾\rif(node-\u0026gt;data \u0026gt; data)\r{\rnode = node-\u0026gt;left;\r}\r// node çš„å€¼å°äº data å°±å¾€å³å­æ ‘æ‰¾\relse{\rnode = node-\u0026gt;right;\r}\r}\r// æ‰¾åˆ°å€¼çš„èŠ‚ç‚¹äº†\rif(node != 0 \u0026amp;\u0026amp; node-\u0026gt;data == data)\r{\r// å¦‚æœæ˜¯å¤´èŠ‚ç‚¹\rif(node == root)\r{\r// deleteNodeByMerge(root);\rdeleteNodeByCopy(root);\r}\r// å…¶ä»–èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹==data\relse if(prev_node-\u0026gt;left == node)\r{\r// deleteNodeByMerge(prev_node-\u0026gt;left);\rdeleteNodeByCopy(prev_node-\u0026gt;left);\r}\relse\r{\r// deleteNodeByMerge(prev_node-\u0026gt;right);\rdeleteNodeByCopy(prev_node-\u0026gt;right);\r}\rtreeNodeNum--; //èŠ‚ç‚¹æ•°å‡ä¸€\rreturn true;\r}\relse\r{\rcout \u0026lt;\u0026lt; data \u0026lt;\u0026lt; \u0026quot;no exits tree\u0026quot; \u0026lt;\u0026lt; endl;\r}\rreturn false;\r}\r// å¤åˆ¶åˆ é™¤\rtemplate\u0026lt;class T\u0026gt;\rbool BinarySearchTree\u0026lt;T\u0026gt; ::removeNodeCopy(const T data)\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;the tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn false;\r}\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\rBinarySearchTreeNode\u0026lt;T\u0026gt; *prev = 0;\r// æ‰¾åˆ°æ•°æ®çš„èŠ‚ç‚¹\rwhile (node)\r{\r// æ‰¾åˆ°å€¼å°±è·³å‡ºå¾ªç¯\rif(node-\u0026gt;data == data)\r{\rbreak;\r}\r// æœªæ‰¾åˆ°ï¼Œçˆ¶èŠ‚ç‚¹ç»™prev\rprev = node;\r// data \u0026gt; value -\u0026gt; å³å­æ ‘æŸ¥æ‰¾\rif(data \u0026gt; node-\u0026gt;data)\r{\rnode = node-\u0026gt;right;\r}\r// å·¦å­æ ‘æŸ¥æ‰¾\relse\r{\rnode = node-\u0026gt;left;\r}\r}\r// æ‰¾åˆ°èŠ‚ç‚¹\rif(node \u0026amp;\u0026amp; node-\u0026gt;data == data)\r{\r// èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹\rif(node == root)\r{\rdeleteNodeByCopy(root);\r}\r// å³èŠ‚ç‚¹\relse if(prev-\u0026gt;right == node)\r{\rdeleteNodeByCopy(prev-\u0026gt;right);\r}\r// å·¦èŠ‚ç‚¹\relse\r{\rdeleteNodeByCopy(prev-\u0026gt;left);\r}\r// èŠ‚ç‚¹æ•°-1\rtreeNodeNum--;\rreturn true;\r}\r// æœªæ‰¾åˆ°\relse\r{\rcout \u0026lt;\u0026lt; data \u0026lt;\u0026lt; \u0026quot;no exits in zhe tree\u0026quot; \u0026lt;\u0026lt; endl;\r}\rreturn false;\r}\ræ•°æ®çš„æŸ¥è¯¢  å‰åºéå†ã€ä¸­åºéå†ã€åç»­éå†ã€å€¼æŸ¥è¯¢  template\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::DLR(BinarySearchTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{ return;\r}\r// å‰åºéå†(DLR)(æ ¹-\u0026gt;å·¦-\u0026gt;å³)\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; \u0026quot;-\u0026gt;\u0026quot;;\rDLR(node-\u0026gt;left);\rDLR(node-\u0026gt;right);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::LDR(BinarySearchTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{\rreturn;\r}\r// ä¸­åºéå†(LDR)(å·¦-\u0026gt;æ ¹-\u0026gt;å³)\rLDR(node-\u0026gt;left);\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; \u0026quot;-\u0026gt;\u0026quot;;\rLDR(node-\u0026gt;right);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::LRD(BinarySearchTreeNode\u0026lt;T\u0026gt; *node)\r{\rif(!node)\r{\rreturn;\r}\r// ååºéå†(LRD)(å·¦-\u0026gt;å³-\u0026gt;æ ¹)\rLRD(node-\u0026gt;left);\rLRD(node-\u0026gt;right);\rcout \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; \u0026quot;-\u0026gt;\u0026quot;;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::showNodeByDLR()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\r// éå†æ ‘\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\rcout \u0026lt;\u0026lt; \u0026quot;DLR: \u0026quot;;\rDLR(node); cout \u0026lt;\u0026lt; endl;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::showNodeByLDR()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\r// éå†æ ‘\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\rcout \u0026lt;\u0026lt; \u0026quot;LDR: \u0026quot;;\rLDR(node); cout \u0026lt;\u0026lt; endl; }\rtemplate\u0026lt;class T\u0026gt;\rvoid BinarySearchTree\u0026lt;T\u0026gt; ::showNodeByLRD()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;this tree is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\r// éå†æ ‘\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\rcout \u0026lt;\u0026lt; \u0026quot;LRD: \u0026quot;;\rLRD(node); cout \u0026lt;\u0026lt; endl; }\rtemplate\u0026lt;class T\u0026gt;\rbool BinarySearchTree\u0026lt;T\u0026gt; ::SearchData(const T data)\r{\rif(isEmpty())\r{\rreturn false;\r}\rBinarySearchTreeNode\u0026lt;T\u0026gt; *node = root;\rwhile (node)\r{\rif(node-\u0026gt;data == data)\r{\rreturn true;\r}\relse if(data \u0026gt; node-\u0026gt;data)\r{\rnode = node-\u0026gt;right;\r}\relse\r{\rnode = node-\u0026gt;left;\r}\r}\rreturn false\r;\r}\ræµ‹è¯• \rint main(int argc, char const *argv[])\r{\rBinarySearchTree\u0026lt;int\u0026gt; tree;\rtree.inseartNode(5);\rtree.inseartNode(3);\rtree.inseartNode(2);\rtree.inseartNode(4);\rtree.inseartNode(6);\rtree.inseartNode(5);\rtree.inseartNode(7);\r// å‰åºéå†\rtree.showNodeByDLR();\r// ä¸­åºéå†\rtree.showNodeByLDR();\r// ååºéå†\rtree.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;*******************************\u0026quot; \u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; tree.removeNodeMerge(5) \u0026lt;\u0026lt; endl;\r// å‰åºéå†\rtree.showNodeByDLR();\r// ä¸­åºéå†\rtree.showNodeByLDR();\r// ååºéå†5\rtree.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;nodes is:\u0026quot; \u0026lt;\u0026lt; tree.Nodes() \u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; \u0026quot;*******************************\u0026quot; \u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; tree.removeNodeCopy(7) \u0026lt;\u0026lt; endl;\r// å‰åºéå†\rtree.showNodeByDLR();\r// ä¸­åºéå†\rtree.showNodeByLDR();\r// ååºéå†\rtree.showNodeByLRD();\rcout \u0026lt;\u0026lt; \u0026quot;nodes is:\u0026quot; \u0026lt;\u0026lt; tree.Nodes() \u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; \u0026quot;*******************************\u0026quot; \u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; tree.SearchData(21) \u0026lt;\u0026lt; endl;\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/tree/binary_tree  ","date":"2022-01-01T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-binary-search-tree-c-%E5%AE%9E%E7%8E%B0/1_hu163e0849e6d75821587eb02814146518_65785_120x120_fill_box_smart1.gif","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-binary-search-tree-c-%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-Binary search tree c++å®ç°"},{"content":"æ ˆ åŸºäºå•å‘é“¾è¡¨å®ç°\næ•°æ®ç»“æ„å®šä¹‰ type stackData struct {\rlist *Singly_linked_list.LinkedList\r}\r// è·å¾—æ ˆçš„é•¿åº¦\rfunc (s *stackData)Len() int{\rreturn s.list.Len()\r}\ræ•°æ®æ“ä½œ // å°†æ•°æ®æ’å…¥æ ˆé¡¶\rfunc (s *stackData)Push(data interface{}) {\rs.list.AddToHead(data)\r}\r// å°†æ•°æ®ä»æ ˆé¡¶å–å‡ºï¼Œå¹¶åˆ é™¤æ•°æ®\rfunc (s *stackData)Pop()interface{}{\rdata := s.list.QuireIndex(0)\r// æ ˆä¸ä¸ºç©º, åˆ é™¤æ ˆé¡¶æ•°æ®\rif data != nil{\rs.list.DeleteToHead()\r}\rreturn data\r}\r// å°†æ•°æ®å–å‡ºï¼Œä¸åˆ é™¤æ•°æ®\rfunc (s *stackData)GetTopValue()interface{}{\rreturn s.list.QuireIndex(0)\r}\r// å±•ç¤ºæ ˆ\rfunc (s *stackData)ShowStack() {\rs.list.QuireAll()\r}\råˆ›å»ºæ ˆ func NewStackData()*stackData{\rreturn \u0026amp;stackData{list:Singly_linked_list.NewLinkedList()}\r}\ré˜Ÿåˆ—  åŸºäºåŒå‘é“¾è¡¨å®ç°  æ•°æ®ç»“æ„å®šä¹‰ type queueData struct {\rlist *double_linked_list.DoubleList\r}\r// è·å¾—é˜Ÿåˆ—çš„å¤§å°\rfunc (q *queueData)Len() int{\rreturn q.list.Len()\r}\ræ•°æ®çš„æ“ä½œ // å°†æ•°æ®é˜Ÿå°¾\rfunc (q *queueData)EnQueue(data interface{}) {\rq.list.AddToTail(data)\r}\r// å°†æ•°æ®ä»é˜Ÿé¦–å–å‡ºï¼Œå¹¶åˆ é™¤æ•°æ®\rfunc (q *queueData)DeQueue()interface{}{\rdata := q.list.QuireIndex(0)\r// æ ˆä¸ä¸ºç©º, åˆ é™¤æ ˆé¡¶æ•°æ®\rif data != nil{\rq.list.DeleteToHead()\r}\rreturn data\r}\r// å°†æ•°æ®å–å‡ºï¼Œä¸åˆ é™¤æ•°æ®\rfunc (q *queueData)GetTopQueueValue()interface{}{\rreturn q.list.QuireIndex(0)\r}\r// å±•ç¤ºé˜Ÿåˆ—\rfunc (q *queueData)ShowQueue() {\rq.list.QuireAll()\r}\råˆ›å»ºé˜Ÿåˆ— func NewQueueData()*queueData{\rreturn \u0026amp;queueData{list:double_linked_list.NewDoubleLinkedList()}\r}\ræºç   æˆ‘çš„github:https:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/stack_queue/queue æˆ‘çš„github:https:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/stack_queue/stack  ","date":"2021-12-31T22:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%9F%BA%E4%BA%8E%E5%8D%95%E9%A1%B9%E9%93%BE%E8%A1%A8%E9%98%9F%E5%88%97%E5%9F%BA%E4%BA%8E%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8go%E5%AE%9E%E7%8E%B0/1_hucc057a99640c389677e7decbd4886594_40524_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%9F%BA%E4%BA%8E%E5%8D%95%E9%A1%B9%E9%93%BE%E8%A1%A8%E9%98%9F%E5%88%97%E5%9F%BA%E4%BA%8E%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8go%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-æ ˆ(åŸºäºå•é¡¹é“¾è¡¨)\u0026\u0026é˜Ÿåˆ—(åŸºäºåŒå‘é“¾è¡¨)goå®ç°"},{"content":"æ ˆ åŸºäºå•å‘é“¾è¡¨å®ç°\næ•°æ®ç»“æ„å®šä¹‰ \rtemplate\u0026lt;class T\u0026gt;\rclass Stack\r{\rprivate:\rSinglyList\u0026lt;T\u0026gt; list; // å­˜å‚¨æ•°æ®çš„é“¾è¡¨\rpublic:\rStack(/* args */){};\r~Stack();\r// è·å¾—æ ˆçš„é•¿åº¦\rint len()\r{\rreturn list.getlen();\r}\r// æ¸…ç©ºæ ˆ\rvoid clear();\r// åˆ¤æ–­æ ˆæ˜¯å¦ä¸ºç©ºs\rbool isEmpty();\r// å°†æ•°æ®æ”¾å…¥æ ˆé¡¶\rvoid push(T data);\r// è·å–æ ˆé¡¶æ•°æ®ï¼Œå¹¶åˆ é™¤æ•°æ®\rbool pop(T *info);\r// è·å–æ ˆé¡¶æ•°æ®ä½†ä¸åˆ é™¤æ•°æ®\rbool getTopValue(T *info);\r// æ˜¾ç¤ºæ‰€æœ‰æ ˆçš„æ•°æ®\rvoid showStack();\r};\ræ•°æ®æ“ä½œ \rtemplate\u0026lt;class T\u0026gt;\rvoid Stack\u0026lt;T\u0026gt; ::clear()\r{\rlist.clear();\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid Stack\u0026lt;T\u0026gt; ::push(T data)\r{\rlist.inseartToHead(data);\r}\rtemplate\u0026lt;class T\u0026gt;\rbool Stack\u0026lt;T\u0026gt; ::pop(T *info)\r{\r// åˆ¤æ–­æ ˆé¡¶æ˜¯å¦æœ‰å€¼\rif(getTopValue(info))\r{\rlist.deleteToHead(); // åˆ é™¤æ ˆé¡¶å€¼\rreturn true;\r}\rreturn false;\r}\rtemplate\u0026lt;class T\u0026gt;\rbool Stack\u0026lt;T\u0026gt; ::getTopValue(T *info)\r{\r// åˆ¤æ–­æ ˆé¡¶æ˜¯å¦æœ‰å€¼\rif(list.queryIndex(0, info))\r{\rreturn true;\r}\rreturn false;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid Stack\u0026lt;T\u0026gt; ::showStack()\r{\rlist.queryAll();\r}\ræµ‹è¯• int main()\r{\rStack\u0026lt;int\u0026gt; s;\rs.push(0);\rs.push(1);\rs.push(2);\rs.push(3);\rs.push(4);\rs.showStack();\rcout \u0026lt;\u0026lt; \u0026quot;********************************\u0026quot; \u0026lt;\u0026lt; endl;\rint info = -1;\rif(s.getTopValue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(s.getTopValue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(s.getTopValue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rcout \u0026lt;\u0026lt; \u0026quot;********************************\u0026quot; \u0026lt;\u0026lt; endl;\rs.showStack();\rcout \u0026lt;\u0026lt; \u0026quot;********************************\u0026quot; \u0026lt;\u0026lt; endl;\rif(s.pop(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(s.pop(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(s.pop(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(s.pop(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rcout \u0026lt;\u0026lt; \u0026quot;********************************\u0026quot; \u0026lt;\u0026lt; endl;\rs.showStack();\rcout \u0026lt;\u0026lt; \u0026quot;********************************\u0026quot; \u0026lt;\u0026lt; endl;\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\ré˜Ÿåˆ—  åŸºäºåŒå‘é“¾è¡¨å®ç°  æ•°æ®ç»“æ„å®šä¹‰ \rtemplate\u0026lt;class T\u0026gt;\rclass Queue\r{\rprivate:\rTwoWayList\u0026lt;T\u0026gt; list; // å®šä¹‰çš„åŒå‘é“¾è¡¨\rpublic:\rQueue(/* args */){};\r~Queue();\r// è·å¾—é˜Ÿåˆ—çš„é•¿åº¦\rint len()\r{\rreturn list.getlen();\r}\r// æ¸…ç©ºé˜Ÿåˆ—\rvoid clear();\r// åˆ¤æ–­æ ˆæ˜¯å¦ä¸ºç©ºs\rbool isEmpty();\r// å°†æ•°æ®å­˜å…¥é˜Ÿåˆ—å°¾ä¸­\rvoid enQueue(T data);\r// è·å–è·å¾—é˜Ÿåˆ—æ•°æ®ï¼Œå¹¶åˆ é™¤æ•°æ®\rbool deQueue(T *info);\r// è·å–è·å¾—é˜Ÿåˆ—æ•°æ®ï¼Œä½†ä¸åˆ é™¤æ•°æ®\rbool getQueueValue(T *info);\r// æ˜¾ç¤ºæ‰€æœ‰é˜Ÿåˆ—çš„æ•°æ®\rvoid showQueue();\r};\ræ•°æ®çš„æ“ä½œ \rtemplate\u0026lt;class T\u0026gt;\rvoid Queue\u0026lt;T\u0026gt; ::clear()\r{\rlist.clear();\r}\rtemplate\u0026lt;class T\u0026gt;\rbool Queue\u0026lt;T\u0026gt; ::isEmpty()\r{\rreturn list.isEmpty();\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid Queue\u0026lt;T\u0026gt; ::enQueue(T data)\r{\rlist.inseartTotail(data);\r}\rtemplate\u0026lt;class T\u0026gt;\rbool Queue\u0026lt;T\u0026gt; ::getQueueValue(T *info)\r{\rif(list.queryIndex(0, info))\r{\rreturn true;\r}\rreturn false;\r}\rtemplate\u0026lt;class T\u0026gt;\rbool Queue\u0026lt;T\u0026gt; ::deQueue(T *info)\r{\rif(list.queryIndex(0, info))\r{\rlist.deleteToHead();\rreturn true;\r}\rreturn false;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid Queue\u0026lt;T\u0026gt; ::showQueue()\r{\rlist.queryAll();\r}\ræµ‹è¯• int main()\r{\rQueue\u0026lt;int\u0026gt; q;\rq.enQueue(0);\rq.enQueue(1);\rq.enQueue(2);\rq.enQueue(3);\rq.enQueue(4);\rq.enQueue(5);\rq.showQueue();\rcout \u0026lt;\u0026lt; \u0026quot;**************************************\u0026quot;\u0026lt;\u0026lt; endl;\rint info = -1;\rif(q.getQueueValue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;queue top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(q.getQueueValue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;queue top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rif(q.getQueueValue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;queue top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rq.showQueue();\rcout \u0026lt;\u0026lt; \u0026quot;**************************************\u0026quot;\u0026lt;\u0026lt; endl;\rif(q.deQueue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;queue top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rq.showQueue();\rcout \u0026lt;\u0026lt; \u0026quot;**************************************\u0026quot;\u0026lt;\u0026lt; endl;\rif(q.deQueue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;queue top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rq.showQueue();\rcout \u0026lt;\u0026lt; \u0026quot;**************************************\u0026quot;\u0026lt;\u0026lt; endl;\rif(q.deQueue(\u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;queue top value is: \u0026quot; \u0026lt;\u0026lt;info \u0026lt;\u0026lt; endl;\r}\rq.showQueue();\rcout \u0026lt;\u0026lt; \u0026quot;**************************************\u0026quot;\u0026lt;\u0026lt; endl;\rq.clear();\rq.showQueue();\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\ræºç   æˆ‘çš„github:https:https://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/stack_queue/queue æˆ‘çš„github:https:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/stack_queue/stackhttps://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/stack_queue/stack  ","date":"2021-12-31T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%9F%BA%E4%BA%8E%E5%8D%95%E9%A1%B9%E9%93%BE%E8%A1%A8%E9%98%9F%E5%88%97%E5%9F%BA%E4%BA%8E%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8c-%E5%AE%9E%E7%8E%B0/1_hucc057a99640c389677e7decbd4886594_40524_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%9F%BA%E4%BA%8E%E5%8D%95%E9%A1%B9%E9%93%BE%E8%A1%A8%E9%98%9F%E5%88%97%E5%9F%BA%E4%BA%8E%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8c-%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-æ ˆ(åŸºäºå•é¡¹é“¾è¡¨)\u0026\u0026é˜Ÿåˆ—(åŸºäºåŒå‘é“¾è¡¨)c++å®ç°"},{"content":"åŒå‘é“¾è¡¨ æ•°æ®ç»“æ„çš„å®šä¹‰ // åŒå‘é“¾è¡¨çš„èŠ‚ç‚¹å®šä¹‰\rtype doubleLinkedNode struct {\rinfo interface{} // å­˜å‚¨çš„æ•°æ®\rprev *doubleLinkedNode // æŒ‡å‘å…ˆé©±èŠ‚ç‚¹\rnext *doubleLinkedNode // æŒ‡å‘åé©±å‡ ç‚¹\r}\r// åŒå‘é“¾è¡¨å®šä¹‰\rtype DoubleList struct {\rHead *doubleLinkedNode // å¤´èŠ‚ç‚¹\rTail *doubleLinkedNode // å°¾èŠ‚ç‚¹\rlen int // é“¾è¡¨é•¿åº¦\r}\råˆ›å»ºèŠ‚ç‚¹ func createNode(data interface{}) *doubleLinkedNode {\rreturn \u0026amp;doubleLinkedNode{\rinfo: data,\rprev: nil,\rnext: nil,\r}\r}\ré“¾è¡¨çš„é•¿åº¦ // é“¾è¡¨çš„é•¿åº¦\rfunc(d *DoubleList)Len() int{\rreturn d.len\r}\ræ•°æ®çš„æ’å…¥ å•ä¸ªèŠ‚ç‚¹çš„æ’å…¥ // é“¾è¡¨çš„å°¾æ’æ³•\rfunc (d *DoubleList)AddToTail(info interface{}) *DoubleList {\rnewNode := createNode(info) // åˆ›å»ºæ–°èŠ‚ç‚¹\r// é“¾è¡¨ä¸ºç©º, å¤´å°¾èŠ‚ç‚¹éƒ½æŒ‡å‘è¯¥èŠ‚ç‚¹\rif d.Head == nil{\rd.Head = newNode\rd.Tail = newNode\r}else{\rd.Tail.next = newNode\rnewNode.prev = d.Tail\rd.Tail = d.Tail.next\r}\r// é“¾è¡¨é•¿åº¦+1\rd.len++\rreturn d\r}\r// é“¾è¡¨çš„å¤´æ’æ³•\rfunc (d *DoubleList)AddToHead(info interface{}) *DoubleList {\rnewNode := createNode(info) // åˆ›å»ºèŠ‚ç‚¹\r// é“¾è¡¨ä¸ºç©º\rif d.Head == nil{\rd.Head = newNode\rd.Tail = newNode\r}else{\rnewNode.next = d.Head // æ–°èŠ‚ç‚¹çš„åé©±æŒ‡å‘å¤´èŠ‚ç‚¹\rd.Head.prev = newNode // å¤´èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘æ–°èŠ‚ç‚¹\rd.Head = newNode // å°†æ–°èŠ‚ç‚¹è®¾ç½®å°¾å¤´èŠ‚ç‚¹\r}\r// é“¾è¡¨é•¿åº¦+1\rd.len++\rreturn d\r}\r// é“¾è¡¨çš„index\r// é€šè¿‡index=\u0026gt;æ’å…¥é“¾è¡¨æ–°çš„èŠ‚ç‚¹\r// indexä¸ºæ­£æ•° ä¸ºä»å·¦-\u0026gt;å³ // 0è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\r// indexä¸ºè´Ÿæ•° ä¸ºä»å³-\u0026gt;å·¦ // -1è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\rfunc (d *DoubleList)AddToIndex(index int, info interface{}) *DoubleList {\r// å½“é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œé‡‡ç”¨äº†å°¾æ’å…¥æ³•æ’å…¥æ•°æ®\rif d.Head == nil{\rreturn d.AddToTail(info)\r}\r// å½“indexå¤§äºé“¾è¡¨çš„å€¼æ—¶ï¼Œé»˜è®¤å°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨çš„åé¢\rif int(math.Abs(float64(index))) \u0026gt; d.len-1{\rreturn d.AddToTail(info)\r}\r// æ’å…¥é“¾è¡¨çš„å¤´éƒ¨\rif index == 0{\rreturn d.AddToHead(info)\r}\r// æ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾\rif index == -1{\rreturn d.AddToTail(info)\r}\r// å½“index ä¸ºè´Ÿæ•°æ—¶ï¼Œä»å³åˆ°å·¦æ’å…¥\rif index \u0026lt; 0{\rindex += d.len +1\r}\r__index := 1 // å†…éƒ¨çš„indexå€¼\r// ä»ç¬¬äºŒä¸ªå€¼å¼€å§‹æ’å…¥\rfor node := d.Head; node != d.Tail; node = node.next{\rif index == __index{\rnewNode := createNode(info)\rnode.next.prev = newNode // èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹çš„å…ˆé©±æŒ‡å‘æ–°èŠ‚ç‚¹\rnewNode.prev = node // æ–°èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘èŠ‚ç‚¹\rnewNode.next = node.next // æ–°èŠ‚ç‚¹çš„åé©±æŒ‡å‘èŠ‚ç‚¹çš„åé©±\rnode.next = newNode // èŠ‚ç‚¹çš„åé©±æŒ‡å‘æ–°èŠ‚ç‚¹\r// é“¾è¡¨çš„èŠ‚ç‚¹æ•°åŠ 1\rd.len ++\rreturn d\r}\r__index ++\r}\rreturn d\r}\ré“¾è¡¨çš„åˆå¹¶ // å°†æ–°çš„é“¾è¡¨æ’å…¥å¤´éƒ¨\rfunc (d *DoubleList)AddListToHead(list *DoubleList)*DoubleList{\r// ä¸¤ä¸ªé“¾è¡¨éƒ½ä¸ºç©ºæ—¶\rif d.Head == nil \u0026amp;\u0026amp; list.Head == nil{\rreturn d\r}\r// åˆå¹¶è¡¨ä¸ºç©º\rif d.Head != nil \u0026amp;\u0026amp; list.Head == nil{\rreturn d\r}\r// ä¸»è¡¨ä¸ºç©º\rif d.Head == nil \u0026amp;\u0026amp; list.Head != nil{\rreturn list\r}\r// åˆå¹¶è¡¨çš„å°¾æŒ‡é’ˆæŒ‡å‘ä¸»è¡¨çš„å¤´\rlist.Tail.next = d.Head\rd.Head.prev = list.Tail\rlist.Tail = d.Tail\r// è¡¨èŠ‚ç‚¹æ•°åˆå¹¶\rlist.len += d.len\rreturn list\r}\r// å°†æ–°çš„é“¾è¡¨æ’å…¥åˆ°å°¾éƒ¨\rfunc (d *DoubleList)AddListToTail(list *DoubleList)*DoubleList{\r// ä¸¤ä¸ªé“¾è¡¨éƒ½ä¸ºç©ºæ—¶\rif d.Head == nil \u0026amp;\u0026amp; list.Head == nil{\rreturn d\r}\r// åˆå¹¶è¡¨ä¸ºç©º\rif d.Head != nil \u0026amp;\u0026amp; list.Head == nil{\rreturn d\r}\r// ä¸»è¡¨ä¸ºç©º\rif d.Head == nil \u0026amp;\u0026amp; list.Head != nil{\rreturn list\r}\r// å°†æ–°è¡¨æ’å…¥åˆ°ä¸»è¡¨ä¹‹å\rd.Tail.next = list.Head\rlist.Head.prev = d.Tail\rd.Tail = list.Tail\rd.len += list.len\rreturn d\r}\r// ç»æ–°çš„è¡¨æ’å…¥åˆ°index\rfunc (d *DoubleList)AddListToIndex(index int, list *DoubleList) *DoubleList {\r// ä¸¤ä¸ªé“¾è¡¨éƒ½ä¸ºç©ºæ—¶\rif d.Head == nil \u0026amp;\u0026amp; list.Head == nil{\rreturn d\r}\r// åˆå¹¶è¡¨ä¸ºç©º\rif d.Head != nil \u0026amp;\u0026amp; list.Head == nil{\rreturn d\r}\r// ä¸»è¡¨ä¸ºç©º\rif d.Head == nil \u0026amp;\u0026amp; list.Head != nil{\rreturn list\r}\rif int(math.Abs(float64(index))) \u0026gt; d.len{\rfmt.Println(\u0026quot;é”™è¯¯çš„index\u0026quot;)\rreturn d\r}\rif index == 0{\rreturn d.AddListToHead(list)\r}\rif index == -1{\rreturn d.AddListToTail(list)\r}\rif index \u0026lt; 0{\rindex += d.len\r}\r__index := 1\rfor node := d.Head; node != d.Tail; node = node.next{\rif index == __index{\rnode.next.prev = list.Tail\rlist.Tail.next = node.next\rnode.next = list.Head\rlist.Head.prev = node\rd.len += list.len // é“¾è¡¨çš„æ•°å€¼ç›¸åŠ \rreturn d\r}\r__index ++\r}\rreturn d\r}\ræ•°æ®çš„åˆ é™¤ // é“¾è¡¨å¤´åˆ é™¤æ³•\rfunc (d *DoubleList)DeleteToHead()*DoubleList{\r// é“¾è¡¨ä¸ºç©º\rif d.Head == nil{\rreturn d\r}\r// é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªæ•°\rif d.Head == d.Tail{\rd.Head = nil\rd.Tail = nil\rd.len = 0\rreturn d\r}\rd.Head = d.Head.next\rd.Head.prev = nil\r// nodeæ•°å‡ä¸€\rd.len --\rreturn d\r}\r// é“¾è¡¨å°¾åˆ é™¤æ³•\rfunc (d *DoubleList)DeleteToTail()*DoubleList{\r// é“¾è¡¨ä¸ºç©º\rif d.Tail == nil{\rreturn d\r}\r// é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªæ•°\rif d.Head == d.Tail{\rd.Head = nil\rd.Tail = nil\rd.len = 0\rreturn d\r}\rd.Tail = d.Tail.prev\rd.Tail.next = nil\r// nodeæ•°å‡ä¸€\rd.len --\rreturn d\r}\r// é€šè¿‡å€¼=\u0026gt;åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹(ç¬¬ä¸€ä¸ª)\rfunc (d *DoubleList)DeleteToAValue(value interface{})*DoubleList{\r// é“¾è¡¨ä¸ºç©º\rif d.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨ä¸ºç©º\u0026quot;)\rreturn d\r}\r// value == head.info\r// å°±é‡‡ç”¨å¤´åˆ æ³•\rif value == d.Head.info{\rreturn d.DeleteToHead()\r}\rif value == d.Tail.info{\rreturn d.DeleteToTail()\r}\r// ä¸­é—´é‡‡ç”¨è½®è¯¢æŸ¥æ‰¾value, ä»ç¬¬äºŒä¸ªå¼€å§‹è½®è¯¢åˆ°å€’æ•°ç¬¬äºŒä¸ªç»“æŸ\rfor node := d.Head.next; node != d.Tail; node = node.next{\rif node.info == value{\r// åˆ é™¤node\rnode.next.prev = node.prev\rnode.prev.next = node.next\rd.len --\rreturn d\r}\r}\rfmt.Println(\u0026quot;é“¾è¡¨ä¸­ï¼šå€¼ä¸å­˜åœ¨\u0026quot;)\rreturn d\r}\r// é€šè¿‡å€¼=\u0026gt;åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹(æ‰€æœ‰)\rfunc (d *DoubleList)DeleteToValue(value interface{})*DoubleList{\r// é“¾è¡¨ä¸ºç©º\rif d.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨ä¸ºç©º\u0026quot;)\rreturn d\r}\rnode := d.Head // å½“å‰çš„node\rfor {\r// å½“ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶ï¼Œå°±åˆ¤æ–­é¦–ä½å’Œæœ«å°¾æ˜¯ä¸ºéœ€è¦åˆ é™¤çš„node\rif node == d.Tail {\rif d.Head.info == value{\rd.DeleteToHead()\r}\rif d.Tail.info == value{\rd.DeleteToTail()\r}\rreturn d\r}\rif node.info == value{\r// åˆ é™¤nodeï¼Œ éå¤´èŠ‚ç‚¹\rif node.prev != nil{\rnode.next.prev = node.prev\rnode.prev.next = node.next\rd.len --\r}else{\r// å¤´èŠ‚ç‚¹\rd.DeleteToHead()\r}\r}\rnode = node.next\r}\r}\r// é€šè¿‡index=\u0026gt;åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹\r// indexä¸ºæ­£æ•° ä¸ºä»å·¦-\u0026gt;å³ // 0è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\r// indexä¸ºè´Ÿæ•° ä¸ºä»å³-\u0026gt;å·¦ // -1è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\rfunc (d *DoubleList)DeleteToIndex(index int)*DoubleList{\r// é“¾è¡¨ä¸ºç©º\rif d.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨ä¸ºç©º\u0026quot;)\rreturn d\r}\r// index è¶…è¿‡é“¾è¡¨æ•°\rif int(math.Abs(float64(index))) \u0026gt; d.len-1{\rfmt.Println(\u0026quot;é”™è¯¯çš„index\u0026quot;)\rreturn d\r}\r// åˆ é™¤ç¬¬ä¸€ä¸ªnode\rif index == 0{\rreturn d.DeleteToHead()\r}\rif index \u0026lt; 0{\rindex += d.len\r}\rif index == d.len -1{\rreturn d.DeleteToTail()\r}\r_index := 1\rnode := d.Head.next\rfor {\rif index == _index{\rnode.next.prev = node.prev\rnode.prev.next = node.next\rd.len --\rreturn d\r}\rnode = node.next\r_index ++\r}\r}\ræ•°æ®çš„æŸ¥è¯¢ // éå†é“¾è¡¨\rfunc (d *DoubleList) QuireAll() {\rif d.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨æ•°æ®ä¸ºç©º\u0026quot;)\rreturn\r}\rnode := d.Head\rfor {\rif node == nil{\rreturn\r}\rfmt.Println(node.info)\rif node == d.Tail{\rreturn\r}\rnode = node.next\r}\r}\r// åˆ¤æ–­valveæ˜¯å¦å­˜åœ¨\rfunc (d *DoubleList)QuireValue(value interface{}) bool{\r// è¡¨ä¸ºç©º\rif d.Head == nil{\rreturn false\r}\r// è¡¨ä¸­åªå­˜åœ¨ä¸€ä¸ªå€¼\rif d.Head == d.Tail{\rif d.Head.info == value{\rreturn true\r}\rreturn false\r}\r// éå†æŸ¥å€¼\rfor node := d.Head; node != d.Tail.next; node = node.next{\rif node.info == value{\rreturn true\r}\r}\rreturn false\r}\r// æ ¹æ®ç´¢å¼•è¿”å›å€¼\rfunc (d *DoubleList)QuireIndex(index int) interface{} {\r// é“¾è¡¨ä¸ºç©º\rif d.Head == nil{\rreturn nil\r}\rif int(math.Abs(float64(index))) \u0026gt; d.len -1 {\rfmt.Println(\u0026quot;ç´¢å¼•å€¼é”™è¯¯\u0026quot;)\rreturn nil\r}\rif index == 0{\rreturn d.Head.info\r}\rif index == d.len -1 || index == -1{\rreturn d.Tail.info\r}\rif index \u0026lt; 0{\rindex += d.len\r}\r__index := 1\rfor node := d.Head.next; node != d.Tail; node = node.next{\rif __index == index{\rreturn node.info\r}\r__index ++\r}\r//fmt.Println(\u0026quot;æœªèƒ½æ‰¾åˆ°ï¼ï¼ï¼ï¼\u0026quot;)\rreturn nil\r}\rç»“æ„çš„å…¥å£ func NewDoubleLinkedList()*DoubleList{\r// åˆ›å»ºçš„é“¾è¡¨å¤´å°¾èŠ‚ç‚¹éƒ½ä¸ºç©º\rreturn \u0026amp;DoubleList{\rHead: nil,\rTail: nil,\rlen: 0,\r}\r}\rå¾ªç¯åŒå‘é“¾è¡¨ æ•°æ®ç»“æ„çš„å®šä¹‰ // èŠ‚ç‚¹çš„å®šä¹‰\rtype circleDoubleNode struct {\rinfo interface{} // æ•°æ®ç»“æ„çš„å®šä¹‰\rprev *circleDoubleNode // å‰é©±æŒ‡é’ˆ\rnext *circleDoubleNode // åé©±æŒ‡é’ˆ\r}\r// åŒå‘å¾ªç¯é“¾è¡¨çš„å®šä¹‰\rtype circleDoubleList struct {\rcurrentNode *circleDoubleNode // æŒ‡å‘é“¾è¡¨çš„æŒ‡é’ˆ\rlen int // é“¾è¡¨çš„é•¿åº¦\r}\råˆ›å»ºèŠ‚ç‚¹ func createNode(data interface{}) *circleDoubleNode{\rreturn \u0026amp;circleDoubleNode{\rinfo: data,\rprev: nil,\rnext: nil,\r}\r}\r// å¾—åˆ°é“¾è¡¨çš„é•¿åº¦\rfunc (c *circleDoubleList)GetLen()int{\rreturn c.len\r}\rèŠ‚ç‚¹çš„æ’å…¥ func (c *circleDoubleList)InsertNode(data interface{}) {\rnewNode := createNode(data)\r// å¦‚æœé“¾è¡¨ä¸ºç©º\rif c.currentNode == nil{\rc.currentNode = newNode // æ–°åˆ›å»ºçš„èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹\r// èŠ‚ç‚¹çš„å‰é©±ä¸åé©±éƒ½æŒ‡å‘è‡ªå·±\rc.currentNode.next = c.currentNode\rc.currentNode.prev = c.currentNode\r}else{\r// èŠ‚ç‚¹çš„æ’å…¥\rc.currentNode.next.prev = newNode\rnewNode.prev = c.currentNode\rnewNode.next = c.currentNode.next\rc.currentNode.next = newNode\rc.currentNode = newNode\r}\r// é“¾è¡¨é•¿åº¦ +1\rc.len ++\r}\rå½“å‰èŠ‚ç‚¹çš„åˆ é™¤ func (c *circleDoubleList)DeleteNode() bool{\r// é“¾è¡¨ä¸ºç©º\rif c.currentNode == nil{\rreturn false\r}\r// å½“é“¾è¡¨å€¼å­˜åœ¨ä¸€ä¸ªå…ƒç´ æ—¶\rif c.len == 1{\rc.currentNode = nil\rc.len --\rreturn true\r}\r// å½“é“¾è¡¨åªå­˜åœ¨ä¸¤ä¸ªå…ƒç´ æ—¶\rif c.len == 2{\rc.currentNode = c.currentNode.next\rc.len --\rreturn true\r}\r// å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„çš„å‰é©±èŠ‚ç‚¹\rc.currentNode.next.prev = c.currentNode.prev\r// å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„åé©±æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹\rc.currentNode.prev.next = c.currentNode.next\r// è®¾ç½®å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹\rc.currentNode = c.currentNode.next\rc.len --\rreturn true\r}\réå†è¯´æœ‰èŠ‚ç‚¹ func (c *circleDoubleList)QuireAll(){\rif c.currentNode == nil{\rfmt.Println(\u0026quot;circle double linked list is empty\u0026quot;)\rreturn\r}\r//__index := 1\r//for node := c.currentNode.next; node != c.currentNode; node = node.next{\r//\tfmt.Printf(\u0026quot;index is %d, node value is %v\u0026quot;, __index, node.info)\r//\t__index ++\r//}\rfmt.Printf(\u0026quot;circle double linked list len is %d \\n\u0026quot;, c.len)\rnode := c.currentNode.next\rfor i := 1; i \u0026lt; c.len; i++{\rfmt.Printf(\u0026quot;index is %d, node value is %v \\n\u0026quot;, i, node.info)\rnode = node.next\r}\rfmt.Printf(\u0026quot;index is %d, node value is %v \\n\u0026quot;, c.len, c.currentNode.info)\r}\r// åˆ¤æ–­å€¼æ˜¯å¦å­˜åœ¨\rfunc (c *circleDoubleList)QuireValue(data interface{}) bool{\rif c.currentNode == nil{\rreturn false\r}\rnode := c.currentNode\rfor i := 1; i \u0026lt;= c.len; i++{\rif node.info == data{\rreturn true\r}\rnode = node.next\r}\rreturn false\r}\ré“¾è¡¨å®ä¾‹åŒ– func NewCircleDoubleList()*circleDoubleList{\rreturn \u0026amp;circleDoubleList{\rcurrentNode: nil,\rlen: 0,\r}\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/Linked_list/double_linked_list æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/Linked_list/circle_double_linked_list  ","date":"2021-12-30T22:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8%E5%BE%AA%E7%8E%AF%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0/1_huc216cf6486350636a2e6728955e7fc78_62516_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8%E5%BE%AA%E7%8E%AF%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-åŒå‘é“¾è¡¨\u0026\u0026å¾ªç¯åŒå‘é“¾è¡¨goè¯­è¨€å®ç°"},{"content":"åŒå‘é“¾è¡¨ æ•°æ®ç»“æ„çš„å®šä¹‰ template\u0026lt;class T\u0026gt;\rclass TwoWayLinkedNode\r{\rpublic:\rTwoWayLinkedNode(/* args */){}; TwoWayLinkedNode(T data)\r{\rthis-\u0026gt;data = data;\rthis-\u0026gt;prev = 0;\rthis-\u0026gt;next = 0;\r}\r~TwoWayLinkedNode(){};\rT data; // æ•°æ®\rTwoWayLinkedNode *next; // æŒ‡å‘åç»§èŠ‚ç‚¹\rTwoWayLinkedNode *prev; // æŒ‡å‘å‰é©±\r};\rtemplate\u0026lt;class T\u0026gt;\rclass TwoWayList\r{\rprivate:\r/* data */\rTwoWayLinkedNode\u0026lt;T\u0026gt; *head; // å¤´èŠ‚ç‚¹\rTwoWayLinkedNode\u0026lt;T\u0026gt; *tail; // å°¾èŠ‚ç‚¹\rint len; // é“¾è¡¨é•¿åº¦\rpublic:\rTwoWayList()\r{\rhead = 0;\rtail = 0;\rlen = 0;\r};\r~TwoWayList();\r// é“¾è¡¨çš„é•¿åº¦+1\rvoid setlen(int len)\r{\rthis-\u0026gt;len += len;\r}; // è¿”å›é“¾è¡¨çš„é•¿åº¦\rint getlen()\r{\rreturn len;\r};\r// æ¸…ç©ºé“¾è¡¨\rvoid clear();\r// é“¾è¡¨æ˜¯å¦ä¸ºç©º\rbool isEmpty()\r{\rreturn head == 0;\r}\r// æ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨\rvoid inseartToHead(T data); // æ’å…¥åˆ°é“¾è¡¨çš„å°¾éƒ¨\rvoid inseartTotail(T data); // æ’å…¥åˆ°é“¾è¡¨çš„index\rvoid inseartToindex(int index, T data); // åˆ é™¤é“¾è¡¨çš„å¤´éƒ¨å…ƒç´ \rvoid deleteToHead();\r// åˆ é™¤é“¾è¡¨çš„å°¾éƒ¨å…ƒç´ \rvoid deleteToTail();\r// åˆ é™¤é“¾è¡¨çš„indexå…ƒç´ \rvoid deleteToIndex(int index);\r// æŸ¥è¯¢é“¾è¡¨çš„æ‰€æœ‰å€¼\rvoid queryAll();\r// è¿”å›indexçš„å€¼\rbool queryIndex(int index, T *data);\r// åˆ¤æ–­valueæ˜¯å¦å­˜åœ¨\rbool queryValue(T data);\r};\ræ•°æ®çš„æ“ä½œ \rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::inseartToHead(T data)\r{\rTwoWayLinkedNode\u0026lt;T\u0026gt; *new_Node = new TwoWayLinkedNode\u0026lt;T\u0026gt;(data); // é“¾è¡¨ä¸ºç©º\rif (isEmpty())\r{\rhead = tail = new_Node;\r}\relse\r{\rnew_Node-\u0026gt;next = head; // æ–°èŠ‚ç‚¹çš„åé©±æŒ‡å‘å¤´èŠ‚ç‚¹\rhead-\u0026gt;prev = new_Node; // å¤´èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘æ–°èŠ‚ç‚¹\rhead = new_Node; // å°†æ–°èŠ‚ç‚¹è®¾ç½®æ–°çš„å¤´èŠ‚ç‚¹\r}\rsetlen(addOne);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::inseartTotail(T data)\r{\rTwoWayLinkedNode\u0026lt;T\u0026gt; *new_Node = new TwoWayLinkedNode\u0026lt;T\u0026gt;(data);\rif(isEmpty())\r{\rhead = tail = new_Node;\r}\relse\r{\rtail-\u0026gt;next = new_Node; // å°¾èŠ‚ç‚¹çš„nextæŒ‡å‘æ–°èŠ‚ç‚¹\rnew_Node-\u0026gt;prev = tail; // æ–°èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘å°¾èŠ‚ç‚¹\rtail = new_Node; // å°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹\r}\rsetlen(addOne);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::inseartToindex(int index, T data)\r{\rint len = getlen();\rif(index == 0)\r{\rinseartToHead(data);\rreturn;\r}\r// é“¾è¡¨ä¸ºç©ºï¼Œå½“index å°äº0 æˆ–è€…å¤§äºç­‰äºé“¾è¡¨æ•°ï¼Œé‡‡ç”¨å°¾æ’æ³•\rif (isEmpty() || index \u0026lt; 0 || index \u0026gt;= len)\r{\rinseartTotail(data);\rreturn;\r}\rTwoWayLinkedNode\u0026lt;T\u0026gt; *node = head;\rint __index = 1;\rwhile (__index != index)\r{\rnode = node-\u0026gt;next;\r__index ++;\r}\rTwoWayLinkedNode\u0026lt;T\u0026gt; *new_node = new TwoWayLinkedNode\u0026lt;T\u0026gt;(data);\rnode-\u0026gt;next-\u0026gt;prev = new_node; // nodeèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„å…ˆé©±è¦æŒ‡å‘æ–°èŠ‚ç‚¹\rnew_node-\u0026gt;prev = node; // æ–°èŠ‚ç‚¹çš„å…ˆé©±è¦æŒ‡å‘node\rnew_node-\u0026gt;next = node-\u0026gt;next; // æ–°èŠ‚ç‚¹çš„åç»§è¦æŒ‡å‘nodeçš„åç»§\rnode-\u0026gt;next = new_node; // nodeçš„åç»§è¦æŒ‡å‘æ–°èŠ‚ç‚¹\rsetlen(addOne);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::clear()\r{\rwhile (!isEmpty())\r{\rTwoWayLinkedNode\u0026lt;T\u0026gt; *node = head-\u0026gt;next;\rdelete head;\rhead = node;\r}\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::deleteToHead()\r{\r// é“¾è¡¨ä¸ºç©ºå°±è¿”å›\rif(isEmpty())\r{\rreturn;\r}\r// é“¾è¡¨åªå­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹\rif(head == tail)\r{\rdelete head;\rhead = tail = 0;\r}\relse{\rhead = head-\u0026gt;next; // å°†ä¸‹ä¸€èŠ‚ç‚¹è®¾ç½®å¤´èŠ‚ç‚¹\rdelete head-\u0026gt;prev; // é‡Šæ”¾æ–°çš„å¤´èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹\rhead-\u0026gt;prev = 0; // å¤´èŠ‚ç‚¹çš„å…ˆé©±è®¾ç½®nil\r}\rsetlen(ReductOne);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::deleteToTail()\r{\r// é“¾è¡¨ä¸ºç©ºå°±è¿”å›\rif(isEmpty())\r{\rreturn;\r}\r// é“¾è¡¨åªå­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹\rif(head == tail)\r{\rdelete head;\rhead = tail = 0;\r}\relse{\rtail = tail-\u0026gt;prev; // å°¾èŠ‚ç‚¹çš„å…ˆé©±èŠ‚ç‚¹é‡æ–°è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹\rdelete tail-\u0026gt;next; // é‡Šæ”¾æ–°çš„å°¾èŠ‚ç‚¹çš„åé©±\rtail-\u0026gt;next = 0; // æ–°çš„å°¾èŠ‚ç‚¹çš„åé©±æŒ‡å‘å°¾nil\r}\rsetlen(ReductOne);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::deleteToIndex(int index)\r{\rlen = getlen();\r// é“¾è¡¨ä¸ºç©º,å°±è¿”å›\rif(isEmpty())\r{\rreturn;\r}\r// index \u0026gt;= len || index \u0026lt; 0 é‡‡ç”¨åˆ é™¤æœ«å°¾å€¼\rif (index \u0026gt;= len || index \u0026lt; 0)\r{\rdeleteToTail();\rreturn;\r}\rif(index == 0)\r{\rdeleteToHead();\rreturn;\r}\rif (index == len - 1)\r{\rdeleteToTail();\rreturn;\r}\rint __index = 1;\rTwoWayLinkedNode\u0026lt;T\u0026gt; *node = head-\u0026gt;next;\rwhile (__index != index)\r{\rnode = node-\u0026gt;next;\r__index ++;\r}\rnode-\u0026gt;prev-\u0026gt;next = node-\u0026gt;next; // nodeèŠ‚ç‚¹çš„å…ˆé©±èŠ‚ç‚¹çš„åé©±æŒ‡å‘nodeçš„åé©±\rnode-\u0026gt;next-\u0026gt;prev = node-\u0026gt;prev; // nodeèŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹çš„å…ˆé©±æŒ‡å‘nodeçš„å…ˆé©±\rdelete node; // é‡Šæ”¾node\rsetlen(ReductOne);\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid TwoWayList\u0026lt;T\u0026gt; ::queryAll()\r{\rif (isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;The list length is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\rcout \u0026lt;\u0026lt; \u0026quot;The length of the two way list is zero:\u0026quot; \u0026lt;\u0026lt; getlen() \u0026lt;\u0026lt; endl;\rint __index = 1;\rTwoWayLinkedNode\u0026lt;T\u0026gt; *node = head;\rwhile (node != tail-\u0026gt;next)\r{\rcout \u0026lt;\u0026lt; \u0026quot;node num is:\u0026quot; \u0026lt;\u0026lt; __index \u0026lt;\u0026lt; \u0026quot; data:\u0026quot; \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; endl;\rnode = node-\u0026gt;next;\r__index++; }\r}\rtemplate\u0026lt;class T\u0026gt;\rbool TwoWayList\u0026lt;T\u0026gt; ::queryIndex(int index, T *data)\r{\rlen = getlen();\r// é“¾è¡¨ä¸ºç©º,index \u0026gt;= len || index \u0026lt; 0 å°±è¿”å›\rif(isEmpty() || index \u0026gt;= len || index \u0026lt; 0)\r{\rreturn false;\r}\rint __index = 0;\rfor(TwoWayLinkedNode\u0026lt;T\u0026gt; *node = head; node != tail-\u0026gt;next; node = node-\u0026gt;next)\r{\rif (__index == index)\r{\r*data = node-\u0026gt;data;\rreturn true;\r}\r__index++;\r}\rreturn false;\r}\rtemplate\u0026lt;class T\u0026gt;\rbool TwoWayList\u0026lt;T\u0026gt; ::queryValue(T data)\r{\rif(isEmpty())\r{\rreturn false;\r}\rfor(TwoWayLinkedNode\u0026lt;T\u0026gt; *node = head; node != tail-\u0026gt;next; node = node-\u0026gt;next)\r{\rif (node-\u0026gt;data == data)\r{\rreturn true;\r}\r}\rreturn false;\r}\ræµ‹è¯• int main()\r{\rTwoWayList\u0026lt;int\u0026gt; newList;\rnewList.inseartToHead(3);\rnewList.inseartToHead(2);\rnewList.inseartToHead(1);\rnewList.inseartToHead(-11);\rnewList.inseartTotail(4);\rnewList.inseartTotail(5);\rnewList.inseartTotail(6);\rnewList.inseartTotail(7);\rnewList.inseartTotail(8);\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;****************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.inseartToindex(2, 11);\rnewList.inseartToindex(0, 2);\rnewList.inseartToindex(1, 3);\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;****************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToHead();\rnewList.deleteToHead();\rnewList.deleteToHead();\rnewList.queryAll();\r// newList.clear();\rcout \u0026lt;\u0026lt; \u0026quot;****************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToTail();\rnewList.deleteToTail();\rnewList.deleteToTail();\rnewList.deleteToTail();\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;****************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToIndex(4);\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;****************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rint index = 1;\rint info;\rif(newList.queryIndex(index, \u0026amp;info))\r{\rcout \u0026lt;\u0026lt; \u0026quot;exits index: \u0026quot; \u0026lt;\u0026lt; index \u0026lt;\u0026lt; \u0026quot; =\u0026gt; value is \u0026quot; \u0026lt;\u0026lt; info\u0026lt;\u0026lt; endl;\r}\relse\r{\rcout \u0026lt;\u0026lt;\u0026quot; no exits index:\u0026quot; \u0026lt;\u0026lt; index \u0026lt;\u0026lt; endl;\r}\rcout \u0026lt;\u0026lt; \u0026quot;****************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.queryAll();\rcout \u0026lt;\u0026lt; newList.queryValue(1)\u0026lt;\u0026lt; endl;\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\rå¾ªç¯åŒå‘é“¾è¡¨ æ•°æ®ç»“æ„çš„å®šä¹‰ // å¾ªç¯åŒå‘é“¾è¡¨èŠ‚ç‚¹\rtemplate\u0026lt;class T\u0026gt;\rclass CircularDoubleLinkedNode\r{\rpublic:\rCircularDoubleLinkedNode()\r{\rprev = next = 0;\r}\rCircularDoubleLinkedNode(T data)\r{\rinfo = data;\rprev = next = 0;\r}\r~CircularDoubleLinkedNode(){};\rT info; // æ•°æ®\rCircularDoubleLinkedNode *prev; // å…ˆé©±èŠ‚ç‚¹\rCircularDoubleLinkedNode *next; // åç»§èŠ‚ç‚¹\r};\rtemplate\u0026lt;class T\u0026gt;\rclass CircularDoubleList\r{\rprivate:\rCircularDoubleLinkedNode\u0026lt;T\u0026gt; *current_node; // æŒ‡å‘å½“å‰èŠ‚ç‚¹\rint len; // é“¾è¡¨çš„é•¿åº¦\rpublic:\rCircularDoubleList()\r{\rcurrent_node = 0;\rlen = 0;\r}\r~CircularDoubleList();\rvoid addLen()\r{\rlen++;\r}\rvoid reduceLen()\r{\rlen--;\r}\rint getLen()\r{\rreturn len;\r}\rbool isEmpty()\r{\rreturn current_node == 0;\r}\rvoid inseartNode(T data);\rbool deleteNode();\rvoid queryAll();\r// åˆ¤æ–­valueæ˜¯å¦å­˜åœ¨\rbool queryValue(T data);\r};\ræ•°æ®çš„æ“ä½œ \rtemplate\u0026lt;class T\u0026gt;\rvoid CircularDoubleList\u0026lt;T\u0026gt; ::inseartNode(T data)\r{\rCircularDoubleLinkedNode\u0026lt;T\u0026gt; *new_node = new CircularDoubleLinkedNode\u0026lt;T\u0026gt;(data);\r// å¦‚æœé“¾è¡¨ä¸ºç©º\rif(isEmpty())\r{\r// å½“å‰èŠ‚ç‚¹ä¸ºæ–°çš„èŠ‚ç‚¹\rcurrent_node = new_node;\rcurrent_node-\u0026gt;next = current_node; // åé©±æŒ‡å‘è‡ªå·±\rcurrent_node-\u0026gt;prev = current_node; // å‰é©±ä¹ŸæŒ‡å‘è‡ªå·±\r}\relse\r{\r/*ä¸åŒå‘é“¾è¡¨ä¸­çš„æ’å…¥åˆ°é“¾è¡¨ä¸­æ˜¯ä¸€æ ·çš„*/\rcurrent_node-\u0026gt;next-\u0026gt;prev = new_node;\rnew_node-\u0026gt;prev = current_node;\rnew_node-\u0026gt;next = current_node-\u0026gt;next;\rcurrent_node-\u0026gt;next = new_node;\rcurrent_node = new_node;\r}\raddLen();\r}\rtemplate\u0026lt;class T\u0026gt;\rbool CircularDoubleList\u0026lt;T\u0026gt; ::deleteNode()\r{\r// é“¾è¡¨ä¸ºç©º\rif(isEmpty())\r{\rreturn false;\r}\rint len = getLen();\r// é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ \rif(len == 1)\r{\rdelete current_node;\rcurrent_node = 0;\rreduceLen();\rreturn true;\r}\r// é“¾è¡¨ä¸­åªæœ‰ä¸¤ä¸ªå…ƒç´ \rif (len == 2)\r{\rCircularDoubleLinkedNode\u0026lt;T\u0026gt; *node = current_node;\rcurrent_node = current_node-\u0026gt;next;\rcurrent_node-\u0026gt;next = current_node;\rcurrent_node-\u0026gt;prev = current_node;\rdelete node;\rreduceLen();\rreturn true;\r}\r// é“¾è¡¨å…ƒç´ è¾¾åˆ°3ä¸ªåŠ3ä¸ªä»¥ä¸Š\rCircularDoubleLinkedNode\u0026lt;T\u0026gt; *node = current_node;\rcurrent_node-\u0026gt;prev-\u0026gt;next = current_node-\u0026gt;next;\rcurrent_node-\u0026gt;next-\u0026gt;prev = current_node-\u0026gt;prev;\rcurrent_node = current_node-\u0026gt;next;\rdelete node;\rreduceLen();\rreturn true;\r}\rtemplate\u0026lt;class T\u0026gt;\rvoid CircularDoubleList\u0026lt;T\u0026gt; ::queryAll()\r{\rif(isEmpty())\r{\rcout \u0026lt;\u0026lt; \u0026quot;circular double list is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\rcout \u0026lt;\u0026lt; \u0026quot;circular double list len is:\u0026quot; \u0026lt;\u0026lt; getLen() \u0026lt;\u0026lt; endl;\rint __index = 1;\rfor (CircularDoubleLinkedNode\u0026lt;T\u0026gt; *node = current_node-\u0026gt;next; node != current_node; node = node-\u0026gt;next)\r{\rcout \u0026lt;\u0026lt; \u0026quot;index:\u0026quot; \u0026lt;\u0026lt; __index \u0026lt;\u0026lt; \u0026quot; data is: \u0026quot; \u0026lt;\u0026lt; node-\u0026gt;info \u0026lt;\u0026lt; endl;\r__index++;\r}\rcout \u0026lt;\u0026lt; \u0026quot;index:\u0026quot; \u0026lt;\u0026lt; __index \u0026lt;\u0026lt; \u0026quot; data is: \u0026quot; \u0026lt;\u0026lt; current_node-\u0026gt;info \u0026lt;\u0026lt; endl;\r}\rtemplate\u0026lt;class T\u0026gt;\rbool CircularDoubleList\u0026lt;T\u0026gt; ::queryValue(T data)\r{\r// åˆ¤æ–­é“¾è¡¨ä¸ºç©º\rif(isEmpty())\r{\rreturn false;\r}\r// å½“å‰èŠ‚ç‚¹çš„å€¼== data\rif(current_node-\u0026gt;info == data)\r{\rreturn true;\r}\r// å¾ªç¯éå†å½“èŠ‚ç‚¹çš„value== data then retuen ture\rfor(CircularDoubleLinkedNode\u0026lt;T\u0026gt; *node = current_node-\u0026gt;next; node != current_node; node = node-\u0026gt;next)\r{\rif(node-\u0026gt;info == data)\r{\rreturn true;\r}\r}\rreturn false;\r}\ræµ‹è¯• int main()\r{\rCircularDoubleList\u0026lt;int\u0026gt; cirList;\rcirList.inseartNode(0);\rcirList.inseartNode(1);\rcirList.inseartNode(2);\rcirList.inseartNode(3);\rcirList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;*****************************************************\u0026quot; \u0026lt;\u0026lt; endl;\rcirList.deleteNode();\rcirList.deleteNode();\r// cirList.deleteNode();\r// cirList.deleteNode();\rcirList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;******************************************************\u0026quot; \u0026lt;\u0026lt;endl;\rint data = 11;\rif(cirList.queryValue(data))\r{\rcout \u0026lt;\u0026lt; data \u0026lt;\u0026lt; \u0026quot; is exists\u0026quot; \u0026lt;\u0026lt; endl;\r}\relse\r{\rcout \u0026lt;\u0026lt; data \u0026lt;\u0026lt; \u0026quot; is not exists\u0026quot; \u0026lt;\u0026lt; endl;\r}\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/linked_list/two_way_linked_list æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/linked_list/circular_double_linked_list  ","date":"2021-12-30T21:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8%E5%BE%AA%E7%8E%AF%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8-c-%E5%AE%9E%E7%8E%B0/1_huc216cf6486350636a2e6728955e7fc78_62516_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8%E5%BE%AA%E7%8E%AF%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8-c-%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-åŒå‘é“¾è¡¨\u0026\u0026å¾ªç¯åŒå‘é“¾è¡¨ c++å®ç°"},{"content":"å•å‘é“¾è¡¨ æ•°æ®ç»“æ„çš„å®šä¹‰ æ•°æ®èŠ‚ç‚¹çš„ç±»çš„å®šä¹‰ class SinglyLinkedNode\r{\rpublic:\rSinglyLinkedNode(){\rnext = 0;\r};\r// åˆ›å»ºæ–°çš„node\rSinglyLinkedNode(int data)\r{\rthis-\u0026gt;data = data;\rnext = 0;\r};\r~SinglyLinkedNode(){};\rint data; // é“¾è¡¨çš„æ•°æ®\rSinglyLinkedNode *next; // æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r};\ré“¾è¡¨çš„æ•°æ®ç»“æ„(ç±»çš„å®šä¹‰) class SinglyList\r{\rprivate:\r/* data */\rSinglyLinkedNode *head; // å¤´èŠ‚ç‚¹\rSinglyLinkedNode *tail; // å°¾èŠ‚ç‚¹\rint len; // é“¾è¡¨é•¿åº¦\rpublic:\rSinglyList(){\rhead = 0;\rtail = 0;\rlen = 0;\r};\r~SinglyList();\r// é“¾è¡¨çš„é•¿åº¦+1\rvoid setlen(int len)\r{\rthis-\u0026gt;len += len;\r}; // è¿”å›é“¾è¡¨çš„é•¿åº¦\rint getlen()\r{\rreturn len;\r};\r// é“¾è¡¨æ˜¯å¦ä¸ºç©º\rbool ismpty()\r{\rreturn head == 0;\r}\r// æ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨\rvoid inseartToHead(int data); // æ’å…¥åˆ°é“¾è¡¨çš„å°¾éƒ¨\rvoid inseartTotail(int data); // æ’å…¥åˆ°é“¾è¡¨çš„index\rvoid inseartToindex(int index, int data); // åˆ é™¤é“¾è¡¨çš„å¤´éƒ¨å…ƒç´ \rvoid deleteToHead();\r// åˆ é™¤é“¾è¡¨çš„å°¾éƒ¨å…ƒç´ \rvoid deleteToTail();\r// åˆ é™¤é“¾è¡¨çš„indexå…ƒç´ \rvoid deleteToIndex(int index);\r// æŸ¥è¯¢é“¾è¡¨çš„æ‰€æœ‰å€¼\rvoid queryAll();\r// è¿”å›indexçš„å€¼\rint queryIndex(int index);\r// åˆ¤æ–­valueæ˜¯å¦å­˜åœ¨\rbool queryValue(int data);\r};\ræ•°æ®çš„æ’å…¥ æ’å…¥åˆ°é“¾è¡¨çš„å°¾éƒ¨ void SinglyList::inseartTotail(int data)\r{\r// å®šä¹‰node\rSinglyLinkedNode *new_node;\rnew_node = new SinglyLinkedNode(data);\r// é“¾è¡¨ä¸ºç©º\rif (ismpty())\r{\rhead = tail = new_node; // å¤´å°¾èŠ‚ç‚¹éƒ½æŒ‡å‘æ–°åˆ›èŠ‚ç‚¹\rsetlen(addOne); // èŠ‚ç‚¹æ•°+1\rreturn;\r}\rtail-\u0026gt;next = new_node;\rtail = tail-\u0026gt;next;\rsetlen(addOne);\r}\ræ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ void SinglyList::inseartToHead(int data)\r{\rSinglyLinkedNode *node;\rnode = new SinglyLinkedNode(data);\rif (ismpty()){\rhead = tail = node;\rsetlen(addOne);\rreturn ;\r}\rnode-\u0026gt;next = head;\rhead = node;\rsetlen(addOne);\r}\ræ’å…¥åˆ°é“¾è¡¨çš„index void SinglyList::inseartToindex(int index, int data)\r{\rint len;\rlen = getlen()-1;\r// å¦‚æœé“¾è¡¨ä¸ºç©º, æˆ–è€…æ’å…¥åˆ°æœ«å°¾,æˆ–è€…index \u0026lt;0 é‡‡ç”¨å°¾æ’æ³•æ·»åŠ åˆ°é“¾è¡¨ä¸­\rif (ismpty() || index ==len || index \u0026lt; 0)\r{\rinseartTotail(data);\rreturn;\r}\rif(index == 0){\rinseartToHead(data);\rreturn;\r}\rSinglyLinkedNode *node;\rnode = new SinglyLinkedNode(data);\rint __index = 1;\rfor (node = head; node != tail; node = node-\u0026gt;next)\r{\rif (__index == index)\r{\rSinglyLinkedNode *new_node;\rnew_node = new SinglyLinkedNode(data);\rnew_node -\u0026gt;next = node-\u0026gt;next;\rnode-\u0026gt;next = new_node;\rsetlen(addOne);\rreturn;\r}\r__index ++;\r}\r}\ræ•°æ®çš„åˆ é™¤ åˆ é™¤é“¾è¡¨çš„å¤´éƒ¨å…ƒç´  void SinglyList::deleteToHead()\r{\r// é“¾è¡¨ä¸ºç©º\rif(ismpty())\r{\rreturn;\r}\rSinglyLinkedNode *tmp = head;\r// é“¾è¡¨åªå­˜åœ¨ä¸€ä¸ªå€¼\rif(head == tail)\r{\rhead = tail = 0;\r}\relse\r{\rhead = head-\u0026gt;next;\r}\rdelete tmp; // é‡Šæ”¾èµ„æº\rsetlen(ReductOne);\r}\råˆ é™¤é“¾è¡¨çš„å°¾éƒ¨å…ƒç´  void SinglyList::deleteToTail()\r{\r// é“¾è¡¨ä¸ºç©º\rif(ismpty())\r{\rreturn;\r}\r// é“¾è¡¨åªå­˜åœ¨ä¸€ä¸ªå€¼\rif(head == tail)\r{\rdelete head;\rsetlen(ReductOne);\rhead = tail = 0;\rreturn;\r}\rSinglyLinkedNode *tmp = head;\rwhile (tmp-\u0026gt;next != tail)\r{\rtmp = tmp-\u0026gt;next;\r}\rdelete tail;\rtail = tmp;\rtail-\u0026gt;next = 0;\rsetlen(ReductOne);\r}\råˆ é™¤é“¾è¡¨çš„indexå…ƒç´  void SinglyList::deleteToIndex(int index)\r{\r// é“¾è¡¨ä¸ºç©º\rif(ismpty())\r{\rreturn;\r}\r// é“¾è¡¨åªå­˜åœ¨ä¸€ä¸ªå€¼\rif(head == tail)\r{\rdelete head;\rsetlen(ReductOne);\rhead = tail = 0;\rreturn;\r}\rint len = getlen();\rif (index \u0026gt;= len-1 || index \u0026lt; 0)\r{\rdeleteToTail();\rreturn;\r}\rif (index == 0)\r{\rdeleteToHead();\rreturn;\r}\rSinglyLinkedNode *node = head;\rSinglyLinkedNode *tmp = head-\u0026gt;next;\rint __index = 1;\rwhile (__index != index)\r{\rnode = node-\u0026gt;next;\rtmp = tmp-\u0026gt;next;\r__index ++;\r}\rnode-\u0026gt;next = tmp-\u0026gt;next;\rdelete tmp;\rsetlen(ReductOne);\r}\ræ•°æ®çš„æŸ¥è¯¢ æŸ¥è¯¢é“¾è¡¨çš„æ‰€æœ‰å€¼ void SinglyList::queryAll()\r{\rif (ismpty()){\rcout \u0026lt;\u0026lt; \u0026quot;The list length is empty\u0026quot; \u0026lt;\u0026lt; endl;\rreturn;\r}\rint i = 1;\rcout \u0026lt;\u0026lt; \u0026quot;The length of the list is zero:\u0026quot; \u0026lt;\u0026lt; getlen() \u0026lt;\u0026lt; endl;\rSinglyLinkedNode *node;\rfor(node = head; node != tail-\u0026gt;next; node = node-\u0026gt;next){\rcout \u0026lt;\u0026lt; \u0026quot;node num is:\u0026quot; \u0026lt;\u0026lt; i \u0026lt;\u0026lt; \u0026quot; data:\u0026quot; \u0026lt;\u0026lt; node-\u0026gt;data \u0026lt;\u0026lt; endl;\ri++;\r}\r}\rè¿”å›indexçš„å€¼ int SinglyList::queryIndex(int index)\r{\rint len = getlen();\r// é“¾è¡¨ä¸ºç©º, ç´¢å¼•ä¸å­˜åœ¨\rif(ismpty() || index \u0026gt; len -1 || index \u0026lt; 0)\r{\rreturn -1;\r}\rif (index == 0)\r{\rreturn head -\u0026gt;data;\r}\rif (index == len -1)\r{\rreturn tail -\u0026gt;data;\r}\rint __index = 1;\rfor (SinglyLinkedNode *node = head-\u0026gt;next; node != tail; node = node-\u0026gt;next)\r{\rif (index == __index)\r{\rreturn node-\u0026gt;data;\r}\r__index ++; }\rreturn -1;\r}\råˆ¤æ–­valueæ˜¯å¦å­˜åœ¨ bool SinglyList::queryValue(int value)\r{\r// é“¾è¡¨ä¸ºç©º\rif(ismpty())\r{\rreturn false;\r}\r// é“¾è¡¨åªå­˜åœ¨ä¸€ä¸ªå€¼\rif(head == tail)\r{\rif (head-\u0026gt;data == value){\rreturn true;\r}\rreturn false;\r}\rfor(SinglyLinkedNode *node = head; node != tail-\u0026gt;next; node = node-\u0026gt;next)\r{\rif(node-\u0026gt;data == value)\r{\rreturn true;\r}\r}\rreturn false;\r}\ræµ‹è¯• int main()\r{\rSinglyList newList;\rnewList.inseartTotail(1);\rnewList.inseartTotail(2);\rnewList.inseartTotail(3);\rnewList.inseartToHead(0);\rnewList.inseartToHead(-11);\rnewList.inseartToHead(-12);\rnewList.inseartToHead(-13);\rnewList.inseartToindex(6,5);\rnewList.inseartToindex(-7,51);\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToHead();\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToTail();\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToTail();\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rnewList.deleteToIndex(3);\rnewList.queryAll();\rcout \u0026lt;\u0026lt; \u0026quot;************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; newList.queryIndex(5) \u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; \u0026quot;************************************************\u0026quot;\u0026lt;\u0026lt; endl;\rcout \u0026lt;\u0026lt; newList.queryValue(21) \u0026lt;\u0026lt; endl;\rsystem(\u0026quot;pause\u0026quot;);\rreturn 0;\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForC/tree/master/linked_list/singly_linked_list  ","date":"2021-12-27T22:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8c-%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0/1_huda65db0749ea5cfbe7a2aa726c042ca1_14970_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8c-%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-å•å‘é“¾è¡¨c++è¯­è¨€å®ç°"},{"content":"å•å‘é“¾è¡¨ æ•°æ®ç»“æ„çš„å®šä¹‰ å•é¡¹é“¾è¡¨èŠ‚ç‚¹çš„å®šä¹‰\rtype singlyLinkedNode struct {\rinfo interface{} // å­˜å‚¨ä»»æ„æ•°æ®\rnext *singlyLinkedNode // æŒ‡å‘ä¸‹ä¸€èŠ‚ç‚¹\r}\rtype linkedList struct {\rlen int // é“¾è¡¨é•¿åº¦\rHead *singlyLinkedNode // å¤´èŠ‚ç‚¹\rTail *singlyLinkedNode // å°¾èŠ‚ç‚¹\r}\råˆ›å»ºèŠ‚ç‚¹ func createNode(info interface{}) *singlyLinkedNode {\rnode := \u0026amp;singlyLinkedNode{\rinfo: info,\rnext: nil,\r}\rreturn node\r}\ré“¾è¡¨çš„é•¿åº¦ func(l *linkedList)Len() int{\rreturn l.len\r}\ræ•°æ®çš„æ’å…¥ å•ä¸ªèŠ‚ç‚¹çš„æ’å…¥ // é“¾è¡¨çš„å°¾æ’æ³•\rfunc (l *linkedList)AddToTail(info interface{}) *linkedList {\rnewNode := createNode(info) // åˆ›å»ºæ–°èŠ‚ç‚¹\r// é“¾è¡¨ä¸ºç©º, å¤´å°¾èŠ‚ç‚¹éƒ½æŒ‡å‘è¯¥èŠ‚ç‚¹\rif l.Tail == nil{\rl.Head = newNode\rl.Tail = newNode\r}\rl.Tail.next = newNode\rl.Tail = l.Tail.next\r// é“¾è¡¨é•¿åº¦+1\rl.len++\rreturn l\r}\r// é“¾è¡¨çš„å¤´æ’æ³•\rfunc (l *linkedList)AddToHead(info interface{}) *linkedList {\rnewNode := createNode(info) // åˆ›å»ºèŠ‚ç‚¹\r// é“¾è¡¨ä¸ºç©º\rif l.Head == nil{\rl.Head = newNode\rl.Tail = newNode\r}\rnewNode.next = l.Head\rl.Head = newNode\r// é“¾è¡¨é•¿åº¦+1\rl.len++\rreturn l\r}\r// é“¾è¡¨çš„index\r// é€šè¿‡index=\u0026gt;æ’å…¥é“¾è¡¨æ–°çš„èŠ‚ç‚¹\r// indexä¸ºæ­£æ•° ä¸ºä»å·¦-\u0026gt;å³ // 0è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\r// indexä¸ºè´Ÿæ•° ä¸ºä»å³-\u0026gt;å·¦ // -1è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\rfunc (l *linkedList)AddToIndex(index int, info interface{}) *linkedList {\r// å½“é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œé‡‡ç”¨äº†å°¾æ’å…¥æ³•æ’å…¥æ•°æ®\rif l.Head == nil{\rreturn l.AddToTail(info)\r}\r// å½“indexå¤§äºé“¾è¡¨çš„å€¼æ—¶ï¼Œé»˜è®¤å°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨çš„åé¢\rif int(math.Abs(float64(index))) \u0026gt; l.len-1{\rreturn l.AddToTail(info)\r}\r// æ’å…¥é“¾è¡¨çš„å¤´éƒ¨\rif index == 0{\rreturn l.AddToHead(info)\r}\r// æ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾\rif index == -1{\rreturn l.AddToTail(info)\r}\r// å½“index ä¸ºè´Ÿæ•°æ—¶ï¼Œä»å³åˆ°å·¦æ’å…¥\rif index \u0026lt; 0{\rindex += l.len\r}\r__index := 1 // å†…éƒ¨çš„indexå€¼\r// ä»ç¬¬äºŒä¸ªå€¼å¼€å§‹æ’å…¥\rfor node := l.Head.next; node != l.Tail; node = node.next{\rif index == __index{\rnewNode := createNode(info)\rnewNode.next = node.next // æŒ‡å‘nodeçš„åç»§èŠ‚ç‚¹\rnode.next = newNode // node æŒ‡å‘è¿™ä¸ªæ–°çš„èŠ‚ç‚¹\r// é“¾è¡¨çš„èŠ‚ç‚¹æ•°åŠ 1\rl.len ++\rreturn l\r}\r__index ++\r}\rreturn l\r}\ré“¾è¡¨çš„åˆå¹¶ // å°†æ–°çš„é“¾è¡¨æ’å…¥å¤´éƒ¨\rfunc (l *linkedList)AddListToHead(list *linkedList)*linkedList{\r// ä¸¤ä¸ªé“¾è¡¨éƒ½ä¸ºç©ºæ—¶\rif l.Head == nil \u0026amp;\u0026amp; list.Head == nil{\rreturn l\r}\r// åˆå¹¶è¡¨ä¸ºç©º\rif l.Head != nil \u0026amp;\u0026amp; list.Head == nil{\rreturn l\r}\r// ä¸»è¡¨ä¸ºç©º\rif l.Head == nil \u0026amp;\u0026amp; list.Head != nil{\rreturn list\r}\r// åˆå¹¶è¡¨çš„å°¾æŒ‡é’ˆæŒ‡å‘ä¸»è¡¨çš„å¤´\rlist.Tail.next = l.Head\rlist.Tail = l.Tail\r// è¡¨èŠ‚ç‚¹æ•°åˆå¹¶\rlist.len += l.len\rreturn list\r}\r// å°†æ–°çš„é“¾è¡¨æ’å…¥åˆ°å°¾éƒ¨\rfunc (l *linkedList)AddListToTail(list *linkedList)*linkedList{\r// ä¸¤ä¸ªé“¾è¡¨éƒ½ä¸ºç©ºæ—¶\rif l.Head == nil \u0026amp;\u0026amp; list.Head == nil{\rreturn l\r}\r// åˆå¹¶è¡¨ä¸ºç©º\rif l.Head != nil \u0026amp;\u0026amp; list.Head == nil{\rreturn l\r}\r// ä¸»è¡¨ä¸ºç©º\rif l.Head == nil \u0026amp;\u0026amp; list.Head != nil{\rreturn list\r}\r// å°†æ–°è¡¨æ’å…¥åˆ°ä¸»è¡¨ä¹‹å\rl.Tail.next = list.Head\rl.Tail = list.Tail\rl.len += list.len\rreturn l\r}\r// ç»æ–°çš„è¡¨æ’å…¥åˆ°index\rfunc (l *linkedList)AddListToIndex(index int, list *linkedList) *linkedList {\r// ä¸¤ä¸ªé“¾è¡¨éƒ½ä¸ºç©ºæ—¶\rif l.Head == nil \u0026amp;\u0026amp; list.Head == nil{\rreturn l\r}\r// åˆå¹¶è¡¨ä¸ºç©º\rif l.Head != nil \u0026amp;\u0026amp; list.Head == nil{\rreturn l\r}\r// ä¸»è¡¨ä¸ºç©º\rif l.Head == nil \u0026amp;\u0026amp; list.Head != nil{\rreturn list\r}\rif int(math.Abs(float64(index))) \u0026gt; l.len{\rfmt.Println(\u0026quot;é”™è¯¯çš„index\u0026quot;)\rreturn l\r}\rif index == 0{\rreturn l.AddListToHead(list)\r}\rif int(math.Abs(float64(index))) == l.len -1 || index == -1{\rreturn l.AddListToTail(list)\r}\rif index \u0026lt; 0{\rindex += l.len\r}\r__index := 1\rfor node := l.Head.next; node != l.Tail; node = node.next{\rif index == __index{\rlist.Tail.next = node.next\rnode.next = list.Head\rl.len += list.len // é“¾è¡¨çš„æ•°å€¼ç›¸åŠ \rreturn l\r}\r__index ++\r}\rreturn l\r}\ræ•°æ®çš„åˆ é™¤ // é“¾è¡¨å¤´åˆ é™¤æ³•\rfunc (l *linkedList)DeleteToHead()*linkedList{\r// é“¾è¡¨ä¸ºç©º\rif l.Head == nil{\rreturn l\r}\r// é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªæ•°\rif l.Head == l.Tail{\rl.Head = nil\rl.Tail = nil\rl.len = 0\rreturn l\r}\rl.Head = l.Head.next\r// nodeæ•°å‡ä¸€\rl.len --\rreturn l\r}\r// é“¾è¡¨å°¾åˆ é™¤æ³•\rfunc (l *linkedList)DeleteToTail()*linkedList{\r// é“¾è¡¨ä¸ºç©º\rif l.Tail == nil{\rreturn l\r}\r// é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ªæ•°\rif l.Head == l.Tail{\rl.Head = nil\rl.Tail = nil\rl.len = 0\rreturn l\r}\r// æ‰¾å‡ºå°¾èŠ‚ç‚¹çš„ä¸Šä¸€èŠ‚ç‚¹\rvar node *singlyLinkedNode\rfor node = l.Head; node.next != l.Tail; node = node.next{}\rnode.next = nil\rl.Tail = node\r// nodeæ•°å‡ä¸€\rl.len --\rreturn l\r}\r// é€šè¿‡å€¼=\u0026gt;åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹(ç¬¬ä¸€ä¸ª)\rfunc (l *linkedList)DeleteToAValue(value interface{})*linkedList{\r// é“¾è¡¨ä¸ºç©º\rif l.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨ä¸ºç©º\u0026quot;)\rreturn l\r}\r// value == head.info\r// å°±é‡‡ç”¨å¤´åˆ æ³•\rif value == l.Head.info{\rreturn l.DeleteToHead()\r}\r// ä¸­é—´é‡‡ç”¨è½®è¯¢æŸ¥æ‰¾value, ä»ç¬¬äºŒä¸ªå¼€å§‹è½®è¯¢åˆ°å€’æ•°ç¬¬äºŒä¸ªç»“æŸ\rnode := l.Head\rfor temp := l.Head.next; temp != nil; temp = node.next{\rif temp.info == value{\r// åˆ é™¤node\rnode.next = temp.next\rl.len --\rreturn l\r}\rnode = node.next\r}\rfmt.Println(\u0026quot;é“¾è¡¨ä¸­ï¼šå€¼ä¸å­˜åœ¨\u0026quot;)\rreturn l\r}\r// é€šè¿‡å€¼=\u0026gt;åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹(æ‰€æœ‰)\rfunc (l *linkedList)DeleteToValue(value interface{})*linkedList{\r// é“¾è¡¨ä¸ºç©º\rif l.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨ä¸ºç©º\u0026quot;)\rreturn l\r}\rnode := l.Head // å½“å‰çš„node\rtemp := l.Head.next // ä¸‹ä¸€ä¸ªnode\rfor {\r// å½“ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶ï¼Œå°±åˆ¤æ–­é¦–ä½å’Œæœ«å°¾æ˜¯ä¸ºéœ€è¦åˆ é™¤çš„node\rif temp == l.Tail {\rif l.Head.info == value{\rl.DeleteToHead()\r}\rif l.Tail.info == value{\rl.DeleteToTail()\r}\rreturn l\r}\rif temp.info == value{\r// åˆ é™¤node\rnode.next = temp.next\rtemp = temp.next\r// nodeæ•°å‡ä¸€\rl.len --\rcontinue\r}\rnode = node.next\rtemp = temp.next\r}\r}\r// é€šè¿‡index=\u0026gt;åˆ é™¤é“¾è¡¨çš„èŠ‚ç‚¹\r// indexä¸ºæ­£æ•° ä¸ºä»å·¦-\u0026gt;å³ // 0è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\r// indexä¸ºè´Ÿæ•° ä¸ºä»å³-\u0026gt;å·¦ // -1è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹\rfunc (l *linkedList)DeleteToIndex(index int)*linkedList{\r// é“¾è¡¨ä¸ºç©º\rif l.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨ä¸ºç©º\u0026quot;)\rreturn l\r}\r// index è¶…è¿‡é“¾è¡¨æ•°\rif int(math.Abs(float64(index))) \u0026gt; l.len-1{\rfmt.Println(\u0026quot;é”™è¯¯çš„index\u0026quot;)\rreturn l\r}\r// åˆ é™¤ç¬¬ä¸€ä¸ªnode\rif index == 0{\rreturn l.DeleteToHead()\r}\rif index \u0026lt; 0{\rindex += l.len\r}\r_index := 1\rnode := l.Head\rtemp := node.next\rfor {\rif index == _index{\rif temp != nil{\rnode.next = temp.next\r}\rl.len --\rreturn l\r}\rnode = node.next\rtemp = temp.next\r_index ++\r}\r}\ræ•°æ®çš„æŸ¥è¯¢ // éå†é“¾è¡¨\rfunc (l *linkedList) QuireAll() {\rif l.Head == nil{\rfmt.Println(\u0026quot;é“¾è¡¨æ•°æ®ä¸ºç©º\u0026quot;)\rreturn\r}\rnode := l.Head\rfor {\rif node == nil{\rreturn\r}\rfmt.Println(node.info)\rif node == l.Tail{\rreturn\r}\rnode = node.next\r}\r}\r// åˆ¤æ–­valveæ˜¯å¦å­˜åœ¨\rfunc (l *linkedList)QuireValue(value interface{}) bool{\r// è¡¨ä¸ºç©º\rif l.Head == nil{\rreturn false\r}\r// è¡¨ä¸­åªå­˜åœ¨ä¸€ä¸ªå€¼\rif l.Head == l.Tail{\rif l.Head.info == value{\rreturn true\r}\rreturn false\r}\r// éå†æŸ¥å€¼\rfor node := l.Head; node != l.Tail.next; node = node.next{\rif node.info == value{\rreturn true\r}\r}\rreturn false\r}\r// æ ¹æ®ç´¢å¼•è¿”å›å€¼\rfunc (l *linkedList)QuireIndex(index int) interface{} {\r// é“¾è¡¨ä¸ºç©º\rif l.Head == nil{\rreturn nil\r}\rif int(math.Abs(float64(index))) \u0026gt; l.len -1 {\rfmt.Println(\u0026quot;ç´¢å¼•å€¼é”™è¯¯\u0026quot;)\rreturn nil\r}\rif index == 0{\rreturn l.Head.info\r}\rif index == l.len -1 || index == -1{\rreturn l.Tail.info\r}\rif index \u0026lt; 0{\rindex += l.len\r}\r__index := 1\rfor node := l.Head.next; node != l.Tail; node = node.next{\rif __index == index{\rreturn node.info\r}\r__index ++\r}\r//fmt.Println(\u0026quot;æœªèƒ½æ‰¾åˆ°ï¼ï¼ï¼ï¼\u0026quot;)\rreturn nil\r}\rç»“æ„çš„å…¥å£ func NewLinkerList()*linkedList{\r// åˆ›å»ºçš„é“¾è¡¨å¤´å°¾èŠ‚ç‚¹éƒ½ä¸ºç©º\rreturn \u0026amp;linkedList{\rHead: nil,\rTail: nil,\rlen: 0,\r}\r}\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/DataStructuresAlgorithmsForGo/tree/master/Linked_list/Singly_linked_list  ","date":"2021-12-25T22:00:08+08:00","image":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0/1_huda65db0749ea5cfbe7a2aa726c042ca1_14970_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0/","title":"æ•°æ®ç»“æ„-å•å‘é“¾è¡¨goè¯­è¨€å®ç°"},{"content":"host_try  host_tryï¼šä¸»è¦æ˜¯ç›®çš„æ˜¯åœ¨å•ä¸ªæˆ–è€…å¤šä¸ªhostçš„ä¸‹ï¼Œè¿æ¥è¶…æ—¶æˆ–è€…è¿æ¥å¤±è´¥ä¸‹çš„é‡è¯•æœºåˆ¶ host_try: æä¾›ä¸‰ç§é€€é¿ç­–ç•¥ï¼š1. å°è¯•ç­‰å¾…æ—¶é—´æŒ‡æ•°å¢é•¿ 2. ä»¥ç›¸åŒæ—¶é—´è¿›è¡Œå°è¯• 3.éšæœºæ—¶é—´è¿›è¡Œå°è¯• ä¸‰ç§å°è¯•ç­–ç•¥å¯ä¸€èµ·ä½¿ç”¨ host_try: æä¾›ä¸‰ç§é‡è¯•æ–¹å¼ï¼š1. è½®è¯¢hostè¿›è¡Œé‡è¿, é‡è¿æ¬¡æ•°è¾¾åˆ°å,åœ¨å°†æ¢ä¸‹ä¸€host, ç›´åˆ°é‡æ–°è¿æ¥æˆåŠŸæˆ–æ‰€æœ‰çš„hostéƒ½é‡è¿å®Œæˆç»“æŸ 2.æ¯ä¸€ä¸ªhostè¿›è¡Œé‡è¿, åœ¨å°†æ¢ä¸‹ä¸€host, æ‰€æœ‰çš„hostå¤±è´¥äº†,åœ¨è¿›è¡Œä¸‹ä¸€æ¬¡é‡è¿ã€‚ç›´åˆ°é‡æ–°è¿æ¥æˆåŠŸæˆ–é‡è¿æ¬¡æ•°è¾¾åˆ°åç»“æŸ 3. é‡è¯•ç›´åˆ°æˆåŠŸ host_try åªæ˜¯æä¾›é‡è¯•è¿æ¥çš„æ¥å£ï¼Œå…·ä½“è¯·æ±‚çš„æ–¹æ³•éœ€è¦è‡ªå·±å†™  host_tryçš„å·¥ä½œåŸç†  å­˜åœ¨å¤šä¸ªhostçš„è¯·æ±‚æä¾›ç›¸åŒçš„æœåŠ¡å¦‚(ntp)ï¼Œå­˜åœ¨è¿æ¥è¶…æ—¶çš„æƒ…å†µï¼Œéœ€è¦ä¸æ–­çš„å°è¯•è¿æ¥ï¼Œ åªè¦ä¸€ä¸ªhostè¿æ¥è¯·æ±‚æˆåŠŸå°±è¿”å›  host_tryçš„é…ç½®ç»“æ„ type tryConfig struct {\rattemptNum uint // å°è¯•çš„é‡è¿çš„æ¬¡æ•°\rnowAttempt uint // ç°åœ¨ç¬¬å‡ æ¬¡é‡è¿\rhosts []string // è¿æ¥çš„hostç»„\rsuccessHost string // è¿æ¥æˆåŠŸçš„host\rerrorHost map[string]string // è¿æ¥å¤±è´¥çš„hostå’Œé”™è¯¯åŸå› \rattemptType string // é‡è¿æ–¹å¼\rattemptStatus bool // æœ€ç»ˆé‡è¿çš„çŠ¶æ€\rdelay time.Duration // å»¶æ—¶æ—¶é—´\rmaxDelay time.Duration // æœ€å¤§å»¶æ—¶æ—¶é—´\rmaxJitter time.Duration // æœ€å¤§éšæœºæ•°æ—¶é—´\rdelayType []uint // é€€é¿ç­–ç•¥ç±»å‹\rcontest context.Context\r}\ræä¾›ä¸‰ç§é€€é¿ç­–ç•¥ ç¬¬ä¸€ç§ç­–ç•¥  å»¶æ—¶æ—¶é—´* å› å­**é‡è¿æ¬¡æ•°(å› å­é»˜è®¤ä¸º2) func (t *tryConfig)backOffDelay(n uint) time.Duration  ç¬¬äºŒç§ç­–ç•¥  ä»¥ç›¸åŒçš„æ—¶é—´è¿›è¡Œå»¶æ—¶  func (t *tryConfig)fixedDelay() time.Duration  ç¬¬ä¸‰ç§ç­–ç•¥  éšæœºå»¶è¿Ÿæ—¶é—´  func (t *tryConfig)randomDelay() time.Duration  é‡è¯•æ–¹å¼ æ–¹å¼1  è½®è¯¢hostè¿›è¡Œé‡è¿, é‡è¿æ¬¡æ•°è¾¾åˆ°å,åœ¨å°†æ¢ä¸‹ä¸€host, ç›´åˆ°é‡æ–°è¿æ¥æˆåŠŸæˆ–æ‰€æœ‰çš„hostéƒ½é‡è¿å®Œæˆç»“æŸ func (t *tryConfig) directConnection (retryableFunc RetryableFunc)  æ–¹å¼2  æ¯ä¸€ä¸ªhostè¿›è¡Œé‡è¿, åœ¨å°†æ¢ä¸‹ä¸€host, æ‰€æœ‰çš„hostå¤±è´¥äº†,åœ¨è¿›è¡Œä¸‹ä¸€æ¬¡é‡è¿ã€‚ç›´åˆ°é‡æ–°è¿æ¥æˆåŠŸæˆ–é‡è¿æ¬¡æ•°è¾¾åˆ°åç»“æŸ  func (t *tryConfig) staggeredConnection (retryableFunc RetryableFunc)  æ–¹å¼3  é‡è¯•ç›´åˆ°æˆåŠŸ func (t *tryConfig) untilConnection (retryableFunc RetryableFunc)  ä½¿ç”¨ host := []string{\u0026quot;172.16.21.1\u0026quot;,\u0026quot;ntp.ntsc1.ac.cn\u0026quot;,\u0026quot;cn.ntp1.org.cn\u0026quot;,\u0026quot;cn.pool.ntp1.org\u0026quot;,\u0026quot;time.pool.aliyun1.com\u0026quot;, \u0026quot;172.16.2.1\u0026quot;}\rdemo := New(host, AttemptType(\u0026quot;directConnection\u0026quot;))\rdemo.DoTry(SetNtpTime)\r é‡è¿çš„å…¥å£ï¼Œå½“è½®è¯¢æ—¶é—´ä¸º0æ—¶ï¼Œä½¿ç”¨æ–¹å¼3ï¼Œé»˜è®¤ä¸ºï¼šæ–¹å¼2  // å°è¯•çš„é‡è¿çš„æ¬¡æ•°é»˜è®¤ä¸ºï¼š5æ¬¡\r// é‡è¿æ–¹å¼é»˜è®¤ä¸ºï¼šæ–¹å¼2\r// å»¶æ—¶æ—¶é—´é»˜è®¤ä¸ºï¼š10*time.Minute\r// æœ€å¤§å»¶æ—¶æ—¶é—´é»˜è®¤ä¸ºï¼š100*time.Minute\r// æœ€å¤§éšæœºæ•°æ—¶é—´é»˜è®¤ä¸ºï¼š100*time.Minute\r// é€€é¿ç­–ç•¥ç±»å‹é»˜è®¤ä¸ºï¼šç­–ç•¥1\rfunc New(hots []string, opts ...Option) *tryConfig\rfunc (t *tryConfig) DoTry(retryableFunc RetryableFunc)\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/host_try  ","date":"2021-12-20T22:00:08+08:00","image":"https://zcj-git520.github.io/p/%E8%B6%85%E6%97%B6%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6-host_try/1_huc278944164dd3ada59be56854851c305_117502_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E8%B6%85%E6%97%B6%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6-host_try/","title":"è¶…æ—¶é‡è¯•æœºåˆ¶-host_try"},{"content":"timerTask å®šæ—¶ä»»åŠ¡ï¼šå¯ä»¥å®šæ—¶æ‰§è¡Œå•ä¸ªæˆ–è€…å¯¹ä¸ªä»»åŠ¡ï¼š\n å®šæ—¶å®šæ—¶ä»»åŠ¡ åœæ­¢å®šæ—¶ä»»åŠ¡ é‡ç½®å®šæ—¶æ—¶é—´ï¼Œå¹¶æ‰§è¡Œå®šæ—¶ä»»åŠ¡ å®šæ—¶å¼€å¯å®šæ—¶ä»»åŠ¡ å®šæ—¶ç»“æŸå®šæ—¶ä»»åŠ¡  timerTaskç»“æ„ type timerConfig struct {\rtiming time.Duration // å®šæ—¶æ—¶é—´\rstartTiming time.Duration // å®šæ—¶å¼€å¯å®šæ—¶ä»»åŠ¡æ—¶é—´\rstopTiming time.Duration // å®šæ—¶åœæ­¢å®šæ—¶ä»»åŠ¡æ—¶é—´\rrunning bool // å®šæ—¶å™¨è¿è¡Œçš„çŠ¶æ€,è¿ä½œä¸­ä¸ºtrue/æ²¡æœ‰è¿è¡Œä¸ºfalse\rtasks []func() // å®šæ—¶ä»»åŠ¡\rstopChan chan struct{} // åœæ­¢å®šæ—¶å™¨æ—¥ä»»åŠ¡\rrunningMu sync.Mutex\rWaiter sync.WaitGroup\r}\rå®šæ—¶ä»»åŠ¡çš„å¼€å§‹å’Œç»“æŸ å‡½æ•°åŸå‹ï¼šNewTimerTask(d time.Duration, tasks []func(), opts ... Option) *timerConfig\rå‚æ•°ä¸ºï¼šç»Ÿä¸€çš„å®šæ—¶ä»»åŠ¡æ—¶é—´,å®šæ—¶ä»»åŠ¡é›†, å¯é€‰å‚æ•°ã€å®šæ—¶å¼€å¯å®šæ—¶ä»»åŠ¡æ—¶é—´(SetTimerStart(d time.Duration)), å®šæ—¶åœæ­¢å®šæ—¶ä»»åŠ¡æ—¶é—´(SetTimerStop(d time.Duration))ã€‘\rStart()å¼€å§‹å®šæ—¶ä»»åŠ¡, Stop()ç»“æŸå®šæ—¶ä»»åŠ¡ ä½¿ç”¨\nt1 := 1 * time.Second\rtasks := []func(){printTest1, printTest2, printTest3, printTest4, printTest5}\rtimer := NewTimerTask(t1, tasks)\rtimer.Waiter.Add(2)\rtimer.start()\rgo func() {\rselect {\rcase \u0026lt;-time.After(5*time.Second):\rtimer.stop()\rtimer.Waiter.Done()\rreturn\r}\r}()\rtimer.Waiter.Wait()\ré‡ç½®å®šæ—¶æ—¶é—´ä»»åŠ¡ å‡½æ•°åŸå‹ï¼šReset(d time.Duration) // é‡ç½®å®šæ—¶çš„æ—¶é—´\rä½¿ç”¨ï¼š\n\tt1 := 1 * time.Second\rtasks := []func(){printTest1, printTest2, printTest3, printTest4, printTest5}\rtimer := NewTimerTask(t1, tasks)\rtimer.Waiter.Add(3)\rtimer.start()\rgo func() {\rselect {\rcase \u0026lt;-time.After(10*time.Second):\rtimer.stop()\rtimer.Waiter.Done()\rreturn\r}\r}()\rgo func() {\rselect {\rcase \u0026lt;-time.After(5*time.Second):\rtimer.Reset(2*time.Second)\rtimer.Waiter.Done()\rreturn\r}\r}()\rtimer.Waiter.Wait()\rå®šæ—¶å¼€å§‹å®šæ—¶ä»»åŠ¡ å‡½æ•°åŸå‹ï¼šTimerStart() ,éœ€è¦åœ¨åˆå§‹åŒ–æ—¶,è®¾å®šå®šæ—¶å¼€å§‹å®šæ—¶ä»»åŠ¡çš„æ—¶é—´\rä½¿ç”¨ï¼š\n\tt1 := 1 * time.Second\rts := time.Now()\rtasks := []func(){printTest1, printTest2, printTest3, printTest4, printTest5}\rtimer := NewTimerTask(t1, tasks, SetTimerStart(3*time.Second))\rtimer.TimerStart()\rt.Logf(\u0026quot;å®šæ—¶æ—¶é—´ä¸ºï¼š%v\u0026quot;, time.Now().Sub(ts))\rtimer.Waiter.Add(2)\rtimer.start()\rgo func() {\rselect {\rcase \u0026lt;-time.After(5*time.Second):\rtimer.stop()\rtimer.Waiter.Done()\rreturn\r}\r}()\rtimer.Waiter.Wait()\rå®šæ—¶ç»“æŸå®šæ—¶ä»»åŠ¡ å‡½æ•°åŸå‹ï¼šTimerStop(),è®¾å®šå®šæ—¶ç»“æŸå®šæ—¶ä»»åŠ¡çš„æ—¶é—´\r ä½¿ç”¨ï¼š  t1 := 1 * time.Second\rtasks := []func(){printTest1, printTest2, printTest3, printTest4, printTest5}\rtimer := NewTimerTask(t1, tasks, SetTimerStop(3*time.Second))\rtimer.Waiter.Add(1)\rtimer.start()\rtime.Sleep(1*time.Second)\rts := time.Now()\rtimer.TimerStop()\rt.Logf(\u0026quot;å®šæ—¶æ—¶é—´ä¸ºï¼š%v\u0026quot;, time.Now().Sub(ts))\rtimer.Waiter.Wait()\ræºç   æˆ‘çš„github:https://github.com/zcj-git520/timerTask  ","date":"2021-12-15T22:00:08+08:00","image":"https://zcj-git520.github.io/p/timertask-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8C%85/1_hu8e77554b4f75574526b9eba572e1dcc7_37690_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/timertask-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8C%85/","title":"timerTask å®šæ—¶ä»»åŠ¡åŒ…"},{"content":"å¸¸è§çš„IOç±»å‹ åŒæ­¥é˜»å¡IO  ç”¨æˆ·çº¿ç¨‹é€šè¿‡è°ƒç”¨ç³»ç»Ÿå‘½ä»¤å‘èµ·ioæ“ä½œï¼Œç”±ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ç©ºé—´ï¼Œå†…æ ¸æ€ä¸€ç›´åœ¨ç­‰å¾…ï¼Œ ç›´åˆ°è·å–åˆ°æ•°æ®æ—¶ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ç©ºé—´ï¼Œç”¨æˆ·çº¿ç¨‹åœ¨è·å–æ•°æ®ã€‚æ•´ä¸ªè¿‡ç¨‹ç”¨æˆ·çº¿ç¨‹ å¤„äºé˜»å¡çš„çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ•°æ®ä¸ºæ­¢ã€‚  åŒæ­¥éé˜»å¡IO  åœ¨åŒæ­¥é˜»å¡ioçš„åŸºç¡€ä¸Šï¼Œç”¨æˆ·çº¿ç¨‹å‘èµ·ioæ“ä½œåï¼Œå°±ç«‹åˆ»è¿”å›ã€‚ç”±äºæ˜¯éé˜»å¡çš„æ–¹å¼ï¼Œå°±å­˜åœ¨è¿”å›æ—¶ æ²¡æœ‰æ•°æ®ï¼Œå°±éœ€è¦ä¸æ–­çš„è½®è¯¢å‘èµ·ioè¯·æ±‚ï¼Œç›´åˆ°æ¥æ”¶åˆ°æ•°æ®ä¸ºæ­¢ã€‚  IOå¤šè·¯å¤ç”¨  ioå¤šè·¯å¤ç”¨æ˜¯ä¸€ç§åŒæ­¥çš„ioæ¨¡å‹ã€‚å®ç°åœ¨å†…æ ¸æ€ä¸­ä¸€ä¸ªçº¿ç¨‹ç›‘è§†å¤šä¸ªio(æ–‡ä»¶å¥æŸ„)ï¼Œä¸€æ—¦æŸä¸ªioå°±ç»ªåï¼Œ å°±é€šçŸ¥ç”¨æˆ·çº¿ç¨‹è¿›è¡Œç›¸å…³çš„æ“ä½œã€‚æ²¡æœ‰ioå°±ç»ªæ—¶å°±é˜»å¡ç”¨æˆ·çº¿ç¨‹ï¼Œå°†äº¤å‡ºcpuã€‚å¤šè·¯æ˜¯æŒ‡ç½‘ç»œè¿æ¥ï¼Œå¤ç”¨æ˜¯æŒ‡ ç”¨ä¸€ä¸ªçº¿ç¨‹ã€‚  ä¿¡å·é©±åŠ¨IO  ç”¨æˆ·çº¿ç¨‹å‘èµ·ä¸€ä¸ªioæ“ä½œåï¼Œä¼šå‘å†…æ ¸æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œç„¶åè¿”å›ï¼Œå½“å†…æ ¸ä¸­æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘é€ä¸€ä¸ª ä¿¡å·ç»™ç”¨æˆ·çº¿ç¨‹ï¼Œç”¨æˆ·æ€çš„çº¿ç¨‹åœ¨è°ƒç”¨ioè¯·æ±‚ï¼Œè·å–åˆ°æ•°æ®ã€‚  å¼‚æ­¥IO  ç”¨æˆ·çº¿ç¨‹å‘èµ·ioæ“ä½œåå°±è¿”å›ã€‚ç”±å†…æ ¸æ€çš„çº¿ç¨‹å¤„ç†ï¼Œå½“å†…æ ¸çº¿ç¨‹è·å–åˆ°æ•°æ®åï¼Œä¸»åŠ¨å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œ å¹¶å‘ŠçŸ¥ç”¨æˆ·çº¿ç¨‹ioæ“ä½œä¹Ÿå®Œæˆã€‚ \r  ioå¤šè·¯å¤ç”¨çš„ä¸‰ç§å®ç°æ–¹å¼ select  selectæ˜¯é‡‡ç”¨æ•°ç»„çš„å­˜å‚¨çš„ç»“æ„å­˜å‚¨io(fdæ–‡ä»¶å¥æŸ„)ï¼Œé»˜è®¤çš„æœ€å¤§çš„fdä¸º32ä½ç³»ç»Ÿ1024ï¼Œ64ä½ç³»ç»Ÿæ˜¯2048(å¯è®¾ç½®),ç”¨æˆ·çº¿ç¨‹å°†fdé›†åˆæ‹·è´åˆ° å†…æ ¸æ€å¹¶å¼€å§‹ç›‘æ§ï¼Œå½“æœ‰fdå°±ç»ªæˆ–è€…è¿‡äº†è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå°±å°†fdé›†åˆä¸­æ‰€æœ‰æœªå°±ç»ªçš„fdæ¸…ç©º(å°†bitmapç½®ä¸º0)ï¼Œå°†å°±idé›†åˆè¿”å›åˆ°ç”¨æˆ·æ€ï¼Œ ç”¨æˆ·æ€çš„çº¿ç¨‹é€šè¿‡è½®è¯¢è¿”å›çš„fdé›†åˆæ‰¾åˆ°å°±ç»ªçš„fd,è¿›è¡Œç›¸å…³çš„ioæ“ä½œè·å–æ•°æ®ã€‚å†ä¸€æ¬¡ç›‘æ§æ—¶ï¼Œéœ€è¦å°†ä¹‹å‰æ¸…ç©ºçš„fd æ·»åŠ åˆ°fdé›†åˆä¸­è¿›è¡Œæ–°ä¸€è½®çš„ç›‘æ§ã€‚  #include \u0026lt;sys/select.h\u0026gt; #include \u0026lt;sys/time.h\u0026gt; #define FD_SETSIZE 1024 #define NFDBITS (8 * sizeof(unsigned long)) #define __FDSET_LONGS (FD_SETSIZE/NFDBITS) // æ•°æ®ç»“æ„ (bitmap) typedef struct { unsigned long fds_bits[__FDSET_LONGS]; } fd_set; // API int select( int max_fd, // æœ€å¤§çš„æ–‡ä»¶æ–‡ä»¶æè¿°ç¬¦fd fd_set *readset, // è¯»æ–‡ä»¶æè¿°ç¬¦é›†åˆ fd_set *writeset, // å†™æ–‡ä»¶æè¿°ç¬¦é›†åˆ fd_set *exceptset, // å¼‚å¸¸çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆ struct timeval *timeout // è¶…æ—¶æ—¶é—´ ) // è¿”å›å€¼å°±ç»ªæè¿°ç¬¦çš„æ•°ç›® FD_ZERO(int fd, fd_set* fds) // æ¸…ç©ºé›†åˆ FD_SET(int fd, fd_set* fds) // å°†ç»™å®šçš„æè¿°ç¬¦åŠ å…¥é›†åˆ FD_ISSET(int fd, fd_set* fds) // åˆ¤æ–­æŒ‡å®šæè¿°ç¬¦æ˜¯å¦åœ¨é›†åˆä¸­ FD_CLR(int fd, fd_set* fds) // å°†ç»™å®šçš„æè¿°ç¬¦ä»æ–‡ä»¶ä¸­åˆ é™¤ //selectä½¿ç”¨ç¤ºä¾‹ int main() { /* * è¿™é‡Œè¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„è®¾ç½®ï¼Œ * åŒ…æ‹¬socketå»ºç«‹ï¼Œåœ°å€çš„è®¾ç½®ç­‰, */ fd_set read_fs, write_fs; struct timeval timeout; int max = 0; // ç”¨äºè®°å½•æœ€å¤§çš„fdï¼Œåœ¨è½®è¯¢ä¸­æ—¶åˆ»æ›´æ–°å³å¯ // åˆå§‹åŒ–æ¯”ç‰¹ä½ FD_ZERO(\u0026amp;read_fs); FD_ZERO(\u0026amp;write_fs); int nfds = 0; // è®°å½•å°±ç»ªçš„äº‹ä»¶ï¼Œå¯ä»¥å‡å°‘éå†çš„æ¬¡æ•° while (1) { // é˜»å¡è·å– // æ¯æ¬¡éœ€è¦æŠŠfdä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ nfds = select(max + 1, \u0026amp;read_fd, \u0026amp;write_fd, NULL, \u0026amp;timeout); // æ¯æ¬¡éœ€è¦éå†æ‰€æœ‰fdï¼Œåˆ¤æ–­æœ‰æ— è¯»å†™äº‹ä»¶å‘ç”Ÿ for (int i = 0; i \u0026lt;= max \u0026amp;\u0026amp; nfds; ++i) { if (i == listenfd) { --nfds; // è¿™é‡Œå¤„ç†acceptäº‹ä»¶ FD_SET(i, \u0026amp;read_fd);//å°†å®¢æˆ·ç«¯socketåŠ å…¥åˆ°é›†åˆä¸­ } if (FD_ISSET(i, \u0026amp;read_fd)) { --nfds; // è¿™é‡Œå¤„ç†readäº‹ä»¶ } if (FD_ISSET(i, \u0026amp;write_fd)) { --nfds; // è¿™é‡Œå¤„ç†writeäº‹ä»¶ } } } \r\nselectå­˜åœ¨çš„é—®é¢˜  ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆæ˜¯æœ‰ä¸Šçº¿çš„ï¼Œå³å­˜å‚¨çš„fdæœ‰æœ€å¤§å€¼ï¼Œé»˜è®¤çš„æœ€å¤§çš„fdä¸º32ä½ç³»ç»Ÿ1024ï¼Œ64ä½ç³»ç»Ÿ2048(å¯è®¾ç½®) æ¯ä¸€æ¬¡éƒ½æ˜¯éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œä¸”å†…æ ¸æ€æ˜¯é€šè¿‡è½®è¯¢çš„æ–¹å¼åˆ¤æ–­fdæ˜¯å¦å°±ç»ªï¼Œå½“æ–‡ä»¶æè¿°ç¬¦å¢å¤šæ—¶ ä¼šé€ æˆæ•´ä½“çš„æ€§èƒ½çš„ä¸‹é™ã€‚ æ–‡ä»¶æè¿°ç¬¦é›†åˆè¿”å›æ—¶ï¼Œä¼šå°†æ²¡æœ‰å°±ç»ªçš„fdåˆ é™¤(å°†bitmapç½®ä¸º0)ï¼Œå½“ç»§ç»­ç›‘æ§æ—¶ï¼Œä¼šå°†åˆ é™¤çš„fdæ·»åŠ åˆ°é›†åˆä¸­ è¿”å›åˆ°ç”¨æˆ·æ€çš„é›†åˆï¼Œå¹¶æœªæ˜ç¡®å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»ç„¶éœ€è¦è½®è¯¢åˆ¤æ–­  poll  poll æ˜¯é‡‡ç”¨é“¾è¡¨æ¥å­˜å‚¨fd,æ²¡æœ‰äº†æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ã€‚ç”¨æˆ·æœªæ¯ä¸€ä¸ªfdå®šä¹‰ä¸€ä¸ªäº‹ä»¶ç»“æ„ä½“ï¼Œç„¶åå°†äº‹ä»¶ç»“æ„ä½“çš„é“¾è¡¨æ‹·è´åˆ°å†…æ ¸ä¸­ï¼Œ å†…æ ¸çº¿ç¨‹è¿›è¡Œè½®è¯¢éå†è¿›è¡Œåˆ¤æ–­fdæ˜¯å¦å°±ç»ªã€‚å½“æœ‰fdå°±ç»ªå°±å°†å°±ç»ªäº‹ä»¶æ”¾å…¥reventsä¸­ï¼Œç„¶åè¿”å›ï¼Œç”¨æˆ·æ€éå†äº‹ä»¶é“¾è¡¨å¯¹äº‹ä»¶ç»“æ„ä½“çš„revents è¿›è¡Œåˆ¤æ–­å°±ç»ªçš„fdï¼Œè¿›è¡Œç›¸å…³çš„ioæ“ä½œè·å–æ•°æ®ã€‚  #include \u0026lt;poll.h\u0026gt; // æ•°æ®ç»“æ„ struct pollfd { int fd; // éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ short events; // éœ€è¦å†…æ ¸ç›‘è§†çš„äº‹ä»¶ï¼ˆè¯»å†™ï¼‰ short revents; // å®é™…å‘ç”Ÿçš„äº‹ä»¶ }; // // API int poll(struct pollfd fds[], nfds_t nfds, int timeout); // fdçš„é›†åˆï¼Œ ä¸ªæ•°ï¼Œè¶…æ—¶æ—¶é—´ // // å…ˆå®å®šä¹‰é•¿åº¦ #define MAX_POLLFD_LEN 4096 int main() { /* * åœ¨è¿™é‡Œè¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œ * æ¯”å¦‚åˆå§‹åŒ–æ•°æ®å’Œsocketç­‰ã€‚ */ int nfds = 0; pollfd fds[MAX_POLLFD_LEN]; memset(fds, 0, sizeof(fds)); fds[0].fd = listenfd; fds[0].events = POLLRDNORM; int max = 0; // é˜Ÿåˆ—çš„å®é™…é•¿åº¦ï¼Œæ˜¯ä¸€ä¸ªéšæ—¶æ›´æ–°çš„ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å…¶ä»–çš„ int timeout = 0; int current_size = max; while (1) { // é˜»å¡è·å– // æ¯æ¬¡éœ€è¦æŠŠfdä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ nfds = poll(fds, max+1, timeout); if (fds[0].revents \u0026amp; POLLRDNORM) { // è¿™é‡Œå¤„ç†acceptäº‹ä»¶ connfd = accept(listenfd); //å°†æ–°çš„æè¿°ç¬¦æ·»åŠ åˆ°è¯»æè¿°ç¬¦é›†åˆä¸­ } // æ¯æ¬¡éœ€è¦éå†æ‰€æœ‰fdï¼Œåˆ¤æ–­æœ‰æ— è¯»å†™äº‹ä»¶å‘ç”Ÿ for (int i = 1; i \u0026lt; max; ++i) { if (fds[i].revents \u0026amp; POLLRDNORM) { sockfd = fds[i].fd if ((n = read(sockfd, buf, MAXLINE)) \u0026lt;= 0) { // è¿™é‡Œå¤„ç†readäº‹ä»¶ if (n == 0) { close(sockfd); fds[i].fd = -1; } } else { // è¿™é‡Œå¤„ç†writeäº‹ä»¶ } if (--nfds \u0026lt;= 0) { break; } } } } pollå­˜åœ¨çš„é—®é¢˜  pollè§£å†³äº†selectçš„æœ€å¤§è¿æ¥æ•°çš„é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ï¼šæ¯æ¬¡è°ƒç”¨polléƒ½éœ€è¦å°†fdæ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´åˆ°å†…æ ¸æ€ å¯¹fdæ˜¯çº¿æ€§æ‰«æï¼Œå³è¿˜æ˜¯é‡‡ç”¨äº†è½®è¯¢éå†çš„æ–¹æ³•,å†…æ ¸æ€ä¸­ç›‘æ§æ˜¯å¦æœ‰å°±ç»ªçš„fd,ç”¨æˆ·æ€ä¸­åˆ¤æ–­å°±ç»ªçš„fd  epoll  epollæ˜¯é‡‡ç”¨çº¢é»‘æ ‘å­˜å‚¨fd,é‡‡ç”¨rdlistå­˜å‚¨å°±ç»ªçš„fd, é€šè¿‡epoll_creat()æ–¹æ³•æ¥åˆ›å»ºeventPollç»“æ„ä½“(çº¢é»‘æ ‘+relist)ã€‚ é€šè¿‡epoll_ctl()æ–¹æ³•å°†fdå­˜å…¥åˆ°çº¢é»‘æ ‘ä¸­ï¼Œè‹¥æœ‰å°±ç»ªçš„fd,å°±è°ƒç”¨ep_poll_callback()å›è°ƒå‡½æ•°å°†å°±ç»ªçš„fdæ·»åŠ åˆ°relistä¸­ã€‚ è°ƒç”¨event_wait()æ£€æŸ¥æ˜¯å¦æœ‰å°±ç»ªçš„fd,å³æ£€æµ‹relistæ˜¯å¦ä¸ºç©ºã€‚è‹¥ä¸ä¸ºç©ºï¼Œå°†å°†å°±ç»ªçš„fdçš„æ•°é‡è¿”å›ã€‚ç”¨æˆ·æ€éå†relist+è¿”å›çš„å°±ç»ªçš„fd çš„æ•°é‡å³å¯è·å¾—æ•°æ®ã€‚   #include \u0026lt;sys/epoll.h\u0026gt; // æ•°æ®ç»“æ„ // æ¯ä¸€ä¸ªepollå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„eventpollç»“æ„ä½“ // ç”¨äºå­˜æ”¾é€šè¿‡epoll_ctlæ–¹æ³•å‘epollå¯¹è±¡ä¸­æ·»åŠ è¿›æ¥çš„äº‹ä»¶ // epoll_waitæ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåªéœ€è¦æ£€æŸ¥eventpollå¯¹è±¡ä¸­çš„rdliståŒé“¾è¡¨ä¸­æ˜¯å¦æœ‰epitemå…ƒç´ å³å¯ struct eventpoll { /*çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œè¿™é¢—æ ‘ä¸­å­˜å‚¨ç€æ‰€æœ‰æ·»åŠ åˆ°epollä¸­çš„éœ€è¦ç›‘æ§çš„äº‹ä»¶*/ struct rb_root rbr; /*åŒé“¾è¡¨ä¸­åˆ™å­˜æ”¾ç€å°†è¦é€šè¿‡epoll_waitè¿”å›ç»™ç”¨æˆ·çš„æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶*/ struct list_head rdlist; }; // å¯¹äºæ¯ä¸€ä¸ªäº‹ä»¶ï¼Œéƒ½ä¼šå»ºç«‹ä¸€ä¸ªepitemç»“æ„ä½“ struct epitem{ struct rb_node rbn;//çº¢é»‘æ ‘èŠ‚ç‚¹ struct list_head rdllink;//åŒå‘é“¾è¡¨èŠ‚ç‚¹ struct epoll_filefd ffd; //äº‹ä»¶å¥æŸ„ä¿¡æ¯ struct eventpoll *ep; //æŒ‡å‘å…¶æ‰€å±çš„eventpollå¯¹è±¡ struct epoll_event event; //æœŸå¾…å‘ç”Ÿçš„äº‹ä»¶ç±»å‹ } // API int epoll_create(int size); // å†…æ ¸ä¸­é—´åŠ ä¸€ä¸ª ep å¯¹è±¡ï¼ŒæŠŠæ‰€æœ‰éœ€è¦ç›‘å¬çš„ socket éƒ½æ”¾åˆ° ep å¯¹è±¡ä¸­ int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); // epoll_ctl è´Ÿè´£æŠŠ socket å¢åŠ ã€åˆ é™¤åˆ°å†…æ ¸çº¢é»‘æ ‘ int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);// epoll_wait è´Ÿè´£æ£€æµ‹å¯è¯»é˜Ÿåˆ—ï¼Œæ²¡æœ‰å¯è¯» socket åˆ™é˜»å¡è¿›ç¨‹ //epollä½¿ç”¨ç¤ºä¾‹ int main(int argc, char* argv[]) { /* * åœ¨è¿™é‡Œè¿›è¡Œä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œ * æ¯”å¦‚åˆå§‹åŒ–æ•°æ®å’Œsocketç­‰ã€‚ */ // å†…æ ¸ä¸­åˆ›å»ºepå¯¹è±¡ epfd=epoll_create(256); // éœ€è¦ç›‘å¬çš„socketæ”¾åˆ°epä¸­ epoll_ctl(epfd,EPOLL_CTL_ADD,listenfd,\u0026amp;ev); while(1) { // é˜»å¡è·å– nfds = epoll_wait(epfd,events,20,0); for(i=0;i\u0026lt;nfds;++i) { if(events[i].data.fd==listenfd) { // è¿™é‡Œå¤„ç†acceptäº‹ä»¶ connfd = accept(listenfd); // æ¥æ”¶æ–°è¿æ¥å†™åˆ°å†…æ ¸å¯¹è±¡ä¸­ epoll_ctl(epfd,EPOLL_CTL_ADD,connfd,\u0026amp;ev); } else if (events[i].events\u0026amp;EPOLLIN) { // è¿™é‡Œå¤„ç†readäº‹ä»¶ read(sockfd, BUF, MAXLINE); //è¯»å®Œåå‡†å¤‡å†™ epoll_ctl(epfd,EPOLL_CTL_MOD,sockfd,\u0026amp;ev); } else if(events[i].events\u0026amp;EPOLLOUT) { // è¿™é‡Œå¤„ç†writeäº‹ä»¶ write(sockfd, BUF, n); //å†™å®Œåå‡†å¤‡è¯» epoll_ctl(epfd,EPOLL_CTL_MOD,sockfd,\u0026amp;ev); } } } return 0; }  \r  epoll ä¼˜ç‚¹  é‡‡ç”¨äº†çº¢é»‘æ ‘è¿›è¡Œå­˜å‚¨fd, æ²¡æœ‰fdçš„æœ€å¤§è¿æ¥æ•°é™åˆ¶ é‡‡ç”¨äº†äº‹ä»¶å›è°ƒçš„æ–¹å¼ï¼Œå³æœ‰å°±ç»ªçš„fdæ—¶ï¼Œå°±ä¼šå°†fdé€šè¿‡å›è°ƒå‡½æ•°æ·»åŠ åˆ°relistè¡¨ä¸­ï¼Œå¹¶ä¸æ˜¯é‡‡ç”¨è½®è¯¢+éå†çš„æ–¹å¼ åˆ©ç”¨mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸æ€ç©ºé—´çš„ä¿¡æ¯ä¼ é€’(ç”¨æˆ·æ€ä¸å†…æ ¸æ€å…±äº«å†…å­˜)ï¼Œå‡å°‘äº†fdé›†åˆä»ç”¨æˆ·æ€æ‹·è´ (ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„åªæ‹·è´ä¸€æ¬¡)åˆ°å†…æ ¸æ€çš„å¼€é”€  epollçš„è§¦å‘  æ°´å¹³è§¦å‘LT:åªæœ‰è¦å°±ç»ªçš„fd,epoll_wait()å°±ä¼šè¿”å›ï¼Œå¹¶æé†’ç”¨æˆ·æ€è¿›è¡Œç›¸å…³çš„æ“ä½œã€‚å³åªæœ‰ç¼“å†²åŒºæœ‰å˜åŒ–å°±ä¼šè§¦å‘ è¾¹ç¼˜è§¦å‘ET:å½“æ–‡ä»¶æè¿°ç¬¦å…³è”çš„ç¼“å†²åŒºæœ‰ç©ºè½¬ä¸ºéç©ºæ—¶ï¼Œæˆ–è€…æ˜¯ç¼“å†²åŒºç”±æ»¡åˆ°ä¸æ»¡å°±ä¼šè§¦å‘ã€‚å³åªæœ‰ç¼“å†²åŒºæœ‰ç©ºè½¬ä¸ºéç©ºæˆ–è€…æ˜¯ç”±æ»¡è½¬ä¸ºéæ»¡çš„ æƒ…å†µæ‰ä¼šè§¦å‘ã€‚  ä¸‰è€…æ€»ç»“ \r\nå‚è€ƒæ–‡çŒ® å½»åº•ç†è§£ IO å¤šè·¯å¤ç”¨å®ç°æœºåˆ¶\n","date":"2021-12-12T12:00:38+08:00","image":"https://zcj-git520.github.io/p/io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/3_hu407313779efa40a3c2449c5134b0af99_194287_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/","title":"ioå¤šè·¯å¤ç”¨"},{"content":"redisçš„ç½‘ç»œåè®®  redisæ˜¯åŸºäºtcp/ipåè®®ï¼Œå³å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¿æŒåŒå·¥è¿æ¥ï¼Œé€šè¿‡åºåˆ—åŒ–çš„åè®®(respåè®®)è¿›è¡Œæ•°æ®çš„äº¤äº’ï¼Œåœ¨Redisä¸­ï¼Œåè®®æ•°æ®åˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œ æ¯ç§ç±»å‹çš„æ•°æ®å‡ä»¥CRLFï¼ˆ\\r\\nï¼‰ç»“æŸï¼Œé€šè¿‡æ•°æ®çš„é¦–å­—ç¬¦åŒºåˆ†ç±»å‹ \r redisæœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç³»ç»Ÿä¸»è¦åˆ†ä¸ºï¼šæ–‡ä»¶äº‹ä»¶(ioäº‹ä»¶)å’Œæ—¶é—´äº‹ä»¶ æ–‡ä»¶é©±åŠ¨ï¼šsocketçš„è¯»å–äº‹ä»¶(ioäº‹ä»¶)æ˜¯ç”±ï¼›è¿æ¥(ä¸‰æ¬¡æ¡æ‰‹)ã€è¯·æ±‚ã€å“åº”(æ•°æ®è¿”å›)ã€æ–­å¼€è¿æ¥(å››æ¬¡æŒ¥æ‰‹)ç»„æˆï¼Œredisæ˜¯é‡‡ç”¨å•çº¿ç¨‹ å’Œepoll(ioå¤šè·¯å¤ç”¨)çš„æœºåˆ¶å¤„ç†ç›¸å…³çš„æ–‡ä»¶äº‹ä»¶ã€‚ æ—¶é—´äº‹ä»¶ï¼šå¯åˆ†ä¸ºå®šæ—¶äº‹ä»¶(ç¨‹åºåœ¨æŒ‡å®šæ—¶é—´åæ‰§è¡Œç›¸å…³çš„æ“ä½œ)å’Œå‘¨æœŸäº‹ä»¶(ç¨‹åºæ¯éš”ä¸€æ®µæ—¶é—´è¿è¡Œç›¸å…³çš„æ“ä½œ)  rediså®¢æˆ·ç«¯ä¸æœåŠ¡å™¨äº¤äº’æ¨¡å¼ ä¸²è¡Œçš„è¯·æ±‚/äº¤äº’æ¨¡å¼  å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹é•¿è¿æ¥ï¼Œé€šè¿‡å¿ƒè·³æ£€æµ‹(ping-pong)ackåº”ç­”ï¼Œå³å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨åœ¨è¿›è¡Œå“åº”ã€‚ åœ¨å•è¿æ¥ä¸‹ã€‚å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯å¤„äºç½‘ç»œç­‰å¾…ä¸Š(å®¢æˆ·ç«¯åœ¨å‘é€è¯·æ±‚å‘½ä»¤ï¼Œå¹¶ç›‘å¬socketè¿”å›ï¼Œé€šå¸¸ä»¥é˜»å¡æ¨¡å¼ç­‰å¾…æœåŠ¡å™¨ç«¯çš„å“åº”)ï¼Œè¿™ç§æ¨¡å¼ä¸‹ çš„æ€§èƒ½è¾ƒä½ \r  ç®¡é“æŠ€æœ¯(pipeline)åŒå·¥çš„è¯·æ±‚/å“åº”æ¨¡å¼  å°†ä¸€æ‰¹å‘½ä»¤è¿›è¡Œæ‰“åŒ…ï¼Œç„¶åå‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è·å–æ•°æ®åæŒ‰é¡ºåºæ‰“åŒ…è¿”å›ï¼Œå³æ‰¹é‡è¯·æ±‚ï¼Œæ‰¹é‡å“åº”ã€‚ä»¥æ¬¡æ¥å‡å°‘ç½‘ç»œç­‰å¾…çš„å»¶æ—¶ï¼Œæé«˜æ€§èƒ½ \r  åŸå­åŒ–çš„æ‰¹é‡è¯·æ±‚/å“åº”(äº‹åŠ¡)æ¨¡å¼  å®¢æˆ·ç«¯å°†è¯·æ±‚çš„å‘½ä»¤å‘é€å‘åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç»è¿™äº›è¯·æ±‚æš‚å­˜åœ¨æœåŠ¡å™¨çš„è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œè¿™è¿‡ç¨‹ä¹Ÿç§°ä¸ºï¼šè¯·æ±‚å…¥é˜Ÿåˆ—ã€‚æœåŠ¡å™¨åœ¨ä»è¯·æ±‚é˜Ÿåˆ—ä¸­ æ‹¿å»æ‰€æœ‰çš„è¯·æ±‚æ‰§è¡Œï¼Œç„¶åå†å°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™è¿‡ç¨‹ç§°ä¸ºæ‰§è¡Œé˜¶æ®µã€‚ æœåŠ¡å™¨åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šåœ¨æ¥æ”¶å…¶ä»–å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ã€‚æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸå­æ“ä½œï¼Œå³è¯·æ±‚éƒ½æ‰§è¡Œæˆ–éƒ½ä¸æ‰§è¡Œã€‚ äº‹åŠ¡çš„æ­¥éª¤ä¸ºï¼šå¼€å§‹äº‹åŠ¡-\u0026gt;è¯·æ±‚å…¥é˜Ÿåˆ—-\u0026gt;æ‰§è¡Œè¯·æ±‚ \r  å‘å¸ƒ/è®¢é˜…(pub/sub)æ¨¡å¼  å‘å¸ƒè€…(pub)å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…(sub)æ¥æ”¶æ¶ˆæ¯ï¼Œå‘å¸ƒè€…å’Œè®¢é˜…è€…é€šè¿‡(é€šé“)channelå…³è”ï¼Œæ‰€æœ‰çš„channeléƒ½æ˜¯ç”±ä¸€ä¸ªmapç»´æŠ¤ï¼Œmapçš„keyæ˜¯ channelçš„åå­—ï¼Œvalueæ˜¯æ‰€æœ‰çš„è®¢é˜…è€…çš„æŒ‡é’ˆé“¾è¡¨ã€‚å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„çš„æ•°é‡çš„é¢‘é“ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œå‘å¸ƒã€‚ å‘å¸ƒè€…å’Œè®¢é˜…è€…éƒ½æ˜¯å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨åªæ˜¯è¿›è¡Œæ•°æ®çš„ä¸­è½¬ã€‚å³å‘å¸ƒè€…ç€å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å°†è¯·æ±‚çš„æ•°æ®æ¨é€ç»™è®¢é˜…è€…ã€‚ \r  redisçš„æŒä¹…åŒ–æœºåˆ¶  redisçš„æŒä¹…åŒ–æœºåˆ¶ä¸»è¦æ˜¯æœ‰ï¼šRDB(å¿«ç…§)å’ŒAOF(æ—¥å¿—)ä¸¤ç§æŒä¹…åŒ–çš„æ–¹å¼ã€‚æŒä¹…çš„åŒ–çš„ä½œç”¨åœ¨äºï¼šæ•…éšœæ¢å¤å’Œæ•°æ®æ¢å¤  RDB(å¿«ç…§)æŒä¹…åŒ–æœºåˆ¶  å¿«ç…§æ˜¯redisé»˜è®¤çš„æŒä¹…åŒ–æ–¹æ¡ˆï¼Œåœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…ç”Ÿæˆæ•°æ®é›†çš„æ—¶é—´ç‚¹ï¼Œå³åœ¨æŒ‡å®šçš„æ—¶é—´æ®µå†…å°†å†…å­˜çš„æ•°æ®å†™å…¥ç£ç›˜ï¼Œåœ¨ç£ç›˜ ä¸Šç”Ÿæˆä¸€ä¸ªrdbçš„å¤‡ä»½æ–‡ä»¶ã€‚åœ¨redisé‡å¯æ—¶åŠ è½½rdbæ–‡ä»¶è¿›è¡Œæ•°æ®çš„æ¢å¤ã€‚ å¿«ç…§çš„æŒä¹…åŒ–æä¾›è‡ªåŠ¨å¤‡ä»½ï¼šéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶redis.confã€‚ä¹Ÿæä¾›saveå’Œbysave(åå°å­è¿›ç¨‹)è¿›è¡Œä¸»åŠ¨å¤‡ä»½  RDB(å¿«ç…§)çš„å·¥ä½œæµç¨‹ï¼š  ä¸»è¿›ç¨‹ä¼šå•ç‹¬åˆ›å»ºå­è¿›ç¨‹ï¼Œå°†ä¸»è¿›ç¨‹çš„æ•°æ®åº“çš„æ•°æ®å¤åˆ¶åˆ°å­è¿›ç¨‹ã€‚ å­è¿›ç¨‹å°†æ•°æ®å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­è¿›è¡ŒæŒä¹…åŒ–ï¼Œåœ¨ç»ä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¹‹å‰çš„rdbæ–‡ä»¶,å­è¿›ç¨‹é€€å‡ºï¼Œé‡Šæ”¾å†…å­˜ä¸­çš„æ•°æ® ä¸»è¿›ç¨‹ä¸è¿›è¡ŒæŒä¹…åŒ–ï¼Œå³ä¸è¿›è¡Œä»»ä½•çš„ioæ“ä½œï¼Œç¡®ä¿redisçš„æé«˜çš„æ€§èƒ½  RDB(å¿«ç…§)çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹  å•ä¸€çš„ç´§å‡‘æ–‡ä»¶ä¿å­˜äº†è«ä¸€æ®µæ—¶é—´çš„æ•°æ®é›†ï¼Œæ¯”è¾ƒé€‚åˆåšæ•°æ®çš„å¤‡ä»½å°¤å…¶çš„å†·å¤‡ä»½ åœ¨å¯¹æ•°æ®å®Œæ•´æ€§ä¸æ•æ„Ÿä¸‹ï¼Œé€‚åˆå¤§è§„æ¨¡çš„æ•°æ®çš„æ¢å¤ï¼Œå› ç›´æ¥ä»ç£ç›˜è·å–æ•°æ®ï¼Œæ¢å¤æ•°æ®å¿« ç”±å­è¿›ç¨‹è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¸»è¿›ç¨‹ä¸è¿›è¡ŒæŒä¹…åŒ–ï¼Œå³ä¸è¿›è¡Œä»»ä½•çš„ioæ“ä½œï¼Œç¡®ä¿redisçš„æé«˜çš„æ€§èƒ½  ç¼ºç‚¹  ä¸èƒ½ä¿éšœæ•°æ®çš„å®Œæ•´æ€§ï¼Œè‹¥rediså‡ºç°å®•æœºï¼Œå°±ä¸ä¼šå‡ºç°æœ€è¿‘çš„æ•°æ®æœªæŒä¹…åŒ–ï¼Œå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ã€‚ å½“æŒä¹…åŒ–çš„æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œä¼šå¯¼è‡´æŒä¹…åŒ–çš„å­è¿›ç¨‹å°±ä¼šå¾ˆè€—æ—¶ï¼Œå³ä½¿ä¸»çº¿ç¨‹åœ¨ä¸å‚ä¸æŒä¹…åŒ–ä¹Ÿå¯èƒ½å¯¼è‡´æœåŠ¡å™¨åœ¨æ¯«ç§’çº§å†…ä¸èƒ½å“åº” å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè‹¥æ•°æ®å·¨å¤§æ—¶ä¸”cpuçš„æ€§èƒ½ä¸ä½³æ—¶ï¼Œä¼šå‡ºç°ç§’çº§ä¸èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚  AOF(æ—¥å¿—)æŒä¹…åŒ–  é€šè¿‡å°†æ¯ä¸ªå†™æ“ä½œè®°å½•åˆ°æ—¥å¿—ä¸­ä¸”ä»¥è¿½åŠ æ–‡ä»¶ä¸ä¿®æ”¹æ–‡ä»¶çš„æ¨¡å¼ï¼Œé‡å¯æ—¶æ›´å…·æ ¹æ®æ—¥å¿—æ–‡ä»¶ä»å¤´åˆ°æœªæ‰§è¡Œä¸€éå³æ¢å¤æ•°æ®ã€‚ï¼Œå› AOFé‡‡ç”¨çš„æ˜¯ç»æ“ä½œè®°å½•ä»¥è¿½åŠ æ¨¡å¼ä¸‹å†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä¼šå¯¼è‡´AOFæ–‡ä»¶è¶Šæ¥è¶Šå¤§ã€‚AOFå¼•å…¥äº†é‡å†™æœºåˆ¶ã€‚ AOFå¼•å…¥äº†é‡å†™æœºåˆ¶ï¼šå½“æ–‡ä»¶AOFæ˜¯ä¸Šæ¬¡é‡å†™å¤§å°çš„ä¸€å€ä¸”æ–‡ä»¶å¤§äº64MBæ—¶å°±åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹éå†æœåŠ¡å™¨çš„é”®å€¼å¯¹ï¼Œè½¬æ¢æˆä¸€ç³»åˆ— Redis çš„æ“ä½œ æŒ‡ä»¤ï¼Œåºåˆ—åŒ–åˆ°ä¸€ä¸ªæ–°çš„AOFæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå†æ›¿æ¢æ—§çš„AOFæ—¥å¿—æ–‡ä»¶ã€‚å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶è®¾å®šæŒä¹…åŒ–ç­–ç•¥ã€‚  AOF æä¾›äº†ä¸‰ç§æŒä¹…åŒ–ç­–ç•¥ï¼š  no: æ—  fsyncï¼Œç”±ç³»ç»Ÿä¿è¯æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ï¼Œé€Ÿåº¦æœ€å¿«ï¼Œä½†å¾ˆä¸å®‰å…¨ï¼ˆé€šå¸¸ä¸ä½¿ç”¨ï¼‰ï¼› always: æ¯æ¬¡ fsyncï¼Œæ¯ä¸€ä¸ªä¿®æ”¹å†…å­˜çš„ Redis æŒ‡ä»¤éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ fsyncï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼ˆé€šå¸¸ä¸ä½¿ç”¨ï¼‰ï¼› everysec: æ¯ç§’è¿›è¡Œä¸€æ¬¡ fsyncï¼Œæœ‰å¯èƒ½ä¸¢å¤±ä¸€ç§’çš„ fsync çš„æ•°æ®ã€‚é€šå¸¸é€‰æ‹© everysec ç­–ç•¥ï¼Œå…¼é¡¾å®‰å…¨æ€§å’Œæ•ˆç‡ã€‚  AOF(æ—¥å¿—)çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹  å¯ä»¥é‡‡ç”¨everysecçš„æŒä¹…åŒ–ç­–ç•¥ï¼Œèƒ½ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§  ç¼ºç‚¹  AOFçš„æ—¥å¿—æ–‡ä»¶é€šå¸¸æ˜¯æ¯”rdbæ–‡ä»¶å¤§ åœ¨æ•°æ®çš„æ¢å¤æ—¶ï¼Œéœ€è¦éå†æ—¥å¿—æ–‡ä»¶ï¼Œå°†æ—¥å¿—æ–‡ä»¶çš„æ•°æ®æ“ä½œå‘½ä»¤åœ¨æ‰§è¡Œä¸€éï¼Œå¯¼è‡´æ•°æ®æ¢å¤ç›¸å¯¹äºå¿«ç…§(rdb)è¾ƒæ…¢ï¼Œå°¤å…¶åœ¨å¤§æ•°æ®ä¸‹ã€‚  redis ç¼“å­˜ä¸­çš„çŠ¶å†µäºè§£å†³æ–¹æ¡ˆ ç¼“å­˜é›ªå´©  æ•°æ®æœªåŠ è½½åˆ°å†…å­˜æˆ–è€…åŒä¸€æ—¶é—´å‘ç”Ÿå¤§è§„æ¨¡çš„keyå¤±æ•ˆï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½ç›´æ¥åœ¨æŸ¥æ•°æ®åº“ã€‚å¯¼è‡´æ•°æ®åº“å’Œcpuè´Ÿè½½è¿‡é«˜ï¼Œç”šè‡³å®•æœº  è§£å†³æ–¹æ¡ˆ  åŠ é”è®¡æ•°ï¼Œé™åˆ¶å¹¶å‘çš„æ•°é‡ï¼Œé¿å…å‡ºç°å¹¶å‘å‡ºç°å¤§é‡çš„è¯·æ±‚è®¿é—®åˆ°æ•°æ®åº“ï¼Œé™ä½æœåŠ¡å™¨çš„ååé‡ è®¾ç½®çƒ­ç‚¹keyæ°¸ä¸å¤±æ•ˆï¼Œå‡åŒ€è¿‡æœŸï¼Œé¿å…å‡ºç°å¤§é¢ç§¯çš„keyåŒæ—¶å¤±æ•ˆ è®¾ç½®ç¼“å­˜æœåŠ¡å™¨çš„ä¸»å¤‡  ç¼“å­˜ç©¿é€  æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­å‡æ²¡æœ‰ï¼Œå¯¼è‡´å®¢æˆ·ç«¯åœ¨æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»æ•°æ®åº“æŸ¥è¯¢ã€‚è‹¥åœ¨å¹¶å‘æ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´æ•°æ®åº“å’Œcpuçš„è´Ÿè½½è¿‡é«˜ï¼Œ å¯¼è‡´æ•°æ®åº“çš„å®•æœº  è§£å†³æ–¹æ¡ˆ  è‹¥æŸ¥è¯¢æ•°æ®åº“ä¸å­˜åœ¨ï¼Œç›´æ¥åœ¨ç¼“å­˜ä¸­ä¿å­˜ä¸€ä¸ªé»˜è®¤çš„å€¼ï¼Œå¹¶è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œä¸‹æ¬¡è¯·æ±‚ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ã€‚ ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œé˜»æŒ¡æ— æ•ˆçš„è¯·æ±‚ã€‚  ç¼“å­˜å¹¶å‘  åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç¼“å­˜å¤±æ•ˆï¼Œåœ¨é«˜å¹¶å‘ä¸‹è®¿é—®æ•°æ®åº“ï¼Œç¼“å­˜æ›´æ–°ï¼Œä¹Ÿä¼šå¯¼è‡´æ•°æ®çš„å‹åŠ›å˜å¤§ã€‚  è§£å†³æ–¹æ¡ˆ  å¯¹ç¼“å­˜åŠ é”ï¼Œè‹¥keyä¸å­˜åœ¨ï¼Œå°±åŠ é”ï¼Œå½“æŸ¥è¯¢æ•°æ®åº“çš„æ•°æ®å†™å…¥ç¼“å­˜åœ¨è§£é”  ç¼“å­˜é¢„çƒ­  åœ¨ç³»ç»Ÿè¿è¡Œå‰ï¼Œå°†æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­  è§£å†³æ–¹æ¡ˆ  æ•°æ®é‡ä¸å¤§ï¼Œç›´æ¥åŠ è½½ æ•°æ®é‡å¤§æ—¶ï¼Œè®¾ç½®å®šæ—¶çš„è„šæœ¬è¿›è¡Œç¼“å­˜çš„åˆ·æ–° æ•°æ®é‡å·¨å¤§æ—¶ï¼Œä¼˜å…ˆä¿éšœçƒ­ç‚¹æ•°æ®æå‰åŠ è½½åˆ°ç¼“å­˜ä¸­  ç¼“å­˜é™çº§  æŒ‡ç¼“å­˜å¤±æ•ˆæˆ–è€…ç¼“å­˜æœåŠ¡å™¨å®•æœºæ—¶ï¼Œä¸å»è®¿é—®æ•°æ®åº“ï¼Œç›´æ¥è¿”å›é»˜è®¤å€¼æˆ–è®¿é—®å†…å­˜æ•°æ®  åˆ†å¸ƒé”  ä½¿ç”¨setnxåŠ é”ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¿‡äº†è¶…æ—¶æ—¶é—´å°±è§£é”ï¼Œå¹¶åˆ é™¤é”  å‚è€ƒæ–‡çŒ® Redis å®¢æˆ·ç«¯æœåŠ¡ç«¯äº¤äº’1 å®¢æˆ·ç«¯/æœåŠ¡ç«¯åè®®\n","date":"2021-12-08T22:00:38+08:00","image":"https://zcj-git520.github.io/p/redis%E8%BF%9B%E9%98%B6/5_hu55d28ed2616667077617555b48a30f7c_17120_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/redis%E8%BF%9B%E9%98%B6/","title":"redisè¿›é˜¶"},{"content":"redis  redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œæ•°æ®ç»“æ„ä¸ºkey-valueçš„å­˜å‚¨ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨ä½œåˆ†å¸ƒå¼æ•°æ®åº“ã€ç¼“å­˜ å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰ã€‚æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå­˜å–é€Ÿåº¦å¿«ï¼Œå¹¶å‘èƒ½åŠ›å¼ºã€‚ redis æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€map(å“ˆå¸Œ)ã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰æ•°æ®ç±»å‹ã€‚æ•°æ®éƒ½æ˜¯åŸå­æ“ä½œï¼Œ æ•°æ®éƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä¼šå®šæœŸå°†æ•°æ®æ›´æ–°åˆ°ç£ç›˜æˆ–è€…ä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ è®°å½•ã€‚å†æ¬¡åŸºç¡€ä¸Šå®ç°äº†ä¸»ä»ï¼ˆmaster-slaveï¼‰  redis æ•°æ®ç»“æ„ å­—ç¬¦ä¸²(string)ç±»å‹  å­—ç¬¦ä¸²ç±»å‹æ˜¯redisæœ€åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨ç®€å•çš„å­—ç¬¦ä¸²ä¹Ÿå¯å­˜å‚¨å¤æ‚çš„xmlã€jsonã€äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚å›¾åƒã€éŸ³é¢‘ï¼‰ valueå†…éƒ¨ä»¥ä¿å­˜æ•´æ•°çš„intå’Œä¿å­˜å­—ç¬¦çš„sdsç»„æˆçš„æ•°æ®å­˜å‚¨ç»“æ„ã€‚sdså†…éƒ¨ç»“æ„ä¸ºï¼š  struct sdshdr { int len; // è®°å½•ç€bufä¸­ä¹Ÿä½¿ç”¨çš„å­—ç¬¦ä¸²æ•°é‡ int free; // è®°å½•ç€bufä¸­æœªä½¿ç”¨çš„å­—ç¬¦ä¸²æ•°é‡ char buh[]; // å­—ç¬¦ä¸²æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸² } \r\nå­—ç¬¦ä¸²ç±»å‹ç‰¹æ€§  åˆ†é…å†—ä½™ç©ºé—´ï¼šé‡‡ç”¨é¢„å…ˆåˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é… è‡ªåŠ¨æ‰©å®¹ï¼š å½“å­—ç¬¦ä¸²æ‰€å ç©ºé—´å°äº1MBæ—¶ï¼Œredisä¼šæŒ‰ç…§å­—ç¬¦ä¸²ï¼ˆlen + addLenï¼‰*2å€æ•°å­˜å‚¨ç©ºé—´å¢åŠ ï¼Œ å½“å­—ç¬¦ä¸²çš„å­˜å‚¨ç©ºé—´è¶…è¿‡æ‰€å ç©ºé—´çš„1MBæ—¶ï¼Œæ¯æ¬¡è‡ªä¼šå¢åŠ 1MBçš„å­˜å‚¨ç©ºé—´æ‰©å®¹ï¼Œæœ€å¤§æ‰©å®¹ä¸º512MBçš„å­˜å‚¨ç©ºé—´ äºŒè¿›åˆ¶çš„å®‰å…¨æ€§ï¼Œå…¼å®¹cè¯­è¨€å‡½æ•°åº“ä¸­å­—ç¬¦ä¸²ä»¥\\0ç»“æŸã€‚  å­—ç¬¦ä¸²å¸¸ç”¨çš„åœºæ™¯  ç¼“å­˜åŠŸèƒ½ï¼š åŸºäºredisä½œä¸ºç¼“å­˜å†é…åˆå…¶ä»–çš„æ•°æ®åº“æœ€ä¸ºå­˜å‚¨å±‚ï¼Œåˆ©ç”¨redisçš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜å’Œæ”¯æŒé«˜å¹¶å‘çš„ç‰¹ç‚¹ï¼Œå¯ä»¥å¤§å¤§åŠ å¿« ç³»ç»Ÿçš„è¯»å†™é€Ÿåº¦ä»¥åŠé™ä½åç«¯æ•°æ®åº“çš„å‹åŠ›ã€‚ï¼ˆå•å€¼ç¼“å­˜ã€å¯¹è±¡ç¼“å­˜ã€åˆ†å¸ƒå¼é”ç­‰ï¼‰ è®¡æ•°å™¨ï¼š ä½¿ç”¨redisä½œä¸ºç³»ç»Ÿçš„å®æ—¶è®¡æ•°å™¨ï¼Œå¯ä»¥åŠ å¿«è®¡æ•°å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚ å…±äº«ç”¨æˆ·çš„sessionï¼šåˆ©ç”¨rediså°†ç”¨æˆ·çš„sessioné›†ä¸­ç®¡ç†ï¼Œè¿™ç§æ¨¡å¼ç¡®ä¿redisçš„é«˜å¯ç”¨ã€‚æ¯æ¬¡ç”¨æˆ·çš„sessionçš„æ›´æ–°å’Œè·å–å¿«é€Ÿå®Œæˆ  åˆ—è¡¨(list)  listç±»å‹çš„valueå¯¹è±¡å†…éƒ¨é‡‡ç”¨çš„quicklist(å¿«é€Ÿåˆ—è¡¨)æˆ–è€…ziplist(å‹ç¼©åˆ—è¡¨)æ‰¿è½½ã€‚å½“listçš„å…ƒç´ å’Œå•ä¸ªå…ƒç´ è¾ƒå°æ—¶é‡‡ç”¨ziplistå®ç°æ¥å‡å°‘å†…å­˜çš„ å ç”¨å¦åˆ™é‡‡ç”¨quicklistç»“æ„è¿›è¡Œå­˜å‚¨ã€‚ ziplistæ‰€æœ‰å†…å®¹éƒ½å­˜æ”¾åœ¨æ¥è¿ç»­çš„å†…å­˜ä¸­ã€‚zipbytesè¡¨ç¤ºziplistçš„æ€»é•¿åº¦ï¼Œ zltailè¡¨ç¤ºæŒ‡å‘æœ€æœ«çš„å…ƒç´ ï¼Œzllenè¡¨ç¤ºå…ƒç´ ä¸ªæ•°ï¼Œ entryXè¡¨ç¤ºå…ƒç´ è‡ªèº«å†…å®¹ï¼Œ zlendæ˜¯ziplistçš„å®šç•Œç¬¦ ziplistçš„å†…éƒ¨ç»“æ„ä¸ºï¼š  typedef struct ziplist{ /*zipliståˆ†é…çš„å†…å­˜å¤§å°*/ uint32_t bytes; /*è¾¾åˆ°å°¾éƒ¨çš„åç§»é‡*/ uint32_t tail_offset; /*å­˜å‚¨å…ƒç´ å®ä½“ä¸ªæ•°*/ uint16_t length; /*å­˜å‚¨å†…å®¹å®ä½“å…ƒç´ */ unsigned char* content[]; /*å°¾éƒ¨æ ‡è¯†*/ unsigned char end; }ziplist; /*å…ƒç´ å®ä½“æ‰€æœ‰ä¿¡æ¯, ä»…ä»…æ˜¯æè¿°ä½¿ç”¨, å†…å­˜ä¸­å¹¶éå¦‚æ­¤å­˜å‚¨*/ typedef struct zlentry { /*å‰ä¸€ä¸ªå…ƒç´ é•¿åº¦éœ€è¦ç©ºé—´å’Œå‰ä¸€ä¸ªå…ƒç´ é•¿åº¦*/ unsigned int prevrawlensize, prevrawlen; /*å…ƒç´ é•¿åº¦éœ€è¦ç©ºé—´å’Œå…ƒç´ é•¿åº¦*/ unsigned int lensize, len; /*å¤´éƒ¨é•¿åº¦å³prevrawlensize + lensize*/ unsigned int headersize; /*å…ƒç´ å†…å®¹ç¼–ç */ unsigned char encoding; /*å…ƒç´ å®é™…å†…å®¹*/ unsigned char *p; }zlentry; \r\n quicklistæ˜¯åº•å±‚æ˜¯ziplistçš„åŒå‘é“¾è¡¨,ç»“æ„ä¸ºï¼š  struct quicklistNode { quicklistNode *prev; quicklistNode *next; ziplist *zl; // æŒ‡å‘å‹ç¼©åˆ—è¡¨ int32 size; // ziplistå­—èŠ‚æ€»æ•° int16 count; // ziplistä¸­å…ƒç´ æ•°é‡ int2 encoding; // å­˜å‚¨å½¢å¼ï¼Œè¡¨ç¤ºåŸç”Ÿå­—èŠ‚æ•°ç»„è¿˜æ˜¯LZFå‹ç¼©å­˜å‚¨ ... } quicklistNodeï¼› // å¿«é€Ÿåˆ—è¡¨ struct quicklist { quicklistNode *head; quicklistNode *next; long count; // å…ƒç´ æ€»æ•° int nodes; // ziplistèŠ‚ç‚¹ä¸ªæ•° int compressDepth; // LZFç®—æ³•å‹ç¼©æ·±åº¦ } quicklist; \r\n redisçš„listæ”¯æŒå­˜å‚¨2çš„32æ¬¡æ–¹ä¸ªå…ƒç´ ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡è·å–æŒ‡å®šå…ƒç´ å’Œè«ä¸ªèŒƒå›´çš„å…ƒç´ é›†  åˆ—è¡¨å¸¸ç”¨åœºæ™¯  æ¶ˆæ¯é˜Ÿåˆ—ï¼šredisçš„é“¾è¡¨å¼ç»“æ„ï¼Œå¯ä»¥è½»æ¾å®ç°é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥ä½¿ç”¨å·¦è¿›å³å‡ºçš„å‘½ä»¤å®Œæˆé˜Ÿåˆ—çš„è®¾è®¡ æ–‡ç« åˆ—è¡¨æˆ–è€…æ•°æ®åˆ†é¡µå±•ç¤ºçš„åº”ç”¨  mapç±»å‹(hash æ•£åˆ—)  mapä¸»è¦ç”±hashtableå’Œziplistä¸¤ç§æ‰¿è½½æ–¹å¼æ‰¿è½½ã€‚å½“å­˜å‚¨æ•°æ®è¾ƒå°æ—¶ï¼Œé‡‡ç”¨ziplistå®ç°  hashtableç»„æˆ  dict: å½“dicthtéœ€è¦æ‰©å®¹/ç¼©å®¹æ—¶ï¼Œç”¨äºç®¡ç†æ¡¶çš„è¿ç§»ï¼Œç»“æ„å›¾ä¸‹  typedef struct dict{ // ç±»å‹ç‰¹å®šå‡½æ•° dictType *type; // ç§æœ‰æ•°æ® void *private; // å“ˆå¸Œè¡¨ dictht ht[2]; // rehash ç´¢å¼•ï¼Œå½“å½“å‰çš„å­—å…¸ä¸åœ¨ rehash æ—¶ï¼Œå€¼ä¸º-1 int trehashidx; } dictht: ç»´æŠ¤å“ˆå¸Œè¡¨çš„è¯´æœ‰æ¡¶è¿,ç»“æ„å¦‚ä¸‹ï¼š  typedef struct dictht{ //å“ˆå¸Œè¡¨æ•°ç»„ dictEntry **table; //å“ˆå¸Œè¡¨å¤§å° unsigned long size; //å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼ //æ€»æ˜¯ç­‰äº size-1 unsigned long sizemask; //è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡ unsigned long used; }dictht dictEntry:ç®¡ç†ä¸€ä¸ªk-vå¯¹ï¼ŒåŒæ—¶ä¿ç•™ç€ä¸€ä¸ªæ¡¶ä¸­ç›¸é‚»å…ƒç´ çš„æŒ‡é’ˆï¼Œä¸€æ¬¡ç»´æŠ¤å“ˆå¸Œæ¡¶å†…éƒ¨ç›¸è¿ï¼Œç»“æ„å¦‚ä¸‹  typedef struct dictEntry{ void *key; union{ void *val; uint64_tu64; int64_ts64; }v; //ä¸‹ä¸€ä¸ª struct dictEntry *next; }dictEntry \r\nziplist  mapä¸­å¯¹åº”çš„ziplistçš„entryçš„ä¸ªæ•°ä¸€å®šæ˜¯2çš„æ•´æ•°å€ã€‚å³å¥‡æ•°å­˜æ”¾ç€key,å¶æ•°å­˜æ”¾ç€value  mapç±»å‹çš„ç‰¹æ€§  mapå†…éƒ¨çš„keyå’Œvalueä¸èƒ½åœ¨åµŒå¥—map,åªèƒ½æ˜¯stringï¼Œintæˆ–ç€æ˜¯float è´Ÿè½½å› å­ = å“ˆå¸Œè¡¨ä¸­å·²æœ‰çš„å…ƒç´ /å“ˆå¸Œæ¡¶æ•° æ‰©å®¹ï¼šé€šè¿‡è´Ÿè½½å› å­åˆ¤æ–­æ˜¯å¦éœ€è¦å¢åŠ æ¡¶æ•°ã€‚å³å½“è´Ÿè½½å› å­å°äº1æ—¶ï¼Œä¸€å®šä¸æ‰©å®¹ï¼Œ å½“è´Ÿè½½å› å­å¤§äº1ï¼Œä¸”åœ¨æ²¡æœ‰åœ¨æ‰§è¡ŒBGSAVEè¿›è¡Œæˆ–å½“è´Ÿè½½å› å­å¤§äº5æ—¶ï¼Œä¸€é¡¶ä¼šè¿›è¡Œæ‰©å®¹ï¼Œ æ‰©å®¹æ—¶ï¼Œæ–°æ¡¶çš„æ•°ç›®æ˜¯ç°æœ‰æ¡¶æ•°ç›®çš„ä¸¤å€ã€‚ ç¼©å®¹ï¼šå½“è´Ÿè½½å› å­å°äº0.1æ—¶ï¼Œå°±è¿›è¡Œç¼©å®¹ã€‚ æ‰©/ç¼©å®¹éƒ½æ˜¯é€šè¿‡æ–°å»ºå“ˆå¸Œè¡¨çš„æ–¹å¼å®ç°ï¼Œæ‰©å®¹æ—¶æ–°å»ºç°æœ‰æ¡¶çš„2å€çš„æ–°è¡¨ï¼Œç¼©å®¹æ—¶æ˜¯æ–°å»ºåŸè¡¨çš„ä¸€åŠæ–°å»ºå“ˆå¸Œè¡¨ã€‚ å°†åŸè¡¨çš„æ¡¶é€æ­¥è¿ç§»åˆ°ç›®æ ‡è¡¨(æ–°å»ºçš„å“ˆå¸Œè¡¨)  mapå¸¸ç”¨åœºæ™¯  åˆ©ç”¨é”®å€¼å¯¹çš„ç‰¹æ€§ï¼Œç”¨æ¥å­˜å‚¨å…³ç³»æ€§æ•°æ®åº“ä¸­è¡¨çš„è®°å½• å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä¼˜åŒ–ç”¨æˆ·ä¿¡æ¯çš„æ¥æºï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½  é›†åˆ(set)ç±»å‹  setæ˜¯ç”±insetæˆ–è€…hashtableæ¥å­˜å‚¨ï¼Œhashtableçš„valueæ°¸è¿œä¸ºnil,åªæœ‰intç±»å‹æ˜¯ä½¿ç”¨insetè¿›è¡Œå­˜å‚¨ inset:å…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„  setç±»å‹çš„ç‰¹æ€§  å…è®¸é‡å¤å…ƒç´ ï¼Œæ²¡æœ‰é¡ºåºï¼Œæ²¡æœ‰ä¸‹è¡¨ï¼Œæ”¯æŒé›†åˆå†…çš„å¢åˆ æ”¹æŸ¥ï¼Œå¹¶æ”¯æŒå¤šä¸ªé›†åˆçš„äº¤ã€å¹¶ã€å·®é›†ç­‰æ“ä½œ  setå¸¸ç”¨åœºæ™¯  æ ¹æ®setçš„ç‰¹æ€§ï¼Œé€‚åˆäºèšåˆåˆ†ç±»ï¼Œå¦‚æ ‡ç­¾ã€å¥½å‹å…±åŒå–œå¥½ç­‰åœºæ™¯ åˆ©ç”¨setä¸­å…ƒç´ çš„å”¯ä¸€æ€§ï¼Œé€‚åˆäºæ•°æ®çš„å”¯ä¸€æ€§ï¼Œå¦‚ç»Ÿè®¡ç½‘ç«™çš„ç‹¬ç«‹ip  æœ‰åºé›†åˆ(sorted-set)  sorter-setæ˜¯çš„å†…éƒ¨ç»“æ„æ˜¯ä»¥å‹ç¼©åˆ—è¡¨(ziplist)æˆ–è€…è·³è·ƒè¡¨(skiplist)+hashtableæ„æˆ sorted-setç±»ä¼¼äºmapçš„é”®å€¼å¯¹(key-value)ä¸”æœ‰åºï¼Œvalueæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ç§°ä¹‹ä¸ºscoreï¼Œæ˜¯æ’åºçš„æ ¹æ® è·³è·ƒè¡¨(skiplist)å…¶æ ¸å¿ƒç‚¹ä¸»è¦æ˜¯åŒ…æ‹¬ä¸€ä¸ªdictå¯¹è±¡å’Œä¸€ä¸ªskiplistå¯¹è±¡,ç»“æ„å¦‚ä¸‹ï¼š  typedef struct zset{ //è·³è·ƒè¡¨ zskiplist *zsl; //å­—å…¸ dict *dice; } zset /* ZSETs use a specialized version of Skiplists */ /* * è·³è·ƒè¡¨èŠ‚ç‚¹ */ typedef struct zskiplistNode { // æˆå‘˜å¯¹è±¡ robj *obj; // åˆ†å€¼ double score; // åé€€æŒ‡é’ˆ struct zskiplistNode *backward; // å±‚ struct zskiplistLevel { // å‰è¿›æŒ‡é’ˆ struct zskiplistNode *forward; // è·¨åº¦ unsigned int span; } level[]; } zskiplistNode; /* * è·³è·ƒè¡¨ */ typedef struct zskiplist { // è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹ struct zskiplistNode *header, *tail; // è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ unsigned long length; // è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•° int level; } zskiplist; \r\næœ‰åºé›†åˆ(sorted-set)ç‰¹æ€§  sorted-setæ˜¯é›†åˆçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ç»™æ¯ä¸€ä¸ªå…ƒç´ è®¾ç½®åˆ†æ•°(score),åˆ©ç”¨è¯¥åˆ†æ•°è¿›è¡Œæ’åºï¼Œé›†åˆå…ƒç´ æ˜¯å”¯ä¸€çš„ï¼Œåˆ†æ•°æ˜¯ä¸å”¯ä¸€çš„ã€‚  æœ‰åºé›†åˆ(sorted-set)å¸¸ç”¨åˆ›æ™¯  åˆ©ç”¨å®ƒçš„ç‰¹æ€§ï¼Œå¯ä»¥é€‚åˆäºæ’åºçš„åœºæ™¯ï¼Œå¦‚æ’è¡Œæ¦œç­‰ æ ¹æ®é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½è®¾ç½®äº†ä¸€ä¸ªscoreåˆ†æ•°çš„ç‰¹æ€§ï¼Œåšå¸¦æƒçš„é˜Ÿåˆ—ï¼Œå¦‚ï¼šæ™®é€šçš„ä¿¡æ¯çš„æƒé‡ä¸º1ï¼Œé‡è¦çš„ä¿¡æ¯çš„æƒé‡ä¸º2ï¼Œ åº”ç”¨çº¿ç¨‹å¯ä»¥æ ¹æ®æƒé‡è°ƒç”¨ã€‚  å‚è€ƒæ–‡çŒ®ï¼š Redisåº•å±‚æ•°æ®ç»“æ„è¯¦è§£\n","date":"2021-12-05T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E5%88%9D%E8%AF%86redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/2_hu2e0e0d83f63ca97b7bb5a7ad9fe95b5f_87192_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E5%88%9D%E8%AF%86redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/","title":"åˆè¯†redis(æ•°æ®ç»“æ„åˆ†æ)"},{"content":"jwt  jwt å®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘çš„ã€è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨äºä½œä¸ºJSONå¯¹è±¡åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ï¼Œæ˜¯æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯çš„è§£å†³æ–¹æ¡ˆ  ä¼ ç»Ÿè·¨åŸŸè®¤è¯  å®¢æœç«¯å‘æœåŠ¡å™¨å‘é€ç”¨ç”¨æˆ·åå’Œå¯†ç ï¼ŒæœåŠ¡å™¨éªŒè¯é€šè¿‡åï¼ŒæŠŠå½“å‰å¯¹è¯çš„sessioné‡Œä¿å­˜ ç›¸å…³æ•°æ®ï¼Œå¹¶å†™åœ¨å®¢æˆ·ç«¯çš„cookie, å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªsession idã€‚å®¢æˆ·ç«¯å†æ¬¡é€šè¿‡cookie, ç»session id ä¼ å›æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨é€šè¿‡session idå¾—çŸ¥è®¿é—®å®¢æˆ·ç«¯çš„èº«ä»½ã€‚ å­˜åœ¨çš„é—®é¢˜ï¼šæ‰©å±•æ€§ä¸ä½³ï¼ŒæœåŠ¡å™¨é›†ç¾¤æˆ–è€…è·¨åŸŸçš„æœåŠ¡å¯¼å‘æ¶æ„ï¼Œå°±éœ€è¦å…±äº«sessionå…±äº«æ•°æ® è§£å†³æ–¹æ¡ˆï¼š1. å°†session æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­æˆ–è€…å…¶ä»–çš„æŒä¹…å±‚ï¼ŒæœåŠ¡å™¨è®¿é—®æŒä¹…å±‚çš„sessionæ•°æ® 2. æœåŠ¡å™¨ä¸ä¿å­˜sessionæ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å‘å›æœåŠ¡å™¨  jwtçš„åŸç†  æœåŠ¡å™¨è®¤è¯ä»¥åï¼Œç”Ÿæˆä¸€ä¸ªjsonå¯¹è±¡ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä¹‹åï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é è¿™ä¸ªjsonå¯¹è±¡è®¤è¯ï¼Œä¼šä¼š åŠ ä¸Šç­¾åæ¥é˜²æ­¢å®¢æˆ·ç«¯ä¿®è¯¥json å¯¹è±¡  jwtçš„æ•°æ®ç»“æ„  jwtçš„æ•°æ®ç»“æ„ä¸ºï¼šHeader(å¤´éƒ¨)ã€payload(è´Ÿè½½)ã€signature(ç­¾å)\n\r  Header(å¤´éƒ¨)  Headeréƒ¨åˆ†æ˜¯ä¸€ä¸ªjsonå¯¹è±¡ï¼Œæè¿°jwtçš„å…ƒç´ æ®ã€‚å£°æ˜ç±»å‹ï¼Œè¿™é‡Œæ˜¯jwtå£°æ˜åŠ å¯†çš„ç®—æ³• é€šå¸¸ç›´æ¥ä½¿ç”¨ HMAC SHA256ï¼Œç»“æ„å¦‚ä¸‹ï¼š  { 'typ': 'JWT', 'alg': 'HS256' } payload(è´Ÿè½½)  payload ä¹Ÿæ˜¯ä¸€ä¸ªjsonå¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦çš„ä¼ é€’çš„æ•°æ®ï¼Œissï¼šå‘è¡Œäººï¼Œexpï¼šåˆ°æœŸæ—¶é—´ï¼Œsubï¼šä¸»é¢˜ï¼Œaudï¼šç”¨æˆ·ï¼Œ nbfï¼šåœ¨æ­¤ä¹‹å‰ä¸å¯ç”¨ï¼Œiatï¼šå‘å¸ƒæ—¶é—´ï¼Œjtiï¼šJWT IDç”¨äºæ ‡è¯†è¯¥JWT  { \u0026quot;sub\u0026quot;: \u0026quot;1234567890\u0026quot;, \u0026quot;name\u0026quot;: \u0026quot;John Doe\u0026quot;, \u0026quot;admin\u0026quot;: true } signature(ç­¾å)  æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†è¿›è¡Œç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹ã€‚åœ¨æœåŠ¡å™¨ä¸ŠæŒ‡æ˜ä¸€ä¸ªå¯†é’¥ï¼Œåœ¨æ ¹æ®headerä¸­æŒ‡å®šçš„ç®—æ³•ï¼Œ æŒ‰ç…§æ ¼å¼äº§ç”Ÿç­¾åï¼Œheader (base64åçš„)ã€payload (base64åçš„)ã€secretã€‚å…¶æ ¼å¼å¦‚ä¸‹ï¼š  // javascript var encodedString = base64UrlEncode(header) + '.' + base64UrlEncode(payload); var signature = HMACSHA256(encodedString, 'secret'); // TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ jwtçš„ç‰¹ç‚¹  jwté»˜è®¤ä¸åŠ å¯†ï¼Œä½†æ˜¯å¯ä»¥å¯¹åŸç”Ÿçš„TokenåŠ å¯†æˆ–è€…ä½¿ç”¨httpsåŠ å¯†ä¼ è¾“ jwtåœ¨ä¸åŠ å¯†çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½åŠ ç§˜å¯†æ•°æ®å†™å…¥jwt jwtä¸ä»…å¯ä»¥ä½¿ç”¨ä¸è®¤è¯ï¼Œä¹Ÿèƒ½ç”¨äºä¿¡æ¯çš„äº¤æ¢ jwtä¸èƒ½åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ¸…é™¤è«ä¸€ä¸ªtokenå’Œæ›´æ”¹è¯¥tokençš„æƒé™ï¼Œä¸€æ—¦ç­¾å‘ä¸€ç›´åˆ°åˆ°æœŸéƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œåº”è¯¥jwt çš„æœ‰æ•ˆæœŸ  è®¤è¯  è®¤è¯å°±æ˜¯æ ¹æ®å£°æ˜è€…æ‰€æŒæœ‰çš„è¯†åˆ«ä¿¡æ¯ï¼Œç¡®è®¤å£°æ˜è€…çš„èº«ä»½  æˆæƒ  ä¸€èˆ¬æ˜¯æŒ‡è·å–ç”¨æˆ·çš„å§”æ´¾çš„æƒé™  é‰´æƒ  æŒ‡å¯¹ä¸€ä¸ªå£°æ˜è€…æ‰€å£°æ˜çš„èº«ä»½çš„æƒé™çš„çœŸå®æ€§è¿›è¡Œé‰´åˆ«å’Œç¡®è®¤çš„è¿‡ç¨‹  æƒé™æ§åˆ¶  æ˜¯æŒ‡å¯æ‰§è¡Œå’Œæ“ä½œçš„ç»„åˆé…ç½®çš„æƒé™åˆ—è¡¨ï¼Œç„¶åæ ¹æ®æ‰§è¡Œè€…çš„æƒé™ï¼Œè‹¥å…¶æ“ä½œåœ¨æƒé™èŒƒå›´å†…ï¼Œåˆ™å…è®¸æ‰§è¡Œï¼Œå¦åˆ™ç¦æ­¢  å‚è€ƒæ–‡çŒ®ï¼š ä»€ä¹ˆæ˜¯ JWT \u0026ndash; JSON WEB TOKEN\n","date":"2021-11-30T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E5%88%9D%E6%8E%A2jwtjson-web-token/1_hu679d1d76db059750024901bffb37cf39_65265_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E5%88%9D%E6%8E%A2jwtjson-web-token/","title":"åˆæ¢jwt(json web Token)"},{"content":"Nginx  nginx æ˜¯è½»é‡çº§é«˜å¹¶å‘webæœåŠ¡å™¨ï¼Œæ˜¯åŸºäºRestæ¶æ„é£æ ¼ã€‚é€šè¿‡httpåè®®æä¾›å„ç§ç½‘ç»œæœåŠ¡\nå…¶é«˜å¹¶å‘æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œioå¤šè·¯å¤ç”¨çš„epoll,ä½¿å¾—å¯ä»¥è½»æ¾æ”¯æŒç™¾ä¸‡è®¡çš„icpè¿æ¥ã€‚\nè½»é‡çº§ä¸»è¦ä½“ç°åœ¨ï¼šé‡‡ç”¨æ’ä»¶åŒ–å¼€å‘ï¼Œcupäº²å’Œï¼Œå°†cpuä¸nginxå·¥ä½œè¿›ç¨‹ç»‘å®šï¼Œå‡å°‘cpuåˆ‡æ¢å¸¦æ¥çš„æ¶ˆè€—  ä»£ç†  ä»£ç†æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ä¸€å±‚æœåŠ¡å™¨ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼Œç„¶åæœåŠ¡å™¨çš„å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯  æ­£å‘ä»£ç†  å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨è½¬å‘è¯·æ±‚å’ŒæŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ï¼Œå³å®¢æˆ·ç«¯çŸ¥é“è®¿é—®çš„æ˜¯ç›®æ ‡æœåŠ¡å™¨ï¼Œå¯¹ç›®æ ‡æœåŠ¡å™¨æ¥è¯´æ˜¯éé€æ˜çš„ï¼Œå¹¶ä¸çŸ¥é“è®¿é—®æœåŠ¡å™¨æ˜¯ å®¢æˆ·ç«¯è¿˜æ˜¯ä»£ç†æœåŠ¡å™¨  åå‘ä»£ç†  å®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»£ç†æœåŠ¡å™¨å°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨çš„ç½‘ç»œæœåŠ¡å™¨(ç›®æ ‡æœåŠ¡å™¨)ï¼Œåœ¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¯¹äºå®¢æˆ·ç«¯ æ˜¯éé€æ˜çš„ï¼Œå³å®¢æˆ·ç«¯ä¸æ¸…æ¥šæ˜¯è®¿é—®æ˜¯é‚£ä¸€å°ç›®æ ‡æœåŠ¡å™¨ã€‚å¯¹äºç›®æ ‡æœåŠ¡å™¨æ˜¯é€æ˜çš„ï¼Œå³ç›®æ ‡æœåŠ¡å™¨çŸ¥é“è®¿é—®çš„æ˜¯ ä»£ç†æœåŠ¡å™¨ nginxåå‘ä»£ç†çš„é…ç½®å¦‚ä¸‹ï¼š  server { listen 80; server_name www.123.com; location / { proxy_pass http://127.0.0.1:8080; index index.html index.htm index.jsp; } } æˆ‘ä»¬ç›‘å¬80ç«¯å£ï¼Œè®¿é—®åŸŸåä¸ºwww.123.comï¼Œä¸åŠ ç«¯å£å·æ—¶é»˜è®¤ä¸º80ç«¯å£ï¼Œæ•…è®¿é—®è¯¥åŸŸåæ—¶ä¼šè·³è½¬åˆ°127.0.0.1:8080è·¯å¾„ä¸Š\nè´Ÿè½½å‡è¡¡  å½“è¯·æ±‚è¿‡å¤§æ—¶ï¼Œå°†è¯·æ±‚åˆ†å‘ç»™å„ä¸ªæœåŠ¡å™¨ã€‚è´Ÿè½½å‡è¡¡çš„åˆ†é…ç­–ç•¥ä¸ºï¼šweight(æƒé‡)è½®è¯¢ï¼Œfair(æ™ºèƒ½è°ƒæ•´è°ƒåº¦) nginxè½®è¯¢é…ç½®(æ‰€æœ‰è¯·æ±‚éƒ½æŒ‰ç…§æ—¶é—´é¡ºåºåˆ†é…åˆ°ä¸åŒçš„æœåŠ¡ä¸Š)  upstream dalaoyang-server { server localhost:10001; server localhost:10002; }  nginxæƒé‡é…ç½®(æƒé‡è½®è¯¢ï¼šä»£ç†æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼ŒæŒ‰ç…§è®¾å®šçš„æƒé‡ï¼Œè¯·æ±‚åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœå‘ç°åç«¯æœåŠ¡å™¨å®•æœºæ—¶ï¼Œ ä»£ç†æœåŠ¡å™¨ä¼šå°†å…¶å‰”é™¤å‡ºé˜Ÿåˆ—)  upstream dalaoyang-server { server localhost:10001 weight=1; server localhost:10002 weight=2; }  nginx iphash é…ç½®(æ¯ä¸ªè¯·æ±‚éƒ½æ ¹æ®è®¿é—®ipçš„hashç»“æœåˆ†é…)  upstream dalaoyang-server { ip_hash; server localhost:10001 weight=1; server localhost:10002 weight=2; }  æœ€å°‘è¿æ¥(å°†è¯·æ±‚åˆ†é…åˆ°è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡ä¸Š)  upstream dalaoyang-server { least_conn; server localhost:10001 weight=1; server localhost:10002 weight=2; }  far æ™ºèƒ½è°ƒæ•´è°ƒåº¦ç®—æ³•ï¼šåŠ¨æ€æ ¹æ®åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤„ç†åˆ°å“åº”æ—¶é—´è¿›è¡Œå‡è¡¡åˆ†é…ã€‚å³å“åº”æ—¶é—´çŸ­ï¼Œå¤„ç†æ•ˆç‡é«˜çš„æœåŠ¡å™¨ åˆ†é…åˆ°è¯·æ±‚çš„æ¦‚ç‡é«˜ã€‚å“åº”æ—¶é—´é•¿ï¼Œæ•ˆç‡ä½çš„æœåŠ¡å™¨åˆ†é…åˆ°è¯·æ±‚çš„æ¦‚ç‡ä½ã€‚ far é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š  upstream dalaoyang-server { server localhost:10001 weight=1; server localhost:10002 weight=2; fair; } æµé‡æ§åˆ¶  é™æµå®é™…å°±æ˜¯é™åˆ¶æµå…¥è¯·æ±‚çš„æ•°é‡ï¼šæœ‰è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•ã€ä»¤ç‰Œæ¡¶ç®—æ³•ã€æ¼æ¡¶ç®—æ³•å’Œé™åˆ¶å¹¶å‘è¿æ¥æ•°é™åˆ¶\nä»¤ç‰Œæ¡¶ç®—æ³•:å­˜åœ¨ä¸€ä¸ªå¤§å°å›ºå®šçš„ä»¤ç‰Œæ¡¶ï¼Œä¼šä»¥æ’å®šçš„é€Ÿç‡æºæºä¸æ–­äº§ç”Ÿä»¤ç‰Œã€‚å¦‚æœä»¤ç‰Œæ¶ˆè€—é€Ÿç‡å°äºç”Ÿäº§ä»¤ç‰Œçš„é€Ÿåº¦ï¼Œ ä»¤ç‰Œå°±ä¼šä¸€ç›´äº§ç”Ÿç›´è‡³è£…æ»¡æ•´ä¸ªä»¤ç‰Œæ¡¶ã€‚å¦‚æœè¯·æ±‚è·å–ä»¤ç‰Œå¤±è´¥åˆ™è¯·æ±‚ä¼šè¢«ç¦æ­¢è®¿é—®\n\r æ¼æ¡¶ç®—æ³•:çªå‘æµé‡ä¼šè¿›å…¥åˆ°ä¸€ä¸ªæ¼æ¡¶ï¼Œæ¼æ¡¶ä¼šæŒ‰ç…§æˆ‘ä»¬å®šä¹‰çš„é€Ÿç‡ä¾æ¬¡å¤„ç†è¯·æ±‚ï¼Œå¦‚æœæ°´æµè¿‡å¤§ä¹Ÿå°±æ˜¯çªå‘æµé‡è¿‡å¤§å°±ä¼šç›´æ¥æº¢å‡ºï¼Œ åˆ™å¤šä½™çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚æ‰€ä»¥æ¼æ¡¶ç®—æ³•èƒ½æ§åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚ç®—æ³•çš„æ ¸å¿ƒæ˜¯ï¼šç¼“å­˜è¯·æ±‚ã€åŒ€é€Ÿå¤„ç†ã€å¤šä½™çš„è¯·æ±‚ç›´æ¥ä¸¢å¼ƒã€‚\n\r  ç»Ÿä¸€é‰´æƒ  å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå°†Tokenæ”¾å…¥åœ¨è¯·æ±‚å¤´headä¸­ã€‚æœåŠ¡å™¨è§£æToken,å¯¹è®¿é—®è€…éƒ½è¿›è¡Œé‰´æƒï¼Œæœ€åè¿›å…¥æƒåŠ›è®¿é—®  ä¸»æµçš„ç½‘å…³  Hongï¼šæ˜¯åŸºäºnginx+luaå¼€æºçš„ç½‘å…³ Traefikæ˜¯httpåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œè¾ƒå¥½çš„ä¼¸ç¼©æ€§ kubernetesæ˜¯åŸºäºEnvog Proxyæ„å»ºçš„åŸç”Ÿk8sç½‘å…³  å‚è€ƒæ–‡çŒ®ï¼š Nginxï¼ˆä¸‰ï¼‰nginx åå‘ä»£ç† \n","date":"2021-11-24T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E5%88%9D%E8%AF%86nginx/1_hu3f3721f37acfbb79e3bc6e8d69d34816_28729_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/%E5%88%9D%E8%AF%86nginx/","title":"åˆè¯†Nginx"},{"content":"HTTP  HTTPæ˜¯(Hyper Text Transfer Protocol)è¶…æ–‡æœ¬ä¼ è¾“åè®®, åŸºäºtcpçš„åº”ç”¨å±‚ä¼ è¾“åè®®ï¼ˆè¯·æ±‚-å“åº”ï¼‰åè®® å½±å“HTTPç½‘ç»œè¯·æ±‚çš„ä¸»è¦å› ç´ å¸¦å®½å’Œå»¶è¿Ÿ  å»¶è¿Ÿçš„ç§ç±»:  æµè§ˆå™¨é˜»å¡(è¶…è¿‡æµè§ˆå™¨è¿æ¥æ•°é™åˆ¶çš„åç»­è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡) DNSæŸ¥è¯¢ (å°†åŸŸåè§£æé€ æˆçš„å»¶è¿Ÿï¼Œå¯ä»¥é€šè¿‡ç¼“å­˜DNSè¿›è¡Œè§£å†³) å»ºç«‹é“¾æ¥ (å› HTTPæ˜¯åŸºäºTCPçš„åº”ç”¨å±‚åè®®ï¼Œåœ¨å»ºç«‹è¿æ¥æ—¶éœ€è¦è¿›è¡Œ)  HTTP1.0 http1.0å­˜åœ¨çš„é—®é¢˜ï¼š  çŸ­è¿æ¥ï¼šè§„å®šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åªä¿æŒçŸ­æš‚è¿æ¥ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨å®Œæˆè¯·æ±‚å æ–­å¼€è¿æ¥ï¼ŒæœåŠ¡å™¨ä¸è·Ÿè¸ªå®¢æˆ·ç«¯ï¼Œä¸ä¿å­˜å®¢æˆ·ç«¯çš„è¯·æ±‚è®°å½•ã€‚ æ²¡æœ‰hostå¤´åŸŸï¼šæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œè¯·æ±‚æ¶ˆæ¯ä¸­çš„URLå¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåï¼ˆhostnameï¼‰ ä¸å…è®¸çŸ­ç‚¹ç»­ä¼   HTTP1.1 æ ¹æ®http1.0æš´éœ²çš„é—®é¢˜ï¼Œhttp1.1å¢åŠ ä¼˜åŒ–æ–¹æ¡ˆ  ç¼“å­˜å¤„ç†ï¼šhttp1.1å¢åŠ æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ å¸¦å®½ä¼˜åŒ–åŠç½‘ç»œè¿æ¥çš„ä½¿ç”¨ï¼šhttp1.1ä¸­è¯·æ±‚å¤´å¼•å…¥äº†rangeå¤´åŸŸå’Œæ”¯æŒæ–­ç‚¹ç»­ä¼ çš„åŠŸèƒ½ Hostå¤´å¤„ç†ï¼šhttp1.1çš„è¯·æ±‚æ¶ˆæ¯å’Œç›¸åº”æ¶ˆæ¯è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœº(Multi-homed Web Servers),å¹¶ä¸”å®ƒä»¬å…±äº«ä¸€ä¸ªIPåœ°å€,HTTP1.1çš„è¯·æ±‚æ¶ˆæ¯å’Œå“åº”æ¶ˆæ¯éƒ½åº”æ”¯æŒHostå¤´åŸŸï¼Œä¸”è¯·æ±‚æ¶ˆæ¯ä¸­å¦‚æœæ²¡æœ‰Hostå¤´åŸŸä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼ˆ400 Bad Requestï¼‰ é•¿è¿æ¥ï¼š æ”¯æŒé•¿è¿æ¥å’Œæµæ°´çº¿å¤„ç†ï¼Œé»˜è®¤å¼€å§‹æ˜¯é•¿è¿æ¥ï¼škeep-alive  http1.1 ä¹Ÿå¸¦æ¥æ–°çš„é—®é¢˜ï¼šHTTP é˜Ÿå¤´é˜»å¡(head of line blocking)  å› http1.1æ”¯æŒäº†é•¿è¿æ¥å’Œä½¿ç”¨äº†ç®¡é“æœºåˆ¶ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¸ç”¨ç­‰å¾…æœåŠ¡å™¨å“åº”å°±èƒ½å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œæ”¯æŒäº†å¹¶è¡Œå‘é€å¤šä¸ªè¯·æ±‚ï¼Œ ä½†æœåŠ¡å™¨å¿…é¡»æŒ‰ç…§è¯·æ±‚çš„é¡ºåºæ¥ç›¸åº”è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä¸²è¡Œå“åº”è¯·æ±‚ï¼Œè¿™å°±é€ æˆäº†HTTPçš„é˜Ÿå¤´é˜»å¡ã€‚  è§£å†³Http é˜Ÿå¤´é˜»å¡æ–¹æ³•  å¹¶å‘è¿æ¥ï¼šä¸€ä¸ªåŸŸåå…è®¸åˆ†é…å¤šä¸ªé•¿è¿æ¥ï¼Œå¢åŠ å¤„ç†è¯·æ±‚ä»»åŠ¡ åŸŸååˆ†ç‰‡ï¼šå°†ä¸€ä¸ªåŸŸååˆ†è§£ä¸ºå¤šä¸ªåŸŸåï¼Œåœ¨è¿›è¡Œå¹¶å‘è¿æ¥  HTTP2.0  HTTP2.0ä¸»è¦æ˜¯åŸºäºSPDYåè®®ã€‚å®ç°äº†ä½å»¶æ—¶é«˜ååé‡  SPDYåè®®  æ˜¯åŸºäºTCPåè®®çš„åº”ç”¨å±‚åè®®ï¼Œå…¶ç›®æ ‡æ˜¯é€šè¿‡å¤´éƒ¨å‹ç¼©ã€å¤šè·¯å¤ç”¨ã€ä¼˜å…ˆçº§ç­‰ä½œç”¨ç¼©çŸ­ç½‘é¡µæ”¾å…¥åŠ è½½æ—¶é—´å’Œ ä¼˜åŒ–httpçš„æ€§èƒ½ï¼Œå…¶æ ¸å¿ƒæ˜¯å°½é‡å‡å°‘TCPè¿æ¥æ•°  HTTP 2.0çš„ç‰¹æ€§ å¤´éƒ¨å‹ç¼© å¤´éƒ¨å­˜åœ¨å¤§é‡çš„ä¿¡æ¯ï¼Œè€Œä¸”æ¯æ¬¡åœ¨å‘é€éƒ½ä¼šé™ä½httpçš„æ€§èƒ½ï¼Œåœ¨ç”¨HPACKç®—æ³•å¯¹å¤´éƒ¨è¿›è¡Œå‹ç¼©ï¼š 1.åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç»´æŒä¸€ä¸ªå¤´éƒ¨è¡¨æ¥è·Ÿè¸ªå’Œå­˜å‚¨å®¢æˆ·ç«¯å‘æ¥çš„é”®å€¼å¯¹ 2.å®¢æˆ·ç«¯åœ¨è¯·æ±‚çš„æ—¶å€™ä¾¿åªéœ€è¦å‘é€åœ¨è¡¨é‡Œçš„ç´¢å¼•ä½ç½®å³å¯ 3.HPACK ä¸ä»…ä»…é€šè¿‡ç´¢å¼•é”®å€¼å¯¹æ¥é™ä½æ•°æ®é‡ï¼ŒåŒæ—¶è¿˜ä¼šå°†å­—ç¬¦ä¸²è¿›è¡Œéœå¤«æ›¼ç¼–ç æ¥å‹ç¼©å­—ç¬¦ä¸²å¤§å° \r\nå¤šè·¯å¤ç”¨  åŸºäºäºŒè¿›åˆ¶åˆ†å¸§ï¼Œåœ¨å…±äº«çš„Tcpè¿æ¥çš„åŸºç¡€ä¸ŠåŒæ—¶å‘é€è¯·æ±‚å’Œå“åº”ã€‚httpçš„æ¶ˆæ¯è¢«åˆ†è§£æˆç‹¬ç«‹çš„å¸§å±‚ï¼Œäº¤é”™å‘å‡º é€šè¿‡æµæ ‡è¯†ç¬¦å’Œé¦–éƒ¨å°†ä»–ä»¬é‡æ–°ç»„è£…èµ·æ¥ï¼Œé¿å…äº†é˜Ÿå¤´é˜»å¡å’Œæé«˜äº†ä¼ è¾“çš„æ€§èƒ½ \r  äºŒè¿›åˆ¶åˆ†å¸§  ç»httpæŠ¥æ–‡æ ¼å¼è½¬æ¢æˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œå…¨éƒ¨çš„ioä¸²ã€‚å°†åŸæ¥çš„headerçš„æŠ¥æ–‡åˆ†æˆäºŒè¿›åˆ¶å¸§æ²‰åœ¨çš„å¤´éƒ¨å­—æ®µï¼Œ bodyè¢«æ‹†åˆ†æˆäºŒè¿›åˆ¶å¸§å­˜æ”¾åœ¨è¯·æ±‚ä½“æ•°æ®æ®µã€‚æœåŠ¡å™¨æ¥æ”¶çš„ä¸æ˜¯httpæŠ¥æ–‡ï¼Œè€Œæ˜¯äºŒè¿›åˆ¶å¸§ã€‚ å¸§(frame)åŒ…å«éƒ¨åˆ†ï¼šç±»å‹Type, é•¿åº¦Length, æ ‡è®°Flags, æµæ ‡è¯†Streamå’Œframe payloadæœ‰æ•ˆè½½è·ã€‚ æ¶ˆæ¯(message)ï¼šä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚æˆ–è€…å“åº”ï¼Œæ¯”å¦‚è¯·æ±‚ã€å“åº”ç­‰ï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ª Frame ç»„æˆã€‚ æµæ˜¯è¿æ¥ä¸­çš„ä¸€ä¸ªè™šæ‹Ÿä¿¡é“ï¼Œå¯ä»¥æ‰¿è½½åŒå‘æ¶ˆæ¯ä¼ è¾“ã€‚æ¯ä¸ªæµæœ‰å”¯ä¸€æ•´æ•°æ ‡è¯†ç¬¦ã€‚ä¸ºäº†é˜²æ­¢ä¸¤ç«¯æµIDå†²çªï¼Œå®¢æˆ·ç«¯å‘èµ·çš„æµå…·æœ‰å¥‡æ•°IDï¼ŒæœåŠ¡å™¨ç«¯å‘èµ·çš„æµå…·æœ‰å¶æ•°IDã€‚ æµæ ‡è¯†æ˜¯æè¿°äºŒè¿›åˆ¶frameçš„æ ¼å¼ï¼Œä½¿å¾—æ¯ä¸ªframeèƒ½å¤ŸåŸºäºhttp2å‘é€ï¼Œä¸æµæ ‡è¯†è”ç³»çš„æ˜¯ä¸€ä¸ªæµï¼Œæ¯ä¸ªæµæ˜¯ä¸€ä¸ªé€»è¾‘è”ç³»ï¼Œä¸€ä¸ªç‹¬ç«‹çš„åŒå‘çš„frameå­˜åœ¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´çš„http2è¿æ¥ä¸­ã€‚ä¸€ä¸ªhttp2è¿æ¥ä¸Šå¯åŒ…å«å¤šä¸ªå¹¶å‘æ‰“å¼€çš„æµï¼Œè¿™ä¸ªå¹¶å‘æµçš„æ•°é‡èƒ½å¤Ÿç”±å®¢æˆ·ç«¯è®¾ç½®ã€‚  \r\näºŒè¿›åˆ¶åˆ†å¸§çš„ç‰¹æ€§  å¹¶å‘æ€§ï¼šåŒæ—¶å¯å‘å¤šä¸ªå¸§ è‡ªå¢æ€§ï¼šæµçš„idä¸å¯é‡ç”¨ï¼ŒæŒ‰é¡ºåºé€’å¢ï¼Œåˆ°é˜ˆå€¼åç½®é›¶ åŒå‘æ€§ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯éƒ½å¯åˆ°æµï¼Œäº’ä¸å¹²æ‰°ï¼Œéƒ½å¯æ”¶å‘ å¯è®¾ä¼˜å…ˆçº§ï¼šè®¾ç½®å¸§çš„ä¼˜å…ˆçº§ï¼ŒæœåŠ¡å™¨ä¼˜å…ˆå¤„ç†  æœåŠ¡å™¨æ¨é€  æœåŠ¡å™¨ä¸åœ¨æ˜¯å®Œå…¨è¢«åŠ¨çš„æ¥æ”¶å’Œå“åº”è¯·æ±‚ï¼Œä¹Ÿèƒ½åˆ›å»ºæ–°çš„èµ„æº(æµ)å‘é€ç»™å®¢æˆ·ç«¯ã€‚ æœåŠ¡å™¨å¯ä»¥å¯¹ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å‘é€å¤šä¸ªå“åº”ï¼ŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€èµ„æºæ— éœ€å®¢æˆ·ç«¯æ˜ç¡®åœ°è¯·æ±‚ã€‚ å¹¶ä¸”ï¼ŒæœåŠ¡ç«¯æ¨é€èƒ½æŠŠå®¢æˆ·ç«¯æ‰€éœ€è¦çš„èµ„æºä¼´éšç€index.htmlä¸€èµ·å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œçœå»äº†å®¢æˆ·ç«¯é‡å¤è¯·æ±‚çš„æ­¥éª¤ã€‚ å½“æœåŠ¡ç«¯éœ€è¦ä¸»åŠ¨æ¨é€æŸä¸ªèµ„æºæ—¶ï¼Œä¾¿ä¼šå‘é€ä¸€ä¸ª Frame Type ä¸º PUSH_PROMISE çš„ Frameï¼Œé‡Œé¢å¸¦äº† PUSH éœ€è¦æ–°å»ºçš„ Stream IDã€‚ æ„æ€æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯ï¼šæ¥ä¸‹æ¥æˆ‘è¦ç”¨è¿™ä¸ª ID å‘ä½ å‘é€ä¸œè¥¿ï¼Œå®¢æˆ·ç«¯å‡†å¤‡å¥½æ¥ç€ã€‚å®¢æˆ·ç«¯è§£æ Frame æ—¶ï¼Œå‘ç°å®ƒæ˜¯ä¸€ä¸ª PUSH_PROMISE ç±»å‹ï¼Œ ä¾¿ä¼šå‡†å¤‡æ¥æ”¶æœåŠ¡ç«¯è¦æ¨é€çš„æµã€‚  \r\nè¯·æ±‚ä¼˜å…ˆçº§  é€šè¿‡è®¾ç½®å¸§çš„ä¼˜å…ˆçº§ï¼Œä¼˜åŒ–å¸§çš„ä¼ è¾“é¡ºåº æŠŠhttpæ¶ˆæ¯åˆ†ä¸ºå¾ˆå¤šç‹¬ç«‹å¸§ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ä¼˜åŒ–è¿™äº›å¸§çš„äº¤é”™å’Œä¼ è¾“é¡ºåºè¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ã€‚æ¯ä¸ªæµéƒ½å¯ä»¥å¸¦æœ‰ä¸€ä¸ª31æ¯”ç‰¹çš„ä¼˜å…ˆå€¼ï¼š0 è¡¨ç¤ºæœ€é«˜ä¼˜å…ˆçº§ï¼›2çš„31æ¬¡æ–¹-1 è¡¨ç¤ºæœ€ä½ä¼˜å…ˆçº§ã€‚ æœåŠ¡å™¨å¯ä»¥æ ¹æ®æµçš„ä¼˜å…ˆçº§ï¼Œæ§åˆ¶èµ„æºåˆ†é…ï¼ˆCPUã€å†…å­˜ã€å¸¦å®½ï¼‰ï¼Œè€Œåœ¨å“åº”æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œä¼˜å…ˆå°†æœ€é«˜ä¼˜å…ˆçº§çš„å¸§å‘é€ç»™å®¢æˆ·ç«¯ã€‚é«˜ä¼˜å…ˆçº§çš„æµéƒ½åº”è¯¥ä¼˜å…ˆå‘é€ï¼Œä½†åˆä¸ä¼šç»å¯¹çš„ã€‚ç»å¯¹åœ°å‡†å®ˆï¼Œå¯èƒ½åˆä¼šå¼•å…¥é¦–é˜Ÿé˜»å¡çš„é—®é¢˜ï¼šé«˜ä¼˜å…ˆçº§çš„è¯·æ±‚æ…¢å¯¼è‡´é˜»å¡å…¶ä»–èµ„æºäº¤ä»˜ã€‚ 4.åˆ†é…å¤„ç†èµ„æºå’Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é—´çš„å¸¦å®½ï¼Œä¸åŒä¼˜å…ˆçº§çš„æ··åˆä¹Ÿæ˜¯å¿…é¡»çš„ã€‚å®¢æˆ·ç«¯ä¼šæŒ‡å®šå“ªä¸ªæµæ˜¯æœ€é‡è¦çš„ï¼Œæœ‰ä¸€äº›ä¾èµ–å‚æ•°ï¼Œè¿™æ ·ä¸€ä¸ªæµå¯ä»¥ä¾èµ–å¦å¤–ä¸€ä¸ªæµã€‚ä¼˜å…ˆçº§åˆ«å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ”¹å˜ï¼Œå½“ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œå¯ä»¥å‘Šè¯‰æµè§ˆå™¨å“ªä¸ªå›¾åƒæ˜¯æœ€é‡è¦çš„ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ä¸€ç»„æµä¸­è¿›è¡Œä¼˜å…ˆç­›é€‰ï¼Œèƒ½å¤Ÿçªç„¶æŠ“ä½é‡ç‚¹æµã€‚  ä¼˜å…ˆçº§ç­‰çº§ï¼š  ä¼˜å…ˆçº§æœ€é«˜ï¼šä¸»è¦çš„html ä¼˜å…ˆçº§é«˜ï¼šCSSæ–‡ä»¶ ä¼˜å…ˆçº§ä¸­ï¼šjsæ–‡ä»¶ ä¼˜å…ˆçº§ä½ï¼šå›¾ç‰‡  å‚è€ƒæ–‡çŒ®ï¼š ","date":"2021-11-18T22:00:38+08:00","image":"https://zcj-git520.github.io/p/http%E5%8D%8F%E8%AE%AE%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/1_hu7de10a5ba4c09963d2757d75c9451326_29719_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/http%E5%8D%8F%E8%AE%AE%E5%BA%95%E5%B1%82%E5%88%86%E6%9E%90/","title":"httpåè®®åº•å±‚åˆ†æ"},{"content":"RPC  RPC(Remote Procedure Call Protocol)â€”â€”è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œå®ƒæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œ è€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚RPCåè®®å‡å®šæŸäº›ä¼ è¾“åè®®çš„å­˜åœ¨ï¼Œå¦‚TCP/IPæˆ–UDPï¼Œä¸ºé€šä¿¡ç¨‹åºä¹‹é—´æºå¸¦ä¿¡æ¯æ•°æ®ã€‚ RPCå°†åŸæ¥çš„æœ¬åœ°è°ƒç”¨è½¬å˜ä¸ºè°ƒç”¨è¿œç«¯çš„æœåŠ¡å™¨ä¸Šçš„æ–¹æ³•ï¼Œç»™ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›å’Œååé‡å¸¦æ¥äº†è¿‘ä¼¼äºæ— é™åˆ¶æå‡çš„å¯èƒ½ã€‚ åœ¨OSIç½‘ç»œé€šä¿¡æ¨¡å‹ä¸­ï¼ŒRPCè·¨åŸŸäº†ä¼ è¾“å±‚å’Œåº”ç”¨å±‚ã€‚RPCä½¿å¾—å¼€å‘åŒ…æ‹¬ç½‘ç»œåˆ†å¸ƒå¼å¤šç¨‹åºåœ¨å†…çš„åº”ç”¨ç¨‹åºæ›´åŠ å®¹æ˜“ RPCé‡‡ç”¨å®¢æˆ·æœº/æœåŠ¡å™¨(client-server)æ¨¡å¼,ä¹Ÿæ˜¯ä¸€ç§è¯·æ±‚/å“åº”(request-response)æ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡TCP/UDPä»¥åŠHTTP åè®®è¿›è¡Œä¼ è¾“  RPC æ¶æ„  CAll ID æ˜ å°„ï¼šå®¢æˆ·ç«¯é€šè¿‡IDä¼ è¾“ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨é€šè¿‡IDè°ƒç”¨ç›¸åº”çš„å‡½æ•°è¿”å› åºåˆ—åŒ–ä¸çƒ¦åºåˆ—åŒ–ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šè¿‡åºåˆ—åŒ–ä¸ååºåˆ—åŒ–è¿›è¡Œä¼ å‚ ä¸€ä¸ªå®Œæ•´çš„RPCæ¶æ„é‡Œé¢åŒ…å«äº†å››ä¸ªæ ¸å¿ƒçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯Clientï¼ŒClient Stubï¼ŒServerä»¥åŠServer Stubï¼Œè¿™ä¸ªStubå¯ä»¥ç†è§£ä¸ºå­˜æ ¹ã€‚   å®¢æˆ·ç«¯(Client)ï¼ŒæœåŠ¡çš„è°ƒç”¨æ–¹ã€‚ å®¢æˆ·ç«¯å­˜æ ¹(Client Stub)ï¼Œå­˜æ”¾æœåŠ¡ç«¯çš„åœ°å€æ¶ˆæ¯ï¼Œå†å°†å®¢æˆ·ç«¯çš„è¯·æ±‚å‚æ•°æ‰“åŒ…æˆç½‘ç»œæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç½‘ç»œè¿œç¨‹å‘é€ç»™æœåŠ¡æ–¹ã€‚ æœåŠ¡ç«¯(Server)ï¼ŒçœŸæ­£çš„æœåŠ¡æä¾›è€…ã€‚ æœåŠ¡ç«¯å­˜æ ¹(Server Stub)ï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯è§£åŒ…ï¼Œå¹¶è°ƒç”¨æœ¬åœ°çš„æ–¹æ³•ã€‚  RPCè°ƒç”¨è¿‡ç¨‹  å®¢æˆ·ç«¯ï¼ˆclientï¼‰ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼ï¼ˆå³ä»¥æ¥å£çš„æ–¹å¼ï¼‰è°ƒç”¨æœåŠ¡ï¼› å®¢æˆ·ç«¯å­˜æ ¹ï¼ˆclient stubï¼‰æ¥æ”¶åˆ°è°ƒç”¨åï¼Œè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼ˆå°†æ¶ˆæ¯ä½“å¯¹è±¡åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶ï¼‰ï¼› å®¢æˆ·ç«¯é€šè¿‡socketså°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼› æœåŠ¡ç«¯å­˜æ ¹( server stubï¼‰æ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç ï¼ˆå°†æ¶ˆæ¯å¯¹è±¡ååºåˆ—åŒ–ï¼‰ï¼› æœåŠ¡ç«¯å­˜æ ¹( server stubï¼‰æ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡ï¼› æœ¬åœ°æœåŠ¡æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›ç»™æœåŠ¡ç«¯å­˜æ ¹( server stubï¼‰ï¼› æœåŠ¡ç«¯å­˜æ ¹( server stubï¼‰å°†è¿”å›ç»“æœæ‰“åŒ…æˆæ¶ˆæ¯ï¼ˆå°†ç»“æœæ¶ˆæ¯å¯¹è±¡åºåˆ—åŒ–ï¼‰ï¼› æœåŠ¡ç«¯ï¼ˆserverï¼‰é€šè¿‡socketså°†æ¶ˆæ¯å‘é€åˆ°å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯å­˜æ ¹ï¼ˆclient stubï¼‰æ¥æ”¶åˆ°ç»“æœæ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œè§£ç ï¼ˆå°†ç»“æœæ¶ˆæ¯å‘åºåˆ—åŒ–ï¼‰ï¼› å®¢æˆ·ç«¯ï¼ˆclientï¼‰å¾—åˆ°æœ€ç»ˆç»“æœã€‚\nRPCçš„ç›®æ ‡æ˜¯è¦æŠŠ2ã€3ã€4ã€7ã€8ã€9è¿™äº›æ­¥éª¤éƒ½å°è£…èµ·æ¥ã€‚   æ³¨æ„ï¼šæ— è®ºæ˜¯ä½•ç§ç±»å‹çš„æ•°æ®ï¼Œæœ€ç»ˆéƒ½éœ€è¦è½¬æ¢æˆäºŒè¿›åˆ¶æµåœ¨ç½‘ç»œä¸Šè¿›è¡Œä¼ è¾“ï¼Œæ•°æ®çš„å‘é€æ–¹éœ€è¦å°†å¯¹è±¡è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµï¼Œè€Œæ•°æ®çš„æ¥æ”¶æ–¹åˆ™éœ€è¦æŠŠäºŒè¿›åˆ¶æµå†æ¢å¤ä¸ºå¯¹è±¡ã€‚ \r  gPRC  gRPC æ˜¯ä¸€ç§ç°ä»£å¼€æºé«˜æ€§èƒ½è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ (RPC) æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œã€‚å®ƒå¯ä»¥é€šè¿‡å¯¹è´Ÿè½½å¹³è¡¡ã€è·Ÿè¸ªã€å¥åº·æ£€æŸ¥å’Œèº«ä»½éªŒè¯çš„å¯æ’æ‹”æ”¯æŒï¼Œæœ‰æ•ˆåœ°è¿æ¥æ•°æ®ä¸­å¿ƒå†…å’Œæ•°æ®ä¸­å¿ƒä¹‹é—´çš„æœåŠ¡ã€‚å®ƒè¿˜é€‚ç”¨äºåˆ†å¸ƒå¼è®¡ç®—çš„æœ€åä¸€è‹±é‡Œï¼Œå°†è®¾å¤‡ã€ç§»åŠ¨åº”ç”¨ç¨‹åºå’Œæµè§ˆå™¨è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚ gRPC æ˜¯åŸºäºHTTP2.0(å¤šè·¯å¤ç”¨,æ¶ˆé™¤äº†çº¿å¤´é˜»å¡)æ ‡å‡†åè®®è‰²è®¾è®¡çš„åŸºäºProtoBufåºåˆ—åŒ–çš„é«˜æ€§èƒ½æ¡†æ¶ã€‚ ã€ŠgRPC å®˜æ–¹æ–‡æ¡£ä¸­æ–‡ç‰ˆã€‹  Protocol Buffers  Protocol Buffers æ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–ï¼Œå¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ– RPC æ•°æ®äº¤æ¢æ ¼å¼ã€‚å®ƒå¯ç”¨äºé€šè®¯åè®®ã€æ•°æ®å­˜å‚¨ç­‰é¢†åŸŸçš„è¯­è¨€æ— å…³ã€å¹³å°æ— å…³ã€å¯æ‰©å±•çš„åºåˆ—åŒ–ç»“æ„æ•°æ®æ ¼å¼ åºåˆ—åŒ–ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆèƒ½è¢«ä¼ è¾“æˆ–è€…å­˜å‚¨ï¼ˆå¦‚äºŒè¿›åˆ¶æ ¼å¼ï¼‰çš„è¿‡ç¨‹ã€‚ ååºåˆ—åŒ–ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„(æ ¼å¼)è½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹ã€‚  å‚è€ƒæ–‡çŒ®ï¼š RPCåŸç†è§£æ\n","date":"2021-11-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/prc/1_hu92b5144e2fe44c426742bd76f38787bf_37611_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/prc/","title":"PRC"},{"content":"Restful API  restæ˜¯Representational state Transfer çš„ç¼©å†™ï¼ˆè¡¨è¿°æ€§è½¬æ€ä¼ é€’ï¼‰ apiæ˜¯åº”ç”¨ç¨‹åºæ¥å£ Restful APIæ˜¯ä¸€ç§è½¯ä»¶ç»“æ„é£æ ¼ï¼Œè®¾è®¡é£æ ¼ï¼Œè®©è½¯ä»¶æ›´åŠ æ¸…æ™°ã€ç®€æ´ã€æ˜“ç»´æŠ¤ã€‚æ˜¯ä¸€ç§æµè¡Œçš„è½¯ä»¶API è®¾è®¡é£æ ¼  Restçš„æŒ‡å¯¼é£æ ¼  å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼šé€šè¿‡å°†ç”¨æˆ·æ¥å£é—®é¢˜ä¸æ•°æ®å­˜å‚¨é—®é¢˜åˆ†å¼€ï¼Œç®€åŒ–æœåŠ¡å™¨ç»„ä»¶æ¥æé«˜è·¨å¹³å°æ”¾å…¥ç”¨æˆ·æ¥å£çš„ å¯ç§»æ¤æ€§æ€§å¹¶æé«˜å¯ä¼¸ç¼©æ€§ æ— è½¬æ€ï¼šä»å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åŒ…å«ç†è§£è¯·æ±‚æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸èƒ½åˆ©ç”¨æœåŠ¡å™¨ä¸Šä»»ä½•å­˜å‚¨çš„ä¸Šä¸‹æ–‡ã€‚å› æ­¤ï¼Œä¼šè¯çŠ¶æ€å®Œå…¨ä¿ç•™åœ¨å®¢æˆ·ç«¯ä¸Šã€‚ å¯ç¼“å­˜ï¼šç¼“å­˜çº¦æŸè¦æ±‚å°†å¯¹è¯·æ±‚çš„å“åº”ä¸­çš„æ•°æ®éšå¼æˆ–æ˜¾å¼æ ‡è®°ä¸ºå¯ç¼“å­˜æˆ–ä¸å¯ç¼“å­˜ã€‚å¦‚æœå“åº”æ˜¯å¯ç¼“å­˜çš„ï¼Œåˆ™å®¢æˆ·ç«¯ç¼“å­˜æœ‰æƒé‡ç”¨è¯¥å“åº”æ•°æ®ä»¥ç”¨äºä»¥åçš„ç­‰æ•ˆè¯·æ±‚ã€‚ ç»Ÿä¸€æ¥å£ï¼šé€šè¿‡å°†é€šç”¨æ€§çš„è½¯ä»¶å·¥ç¨‹åŸç†åº”ç”¨äºç»„ä»¶æ¥å£ï¼Œç®€åŒ–äº†æ•´ä¸ªç³»ç»Ÿæ¶æ„ï¼Œæé«˜äº†äº¤äº’çš„å¯è§æ€§ã€‚ä¸ºäº†è·å¾—ç»Ÿä¸€çš„æ¥å£ï¼Œéœ€è¦å¤šä¸ªæ¶æ„çº¦æŸæ¥æŒ‡å¯¼ç»„ä»¶çš„è¡Œä¸ºã€‚RESTç”±å››ä¸ªæ¥å£çº¦æŸå®šä¹‰ï¼šèµ„æºè¯†åˆ«; é€šè¿‡é™ˆè¿°æ¥å¤„ç†èµ„æº; è‡ªæˆ‘æè¿°æ€§çš„ä¿¡æ¯; å¹¶ä¸”ï¼Œè¶…åª’ä½“ä½œä¸ºåº”ç”¨ç¨‹åºçŠ¶æ€çš„å¼•æ“ åˆ†å±‚ç³»ç»Ÿï¼šåˆ†å±‚ç³»ç»Ÿé£æ ¼å…è®¸é€šè¿‡çº¦æŸç»„ä»¶è¡Œä¸ºæ¥ä½¿ä½“ç³»ç»“æ„ç”±åˆ†å±‚å±‚ç»„æˆï¼Œè¿™æ ·æ¯ä¸ªç»„ä»¶éƒ½ä¸èƒ½â€œçœ‹åˆ°â€è¶…å‡ºä¸å®ƒä»¬äº¤äº’çš„ç›´æ¥å±‚ã€‚ æŒ‰éœ€ç¼–ç ï¼ˆå¯é€‰ï¼‰ï¼š RESTå…è®¸é€šè¿‡ä»¥å°ç¨‹åºæˆ–è„šæœ¬çš„å½¢å¼ä¸‹è½½å’Œæ‰§è¡Œä»£ç æ¥æ‰©å±•å®¢æˆ·ç«¯åŠŸèƒ½ã€‚è¿™é€šè¿‡å‡å°‘é¢„å…ˆå®ç°æ‰€éœ€çš„åŠŸèƒ½æ•°é‡æ¥ç®€åŒ–å®¢æˆ·ç«¯  RestFul æ¶æ„  èµ„æºï¼šç½‘ç»œçš„å®ä½“æˆ–è€…æ˜¯å…·ä½“çš„ä¿¡æ¯ï¼Œä½¿ç”¨URI(ç»Ÿä¸€èµ„æºå®šä½ç¬¦)ï¼ŒURIæ˜¯æ¯ä¸€ä¸ªèµ„æºçš„åœ°å€æˆ–è€…ç‹¬ä¸€æ— äºŒçš„æ˜¯è¯†åˆ«ç¬¦ è¡¨ç°å±‚ï¼š å¯¹èµ„æºçš„å¤–åœ¨è¡¨ç°ï¼Œå¦‚ï¼šjsonã€xmlã€txtã€äºŒè¿›åˆ¶ç­‰ è½¬æ€è½¬åŒ–ï¼šäº’è”ç½‘æ˜¯ä¸€ç§æ— è½¬æ€çš„åè®®ï¼Œæ‰€æœ‰çš„çŠ¶æ€éƒ½æ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œå®¢æˆ·ç«¯é€šè¿‡ HTTPçš„æ“ä½œæ–¹å¼(GET,POST,PUT,DELETE)ç­‰æ”¹å˜æœåŠ¡å™¨çš„â€œçŠ¶æ€å˜åŒ–â€ \r  RESTful APIæ¥å£è§„èŒƒ æ¥å£é£æ ¼  è·¯å¾„å’Œå˜é‡å‡é‡‡ç”¨å°é©¼å³°å¼ï¼Œä¾‹å¦‚deviceId ä½¿ç”¨HTTPåŠ¨è¯ä½œä¸ºactionæ“ä½œURLèµ„æºï¼ŒåŠ¨è¯ä¸€å¾‹å¤§å†™ã€‚  GETï¼šè¯»å–\\æŸ¥è¯¢ï¼ˆReadï¼‰ POSTï¼šæ–°å»ºï¼ˆCreateï¼‰ PUTï¼šæ›´æ–°ï¼ˆUpdateï¼‰ PATCHï¼šæ›´æ–°ï¼ˆUpdateï¼‰ï¼Œé€šå¸¸æ˜¯éƒ¨åˆ†æ›´æ–° DELETEï¼šåˆ é™¤ï¼ˆDeleteï¼‰ HEADï¼šè·å–èµ„æºçš„å…ƒæ•°æ®ã€‚ OPTIONSï¼šè·å–ä¿¡æ¯ï¼Œå…³äºèµ„æºçš„å“ªäº›å±æ€§æ˜¯å®¢æˆ·ç«¯å¯ä»¥æ”¹å˜çš„ã€‚ 5ç§è¯·æ±‚åŠ¨ä½œä¸­ï¼ŒGETã€PUTã€PATCHã€DELETEå‡æ˜¯å¹‚ç­‰çš„ï¼›åªæœ‰POSTæ˜¯éå¹‚ç­‰çš„ã€‚å¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚æ˜¯éå¹‚ç­‰æ˜¯åˆ¤æ–­æ¥å£ä½¿ç”¨POSTè¿˜æ˜¯PUTçš„å†³å®šæ¡ä»¶ã€‚å¹‚ç­‰çš„ç†è§£è§æœ¬æ–‡é™„å½•ã€‚   å‚æ•°ï¼š  PATHï¼ˆè·¯å¾„ï¼‰ï¼š  ç‰ˆæœ¬å·æ”¾å…¥PATHï¼Œä¸”åœ¨æœ€å‰  å°½é‡ä½¿ç”¨åè¯ï¼Œä¸ä½¿ç”¨åŠ¨è¯ï¼ŒæŠŠæ¯ä¸ªURLçœ‹æˆä¸€ä¸ªèµ„æºï¼Œåç§°éƒ½ç”¨å¤æ•° å¾®æœåŠ¡åç§°ä¸æ”¾å…¥PATHä¸­     Queryå‚æ•°ï¼šä¸»è¦ç”¨åœ¨GETæŸ¥è¯¢ä¸­ï¼Œç®€å•çš„PUTåŠ¨ä½œï¼Œä¹Ÿç”¨Queryå‚æ•° Headerså‚æ•°ï¼šå…¬å…±å‚æ•°é€šè¿‡headerä¼ é€’ï¼Œcontent-typeã€authorizationè®¤è¯å¿…å¡«ï¼Œå…¶ä»–ç»Ÿä¸€æŒ‰è°ƒç”¨é“¾è§„èŒƒã€é€Ÿç‡é™åˆ¶è§„èŒƒå¡«å†™ã€‚content-typeåº”è¯¥å›ºå®šä¸ºapplication/jsonã€‚ Bodyï¼š  ç»Ÿä¸€ä½¿ç”¨jsonæ ¼å¼ï¼Œæ‰€æœ‰è¿”å›éƒ½æ˜¯jsonæ ¼å¼  POSTæ‰€æœ‰å‚æ•°é€šè¿‡JSONä¼ é€’ GETè¯·æ±‚ä¸å…è®¸æœ‰bodyï¼Œ æ‰€æœ‰å‚æ•°é€šè¿‡æ‹¼æ¥åœ¨URLä¹‹åä¼ é€’ï¼Œæ‰€æœ‰çš„è¯·æ±‚å‚æ•°éƒ½è¦è¿›è¡Œéµå¾ªRFC 3986çš„URL Encodeã€‚ DELETEåˆ é™¤å•ä¸ªèµ„æºæ—¶ï¼Œèµ„æºæ ‡è¯†é€šè¿‡pathä¼ é€’ï¼Œæ‰¹é‡åˆ é™¤æ—¶ï¼Œé€šè¿‡åœ¨bodyä¸­ä¼ é€’JSONã€‚       è¿”å›ç»“æœ  çŠ¶æ€ç ï¼šHTTPçŠ¶æ€ç æ ‡å‡†ç”¨æ³•ï¼Œè§åçŠ¶æ€ç è§„èŒƒ Bodyè¿”å›ï¼Œåªæä¾›jsonè¿”å›æ ¼å¼ GETï¼šè¿”å›èµ„æºå¯¹è±¡ï¼Œå®Œæ•´å¯¹è±¡æˆ–é€šè¿‡Queryå‚æ•°å¯è¿‡æ»¤ POSTï¼šè¿”å›æ–°ç”Ÿæˆçš„èµ„æºå¯¹è±¡ï¼Œå¯èƒ½æ˜¯IDæˆ–å®Œæ•´çš„èµ„æºå¯¹è±¡ PUTï¼šè¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡ DELETEï¼šè¿”å›ä¸€ä¸ªç©ºæ–‡æ¡£   è¿‡æ»¤ä¿¡æ¯ï¼šæŸ¥è¯¢åŠæŸ¥è¯¢ç»“æœä½¿ç”¨  pageNoï¼šåˆ†é¡µæŸ¥è¯¢æ ‡è¯†ç¬¬å‡ é¡µ pageSizeï¼šåˆ†é¡µæŸ¥è¯¢æ ‡è¯†æ¯é¡µå¤šå°‘æ¡æ•°æ® beginï¼šå½•åƒ/æˆªå›¾å¼€å§‹æ—¶é—´ï¼ŒUnixæ—¶é—´æˆ³ï¼Œå•ä½ç§’ endï¼šå½•åƒ/æˆªå›¾ç»“æŸæ—¶é—´ï¼ŒUnixæ—¶é—´æˆ³ï¼Œå•ä½ç§’ orderbyï¼šæ’åºè§„åˆ™ï¼Œdescæˆ–asc qï¼šæœç´¢å…³é”®å­—ï¼ˆuri encodeä¹‹åçš„ï¼‰ totalCountï¼šæ€»è®°å½•æ•°ï¼Œåˆ†é¡µæŸ¥è¯¢ï¼Œè¿”å›jsonæºå¸¦ totalPagesï¼šæ€»é¡µæ•°ï¼Œåˆ†é¡µæŸ¥è¯¢ï¼Œè¿”å›jsonæºå¸¦ï¼Œç­‰äºpageæ—¶ï¼Œè¡¨ç¤ºå½“å‰æ˜¯æœ€åä¸€é¡µ   å¾®æœåŠ¡å†…éƒ¨ä½¿ç”¨httpåè®®ï¼Œå¯¹å¤–ä½¿ç”¨httpsåè®®  è¯¦ç»†è®¾è®¡è¦æ±‚  è¾“å…¥å‚æ•°è¦ç²¾ç®€æœ‰æ•ˆ  ä¸èƒ½æŠŠå†…éƒ¨å¯¹è±¡ä½œä¸ºæ¥å£å‚æ•°ï¼Œé€šè¿‡DTOè¿›è¡Œè½¬æ¢ï¼› requiredçš„å­—æ®µå°½å¯èƒ½å°‘   CRUDçš„U(POST)è¦é€šè¿‡ä¸šåŠ¡åˆ†æï¼ˆé¢†åŸŸå»ºæ¨¡ï¼‰å…·ä½“åŒ–æ“ä½œï¼Œä¸è¦æä¾›çµæ´»ä½†æ˜¯æ”¯æŒä¸å…¨é¢çš„æ¥å£ æŸ¥è¯¢å°½å¯èƒ½æä¾›ä¸°å¯Œçš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¯ä»¥è¿”å›å°½å¯èƒ½è¯¦ç»†çš„ä¿¡æ¯ åŒç±»èµ„æºå°½å¯èƒ½ç»Ÿä¸€æ¥å£ é¿å…å¤šçº§ URLï¼Œæ¯”å¦‚è·å–æŸä¸ªä½œè€…çš„æŸä¸€ç±»æ–‡ç« ï¼š GET /authors/12/categories/2 è¿™ç§ URL ä¸åˆ©äºæ‰©å±•ï¼Œè¯­ä¹‰ä¹Ÿä¸æ˜ç¡®ï¼Œå¾€å¾€è¦æƒ³ä¸€ä¼šï¼Œæ‰èƒ½æ˜ç™½å«ä¹‰ã€‚ æ›´å¥½çš„åšæ³•æ˜¯ï¼Œé™¤äº†ç¬¬ä¸€çº§ï¼Œå…¶ä»–çº§åˆ«éƒ½ç”¨æŸ¥è¯¢å­—ç¬¦ä¸²è¡¨è¾¾ã€‚ GET /authors/12?categories=2 å¦‚ä½•è®¾è®¡æ‰¹é‡å¤„ç† æŠŠURLè®¾è®¡ä¸ºPATCH /authors/batchï¼Œä¹Ÿå°±æ˜¯å…·ä½“çš„idä¼ å…¥batchè¡¨ç¤ºæ‰¹é‡ï¼Œå‚æ•°é€šè¿‡bodyä¼ é€’ï¼Œä¾‹å¦‚å¦‚ä¸‹ï¼š  { {\u0026quot;method\u0026quot;:\u0026quot;DELETE\u0026quot;,\u0026quot;id\u0026quot;:\u0026quot;12\u0026quot;,\u0026quot;value\u0026quot;:\u0026quot;\u0026quot;} {\u0026quot;method\u0026quot;:\u0026quot;PUT\u0026quot;,\u0026quot;id\u0026quot;:\u0026quot;23\u0026quot;,\u0026quot;value\u0026quot;:{\u0026quot;name\u0026quot;:\u0026quot;michael\u0026quot;,\u0026quot;group\u0026quot;:\u0026quot;fisrt\u0026quot;,...}} } åœ¨methodä¸­ä¼ é€’HTTPåŠ¨è¯ï¼Œä¸»è¦æ˜¯PUT\\DELETEï¼ŒGETé€šè¿‡æŸ¥è¯¢æ¡ä»¶æœ¬èº«å°±æ”¯æŒæ‰¹é‡ï¼ŒPOSTæ˜¯åˆ›å»ºï¼Œå‡ ä¹ä¸éœ€æ‰¹é‡åˆ›å»ºï¼Œè€ŒPUT\\DELETEéƒ½æ˜¯å¯¹æŸä¸ªidæ“ä½œï¼ŒåŒæ—¶ä¿®æ”¹æˆ–åˆ é™¤å¤šä¸ªidå°±æ˜¯æ‰¹é‡æ“ä½œï¼›åœ¨idä¸­æ˜ç¡®å…·ä½“çš„idï¼Œvalueåˆ™ä¼ é€’ä¸æ“ä½œå•ä¸ªidä¸€è‡´çš„æ•°æ®ã€‚æ‰¹é‡æ“ä½œçš„è¿”å›bodyä¸ä¼ å…¥bodyä¿æŒä¸€è‡´ï¼Œåªæ˜¯valueå¯èƒ½æ˜¯erroræ•°æ®ä¹Ÿå¯èƒ½æ˜¯PUTçš„ç»“æœæ•°æ®ã€‚é€šè¿‡è¿™ç§è®¾è®¡ï¼Œåœ¨å®ç°æ—¶ï¼Œbatchæ“ä½œå¯ä»¥å¤ç”¨å•ä¸ªidæ“ä½œçš„å¤„ç†è¿‡ç¨‹ã€‚\nçŠ¶æ€ç è§„èŒƒ æ­£ç¡® æ¥å£æ­£å¸¸è®¿é—®æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨è¿”å›2Ã—Ã—çš„HTTPçŠ¶æ€ç ã€‚ 200 OK ï¼šè¡¨ç¤ºå·²åœ¨å“åº”ä¸­å‘å‡ºã€èµ„æºæ›´æ”¹æˆåŠŸï¼ˆGETã€PUTï¼‰ 201 Createdï¼šè¡¨ç¤ºæ–°èµ„æºè¢«åˆ›å»ºï¼ˆPOSTï¼‰ 204 No Content ï¼šèµ„æºè¢«åˆ é™¤ï¼ˆDELETEï¼‰\né”™è¯¯ å½“ç”¨æˆ·è®¿é—®æ¥å£å‡ºé”™æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ç»™ä¸€ä¸ªåˆé€‚çš„4Ã—Ã—æˆ–è€…5Ã—Ã—çš„HTTPçŠ¶æ€ç ï¼›ä»¥åŠä¸€ä¸ªapplication/jsonæ ¼å¼çš„æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯ä½“ä¸­åŒ…å«é”™è¯¯ç codeå’Œé”™è¯¯è¯´æ˜messageï¼Œjsonæ ¼å¼å¦‚ä¸‹ï¼š\n{ \u0026quot;code\u0026quot;:\u0026quot;å†…éƒ¨é”™è¯¯ä»£ç å¯ä»¥æ˜¯æ•°å­—æˆ–Exeptionå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚20003, OAuthException\u0026quot; \u0026quot;message\u0026quot;:\u0026quot;æ ¼å¼åŒ–çš„é”™è¯¯ä¿¡æ¯ï¼Œè‹±æ–‡ï¼Œæ­¤messageæ˜¯å¯¹codeçš„æ›´ç»†çš„é”™è¯¯æè¿°ï¼Œå¯ä»¥æŠŠä¸€äº›çŠ¶æ€å˜é‡æ ¼å¼åŒ–åµŒå…¥ã€‚\u0026quot; } è¡¥å……è¯´æ˜ï¼šä»¥ä¸Šé”™è¯¯è¿”å›å…¨è‹±æ–‡ï¼Œè‹¥Webæç¤ºï¼Œç”±webå®¢æˆ·ç«¯å»ºç«‹codeçš„å¤šè¯­è¨€å­—ç¬¦ä¸²è¡¨ï¼ŒæŠŠé”™è¯¯ç è½¬åŒ–ä¸ºå¯¹äºçš„å¤šè¯­è¨€å­—ç¬¦ä¸²ï¼Œå±•ç¤ºå¤šè¯­è¨€æç¤ºã€‚\n å‘ç”Ÿé”™è¯¯æ—¶ï¼Œç»å¯¹ä¸è¦è¿”å› 200 çŠ¶æ€ç  4Ã—Ã—é”™è¯¯( 400=\u0026lt;status code\u0026lt;500 )ä¸ºå®¢æˆ·ç«¯çš„è¯·æ±‚é”™è¯¯ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„codeåšç›¸åº”çš„æç¤ºå’Œé€»è¾‘å¤„ç†ï¼Œmessageä»…ä¾›å¼€å‘æ—¶å‚è€ƒï¼Œä¸å»ºè®®ä½œä¸ºç”¨æˆ·æç¤ºã€‚ 5Ã—Ã—é”™è¯¯( 500=\u0026lt;status code )ä¸ºæœåŠ¡å™¨æˆ–ç¨‹åºå‡ºé”™ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æç¤ºâ€œæœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•â€å³å¯ï¼Œè¯¥ç±»é”™è¯¯ä¸åœ¨æ¯ä¸ªæ¥å£ä¸­åˆ—å‡ºã€‚  400 Bad Request ï¼šæœåŠ¡å™¨ä¸ç†è§£å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæœªåšä»»ä½•å¤„ç†ã€‚\n401 Unauthorized ï¼šç”¨æˆ·æœªæä¾›èº«ä»½éªŒè¯å‡­æ®ï¼Œæˆ–è€…æ²¡æœ‰é€šè¿‡èº«ä»½éªŒè¯ã€‚\n403 Forbidden ï¼šç”¨æˆ·é€šè¿‡äº†èº«ä»½éªŒè¯ï¼Œä½†æ˜¯ä¸å…·æœ‰è®¿é—®èµ„æºæ‰€éœ€çš„æƒé™ã€‚\n404 Not Found ï¼šæ‰€è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨ï¼Œæˆ–ä¸å¯ç”¨ã€‚\n405 Method Not Allowed ï¼šç”¨æˆ·å·²ç»é€šè¿‡èº«ä»½éªŒè¯ï¼Œä½†æ˜¯æ‰€ç”¨çš„ HTTP æ–¹æ³•ä¸åœ¨ä»–çš„æƒé™ä¹‹å†…ã€‚\n410 Gone ï¼šæ‰€è¯·æ±‚çš„èµ„æºå·²ä»è¿™ä¸ªåœ°å€è½¬ç§»ï¼Œä¸å†å¯ç”¨ã€‚\n415 Unsupported Media Type ï¼šå®¢æˆ·ç«¯è¦æ±‚çš„è¿”å›æ ¼å¼ä¸æ”¯æŒã€‚æ¯”å¦‚ï¼ŒAPI åªèƒ½è¿”å› JSON æ ¼å¼ï¼Œä½†æ˜¯å®¢æˆ·ç«¯è¦æ±‚è¿”å› XML æ ¼å¼ã€‚\n422 Unprocessable Entity ï¼šå®¢æˆ·ç«¯ä¸Šä¼ çš„é™„ä»¶æ— æ³•å¤„ç†ï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚\n429 Too Many Requests ï¼šå®¢æˆ·ç«¯çš„è¯·æ±‚æ¬¡æ•°è¶…è¿‡é™é¢ã€‚\n500 Internal Server Error ï¼šå®¢æˆ·ç«¯è¯·æ±‚æœ‰æ•ˆï¼ŒæœåŠ¡å™¨å¤„ç†æ—¶å‘ç”Ÿäº†æ„å¤–ã€‚\n503 Service Unavailable ï¼šæœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºç½‘ç«™æˆ–è®¾å¤‡ç»´æŠ¤çŠ¶æ€ã€‚\né™„å½•ï¼šå¹‚ç­‰æ€§ å¹‚ç­‰æ€§ï¼šå¹‚ç­‰æ€§æ˜¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¸¸è§çš„é—®é¢˜ï¼›å¹‚ç­‰æ€§æŒ‡çš„æ˜¯å¤šæ¬¡æ“ä½œï¼Œç»“æœæ˜¯ä¸€è‡´çš„ã€‚ï¼ˆå¤šæ¬¡æ“ä½œæ•°æ®åº“æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚ï¼‰\n GETæ–¹æ³•ç”¨äºè·å–èµ„æºï¼Œä¸åº”æœ‰å‰¯ä½œç”¨ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚ DELETEæ–¹æ³•ç”¨äºåˆ é™¤èµ„æºï¼Œæœ‰å‰¯ä½œç”¨ï¼Œä½†å®ƒåº”è¯¥æ»¡è¶³å¹‚ç­‰æ€§ã€‚ POSTæ‰€å¯¹åº”çš„URIå¹¶éåˆ›å»ºçš„èµ„æºæœ¬èº«ï¼Œè€Œæ˜¯èµ„æºçš„æ¥æ”¶è€…ã€‚æ¯”å¦‚ï¼š POST http://www.forum.com/articles çš„è¯­ä¹‰æ˜¯åœ¨ http://www.forum.com/articles ä¸‹åˆ›å»ºä¸€ç¯‡å¸–å­ï¼ŒHTTPå“åº”ä¸­åº”åŒ…å«å¸–å­çš„åˆ›å»ºçŠ¶æ€ä»¥åŠå¸–å­çš„URIã€‚ä¸¤æ¬¡ç›¸åŒçš„POSTè¯·æ±‚ä¼šåœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸¤ä»½èµ„æºï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„URIï¼›æ‰€ä»¥ï¼ŒPOSTæ–¹æ³•ä¸å…·å¤‡å¹‚ç­‰æ€§ã€‚ PUTæ‰€å¯¹åº”çš„URIæ˜¯è¦åˆ›å»ºæˆ–æ›´æ–°çš„èµ„æºæœ¬èº«ã€‚æ¯”å¦‚ï¼š PUT http://www.forum/articles/4231 çš„è¯­ä¹‰æ˜¯åˆ›å»ºæˆ–æ›´æ–°IDä¸º4231çš„å¸–å­ã€‚å¯¹åŒä¸€URIè¿›è¡Œå¤šæ¬¡PUTçš„å‰¯ä½œç”¨å’Œä¸€æ¬¡PUTæ˜¯ç›¸åŒçš„ï¼›å› æ­¤ï¼ŒPUTæ–¹æ³•å…·æœ‰å¹‚ç­‰æ€§ã€‚ å¦‚ä½•æŠŠéå¹‚ç­‰çš„POSTæ“ä½œè®¾è®¡ä¸ºå¹‚ç­‰çš„ï¼Œå¯ä»¥å‚åŠ ä¸‹é¢çš„å¸–å­çš„ç¤ºä¾‹ï¼š https://www.cnblogs.com/weidagang2046/archive/2011/06/04/idempotence.html  ","date":"2021-11-10T22:00:08+08:00","image":"https://zcj-git520.github.io/p/restfulapi/1_hu5d30570469f48ece7400dce081384b39_15097_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/restfulapi/","title":"RestfulAPI"},{"content":"æ¦‚å¿µçŸ¥è¯† Dockeré•œåƒ Dockeré•œåƒæ˜¯ç”±æ–‡ä»¶å’Œå…ƒæ•°æ®ç»„æˆçš„ã€‚\n æ–‡ä»¶ï¼šè¯­è¨€ç¯å¢ƒã€åº“ã€æ‰§è¡Œæ–‡ä»¶  ç”±äº Docker ä½¿ç”¨ Union FSï¼Œç›¸åŒçš„å±‚åªéœ€è¦ä¿å­˜ä¸€ä»½å³å¯ï¼Œå› æ­¤å®é™…é•œåƒç¡¬ç›˜å ç”¨ç©ºé—´å¾ˆå¯èƒ½è¦æ¯”è¿™ä¸ªåˆ—è¡¨é•œåƒå¤§å°çš„æ€»å’Œè¦å°çš„å¤šã€‚   å…ƒæ•°æ®ï¼šç¯å¢ƒå˜é‡ã€ç«¯å£æ˜ å°„ã€å·ç­‰ é•œåƒä¿¡æ¯ï¼š  RESPOSITORYï¼šä»“åº“å TAGï¼šæ ‡ç­¾ IMAGE IDï¼šé•œåƒID CREATEDï¼šåˆ›å»ºæ—¶é—´ SIZEï¼šæ‰€å ç”¨çš„ç©ºé—´   è™šæ‚¬é•œåƒ(dangling image)  RESPOSITROYåŠTAGéƒ½ä¸º ä½¿ç”¨docker image prune å¯ä»¥åˆ é™¤    å®¹å™¨ å®¹å™¨æ˜¯ä»é•œåƒä¸­åˆ›å»ºï¼Œç»§æ‰¿äº†ä»–ä»¬çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨ä»–ä»¬çš„å…ƒæ•°æ®æ¥ç¡®å®šå…¶å¯åŠ¨é…ç½®ã€‚\n å¯åŠ¨æ—¶ï¼Œè¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œä¸è¿‡å¯æ´¾ç”Ÿå…¶ä»–è¿›ç¨‹ã€‚ æ–‡ä»¶çš„å˜æ›´é€šè¿‡å†™æ—¶å¤åˆ¶å­˜å‚¨åœ¨å®¹å™¨ä¸­ï¼ŒåŸºç¡€é•œåƒä¸ä¼šå—å½±å“ã€‚  æ•°æ®å· æ•°æ®å· æ˜¯ä¸€ä¸ªå¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•ï¼Œå®ƒç»•è¿‡ UFSï¼Œå¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼š\n æ•°æ®å· å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨ å¯¹ æ•°æ®å· çš„ä¿®æ”¹ä¼šç«‹é©¬ç”Ÿæ•ˆ å¯¹ æ•°æ®å· çš„æ›´æ–°ï¼Œä¸ä¼šå½±å“é•œåƒ æ•°æ®å· é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤ æ³¨æ„ï¼šæ•°æ®å· çš„ä½¿ç”¨ï¼Œç±»ä¼¼äº Linux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mountï¼Œé•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šå¤åˆ¶åˆ°æ•°æ®å·ä¸­ï¼ˆä»…æ•°æ®å·ä¸ºç©ºæ—¶ä¼šå¤åˆ¶ï¼‰ã€‚ æ•°æ®å· æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼ŒDocker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤ æ•°æ®å·  Dockerç½‘ç»œ å½“ Docker å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª docker0 è™šæ‹Ÿç½‘æ¡¥ï¼Œå®é™…ä¸Šæ˜¯ Linux çš„ä¸€ä¸ª bridgeï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½¯ä»¶äº¤æ¢æœºã€‚å®ƒä¼šåœ¨æŒ‚è½½åˆ°å®ƒçš„ç½‘å£ä¹‹é—´è¿›è¡Œè½¬å‘ã€‚\nåŒæ—¶ï¼ŒDocker éšæœºåˆ†é…ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ®µï¼ˆåœ¨ RFC1918 ä¸­å®šä¹‰ï¼‰ä¸­çš„ä¸€ä¸ªåœ°å€ç»™ docker0 æ¥å£ã€‚æ¯”å¦‚å…¸å‹çš„ 172.17.42.1ï¼Œæ©ç ä¸º 255.255.0.0ã€‚æ­¤åå¯åŠ¨çš„å®¹å™¨å†…çš„ç½‘å£ä¹Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªåŒä¸€ç½‘æ®µï¼ˆ172.17.0.0/16ï¼‰çš„åœ°å€ã€‚\nå½“åˆ›å»ºä¸€ä¸ª Docker å®¹å™¨çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šåˆ›å»ºäº†ä¸€å¯¹ veth pair æ¥å£ï¼ˆå½“æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦å¤–ä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æ”¶åˆ°ç›¸åŒçš„æ•°æ®åŒ…ï¼‰ã€‚è¿™å¯¹æ¥å£ä¸€ç«¯åœ¨å®¹å™¨å†…ï¼Œå³ eth0ï¼›å¦ä¸€ç«¯åœ¨æœ¬åœ°å¹¶è¢«æŒ‚è½½åˆ° docker0 ç½‘æ¡¥ï¼Œåç§°ä»¥ veth å¼€å¤´ï¼ˆä¾‹å¦‚ vethAQI2QTï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸»æœºå¯ä»¥è·Ÿå®¹å™¨é€šä¿¡ï¼Œå®¹å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡ã€‚Docker å°±åˆ›å»ºäº†åœ¨ä¸»æœºå’Œæ‰€æœ‰å®¹å™¨ä¹‹é—´ä¸€ä¸ªè™šæ‹Ÿå…±äº«ç½‘ç»œã€‚ \rimage\r\nå…¶ä»–çŸ¥è¯†  Docker ä¸æ˜¯è™šæ‹Ÿæœºï¼Œå®¹å™¨ä¸­çš„åº”ç”¨éƒ½åº”è¯¥ä»¥å‰å°æ‰§è¡Œï¼Œè€Œä¸æ˜¯åƒè™šæ‹Ÿæœºã€ç‰©ç†æœºé‡Œé¢é‚£æ ·ï¼Œç”¨ systemd å»å¯åŠ¨åå°æœåŠ¡ï¼Œå®¹å™¨å†…æ²¡æœ‰åå°æœåŠ¡çš„æ¦‚å¿µã€‚  ä½¿ç”¨é•œåƒçš„å‘½ä»¤å·¥å…·    å‘½ä»¤ åŠŸèƒ½     docker pull [Registryåœ°å€[:ç«¯å£]/] ä»“åº“å[:æ ‡ç­¾] Registry åœ°å€æ‹‰å–é•œåƒ   Docker run ä»“åº“å:æ ‡ç­¾ [å‘½ä»¤] ä»¥å®¹å™¨å½¢å¼è¿è¡Œä¸€ä¸ªDockeré•œåƒ   Docker run -it ä»“åº“å:æ ‡ç­¾ [å‘½ä»¤] -itè¡¨ç¤ºè¿›å…¥äº¤äº’ç»ˆç«¯   Docker run \u0026ndash;rm ä»“åº“å:æ ‡ç­¾ [å‘½ä»¤] \u0026ndash;rmé€€å‡ºååˆ é™¤ï¼Œå¦åˆ™docker ps -açœ‹å¾—åˆ°   docker image ls åˆ—å‡ºå·²ç»ä¸‹è½½ä¸‹æ¥çš„é•œåƒ   docker images åŒä¸Š   docker image ls [ä»“åº“å][:æ ‡ç­¾] åˆ—å‡ºæŒ‡å®šä»“åº“åæˆ–é™„å¸¦æ ‡ç­¾çš„é•œåƒ   docker image ls -q ä»…åˆ—å‡ºè¡¨æ ¼çš„IMAGE IDåˆ—è¡¨   docker image ls -f label=com.example.version=0.1 -f å¢åŠ è¿‡æ»¤å™¨   docker image ls \u0026ndash;format \u0026ldquo;{{.ID}}: {{.Repository}}\u0026rdquo; åˆ©ç”¨Goçš„æ¨¡æ¿è¯­æ³•åˆ—å‡ºä¿¡æ¯   docker image ls \u0026ndash;digests åˆ—å‡ºé•œåƒï¼Œå¢åŠ DIGESTæ‘˜è¦æ˜¾ç¤ºï¼ˆç¡®ä¿å”¯ä¸€ï¼‰   docker image rm [é€‰é¡¹] \u0026lt;é•œåƒ1\u0026gt; [\u0026lt;é•œåƒ2\u0026gt; \u0026hellip;] åˆ é™¤é•œåƒï¼Œé•œåƒå¯ä»¥æ˜¯IDã€ä»“åº“å:æ ‡ç­¾ï¼Œæ‘˜è¦   docker image rm $(docker images -q redis) åˆ é™¤æ‰€æœ‰redisåç§°çš„é•œåƒ   docker image rm $(docker images -q -f before=é•œåƒ) åˆ é™¤æŸä¸ªé•œåƒå‰é¢çš„é•œåƒ   docker run \u0026ndash;name webserver -d -p 80:80 nginx æŒ‡å®šå®¹å™¨åç§°ä¸ºwebserverï¼Œä¸”é…ç½®ç«¯å£   docker exec -it webserver bash è¿›å…¥å®¹å™¨ï¼Œæ‰“å¼€bashæ§åˆ¶å°   docker commit [é€‰é¡¹] \u0026lt;å®¹å™¨IDæˆ–å®¹å™¨å\u0026gt; [\u0026lt;ä»“åº“å\u0026gt;[:\u0026lt;æ ‡ç­¾\u0026gt;]] ä¿å­˜é•œåƒ   Docker tag ç»™ä¸€ä¸ªDockeré•œåƒæ‰“æ ‡ç­¾   docker system df ä¾¿æ·çš„æŸ¥çœ‹é•œåƒã€å®¹å™¨ã€æ•°æ®å·æ‰€å ç”¨çš„ç©ºé—´   docker image prune åˆ é™¤è™šæ‚¬é•œåƒ(dangling image)   docker build [é€‰é¡¹] \u0026lt;ä¸Šä¸‹æ–‡è·¯å¾„/URL/-\u0026gt; æ„å»ºé•œåƒ    $ docker commit \\ --author \u0026quot;Tao Wang \u0026lt;twang2218@gmail.com\u0026gt;\u0026quot; \\ --message \u0026quot;ä¿®æ”¹äº†é»˜è®¤ç½‘é¡µ\u0026quot; \\ webserver \\ nginx:v2 ä½¿ç”¨Dockerfileå®šåˆ¶é•œåƒ    æŒ‡ä»¤ åŠŸèƒ½     FROM \u0026lt;åŸºç¡€é•œåƒ\u0026gt; åŸºç¡€é•œåƒ   FROM scratch ä¸ä»¥ä»»ä½•é•œåƒä¸ºåŸºç¡€ï¼ŒGoè¯­è¨€å¼€å‘çš„åº”ç”¨å¾ˆå¤šä¼šä½¿ç”¨è¿™ç§æ–¹å¼   RUN shellæ ¼å¼å‘½ä»¤ shellå‘½ä»¤è¿½åŠ å±‚   RUN [\u0026ldquo;å¯æ‰§è¡Œæ–‡ä»¶\u0026rdquo;, \u0026ldquo;å‚æ•°1\u0026rdquo;, \u0026ldquo;å‚æ•°2\u0026rdquo;] execæ ¼å¼è¿½åŠ å±‚   COPY ./package.json /app/ å…¶ä¸­.è¡¨ç¤ºä¸Šä¸‹æ–‡ç›®å½•   docker build -t nginx:v3 . å…¶ä¸­.å°±æ˜¯ä¼ å…¥çš„ä¸Šä¸‹æ–‡ç›®å½•ï¼Œä¸€èˆ¬åŠæ—¶Dockerfileæ–‡ä»¶æ‰€åœ¨ç›®å½•   COPY [\u0026ndash;chown=:] \u0026lt;æºè·¯å¾„\u0026gt;\u0026hellip; \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; å¤åˆ¶ä¸Šä¸‹æ–‡ç›®å½•ä¸­çš„æ–‡ä»¶/ç›®å½•åˆ°é•œåƒä¸­   WORKDIR \u0026lt;ç»å¯¹è·¯å¾„\u0026gt; æŒ‡å®šæŸä¸ªç»å¯¹è·¯å¾„ä½œä¸ºåç»­çš„ç›¸å¯¹è·¯å¾„   ADD [\u0026ndash;chown=:] \u0026lt;æºè·¯å¾„\u0026gt;\u0026hellip; \u0026lt;ç›®æ ‡è·¯å¾„\u0026gt; ä»…æºè‡ªåŠ¨è§£å‹ç¼©æ—¶ä½¿ç”¨   CMD \u0026lt;shellå‘½ä»¤\u0026gt; å®¹å™¨ä¸»è¿›ç¨‹çš„å¯åŠ¨å‘½ä»¤ï¼Œä¾‹å¦‚ubuntué•œåƒé»˜è®¤çš„CMDæ˜¯/bin/bash   CMD [\u0026ldquo;å¯æ‰§è¡Œæ–‡ä»¶\u0026rdquo;, \u0026ldquo;å‚æ•°1\u0026rdquo;, \u0026ldquo;å‚æ•°2\u0026rdquo;\u0026hellip;] exec æ ¼å¼å®¹å™¨ä¸»è¿›ç¨‹çš„å¯åŠ¨å‘½ä»¤ï¼Œæ¨èä½¿ç”¨   ENTRYPOINT [\u0026ldquo;å¯æ‰§è¡Œæ–‡ä»¶\u0026rdquo;, \u0026ldquo;å‚æ•°1\u0026rdquo;, \u0026ldquo;å‚æ•°2\u0026rdquo;\u0026hellip;] å…¥å£ç‚¹ï¼Œé•œåƒå˜æˆå‘½ä»¤ä¸€æ ·ä½¿ç”¨ï¼Œæˆ–è€…è¿è¡Œå‰çš„å‡†å¤‡å·¥ä½œ   ENV  ENV è®¾ç½®ç¯å¢ƒå˜é‡   ENV ==\u0026hellip; ENV è®¾ç½®ç¯å¢ƒå˜é‡   ARG \u0026lt;å‚æ•°å\u0026gt;[=\u0026lt;é»˜è®¤å€¼\u0026gt;] docker buildä¸­ç”¨\u0026ndash;build-arg \u0026lt;å‚æ•°å\u0026gt;=\u0026lt;å€¼\u0026gt;æ¥è¦†ç›–ï¼Œç”Ÿæ•ˆèŒƒå›´ä¸ºä¸‹ä¸€ä¸ªæŒ‡ä»¤   VOLUME [\u0026quot;\u0026lt;è·¯å¾„1\u0026gt;\u0026quot;, \u0026ldquo;\u0026lt;è·¯å¾„2\u0026gt;\u0026rdquo;\u0026hellip;] VOLUME å®šä¹‰åŒ¿åå·ï¼Œè¿™æ ·è¿è¡Œæ—¶ï¼Œä¸ä¼šå‘å®¹å™¨å­˜å‚¨å±‚å†™å…¥æ•°æ®ï¼Œè¿è¡Œå‘½ä»¤-vå¯ä»¥è¦†ç›–ä½ç½®   VOLUME \u0026lt;è·¯å¾„\u0026gt; VOLUME å®šä¹‰åŒ¿åå·   EXPOSE \u0026lt;ç«¯å£1\u0026gt; [\u0026lt;ç«¯å£2\u0026gt;\u0026hellip;] æš´éœ²ç«¯å£ï¼Œå®¹å™¨è¿è¡Œæ—¶æä¾›æœåŠ¡çš„ç«¯å£ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå£°æ˜   WORKDIR \u0026lt;å·¥ä½œç›®å½•è·¯å¾„\u0026gt; æŒ‡å®šå·¥ä½œç›®å½•ï¼ˆæˆ–è€…ç§°ä¸ºå½“å‰ç›®å½•ï¼‰ï¼Œå¦‚è¯¥ç›®å½•ä¸å­˜åœ¨ï¼ŒWORKDIR ä¼šå¸®ä½ å»ºç«‹ç›®å½•   USER \u0026lt;ç”¨æˆ·å\u0026gt;[:\u0026lt;ç”¨æˆ·ç»„\u0026gt;] æŒ‡å®šå½“å‰ç”¨æˆ·ï¼Œè¿™ä¸ªç”¨æˆ·å¿…é¡»æ˜¯äº‹å…ˆå»ºç«‹å¥½çš„   HEALTHCHECK [é€‰é¡¹] CMD \u0026lt;å‘½ä»¤\u0026gt; è®¾ç½®æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶å†µçš„å‘½ä»¤   HEALTHCHECK NONE å¦‚æœåŸºç¡€é•œåƒæœ‰å¥åº·æ£€æŸ¥æŒ‡ä»¤ï¼Œä½¿ç”¨è¿™è¡Œå¯ä»¥å±è”½æ‰å…¶å¥åº·æ£€æŸ¥æŒ‡ä»¤\\   ONBUILD \u0026lt;å…¶å®ƒæŒ‡ä»¤\u0026gt; åé¢æŒ‡ä»¤ï¼Œä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒæ„å»ºä¸‹ä¸€çº§é•œåƒæ—¶è¢«æ‰§è¡Œã€‚   LABEL ==\u0026hellip; é•œåƒä»¥é”®å€¼å¯¹çš„å½¢å¼æ·»åŠ ä¸€äº›å…ƒæ•°æ®ï¼ˆmetadataï¼‰   SHELL [\u0026ldquo;executable\u0026rdquo;, \u0026ldquo;parameters\u0026rdquo;] æŒ‡å®šRUN ENTRYPOINT CMD æŒ‡ä»¤çš„ shellï¼ŒLinux ä¸­é»˜è®¤ä¸º [\u0026quot;/bin/sh\u0026quot;, \u0026ldquo;-c\u0026rdquo;]    ç¤ºä¾‹\nFROM FROM nginx RUN echo '\u0026lt;h1\u0026gt;Hello, Docker!\u0026lt;/h1\u0026gt;' \u0026gt; /usr/share/nginx/html/index.html docker build -t nginx:v3 . FROM debian:stretch RUN apt-get update RUN apt-get install -y gcc libc6-dev make wget RUN wget -O redis.tar.gz \u0026quot;http://download.redis.io/releases/redis-5.0.3.tar.gz\u0026quot; RUN mkdir -p /usr/src/redis RUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 RUN make -C /usr/src/redis RUN make -C /usr/src/redis install FROM debian:stretch RUN set -x; buildDeps='gcc libc6-dev make wget' \\ \u0026amp;\u0026amp; apt-get update \\ \u0026amp;\u0026amp; apt-get install -y $buildDeps \\ \u0026amp;\u0026amp; wget -O redis.tar.gz \u0026quot;http://download.redis.io/releases/redis-5.0.3.tar.gz\u0026quot; \\ \u0026amp;\u0026amp; mkdir -p /usr/src/redis \\ \u0026amp;\u0026amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\ \u0026amp;\u0026amp; make -C /usr/src/redis \\ \u0026amp;\u0026amp; make -C /usr/src/redis install \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* \\ \u0026amp;\u0026amp; rm redis.tar.gz \\ \u0026amp;\u0026amp; rm -r /usr/src/redis \\ \u0026amp;\u0026amp; apt-get purge -y --auto-remove $buildDeps COPY package.json /usr/src/app/ COPY hom* /mydir/ COPY hom?.txt /mydir/ COPY --chown=55:mygroup files* /mydir/ COPY --chown=bin files* /mydir/ COPY --chown=1 files* /mydir/ COPY --chown=10:11 files* /mydir/ ADD --chown=55:mygroup files* /mydir/ ADD --chown=bin files* /mydir/ ADD --chown=1 files* /mydir/ ADD --chown=10:11 files* /mydir/ FROM ubuntu:18.04 RUN apt-get update \\ \u0026amp;\u0026amp; apt-get install -y curl \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* ENTRYPOINT [ \u0026quot;curl\u0026quot;, \u0026quot;-s\u0026quot;, \u0026quot;http://myip.ipip.net\u0026quot; ] FROM ubuntu:18.04 RUN apt-get update \\ \u0026amp;\u0026amp; apt-get install -y curl \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* ENTRYPOINT [ \u0026quot;curl\u0026quot;, \u0026quot;-s\u0026quot;, \u0026quot;http://myip.ipip.net\u0026quot; ] ENV VERSION=1.0 DEBUG=on \\ NAME=\u0026quot;Happy Feet\u0026quot; # åé¢çš„æŒ‡ä»¤ä¸­ï¼Œå¯ä»¥é€šè¿‡$VERSIONã€$NAMEæ¥å¼•ç”¨ã€‚åˆ—æŒ‡ä»¤å¯ä»¥æ”¯æŒç¯å¢ƒå˜é‡å±•å¼€ï¼š # ADDã€COPYã€ENVã€EXPOSEã€FROMã€LABELã€USERã€WORKDIRã€VOLUMEã€STOPSIGNALã€ONBUILDã€RUNã€‚ ARG DOCKER_USERNAME=library FROM ${DOCKER_USERNAME}/alpine # åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡ï¼Œå¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} FROM ${DOCKER_USERNAME}/alpine # åœ¨FROM ä¹‹åä½¿ç”¨å˜é‡ï¼Œå¿…é¡»åœ¨æ¯ä¸ªé˜¶æ®µåˆ†åˆ«æŒ‡å®š ARG DOCKER_USERNAME=library RUN set -x ; echo ${DOCKER_USERNAME} RUN groupadd -r redis \u0026amp;\u0026amp; useradd -r -g redis redis USER redis RUN [ \u0026quot;redis-server\u0026quot; ] FROM nginx RUN apt-get update \u0026amp;\u0026amp; apt-get install -y curl \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* HEALTHCHECK --interval=5s --timeout=3s \\ CMD curl -fs http://localhost/ || exit 1 Dockerfileå¤šé˜¶æ®µæ„å»º åœ¨Docker 17.05ä¹‹åï¼Œå¼€å§‹æ”¯æŒå¤šé˜¶æ®µæ„å»º (multistage builds)ã€‚è§£å†³äº†ä¹‹å‰ç¼–å†™2ä¸ªDockerfileçš„æ–¹æ¡ˆï¼Œä¸€ä¸ªDockerfileæŠŠé¡¹ç›®åŠå…¶ä¾èµ–åº“ç¼–è¯‘æµ‹è¯•æ‰“åŒ…ï¼Œä¸€ä¸ªDockerfileæ„å»ºè¿è¡Œé•œåƒåŒ…ï¼ŒæŠŠä¹‹å‰çš„æ„å»ºç»“æœæ‹·è´åˆ°è¿è¡Œç¯å¢ƒã€‚\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ as æ¥ä¸ºæŸä¸€é˜¶æ®µå‘½åï¼Œä¾‹å¦‚\n FROM golang:alpine as builder ä¸€ä¸ªä¸ºgoç¨‹åºï¼Œå¤šé˜¶æ®µæ„å»ºçš„ä¾‹å­ï¼š\nFROM golang:alpine as builder RUN apk --no-cache add git WORKDIR /go/src/github.com/go/helloworld/ RUN go get -d -v github.com/go-sql-driver/mysql COPY app.go . RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app . FROM alpine:latest as prod RUN apk --no-cache add ca-certificates WORKDIR /root/ COPY --from=0 /go/src/github.com/go/helloworld/app . CMD [\u0026quot;./app\u0026quot;] ä¾‹å¦‚å½“æˆ‘ä»¬åªæƒ³æ„å»º builder é˜¶æ®µçš„é•œåƒæ—¶ï¼Œå¢åŠ  \u0026ndash;target=builder å‚æ•°å³å¯\n docker build --target builder -t username/imagename:tag . æ„å»ºæ—¶ä»å…¶ä»–é•œåƒå¤åˆ¶æ–‡ä»¶\n COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf æ„å»ºå¤šç§ç³»ç»Ÿæ¶æ„æ”¯æŒçš„ Docker é•œåƒ å‚è§ï¼šhttps://yeasy.gitbook.io/docker_practice/image/manifest\nDocker é•œåƒçš„å¯¼å…¥å’Œå¯¼å‡º docker save å’Œ docker load    å‘½ä»¤ç¤ºä¾‹ è¯´æ˜     docker save alpine -o filename æŠŠalphineé•œåƒä¿å­˜åˆ°filenameæ–‡ä»¶   docker save alpine gzip \u0026gt; alpine-latest.tar.gz   docker load -i alpine-latest.tar.gz æŠŠalpine-latest.tar.gzé•œåƒå‹ç¼©æ–‡ä»¶å¯¼å…¥åˆ°Dockerç³»ç»Ÿä¸­    æ“ä½œé•œåƒ    å‘½ä»¤ç¤ºä¾‹ è¯´æ˜     docker run ubuntu:18.04 /bin/echo \u0026lsquo;Hello world\u0026rsquo; é€šè¿‡é•œåƒï¼Œè¾“å‡ºä¸€ä¸ª â€œHello Worldâ€ï¼Œä¹‹åç»ˆæ­¢å®¹å™¨   docker run -t -i ubuntu:18.04 /bin/bash å¯åŠ¨ä¸€ä¸ª bash ç»ˆç«¯ï¼Œå…è®¸ç”¨æˆ·è¿›è¡Œäº¤äº’   docker container start å†å²å®¹å™¨ å°†ä¸€ä¸ªå·²ç»ç»ˆæ­¢ï¼ˆexitedï¼‰çš„å®¹å™¨å¯åŠ¨è¿è¡Œ   docker run -d ubuntu:18.04 /bin/sh -c \u0026ldquo;\u0026hellip;è„šæœ¬\u0026rdquo; -då®¹å™¨è¾“å‡ºåˆ°å®¹å™¨ä¸­ï¼Œä¼šè¿”å›ä¸€ä¸ªå”¯ä¸€çš„id   docker container ls å¯ä»¥çœ‹åˆ°å®¹å™¨idï¼Œè¿è¡Œä¸­çš„   docker container ls -a æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ŒåŠ äº†-aåŒ…æ‹¬å·²ç»ç»ˆæ­¢çš„å®¹å™¨   docker container logs [container ID or NAMES] å¯ä»¥è·å–å®¹å™¨çš„è¾“å‡ºä¿¡æ¯   docker container stop [container ID or NAMES] ç»ˆæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨   docker exec -it 69d1 bash è¿›å…¥container IDä»¥69d1å¼€å¤´çš„å®¹å™¨ï¼Œæ‰“å¼€bashï¼Œé€€å‡ºæ—¶ï¼Œå®¹å™¨ç»§ç»­è¿è¡Œ   docker attach -it 69d1 bash è¿›å…¥container IDä»¥69d1å¼€å¤´çš„å®¹å™¨ï¼Œæ‰“å¼€bashï¼Œé€€å‡ºæ—¶ï¼Œå®¹å™¨åœæ­¢   docker export 7691a814370e \u0026gt; ubuntu.tar å¯¼å‡ºå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°æ–‡ä»¶   cat ubuntu.tar docker import - test/ubuntu:v1.0   docker import http://example.com/exampleimage.tgz example/imagerepo é€šè¿‡æŒ‡å®š URL æˆ–è€…æŸä¸ªç›®å½•æ¥å¯¼å…¥   docker container rm trusting_newton åˆ é™¤ä¸€ä¸ªå¤„äºç»ˆæ­¢çŠ¶æ€çš„NAMESä¸ºtrusting_newtonçš„å®¹å™¨   docker container prune æ¸…ç†æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨    æ•°æ®ç®¡ç†    å‘½ä»¤ç¤ºä¾‹ è¯´æ˜     docker volume create my-vol åˆ›å»ºä¸€ä¸ªåç§°ä¸ºmy-volçš„æ•°æ®å·ï¼Œå®¿ä¸»æœºé»˜è®¤ç›®å½•/var/lib/docker/volumes/my-vol/_data   docker volume ls æŸ¥çœ‹æ‰€æœ‰çš„ æ•°æ®å·   docker volume inspect my-vol åœ¨ä¸»æœºé‡ŒæŸ¥çœ‹æŒ‡å®š æ•°æ®å· çš„ä¿¡æ¯   docker run -v my-vol:/usr/share/nginx/html [å…¶ä»–çœç•¥] è¿è¡Œæ—¶åŠ è½½my-volæ•°æ®å· åˆ°å®¹å™¨çš„ /usr/share/nginx/html ç›®å½•   docker run \u0026ndash;mount source=my-vol,target=/usr/share/nginx/html [å…¶ä»–çœç•¥] åŒä¸Šï¼Œå¦ä¸€ç§å†™æ³•   docker inspect web æŸ¥çœ‹webå®¹å™¨æ—¶ï¼Œå¯ä»¥åœ¨Moutsä¸­æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯   docker volume rm my-vol åˆ é™¤æ•°æ®å·   docker rm -v \u0026lt;å®¹å™¨IDæˆ–åç§°\u0026gt; åˆ é™¤å®¹å™¨æ—¶ï¼ŒåŒæ—¶ç§»é™¤æ•°æ®å·   docker volume prune æ¸…ç†æ— ä¸»çš„æ•°æ®å·   docker -v /src/webapp:/usr/share/nginx/html [å…¶ä»–çœç•¥] æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å»   docker \u0026ndash;mount type=bind,source=/src/webapp,target=/usr/share/nginx/html [å…¶ä»–çœç•¥] åŒä¸Šï¼Œå¦ä¸€ç§ä¸¥æ ¼å†™æ³•   -v /src/webapp:/usr/share/nginx/html:ro [å…¶ä»–çœç•¥] roè¡¨ç¤ºåªè¯»ï¼Œä¸åŠ è¡¨ç¤ºè¯»å†™   \u0026ndash;mount type=bind,source=/src/webapp,target=/usr/share/nginx/html,readonly [å…¶ä»–çœç•¥] è¡¨ç¤ºåªè¯»   -v $HOME/.bash_history:/root/.bash_history [å…¶ä»–çœç•¥] æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºæ–‡ä»¶ä½œä¸ºæ•°æ®å·   \u0026ndash;mount type=bind,source=$HOME/.bash_history,target=/root/.bash_history [å…¶ä»–çœç•¥] åŒä¸Š    ä½¿ç”¨ç½‘ç»œ    å‘½ä»¤ åŠŸèƒ½     docker run -p [å…¶ä»–çœç•¥] -péšæœºæ˜ å°„ç«¯å£åˆ°å†…éƒ¨å®¹å™¨å¼€æ”¾çš„ç½‘ç»œç«¯å£   docker container ls åˆ—è¡¨ä¸­PORTSï¼ˆå¦‚0.0.0.0:32768-\u0026gt;80/tcpï¼‰å‰ä¸€ä¸ªè¡¨ç¤ºå®¿ä¸»æœºç«¯å£   docker logs \u0026lt;å®¹å™¨ID\u0026gt; ä¸Šé¢å·²æè¿°ï¼ŒæŸ¥çœ‹å®¹å™¨å†…çš„æ‰“å°   docker run -p ip:hostPort:containerPort [å…¶ä»–çœç•¥] æŒ‡å®šæ˜ å°„ç«¯å£ï¼Œ-på¯ä»¥å¤šæ¬¡ä½¿ç”¨   docker run -p ip::containerPort [å…¶ä»–çœç•¥] æŒ‡å®šæ˜ å°„ç«¯å£   docker run -p hostPort:containerPort [å…¶ä»–çœç•¥] æŒ‡å®šæ˜ å°„ç«¯å£   docker port \u0026lt;å®¹å™¨ID\u0026gt; \u0026lt;å®¹å™¨ç«¯å£\u0026gt; æŸ¥çœ‹å½“å‰æ˜ å°„çš„ç«¯å£é…ç½®ï¼Œå’Œç»‘å®šçš„åœ°å€   docker network create -d bridge my-net åˆ›å»ºDockerç½‘ç»œï¼Œ-dæŒ‡å®šç±»å‹ï¼Œæœ‰bridge\\overlayï¼Œmy-netæ˜¯åç§°   mount åœ¨å®¹å™¨ä¸­ä½¿ç”¨mountå¯æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯   docker run [å…¶ä»–çœç•¥] cat /etc/resolv.conf å¯åŠ¨æ—¶ï¼ŒæŸ¥çœ‹DNSé…ç½®   docker run [å…¶ä»–çœç•¥] -h HOSTNAME è®¾å®šå®¹å™¨çš„ä¸»æœºåï¼Œå†™åˆ°å®¹å™¨å†…çš„/etc/hostname å’Œ/etc/hostsï¼Œå¤–åŒ…çœ‹ä¸åˆ°   docker run [å…¶ä»–çœç•¥] \u0026ndash;dns=IP_ADDRESS æ·»åŠ  DNS æœåŠ¡å™¨åˆ°å®¹å™¨çš„/etc/resolv.conf ä¸­ï¼Œç­‰åœ¨å®¿ä¸»/etc/hosts ä¸´æ—¶å¢åŠ     Dockerfileæœ€ä½³å®è·µæŒ‡å—  ä¸å¸¸å˜åŠ¨çš„éƒ¨åˆ†å†™åœ¨dockerfileä¸Šé¢ï¼Œä»¥ä¾¿åç»­å˜æ›´æ—¶å¯ä»¥åˆ©ç”¨ç¼“å­˜ï¼Œå‡å°‘buildæ—¶é—´ã€‚ ç¼–å†™ .dockerignore ç¼–è¯‘é•œåƒæ—¶ï¼Œdocker å…ˆè¦å‡†å¤‡ç¼–è¯‘ç”¨çš„contextï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šæŠŠ Dockerfileæ‰€åœ¨çš„æ‰€åœ¨æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶åŒ…å«è¿›å»ï¼Œå¦‚æœä¸æƒ³æŠŠsrcç›®å½•åŒ…å«è¿›å»æ¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œå¯ä»¥æ·»åŠ .dockerignoreï¼Œå†…å®¹å¦‚ä¸‹ src/ RUN rm xxx åˆ é™¤å‰é¢å±‚çš„æ–‡ä»¶ä¸ä¼šå‡å°é•œåƒå¤§å°ï¼Œå› ä¸ºåŒ…å«æ–‡ä»¶çš„é‚£å±‚ä¼šä¸€ç›´å­˜åœ¨ï¼ŒRUN setåˆå¹¶ä¸ºä¸€å±‚ å°½é‡ä¸åœ¨dockerfileå»ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œä¿®æ”¹æƒé™åçš„æ–‡ä»¶ä¼šç”Ÿæˆä¸€ä»½æ–°çš„æ–‡ä»¶å¯¼è‡´é•œåƒå˜å¤§ï¼Œä¿®æ”¹æƒé™æœ€å¥½æœ¬åœ°ç›´æ¥æ”¹å¥½æˆ–å†™åœ¨å¯åŠ¨è„šæœ¬ä¸­(ä¸æ¨è)ã€‚ åªå¤åˆ¶éœ€è¦çš„ï¼Œå¦‚æœå¯èƒ½ï¼Œé¿å…å¤åˆ¶ã€‚åœ¨å°†æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­æ—¶ï¼Œè¯·ç¡®ä¿å¯¹è¦å¤åˆ¶çš„å†…å®¹éå¸¸æ˜ç¡®ï¼Œé¿å… COPY . /home/admin/broker è¿™æ ·çš„æ“ä½œï¼Œä½¿ç”¨COPY app/xxx.jar /home/admin/broker æ·»åŠ æ–‡ä»¶å¤¹åˆ°æŒ‡å®šç›®å½•ï¼Œæœ€å¥½å¡«å†™ç»å¯¹è·¯å¾„ï¼Œå¦‚æœæƒ³æŠŠkafkaæ–‡ä»¶å¤¹æ·»åŠ åˆ°homeï¼Œè¦å†™æˆADD kafka/ /home/kafka/ å¤§çš„rpmåŒ…ï¼Œå¦‚æœè¦å®‰è£…åˆ°é•œåƒä¸­ï¼Œå¯ä»¥åšæˆyum æºï¼Œyum install xxä¹‹åyum clean allï¼Œå¦‚æœADD XX.rpm /xxï¼Œè¿™æ ·rpmä¼šä½¿é•œåƒå¢å¤§ã€‚ å¤§çš„å‹ç¼©åŒ…æœ€å¥½æ˜¯åšæˆå¯ä»¥ä¸‹è½½çš„æ–‡ä»¶ï¼Œä¸‹è½½è§£å‹ååˆ é™¤æºæ–‡ä»¶ å¤šä¸ªRUNæˆ–è€…ENVæœ€å¥½åˆå¹¶ä¸ºä¸€ä¸ªï¼Œè¿™æ ·ç”Ÿæˆçš„æ–‡ä»¶éƒ½åœ¨åŒä¸€å±‚ï¼Œä¾¿äºä¼˜åŒ–å¤§å° å»æ‰ä¸å¿…è¦çš„ç»„ä»¶ï¼Œæ¯”å¦‚ yum install vim ä¸å®‰è£…è¿è¡Œä¸å¿…é¡»å¾—vimï¼Œå¯ä»¥å‡å°é•œåƒä½“ç§¯ æ¯æ¬¡RUNçš„åé¢é˜¶æ®µåˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ yum install xx å®‰è£…è½¯ä»¶åè¦æ‰§è¡Œ yum clean all æ¸…é™¤ç¼“å­˜ï¼Œå‡å°é•œåƒã€‚ åŸºç¡€é•œåƒè¦æŒ‡å®šæ˜ç¡®çš„ç‰ˆæœ¬ FROM openjdk:latest å»ºè®®ä½¿ç”¨ FROM openjdk:8-jre-alpine åŸºç¡€é•œåƒå¦‚æœå¯èƒ½ï¼Œå°½é‡ä½¿ç”¨å®˜æ–¹å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œç¬¬ä¸‰æ–¹çš„ç‰ˆæœ¬æœ‰è¢«æ¤å…¥ç—…æ¯’çš„é£é™©ï¼Œè€Œä¸”æ²¡æ³•ä¿è¯åŠæ—¶è¡¥ä¸å‡çº§å’Œæ›´æ–° åŸºç¡€é•œåƒå°½é‡é€‰æ‹©å°ä½“ç§¯çš„å‘è¡Œç‰ˆæœ¬ï¼Œæ¯”å¦‚åŸºäºalpine linuxåˆ¶ä½œçš„é•œåƒï¼Œ åˆ†é˜¶æ®µç¼–è¯‘ï¼Œdocker 17.05 ç‰ˆæœ¬ä»¥åå¼€å§‹æ”¯æŒåˆ†é˜¶æ®µç¼–è¯‘ï¼Œå¯ä»¥ä½¿ç”¨ç¼–è¯‘é•œåƒå»ç¼–è¯‘ï¼Œç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¯¼å…¥åˆ°è¿è¡Œç¯å¢ƒé•œåƒä¸­ï¼Œè¿™æ ·ç¼–è¯‘å‡ºçš„é•œåƒå°±å¯ä»¥ä¸éœ€è¦ä¸€äº›ç¼–è¯‘å·¥å…·ï¼Œç¼–è¯‘ä¾èµ–ï¼Œå»æ‰ç¼–è¯‘ä¸­äº§ç”Ÿçš„æ— ç”¨æ–‡ä»¶ WORKDIR ä¸º RUN CMD ENTRYPOINTæŒ‡å®šä¸€ä¸ªé»˜è®¤çš„å·¥ä½œç›®å½• å¯åŠ¨è„šæœ¬ä¸­æœ€å¥½ä½¿ç”¨ execå»è¿è¡Œç¨‹åº ä½¿ç”¨LABELå»æ·»åŠ ä¸€äº›é™„å±ä¿¡æ¯ï¼Œæ¯”å¦‚ä½œè€…ï¼Œè”ç³»æ–¹å¼ï¼Œå†…éƒ¨è½¯ä»¶ç‰ˆæœ¬ä¹‹ç±» ä½¿ç”¨HEALTHCHECKæ·»åŠ å¥åº·æ£€æŸ¥ï¼Œåˆ¤æ–­æ‹‰èµ·çš„å®¹å™¨ä¸šåŠ¡æ˜¯å¦æ­£å¸¸  FROM golang:1.7.3 AS builder WORKDIR /go/src/github.com/alexellis/href-counter/ RUN go get -d -v golang.org/x/net/html COPY app.go . RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app . FROM alpine:latest RUN apk --no-cache add ca-certificates WORKDIR /root/ COPY --from=builder /go/src/github.com/alexellis/href-counter/app . CMD [\u0026quot;./app\u0026quot;] Docker å®æˆ˜ä¸ç»ƒä¹  Docker å®æˆ˜ä¸ç»ƒä¹ \n","date":"2021-11-05T22:00:38+08:00","image":"https://zcj-git520.github.io/p/docker%E7%9F%A5%E8%AF%86%E6%80%BB%E8%A7%88/1_hub2f0788524e05f802191dca26df6a25d_10280_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/docker%E7%9F%A5%E8%AF%86%E6%80%BB%E8%A7%88/","title":"DockerçŸ¥è¯†æ€»è§ˆ"},{"content":"æ–‡ç« æ¥æº é¹…å‚(è…¾è®¯)ä»£ç å®‰å…¨æŒ‡å—\né€šç”¨ åŠ å¯†ç®—æ³• ã€å¿…é¡»ã€‘é¿å…ä½¿ç”¨ä¸å®‰å…¨çš„å¯¹ç§°åŠ å¯†ç®—æ³•  DESå’Œ3DESå·²ç»ä¸å†é€‚ç”¨äºç°ä»£åº”ç”¨ç¨‹åºï¼Œåº”æ”¹ä¸ºä½¿ç”¨AESã€‚  ç¨‹åºæ—¥å¿— ã€å»ºè®®ã€‘å¯¹æ¯ä¸ªé‡è¦è¡Œä¸ºéƒ½è®°å½•æ—¥å¿—  ç¡®ä¿é‡è¦è¡Œä¸ºéƒ½è®°å½•æ—¥å¿—ï¼Œä¸”å¯é ä¿å­˜6ä¸ªæœˆä»¥ä¸Šã€‚  1.2.2 ã€å»ºè®®ã€‘ç¦æ­¢å°†æœªç»éªŒè¯çš„ç”¨æˆ·è¾“å…¥ç›´æ¥è®°å½•æ—¥å¿—  å½“æ—¥å¿—æ¡ç›®åŒ…å«æœªç»å‡€åŒ–çš„ç”¨æˆ·è¾“å…¥æ—¶ä¼šå¼•å‘è®°å½•æ³¨å…¥æ¼æ´ã€‚æ¶æ„ç”¨æˆ·ä¼šæ’å…¥ä¼ªé€ çš„æ—¥å¿—æ•°æ®ï¼Œä»è€Œè®©ç³»ç»Ÿç®¡ç†å‘˜ä»¥ä¸ºæ˜¯ç³»ç»Ÿè¡Œä¸ºã€‚  1.2.3 ã€å»ºè®®ã€‘é¿å…åœ¨æ—¥å¿—ä¸­ä¿å­˜æ•æ„Ÿä¿¡æ¯  ä¸èƒ½åœ¨æ—¥å¿—ä¿å­˜å¯†ç ï¼ˆåŒ…æ‹¬æ˜æ–‡å¯†ç å’Œå¯†æ–‡å¯†ç ï¼‰ã€å¯†é’¥å’Œå…¶å®ƒæ•æ„Ÿä¿¡æ¯  ç³»ç»Ÿå£ä»¤ ã€å¿…é¡»ã€‘ç¦æ­¢ä½¿ç”¨ç©ºå£ä»¤ã€å¼±å£ä»¤ã€å·²æ³„éœ²å£ä»¤ ã€å¿…é¡»ã€‘å£ä»¤å¼ºåº¦è¦æ±‚  å£ä»¤å¼ºåº¦é¡»åŒæ—¶æ»¡è¶³ï¼š\n å¯†ç é•¿åº¦å¤§äº14ä½ å¿…é¡»åŒ…å«ä¸‹åˆ—å…ƒç´ ï¼šå¤§å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ ä¸å¾—ä½¿ç”¨å„ç³»ç»Ÿã€ç¨‹åºçš„é»˜è®¤åˆå§‹å¯†ç  ä¸èƒ½ä¸æœ€è¿‘6æ¬¡ä½¿ç”¨è¿‡çš„å¯†ç é‡å¤ ä¸å¾—ä¸å…¶ä»–å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ç›¸åŒçš„å¯†ç    ã€å¿…é¡»ã€‘å£ä»¤å­˜å‚¨å®‰å…¨  ç¦æ­¢æ˜æ–‡å­˜å‚¨å£ä»¤ ç¦æ­¢ä½¿ç”¨å¼±å¯†ç å­¦ç®—æ³•ï¼ˆå¦‚DESå’Œ3DESï¼‰åŠ å¯†å­˜å‚¨å£ä»¤ ä½¿ç”¨ä¸å¯é€†ç®—æ³•å’Œéšæœºsaltå¯¹å£ä»¤è¿›è¡ŒåŠ å¯†å­˜å‚¨  ã€å¿…é¡»ã€‘ç¦æ­¢ä¼ é€’æ˜æ–‡å£ä»¤ ã€å¿…é¡»ã€‘ç¦æ­¢åœ¨ä¸å®‰å…¨çš„ä¿¡é“ä¸­ä¼ è¾“å£ä»¤ é…ç½®\u0026amp;ç¯å¢ƒ Pythonç‰ˆæœ¬é€‰æ‹© ã€å»ºè®®ã€‘ä½¿ç”¨Python 3.6+çš„ç‰ˆæœ¬  æ–°å¢çš„é¡¹ç›®åº”ä½¿ç”¨ Python 3.6+   ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ ç”±äº Python 2 åœ¨ 2020 å¹´åœæ­¢ç»´æŠ¤ï¼Œç›¸å…³ç»„ä»¶çš„æ¼æ´ä¸èƒ½å¾—åˆ°åŠæ—¶ä¿®å¤ä¸ç»´æŠ¤\n ç¬¬ä¸‰æ–¹åŒ…å®‰å…¨ ã€å¿…é¡»ã€‘ç¦æ­¢ä½¿ç”¨ä¸å®‰å…¨çš„ç»„ä»¶ é…ç½®ä¿¡æ¯ ã€å¿…é¡»ã€‘å¯†é’¥å­˜å‚¨å®‰å…¨  åœ¨ä½¿ç”¨å¯¹ç§°å¯†ç ç®—æ³•æ—¶ï¼Œéœ€è¦ä¿æŠ¤å¥½åŠ å¯†å¯†é’¥ã€‚å½“ç®—æ³•æ¶‰åŠæ•æ„Ÿã€ä¸šåŠ¡æ•°æ®æ—¶ï¼Œå¯é€šè¿‡éå¯¹ç§°ç®—æ³•åå•†åŠ å¯†å¯†é’¥ã€‚å…¶ä»–è¾ƒä¸ºä¸æ•æ„Ÿçš„æ•°æ®åŠ å¯†ï¼Œå¯ä»¥é€šè¿‡å˜æ¢ç®—æ³•ç­‰æ–¹å¼ä¿æŠ¤å¯†é’¥ã€‚  ã€å¿…é¡»ã€‘ç¦æ­¢ç¡¬ç¼–ç æ•æ„Ÿé…ç½®  ç¦æ­¢åœ¨æºç ä¸­ç¡¬ç¼–ç AK/SKã€IPã€æ•°æ®åº“è´¦å¯†ç­‰é…ç½®ä¿¡æ¯ åº”ä½¿ç”¨é…ç½®ç³»ç»Ÿæˆ–KMSå¯†é’¥ç®¡ç†ç³»ç»Ÿã€‚  åå° è¾“å…¥éªŒè¯ ã€å¿…é¡»ã€‘æŒ‰ç±»å‹è¿›è¡Œæ•°æ®æ ¡éªŒ   æ‰€æœ‰ç¨‹åºå¤–éƒ¨è¾“å…¥çš„å‚æ•°å€¼ï¼Œåº”è¿›è¡Œæ•°æ®æ ¡éªŒã€‚æ ¡éªŒå†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼šæ•°æ®é•¿åº¦ã€æ•°æ®èŒƒå›´ã€æ•°æ®ç±»å‹ä¸æ ¼å¼ã€‚æ ¡éªŒä¸é€šè¿‡ï¼Œåº”æ‹’ç»ã€‚\n  æ¨èä½¿ç”¨ç»„ä»¶ï¼šCerberusã€jsonschemaã€Django-Validators\n  # Cerberusç¤ºä¾‹ v = Validator({\u0026#39;name\u0026#39;: {\u0026#39;type\u0026#39;: \u0026#39;string\u0026#39;}}) v.validate({\u0026#39;name\u0026#39;: \u0026#39;john doe\u0026#39;}) # jsonschemaç¤ºä¾‹ schema = { \u0026#34;type\u0026#34; : \u0026#34;object\u0026#34;, \u0026#34;properties\u0026#34; : { \u0026#34;price\u0026#34; : {\u0026#34;type\u0026#34; : \u0026#34;number\u0026#34;}, \u0026#34;name\u0026#34; : {\u0026#34;type\u0026#34; : \u0026#34;string\u0026#34;}, }, } validate(instance={\u0026#34;name\u0026#34; : \u0026#34;Eggs\u0026#34;, \u0026#34;price\u0026#34; : 34.99}, schema=schema) SQLæ“ä½œ ã€å¿…é¡»ã€‘ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢  ä½¿ç”¨å‚æ•°åŒ–SQLè¯­å¥ï¼Œå¼ºåˆ¶åŒºåˆ†æ•°æ®å’Œå‘½ä»¤ï¼Œé¿å…äº§ç”ŸSQLæ³¨å…¥æ¼æ´ã€‚  # é”™è¯¯ç¤ºä¾‹ import mysql.connector mydb = mysql.connector.connect( ... ... ) cur = mydb.cursor() userid = get_id_from_user() # ä½¿ç”¨%ç›´æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‹¼æ¥SQLè¯­å¥ cur.execute(\u0026#34;SELECT `id`, `password` FROM `auth_user` WHERE `id`=%s\u0026#34; % (userid,)) myresult = cur.fetchall() # å®‰å…¨ç¤ºä¾‹ import mysql.connector mydb = mysql.connector.connect( ... ... ) cur = mydb.cursor() userid = get_id_from_user() # å°†å…ƒç»„ä»¥å‚æ•°çš„å½¢å¼ä¼ å…¥ cur.execute(\u0026#34;SELECT `id`, `password` FROM `auth_user` WHERE `id`=%s\u0026#34; , (userid,)) myresult = cur.fetchall()  æ¨èä½¿ç”¨ORMæ¡†æ¶æ¥æ“ä½œæ•°æ®åº“ï¼Œå¦‚ï¼šä½¿ç”¨SQLAlchemyã€‚  # å®‰è£…sqlalchemyå¹¶åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ # pip install sqlalchemy from sqlalchemy import create_engine # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œä¿®æ”¹ä¸ºä½ çš„æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç  engine = create_engine(\u0026#39;mysql+mysqlconnector://user:password@host:port/DATABASE\u0026#39;) # å¼•ç”¨æ•°æ®ç±»å‹ from sqlalchemy import Column, String, Integer, Float from sqlalchemy.ext.declarative import declarative_base Base = declarative_base() # å®šä¹‰ Player å¯¹è±¡: class Player(Base): # è¡¨çš„åå­—: __tablename__ = \u0026#39;player\u0026#39; # è¡¨çš„ç»“æ„: player_id = Column(Integer, primary_key=True, autoincrement=True) team_id = Column(Integer) player_name = Column(String(255)) height = Column(Float(3, 2)) # å¢åˆ æ”¹æŸ¥ from sqlalchemy.orm import sessionmaker # åˆ›å»º DBSession ç±»å‹: DBSession = sessionmaker(bind=engine) # åˆ›å»º session å¯¹è±¡: session = DBSession() # å¢: new_player = Player(team_id=101, player_name=\u0026#34;Tom\u0026#34;, height=1.98) session.add(new_player) # åˆ : row = session.query(Player).filter(Player.player_name==\u0026#34;Tom\u0026#34;).first() session.delete(row) # æ”¹: row = session.query(Player).filter(Player.player_name==\u0026#34;Tom\u0026#34;).first() row.height = 1.99 # æŸ¥: rows = session.query(Player).filter(Player.height \u0026gt;= 1.88).all() # æäº¤å³ä¿å­˜åˆ°æ•°æ®åº“: session.commit() # å…³é—­ session: session.close() ã€å¿…é¡»ã€‘å¯¹å‚æ•°è¿›è¡Œè¿‡æ»¤  å°†æ¥å—åˆ°çš„å¤–éƒ¨å‚æ•°åŠ¨æ€æ‹¼æ¥åˆ°SQLè¯­å¥æ—¶ï¼Œå¿…é¡»å¯¹å‚æ•°è¿›è¡Œå®‰å…¨è¿‡æ»¤ã€‚  def sql_filter(sql, max_length=20): dirty_stuff = [\u0026#34;\\\u0026#34;\u0026#34;, \u0026#34;\\\\\u0026#34;, \u0026#34;/\u0026#34;, \u0026#34;*\u0026#34;, \u0026#34;\u0026#39;\u0026#34;, \u0026#34;=\u0026#34;, \u0026#34;-\u0026#34;, \u0026#34;#\u0026#34;, \u0026#34;;\u0026#34;, \u0026#34;\u0026lt;\u0026#34;, \u0026#34;\u0026gt;\u0026#34;, \u0026#34;+\u0026#34;, \u0026#34;\u0026amp;\u0026#34;, \u0026#34;$\u0026#34;, \u0026#34;(\u0026#34;, \u0026#34;)\u0026#34;, \u0026#34;%\u0026#34;, \u0026#34;@\u0026#34;, \u0026#34;,\u0026#34;] for stuff in dirty_stuff: sql = sql.replace(stuff, \u0026#34;x\u0026#34;) return sql[:max_length] æ‰§è¡Œå‘½ä»¤ ã€å»ºè®®ã€‘é¿å…ç›´æ¥è°ƒç”¨å‡½æ•°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤  ç›¸å…³åŠŸèƒ½çš„å®ç°åº”é¿å…ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼ˆå¦‚os.system()ã€os.popen()ã€subprocess.call()ç­‰ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨å…¶ä»–åŒç±»æ“ä½œè¿›è¡Œä»£æ›¿ï¼Œæ¯”å¦‚ï¼šé€šè¿‡æ–‡ä»¶ç³»ç»ŸAPIè¿›è¡Œæ–‡ä»¶æ“ä½œè€Œéç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿå‘½ä»¤ å¦‚è¯„ä¼°æ— æ³•é¿å…ï¼Œæ‰§è¡Œå‘½ä»¤åº”é¿å…æ‹¼æ¥å¤–éƒ¨æ•°æ®ï¼ŒåŒæ—¶è¿›è¡Œæ‰§è¡Œå‘½ä»¤çš„ç™½åå•é™åˆ¶ã€‚  ã€å¿…é¡»ã€‘è¿‡æ»¤ä¼ å…¥å‘½ä»¤æ‰§è¡Œå‡½æ•°çš„å­—ç¬¦  ç¨‹åºè°ƒç”¨å„ç±»å‡½æ•°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æ—¶ï¼Œå¦‚æœæ¶‰åŠçš„å‘½ä»¤ç”±å¤–éƒ¨ä¼ å…¥ï¼Œè¿‡æ»¤ä¼ å…¥å‘½ä»¤æ‰§è¡Œå‡½æ•°çš„å­—ç¬¦ã€‚  import os import sys import shlex domain = sys.argv[1] # æ›¿æ¢å¯ä»¥ç”¨æ¥æ³¨å…¥å‘½ä»¤çš„å­—ç¬¦ä¸ºç©º badchars = \u0026#34;\\n\u0026amp;;|\u0026#39;\\\u0026#34;$()`-\u0026#34; for char in badchars: domain = domain.replace(char, \u0026#34; \u0026#34;) result = os.system(\u0026#34;nslookup \u0026#34; + shlex.quote(domain)) XMLè¯»å†™ ã€å¿…é¡»ã€‘ç¦ç”¨å¤–éƒ¨å®ä½“çš„æ–¹æ³•  ç¦ç”¨å¤–éƒ¨å®ä½“çš„æ–¹æ³•ï¼Œæ¥é¢„é˜²XXEæ”»å‡»ã€‚  from lxml import etree xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False)) æ–‡ä»¶æ“ä½œ ã€å¿…é¡»ã€‘æ–‡ä»¶ç±»å‹é™åˆ¶  é€šè¿‡ç™½åå•å¯¹ä¸Šä¼ æˆ–è€…ä¸‹è½½çš„æ–‡ä»¶ç±»å‹ã€å¤§å°è¿›è¡Œä¸¥æ ¼æ ¡éªŒã€‚ä»…å…è®¸ä¸šåŠ¡æ‰€éœ€æ–‡ä»¶ç±»å‹ä¸Šä¼ ï¼Œé¿å…ä¸Šä¼ æœ¨é©¬ã€WebShellç­‰æ–‡ä»¶ã€‚  import os ALLOWED_EXTENSIONS = [\u0026#39;txt\u0026#39;,\u0026#39;jpg\u0026#39;,\u0026#39;png\u0026#39;] def allowed_file(filename): if (\u0026#39;.\u0026#39; in filename and \u0026#39;..\u0026#39; not in filename and os.path.splitext(filename)[1].lower() in ALLOWED_EXTENSIONS): return filename return None ã€å¿…é¡»ã€‘ç¦æ­¢å¤–éƒ¨æ–‡ä»¶å­˜å‚¨äºå¯æ‰§è¡Œç›®å½•  ç¦æ­¢å¤–éƒ¨æ–‡ä»¶å­˜å‚¨äºWEBå®¹å™¨çš„å¯æ‰§è¡Œç›®å½•ï¼ˆappBaseï¼‰ã€‚å»ºè®®ä½¿ç”¨ tempfile åº“å¤„ç†ä¸´æ—¶æ–‡ä»¶å’Œä¸´æ—¶ç›®å½•ã€‚  ã€å¿…é¡»ã€‘é¿å…è·¯å¾„ç©¿è¶Š  ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œå¿…é¡»å¯¹è·¯å¾„è¿›è¡Œåˆæ³•æ ¡éªŒï¼Œé¿å…ç›®å½•ç©¿è¶Šæ¼æ´  import os upload_dir = \u0026#39;/tmp/upload/\u0026#39; # é¢„æœŸçš„ä¸Šä¼ ç›®å½• file_name = \u0026#39;../../etc/hosts\u0026#39; # ç”¨æˆ·ä¼ å…¥çš„æ–‡ä»¶å absolute_path = os.path.join(upload_dir, file_name) # /tmp/upload/../../etc/hosts normalized_path = os.path.normpath(absolute_path) # /etc/hosts if not normalized_path.startswith(upload_dir): # æ£€æŸ¥æœ€ç»ˆè·¯å¾„æ˜¯å¦åœ¨é¢„æœŸçš„ä¸Šä¼ ç›®å½•ä¸­ raise IOError() ã€å»ºè®®ã€‘é¿å…è·¯å¾„æ‹¼æ¥  æ–‡ä»¶ç›®å½•é¿å…å¤–éƒ¨å‚æ•°æ‹¼æ¥ã€‚ä¿å­˜æ–‡ä»¶ç›®å½•å»ºè®®åå°å†™æ­»å¹¶å¯¹æ–‡ä»¶åè¿›è¡Œæ ¡éªŒï¼ˆå­—ç¬¦ç±»å‹ã€é•¿åº¦ï¼‰ã€‚  ã€å»ºè®®ã€‘æ–‡ä»¶åhashåŒ–å¤„ç†  å»ºè®®æ–‡ä»¶ä¿å­˜æ—¶ï¼Œå°†æ–‡ä»¶åæ›¿æ¢ä¸ºéšæœºå­—ç¬¦ä¸²ã€‚  import uuid def random_filename(filename): ext = os.path.splitext(filename)[1] new_filename = uuid.uuid4().hex + ext return new_filename ç½‘ç»œè¯·æ±‚ ã€å¿…é¡»ã€‘é™å®šè®¿é—®ç½‘ç»œèµ„æºåœ°å€èŒƒå›´ å½“ç¨‹åºéœ€è¦ä»ç”¨æˆ·æŒ‡å®šçš„URLåœ°å€è·å–ç½‘é¡µæ–‡æœ¬å†…å®¹ã€åŠ è½½æŒ‡å®šåœ°å€çš„å›¾ç‰‡ã€è¿›è¡Œä¸‹è½½ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦å¯¹URLåœ°å€è¿›è¡Œå®‰å…¨æ ¡éªŒï¼š\n  åªå…è®¸HTTPæˆ–HTTPSåè®®\n  è§£æç›®æ ‡URLï¼Œè·å–å…¶host\n  è§£æhostï¼Œè·å–hostæŒ‡å‘çš„IPåœ°å€è½¬æ¢æˆlongå‹\n  æ£€æŸ¥IPåœ°å€æ˜¯å¦ä¸ºå†…ç½‘IP\n  # ä»¥RFCå®šä¹‰çš„ä¸“æœ‰ç½‘ç»œä¸ºä¾‹ï¼Œå¦‚æœ‰è‡ªå®šä¹‰ç§æœ‰ç½‘æ®µäº¦åº”åŠ å…¥ç¦æ­¢è®¿é—®åˆ—è¡¨ã€‚ 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8  è¯·æ±‚URL\n  å¦‚æœæœ‰è·³è½¬ï¼Œè·³è½¬åæ‰§è¡Œ1ï¼Œå¦åˆ™å¯¹URLå‘èµ·è¯·æ±‚\n  å“åº”è¾“å‡º ã€å¿…é¡»ã€‘è®¾ç½®æ­£ç¡®çš„HTTPå“åº”åŒ…ç±»å‹ å“åº”åŒ…çš„HTTPå¤´â€œContent-Typeâ€å¿…é¡»æ­£ç¡®é…ç½®å“åº”åŒ…çš„ç±»å‹ï¼Œç¦æ­¢éHTMLç±»å‹çš„å“åº”åŒ…è®¾ç½®ä¸ºâ€œtext/htmlâ€ã€‚\nã€å¿…é¡»ã€‘è®¾ç½®å®‰å…¨çš„HTTPå“åº”å¤´   X-Content-Type-Options\næ·»åŠ â€œX-Content-Type-Optionsâ€å“åº”å¤´å¹¶å°†å…¶å€¼è®¾ç½®ä¸ºâ€œnosniff â€\n  HttpOnly æ§åˆ¶ç”¨æˆ·ç™»é‰´æƒçš„Cookieå­—æ®µ åº”å½“è®¾ç½®HttpOnlyå±æ€§ä»¥é˜²æ­¢è¢«XSSæ¼æ´/JavaScriptæ“çºµæ³„æ¼ã€‚\n  X-Frame-Options\nè®¾ç½®X-Frame-Optionså“åº”å¤´ï¼Œå¹¶æ ¹æ®éœ€æ±‚åˆç†è®¾ç½®å…¶å…è®¸èŒƒå›´ã€‚è¯¥å¤´ç”¨äºæŒ‡ç¤ºæµè§ˆå™¨ç¦æ­¢å½“å‰é¡µé¢åœ¨frameã€ iframeã€embedç­‰æ ‡ç­¾ä¸­å±•ç°ã€‚ä»è€Œé¿å…ç‚¹å‡»åŠ«æŒé—®é¢˜ã€‚å®ƒæœ‰ä¸‰ä¸ªå¯é€‰çš„å€¼: DENY: æµè§ˆå™¨ä¼šæ‹’ç»å½“å‰é¡µé¢åŠ  è½½ä»»ä½•frameé¡µé¢; SAMEORIGIN:åˆ™frameé¡µé¢çš„åœ°å€åªèƒ½ä¸ºåŒæºåŸŸåä¸‹çš„é¡µé¢ ALLOW-FROM origin:å¯ä»¥å®š ä¹‰å…è®¸frameåŠ è½½çš„é¡µé¢åœ°å€ã€‚\n  ã€å¿…é¡»ã€‘å¯¹å¤–è¾“å‡ºé¡µé¢åŒ…å«ç¬¬ä¸‰æ–¹æ•°æ®æ—¶é¡»è¿›è¡Œç¼–ç å¤„ç†  å½“å“åº”â€œContent-Typeâ€ä¸ºâ€œtext/htmlâ€ç±»å‹æ—¶ï¼Œéœ€è¦å¯¹å“åº”ä½“è¿›è¡Œç¼–ç å¤„ç†  # æ¨èä½¿ç”¨mozillaç»´æŠ¤çš„bleachåº“æ¥è¿›è¡Œè¿‡æ»¤ import bleach bleach.clean(\u0026#39;an \u0026lt;script\u0026gt;evil()\u0026lt;/script\u0026gt; example\u0026#39;) # u\u0026#39;an \u0026amp;lt;script\u0026amp;gt;evil()\u0026amp;lt;/script\u0026amp;gt; example\u0026#39; æ•°æ®è¾“å‡º ã€å¿…é¡»ã€‘æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨  æ•æ„Ÿæ•°æ®åº”ä½¿ç”¨SHA2ã€RSAç­‰ç®—æ³•è¿›è¡ŒåŠ å¯†å­˜å‚¨ æ•æ„Ÿæ•°æ®åº”ä½¿ç”¨ç‹¬ç«‹çš„å­˜å‚¨å±‚ï¼Œå¹¶åœ¨è®¿é—®å±‚å¼€å¯è®¿é—®æ§åˆ¶ åŒ…å«æ•æ„Ÿä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶æˆ–ç¼“å­˜ä¸€æ—¦ä¸å†éœ€è¦åº”ç«‹åˆ»åˆ é™¤  ã€å¿…é¡»ã€‘æ•æ„Ÿä¿¡æ¯å¿…é¡»ç”±åå°è¿›è¡Œè„±æ•å¤„ç†  æ•æ„Ÿä¿¡æ¯é¡»å†åå°è¿›è¡Œè„±æ•åè¿”å›ï¼Œç¦æ­¢æ¥å£è¿”å›æ•æ„Ÿä¿¡æ¯äº¤ç”±å‰ç«¯/å®¢æˆ·ç«¯è¿›è¡Œè„±æ•å¤„ç†ã€‚  ã€å¿…é¡»ã€‘é«˜æ•æ„Ÿä¿¡æ¯ç¦æ­¢å­˜å‚¨ã€å±•ç¤º  å£ä»¤ã€å¯†ä¿ç­”æ¡ˆã€ç”Ÿç†æ ‡è¯†ç­‰é‰´æƒä¿¡æ¯ç¦æ­¢å±•ç¤º éé‡‘èç±»ä¸šåŠ¡ï¼Œä¿¡ç”¨å¡cvvç åŠæ—¥å¿—ç¦æ­¢å­˜å‚¨  ã€å¿…é¡»ã€‘ä¸ªäººæ•æ„Ÿä¿¡æ¯è„±æ•å±•ç¤º åœ¨æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œä¸ªäººæ•æ„Ÿä¿¡æ¯éœ€è„±æ•å±•ç¤ºï¼Œå¦‚ï¼š\n èº«ä»½è¯åªæ˜¾ç¤ºç¬¬ä¸€ä½å’Œæœ€åä¸€ä½å­—ç¬¦ï¼Œå¦‚3****************1ã€‚ ç§»åŠ¨ç”µè¯å·ç éšè—ä¸­é—´6ä½å­—ç¬¦ï¼Œå¦‚134******48ã€‚ å·¥ä½œåœ°å€/å®¶åº­åœ°å€æœ€å¤šæ˜¾ç¤ºåˆ°â€œåŒºâ€ä¸€çº§ã€‚ é“¶è¡Œå¡å·ä»…æ˜¾ç¤ºæœ€å4ä½å­—ç¬¦ï¼Œå¦‚************8639  ã€å¿…é¡»ã€‘éšè—åå°åœ°å€  è‹¥ç¨‹åºå¯¹å¤–æä¾›äº†ç™»å½•åå°åœ°å€ï¼Œåº”ä½¿ç”¨éšæœºå­—ç¬¦ä¸²éšè—åœ°å€ã€‚  # ä¸è¦é‡‡å–è¿™ç§æ–¹å¼ admin_login_url = \u0026#34;xxxx/login\u0026#34; # å®‰å…¨ç¤ºä¾‹ admin_login_url = \u0026#34;xxxx/ranD0Str\u0026#34; æƒé™ç®¡ç† ã€å¿…é¡»ã€‘é»˜è®¤é‰´æƒ  é™¤éèµ„æºå®Œå…¨å¯å¯¹å¤–å¼€æ”¾ï¼Œå¦åˆ™ç³»ç»Ÿé»˜è®¤è¿›è¡Œèº«ä»½è®¤è¯ï¼ˆä½¿ç”¨ç™½åå•çš„æ–¹å¼æ”¾å¼€ä¸éœ€è¦è®¤è¯çš„æ¥å£æˆ–é¡µé¢ï¼‰ã€‚  ####ã€å¿…é¡»ã€‘æˆæƒéµå¾ªæœ€å°æƒé™åŸåˆ™\n ç¨‹åºé»˜è®¤ç”¨æˆ·åº”ä¸å…·å¤‡ä»»ä½•æ“ä½œæƒé™ã€‚  ã€å¿…é¡»ã€‘é¿å…è¶Šæƒè®¿é—®  å¯¹äºéå…¬å…±æ“ä½œï¼Œåº”å½“æ ¡éªŒå½“å‰è®¿é—®è´¦å·è¿›è¡Œæ“ä½œæƒé™ï¼ˆå¸¸è§äºCMSï¼‰å’Œæ•°æ®æƒé™æ ¡éªŒã€‚   éªŒè¯å½“å‰ç”¨æˆ·çš„ç™»å½•æ€ï¼› ä»å¯ä¿¡ç»“æ„ä¸­è·å–ç»è¿‡æ ¡éªŒçš„å½“å‰è¯·æ±‚è´¦å·çš„èº«ä»½ä¿¡æ¯ï¼ˆå¦‚ï¼šsessionï¼‰ï¼Œç¦æ­¢ä»ç”¨æˆ·è¯·æ±‚å‚æ•°æˆ–Cookieä¸­è·å–å¤–éƒ¨ä¼ å…¥ä¸å¯ä¿¡ç”¨æˆ·èº«ä»½ç›´æ¥è¿›è¡ŒæŸ¥è¯¢ï¼› æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡è¯¥æ“ä½œæƒé™ï¼› æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æ‰€æ“ä½œæ•°æ®çš„æƒé™ï¼› æ ¡éªŒå½“å‰æ“ä½œæ˜¯å¦è´¦æˆ·æ˜¯å¦é¢„æœŸè´¦æˆ·ã€‚  ã€å»ºè®®ã€‘åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æƒé™  ç¨‹åºåº”å®šæœŸæ¸…ç†éå¿…éœ€ç”¨æˆ·çš„æƒé™ã€‚  å¼‚å¸¸å¤„ç† ã€å¿…é¡»ã€‘ä¸å‘å¯¹å¤–é”™è¯¯æç¤º  åº”åˆç†ä½¿ç”¨try/except/finally å¤„ç†ç³»ç»Ÿå¼‚å¸¸ï¼Œé¿å…å‡ºé”™ä¿¡æ¯è¾“å‡ºåˆ°å‰ç«¯ã€‚ å¯¹å¤–ç¯å¢ƒç¦æ­¢å¼€å¯debugæ¨¡å¼ï¼Œæˆ–å°†ç¨‹åºè¿è¡Œæ—¥å¿—è¾“å‡ºåˆ°å‰ç«¯ã€‚  ã€å¿…é¡»ã€‘ç¦æ­¢å¼‚å¸¸æŠ›å‡ºæ•æ„Ÿä¿¡æ¯ Flaskå®‰å…¨ ã€å¿…é¡»ã€‘ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•æ¨¡å¼ ã€å»ºè®®ã€‘éµå¾ªFlaskå®‰å…¨è§„èŒƒ  å‚è€ƒFlaskæ–‡æ¡£ä¸­çš„å®‰å…¨æ³¨æ„äº‹é¡¹ https://flask.palletsprojects.com/en/latest/security/  Djangoå®‰å…¨ ã€å¿…é¡»ã€‘ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•æ¨¡å¼ ####ã€å»ºè®®ã€‘ä¿æŒDjangoè‡ªå¸¦çš„å®‰å…¨ç‰¹æ€§å¼€å¯\n  ä¿æŒDjangoè‡ªå¸¦çš„å®‰å…¨ç‰¹æ€§å¼€å¯ https://docs.djangoproject.com/en/3.0/topics/security/\n  åœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒDjangoè‡ªå¸¦çš„å®‰å…¨ç‰¹æ€§å¯¹XSSã€CSRFã€SQLæ³¨å…¥ã€ç‚¹å‡»åŠ«æŒç­‰ç±»å‹æ¼æ´å¯ä»¥èµ·åˆ°è¾ƒå¥½é˜²æŠ¤æ•ˆæœã€‚åº”å°½é‡é¿å…å…³é—­è¿™äº›å®‰å…¨ç‰¹æ€§ã€‚\n  ","date":"2021-10-30T22:00:08+08:00","image":"https://zcj-git520.github.io/p/python%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/1_hu88cf376361c4b459010ac189c2b354f8_10188_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/python%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/","title":"Pythonå®‰å…¨æŒ‡å—"},{"content":"æ–‡ç« æ¥æº é¹…å‚(è…¾è®¯)ä»£ç å®‰å…¨æŒ‡å—\né€šç”¨å®‰å…¨æŒ‡å— C/C++ä½¿ç”¨é”™è¯¯ ã€å¿…é¡»ã€‘ä¸å¾—ç›´æ¥ä½¿ç”¨æ— é•¿åº¦é™åˆ¶çš„å­—ç¬¦æ‹·è´å‡½æ•° ä¸åº”ç›´æ¥ä½¿ç”¨legacyçš„å­—ç¬¦ä¸²æ‹·è´ã€è¾“å…¥å‡½æ•°ï¼Œå¦‚strcpyã€strcatã€sprintfã€wcscpyã€mbscpyç­‰ï¼Œè¿™äº›å‡½æ•°çš„ç‰¹å¾æ˜¯ï¼šå¯ä»¥è¾“å‡ºä¸€é•¿ä¸²å­—ç¬¦ä¸²ï¼Œè€Œä¸é™åˆ¶é•¿åº¦ã€‚å¦‚æœç¯å¢ƒå…è®¸ï¼Œåº”å½“ä½¿ç”¨å…¶_så®‰å…¨ç‰ˆæœ¬æ›¿ä»£ï¼Œæˆ–è€…ä½¿ç”¨nç‰ˆæœ¬å‡½æ•°ï¼ˆå¦‚ï¼šsnprintfï¼Œvsnprintfï¼‰ã€‚\nè‹¥ä½¿ç”¨å½¢å¦‚sscanfä¹‹ç±»çš„å‡½æ•°æ—¶ï¼Œåœ¨å¤„ç†å­—ç¬¦ä¸²è¾“å…¥æ—¶åº”å½“é€šè¿‡%10sè¿™æ ·çš„æ–¹å¼æ¥ä¸¥æ ¼é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦ï¼ŒåŒæ—¶ç¡®ä¿å­—ç¬¦ä¸²æœ«å°¾æœ‰\\0ã€‚å¦‚æœç¯å¢ƒå…è®¸ï¼Œåº”å½“ä½¿ç”¨_så®‰å…¨ç‰ˆæœ¬ã€‚\nä½†æ˜¯æ³¨æ„ï¼Œè™½ç„¶MSVC 2015æ—¶é»˜è®¤å¼•å…¥ç»“å°¾ä¸º0ç‰ˆæœ¬çš„snprintfï¼ˆè¡Œä¸ºç­‰åŒäºC99å®šä¹‰çš„snprintfï¼‰ã€‚ä½†æ›´æ—©æœŸçš„ç‰ˆæœ¬ä¸­ï¼ŒMSVCçš„snprintfå¯èƒ½æ˜¯_snprintfçš„å®ã€‚è€Œ_snprintfæ˜¯ä¸ä¿è¯\\0ç»“å°¾çš„ï¼ˆè§æœ¬èŠ‚ååŠéƒ¨åˆ†ï¼‰ã€‚\nï¼ˆMSVCï¼‰ Beginning with the UCRT in Visual Studio 2015 and Windows 10, snprintf is no longer identical to _snprintf. The snprintf function behavior is now C99 standard compliant. ä»Visual Studio 2015å’ŒWindows 10ä¸­çš„UCRTå¼€å§‹ï¼Œsnprintfä¸å†ä¸_snprintfç›¸åŒã€‚snprintfå‡½æ•°è¡Œä¸ºç°åœ¨ç¬¦åˆC99æ ‡å‡†ã€‚ è¯·å‚è€ƒï¼šhttps://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/snprintf-snprintf-snprintf-l-snwprintf-snwprintf-l?redirectedfrom=MSDN\u0026amp;view=vs-2019 å› æ­¤ï¼Œåœ¨ä½¿ç”¨nç³»åˆ—æ‹·è´å‡½æ•°æ—¶ï¼Œè¦ç¡®ä¿æ­£ç¡®è®¡ç®—ç¼“å†²åŒºé•¿åº¦ï¼ŒåŒæ—¶ï¼Œå¦‚æœä½ ä¸ç¡®å®šæ˜¯å¦ä»£ç åœ¨å„ä¸ªç¼–è¯‘å™¨ä¸‹éƒ½èƒ½ç¡®ä¿æœ«å°¾æœ‰0æ—¶ï¼Œå»ºè®®å¯ä»¥é€‚å½“å¢åŠ 1å­—èŠ‚è¾“å…¥ç¼“å†²åŒºï¼Œå¹¶å°†å…¶ç½®ä¸º\\0ï¼Œä»¥ä¿è¯è¾“å‡ºçš„å­—ç¬¦ä¸²ç»“å°¾ä¸€å®šæœ‰\\0ã€‚\n// Good char buf[101] = {0}; snprintf(buf, sizeof(buf) - 1, \u0026#34;foobar ...\u0026#34;, ...); ä¸€äº›éœ€è¦æ³¨æ„çš„å‡½æ•°ï¼Œä¾‹å¦‚strncpyå’Œ_snprintfæ˜¯ä¸å®‰å…¨çš„ã€‚ strncpyä¸åº”å½“è¢«è§†ä¸ºstrcpyçš„nç³»åˆ—å‡½æ•°ï¼Œå®ƒåªæ˜¯æ°å·§ä¸å…¶ä»–nç³»åˆ—å‡½æ•°åå­—å¾ˆåƒè€Œå·²ã€‚strncpyåœ¨å¤åˆ¶æ—¶ï¼Œå¦‚æœå¤åˆ¶çš„é•¿åº¦è¶…è¿‡nï¼Œä¸ä¼šåœ¨ç»“å°¾è¡¥\\0ã€‚\nåŒæ ·ï¼ŒMSVC _snprintfç³»åˆ—å‡½æ•°åœ¨è¶…è¿‡æˆ–ç­‰äºnæ—¶ä¹Ÿä¸ä¼šä»¥0ç»“å°¾ã€‚å¦‚æœåç»­ä½¿ç”¨é0ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå¯èƒ½æ³„éœ²ç›¸é‚»çš„å†…å®¹æˆ–è€…å¯¼è‡´ç¨‹åºå´©æºƒã€‚\n// Bad char a[4] = {0}; _snprintf(a, 4, \u0026#34;%s\u0026#34;, \u0026#34;AAAA\u0026#34;); foo = strlen(a); ä¸Šè¿°ä»£ç åœ¨MSVCä¸­æ‰§è¡Œåï¼Œ a[4] == \u0026lsquo;A\u0026rsquo;ï¼Œå› æ­¤å­—ç¬¦ä¸²æœªä»¥0ç»“å°¾ã€‚açš„å†…å®¹æ˜¯\u0026quot;AAAA\u0026quot;ï¼Œè°ƒç”¨strlen(a)åˆ™ä¼šè¶Šç•Œè®¿é—®ã€‚å› æ­¤ï¼Œæ­£ç¡®çš„æ“ä½œä¸¾ä¾‹å¦‚ä¸‹ï¼š\n// Good char a[4] = {0}; _snprintf(a, sizeof(a), \u0026#34;%s\u0026#34;, \u0026#34;AAAA\u0026#34;); a[sizeof(a) - 1] = \u0026#39;\\0\u0026#39;; foo = strlen(a); åœ¨ C++ ä¸­ï¼Œå¼ºçƒˆå»ºè®®ç”¨ stringã€vector ç­‰æ›´é«˜å°è£…å±‚æ¬¡çš„åŸºç¡€ç»„ä»¶ä»£æ›¿åŸå§‹æŒ‡é’ˆå’ŒåŠ¨æ€æ•°ç»„ï¼Œå¯¹æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-ä¿¡æ¯æ³„éœ²\nä½é£é™©-æ‹’ç»æœåŠ¡\né«˜é£é™©-ç¼“å†²åŒºæº¢å‡º\nã€å¿…é¡»ã€‘åˆ›å»ºè¿›ç¨‹ç±»çš„å‡½æ•°çš„å®‰å…¨è§„èŒƒ systemã€WinExecã€CreateProcessã€ShellExecuteç­‰å¯åŠ¨è¿›ç¨‹ç±»çš„å‡½æ•°ï¼Œéœ€è¦ä¸¥æ ¼æ£€æŸ¥å…¶å‚æ•°ã€‚\nå¯åŠ¨è¿›ç¨‹éœ€è¦åŠ ä¸ŠåŒå¼•å·ï¼Œé”™è¯¯ä¾‹å­ï¼š\n// Bad WinExec(\u0026#34;D:\\\\program files\\\\my folder\\\\foobar.exe\u0026#34;, SW_SHOW); å½“å­˜åœ¨D:\\program files\\my.exeçš„æ—¶å€™ï¼Œmy.exeä¼šè¢«å¯åŠ¨ã€‚è€Œfoobar.exeä¸ä¼šå¯åŠ¨ã€‚\n// Good WinExec(\u0026#34;\\\u0026#34;D:\\\\program files\\\\my folder\\\\foobar.exe\\\u0026#34;\u0026#34;, SW_SHOW); å¦å¤–ï¼Œå¦‚æœå¯åŠ¨æ—¶ä»ç”¨æˆ·è¾“å…¥ã€ç¯å¢ƒå˜é‡è¯»å–ç»„åˆå‘½ä»¤è¡Œæ—¶ï¼Œè¿˜éœ€è¦æ³¨æ„æ˜¯å¦å¯èƒ½å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚\n// Bad std::string cmdline = \u0026#34;calc \u0026#34;; cmdline += user_input; system(cmdline.c_str()); æ¯”å¦‚ï¼Œå½“ç”¨æˆ·è¾“å…¥1+1 \u0026amp;\u0026amp; lsæ—¶ï¼Œæ‰§è¡Œçš„å®é™…ä¸Šæ˜¯calc 1+1å’Œls ä¸¤ä¸ªå‘½ä»¤ï¼Œå¯¼è‡´å‘½ä»¤æ³¨å…¥ã€‚\néœ€è¦æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦å«æœ‰éæ³•æ•°æ®ã€‚\n// Good std::string cmdline = \u0026#34;ls \u0026#34;; cmdline += user_input; if(cmdline.find_first_not_of(\u0026#34;1234567890.+-*/e \u0026#34;) == std::string::npos) system(cmdline.c_str()); else warning(...); å…³è”æ¼æ´:\né«˜é£é™©-ä»£ç æ‰§è¡Œ\né«˜é£é™©-æƒé™æå‡\nã€å¿…é¡»ã€‘å°½é‡å‡å°‘ä½¿ç”¨ _alloca å’Œå¯å˜é•¿åº¦æ•°ç»„ _alloca å’Œå¯å˜é•¿åº¦æ•°ç»„ä½¿ç”¨çš„å†…å­˜é‡åœ¨ç¼–è¯‘æœŸé—´ä¸å¯çŸ¥ã€‚å°¤å…¶æ˜¯åœ¨å¾ªç¯ä¸­ä½¿ç”¨æ—¶ï¼Œæ ¹æ®ç¼–è¯‘å™¨çš„å®ç°ä¸åŒï¼Œå¯èƒ½ä¼šå¯¼è‡´ï¼šï¼ˆ1ï¼‰æ ˆæº¢å‡ºï¼Œå³æ‹’ç»æœåŠ¡ï¼› ï¼ˆ2ï¼‰ç¼ºå°‘æ ˆå†…å­˜æµ‹è¯•çš„ç¼–è¯‘å™¨å®ç°å¯èƒ½å¯¼è‡´ç”³è¯·åˆ°éæ ˆå†…å­˜ï¼Œå¹¶å¯¼è‡´å†…å­˜æŸåã€‚è¿™åœ¨æ ˆæ¯”è¾ƒå°çš„ç¨‹åºä¸Šï¼Œä¾‹å¦‚IoTè®¾å¤‡å›ºä»¶ä¸Šå½±å“å°¤ä¸ºå¤§ã€‚å¯¹äº C++ï¼Œå¯å˜é•¿åº¦æ•°ç»„ä¹Ÿå±äºéæ ‡å‡†æ‰©å±•ï¼Œåœ¨ä»£ç è§„èŒƒä¸­ç¦æ­¢ä½¿ç”¨ã€‚\né”™è¯¯ç¤ºä¾‹ï¼š\n// Bad for (int i = 0; i \u0026lt; 100000; i++) { char* foo = (char *)_alloca(0x10000); ..do something with foo ..; } void Foo(int size) { char msg[size]; // ä¸å¯æ§çš„æ ˆæº¢å‡ºé£é™©ï¼ } æ­£ç¡®ç¤ºä¾‹ï¼š\n// Good // æ”¹ç”¨åŠ¨æ€åˆ†é…çš„å †å†…å­˜ for (int i = 0; i \u0026lt; 100000; i++) { char * foo = (char *)malloc(0x10000); ..do something with foo ..; if (foo_is_no_longer_needed) { free(foo); foo = NULL; } } void Foo(int size) { std::string msg(size, \u0026#39;\\0\u0026#39;); // C++  char* msg = malloc(size); // C } å…³è”æ¼æ´:\nä½é£é™©-æ‹’ç»æœåŠ¡\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘printfç³»åˆ—å‚æ•°å¿…é¡»å¯¹åº” æ‰€æœ‰printfç³»åˆ—å‡½æ•°ï¼Œå¦‚sprintfï¼Œsnprintfï¼Œvprintfç­‰å¿…é¡»å¯¹åº”æ§åˆ¶ç¬¦å·å’Œå‚æ•°ã€‚\né”™è¯¯ç¤ºä¾‹ï¼š\n// Bad const int buf_size = 1000; char buffer_send_to_remote_client[buf_size] = {0}; snprintf(buffer_send_to_remote_client, buf_size, \u0026#34;%d: %p\u0026#34;, id, some_string); // %p åº”ä¸º %s  buffer_send_to_remote_client[buf_size - 1] = \u0026#39;\\0\u0026#39;; send_to_remote(buffer_send_to_remote_client); æ­£ç¡®ç¤ºä¾‹ï¼š\n// Good const int buf_size = 1000; char buffer_send_to_remote_client[buf_size] = {0}; snprintf(buffer_send_to_remote_client, buf_size, \u0026#34;%d: %s\u0026#34;, id, some_string); buffer_send_to_remote_client[buf_size - 1] = \u0026#39;\\0\u0026#39;; send_to_remote(buffer_send_to_remote_client); å‰è€…å¯èƒ½ä¼šè®©clientçš„æ”»å‡»è€…è·å–éƒ¨åˆ†æœåŠ¡å™¨çš„åŸå§‹æŒ‡é’ˆåœ°å€ï¼Œå¯ä»¥ç”¨äºç ´åASLRä¿æŠ¤ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-ä¿¡æ¯æ³„éœ²\nã€å¿…é¡»ã€‘é˜²æ­¢æ³„éœ²æŒ‡é’ˆï¼ˆåŒ…æ‹¬%pï¼‰çš„å€¼ æ‰€æœ‰printfç³»åˆ—å‡½æ•°ï¼Œè¦é˜²æ­¢æ ¼å¼åŒ–å®Œçš„å­—ç¬¦ä¸²æ³„éœ²ç¨‹åºå¸ƒå±€ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå°†å¸¦æœ‰%pçš„å­—ç¬¦ä¸²æ³„éœ²ç»™ç¨‹åºï¼Œåˆ™å¯èƒ½ä¼šç ´åASLRçš„é˜²æŠ¤æ•ˆæœã€‚ä½¿å¾—æ”»å‡»è€…æ›´å®¹æ˜“æ”»ç ´ç¨‹åºã€‚\n%pçš„å€¼åªåº”å½“åœ¨ç¨‹åºå†…ä½¿ç”¨ï¼Œè€Œä¸åº”å½“è¾“å‡ºåˆ°å¤–éƒ¨æˆ–è¢«å¤–éƒ¨ä»¥æŸç§æ–¹å¼è·å–ã€‚\né”™è¯¯ç¤ºä¾‹ï¼š\n// Bad // å¦‚æœè¿™æ˜¯æš´éœ²ç»™å®¢æˆ·çš„ä¸€ä¸ªAPIï¼š uint64_t GetUniqueObjectId(const Foo* pobject) { return (uint64_t)pobject; } æ­£ç¡®ç¤ºä¾‹ï¼š\n// Good uint64_t g_object_id = 0; void Foo::Foo() { this-\u0026gt;object_id_ = g_object_id++; } // å¦‚æœè¿™æ˜¯æš´éœ²ç»™å®¢æˆ·çš„ä¸€ä¸ªAPIï¼š uint64_t GetUniqueObjectId(const Foo* object) { if (object) return object-\u0026gt;object_id_; else error(...); } å…³è”æ¼æ´:\nä¸­é£é™©-ä¿¡æ¯æ³„éœ²\nã€å¿…é¡»ã€‘ä¸åº”å½“æŠŠç”¨æˆ·å¯ä¿®æ”¹çš„å­—ç¬¦ä¸²ä½œä¸ºprintfç³»åˆ—å‡½æ•°çš„â€œformatâ€å‚æ•° å¦‚æœç”¨æˆ·å¯ä»¥æ§åˆ¶å­—ç¬¦ä¸²ï¼Œåˆ™é€šè¿‡ %n %p ç­‰å†…å®¹ï¼Œæœ€åæƒ…å†µä¸‹å¯ä»¥ç›´æ¥æ‰§è¡Œä»»æ„æ¶æ„ä»£ç ã€‚\nåœ¨ä»¥ä¸‹æƒ…å†µå°¤å…¶éœ€è¦æ³¨æ„ï¼š WIFIåï¼Œè®¾å¤‡åâ€¦â€¦\né”™è¯¯ï¼š\nsnprintf(buf, sizeof(buf), wifi_name); æ­£ç¡®ï¼š\nsnprinf(buf, sizeof(buf), \u0026#34;%s\u0026#34;, wifi_name); å…³è”æ¼æ´:\né«˜é£é™©-ä»£ç æ‰§è¡Œ\né«˜é£é™©-å†…å­˜ç ´å\nä¸­é£é™©-ä¿¡æ¯æ³„éœ²\nä½é£é™©-æ‹’ç»æœåŠ¡\nã€å¿…é¡»ã€‘å¯¹æ•°ç»„deleteæ—¶éœ€è¦ä½¿ç”¨delete[] delete []æ“ä½œç¬¦ç”¨äºåˆ é™¤æ•°ç»„ã€‚deleteæ“ä½œç¬¦ç”¨äºåˆ é™¤éæ•°ç»„å¯¹è±¡ã€‚å®ƒä»¬åˆ†åˆ«è°ƒç”¨operator delete[]å’Œoperator deleteã€‚\n// Bad Foo* b = new Foo[5]; delete b; // trigger assert in DEBUG mode åœ¨new[]è¿”å›çš„æŒ‡é’ˆä¸Šè°ƒç”¨deleteå°†æ˜¯å–å†³äºç¼–è¯‘å™¨çš„æœªå®šä¹‰è¡Œä¸ºã€‚ä»£ç ä¸­å­˜åœ¨å¯¹æœªå®šä¹‰è¡Œä¸ºçš„ä¾èµ–æ˜¯é”™è¯¯çš„ã€‚\n// Good Foo* b = new Foo[5]; delete[] b; åœ¨ C++ ä»£ç ä¸­ï¼Œä½¿ç”¨ stringã€vectorã€æ™ºèƒ½æŒ‡é’ˆï¼ˆæ¯”å¦‚std::unique_ptr\u0026lt;T[]\u0026gt;ï¼‰ç­‰å¯ä»¥æ¶ˆé™¤ç»å¤§å¤šæ•° delete[] çš„ä½¿ç”¨åœºæ™¯ï¼Œå¹¶ä¸”ä»£ç æ›´æ¸…æ™°ã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nä¸­é£é™©-é€»è¾‘æ¼æ´\nä½é£é™©-å†…å­˜æ³„æ¼\nä½é£é™©-æ‹’ç»æœåŠ¡\nã€å¿…é¡»ã€‘æ³¨æ„éšå¼ç¬¦å·è½¬æ¢ ä¸¤ä¸ªæ— ç¬¦å·æ•°ç›¸å‡ä¸ºè´Ÿæ•°æ—¶ï¼Œç»“æœåº”å½“ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ— ç¬¦å·æ•°ï¼Œä½†æ˜¯å°äºintçš„æ— ç¬¦å·æ•°åœ¨è¿ç®—æ—¶å¯èƒ½ä¼šæœ‰é¢„æœŸå¤–çš„éšå¼ç¬¦å·è½¬æ¢ã€‚\n// 1 unsigned char a = 1; unsigned char b = 2; if (a - b \u0026lt; 0) // a - b = -1 (signed int)  a = 6; else a = 8; // 2 unsigned char a = 1; unsigned short b = 2; if (a - b \u0026lt; 0) // a - b = -1 (signed int)  a = 6; else a = 8; ä¸Šè¿°ç»“æœå‡ä¸ºa=6\n// 3 unsigned int a = 1; unsigned short b = 2; if (a - b \u0026lt; 0) // a - b = 0xffffffff (unsigned int)  a = 6; else a = 8; // 4 unsigned int a = 1; unsigned int b = 2; if (a - b \u0026lt; 0) // a - b = 0xffffffff (unsigned int)  a = 6; else a = 8; ä¸Šè¿°ç»“æœå‡ä¸ºa=8\nå¦‚æœé¢„æœŸä¸º8ï¼Œåˆ™é”™è¯¯ä»£ç ï¼š\n// Bad unsigned short a = 1; unsigned short b = 2; if (a - b \u0026lt; 0) // a - b = -1 (signed int)  a = 6; else a = 8; æ­£ç¡®ä»£ç ï¼š\n// Good unsigned short a = 1; unsigned short b = 2; if ((unsigned int)a - (unsigned int)b \u0026lt; 0) // a - b = 0xffff (unsigned short)  a = 6; else a = 8; å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘æ³¨æ„å…«è¿›åˆ¶é—®é¢˜ ä»£ç å¯¹é½æ—¶åº”å½“ä½¿ç”¨ç©ºæ ¼æˆ–è€…ç¼–è¾‘å™¨è‡ªå¸¦çš„å¯¹é½åŠŸèƒ½ï¼Œè°¨æ…åœ¨æ•°å­—å‰ä½¿ç”¨0æ¥å¯¹é½ä»£ç ï¼Œä»¥å…ä¸å½“å°†æŸäº›å†…å®¹è½¬æ¢ä¸ºå…«è¿›åˆ¶ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœé¢„æœŸä¸º20å­—èŠ‚é•¿åº¦çš„ç¼“å†²åŒºï¼Œåˆ™ä¸‹åˆ—ä»£ç å­˜åœ¨é”™è¯¯ã€‚buf2ä¸º020ï¼ˆOCTï¼‰é•¿åº¦ï¼Œå®é™…åªæœ‰16ï¼ˆDECï¼‰é•¿åº¦ï¼Œåœ¨memcpyåè¶Šç•Œï¼š\n// Bad char buf1[1024] = {0}; char buf2[0020] = {0}; memcpy(buf2, somebuf, 19); åº”å½“åœ¨ä½¿ç”¨8è¿›åˆ¶æ—¶æ˜ç¡®æ³¨æ˜è¿™æ˜¯å…«è¿›åˆ¶ã€‚\n// Good int access_mask = 0777; // oct, rwxrwxrwx å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nä¸æ¨èçš„ç¼–ç¨‹ä¹ æƒ¯ ã€å¿…é¡»ã€‘switchä¸­åº”æœ‰default switchä¸­åº”è¯¥æœ‰defaultï¼Œä»¥å¤„ç†å„ç§é¢„æœŸå¤–çš„æƒ…å†µã€‚è¿™å¯ä»¥ç¡®ä¿switchæ¥å—ç”¨æˆ·è¾“å…¥ï¼Œæˆ–è€…åæœŸåœ¨å…¶ä»–å¼€å‘è€…ä¿®æ”¹å‡½æ•°åç¡®ä¿switchä»å¯ä»¥è¦†ç›–åˆ°æ‰€æœ‰æƒ…å†µï¼Œå¹¶ç¡®ä¿é€»è¾‘æ­£å¸¸è¿è¡Œã€‚\n// Bad int Foo(int bar) { switch (bar \u0026amp; 7) { case 0: return Foobar(bar); break; case 1: return Foobar(bar * 2); break; } } ä¾‹å¦‚ä¸Šè¿°ä»£ç switchçš„å–å€¼å¯èƒ½ä»0ï½7ï¼Œæ‰€ä»¥åº”å½“æœ‰defaultï¼š\n// Good int Foo(int bar) { switch (bar \u0026amp; 7) { case 0: return Foobar(bar); break; case 1: return Foobar(bar * 2); break; default: return -1; } } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nä¸­é£é™©-å†…å­˜æ³„æ¼\nã€å¿…é¡»ã€‘ä¸åº”å½“åœ¨Debugæˆ–é”™è¯¯ä¿¡æ¯ä¸­æä¾›è¿‡å¤šå†…å®¹ åŒ…å«è¿‡å¤šä¿¡æ¯çš„Debugæ¶ˆæ¯ä¸åº”å½“è¢«ç”¨æˆ·è·å–åˆ°ã€‚Debugä¿¡æ¯å¯èƒ½ä¼šæ³„éœ²ä¸€äº›å€¼ï¼Œä¾‹å¦‚å†…å­˜æ•°æ®ã€å†…å­˜åœ°å€ç­‰å†…å®¹ï¼Œè¿™äº›å†…å®¹å¯ä»¥å¸®åŠ©æ”»å‡»è€…åœ¨åˆæ­¥æ§åˆ¶ç¨‹åºåï¼Œæ›´å®¹æ˜“åœ°æ”»å‡»ç¨‹åºã€‚\n// Bad int Foo(int* bar) { if (bar \u0026amp;\u0026amp; *bar == 5) { OutputDebugInfoToUser(\u0026#34;Wrong value for bar %p = %d\\n\u0026#34;, bar, *bar); } } è€Œåº”è¯¥ï¼š\n// Good int foo(int* bar) { #ifdef DEBUG  if (bar \u0026amp;\u0026amp; *bar == 5) { OutputDebugInfo(\u0026#34;Wrong value for bar.\\n\u0026#34;, bar, *bar); } #endif  } å…³è”æ¼æ´:\nä¸­é£é™©-ä¿¡æ¯æ³„æ¼\nã€å¿…é¡»ã€‘ä¸åº”è¯¥åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ç¡¬ç¼–ç å¯¹ç§°åŠ å¯†ç§˜é’¥ ä¸åº”è¯¥åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ç¡¬ç¼–ç å¯¹ç§°åŠ å¯†ç§˜é’¥ã€‚ä¾‹å¦‚ï¼šä¸åº”åœ¨å®¢æˆ·ç«¯ä»£ç ä½¿ç”¨ç¡¬ç¼–ç çš„ AES/ChaCha20-Poly1305/SM1 å¯†é’¥ï¼Œä½¿ç”¨å›ºå®šå¯†é’¥çš„ç¨‹åºåŸºæœ¬å’Œæ²¡æœ‰åŠ å¯†ä¸€æ ·ã€‚\nå¦‚æœä¸šåŠ¡éœ€æ±‚æ˜¯è®¤è¯åŠ å¯†æ•°æ®ä¼ è¾“ï¼Œåº”ä¼˜å…ˆè€ƒè™‘ç›´æ¥ç”¨ HTTPS åè®®ã€‚\nå¦‚æœæ˜¯å…¶å®ƒä¸šåŠ¡éœ€æ±‚ï¼Œå¯è€ƒè™‘ç”±æœåŠ¡å™¨ç«¯ç”Ÿæˆå¯¹ç§°ç§˜é’¥ï¼Œå®¢æˆ·ç«¯é€šè¿‡ HTTPS ç­‰è®¤è¯åŠ å¯†é€šä¿¡æ¸ é“ä»æœåŠ¡å™¨æ‹‰å–ã€‚\næˆ–è€…æ ¹æ®ç”¨æˆ·ç‰¹å®šçš„ä¼šè¯ä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•è®¤è¯è¿‡ç¨‹å¯ä»¥æ ¹æ®ç”¨æˆ·åç”¨æˆ·å¯†ç ä¸šåŠ¡ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯ï¼Œä½¿ç”¨ HKDF ç­‰ç®—æ³•è¡ç”Ÿå‡ºå¯¹ç§°ç§˜é’¥ã€‚\nåˆæˆ–è€…ä½¿ç”¨ RSA/ECDSA + ECDHE ç­‰è¿›è¡Œè®¤è¯ç§˜é’¥åå•†ï¼Œç”Ÿæˆå¯¹ç§°ç§˜é’¥ã€‚\n// Bad char g_aes_key[] = {...}; void Foo() { .... AES_func(g_aes_key, input_data, output_data); } å¯ä»¥è€ƒè™‘åœ¨çº¿ä¸ºæ¯ä¸ªç”¨æˆ·è·å–ä¸åŒçš„å¯†é’¥ï¼š\n// Good char* g_aes_key; void Foo() { .... AES_encrypt(g_aes_key, input_data, output_data); } void Init() { g_aes_key = get_key_from_https(user_id, ...); } å…³è”æ¼æ´:\nä¸­é£é™©-ä¿¡æ¯æ³„éœ²\nã€å¿…é¡»ã€‘è¿”å›æ ˆä¸Šå˜é‡çš„åœ°å€ å‡½æ•°ä¸å¯ä»¥è¿”å›æ ˆä¸Šçš„å˜é‡çš„åœ°å€ï¼Œå…¶å†…å®¹åœ¨å‡½æ•°è¿”å›åå°±ä¼šå¤±æ•ˆã€‚\n// Bad char* Foo(char* sz, int len){ char a[300] = {0}; if (len \u0026gt; 100) { memcpy(a, sz, 100); } a[len] = \u0026#39;\\0\u0026#39;; return a; // WRONG } è€Œåº”å½“ä½¿ç”¨å †æ¥ä¼ é€’éç®€å•ç±»å‹å˜é‡ã€‚\n// Good char* Foo(char* sz, int len) { char* a = new char[300]; if (len \u0026gt; 100) { memcpy(a, sz, 100); } a[len] = \u0026#39;\\0\u0026#39;; return a; // OK } å¯¹äº C++ ç¨‹åºæ¥è¯´ï¼Œå¼ºçƒˆå»ºè®®è¿”å› stringã€vector ç­‰ç±»å‹ï¼Œä¼šè®©ä»£ç æ›´åŠ ç®€å•å’Œå®‰å…¨ã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘æœ‰é€»è¾‘è”ç³»çš„æ•°ç»„å¿…é¡»ä»”ç»†æ£€æŸ¥ ä¾‹å¦‚ä¸‹åˆ—ç¨‹åºå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºweek dayï¼Œä½†æ˜¯ä¸¤ä¸ªæ•°ç»„å¹¶ä¸ä¸€æ ·é•¿ï¼Œå¯¼è‡´ç¨‹åºå¯èƒ½ä¼šè¶Šç•Œè¯»ä¸€ä¸ªintã€‚\n// Bad int nWeekdays[] = {1, 2, 3, 4, 5, 6}; const char* sWeekdays[] = {\u0026#34;Mon\u0026#34;, \u0026#34;Tue\u0026#34;, \u0026#34;Wed\u0026#34;, \u0026#34;Thu\u0026#34;, \u0026#34;Fri\u0026#34;, \u0026#34;Sat\u0026#34;, \u0026#34;Sun\u0026#34;}; for (int x = 0; x \u0026lt; ARRAY_SIZE(sWeekdays); x++) { if (strcmp(sWeekdays[x], input) == 0) return nWeekdays[x]; } åº”å½“ç¡®ä¿æœ‰å…³è”çš„nWeekdayså’ŒsWeekdaysæ•°æ®ç»Ÿä¸€ã€‚\n// Good const int nWeekdays[] = {1, 2, 3, 4, 5, 6, 7}; const char* sWeekdays[] = {\u0026#34;Mon\u0026#34;, \u0026#34;Tue\u0026#34;, \u0026#34;Wed\u0026#34;, \u0026#34;Thu\u0026#34;, \u0026#34;Fri\u0026#34;, \u0026#34;Sat\u0026#34;, \u0026#34;Sun\u0026#34;}; assert(ARRAY_SIZE(nWeekdays) == ARRAY_SIZE(sWeekdays)); for (int x = 0; x \u0026lt; ARRAY_SIZE(sWeekdays); x++) { if (strcmp(sWeekdays[x], input) == 0) { return nWeekdays[x]; } } å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘é¿å…å‡½æ•°çš„å£°æ˜å’Œå®ç°ä¸åŒ åœ¨å¤´æ–‡ä»¶ã€æºä»£ç ã€æ–‡æ¡£ä¸­åˆ—ä¸¾çš„å‡½æ•°å£°æ˜åº”å½“ä¸€è‡´ï¼Œä¸åº”å½“å‡ºç°å®šä¹‰å†…å®¹é”™ä½çš„æƒ…å†µã€‚\né”™è¯¯ï¼š\nfoo.h\nint CalcArea(int width, int height); foo.cc\nint CalcArea(int height, int width) { // Different from foo.h  if (height \u0026gt; real_height) { return 0; } return height * width; } æ­£ç¡®ï¼š foo.h\nint CalcArea(int height, int width); foo.cc\nint CalcArea (int height, int width) { if (height \u0026gt; real_height) { return 0; } return height * width; } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nã€å¿…é¡»ã€‘æ£€æŸ¥å¤åˆ¶ç²˜è´´çš„é‡å¤ä»£ç ï¼ˆç›¸åŒä»£ç é€šå¸¸ä»£è¡¨é”™è¯¯ï¼‰ å½“å¼€å‘ä¸­é‡åˆ°è¾ƒé•¿çš„å¥å­æ—¶ï¼Œå¦‚æœä½ é€‰æ‹©äº†å¤åˆ¶ç²˜è´´è¯­å¥ï¼Œè¯·è®°å¾—æ£€æŸ¥æ¯ä¸€è¡Œä»£ç ï¼Œä¸è¦å‡ºç°ä¸Šä¸‹ä¸¤å¥ä¸€æ¨¡ä¸€æ ·çš„æƒ…å†µï¼Œè¿™é€šå¸¸ä»£è¡¨ä»£ç å“ªé‡Œå‡ºç°äº†é”™è¯¯ï¼š\n// Bad void Foobar(SomeStruct\u0026amp; foobase, SomeStruct\u0026amp; foo1, SomeStruct\u0026amp; foo2) { foo1.bar = (foo1.bar \u0026amp; 0xffff) | (foobase.base \u0026amp; 0xffff0000); foo1.bar = (foo1.bar \u0026amp; 0xffff) | (foobase.base \u0026amp; 0xffff0000); } å¦‚ä¸Šä¾‹ï¼Œé€šå¸¸å¯èƒ½æ˜¯ï¼š\n// Good void Foobar(SomeStruct\u0026amp; foobase, SomeStruct\u0026amp; foo1, SomeStruct\u0026amp; foo2) { foo1.bar = (foo1.bar \u0026amp; 0xffff) | (foobase.base \u0026amp; 0xffff0000); foo2.bar = (foo2.bar \u0026amp; 0xffff) | (foobase.base \u0026amp; 0xffff0000); } æœ€å¥½æ˜¯æŠŠé‡å¤çš„ä»£ç ç‰‡æ®µæå–æˆå‡½æ•°ï¼Œå¦‚æœå‡½æ•°æ¯”è¾ƒçŸ­ï¼Œå¯ä»¥è€ƒè™‘å®šä¹‰ä¸º inline å‡½æ•°ï¼Œåœ¨å‡å°‘å†—ä½™çš„åŒæ—¶ä¹Ÿèƒ½ç¡®ä¿ä¸ä¼šå½±å“æ€§èƒ½ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nã€å¿…é¡»ã€‘å·¦å³ä¸€è‡´çš„é‡å¤åˆ¤æ–­/æ°¸è¿œä¸ºçœŸæˆ–å‡çš„åˆ¤æ–­ï¼ˆé€šå¸¸ä»£è¡¨é”™è¯¯ï¼‰ è¿™é€šå¸¸æ˜¯ç”±äºè‡ªåŠ¨å®Œæˆæˆ–ä¾‹å¦‚Visual Assistant Xä¹‹ç±»çš„è¡¥å…¨æ’ä»¶å¯¼è‡´çš„é—®é¢˜ã€‚\n// Bad if (foo1.bar == foo1.bar) { â€¦ } å¯èƒ½æ˜¯ï¼š\n// Good if (foo1.bar == foo2.bar) { â€¦ } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nã€å¿…é¡»ã€‘å‡½æ•°æ¯ä¸ªåˆ†æ”¯éƒ½åº”æœ‰è¿”å›å€¼ å‡½æ•°çš„æ¯ä¸ªåˆ†æ”¯éƒ½åº”è¯¥æœ‰è¿”å›å€¼ï¼Œå¦åˆ™å¦‚æœå‡½æ•°èµ°åˆ°æ— è¿”å›å€¼çš„åˆ†æ”¯ï¼Œå…¶ç»“æœæ˜¯æœªçŸ¥çš„ã€‚\n// Bad int Foo(int bar) { if (bar \u0026gt; 100) { return 10; } else if (bar \u0026gt; 10) { return 1; } } ä¸Šè¿°ä¾‹å­å½“bar\u0026lt;10æ—¶ï¼Œå…¶ç»“æœæ˜¯æœªçŸ¥çš„å€¼ã€‚\n// Good int Foo(int bar) { if (bar \u0026gt; 100) { return 10; } else if (bar \u0026gt; 10) { return 1; } return 0; } å¼€å¯é€‚å½“çº§åˆ«çš„è­¦å‘Šï¼ˆGCC ä¸­ä¸º -Wreturn-type å¹¶å·²åŒ…å«åœ¨ -Wall ä¸­ï¼‰å¹¶è®¾ç½®ä¸ºé”™è¯¯ï¼Œå¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå‘ç°è¿™ç±»é”™è¯¯ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nä¸­é£é™©-ä¿¡æ¯æ³„æ¼\nã€å¿…é¡»ã€‘ä¸å¾—ä½¿ç”¨æ ˆä¸Šæœªåˆå§‹åŒ–çš„å˜é‡ åœ¨æ ˆä¸Šå£°æ˜çš„å˜é‡è¦æ³¨æ„æ˜¯å¦åœ¨ä½¿ç”¨å®ƒä¹‹å‰å·²ç»åˆå§‹åŒ–äº†\n// Bad void Foo() { int foo; if (Bar()) { foo = 1; } Foobar(foo); // fooå¯èƒ½æ²¡æœ‰åˆå§‹åŒ– } æœ€å¥½åœ¨å£°æ˜çš„æ—¶å€™å°±ç«‹åˆ»åˆå§‹åŒ–å˜é‡ï¼Œæˆ–è€…ç¡®ä¿æ¯ä¸ªåˆ†æ”¯éƒ½åˆå§‹åŒ–å®ƒã€‚å¼€å¯ç›¸åº”çš„ç¼–è¯‘å™¨è­¦å‘Šï¼ˆGCC ä¸­ä¸º -Wuninitializedï¼‰ï¼Œå¹¶æŠŠè®¾ç½®ä¸ºé”™è¯¯çº§åˆ«ï¼Œå¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå‘ç°è¿™ç±»é”™è¯¯ã€‚\n// Good void Foo() { int foo = 0; if (Bar()) { foo = 1; } Foobar(foo); } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nä¸­é£é™©-ä¿¡æ¯æ³„æ¼\nã€å»ºè®®ã€‘ä¸å¾—ç›´æ¥ä½¿ç”¨åˆšåˆ†é…çš„æœªåˆå§‹åŒ–çš„å†…å­˜ï¼ˆå¦‚reallocï¼‰ ä¸€äº›åˆšç”³è¯·çš„å†…å­˜é€šå¸¸æ˜¯ç›´æ¥ä»å †ä¸Šåˆ†é…çš„ï¼Œå¯èƒ½åŒ…å«æœ‰æ—§æ•°æ®çš„ï¼Œç›´æ¥ä½¿ç”¨å®ƒä»¬è€Œä¸åˆå§‹åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒCVE-2019-13751ã€‚åº”ç¡®ä¿åˆå§‹åŒ–å˜é‡ï¼Œæˆ–è€…ç¡®ä¿æœªåˆå§‹åŒ–çš„å€¼ä¸ä¼šæ³„éœ²ç»™ç”¨æˆ·ã€‚\n// Bad char* Foo() { char* a = new char[100]; a[99] = \u0026#39;\\0\u0026#39;; memcpy(a, \u0026#34;char\u0026#34;, 4); return a; } // Good char* Foo() { char* a = new char[100]; memcpy(a, \u0026#34;char\u0026#34;, 4); a[4] = \u0026#39;\\0\u0026#39;; return a; } åœ¨ C++ ä¸­ï¼Œå†æ¬¡å¼ºçƒˆæ¨èç”¨ stringã€vector ä»£æ›¿æ‰‹åŠ¨å†…å­˜åˆ†é…ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nä¸­é£é™©-ä¿¡æ¯æ³„æ¼\nã€å¿…é¡»ã€‘æ ¡éªŒå†…å­˜ç›¸å…³å‡½æ•°çš„è¿”å›å€¼ ä¸å†…å­˜åˆ†é…ç›¸å…³çš„å‡½æ•°éœ€è¦æ£€æŸ¥å…¶è¿”å›å€¼æ˜¯å¦æ­£ç¡®ï¼Œä»¥é˜²å¯¼è‡´ç¨‹åºå´©æºƒæˆ–é€»è¾‘é”™è¯¯ã€‚\n// Bad void Foo() { char* bar = mmap(0, 0x800000, .....); *(bar + 0x400000) = \u0026#39;\\x88\u0026#39;; // Wrong } å¦‚ä¸Šä¾‹mmapå¦‚æœå¤±è´¥ï¼Œbarçš„å€¼å°†æ˜¯0xffffffff (ffffffff)ï¼Œç¬¬äºŒè¡Œå°†ä¼šå¾€0x3ffffffå†™å…¥å­—ç¬¦ï¼Œå¯¼è‡´è¶Šç•Œå†™ã€‚\n// Good void Foo() { char* bar = mmap(0, 0x800000, .....); if(bar == MAP_FAILED) { return; } *(bar + 0x400000) = \u0026#39;\\x88\u0026#39;; } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\né«˜é£é™©-è¶Šç•Œæ“ä½œ\nã€å¿…é¡»ã€‘ä¸è¦åœ¨ifé‡Œé¢èµ‹å€¼ ifé‡Œèµ‹å€¼é€šå¸¸ä»£è¡¨ä»£ç å­˜åœ¨é”™è¯¯ã€‚\n// Bad void Foo() { if (bar = 0x99) ... } é€šå¸¸åº”è¯¥æ˜¯ï¼š\n// Good void Foo() { if (bar == 0x99) ... } å»ºè®®åœ¨æ„å»ºç³»ç»Ÿä¸­å¼€å¯è¶³å¤Ÿçš„ç¼–è¯‘å™¨è­¦å‘Šï¼ˆGCC ä¸­ä¸º -Wparentheses å¹¶å·²åŒ…å«åœ¨ -Wall ä¸­ï¼‰ï¼Œå¹¶æŠŠè¯¥è­¦å‘Šè®¾ç½®ä¸ºé”™è¯¯ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nã€å»ºè®®ã€‘ç¡®è®¤ifé‡Œé¢çš„æŒ‰ä½æ“ä½œ ifé‡Œï¼Œéboolç±»å‹å’Œéboolç±»å‹çš„æŒ‰ä½æ“ä½œå¯èƒ½ä»£è¡¨ä»£ç å­˜åœ¨é”™è¯¯ã€‚\n// Bad void Foo() { int bar = 0x1; // binary 01  int foobar = 0x2; // binary 10  if (foobar \u0026amp; bar) // result = 00, false  ... } ä¸Šè¿°ä»£ç å¯èƒ½åº”è¯¥æ˜¯ï¼š\n// Good void foo() { int bar = 0x1; int foobar = 0x2; if (foobar \u0026amp;\u0026amp; bar) // result : true  ... } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nå¤šçº¿ç¨‹ ã€å¿…é¡»ã€‘å˜é‡åº”ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ å½“ä¸€ä¸ªå˜é‡å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨æ—¶ï¼Œåº”å½“ä½¿ç”¨åŸå­æ“ä½œæˆ–åŠ é”æ“ä½œã€‚\n// Bad char g_somechar; void foo_thread1() { g_somechar += 3; } void foo_thread2() { g_somechar += 1; } å¯¹äºå¯ä»¥ä½¿ç”¨åŸå­æ“ä½œçš„ï¼Œåº”å½“ä½¿ç”¨ä¸€äº›å¯ä»¥ç¡®ä¿å†…å­˜å®‰å…¨çš„æ“ä½œï¼Œå¦‚ï¼š\n// Good volatile char g_somechar; void foo_thread1() { __sync_fetch_and_add(\u0026amp;g_somechar, 3); } void foo_thread2() { __sync_fetch_and_add(\u0026amp;g_somechar, 1); } å¯¹äº C ä»£ç ï¼ŒC11 åæ¨èä½¿ç”¨ atomic æ ‡å‡†åº“ã€‚ å¯¹äº C++ä»£ç ï¼ŒC++11 åï¼Œæ¨èä½¿ç”¨ std::atomicã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nã€å¿…é¡»ã€‘æ³¨æ„signal handlerå¯¼è‡´çš„æ¡ä»¶ç«äº‰ ç«äº‰æ¡ä»¶ç»å¸¸å‡ºç°åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­ï¼Œå› ä¸ºä¿¡å·å¤„ç†ç¨‹åºæ”¯æŒå¼‚æ­¥æ“ä½œã€‚æ”»å‡»è€…èƒ½å¤Ÿåˆ©ç”¨ä¿¡å·å¤„ç†ç¨‹åºäº‰ç”¨æ¡ä»¶å¯¼è‡´è½¯ä»¶çŠ¶æ€æŸåï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡ç”šè‡³ä»£ç æ‰§è¡Œã€‚\n å½“ä¿¡å·å¤„ç†ç¨‹åºä¸­å‘ç”Ÿä¸å¯é‡å…¥å‡½æ•°æˆ–çŠ¶æ€æ•æ„Ÿæ“ä½œæ—¶ï¼Œå°±ä¼šå‡ºç°è¿™äº›é—®é¢˜ã€‚å› ä¸ºä¿¡å·å¤„ç†ç¨‹åºä¸­éšæ—¶å¯ä»¥è¢«è°ƒç”¨ã€‚æ¯”å¦‚ï¼Œå½“åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­è°ƒç”¨freeæ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°å¦ä¸€ä¸ªä¿¡å·äº‰ç”¨æ¡ä»¶ï¼Œä»è€Œå¯¼è‡´åŒé‡é‡Šæ”¾ã€‚å³ä½¿ç»™å®šæŒ‡é’ˆåœ¨é‡Šæ”¾åè®¾ç½®ä¸ºNULLï¼Œåœ¨é‡Šæ”¾å†…å­˜å’Œå°†æŒ‡é’ˆè®¾ç½®ä¸ºNULLä¹‹é—´ä»ç„¶å­˜åœ¨ç«äº‰çš„å¯èƒ½ã€‚ ä¸ºå¤šä¸ªä¿¡å·è®¾ç½®äº†ç›¸åŒçš„ä¿¡å·å¤„ç†ç¨‹åºï¼Œè¿™å°¤å…¶æœ‰é—®é¢˜â€”â€”å› ä¸ºè¿™æ„å‘³ç€ä¿¡å·å¤„ç†ç¨‹åºæœ¬èº«å¯èƒ½ä¼šé‡æ–°è¿›å…¥ã€‚ä¾‹å¦‚ï¼Œmalloc()å’Œfree()æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä½¿ç”¨å…¨å±€æˆ–é™æ€æ•°æ®ç»“æ„æ¥ç®¡ç†å†…å­˜ï¼Œå¹¶ä¸”å®ƒä»¬è¢«syslog()ç­‰çœ‹ä¼¼æ— å®³çš„å‡½æ•°é—´æ¥ä½¿ç”¨ï¼›è¿™äº›å‡½æ•°å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æŸåå’Œä»£ç æ‰§è¡Œã€‚  // Bad char *log_message; void Handler(int signum) { syslog(LOG_NOTICE, \u0026#34;%s\\n\u0026#34;, log_m_essage); free(log_message); sleep(10); exit(0); } int main (int argc, char* argv[]) { log_message = strdup(argv[1]); signal(SIGHUP, Handler); signal(SIGTERM, Handler); sleep(10); } å¯ä»¥å€Ÿç”±ä¸‹åˆ—æ“ä½œè§„é¿é—®é¢˜ï¼š\n é¿å…åœ¨å¤šä¸ªå¤„ç†å‡½æ•°ä¸­å…±äº«æŸäº›å˜é‡ã€‚ åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­ä½¿ç”¨åŒæ­¥æ“ä½œã€‚ å±è”½ä¸ç›¸å…³çš„ä¿¡å·ï¼Œä»è€Œæä¾›åŸå­æ€§ã€‚ é¿å…åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ä¸æ»¡è¶³å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°ã€‚  å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nã€å»ºè®®ã€‘æ³¨æ„Time-of-check Time-of-use (TOCTOU) æ¡ä»¶ç«äº‰ TOCTOUï¼š è½¯ä»¶åœ¨ä½¿ç”¨æŸä¸ªèµ„æºä¹‹å‰æ£€æŸ¥è¯¥èµ„æºçš„çŠ¶æ€ï¼Œä½†æ˜¯è¯¥èµ„æºçš„çŠ¶æ€å¯ä»¥åœ¨æ£€æŸ¥å’Œä½¿ç”¨ä¹‹é—´æ›´æ”¹ï¼Œä»è€Œä½¿æ£€æŸ¥ç»“æœæ— æ•ˆã€‚å½“èµ„æºå¤„äºè¿™ç§æ„å¤–çŠ¶æ€æ—¶ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´è½¯ä»¶æ‰§è¡Œé”™è¯¯æ“ä½œã€‚\nå½“æ”»å‡»è€…å¯ä»¥å½±å“æ£€æŸ¥å’Œä½¿ç”¨ä¹‹é—´çš„èµ„æºçŠ¶æ€æ—¶ï¼Œæ­¤é—®é¢˜å¯èƒ½ä¸å®‰å…¨ç›¸å…³ã€‚è¿™å¯èƒ½å‘ç”Ÿåœ¨å…±äº«èµ„æº(å¦‚æ–‡ä»¶ã€å†…å­˜ï¼Œç”šè‡³å¤šçº¿ç¨‹ç¨‹åºä¸­çš„å˜é‡)ä¸Šã€‚åœ¨ç¼–ç¨‹æ—¶éœ€è¦æ³¨æ„é¿å…å‡ºç°TOCTOUé—®é¢˜ã€‚\nä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè¯¥æ–‡ä»¶å¯èƒ½å·²ç»åœ¨æ£€æŸ¥å’Œlstatä¹‹é—´è¿›è¡Œäº†æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºprintfæœ‰å»¶è¿Ÿã€‚\nstruct stat *st; lstat(\u0026#34;...\u0026#34;, st); printf(\u0026#34;foo\u0026#34;); if (st-\u0026gt;st_mtimespec == ...) { printf(\u0026#34;Now updating things\\n\u0026#34;); UpdateThings(); } TOCTOUéš¾ä»¥ä¿®å¤ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹ç¼“è§£æ–¹æ¡ˆï¼š\n é™åˆ¶å¯¹æ¥è‡ªå¤šä¸ªè¿›ç¨‹çš„æ–‡ä»¶çš„äº¤å‰æ“ä½œã€‚ å¦‚æœå¿…é¡»åœ¨å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ä¹‹é—´å…±äº«å¯¹èµ„æºçš„è®¿é—®ï¼Œé‚£ä¹ˆè¯·å°è¯•é™åˆ¶â€æ£€æŸ¥â€œï¼ˆCHECKï¼‰å’Œâ€ä½¿ç”¨â€œï¼ˆUSEï¼‰èµ„æºä¹‹é—´çš„æ—¶é—´é‡ï¼Œä½¿ä»–ä»¬ç›¸è·å°½é‡ä¸è¦å¤ªè¿œã€‚è¿™ä¸ä¼šä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼Œä½†å¯èƒ½ä¼šä½¿æ”»å‡»æ›´éš¾æˆåŠŸã€‚ åœ¨Useè°ƒç”¨ä¹‹åé‡æ–°æ£€æŸ¥èµ„æºï¼Œä»¥éªŒè¯æ˜¯å¦æ­£ç¡®æ‰§è¡Œäº†æ“ä½œã€‚ ç¡®ä¿ä¸€äº›ç¯å¢ƒé”å®šæœºåˆ¶èƒ½å¤Ÿè¢«ç”¨æ¥æœ‰æ•ˆä¿æŠ¤èµ„æºã€‚ä½†è¦ç¡®ä¿é”å®šæ˜¯æ£€æŸ¥ä¹‹å‰è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯åœ¨æ£€æŸ¥ä¹‹åè¿›è¡Œçš„ï¼Œä»¥ä¾¿æ£€æŸ¥æ—¶çš„èµ„æºä¸ä½¿ç”¨æ—¶çš„èµ„æºç›¸åŒã€‚  å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nä¸­é£é™©-é€»è¾‘é—®é¢˜\nåŠ å¯†è§£å¯† 4.1 ã€å¿…é¡»ã€‘ä¸å¾—æ˜æ–‡å­˜å‚¨ç”¨æˆ·å¯†ç ç­‰æ•æ„Ÿæ•°æ® ç”¨æˆ·å¯†ç åº”è¯¥ä½¿ç”¨ Argon2, scrypt, bcrypt, pbkdf2 ç­‰ç®—æ³•åšå“ˆå¸Œä¹‹åå†å­˜å…¥å­˜å‚¨ç³»ç»Ÿ, https://password-hashing.net/\nhttps://libsodium.gitbook.io/doc/password_hashing/default_phf#example-2-password-storage\nç”¨æˆ·æ•æ„Ÿæ•°æ®ï¼Œåº”è¯¥åšåˆ°ä¼ è¾“è¿‡ç¨‹ä¸­åŠ å¯†ï¼Œå­˜å‚¨çŠ¶æ€ä¸‹åŠ å¯† ä¼ è¾“è¿‡ç¨‹ä¸­åŠ å¯†ï¼Œå¯ä»¥ä½¿ç”¨ HTTPS ç­‰è®¤è¯åŠ å¯†é€šä¿¡åè®®\nå­˜å‚¨çŠ¶æ€ä¸‹åŠ å¯†ï¼Œå¯ä»¥ä½¿ç”¨ SQLCipher ç­‰ç±»ä¼¼æ–¹æ¡ˆã€‚\n4.2 ã€å¿…é¡»ã€‘å†…å­˜ä¸­çš„ç”¨æˆ·å¯†ç ç­‰æ•æ„Ÿæ•°æ®åº”è¯¥å®‰å…¨æŠ¹é™¤ ä¾‹å¦‚ç”¨æˆ·å¯†ç ç­‰ï¼Œå³ä½¿æ˜¯ä¸´æ—¶ä½¿ç”¨ï¼Œä¹Ÿåº”åœ¨ä½¿ç”¨å®Œæˆååº”å½“å°†å†…å®¹å½»åº•æ¸…ç©ºã€‚\né”™è¯¯ï¼š\n#include \u0026lt;openssl/crypto.h\u0026gt;#include \u0026lt;unistd.h\u0026gt; { ... string user_password(100, \u0026#39;\\0\u0026#39;); snprintf(\u0026amp;user_password, \u0026#34;password: %s\u0026#34;, user_password.size(), password_from_input); ... } æ­£ç¡®ï¼š\n{ ... string user_password(100, \u0026#39;\\0\u0026#39;); snprintf(\u0026amp;user_password, \u0026#34;password: %s\u0026#34;, user_password.size(), password_from_input); ... OPENSSL_cleanse(\u0026amp;user_password[0], user_password.size()); } å…³è”æ¼æ´:\né«˜é£é™©-æ•æ„Ÿä¿¡æ¯æ³„éœ²\n4.3 ã€å¿…é¡»ã€‘rand() ç±»å‡½æ•°åº”æ­£ç¡®åˆå§‹åŒ– randç±»å‡½æ•°çš„éšæœºæ€§å¹¶ä¸é«˜ã€‚è€Œä¸”åœ¨ä½¿ç”¨å‰éœ€è¦ä½¿ç”¨srand()æ¥åˆå§‹åŒ–ã€‚æœªåˆå§‹åŒ–çš„éšæœºæ•°å¯èƒ½å¯¼è‡´æŸäº›å†…å®¹å¯é¢„æµ‹ã€‚\n// Bad int main() { int foo = rand(); return 0; } ä¸Šè¿°ä»£ç æ‰§è¡Œå®Œæˆåï¼Œfooçš„å€¼æ˜¯å›ºå®šçš„ã€‚å®ƒç­‰æ•ˆäº srand(1); rand();ã€‚\n// Good  int main() { srand(time(0)); int foo = rand(); return 0; } å…³è”æ¼æ´:\né«˜é£é™©-é€»è¾‘æ¼æ´\n4.4 ã€å¿…é¡»ã€‘åœ¨éœ€è¦é«˜å¼ºåº¦å®‰å…¨åŠ å¯†æ—¶ä¸åº”ä½¿ç”¨å¼±PRNGå‡½æ•° åœ¨éœ€è¦ç”Ÿæˆ AES/SM1/HMAC ç­‰ç®—æ³•çš„å¯†é’¥/IV/Nonceï¼Œ RSA/ECDSA/ECDH ç­‰ç®—æ³•çš„ç§é’¥ï¼Œè¿™ç±»éœ€è¦é«˜å®‰å…¨æ€§çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¿…é¡»ä½¿ç”¨å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨ (Cryptographically Secure PseudoRandom Number Generator (CSPRNG) ), ä¸å¾—ä½¿ç”¨ rand() ç­‰æ— å¯†ç å­¦å®‰å…¨æ€§ä¿è¯çš„æ™®é€šéšæœºæ•°ç”Ÿæˆå™¨ã€‚\næ¨èä½¿ç”¨çš„ CSPRNG æœ‰ï¼š\n  OpenSSL ä¸­çš„ RAND_bytes() å‡½æ•°, https://www.openssl.org/docs/man1.1.1/man3/RAND_bytes.html\n  libsodium ä¸­çš„ randombytes_buf() å‡½æ•°\n  Linux kernel çš„ getrandom() ç³»ç»Ÿè°ƒç”¨, https://man7.org/linux/man-pages/man2/getrandom.2.html . æˆ–è€…è¯» /dev/urandom æ–‡ä»¶, æˆ–è€… /dev/random æ–‡ä»¶ã€‚\n  Apple IOS çš„ SecRandomCopyBytes(), https://developer.apple.com/documentation/security/1399291-secrandomcopybytes\n  Windows ä¸‹çš„ BCryptGenRandom(), CryptGenRandom(), RtlGenRandom()\n  #include \u0026lt;openssl/aes.h\u0026gt;#include \u0026lt;openssl/crypto.h\u0026gt;#include \u0026lt;openssl/rand.h\u0026gt;#include \u0026lt;unistd.h\u0026gt; { unsigned char key[16]; if (1 != RAND_bytes(\u0026amp;key[0], sizeof(key))) { //... é”™è¯¯å¤„ç†  return -1; } AES_KEY aes_key; if (0 != AES_set_encrypt_key(\u0026amp;key[0], sizeof(key) * 8, \u0026amp;aes_key)) { // ... é”™è¯¯å¤„ç†  return -1; } ... OPENSSL_cleanse(\u0026amp;key[0], sizeof(key)); } rand()ç±»å‡½æ•°çš„éšæœºæ€§å¹¶ä¸é«˜ã€‚æ•æ„Ÿæ“ä½œæ—¶ï¼Œå¦‚è®¾è®¡åŠ å¯†ç®—æ³•æ—¶ï¼Œä¸å¾—ä½¿ç”¨rand()æˆ–è€…ç±»ä¼¼çš„ç®€å•çº¿æ€§åŒä½™ä¼ªéšæœºæ•°ç”Ÿæˆå™¨æ¥ä½œä¸ºéšæœºæ•°å‘ç”Ÿå™¨ã€‚ç¬¦åˆè¯¥å®šä¹‰çš„æ¯”ç‰¹åºåˆ—çš„ç‰¹ç‚¹æ˜¯ï¼Œåºåˆ—ä¸­â€œ1â€çš„æ•°é‡çº¦ç­‰äºâ€œ0â€çš„æ•°é‡ï¼›åŒç†ï¼Œâ€œ01â€ã€â€œ00â€ã€â€œ10â€ã€â€œ11â€çš„æ•°é‡å¤§è‡´ç›¸åŒï¼Œä»¥æ­¤ç±»æ¨ã€‚\nä¾‹å¦‚ C æ ‡å‡†åº“ä¸­çš„ rand() çš„å®ç°åªæ˜¯ç®€å•çš„çº¿æ€§åŒä½™ç®—æ³•ï¼Œç”Ÿæˆçš„ä¼ªéšæœºæ•°å…·æœ‰è¾ƒå¼ºçš„å¯é¢„æµ‹æ€§ã€‚\nå½“éœ€è¦å®ç°é«˜å¼ºåº¦åŠ å¯†ï¼Œä¾‹å¦‚æ¶‰åŠé€šä¿¡å®‰å…¨æ—¶ï¼Œä¸åº”å½“ä½¿ç”¨ rand() ä½œä¸ºéšæœºæ•°å‘ç”Ÿå™¨ã€‚\nå®é™…åº”ç”¨ä¸­ï¼ŒC++11 æ ‡å‡†æä¾›çš„random_deviceä¿è¯åŠ å¯†çš„å®‰å…¨æ€§å’Œéšæœºæ€§ ä½†æ˜¯ C++ æ ‡å‡†å¹¶ä¸ä¿è¯è¿™ä¸€ç‚¹ã€‚è·¨å¹³å°çš„ä»£ç å¯ä»¥è€ƒè™‘ç”¨ OpenSSL ç­‰ä¿è¯å¯†ç å­¦å®‰å…¨çš„åº“é‡Œçš„éšæœºæ•°å‘ç”Ÿå™¨ã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-æ•æ„Ÿæ•°æ®æ³„éœ²\n4.5 ã€å¿…é¡»ã€‘è‡ªå·±å®ç°çš„randèŒƒå›´ä¸åº”è¿‡å° å¦‚æœåœ¨å¼±å®‰å…¨åœºæ™¯ç›¸å…³çš„ç®—æ³•ä¸­è‡ªå·±å®ç°äº†PRNGï¼Œè¯·ç¡®ä¿randå‡ºæ¥çš„éšæœºæ•°ä¸ä¼šå¾ˆå°æˆ–å¯é¢„æµ‹ã€‚\n// Bad int32_t val = ((state[0] * 1103515245U) + 12345U) \u0026amp; 999999; ä¸Šè¿°ä¾‹å­å¯èƒ½æƒ³ç”Ÿæˆ0~999999å…±100ä¸‡ç§å¯èƒ½çš„éšæœºæ•°ï¼Œä½†æ˜¯999999çš„äºŒè¿›åˆ¶æ˜¯11110100001000111111ï¼Œä¸\u0026amp;è¿ç®—åï¼Œ0ä½ä¸€ç›´æ˜¯0ï¼Œæ‰€ä»¥ç”Ÿæˆå‡ºçš„èŒƒå›´æ˜æ˜¾ä¼šå°äº100ä¸‡ç§ã€‚\n// Good int32_t val = ((state[0] * 1103515245U) + 12345U) % 1000000; // Good int32_t val = ((state[0] * 1103515245U) + 12345U) \u0026amp; 0x7fffffff; å…³è”æ¼æ´:\né«˜é£é™©-é€»è¾‘æ¼æ´\næ–‡ä»¶æ“ä½œ ã€å¿…é¡»ã€‘é¿å…è·¯å¾„ç©¿è¶Šé—®é¢˜ åœ¨è¿›è¡Œæ–‡ä»¶æ“ä½œæ—¶ï¼Œéœ€è¦åˆ¤æ–­å¤–éƒ¨ä¼ å…¥çš„æ–‡ä»¶åæ˜¯å¦åˆæ³•ï¼Œå¦‚æœæ–‡ä»¶åä¸­åŒ…å« ../ ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œåˆ™ä¼šé€ æˆè·¯å¾„ç©¿è¶Šï¼Œå¯¼è‡´ä»»æ„æ–‡ä»¶çš„è¯»å†™ã€‚\né”™è¯¯ï¼š\nvoid Foo() { char file_path[PATH_MAX] = \u0026#34;/home/user/code/\u0026#34;; // å¦‚æœä¼ å…¥çš„æ–‡ä»¶ååŒ…å«../å¯å¯¼è‡´è·¯å¾„ç©¿è¶Š  // ä¾‹å¦‚\u0026#34;../file.txt\u0026#34;ï¼Œåˆ™å¯ä»¥è¯»å–åˆ°ä¸Šå±‚ç›®å½•çš„file.txtæ–‡ä»¶  char name[20] = \u0026#34;../file.txt\u0026#34;; memcpy(file_path + strlen(file_path), name, sizeof(name)); int fd = open(file_path, O_RDONLY); if (fd != -1) { char data[100] = {0}; int num = 0; memset(data, 0, sizeof(data)); num = read(fd, data, sizeof(data)); if (num \u0026gt; 0) { write(STDOUT_FILENO, data, num); } close(fd); } } æ­£ç¡®ï¼š\nvoid Foo() { char file_path[PATH_MAX] = \u0026#34;/home/user/code/\u0026#34;; char name[20] = \u0026#34;../file.txt\u0026#34;; // åˆ¤æ–­ä¼ å…¥çš„æ–‡ä»¶åæ˜¯å¦éæ³•ï¼Œä¾‹å¦‚\u0026#34;../file.txt\u0026#34;ä¸­åŒ…å«éæ³•å­—ç¬¦../ï¼Œç›´æ¥è¿”å›  if (strstr(name, \u0026#34;..\u0026#34;) != NULL){ // åŒ…å«éæ³•å­—ç¬¦  return; } memcpy(file_path + strlen(file_path), name, sizeof(name)); int fd = open(file_path, O_RDONLY); if (fd != -1) { char data[100] = {0}; int num = 0; memset(data, 0, sizeof(data)); num = read(fd, data, sizeof(data)); if (num \u0026gt; 0) { write(STDOUT_FILENO, data, num); } close(fd); } } å…³è”æ¼æ´:\né«˜é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘é¿å…ç›¸å¯¹è·¯å¾„å¯¼è‡´çš„å®‰å…¨é—®é¢˜ï¼ˆDLLã€EXEåŠ«æŒç­‰é—®é¢˜ï¼‰ åœ¨ç¨‹åºä¸­ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯èƒ½å¯¼è‡´ä¸€äº›å®‰å…¨é£é™©ï¼Œä¾‹å¦‚DLLã€EXEåŠ«æŒç­‰é—®é¢˜ã€‚\nä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼Œå¯èƒ½å­˜åœ¨åŠ«æŒé—®é¢˜ï¼š\nint Foo() { // ä¼ å…¥çš„æ˜¯dllæ–‡ä»¶åï¼Œå¦‚æœå½“å‰ç›®å½•ä¸‹è¢«å†™å…¥äº†æ¶æ„çš„åŒådllï¼Œåˆ™å¯èƒ½å¯¼è‡´dllåŠ«æŒ  HINSTANCE hinst = ::LoadLibrary(\u0026#34;dll_nolib.dll\u0026#34;); if (hinst != NULL) { cout\u0026lt;\u0026lt;\u0026#34;dll loaded!\u0026#34; \u0026lt;\u0026lt; endl; } return 0; } é’ˆå¯¹DLLåŠ«æŒçš„å®‰å…¨ç¼–ç çš„è§„èŒƒï¼š\n1ï¼‰è°ƒç”¨LoadLibraryï¼ŒLoadLibraryExï¼ŒCreateProcessï¼ŒShellExecuteç­‰è¿›è¡Œæ¨¡å—åŠ è½½çš„å‡½æ•°æ—¶ï¼ŒæŒ‡æ˜æ¨¡å—çš„å®Œæ•´ï¼ˆå…¨ï¼‰è·¯å¾„ï¼Œç¦æ­¢ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè¿™æ ·å°±å¯é¿å…ä»å…¶å®ƒç›®å½•åŠ è½½DLLã€‚ 2ï¼‰åœ¨åº”ç”¨ç¨‹åºçš„å¼€å¤´è°ƒç”¨SetDllDirectory(TEXT(\u0026quot;\u0026quot;)); ä»è€Œå°†å½“å‰ç›®å½•ä»DLLçš„æœç´¢åˆ—è¡¨ä¸­åˆ é™¤ã€‚ç»“åˆSetDefaultDllDirectoriesï¼ŒAddDllDirectoryï¼ŒRemoveDllDirectoryè¿™å‡ ä¸ªAPIé…åˆä½¿ç”¨ï¼Œå¯ä»¥æœ‰æ•ˆçš„è§„é¿DLLåŠ«æŒé—®é¢˜ã€‚è¿™äº›APIåªèƒ½åœ¨æ‰“äº†KB2533623è¡¥ä¸çš„Windows7ï¼Œ2008ä¸Šä½¿ç”¨ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘æ–‡ä»¶æƒé™æ§åˆ¶ åœ¨åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œéœ€è¦æ ¹æ®æ–‡ä»¶çš„æ•æ„Ÿçº§åˆ«è®¾ç½®ä¸åŒçš„è®¿é—®æƒé™ï¼Œä»¥é˜²æ­¢æ•æ„Ÿæ•°æ®è¢«å…¶ä»–æ¶æ„ç¨‹åºè¯»å–æˆ–å†™å…¥ã€‚\né”™è¯¯ï¼š\nint Foo() { // ä¸è¦è®¾ç½®ä¸º777æƒé™ï¼Œä»¥é˜²æ­¢è¢«å…¶ä»–æ¶æ„ç¨‹åºæ“ä½œ  if (creat(\u0026#34;file.txt\u0026#34;, 0777) \u0026lt; 0) { printf(\u0026#34;æ–‡ä»¶åˆ›å»ºå¤±è´¥ï¼\\n\u0026#34;); } else { printf(\u0026#34;æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼\\n\u0026#34;); } return 0; } å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nå†…å­˜æ“ä½œ ã€å¿…é¡»ã€‘é˜²æ­¢å„ç§è¶Šç•Œå†™ï¼ˆå‘å‰/å‘åï¼‰ é”™è¯¯1ï¼š\nint a[5]; a[5] = 0; é”™è¯¯2ï¼š\nint a[5]; int b = user_controlled_value; a[b] = 3; å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘é˜²æ­¢ä»»æ„åœ°å€å†™ ä»»æ„åœ°å€å†™ä¼šå¯¼è‡´ä¸¥é‡çš„å®‰å…¨éšæ‚£ï¼Œå¯èƒ½å¯¼è‡´ä»£ç æ‰§è¡Œã€‚å› æ­¤ï¼Œåœ¨ç¼–ç æ—¶å¿…é¡»æ ¡éªŒå†™å…¥çš„åœ°å€ã€‚\né”™è¯¯ï¼š\nvoid Write(MyStruct dst_struct) { char payload[10] = { 0 }; memcpy(dst_struct.buf, payload, sizeof(payload)); } int main() { MyStruct dst_stuct; dst_stuct.buf = (char*)user_controlled_value; Write(dst_stuct); return 0; } å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\næ•°å­—æ“ä½œ ã€å¿…é¡»ã€‘é˜²æ­¢æ•´æ•°æº¢å‡º åœ¨è®¡ç®—æ—¶éœ€è¦è€ƒè™‘æ•´æ•°æº¢å‡ºçš„å¯èƒ½ï¼Œå°¤å…¶åœ¨è¿›è¡Œå†…å­˜æ“ä½œæ—¶ï¼Œéœ€è¦å¯¹åˆ†é…ã€æ‹·è´ç­‰å¤§å°è¿›è¡Œåˆæ³•æ ¡éªŒï¼Œé˜²æ­¢æ•´æ•°æº¢å‡ºå¯¼è‡´çš„æ¼æ´ã€‚\né”™è¯¯ï¼ˆè¯¥ä¾‹å­åœ¨è®¡ç®—æ—¶äº§ç”Ÿæ•´æ•°æº¢å‡ºï¼‰\nconst int kMicLen = 4; // æ•´æ•°æº¢å‡º void Foo() { int len = 1; char payload[10] = { 0 }; char dst[10] = { 0 }; // Bad, ç”±äºlenå°äº4å­—èŠ‚ï¼Œå¯¼è‡´è®¡ç®—æ‹·è´é•¿åº¦æ—¶ï¼Œæ•´æ•°æº¢å‡º  // len - MIC_LEN == 0xfffffffd  memcpy(dst, payload, len - kMicLen); } æ­£ç¡®ä¾‹å­\nvoid Foo() { int len = 1; char payload[10] = { 0 }; char dst[10] = { 0 }; int size = len - kMicLen; // æ‹·è´å‰å¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­  if (size \u0026gt; 0 \u0026amp;\u0026amp; size \u0026lt; 10) { memcpy(dst, payload, size); printf(\u0026#34;memcpy good\\n\u0026#34;); } } å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘é˜²æ­¢Off-By-One åœ¨è¿›è¡Œè®¡ç®—æˆ–è€…æ“ä½œæ—¶ï¼Œå¦‚æœä½¿ç”¨çš„æœ€å¤§å€¼æˆ–æœ€å°å€¼ä¸æ­£ç¡®ï¼Œä½¿å¾—è¯¥å€¼æ¯”æ­£ç¡®å€¼å¤š1æˆ–å°‘1ï¼Œå¯èƒ½å¯¼è‡´å®‰å…¨é£é™©ã€‚\né”™è¯¯ï¼š\nchar firstname[20]; char lastname[20]; char fullname[40]; fullname[0] = \u0026#39;\\0\u0026#39;; strncat(fullname, firstname, 20); // ç¬¬äºŒæ¬¡è°ƒç”¨strncat()å¯èƒ½ä¼šè¿½åŠ å¦å¤–20ä¸ªå­—ç¬¦ã€‚å¦‚æœè¿™20ä¸ªå­—ç¬¦æ²¡æœ‰ç»ˆæ­¢ç©ºå­—ç¬¦ï¼Œåˆ™å­˜åœ¨å®‰å…¨é—®é¢˜ strncat(fullname, lastname, 20); æ­£ç¡®ï¼š\nchar firstname[20]; char lastname[20]; char fullname[40]; fullname[0] = \u0026#39;\\0\u0026#39;; // å½“ä½¿ç”¨åƒstrncat()å‡½æ•°æ—¶ï¼Œå¿…é¡»åœ¨ç¼“å†²åŒºçš„æœ«å°¾ä¸ºç»ˆæ­¢ç©ºå­—ç¬¦ç•™ä¸‹ä¸€ä¸ªç©ºå­—èŠ‚ï¼Œé¿å…off-by-one strncat(fullname, firstname, sizeof(fullname) - strlen(fullname) - 1); strncat(fullname, lastname, sizeof(fullname) - strlen(fullname) - 1); å¯¹äº C++ ä»£ç ï¼Œå†æ¬¡å¼ºçƒˆå»ºè®®ä½¿ç”¨ stringã€vector ç­‰ç»„ä»¶ä»£æ›¿åŸå§‹æŒ‡é’ˆå’Œæ•°ç»„æ“ä½œã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘é¿å…å¤§å°ç«¯é”™è¯¯ åœ¨ä¸€äº›æ¶‰åŠå¤§å°ç«¯æ•°æ®å¤„ç†çš„åœºæ™¯ï¼Œéœ€è¦è¿›è¡Œå¤§å°ç«¯åˆ¤æ–­ï¼Œä¾‹å¦‚ä»å¤§ç«¯è®¾å¤‡å–å‡ºçš„å€¼ï¼Œè¦ä»¥å¤§ç«¯è¿›è¡Œå¤„ç†ï¼Œé¿å…ç«¯åºé”™è¯¯ä½¿ç”¨ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘æ£€æŸ¥é™¤ä»¥é›¶å¼‚å¸¸ åœ¨è¿›è¡Œé™¤æ³•è¿ç®—æ—¶ï¼Œéœ€è¦åˆ¤æ–­è¢«é™¤æ•°æ˜¯å¦ä¸ºé›¶ï¼Œä»¥é˜²å¯¼è‡´ç¨‹åºä¸ç¬¦åˆé¢„æœŸæˆ–è€…å´©æºƒã€‚\né”™è¯¯ï¼š\ndouble divide(double x, double y) { return x / y; } int divide(int x, int y) { return x / y; } æ­£ç¡®ï¼š\ndouble divide(double x, double y) { if (y == 0) { throw DivideByZero; } return x / y; } å…³è”æ¼æ´:\nä½é£é™©-æ‹’ç»æœåŠ¡\nã€å¿…é¡»ã€‘é˜²æ­¢æ•°å­—ç±»å‹çš„é”™è¯¯å¼ºè½¬ åœ¨æœ‰ç¬¦å·å’Œæ— ç¬¦å·æ•°å­—å‚ä¸çš„è¿ç®—ä¸­ï¼Œéœ€è¦æ³¨æ„ç±»å‹å¼ºè½¬å¯èƒ½å¯¼è‡´çš„é€»è¾‘é”™è¯¯ï¼Œå»ºè®®æŒ‡å®šå‚ä¸è®¡ç®—æ—¶æ•°å­—çš„ç±»å‹æˆ–è€…ç»Ÿä¸€ç±»å‹å‚ä¸è®¡ç®—ã€‚\né”™è¯¯ä¾‹å­\nint Foo() { int len = 1; unsigned int size = 9; // 1 \u0026lt; 9 - 10 ? ç”±äºè¿ç®—ä¸­æ— ç¬¦å·å’Œæœ‰ç¬¦å·æ··ç”¨ï¼Œå¯¼è‡´è®¡ç®—ç»“æœä»¥æ— ç¬¦å·è®¡ç®—  if (len \u0026lt; size - 10) { printf(\u0026#34;Bad\\n\u0026#34;); } else { printf(\u0026#34;Good\\n\u0026#34;); } } æ­£ç¡®ä¾‹å­\nvoid Foo() { // ç»Ÿä¸€ä¸¤è€…è®¡ç®—ç±»å‹ä¸ºæœ‰ç¬¦å·  int len = 1; int size = 9; if (len \u0026lt; size - 10) { printf(\u0026#34;Bad\\n\u0026#34;); } else { printf(\u0026#34;Good\\n\u0026#34;); } } å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nä¸­é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘æ¯”è¾ƒæ•°æ®å¤§å°æ—¶åŠ ä¸Šæœ€å°/æœ€å¤§å€¼çš„æ ¡éªŒ åœ¨è¿›è¡Œæ•°æ®å¤§å°æ¯”è¾ƒæ—¶ï¼Œè¦åˆç†åœ°æ ¡éªŒæ•°æ®çš„åŒºé—´èŒƒå›´ï¼Œå»ºè®®æ ¹æ®æ•°å­—ç±»å‹ï¼Œå¯¹å…¶è¿›è¡Œæœ€å¤§å’Œæœ€å°å€¼çš„åˆ¤æ–­ï¼Œä»¥é˜²æ­¢éé¢„æœŸé”™è¯¯ã€‚\né”™è¯¯ï¼š\nvoid Foo(int index) { int a[30] = {0}; // æ­¤å¤„indexæ˜¯intå‹ï¼Œåªè€ƒè™‘äº†indexå°äºæ•°ç»„å¤§å°ï¼Œä½†æ˜¯å¹¶æœªåˆ¤æ–­æ˜¯å¦å¤§äº0  if (index \u0026lt; 30) { // å¦‚æœindexä¸ºè´Ÿæ•°ï¼Œåˆ™è¶Šç•Œ  a[index] = 1; } } æ­£ç¡®ï¼š\nvoid Foo(int index) { int a[30] = {0}; // åˆ¤æ–­indexçš„æœ€å¤§æœ€å°å€¼  if (index \u0026gt;=0 \u0026amp;\u0026amp; index \u0026lt; 30) { a[index] = 1; } } å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\næŒ‡é’ˆæ“ä½œ ã€å»ºè®®ã€‘æ£€æŸ¥åœ¨pointerä¸Šä½¿ç”¨sizeof é™¤äº†æµ‹è¯•å½“å‰æŒ‡é’ˆé•¿åº¦ï¼Œå¦åˆ™ä¸€èˆ¬ä¸ä¼šåœ¨pointerä¸Šä½¿ç”¨sizeofã€‚\næ­£ç¡®ï¼š\nsize_t pointer_length = sizeof(void*); å¯èƒ½é”™è¯¯ï¼š\nsize_t structure_length = sizeof(Foo*); å¯èƒ½æ˜¯ï¼š\nsize_t structure_length = sizeof(Foo); å…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘æ£€æŸ¥ç›´æ¥å°†æ•°ç»„å’Œ0æ¯”è¾ƒçš„ä»£ç  é”™è¯¯ï¼š\nint a[3]; ...; if (a \u0026gt; 0) ...; è¯¥åˆ¤æ–­æ°¸è¿œä¸ºçœŸï¼Œç­‰ä»·äº:\nint a[3]; ...; if (\u0026amp;a[0]) ...; å¯èƒ½æ˜¯ï¼š\nint a[3]; ...; if(a[0] \u0026gt; 0) ...; å¼€å¯è¶³å¤Ÿçš„ç¼–è¯‘å™¨è­¦å‘Šï¼ˆGCC ä¸­ä¸º -Waddressï¼Œå¹¶å·²åŒ…å«åœ¨ -Wall ä¸­ï¼‰ï¼Œå¹¶è®¾ç½®ä¸ºé”™è¯¯ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æœŸé—´å‘ç°è¯¥é—®é¢˜ã€‚\nå…³è”æ¼æ´:\nä¸­é£é™©-é€»è¾‘æ¼æ´\nã€å¿…é¡»ã€‘ä¸åº”å½“å‘æŒ‡é’ˆèµ‹äºˆå†™æ­»çš„åœ°å€ ç‰¹æ®Šæƒ…å†µéœ€è¦ç‰¹æ®Šå¯¹å¾…ï¼ˆæ¯”å¦‚å¼€å‘ç¡¬ä»¶å›ºä»¶æ—¶å¯èƒ½éœ€è¦å†™æ­»ï¼‰\nä½†æ˜¯å¦‚æœæ˜¯ç³»ç»Ÿé©±åŠ¨å¼€å‘ä¹‹ç±»çš„ï¼Œå†™æ­»å¯èƒ½ä¼šå¯¼è‡´åç»­çš„é—®é¢˜ã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘æ£€æŸ¥ç©ºæŒ‡é’ˆ é”™è¯¯ï¼š\n*foo = 100; if (!foo) { ERROR(\u0026#34;foobar\u0026#34;); } æ­£ç¡®ï¼š\nif (!foo) { ERROR(\u0026#34;foobar\u0026#34;); } *foo = 100; é”™è¯¯ï¼š\nvoid Foo(char* bar) { *bar = \u0026#39;\\0\u0026#39;; } æ­£ç¡®ï¼š\nvoid Foo(char* bar) { if(bar) *bar = \u0026#39;\\0\u0026#39;; else ...; } å…³è”æ¼æ´:\nä½é£é™©-æ‹’ç»æœåŠ¡\nã€å¿…é¡»ã€‘é‡Šæ”¾å®Œåç½®ç©ºæŒ‡é’ˆ åœ¨å¯¹æŒ‡é’ˆè¿›è¡Œé‡Šæ”¾åï¼Œéœ€è¦å°†è¯¥æŒ‡é’ˆè®¾ç½®ä¸ºNULLï¼Œä»¥é˜²æ­¢åç»­freeæŒ‡é’ˆçš„è¯¯ç”¨ï¼Œå¯¼è‡´UAFç­‰å…¶ä»–å†…å­˜ç ´åé—®é¢˜ã€‚å°¤å…¶æ˜¯åœ¨ç»“æ„ä½“ã€ç±»é‡Œé¢å­˜å‚¨çš„åŸå§‹æŒ‡é’ˆã€‚\né”™è¯¯ï¼š\nvoid foo() { char* p = (char*)malloc(100); memcpy(p, \u0026#34;hello\u0026#34;, 6); // æ­¤æ—¶pæ‰€æŒ‡å‘çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼Œä½†æ˜¯pæ‰€æŒ‡çš„åœ°å€ä»ç„¶ä¸å˜  printf(\u0026#34;%s\\n\u0026#34;, p); free(p); // æœªè®¾ç½®ä¸ºNULLï¼Œå¯èƒ½å¯¼è‡´UAFç­‰å†…å­˜é”™è¯¯  if (p != NULL) { // æ²¡æœ‰èµ·åˆ°é˜²é”™ä½œç”¨  printf(\u0026#34;%s\\n\u0026#34;, p); // é”™è¯¯ä½¿ç”¨å·²ç»é‡Šæ”¾çš„å†…å­˜  } } æ­£ç¡®ï¼š\nvoid foo() { char* p = (char*)malloc(100); memcpy(p, \u0026#34;hello\u0026#34;, 6); // æ­¤æ—¶pæ‰€æŒ‡å‘çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼Œä½†æ˜¯pæ‰€æŒ‡çš„åœ°å€ä»ç„¶ä¸å˜  printf(\u0026#34;%s\\n\u0026#34;, p); free(p); //é‡Šæ”¾åå°†æŒ‡é’ˆèµ‹å€¼ä¸ºç©º  p = NULL; if (p != NULL) { // æ²¡æœ‰èµ·åˆ°é˜²é”™ä½œç”¨  printf(\u0026#34;%s\\n\u0026#34;, p); // é”™è¯¯ä½¿ç”¨å·²ç»é‡Šæ”¾çš„å†…å­˜  } } å¯¹äº C++ ä»£ç ï¼Œä½¿ç”¨ stringã€vectorã€æ™ºèƒ½æŒ‡é’ˆç­‰ä»£æ›¿åŸå§‹å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥å¤§é‡å‡å°‘è¿™ç±»é”™è¯¯ã€‚\nå…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘é˜²æ­¢é”™è¯¯çš„ç±»å‹è½¬æ¢ï¼ˆtype confusionï¼‰ åœ¨å¯¹æŒ‡é’ˆã€å¯¹è±¡æˆ–å˜é‡è¿›è¡Œæ“ä½œæ—¶ï¼Œéœ€è¦èƒ½å¤Ÿæ­£ç¡®åˆ¤æ–­æ‰€æ“ä½œå¯¹è±¡çš„åŸå§‹ç±»å‹ã€‚å¦‚æœä½¿ç”¨äº†ä¸åŸå§‹ç±»å‹ä¸å…¼å®¹çš„ç±»å‹è¿›è¡Œè®¿é—®ï¼Œåˆ™å­˜åœ¨å®‰å…¨éšæ‚£ã€‚\né”™è¯¯ï¼š\nconst int NAME_TYPE = 1; const int ID_TYPE = 2; // è¯¥ç±»å‹æ ¹æ® msg_type è¿›è¡ŒåŒºåˆ†ï¼Œå¦‚æœåœ¨å¯¹MessageBufferè¿›è¡Œæ“ä½œæ—¶æ²¡æœ‰åˆ¤æ–­ç›®æ ‡å¯¹è±¡ï¼Œåˆ™å­˜åœ¨ç±»å‹æ··æ·† struct MessageBuffer { int msg_type; union { const char *name; int name_id; }; }; void Foo() { struct MessageBuffer buf; const char* default_message = \u0026#34;Hello World\u0026#34;; // è®¾ç½®è¯¥æ¶ˆæ¯ç±»å‹ä¸º NAME_TYPEï¼Œå› æ­¤bufé¢„æœŸçš„ç±»å‹ä¸º msg_type + name  buf.msg_type = NAME_TYPE; buf.name = default_message; printf(\u0026#34;Pointer of buf.name is %p\\n\u0026#34;, buf.name); // æ²¡æœ‰åˆ¤æ–­ç›®æ ‡æ¶ˆæ¯ç±»å‹æ˜¯å¦ä¸ºID_TYPEï¼Œç›´æ¥ä¿®æ”¹nameIDï¼Œå¯¼è‡´ç±»å‹æ··æ·†  buf.name_id = user_controlled_value; if (buf.msg_type == NAME_TYPE) { printf(\u0026#34;Pointer of buf.name is now %p\\n\u0026#34;, buf.name); // ä»¥NAME_TYPEä½œä¸ºç±»å‹æ“ä½œï¼Œå¯èƒ½å¯¼è‡´éæ³•å†…å­˜è¯»å†™  printf(\u0026#34;Message: %s\\n\u0026#34;, buf.name); } else { printf(\u0026#34;Message: Use ID %d\\n\u0026#34;, buf.name_id); } } æ­£ç¡®ï¼ˆåˆ¤æ–­æ“ä½œçš„ç›®æ ‡æ˜¯å¦æ˜¯é¢„æœŸç±»å‹ï¼‰ï¼š\nvoid Foo() { struct MessageBuffer buf; const char* default_message = \u0026#34;Hello World\u0026#34;; // è®¾ç½®è¯¥æ¶ˆæ¯ç±»å‹ä¸º NAME_TYPEï¼Œå› æ­¤bufé¢„æœŸçš„ç±»å‹ä¸º msg_type + name  buf.msg_type = NAME_TYPE; buf.name = default_msessage; printf(\u0026#34;Pointer of buf.name is %p\\n\u0026#34;, buf.name); // åˆ¤æ–­ç›®æ ‡æ¶ˆæ¯ç±»å‹æ˜¯å¦ä¸º ID_TYPEï¼Œä¸æ˜¯é¢„æœŸç±»å‹åˆ™åšå¯¹åº”æ“ä½œ  if (buf.msg_type == ID_TYPE) buf.name_id = user_controlled_value; if (buf.msg_type == NAME_TYPE) { printf(\u0026#34;Pointer of buf.name is now %p\\n\u0026#34;, buf.name); printf(\u0026#34;Message: %s\\n\u0026#34;, buf.name); } else { printf(\u0026#34;Message: Use ID %d\\n\u0026#34;, buf.name_id); } } å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\nã€å¿…é¡»ã€‘æ™ºèƒ½æŒ‡é’ˆä½¿ç”¨å®‰å…¨ åœ¨ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œé˜²æ­¢å…¶å’ŒåŸå§‹æŒ‡é’ˆçš„æ··ç”¨ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œä¾‹å¦‚ UAF ç­‰å®‰å…¨é£é™©ã€‚\né”™è¯¯ä¾‹å­ï¼š\nclass Foo { public: explicit Foo(int num) { data_ = num; }; void Function() { printf(\u0026#34;Obj is %p, data = %d\\n\u0026#34;, this, data_); }; private: int data_; }; std::unique_ptr\u0026lt;Foo\u0026gt; fool_u_ptr = nullptr; Foo* pfool_raw_ptr = nullptr; void Risk() { fool_u_ptr = make_unique\u0026lt;Foo\u0026gt;(1); // ä»ç‹¬å æ™ºèƒ½æŒ‡é’ˆä¸­è·å–åŸå§‹æŒ‡é’ˆ,\u0026lt;Foo\u0026gt;(1)  pfool_raw_ptr = fool_u_ptr.get(); // è°ƒç”¨\u0026lt;Foo\u0026gt;(1)çš„å‡½æ•°  pfool_raw_ptr-\u0026gt;Function(); // ç‹¬å æ™ºèƒ½æŒ‡é’ˆé‡æ–°èµ‹å€¼åä¼šé‡Šæ”¾å†…å­˜  fool_u_ptr = make_unique\u0026lt;Foo\u0026gt;(2); // é€šè¿‡åŸå§‹æŒ‡é’ˆæ“ä½œä¼šå¯¼è‡´UAFï¼Œpfool_raw_ptræŒ‡å‘çš„å¯¹è±¡å·²ç»é‡Šæ”¾  pfool_raw_ptr-\u0026gt;Function(); } // è¾“å‡ºï¼š // Obj is 0000027943087B80, data = 1 // Obj is 0000027943087B80, data = -572662307 æ­£ç¡®ï¼Œé€šè¿‡æ™ºèƒ½æŒ‡é’ˆæ“ä½œ:\nvoid Safe() { fool_u_ptr = make_unique\u0026lt;Foo\u0026gt;(1); // è°ƒç”¨\u0026lt;Foo\u0026gt;(1)çš„å‡½æ•°  fool_u_ptr-\u0026gt;function(); fool_u_ptr = make_unique\u0026lt;Foo\u0026gt;(2); // è°ƒç”¨\u0026lt;Foo\u0026gt;(2)çš„å‡½æ•°  fool_u_ptr-\u0026gt;function(); } // è¾“å‡ºï¼š // Obj is 000002C7BB550830, data = 1 // Obj is 000002C7BB557AF0, data = 2 å…³è”æ¼æ´:\né«˜é£é™©-å†…å­˜ç ´å\n","date":"2021-10-28T22:00:08+08:00","image":"https://zcj-git520.github.io/p/c/c-%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/1_hub729bb727716490d1309dfd2d43fb84b_10267_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/c/c-%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/","title":"c/c++å®‰å…¨æŒ‡å—"},{"content":"æ–‡ç« æ¥æº é¹…å‚(è…¾è®¯)ä»£ç å®‰å…¨æŒ‡å—\né€šç”¨ å†…å­˜ç®¡ç† ã€å¿…é¡»ã€‘åˆ‡ç‰‡é•¿åº¦æ ¡éªŒ  åœ¨å¯¹sliceè¿›è¡Œæ“ä½œæ—¶ï¼Œå¿…é¡»åˆ¤æ–­é•¿åº¦æ˜¯å¦åˆæ³•ï¼Œé˜²æ­¢ç¨‹åºpanic  // bad: æœªåˆ¤æ–­dataçš„é•¿åº¦ï¼Œå¯å¯¼è‡´ index out of range func decode(data []byte) bool { if data[0] == 'F' \u0026amp;\u0026amp; data[1] == 'U' \u0026amp;\u0026amp; data[2] == 'Z' \u0026amp;\u0026amp; data[3] == 'Z' \u0026amp;\u0026amp; data[4] == 'E' \u0026amp;\u0026amp; data[5] == 'R' { fmt.Println(\u0026quot;Bad\u0026quot;) return true } return false } // bad: slice bounds out of range func foo() { var slice = []int{0, 1, 2, 3, 4, 5, 6} fmt.Println(slice[:10]) } // good: ä½¿ç”¨dataå‰åº”åˆ¤æ–­é•¿åº¦æ˜¯å¦åˆæ³• func decode(data []byte) bool { if len(data) == 6 { if data[0] == 'F' \u0026amp;\u0026amp; data[1] == 'U' \u0026amp;\u0026amp; data[2] == 'Z' \u0026amp;\u0026amp; data[3] == 'Z' \u0026amp;\u0026amp; data[4] == 'E' \u0026amp;\u0026amp; data[5] == 'R' { fmt.Println(\u0026quot;Good\u0026quot;) return true } } return false } ã€å¿…é¡»ã€‘nilæŒ‡é’ˆåˆ¤æ–­  è¿›è¡ŒæŒ‡é’ˆæ“ä½œæ—¶ï¼Œå¿…é¡»åˆ¤æ–­è¯¥æŒ‡é’ˆæ˜¯å¦ä¸ºnilï¼Œé˜²æ­¢ç¨‹åºpanicï¼Œå°¤å…¶åœ¨è¿›è¡Œç»“æ„ä½“Unmarshalæ—¶  type Packet struct { PackeyType uint8 PackeyVersion uint8 Data *Data } type Data struct { Stat uint8 Len uint8 Buf [8]byte } func (p *Packet) UnmarshalBinary(b []byte) error { if len(b) \u0026lt; 2 { return io.EOF } p.PackeyType = b[0] p.PackeyVersion = b[1] // è‹¥é•¿åº¦ç­‰äº2ï¼Œé‚£ä¹ˆä¸ä¼šnew Data if len(b) \u0026gt; 2 { p.Data = new(Data) } return nil } // bad: æœªåˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºnil func main() { packet := new(Packet) data := make([]byte, 2) if err := packet.UnmarshalBinary(data); err != nil { fmt.Println(\u0026quot;Failed to unmarshal packet\u0026quot;) return } fmt.Printf(\u0026quot;Stat: %v\\n\u0026quot;, packet.Data.Stat) } // good: åˆ¤æ–­DataæŒ‡é’ˆæ˜¯å¦ä¸ºnil func main() { packet := new(Packet) data := make([]byte, 2) if err := packet.UnmarshalBinary(data); err != nil { fmt.Println(\u0026quot;Failed to unmarshal packet\u0026quot;) return } if packet.Data == nil { return } fmt.Printf(\u0026quot;Stat: %v\\n\u0026quot;, packet.Data.Stat) } ã€å¿…é¡»ã€‘æ•´æ•°å®‰å…¨   åœ¨è¿›è¡Œæ•°å­—è¿ç®—æ“ä½œæ—¶ï¼Œéœ€è¦åšå¥½é•¿åº¦é™åˆ¶ï¼Œé˜²æ­¢å¤–éƒ¨è¾“å…¥è¿ç®—å¯¼è‡´å¼‚å¸¸ï¼š\n ç¡®ä¿æ— ç¬¦å·æ•´æ•°è¿ç®—æ—¶ä¸ä¼šåè½¬ ç¡®ä¿æœ‰ç¬¦å·æ•´æ•°è¿ç®—æ—¶ä¸ä¼šå‡ºç°æº¢å‡º ç¡®ä¿æ•´å‹è½¬æ¢æ—¶ä¸ä¼šå‡ºç°æˆªæ–­é”™è¯¯ ç¡®ä¿æ•´å‹è½¬æ¢æ—¶ä¸ä¼šå‡ºç°ç¬¦å·é”™è¯¯    ä»¥ä¸‹åœºæ™¯å¿…é¡»ä¸¥æ ¼è¿›è¡Œé•¿åº¦é™åˆ¶ï¼š\n ä½œä¸ºæ•°ç»„ç´¢å¼• ä½œä¸ºå¯¹è±¡çš„é•¿åº¦æˆ–è€…å¤§å° ä½œä¸ºæ•°ç»„çš„è¾¹ç•Œï¼ˆå¦‚ä½œä¸ºå¾ªç¯è®¡æ•°å™¨ï¼‰    // bad: æœªé™åˆ¶é•¿åº¦ï¼Œå¯¼è‡´æ•´æ•°æº¢å‡º func overflow(numControlByUser int32) { var numInt int32 = 0 numInt = numControlByUser + 1 // å¯¹é•¿åº¦é™åˆ¶ä¸å½“ï¼Œå¯¼è‡´æ•´æ•°æº¢å‡º fmt.Printf(\u0026quot;%d\\n\u0026quot;, numInt) // ä½¿ç”¨numIntï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–é”™è¯¯ } func main() { overflow(2147483647) } // good func overflow(numControlByUser int32) { var numInt int32 = 0 numInt = numControlByUser + 1 if numInt \u0026lt; 0 { fmt.Println(\u0026quot;integer overflow\u0026quot;) return } fmt.Println(\u0026quot;integer ok\u0026quot;) } func main() { overflow(2147483647) } ã€å¿…é¡»ã€‘makeåˆ†é…é•¿åº¦éªŒè¯  åœ¨è¿›è¡Œmakeåˆ†é…å†…å­˜æ—¶ï¼Œéœ€è¦å¯¹å¤–éƒ¨å¯æ§çš„é•¿åº¦è¿›è¡Œæ ¡éªŒï¼Œé˜²æ­¢ç¨‹åºpanicã€‚  // bad func parse(lenControlByUser int, data []byte) { size := lenControlByUser // å¯¹å¤–éƒ¨ä¼ å…¥çš„sizeï¼Œè¿›è¡Œé•¿åº¦åˆ¤æ–­ä»¥å…å¯¼è‡´panic buffer := make([]byte, size) copy(buffer, data) } // good func parse(lenControlByUser int, data []byte) ([]byte, error) { size := lenControlByUser // é™åˆ¶å¤–éƒ¨å¯æ§çš„é•¿åº¦å¤§å°èŒƒå›´ if size \u0026gt; 64*1024*1024 { return nil, errors.New(\u0026quot;value too large\u0026quot;) } buffer := make([]byte, size) copy(buffer, data) return buffer, nil } ã€å¿…é¡»ã€‘ç¦æ­¢SetFinalizerå’ŒæŒ‡é’ˆå¾ªç¯å¼•ç”¨åŒæ—¶ä½¿ç”¨  å½“ä¸€ä¸ªå¯¹è±¡ä»è¢«GCé€‰ä¸­åˆ°ç§»é™¤å†…å­˜ä¹‹å‰ï¼Œruntime.SetFinalizer()éƒ½ä¸ä¼šæ‰§è¡Œï¼Œå³ä½¿ç¨‹åºæ­£å¸¸ç»“æŸæˆ–è€…å‘ç”Ÿé”™è¯¯ã€‚ç”±æŒ‡é’ˆæ„æˆçš„â€œå¾ªç¯å¼•ç”¨â€è™½ç„¶èƒ½è¢«GCæ­£ç¡®å¤„ç†ï¼Œä½†ç”±äºæ— æ³•ç¡®å®šFinalizerä¾èµ–é¡ºåºï¼Œä»è€Œæ— æ³•è°ƒç”¨runtime.SetFinalizer()ï¼Œå¯¼è‡´ç›®æ ‡å¯¹è±¡æ— æ³•å˜æˆå¯è¾¾çŠ¶æ€ï¼Œä»è€Œé€ æˆå†…å­˜æ— æ³•è¢«å›æ”¶ã€‚  // bad func foo() { var a, b Data a.o = \u0026amp;b b.o = \u0026amp;a // æŒ‡é’ˆå¾ªç¯å¼•ç”¨ï¼ŒSetFinalizer()æ— æ³•æ­£å¸¸è°ƒç”¨ runtime.SetFinalizer(\u0026amp;a, func(d *Data) { fmt.Printf(\u0026quot;a %p final.\\n\u0026quot;, d) }) runtime.SetFinalizer(\u0026amp;b, func(d *Data) { fmt.Printf(\u0026quot;b %p final.\\n\u0026quot;, d) }) } func main() { for { foo() time.Sleep(time.Millisecond) } } ã€å¿…é¡»ã€‘ç¦æ­¢é‡å¤é‡Šæ”¾channel  é‡å¤é‡Šæ”¾ä¸€èˆ¬å­˜åœ¨äºå¼‚å¸¸æµç¨‹åˆ¤æ–­ä¸­ï¼Œå¦‚æœæ¶æ„æ”»å‡»è€…æ„é€ å‡ºå¼‚å¸¸æ¡ä»¶ä½¿ç¨‹åºé‡å¤é‡Šæ”¾channelï¼Œåˆ™ä¼šè§¦å‘è¿è¡Œæ—¶panicï¼Œä»è€Œé€ æˆDoSæ”»å‡»ã€‚  // bad func foo(c chan int) { defer close(c) err := processBusiness() if err != nil { c \u0026lt;- 0 close(c) // é‡å¤é‡Šæ”¾channel return } c \u0026lt;- 1 } // good func foo(c chan int) { defer close(c) // ä½¿ç”¨deferå»¶è¿Ÿå…³é—­channel err := processBusiness() if err != nil { c \u0026lt;- 0 return } c \u0026lt;- 1 } ã€å¿…é¡»ã€‘ç¡®ä¿æ¯ä¸ªåç¨‹éƒ½èƒ½é€€å‡º  å¯åŠ¨ä¸€ä¸ªåç¨‹å°±ä¼šåšä¸€ä¸ªå…¥æ ˆæ“ä½œï¼Œåœ¨ç³»ç»Ÿä¸é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œåç¨‹ä¹Ÿæ²¡æœ‰è®¾ç½®é€€å‡ºæ¡ä»¶ï¼Œåˆ™ç›¸å½“äºåç¨‹å¤±å»äº†æ§åˆ¶ï¼Œå®ƒå ç”¨çš„èµ„æºæ— æ³•å›æ”¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‚  // bad: åç¨‹æ²¡æœ‰è®¾ç½®é€€å‡ºæ¡ä»¶ func doWaiter(name string, second int) { for { time.Sleep(time.Duration(second) * time.Second) fmt.Println(name, \u0026quot; is ready!\u0026quot;) } } ã€æ¨èã€‘ä¸ä½¿ç”¨unsafeåŒ…  ç”±äºunsafeåŒ…ç»•è¿‡äº† Golang çš„å†…å­˜å®‰å…¨åŸåˆ™ï¼Œä¸€èˆ¬æ¥è¯´ä½¿ç”¨è¯¥åº“æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯å¯¼è‡´å†…å­˜ç ´åï¼Œå°½é‡é¿å…ä½¿ç”¨è¯¥åŒ…ã€‚è‹¥å¿…é¡»è¦ä½¿ç”¨unsafeæ“ä½œæŒ‡é’ˆï¼Œå¿…é¡»åšå¥½å®‰å…¨æ ¡éªŒã€‚  // bad: é€šè¿‡unsafeæ“ä½œåŸå§‹æŒ‡é’ˆ func unsafePointer() { b := make([]byte, 1) foo := (*int)(unsafe.Pointer(uintptr(unsafe.Pointer(\u0026amp;b[0])) + uintptr(0xfffffffe))) fmt.Print(*foo + 1) } // [signal SIGSEGV: segmentation violation code=0x1 addr=0xc100068f55 pc=0x49142b] ã€æ¨èã€‘ä¸ä½¿ç”¨sliceä½œä¸ºå‡½æ•°å…¥å‚  sliceæ˜¯å¼•ç”¨ç±»å‹ï¼Œåœ¨ä½œä¸ºå‡½æ•°å…¥å‚æ—¶é‡‡ç”¨çš„æ˜¯åœ°å€ä¼ é€’ï¼Œå¯¹sliceçš„ä¿®æ”¹ä¹Ÿä¼šå½±å“åŸå§‹æ•°æ®  // bad: sliceä½œä¸ºå‡½æ•°å…¥å‚æ—¶æ˜¯åœ°å€ä¼ é€’ func modify(array []int) { array[0] = 10 // å¯¹å…¥å‚sliceçš„å…ƒç´ ä¿®æ”¹ä¼šå½±å“åŸå§‹æ•°æ® } func main() { array := []int{1, 2, 3, 4, 5} modify(array) fmt.Println(array) // outputï¼š[10 2 3 4 5] } // good: å‡½æ•°ä½¿ç”¨æ•°ç»„ä½œä¸ºå…¥å‚ï¼Œè€Œä¸æ˜¯slice func modify(array [5]int) { array[0] = 10 } func main() { // ä¼ å…¥æ•°ç»„ï¼Œæ³¨æ„æ•°ç»„ä¸sliceçš„åŒºåˆ« array := [5]int{1, 2, 3, 4, 5} modify(array) fmt.Println(array) } æ–‡ä»¶æ“ä½œ ã€å¿…é¡»ã€‘ è·¯å¾„ç©¿è¶Šæ£€æŸ¥  åœ¨è¿›è¡Œæ–‡ä»¶æ“ä½œæ—¶ï¼Œå¦‚æœå¯¹å¤–éƒ¨ä¼ å…¥çš„æ–‡ä»¶åæœªåšé™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´ä»»æ„æ–‡ä»¶è¯»å–æˆ–è€…ä»»æ„æ–‡ä»¶å†™å…¥ï¼Œä¸¥é‡å¯èƒ½å¯¼è‡´ä»£ç æ‰§è¡Œã€‚  // bad: ä»»æ„æ–‡ä»¶è¯»å– func handler(w http.ResponseWriter, r *http.Request) { path := r.URL.Query()[\u0026quot;path\u0026quot;][0] // æœªè¿‡æ»¤æ–‡ä»¶è·¯å¾„ï¼Œå¯èƒ½å¯¼è‡´ä»»æ„æ–‡ä»¶è¯»å– data, _ := ioutil.ReadFile(path) w.Write(data) // å¯¹å¤–éƒ¨ä¼ å…¥çš„æ–‡ä»¶åå˜é‡ï¼Œè¿˜éœ€è¦éªŒè¯æ˜¯å¦å­˜åœ¨../ç­‰è·¯å¾„ç©¿è¶Šçš„æ–‡ä»¶å data, _ = ioutil.ReadFile(filepath.Join(\u0026quot;/home/user/\u0026quot;, path)) w.Write(data) } // bad: ä»»æ„æ–‡ä»¶å†™å…¥ func unzip(f string) { r, _ := zip.OpenReader(f) for _, f := range r.File { p, _ := filepath.Abs(f.Name) // æœªéªŒè¯å‹ç¼©æ–‡ä»¶åï¼Œå¯èƒ½å¯¼è‡´../ç­‰è·¯å¾„ç©¿è¶Šï¼Œä»»æ„æ–‡ä»¶è·¯å¾„å†™å…¥ ioutil.WriteFile(p, []byte(\u0026quot;present\u0026quot;), 0640) } } // good: æ£€æŸ¥å‹ç¼©çš„æ–‡ä»¶åæ˜¯å¦åŒ…å«..è·¯å¾„ç©¿è¶Šç‰¹å¾å­—ç¬¦ï¼Œé˜²æ­¢ä»»æ„å†™å…¥ func unzipGood(f string) bool { r, err := zip.OpenReader(f) if err != nil { fmt.Println(\u0026quot;read zip file fail\u0026quot;) return false } for _, f := range r.File { if !strings.Contains(f.Name, \u0026quot;..\u0026quot;) { p, _ := filepath.Abs(f.Name) ioutil.WriteFile(p, []byte(\u0026quot;present\u0026quot;), 0640) } else { return false } } return true } ã€å¿…é¡»ã€‘ æ–‡ä»¶è®¿é—®æƒé™  æ ¹æ®åˆ›å»ºæ–‡ä»¶çš„æ•æ„Ÿæ€§è®¾ç½®ä¸åŒçº§åˆ«çš„è®¿é—®æƒé™ï¼Œä»¥é˜²æ­¢æ•æ„Ÿæ•°æ®è¢«ä»»æ„æƒé™ç”¨æˆ·è¯»å–ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®æ–‡ä»¶æƒé™ä¸ºï¼š-rw-r-----  ioutil.WriteFile(p, []byte(\u0026quot;present\u0026quot;), 0640) ç³»ç»Ÿæ¥å£ 1.3.1ã€å¿…é¡»ã€‘å‘½ä»¤æ‰§è¡Œæ£€æŸ¥\n ä½¿ç”¨exec.Commandã€exec.CommandContextã€syscall.StartProcessã€os.StartProcessç­‰å‡½æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆpathï¼‰ç›´æ¥å–å¤–éƒ¨è¾“å…¥å€¼æ—¶ï¼Œåº”ä½¿ç”¨ç™½åå•é™å®šå¯æ‰§è¡Œçš„å‘½ä»¤èŒƒå›´ï¼Œä¸å…è®¸ä¼ å…¥bashã€cmdã€shç­‰å‘½ä»¤ï¼› ä½¿ç”¨exec.Commandã€exec.CommandContextç­‰å‡½æ•°æ—¶ï¼Œé€šè¿‡bashã€cmdã€shç­‰åˆ›å»ºshellï¼Œ-cåçš„å‚æ•°ï¼ˆargï¼‰æ‹¼æ¥å¤–éƒ¨è¾“å…¥ï¼Œåº”è¿‡æ»¤\\n $ \u0026amp; ; | ' \u0026quot; ( ) `ç­‰æ½œåœ¨æ¶æ„å­—ç¬¦ï¼›  // bad func foo() { userInputedVal := \u0026quot;\u0026amp;\u0026amp; echo 'hello'\u0026quot; // å‡è®¾å¤–éƒ¨ä¼ å…¥è¯¥å˜é‡å€¼ cmdName := \u0026quot;ping \u0026quot; + userInputedVal // æœªåˆ¤æ–­å¤–éƒ¨è¾“å…¥æ˜¯å¦å­˜åœ¨å‘½ä»¤æ³¨å…¥å­—ç¬¦ï¼Œç»“åˆshå¯é€ æˆå‘½ä»¤æ³¨å…¥ cmd := exec.Command(\u0026quot;sh\u0026quot;, \u0026quot;-c\u0026quot;, cmdName) output, _ := cmd.CombinedOutput() fmt.Println(string(output)) cmdName := \u0026quot;ls\u0026quot; // æœªåˆ¤æ–­å¤–éƒ¨è¾“å…¥æ˜¯å¦æ˜¯é¢„æœŸå‘½ä»¤ cmd := exec.Command(cmdName) output, _ := cmd.CombinedOutput() fmt.Println(string(output)) } // good func checkIllegal(cmdName string) bool { if strings.Contains(cmdName, \u0026quot;\u0026amp;\u0026quot;) || strings.Contains(cmdName, \u0026quot;|\u0026quot;) || strings.Contains(cmdName, \u0026quot;;\u0026quot;) || strings.Contains(cmdName, \u0026quot;$\u0026quot;) || strings.Contains(cmdName, \u0026quot;'\u0026quot;) || strings.Contains(cmdName, \u0026quot;`\u0026quot;) || strings.Contains(cmdName, \u0026quot;(\u0026quot;) || strings.Contains(cmdName, \u0026quot;)\u0026quot;) || strings.Contains(cmdName, \u0026quot;\\\u0026quot;\u0026quot;) { return true } return false } func main() { userInputedVal := \u0026quot;\u0026amp;\u0026amp; echo 'hello'\u0026quot; cmdName := \u0026quot;ping \u0026quot; + userInputedVal if checkIllegal(cmdName) { // æ£€æŸ¥ä¼ ç»™shçš„å‘½ä»¤æ˜¯å¦æœ‰ç‰¹æ®Šå­—ç¬¦ return // å­˜åœ¨ç‰¹æ®Šå­—ç¬¦ç›´æ¥return } cmd := exec.Command(\u0026quot;sh\u0026quot;, \u0026quot;-c\u0026quot;, cmdName) output, _ := cmd.CombinedOutput() fmt.Println(string(output)) } é€šä¿¡å®‰å…¨ ã€å¿…é¡»ã€‘ç½‘ç»œé€šä¿¡é‡‡ç”¨TLSæ–¹å¼  æ˜æ–‡ä¼ è¾“çš„é€šä¿¡åè®®ç›®å‰å·²è¢«éªŒè¯å­˜åœ¨è¾ƒå¤§å®‰å…¨é£é™©ï¼Œè¢«ä¸­é—´äººåŠ«æŒåå¯èƒ½å¯¼è‡´è®¸å¤šå®‰å…¨é£é™©ï¼Œå› æ­¤å¿…é¡»é‡‡ç”¨è‡³å°‘TLSçš„å®‰å…¨é€šä¿¡æ–¹å¼ä¿è¯é€šä¿¡å®‰å…¨ï¼Œä¾‹å¦‚gRPC/Websocketéƒ½ä½¿ç”¨TLS1.3ã€‚  // good func main() { http.HandleFunc(\u0026quot;/\u0026quot;, func(w http.ResponseWriter, req *http.Request) { w.Header().Add(\u0026quot;Strict-Transport-Security\u0026quot;, \u0026quot;max-age=63072000; includeSubDomains\u0026quot;) w.Write([]byte(\u0026quot;This is an example server.\\n\u0026quot;)) }) // æœåŠ¡å™¨é…ç½®è¯ä¹¦ä¸ç§é’¥ log.Fatal(http.ListenAndServeTLS(\u0026quot;:443\u0026quot;, \u0026quot;yourCert.pem\u0026quot;, \u0026quot;yourKey.pem\u0026quot;, nil)) } ã€æ¨èã€‘TLSå¯ç”¨è¯ä¹¦éªŒè¯  TLSè¯ä¹¦åº”å½“æ˜¯æœ‰æ•ˆçš„ã€æœªè¿‡æœŸçš„ï¼Œä¸”é…ç½®æ­£ç¡®çš„åŸŸåï¼Œç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡ç«¯åº”å¯ç”¨è¯ä¹¦éªŒè¯ã€‚  // bad import ( \u0026quot;crypto/tls\u0026quot; \u0026quot;net/http\u0026quot; ) func doAuthReq(authReq *http.Request) *http.Response { tr := \u0026amp;http.Transport{ TLSClientConfig: \u0026amp;tls.Config{InsecureSkipVerify: true}, } client := \u0026amp;http.Client{Transport: tr} res, _ := client.Do(authReq) return res } // good import ( \u0026quot;crypto/tls\u0026quot; \u0026quot;net/http\u0026quot; ) func doAuthReq(authReq *http.Request) *http.Response { tr := \u0026amp;http.Transport{ TLSClientConfig: \u0026amp;tls.Config{InsecureSkipVerify: false}, } client := \u0026amp;http.Client{Transport: tr} res, _ := client.Do(authReq) return res } æ•æ„Ÿæ•°æ®ä¿æŠ¤ ã€å¿…é¡»ã€‘æ•æ„Ÿä¿¡æ¯è®¿é—®  ç¦æ­¢å°†æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åœ¨ç¨‹åºä¸­ï¼Œæ—¢å¯èƒ½ä¼šå°†æ•æ„Ÿä¿¡æ¯æš´éœ²ç»™æ”»å‡»è€…ï¼Œä¹Ÿä¼šå¢åŠ ä»£ç ç®¡ç†å’Œç»´æŠ¤çš„éš¾åº¦ ä½¿ç”¨é…ç½®ä¸­å¿ƒç³»ç»Ÿç»Ÿä¸€æ‰˜ç®¡å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯  ã€å¿…é¡»ã€‘æ•æ„Ÿæ•°æ®è¾“å‡º  åªè¾“å‡ºå¿…è¦çš„æœ€å°æ•°æ®é›†ï¼Œé¿å…å¤šä½™å­—æ®µæš´éœ²å¼•èµ·æ•æ„Ÿä¿¡æ¯æ³„éœ² ä¸èƒ½åœ¨æ—¥å¿—ä¿å­˜å¯†ç ï¼ˆåŒ…æ‹¬æ˜æ–‡å¯†ç å’Œå¯†æ–‡å¯†ç ï¼‰ã€å¯†é’¥å’Œå…¶å®ƒæ•æ„Ÿä¿¡æ¯ å¯¹äºå¿…é¡»è¾“å‡ºçš„æ•æ„Ÿä¿¡æ¯ï¼Œå¿…é¡»è¿›è¡Œåˆç†è„±æ•å±•ç¤º  // bad func serve() { http.HandleFunc(\u0026quot;/register\u0026quot;, func(w http.ResponseWriter, r *http.Request) { r.ParseForm() user := r.Form.Get(\u0026quot;user\u0026quot;) pw := r.Form.Get(\u0026quot;password\u0026quot;) log.Printf(\u0026quot;Registering new user %s with password %s.\\n\u0026quot;, user, pw) }) http.ListenAndServe(\u0026quot;:80\u0026quot;, nil) } // good func serve1() { http.HandleFunc(\u0026quot;/register\u0026quot;, func(w http.ResponseWriter, r *http.Request) { r.ParseForm() user := r.Form.Get(\u0026quot;user\u0026quot;) pw := r.Form.Get(\u0026quot;password\u0026quot;) log.Printf(\u0026quot;Registering new user %s.\\n\u0026quot;, user) // ... use(pw) }) http.ListenAndServe(\u0026quot;:80\u0026quot;, nil) }  é¿å…é€šè¿‡GETæ–¹æ³•ã€ä»£ç æ³¨é‡Šã€è‡ªåŠ¨å¡«å……ã€ç¼“å­˜ç­‰æ–¹å¼æ³„éœ²æ•æ„Ÿä¿¡æ¯  ã€å¿…é¡»ã€‘æ•æ„Ÿæ•°æ®å­˜å‚¨  æ•æ„Ÿæ•°æ®åº”ä½¿ç”¨SHA2ã€RSAç­‰ç®—æ³•è¿›è¡ŒåŠ å¯†å­˜å‚¨ æ•æ„Ÿæ•°æ®åº”ä½¿ç”¨ç‹¬ç«‹çš„å­˜å‚¨å±‚ï¼Œå¹¶åœ¨è®¿é—®å±‚å¼€å¯è®¿é—®æ§åˆ¶ åŒ…å«æ•æ„Ÿä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶æˆ–ç¼“å­˜ä¸€æ—¦ä¸å†éœ€è¦åº”ç«‹åˆ»åˆ é™¤  ã€å¿…é¡»ã€‘å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•  åº”åˆç†ä½¿ç”¨panicã€recoverã€deferå¤„ç†ç³»ç»Ÿå¼‚å¸¸ï¼Œé¿å…å‡ºé”™ä¿¡æ¯è¾“å‡ºåˆ°å‰ç«¯  defer func () { if r := recover(); r != nil { fmt.Println(\u0026quot;Recovered in start()\u0026quot;) } }()  å¯¹å¤–ç¯å¢ƒç¦æ­¢å¼€å¯debugæ¨¡å¼ï¼Œæˆ–å°†ç¨‹åºè¿è¡Œæ—¥å¿—è¾“å‡ºåˆ°å‰ç«¯  // bad dlv --listen=:2345 --headless=true --api-version=2 debug test.go // good dlv debug test.go åŠ å¯†è§£å¯† ã€å¿…é¡»ã€‘ä¸å¾—ç¡¬ç¼–ç å¯†ç /å¯†é’¥  åœ¨è¿›è¡Œç”¨æˆ·ç™»é™†ï¼ŒåŠ è§£å¯†ç®—æ³•ç­‰æ“ä½œæ—¶ï¼Œä¸å¾—åœ¨ä»£ç é‡Œç¡¬ç¼–ç å¯†é’¥æˆ–å¯†ç ï¼Œå¯é€šè¿‡å˜æ¢ç®—æ³•æˆ–è€…é…ç½®ç­‰æ–¹å¼è®¾ç½®å¯†ç æˆ–è€…å¯†é’¥ã€‚  // bad const ( user = \u0026quot;dbuser\u0026quot; password = \u0026quot;s3cretp4ssword\u0026quot; ) func connect() *sql.DB { connStr := fmt.Sprintf(\u0026quot;postgres://%s:%s@localhost/pqgotest\u0026quot;, user, password) db, err := sql.Open(\u0026quot;postgres\u0026quot;, connStr) if err != nil { return nil } return db } // bad var ( commonkey = []byte(\u0026quot;0123456789abcdef\u0026quot;) ) func AesEncrypt(plaintext string) (string, error) { block, err := aes.NewCipher(commonkey) if err != nil { return \u0026quot;\u0026quot;, err } } 1.6.2ã€å¿…é¡»ã€‘å¯†é’¥å­˜å‚¨å®‰å…¨  åœ¨ä½¿ç”¨å¯¹ç§°å¯†ç ç®—æ³•æ—¶ï¼Œéœ€è¦ä¿æŠ¤å¥½åŠ å¯†å¯†é’¥ã€‚å½“ç®—æ³•æ¶‰åŠæ•æ„Ÿã€ä¸šåŠ¡æ•°æ®æ—¶ï¼Œå¯é€šè¿‡éå¯¹ç§°ç®—æ³•åå•†åŠ å¯†å¯†é’¥ã€‚å…¶ä»–è¾ƒä¸ºä¸æ•æ„Ÿçš„æ•°æ®åŠ å¯†ï¼Œå¯ä»¥é€šè¿‡å˜æ¢ç®—æ³•ç­‰æ–¹å¼ä¿æŠ¤å¯†é’¥ã€‚  1.6.3ã€æ¨èã€‘ä¸ä½¿ç”¨å¼±å¯†ç ç®—æ³•  åœ¨ä½¿ç”¨åŠ å¯†ç®—æ³•æ—¶ï¼Œä¸å»ºè®®ä½¿ç”¨åŠ å¯†å¼ºåº¦è¾ƒå¼±çš„ç®—æ³•ã€‚  // bad crypto/desï¼Œcrypto/md5ï¼Œcrypto/sha1ï¼Œcrypto/rc4ç­‰ã€‚ // good crypto/rsaï¼Œcrypto/aesç­‰ã€‚ æ­£åˆ™è¡¨è¾¾å¼ ã€æ¨èã€‘ä½¿ç”¨regexpè¿›è¡Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…  æ­£åˆ™è¡¨è¾¾å¼ç¼–å†™ä¸æ°å½“å¯è¢«ç”¨äºDoSæ”»å‡»ï¼Œé€ æˆæœåŠ¡ä¸å¯ç”¨ï¼Œæ¨èä½¿ç”¨regexpåŒ…è¿›è¡Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚regexpä¿è¯äº†çº¿æ€§æ—¶é—´æ€§èƒ½å’Œä¼˜é›…çš„å¤±è´¥ï¼šå¯¹è§£æå™¨ã€ç¼–è¯‘å™¨å’Œæ‰§è¡Œå¼•æ“éƒ½è¿›è¡Œäº†å†…å­˜é™åˆ¶ã€‚ä½†regexpä¸æ”¯æŒä»¥ä¸‹æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ€§ï¼Œå¦‚ä¸šåŠ¡ä¾èµ–è¿™äº›ç‰¹æ€§ï¼Œåˆ™regexpä¸é€‚åˆä½¿ç”¨ã€‚  å›æº¯å¼•ç”¨Backreferences æŸ¥çœ‹Lookaround    // good matched, err := regexp.MatchString(`a.b`, \u0026quot;aaxbb\u0026quot;) fmt.Println(matched) // true fmt.Println(err) // nil åå° è¾“å…¥æ ¡éªŒ ã€å¿…é¡»ã€‘æŒ‰ç±»å‹è¿›è¡Œæ•°æ®æ ¡éªŒ  æ‰€æœ‰å¤–éƒ¨è¾“å…¥çš„å‚æ•°ï¼Œåº”ä½¿ç”¨validatorè¿›è¡Œç™½åå•æ ¡éªŒï¼Œæ ¡éªŒå†…å®¹åŒ…æ‹¬ä½†ä¸é™äºæ•°æ®é•¿åº¦ã€æ•°æ®èŒƒå›´ã€æ•°æ®ç±»å‹ä¸æ ¼å¼ï¼Œæ ¡éªŒä¸é€šè¿‡çš„åº”å½“æ‹’ç»  // good import ( \u0026quot;fmt\u0026quot; \u0026quot;github.com/go-playground/validator/v10\u0026quot; ) var validate *validator.Validate func validateVariable() { myEmail := \u0026quot;abc@tencent.com\u0026quot; errs := validate.Var(myEmail, \u0026quot;required,email\u0026quot;) if errs != nil { fmt.Println(errs) return //åœæ­¢æ‰§è¡Œ } // éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œ ... } func main() { validate = validator.New() validateVariable() }  æ— æ³•é€šè¿‡ç™½åå•æ ¡éªŒçš„åº”ä½¿ç”¨html.EscapeStringã€text/templateæˆ–bluemondayå¯¹\u0026lt;, \u0026gt;, \u0026amp;, ',\u0026quot;ç­‰å­—ç¬¦è¿›è¡Œè¿‡æ»¤æˆ–ç¼–ç   import ( \u0026quot;text/template\u0026quot; ) // TestHTMLEscapeString HTMLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ func main(inputValue string) string { escapedResult := template.HTMLEscapeString(inputValue) return escapedResult } SQLæ“ä½œ ã€å¿…é¡»ã€‘SQLè¯­å¥é»˜è®¤ä½¿ç”¨é¢„ç¼–è¯‘å¹¶ç»‘å®šå˜é‡  ä½¿ç”¨database/sqlçš„prepareã€Queryæˆ–ä½¿ç”¨GORMç­‰ORMæ‰§è¡ŒSQLæ“ä½œ  import ( \u0026quot;github.com/jinzhu/gorm\u0026quot; _ \u0026quot;github.com/jinzhu/gorm/dialects/sqlite\u0026quot; ) type Product struct { gorm.Model Code string Price uint } ... var product Product ... db.First(\u0026amp;product, 1)  ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œç¦æ­¢æ‹¼æ¥SQLè¯­å¥ï¼Œå¦å¤–å¯¹äºä¼ å…¥å‚æ•°ç”¨äºorder byæˆ–è¡¨åçš„éœ€è¦é€šè¿‡æ ¡éªŒ  // bad import ( \u0026quot;database/sql\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;net/http\u0026quot; ) func handler(db *sql.DB, req *http.Request) { q := fmt.Sprintf(\u0026quot;SELECT ITEM,PRICE FROM PRODUCT WHERE ITEM_CATEGORY='%s' ORDER BY PRICE\u0026quot;, req.URL.Query()[\u0026quot;category\u0026quot;]) db.Query(q) } // good func handlerGood(db *sql.DB, req *http.Request) { // ä½¿ç”¨?å ä½ç¬¦ q := \u0026quot;SELECT ITEM,PRICE FROM PRODUCT WHERE ITEM_CATEGORY='?' ORDER BY PRICE\u0026quot; db.Query(q, req.URL.Query()[\u0026quot;category\u0026quot;]) } ç½‘ç»œè¯·æ±‚ ã€å¿…é¡»ã€‘èµ„æºè¯·æ±‚è¿‡æ»¤éªŒè¯   ä½¿ç”¨\u0026quot;net/http\u0026quot;ä¸‹çš„æ–¹æ³•http.Get(url)ã€http.Post(url, contentType, body)ã€http.Head(url)ã€http.PostForm(url, data)ã€http.Do(req)æ—¶ï¼Œå¦‚å˜é‡å€¼å¤–éƒ¨å¯æ§ï¼ˆæŒ‡ä»å‚æ•°ä¸­åŠ¨æ€è·å–ï¼‰ï¼Œåº”å¯¹è¯·æ±‚ç›®æ ‡è¿›è¡Œä¸¥æ ¼çš„å®‰å…¨æ ¡éªŒã€‚\n  å¦‚è¯·æ±‚èµ„æºåŸŸåå½’å±å›ºå®šçš„èŒƒå›´ï¼Œå¦‚åªå…è®¸a.qq.comå’Œb.qq.comï¼Œåº”åšç™½åå•é™åˆ¶ã€‚å¦‚ä¸é€‚ç”¨ç™½åå•ï¼Œåˆ™æ¨èçš„æ ¡éªŒé€»è¾‘æ­¥éª¤æ˜¯ï¼š\n  ç¬¬ 1 æ­¥ã€åªå…è®¸HTTPæˆ–HTTPSåè®®\n  ç¬¬ 2 æ­¥ã€è§£æç›®æ ‡URLï¼Œè·å–å…¶HOST\n  ç¬¬ 3 æ­¥ã€è§£æHOSTï¼Œè·å–HOSTæŒ‡å‘çš„IPåœ°å€è½¬æ¢æˆLongå‹\n  ç¬¬ 4 æ­¥ã€æ£€æŸ¥IPåœ°å€æ˜¯å¦ä¸ºå†…ç½‘IPï¼Œç½‘æ®µæœ‰ï¼š\n// ä»¥RFCå®šä¹‰çš„ä¸“æœ‰ç½‘ç»œä¸ºä¾‹ï¼Œå¦‚æœ‰è‡ªå®šä¹‰ç§æœ‰ç½‘æ®µäº¦åº”åŠ å…¥ç¦æ­¢è®¿é—®åˆ—è¡¨ã€‚ 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8   ç¬¬ 5 æ­¥ã€è¯·æ±‚URL\n  ç¬¬ 6 æ­¥ã€å¦‚æœ‰è·³è½¬ï¼Œè·³è½¬åæ‰§è¡Œ1ï¼Œå¦åˆ™ç»‘å®šç»æ ¡éªŒçš„ipå’ŒåŸŸåï¼Œå¯¹URLå‘èµ·è¯·æ±‚\n    å®˜æ–¹åº“encoding/xmlä¸æ”¯æŒå¤–éƒ¨å®ä½“å¼•ç”¨ï¼Œä½¿ç”¨è¯¥åº“å¯é¿å…xxeæ¼æ´\n  import ( \u0026quot;encoding/xml\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;os\u0026quot; ) func main() { type Person struct { XMLName xml.Name `xml:\u0026quot;person\u0026quot;` Id int `xml:\u0026quot;id,attr\u0026quot;` UserName string `xml:\u0026quot;name\u0026gt;first\u0026quot;` Comment string `xml:\u0026quot;,comment\u0026quot;` } v := \u0026amp;Person{Id: 13, UserName: \u0026quot;John\u0026quot;} v.Comment = \u0026quot; Need more details. \u0026quot; enc := xml.NewEncoder(os.Stdout) enc.Indent(\u0026quot; \u0026quot;, \u0026quot; \u0026quot;) if err := enc.Encode(v); err != nil { fmt.Printf(\u0026quot;error: %v\\n\u0026quot;, err) } } æœåŠ¡å™¨ç«¯æ¸²æŸ“ ã€å¿…é¡»ã€‘æ¨¡æ¿æ¸²æŸ“è¿‡æ»¤éªŒè¯  ä½¿ç”¨text/templateæˆ–è€…html/templateæ¸²æŸ“æ¨¡æ¿æ—¶ç¦æ­¢å°†å¤–éƒ¨è¾“å…¥å‚æ•°å¼•å…¥æ¨¡æ¿ï¼Œæˆ–ä»…å…è®¸å¼•å…¥ç™½åå•å†…å­—ç¬¦ã€‚  // bad func handler(w http.ResponseWriter, r *http.Request) { r.ParseForm() x := r.Form.Get(\u0026quot;name\u0026quot;) var tmpl = `\u0026lt;!DOCTYPE html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt; \u0026lt;form action=\u0026quot;/\u0026quot; method=\u0026quot;post\u0026quot;\u0026gt; First name:\u0026lt;br\u0026gt; \u0026lt;input type=\u0026quot;text\u0026quot; name=\u0026quot;name\u0026quot; value=\u0026quot;\u0026quot;\u0026gt; \u0026lt;input type=\u0026quot;submit\u0026quot; value=\u0026quot;Submit\u0026quot;\u0026gt; \u0026lt;/form\u0026gt;\u0026lt;p\u0026gt;` + x + ` \u0026lt;/p\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;` t := template.New(\u0026quot;main\u0026quot;) t, _ = t.Parse(tmpl) t.Execute(w, \u0026quot;Hello\u0026quot;) } // good import ( \u0026quot;fmt\u0026quot; \u0026quot;github.com/go-playground/validator/v10\u0026quot; ) var validate *validator.Validate validate = validator.New() func validateVariable(val) { errs := validate.Var(val, \u0026quot;gte=1,lte=100\u0026quot;) // é™åˆ¶å¿…é¡»æ˜¯1-100çš„æ­£æ•´æ•° if errs != nil { fmt.Println(errs) return false } return true } func handler(w http.ResponseWriter, r *http.Request) { r.ParseForm() x := r.Form.Get(\u0026quot;name\u0026quot;) if validateVariable(x) { var tmpl = `\u0026lt;!DOCTYPE html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt; \u0026lt;form action=\u0026quot;/\u0026quot; method=\u0026quot;post\u0026quot;\u0026gt; First name:\u0026lt;br\u0026gt; \u0026lt;input type=\u0026quot;text\u0026quot; name=\u0026quot;name\u0026quot; value=\u0026quot;\u0026quot;\u0026gt; \u0026lt;input type=\u0026quot;submit\u0026quot; value=\u0026quot;Submit\u0026quot;\u0026gt; \u0026lt;/form\u0026gt;\u0026lt;p\u0026gt;` + x + ` \u0026lt;/p\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;` t := template.New(\u0026quot;main\u0026quot;) t, _ = t.Parse(tmpl) t.Execute(w, \u0026quot;Hello\u0026quot;) } else { // ... } } Webè·¨åŸŸ ã€å¿…é¡»ã€‘è·¨åŸŸèµ„æºå…±äº«CORSé™åˆ¶è¯·æ±‚æ¥æº  CORSè¯·æ±‚ä¿æŠ¤ä¸å½“å¯å¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„æ¼ï¼Œå› æ­¤åº”å½“ä¸¥æ ¼è®¾ç½®Access-Control-Allow-Originä½¿ç”¨åŒæºç­–ç•¥è¿›è¡Œä¿æŠ¤ã€‚  // good c := cors.New(cors.Options{ AllowedOrigins: []string{\u0026quot;http://qq.com\u0026quot;, \u0026quot;https://qq.com\u0026quot;}, AllowCredentials: true, Debug: false, }) // å¼•å…¥ä¸­é—´ä»¶ handler = c.Handler(handler) å“åº”è¾“å‡º ã€å¿…é¡»ã€‘è®¾ç½®æ­£ç¡®çš„HTTPå“åº”åŒ…ç±»å‹  å“åº”å¤´Content-Typeä¸å®é™…å“åº”å†…å®¹ï¼Œåº”ä¿æŒä¸€è‡´ã€‚å¦‚ï¼šAPIå“åº”æ•°æ®ç±»å‹æ˜¯jsonï¼Œåˆ™å“åº”å¤´ä½¿ç”¨application/jsonï¼›è‹¥ä¸ºxmlï¼Œåˆ™è®¾ç½®ä¸ºtext/xmlã€‚  ã€å¿…é¡»ã€‘æ·»åŠ å®‰å…¨å“åº”å¤´  æ‰€æœ‰æ¥å£ã€é¡µé¢ï¼Œæ·»åŠ å“åº”å¤´ X-Content-Type-Options: nosniffã€‚ æ‰€æœ‰æ¥å£ã€é¡µé¢ï¼Œæ·»åŠ å“åº”å¤´X-Frame-Options ã€‚æŒ‰éœ€åˆç†è®¾ç½®å…¶å…è®¸èŒƒå›´ï¼ŒåŒ…æ‹¬ï¼šDENYã€SAMEORIGINã€ALLOW-FROM originã€‚ç”¨æ³•å‚è€ƒï¼šMDNæ–‡æ¡£  ã€å¿…é¡»ã€‘å¤–éƒ¨è¾“å…¥æ‹¼æ¥åˆ°HTTPå“åº”å¤´ä¸­éœ€è¿›è¡Œè¿‡æ»¤  åº”å°½é‡é¿å…å¤–éƒ¨å¯æ§å‚æ•°æ‹¼æ¥åˆ°HTTPå“åº”å¤´ä¸­ï¼Œå¦‚ä¸šåŠ¡éœ€è¦åˆ™éœ€è¦è¿‡æ»¤æ‰\\rã€\\nç­‰æ¢è¡Œç¬¦ï¼Œæˆ–è€…æ‹’ç»æºå¸¦æ¢è¡Œç¬¦å·çš„å¤–éƒ¨è¾“å…¥ã€‚  ã€å¿…é¡»ã€‘å¤–éƒ¨è¾“å…¥æ‹¼æ¥åˆ°responseé¡µé¢å‰è¿›è¡Œç¼–ç å¤„ç†  ç›´å‡ºhtmlé¡µé¢æˆ–ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆhtmlé¡µé¢çš„ï¼Œæ¨èä½¿ç”¨text/templateè‡ªåŠ¨ç¼–ç ï¼Œæˆ–è€…ä½¿ç”¨html.EscapeStringæˆ–text/templateå¯¹\u0026lt;, \u0026gt;, \u0026amp;, ',\u0026quot;ç­‰å­—ç¬¦è¿›è¡Œç¼–ç ã€‚  import ( \u0026quot;html/template\u0026quot; ) func outtemplate(w http.ResponseWriter, r *http.Request) { param1 := r.URL.Query().Get(\u0026quot;param1\u0026quot;) tmpl := template.New(\u0026quot;hello\u0026quot;) tmpl, _ = tmpl.Parse(`{{define \u0026quot;T\u0026quot;}}{{.}}{{end}}`) tmpl.ExecuteTemplate(w, \u0026quot;T\u0026quot;, param1) } ä¼šè¯ç®¡ç† ã€å¿…é¡»ã€‘å®‰å…¨ç»´æŠ¤sessionä¿¡æ¯  ç”¨æˆ·ç™»å½•æ—¶åº”é‡æ–°ç”Ÿæˆsessionï¼Œé€€å‡ºç™»å½•ååº”æ¸…ç†sessionã€‚  import ( \u0026quot;github.com/gorilla/handlers\u0026quot; \u0026quot;github.com/gorilla/mux\u0026quot; \u0026quot;net/http\u0026quot; ) // åˆ›å»ºcookie func setToken(res http.ResponseWriter, req *http.Request) { expireToken := time.Now().Add(time.Minute * 30).Unix() expireCookie := time.Now().Add(time.Minute * 30) //... cookie := http.Cookie{ Name: \u0026quot;Auth\u0026quot;, Value: signedToken, Expires: expireCookie, // è¿‡æœŸå¤±æ•ˆ HttpOnly: true, Path: \u0026quot;/\u0026quot;, Domain: \u0026quot;127.0.0.1\u0026quot;, Secure: true, } http.SetCookie(res, \u0026amp;cookie) http.Redirect(res, req, \u0026quot;/profile\u0026quot;, 307) } // åˆ é™¤cookie func logout(res http.ResponseWriter, req *http.Request) { deleteCookie := http.Cookie{ Name: \u0026quot;Auth\u0026quot;, Value: \u0026quot;none\u0026quot;, Expires: time.Now(), } http.SetCookie(res, \u0026amp;deleteCookie) return } ã€å¿…é¡»ã€‘CSRFé˜²æŠ¤  æ¶‰åŠç³»ç»Ÿæ•æ„Ÿæ“ä½œæˆ–å¯è¯»å–æ•æ„Ÿä¿¡æ¯çš„æ¥å£åº”æ ¡éªŒRefereræˆ–æ·»åŠ csrf_tokenã€‚  // good import ( \u0026quot;github.com/gorilla/csrf\u0026quot; \u0026quot;github.com/gorilla/mux\u0026quot; \u0026quot;net/http\u0026quot; ) func main() { r := mux.NewRouter() r.HandleFunc(\u0026quot;/signup\u0026quot;, ShowSignupForm) r.HandleFunc(\u0026quot;/signup/post\u0026quot;, SubmitSignupForm) // ä½¿ç”¨csrf_tokenéªŒè¯ http.ListenAndServe(\u0026quot;:8000\u0026quot;, csrf.Protect([]byte(\u0026quot;32-byte-long-auth-key\u0026quot;))(r)) } è®¿é—®æ§åˆ¶ ã€å¿…é¡»ã€‘é»˜è®¤é‰´æƒ   é™¤éèµ„æºå®Œå…¨å¯å¯¹å¤–å¼€æ”¾ï¼Œå¦åˆ™ç³»ç»Ÿé»˜è®¤è¿›è¡Œèº«ä»½è®¤è¯ï¼Œä½¿ç”¨ç™½åå•çš„æ–¹å¼æ”¾å¼€ä¸éœ€è¦è®¤è¯çš„æ¥å£æˆ–é¡µé¢ã€‚\n  æ ¹æ®èµ„æºçš„æœºå¯†ç¨‹åº¦å’Œç”¨æˆ·è§’è‰²ï¼Œä»¥æœ€å°æƒé™åŸåˆ™ï¼Œè®¾ç½®ä¸åŒçº§åˆ«çš„æƒé™ï¼Œå¦‚å®Œå…¨å…¬å¼€ã€ç™»å½•å¯è¯»ã€ç™»å½•å¯å†™ã€ç‰¹å®šç”¨æˆ·å¯è¯»ã€ç‰¹å®šç”¨æˆ·å¯å†™ç­‰\n  æ¶‰åŠç”¨æˆ·è‡ªèº«ç›¸å…³çš„æ•°æ®çš„è¯»å†™å¿…é¡»éªŒè¯ç™»å½•æ€ç”¨æˆ·èº«ä»½åŠå…¶æƒé™ï¼Œé¿å…è¶Šæƒæ“ä½œ\n-- ä¼ªä»£ç  selectidfromtablewhereid=:idanduserid=session.userid  æ²¡æœ‰ç‹¬ç«‹è´¦å·ä½“ç³»çš„å¤–ç½‘æœåŠ¡ä½¿ç”¨QQæˆ–å¾®ä¿¡ç™»å½•ï¼Œå†…ç½‘æœåŠ¡ä½¿ç”¨ç»Ÿä¸€ç™»å½•æœåŠ¡ç™»å½•ï¼Œå…¶ä»–ä½¿ç”¨è´¦å·å¯†ç ç™»å½•çš„æœåŠ¡éœ€è¦å¢åŠ éªŒè¯ç ç­‰äºŒæ¬¡éªŒè¯\n  1.9 å¹¶å‘ä¿æŠ¤ 1.9.1ã€å¿…é¡»ã€‘ç¦æ­¢åœ¨é—­åŒ…ä¸­ç›´æ¥è°ƒç”¨å¾ªç¯å˜é‡  åœ¨å¾ªç¯ä¸­å¯åŠ¨åç¨‹ï¼Œå½“åç¨‹ä¸­ä½¿ç”¨åˆ°äº†å¾ªç¯çš„ç´¢å¼•å€¼ï¼Œç”±äºå¤šä¸ªåç¨‹åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªå˜é‡ä¼šäº§ç”Ÿæ•°æ®ç«äº‰ï¼Œé€ æˆæ‰§è¡Œç»“æœå¼‚å¸¸ã€‚  // bad func main() { runtime.GOMAXPROCS(runtime.NumCPU()) var group sync.WaitGroup for i := 0; i \u0026lt; 5; i++ { group.Add(1) go func() { defer group.Done() fmt.Printf(\u0026quot;%-2d\u0026quot;, i) // è¿™é‡Œæ‰“å°çš„iä¸æ˜¯æ‰€æœŸæœ›çš„ }() } group.Wait() } // good func main() { runtime.GOMAXPROCS(runtime.NumCPU()) var group sync.WaitGroup for i := 0; i \u0026lt; 5; i++ { group.Add(1) go func(j int) { defer func() { if r := recover(); r != nil { fmt.Println(\u0026quot;Recovered in start()\u0026quot;) } group.Done() }() fmt.Printf(\u0026quot;%-2d\u0026quot;, j) // é—­åŒ…å†…éƒ¨ä½¿ç”¨å±€éƒ¨å˜é‡ }(i) // æŠŠå¾ªç¯å˜é‡æ˜¾å¼åœ°ä¼ ç»™åç¨‹ } group.Wait() } ã€å¿…é¡»ã€‘ç¦æ­¢å¹¶å‘å†™map  å¹¶å‘å†™mapå®¹æ˜“é€ æˆç¨‹åºå´©æºƒå¹¶å¼‚å¸¸é€€å‡ºï¼Œå»ºè®®åŠ é”ä¿æŠ¤  // bad func main() { m := make(map[int]int) // å¹¶å‘è¯»å†™ go func() { for { _ = m[1] } }() go func() { for { m[2] = 1 } }() select {} } ã€å¿…é¡»ã€‘ç¡®ä¿å¹¶å‘å®‰å…¨ æ•æ„Ÿæ“ä½œå¦‚æœæœªä½œå¹¶å‘å®‰å…¨é™åˆ¶ï¼Œå¯å¯¼è‡´æ•°æ®è¯»å†™å¼‚å¸¸ï¼Œé€ æˆä¸šåŠ¡é€»è¾‘é™åˆ¶è¢«ç»•è¿‡ã€‚å¯é€šè¿‡åŒæ­¥é”æˆ–è€…åŸå­æ“ä½œè¿›è¡Œé˜²æŠ¤ã€‚\né€šè¿‡åŒæ­¥é”å…±äº«å†…å­˜\n// good var count int func Count(lock *sync.Mutex) { lock.Lock() // åŠ å†™é” count++ fmt.Println(count) lock.Unlock() // è§£å†™é”ï¼Œä»»ä½•ä¸€ä¸ªLock()æˆ–RLock()å‡éœ€è¦ä¿è¯å¯¹åº”æœ‰Unlock()æˆ–RUnlock() } func main() { lock := \u0026amp;sync.Mutex{} for i := 0; i \u0026lt; 10; i++ { go Count(lock) // ä¼ é€’æŒ‡é’ˆæ˜¯ä¸ºäº†é˜²æ­¢å‡½æ•°å†…çš„é”å’Œè°ƒç”¨é”ä¸ä¸€è‡´ } for { lock.Lock() c := count lock.Unlock() runtime.Gosched() // äº¤å‡ºæ—¶é—´ç‰‡ç»™åç¨‹ if c \u0026gt; 10 { break } } }  ä½¿ç”¨sync/atomicæ‰§è¡ŒåŸå­æ“ä½œ  // good import ( \u0026quot;sync\u0026quot; \u0026quot;sync/atomic\u0026quot; ) func main() { type Map map[string]string var m atomic.Value m.Store(make(Map)) var mu sync.Mutex // used only by writers read := func(key string) (val string) { m1 := m.Load().(Map) return m1[key] } insert := func(key, val string) { mu.Lock() // ä¸æ½œåœ¨å†™å…¥åŒæ­¥ defer mu.Unlock() m1 := m.Load().(Map) // å¯¼å…¥structå½“å‰æ•°æ® m2 := make(Map) // åˆ›å»ºæ–°å€¼ for k, v := range m1 { m2[k] = v } m2[key] = val m.Store(m2) // ç”¨æ–°çš„æ›¿ä»£å½“å‰å¯¹è±¡ } _, _ = read, insert } ","date":"2021-10-24T22:00:08+08:00","image":"https://zcj-git520.github.io/p/go%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/1_hu7c5d570e6f1bb8cc35e9c2f13acb3eec_11753_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/go%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/","title":"Goå®‰å…¨æŒ‡å—"},{"content":"uber-go/guide çš„ä¸­æ–‡ç¿»è¯‘ English Uber go è¯­è¨€ç¼–ç è§„èŒƒ Uber æ˜¯ä¸€å®¶ç¾å›½ç¡…è°·çš„ç§‘æŠ€å…¬å¸ï¼Œä¹Ÿæ˜¯ go è¯­è¨€çš„æ—©æœŸ adopterã€‚å…¶å¼€æºäº†å¾ˆå¤š golang é¡¹ç›®ï¼Œè¯¸å¦‚è¢« gopher åœˆç†ŸçŸ¥çš„ zapã€jaeger ç­‰ã€‚2018 å¹´å¹´æœ« Uber å°†å†…éƒ¨çš„ go é£æ ¼è§„èŒƒ å¼€æºåˆ° GitHubï¼Œç»è¿‡ä¸€å¹´çš„ç§¯ç´¯å’Œæ›´æ–°ï¼Œè¯¥è§„èŒƒå·²ç»åˆå…·è§„æ¨¡ï¼Œå¹¶å—åˆ°å¹¿å¤§ gopher çš„å…³æ³¨ã€‚æœ¬æ–‡æ˜¯è¯¥è§„èŒƒçš„ä¸­æ–‡ç‰ˆæœ¬ã€‚æœ¬ç‰ˆæœ¬ä¼šæ ¹æ®åŸç‰ˆå®æ—¶æ›´æ–°ã€‚\nç›®å½•  uber- go/guide çš„ä¸­æ–‡ç¿»è¯‘ English Uber go è¯­è¨€ç¼–ç è§„èŒƒ ç‰ˆæœ¬ ç›®å½• ä»‹ç» æŒ‡å¯¼åŸåˆ™  æŒ‡å‘ interface çš„æŒ‡é’ˆ Interface åˆç†æ€§éªŒè¯ æ¥æ”¶å™¨ (receiver) ä¸æ¥å£ é›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„ åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Maps  æ¥æ”¶ Slices å’Œ Maps è¿”å› slices æˆ– maps   ä½¿ç”¨ defer é‡Šæ”¾èµ„æº Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ æšä¸¾ä» 1 å¼€å§‹ ä½¿ç”¨ time å¤„ç†æ—¶é—´  ä½¿ç”¨ time.Time è¡¨è¾¾ç¬æ—¶æ—¶é—´ ä½¿ç”¨ time.Duration è¡¨è¾¾æ—¶é—´æ®µ å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ time.Time å’Œ time.Duration   é”™è¯¯ç±»å‹ é”™è¯¯åŒ…è£… (Error Wrapping) å¤„ç†ç±»å‹æ–­è¨€å¤±è´¥ ä¸è¦ panic ä½¿ç”¨ go.uber.org/atomic é¿å…å¯å˜å…¨å±€å˜é‡ é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹ é¿å…ä½¿ç”¨å†…ç½®åç§° é¿å…ä½¿ç”¨ init() è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡ ä¸»å‡½æ•°é€€å‡ºæ–¹å¼(Exit)  ä¸€æ¬¡æ€§é€€å‡º     æ€§èƒ½  ä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmt é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢ æŒ‡å®šå®¹å™¨å®¹é‡  æŒ‡å®šMapå®¹é‡æç¤º æŒ‡å®šåˆ‡ç‰‡å®¹é‡     è§„èŒƒ  ä¸€è‡´æ€§ ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ import åˆ†ç»„ åŒ…å å‡½æ•°å å¯¼å…¥åˆ«å å‡½æ•°åˆ†ç»„ä¸é¡ºåº å‡å°‘åµŒå¥— ä¸å¿…è¦çš„ else é¡¶å±‚å˜é‡å£°æ˜ å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€ ç»“æ„ä½“ä¸­çš„åµŒå…¥ ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ä½“ æœ¬åœ°å˜é‡å£°æ˜ nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slice ç¼©å°å˜é‡ä½œç”¨åŸŸ é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜ç¡®(Avoid Naked Parameters) ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰ åˆå§‹åŒ–ç»“æ„ä½“  ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ çœç•¥ç»“æ„ä¸­çš„é›¶å€¼å­—æ®µ å¯¹é›¶å€¼ç»“æ„ä½¿ç”¨ var åˆå§‹åŒ– Struct å¼•ç”¨   åˆå§‹åŒ– Maps å­—ç¬¦ä¸² string format å‘½å Printf æ ·å¼çš„å‡½æ•°   ç¼–ç¨‹æ¨¡å¼  è¡¨é©±åŠ¨æµ‹è¯• åŠŸèƒ½é€‰é¡¹   Linting  Lint Runners   Stargazers over time  ä»‹ç» æ ·å¼ (style) æ˜¯æ”¯é…æˆ‘ä»¬ä»£ç çš„æƒ¯ä¾‹ã€‚æœ¯è¯­æ ·å¼æœ‰ç‚¹ç”¨è¯ä¸å½“ï¼Œå› ä¸ºè¿™äº›çº¦å®šæ¶µç›–çš„èŒƒå›´ä¸é™äºç”± gofmt æ›¿æˆ‘ä»¬å¤„ç†çš„æºæ–‡ä»¶æ ¼å¼ã€‚\næœ¬æŒ‡å—çš„ç›®çš„æ˜¯é€šè¿‡è¯¦ç»†æè¿°åœ¨ Uber ç¼–å†™ go ä»£ç çš„æ³¨æ„äº‹é¡¹æ¥ç®¡ç†è¿™ç§å¤æ‚æ€§ã€‚è¿™äº›è§„åˆ™çš„å­˜åœ¨æ˜¯ä¸ºäº†ä½¿ä»£ç åº“æ˜“äºç®¡ç†ï¼ŒåŒæ—¶ä»ç„¶å…è®¸å·¥ç¨‹å¸ˆæ›´æœ‰æ•ˆåœ°ä½¿ç”¨ go è¯­è¨€åŠŸèƒ½ã€‚\nè¯¥æŒ‡å—æœ€åˆç”± Prashant Varanasi å’Œ Simon Newton ç¼–å†™ï¼Œç›®çš„æ˜¯ä½¿ä¸€äº›åŒäº‹èƒ½å¿«é€Ÿä½¿ç”¨ goã€‚å¤šå¹´æ¥ï¼Œè¯¥æŒ‡å—å·²æ ¹æ®å…¶ä»–äººçš„åé¦ˆè¿›è¡Œäº†ä¿®æ”¹ã€‚\næœ¬æ–‡æ¡£è®°å½•äº†æˆ‘ä»¬åœ¨ Uber éµå¾ªçš„ go ä»£ç ä¸­çš„æƒ¯ç”¨çº¦å®šã€‚å…¶ä¸­è®¸å¤šæ˜¯ go çš„é€šç”¨å‡†åˆ™ï¼Œè€Œå…¶ä»–æ‰©å±•å‡†åˆ™ä¾èµ–äºä¸‹é¢å¤–éƒ¨çš„æŒ‡å—ï¼š\n [Effective go](https:// golang.org/doc/effective_ go.html) [ go Common Mistakes](https://github.com/ golang/ go/wiki/CommonMistakes) [ go Code Review Comments](https://github.com/ golang/ go/wiki/CodeReviewComments)  æ‰€æœ‰ä»£ç éƒ½åº”è¯¥é€šè¿‡ golintå’Œ go vetçš„æ£€æŸ¥å¹¶æ— é”™è¯¯ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å°†ç¼–è¾‘å™¨è®¾ç½®ä¸ºï¼š\n ä¿å­˜æ—¶è¿è¡Œ  goimports è¿è¡Œ  golint å’Œ  go vet æ£€æŸ¥é”™è¯¯  æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ go ç¼–è¾‘å™¨å·¥å…·æ”¯æŒé¡µé¢ä¸­æ‰¾åˆ°æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼š \u0026lt;https://github.com/ golang/ go/wiki/IDEsAndTextEditorPlugins\u0026gt;\næŒ‡å¯¼åŸåˆ™ æŒ‡å‘ interface çš„æŒ‡é’ˆ æ‚¨å‡ ä¹ä¸éœ€è¦æŒ‡å‘æ¥å£ç±»å‹çš„æŒ‡é’ˆã€‚æ‚¨åº”è¯¥å°†æ¥å£ä½œä¸ºå€¼è¿›è¡Œä¼ é€’ï¼Œåœ¨è¿™æ ·çš„ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œå®è´¨ä¸Šä¼ é€’çš„åº•å±‚æ•°æ®ä»ç„¶å¯ä»¥æ˜¯æŒ‡é’ˆã€‚\næ¥å£å®è´¨ä¸Šåœ¨åº•å±‚ç”¨ä¸¤ä¸ªå­—æ®µè¡¨ç¤ºï¼š\n ä¸€ä¸ªæŒ‡å‘æŸäº›ç‰¹å®šç±»å‹ä¿¡æ¯çš„æŒ‡é’ˆã€‚æ‚¨å¯ä»¥å°†å…¶è§†ä¸º\u0026quot;type\u0026quot;ã€‚ æ•°æ®æŒ‡é’ˆã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®æ˜¯æŒ‡é’ˆï¼Œåˆ™ç›´æ¥å­˜å‚¨ã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®æ˜¯ä¸€ä¸ªå€¼ï¼Œåˆ™å­˜å‚¨æŒ‡å‘è¯¥å€¼çš„æŒ‡é’ˆã€‚  å¦‚æœå¸Œæœ›æ¥å£æ–¹æ³•ä¿®æ”¹åŸºç¡€æ•°æ®ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æŒ‡é’ˆä¼ é€’(å°†å¯¹è±¡æŒ‡é’ˆèµ‹å€¼ç»™æ¥å£å˜é‡)ã€‚\n go type F interface { f() } type S1 struct{} func (s S1) f() {} type S2 struct{} func (s *S2) f() {} // f1.f()æ— æ³•ä¿®æ”¹åº•å±‚æ•°æ® // f2.f() å¯ä»¥ä¿®æ”¹åº•å±‚æ•°æ®,ç»™æ¥å£å˜é‡f2èµ‹å€¼æ—¶ä½¿ç”¨çš„æ˜¯å¯¹è±¡æŒ‡é’ˆ var f1 F = S1{} var f2 F = \u0026amp;S2{} Interface åˆç†æ€§éªŒè¯ åœ¨ç¼–è¯‘æ—¶éªŒè¯æ¥å£çš„ç¬¦åˆæ€§ã€‚è¿™åŒ…æ‹¬ï¼š\n å°†å®ç°ç‰¹å®šæ¥å£çš„å¯¼å‡ºç±»å‹ä½œä¸ºæ¥å£API çš„ä¸€éƒ¨åˆ†è¿›è¡Œæ£€æŸ¥ å®ç°åŒä¸€æ¥å£çš„(å¯¼å‡ºå’Œéå¯¼å‡º)ç±»å‹å±äºå®ç°ç±»å‹çš„é›†åˆ ä»»ä½•è¿åæ¥å£åˆç†æ€§æ£€æŸ¥çš„åœºæ™¯,éƒ½ä¼šç»ˆæ­¢ç¼–è¯‘,å¹¶é€šçŸ¥ç»™ç”¨æˆ·  è¡¥å……:ä¸Šé¢3æ¡æ˜¯ç¼–è¯‘å™¨å¯¹æ¥å£çš„æ£€æŸ¥æœºåˆ¶, å¤§ä½“æ„æ€æ˜¯é”™è¯¯ä½¿ç”¨æ¥å£ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™. æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªæœºåˆ¶è®©éƒ¨åˆ†é—®é¢˜åœ¨ç¼–è¯‘æœŸæš´éœ².\ngo // å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨è¿è¡Œæ—¶æŠ¥é”™ type Handler struct { // ... } func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { ... }  go type Handler struct { // ... } // ç”¨äºè§¦å‘ç¼–è¯‘æœŸçš„æ¥å£çš„åˆç†æ€§æ£€æŸ¥æœºåˆ¶ // å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™ var _ http.Handler = (*Handler)(nil) func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { // ... } å¦‚æœ *Handler ä¸ http.Handler çš„æ¥å£ä¸åŒ¹é…, é‚£ä¹ˆè¯­å¥ var _ http.Handler = (*Handler)(nil) å°†æ— æ³•ç¼–è¯‘é€šè¿‡.\nèµ‹å€¼çš„å³è¾¹åº”è¯¥æ˜¯æ–­è¨€ç±»å‹çš„é›¶å€¼ã€‚ å¯¹äºæŒ‡é’ˆç±»å‹ï¼ˆå¦‚ *Handlerï¼‰ã€åˆ‡ç‰‡å’Œæ˜ å°„ï¼Œè¿™æ˜¯ nilï¼› å¯¹äºç»“æ„ç±»å‹ï¼Œè¿™æ˜¯ç©ºç»“æ„ã€‚\ngo type LogHandler struct { h http.Handler log *zap.Logger } var _ http.Handler = LogHandler{} func (h LogHandler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { // ... } æ¥æ”¶å™¨ (receiver) ä¸æ¥å£ ä½¿ç”¨å€¼æ¥æ”¶å™¨çš„æ–¹æ³•æ—¢å¯ä»¥é€šè¿‡å€¼è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆè°ƒç”¨ã€‚\nå¸¦æŒ‡é’ˆæ¥æ”¶å™¨çš„æ–¹æ³•åªèƒ½é€šè¿‡æŒ‡é’ˆæˆ– addressable valuesè°ƒç”¨.\ngolang.org/ref/spec#Method_values\nä¾‹å¦‚ï¼Œ\ngo type S struct { data string } func (s S) Read() string { return s.data } func (s *S) Write(str string) { s.data = str } sVals := map[int]S{1: {\u0026quot;A\u0026quot;}} // ä½ åªèƒ½é€šè¿‡å€¼è°ƒç”¨ Read sVals[1].Read() // è¿™ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼š // sVals[1].Write(\u0026quot;test\u0026quot;) sPtrs := map[int]*S{1: {\u0026quot;A\u0026quot;}} // é€šè¿‡æŒ‡é’ˆæ—¢å¯ä»¥è°ƒç”¨ Readï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ Write æ–¹æ³• sPtrs[1].Read() sPtrs[1].Write(\u0026quot;test\u0026quot;) ç±»ä¼¼çš„,å³ä½¿æ–¹æ³•æœ‰äº†å€¼æ¥æ”¶å™¨,ä¹ŸåŒæ ·å¯ä»¥ç”¨æŒ‡é’ˆæ¥æ”¶å™¨æ¥æ»¡è¶³æ¥å£.\ngo type F interface { f() } type S1 struct{} func (s S1) f() {} type S2 struct{} func (s *S2) f() {} s1Val := S1{} s1Ptr := \u0026amp;S1{} s2Val := S2{} s2Ptr := \u0026amp;S2{} var i F i = s1Val i = s1Ptr i = s2Ptr // ä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› ä¸º s2Val æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œ S2 çš„ f æ–¹æ³•ä¸­æ²¡æœ‰ä½¿ç”¨å€¼æ¥æ”¶å™¨ // i = s2Val [Effective go](https:// golang.org/doc/effective_ go.html) ä¸­æœ‰ä¸€æ®µå…³äº [pointers vs. values](https:// golang.org/doc/effective_ go.html#pointers_vs_values) çš„ç²¾å½©è®²è§£ã€‚\nè¡¥å……:\n ä¸€ä¸ªç±»å‹å¯ä»¥æœ‰å€¼æ¥æ”¶å™¨æ–¹æ³•é›†å’ŒæŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†  å€¼æ¥æ”¶å™¨æ–¹æ³•é›†æ˜¯æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†çš„å­é›†,åä¹‹ä¸æ˜¯   è§„åˆ™  å€¼å¯¹è±¡åªå¯ä»¥ä½¿ç”¨å€¼æ¥æ”¶å™¨æ–¹æ³•é›† æŒ‡é’ˆå¯¹è±¡å¯ä»¥ä½¿ç”¨ å€¼æ¥æ”¶å™¨æ–¹æ³•é›† + æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†   æ¥å£çš„åŒ¹é…(æˆ–è€…å«å®ç°)  ç±»å‹å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•,å«åŒ¹é… å…·ä½“çš„è®²,è¦ä¹ˆæ˜¯ç±»å‹çš„å€¼æ–¹æ³•é›†åŒ¹é…æ¥å£,è¦ä¹ˆæ˜¯æŒ‡é’ˆæ–¹æ³•é›†åŒ¹é…æ¥å£    å…·ä½“çš„åŒ¹é…åˆ†ä¸¤ç§:\n å€¼æ–¹æ³•é›†å’Œæ¥å£åŒ¹é…  ç»™æ¥å£å˜é‡èµ‹å€¼çš„ä¸ç®¡æ˜¯å€¼è¿˜æ˜¯æŒ‡é’ˆå¯¹è±¡,éƒ½ok,å› ä¸ºéƒ½åŒ…å«å€¼æ–¹æ³•é›†   æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é…  åªèƒ½å°†æŒ‡é’ˆå¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡,å› ä¸ºåªæœ‰æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é… å¦‚æœå°†å€¼å¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™(ä¼šè§¦å‘æ¥å£åˆç†æ€§æ£€æŸ¥æœºåˆ¶)    ä¸ºå•¥ i = s2Val ä¼šæŠ¥é”™,å› ä¸ºå€¼æ–¹æ³•é›†å’Œæ¥å£ä¸åŒ¹é….\né›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„ é›¶å€¼ sync.Mutex å’Œ sync.RWMutex æ˜¯æœ‰æ•ˆçš„ã€‚æ‰€ä»¥æŒ‡å‘ mutex çš„æŒ‡é’ˆåŸºæœ¬æ˜¯ä¸å¿…è¦çš„ã€‚\ngo mu := new(sync.Mutex) mu.Lock() go var mu sync.Mutex mu.Lock() å¦‚æœä½ ä½¿ç”¨ç»“æ„ä½“æŒ‡é’ˆï¼Œmutex å¯ä»¥éæŒ‡é’ˆå½¢å¼ä½œä¸ºç»“æ„ä½“çš„ç»„æˆå­—æ®µï¼Œæˆ–è€…æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ã€‚ å¦‚æœæ˜¯ç§æœ‰ç»“æ„ä½“ç±»å‹æˆ–æ˜¯è¦å®ç° Mutex æ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå…¥ mutex çš„æ–¹æ³•ï¼š\ngo type smap struct { sync.Mutex // only for unexported typesï¼ˆä»…é€‚ç”¨äºéå¯¼å‡ºç±»å‹ï¼‰ data map[string]string } func newSMap() *smap { return \u0026amp;smap{ data: make(map[string]string), } } func (m *smap) Get(k string) string { m.Lock() defer m.Unlock() return m.data[k] } go type SMap struct { mu sync.Mutex // å¯¹äºå¯¼å‡ºç±»å‹ï¼Œè¯·ä½¿ç”¨ç§æœ‰é” data map[string]string } func NewSMap() *SMap { return \u0026amp;SMap{ data: make(map[string]string), } } func (m *SMap) Get(k string) string { m.mu.Lock() defer m.mu.Unlock() return m.data[k] } åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Maps slices å’Œ maps åŒ…å«äº†æŒ‡å‘åº•å±‚æ•°æ®çš„æŒ‡é’ˆï¼Œå› æ­¤åœ¨éœ€è¦å¤åˆ¶å®ƒä»¬æ—¶è¦ç‰¹åˆ«æ³¨æ„ã€‚\næ¥æ”¶ Slices å’Œ Maps è¯·è®°ä½ï¼Œå½“ map æˆ– slice ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥æ—¶ï¼Œå¦‚æœæ‚¨å­˜å‚¨äº†å¯¹å®ƒä»¬çš„å¼•ç”¨ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚\ngo func (d *Driver) SetTrips(trips []Trip) { d.trips = trips } trips := ... d1.SetTrips(trips) // ä½ æ˜¯è¦ä¿®æ”¹ d1.trips å—ï¼Ÿ trips[0] = ... go func (d *Driver) SetTrips(trips []Trip) { d.trips = make([]Trip, len(trips)) copy(d.trips, trips) } trips := ... d1.SetTrips(trips) // è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ trips[0]ï¼Œä½†ä¸ä¼šå½±å“åˆ° d1.trips trips[0] = ... è¿”å› slices æˆ– maps åŒæ ·ï¼Œè¯·æ³¨æ„ç”¨æˆ·å¯¹æš´éœ²å†…éƒ¨çŠ¶æ€çš„ map æˆ– slice çš„ä¿®æ”¹ã€‚\ngo type Stats struct { mu sync.Mutex counters map[string]int } // Snapshot è¿”å›å½“å‰çŠ¶æ€ã€‚ func (s *Stats) Snapshot() map[string]int { s.mu.Lock() defer s.mu.Unlock() return s.counters } // snapshot ä¸å†å—äº’æ–¥é”ä¿æŠ¤ // å› æ­¤å¯¹ snapshot çš„ä»»ä½•è®¿é—®éƒ½å°†å—åˆ°æ•°æ®ç«äº‰çš„å½±å“ // å½±å“ stats.counters snapshot := stats.Snapshot() go type Stats struct { mu sync.Mutex counters map[string]int } func (s *Stats) Snapshot() map[string]int { s.mu.Lock() defer s.mu.Unlock() result := make(map[string]int, len(s.counters)) for k, v := range s.counters { result[k] = v } return result } // snapshot ç°åœ¨æ˜¯ä¸€ä¸ªæ‹·è´ snapshot := stats.Snapshot() ä½¿ç”¨ defer é‡Šæ”¾èµ„æº ä½¿ç”¨ defer é‡Šæ”¾èµ„æºï¼Œè¯¸å¦‚æ–‡ä»¶å’Œé”ã€‚\ngo p.Lock() if p.count \u0026lt; 10 { p.Unlock() return p.count } p.count++ newCount := p.count p.Unlock() return newCount // å½“æœ‰å¤šä¸ª return åˆ†æ”¯æ—¶ï¼Œå¾ˆå®¹æ˜“é—å¿˜ unlock go p.Lock() defer p.Unlock() if p.count \u0026lt; 10 { return p.count } p.count++ return p.count // æ›´å¯è¯» Defer çš„å¼€é”€éå¸¸å°ï¼Œåªæœ‰åœ¨æ‚¨å¯ä»¥è¯æ˜å‡½æ•°æ‰§è¡Œæ—¶é—´å¤„äºçº³ç§’çº§çš„ç¨‹åº¦æ—¶ï¼Œæ‰åº”é¿å…è¿™æ ·åšã€‚ä½¿ç”¨ defer æå‡å¯è¯»æ€§æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬çš„æˆæœ¬å¾®ä¸è¶³é“ã€‚å°¤å…¶é€‚ç”¨äºé‚£äº›ä¸ä»…ä»…æ˜¯ç®€å•å†…å­˜è®¿é—®çš„è¾ƒå¤§çš„æ–¹æ³•ï¼Œåœ¨è¿™äº›æ–¹æ³•ä¸­å…¶ä»–è®¡ç®—çš„èµ„æºæ¶ˆè€—è¿œè¶…è¿‡ deferã€‚\nChannel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ channel é€šå¸¸ size åº”ä¸º 1 æˆ–æ˜¯æ— ç¼“å†²çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œchannel æ˜¯æ— ç¼“å†²çš„ï¼Œå…¶ size ä¸ºé›¶ã€‚ä»»ä½•å…¶ä»–å°ºå¯¸éƒ½å¿…é¡»ç»è¿‡ä¸¥æ ¼çš„å®¡æŸ¥ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•ç¡®å®šå¤§å°ï¼Œè€ƒè™‘æ˜¯ä»€ä¹ˆé˜»æ­¢äº† channel åœ¨é«˜è´Ÿè½½ä¸‹å’Œé˜»å¡å†™æ—¶çš„å†™å…¥ï¼Œä»¥åŠå½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ç³»ç»Ÿé€»è¾‘æœ‰å“ªäº›å˜åŒ–ã€‚(ç¿»è¯‘è§£é‡Šï¼šæŒ‰ç…§åŸæ–‡æ„æ€æ˜¯éœ€è¦ç•Œå®šé€šé“è¾¹ç•Œï¼Œç«æ€æ¡ä»¶ï¼Œä»¥åŠé€»è¾‘ä¸Šä¸‹æ–‡æ¢³ç†)\ngo // åº”è¯¥è¶³ä»¥æ»¡è¶³ä»»ä½•æƒ…å†µï¼ c := make(chan int, 64) go // å¤§å°ï¼š1 c := make(chan int, 1) // æˆ–è€… // æ— ç¼“å†² channelï¼Œå¤§å°ä¸º 0 c := make(chan int) æšä¸¾ä» 1 å¼€å§‹ åœ¨ go ä¸­å¼•å…¥æšä¸¾çš„æ ‡å‡†æ–¹æ³•æ˜¯å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹å’Œä¸€ä¸ªä½¿ç”¨äº† iota çš„ const ç»„ã€‚ç”±äºå˜é‡çš„é»˜è®¤å€¼ä¸º 0ï¼Œå› æ­¤é€šå¸¸åº”ä»¥éé›¶å€¼å¼€å¤´æšä¸¾ã€‚\ngo type Operation int const ( Add Operation = iota Subtract Multiply ) // Add=0, Subtract=1, Multiply=2 go type Operation int const ( Add Operation = iota + 1 Subtract Multiply ) // Add=1, Subtract=2, Multiply=3 åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨é›¶å€¼æ˜¯æœ‰æ„ä¹‰çš„ï¼ˆæšä¸¾ä»é›¶å¼€å§‹ï¼‰ï¼Œä¾‹å¦‚ï¼Œå½“é›¶å€¼æ˜¯ç†æƒ³çš„é»˜è®¤è¡Œä¸ºæ—¶ã€‚\ngo type Lo goutput int const ( LogToStdout Lo goutput = iota LogToFile LogToRemote ) // LogToStdout=0, LogToFile=1, LogToRemote=2 ä½¿ç”¨ time å¤„ç†æ—¶é—´ æ—¶é—´å¤„ç†å¾ˆå¤æ‚ã€‚å…³äºæ—¶é—´çš„é”™è¯¯å‡è®¾é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ã€‚\n ä¸€å¤©æœ‰ 24 å°æ—¶ ä¸€å°æ—¶æœ‰ 60 åˆ†é’Ÿ ä¸€å‘¨æœ‰ä¸ƒå¤© ä¸€å¹´ 365 å¤© è¿˜æœ‰æ›´å¤š  ä¾‹å¦‚ï¼Œ1 è¡¨ç¤ºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ŠåŠ ä¸Š 24 å°æ—¶å¹¶ä¸æ€»æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å†æ—¥ã€‚\nå› æ­¤ï¼Œåœ¨å¤„ç†æ—¶é—´æ—¶å§‹ç»ˆä½¿ç”¨ \u0026quot;time\u0026quot; åŒ…ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºä»¥æ›´å®‰å…¨ã€æ›´å‡†ç¡®çš„æ–¹å¼å¤„ç†è¿™äº›ä¸æ­£ç¡®çš„å‡è®¾ã€‚\ngolang.org/pkg/time/\nä½¿ç”¨ time.Time è¡¨è¾¾ç¬æ—¶æ—¶é—´ åœ¨å¤„ç†æ—¶é—´çš„ç¬é—´æ—¶ä½¿ç”¨ time.Timeï¼Œåœ¨æ¯”è¾ƒã€æ·»åŠ æˆ–å‡å»æ—¶é—´æ—¶ä½¿ç”¨ time.Time ä¸­çš„æ–¹æ³•ã€‚\ngolang.org/pkg/time/#Time\ngo func isActive(now, start, stop int) bool { return start \u0026lt;= now \u0026amp;\u0026amp; now \u0026lt; stop } go func isActive(now, start, stop time.Time) bool { return (start.Before(now) || start.Equal(now)) \u0026amp;\u0026amp; now.Before(stop) } ä½¿ç”¨ time.Duration è¡¨è¾¾æ—¶é—´æ®µ åœ¨å¤„ç†æ—¶é—´æ®µæ—¶ä½¿ç”¨ time.Duration .\ngolang.org/pkg/time/#Duration\ngo func poll(delay int) { for { // ... time.Sleep(time.Duration(delay) * time.Millisecond) } } poll(10) // æ˜¯å‡ ç§’é’Ÿè¿˜æ˜¯å‡ æ¯«ç§’? go func poll(delay time.Duration) { for { // ... time.Sleep(delay) } } poll(10*time.Second) å›åˆ°ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´ç¬é—´åŠ ä¸Š 24 å°æ—¶ï¼Œæˆ‘ä»¬ç”¨äºæ·»åŠ æ—¶é—´çš„æ–¹æ³•å–å†³äºæ„å›¾ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸‹ä¸€ä¸ªæ—¥å†æ—¥(å½“å‰å¤©çš„ä¸‹ä¸€å¤©)çš„åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.AddDateã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä¿è¯æŸä¸€æ—¶åˆ»æ¯”å‰ä¸€æ—¶åˆ»æ™š 24 å°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ [Time.Add]ã€‚\ngolang.org/pkg/time/#Time.AddDate [Time.Add]: https:// golang.org/pkg/time/#Time.Add\ngo newDay := t.AddDate(0 /* years */, 0 /* months */, 1 /* days */) maybeNewDay := t.Add(24 * time.Hour) å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ time.Time å’Œ time.Duration å°½å¯èƒ½åœ¨ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ä¸­ä½¿ç”¨ time.Duration å’Œ time.Time ä¾‹å¦‚ :\n  Command-line æ ‡å¿—: flag é€šè¿‡ [time.ParseDuration] æ”¯æŒ time.Duration\n  JSON: [encoding/json] é€šè¿‡å…¶ [UnmarshalJSON method] æ–¹æ³•æ”¯æŒå°† time.Time ç¼–ç ä¸º [RFC 3339] å­—ç¬¦ä¸²\n  SQL: [database/sql] æ”¯æŒå°† DATETIME æˆ– TIMESTAMP åˆ—è½¬æ¢ä¸º time.Timeï¼Œå¦‚æœåº•å±‚é©±åŠ¨ç¨‹åºæ”¯æŒåˆ™è¿”å›\n  YAML: [ gopkg.in/yaml.v2] æ”¯æŒå°† time.Time ä½œä¸º [RFC 3339] å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡ [time.ParseDuration] æ”¯æŒ time.Durationã€‚\ngolang.org/pkg/flag/ [time.ParseDuration]: https:// golang.org/pkg/time/#ParseDuration [encoding/json]: https:// golang.org/pkg/encoding/json/ [RFC 3339]: https://tools.ietf.org/html/rfc3339 [UnmarshalJSON method]: https:// golang.org/pkg/time/#Time.UnmarshalJSON [database/sql]: https:// golang.org/pkg/database/sql/ [ gopkg.in/yaml.v2]: https:// godoc.org/ gopkg.in/yaml.v2\n  å½“ä¸èƒ½åœ¨è¿™äº›äº¤äº’ä¸­ä½¿ç”¨ time.Duration æ—¶ï¼Œè¯·ä½¿ç”¨ int æˆ– float64ï¼Œå¹¶åœ¨å­—æ®µåç§°ä¸­åŒ…å«å•ä½ã€‚\nä¾‹å¦‚ï¼Œç”±äº encoding/json ä¸æ”¯æŒ time.Durationï¼Œå› æ­¤è¯¥å•ä½åŒ…å«åœ¨å­—æ®µçš„åç§°ä¸­ã€‚\ngo // {\u0026quot;interval\u0026quot;: 2} type Config struct { Interval int `json:\u0026quot;interval\u0026quot;` } go // {\u0026quot;intervalMillis\u0026quot;: 2000} type Config struct { IntervalMillis int `json:\u0026quot;intervalMillis\u0026quot;` } å½“åœ¨è¿™äº›äº¤äº’ä¸­ä¸èƒ½ä½¿ç”¨ time.Time æ—¶ï¼Œé™¤éè¾¾æˆä¸€è‡´ï¼Œå¦åˆ™ä½¿ç”¨ string å’Œ [RFC 3339] ä¸­å®šä¹‰çš„æ ¼å¼æ—¶é—´æˆ³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTime.UnmarshalText ä½¿ç”¨æ­¤æ ¼å¼ï¼Œå¹¶å¯é€šè¿‡ [time.RFC3339] åœ¨ Time.Format å’Œ time.Parse ä¸­ä½¿ç”¨ã€‚\ngolang.org/pkg/time/#Time.UnmarshalText [time.RFC3339]: https:// golang.org/pkg/time/#RFC3339\nå°½ç®¡è¿™åœ¨å®è·µä¸­å¹¶ä¸æˆé—®é¢˜ï¼Œä½†è¯·è®°ä½ï¼Œ\u0026quot;time\u0026quot; åŒ…ä¸æ”¯æŒè§£æé—°ç§’æ—¶é—´æˆ³ï¼ˆ8728ï¼‰ï¼Œä¹Ÿä¸åœ¨è®¡ç®—ä¸­è€ƒè™‘é—°ç§’ï¼ˆ[15190]ï¼‰ã€‚å¦‚æœæ‚¨æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ç¬é—´ï¼Œåˆ™å·®å¼‚å°†ä¸åŒ…æ‹¬è¿™ä¸¤ä¸ªç¬é—´ä¹‹é—´å¯èƒ½å‘ç”Ÿçš„é—°ç§’ã€‚\ngolang/ go/issues/8728 [15190]: https://github.com/ golang/ go/issues/15190\né”™è¯¯ç±»å‹ go ä¸­æœ‰å¤šç§å£°æ˜é”™è¯¯ï¼ˆError) çš„é€‰é¡¹ï¼š\n errors.New å¯¹äºç®€å•é™æ€å­—ç¬¦ä¸²çš„é”™è¯¯ [fmt.Errorf] ç”¨äºæ ¼å¼åŒ–çš„é”™è¯¯å­—ç¬¦ä¸² å®ç° Error() æ–¹æ³•çš„è‡ªå®šä¹‰ç±»å‹ ç”¨ [\u0026quot;pkg/errors\u0026quot;.Wrap] çš„ Wrapped errors  è¿”å›é”™è¯¯æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å› ç´ ä»¥ç¡®å®šæœ€ä½³é€‰æ‹©ï¼š\n  è¿™æ˜¯ä¸€ä¸ªä¸éœ€è¦é¢å¤–ä¿¡æ¯çš„ç®€å•é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œerrors.New è¶³å¤Ÿäº†ã€‚\n  å®¢æˆ·éœ€è¦æ£€æµ‹å¹¶å¤„ç†æ­¤é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹å¹¶å®ç°è¯¥ Error() æ–¹æ³•ã€‚\n  æ‚¨æ˜¯å¦æ­£åœ¨ä¼ æ’­ä¸‹æ¸¸å‡½æ•°è¿”å›çš„é”™è¯¯ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡åé¢æœ‰å…³é”™è¯¯åŒ…è£… section on error wrapping éƒ¨åˆ†çš„å†…å®¹ã€‚\n  å¦åˆ™ [fmt.Errorf] å°±å¯ä»¥äº†ã€‚\ngolang.org/pkg/errors/#New [fmt.Errorf]: https:// golang.org/pkg/fmt/#Errorf [\u0026quot;pkg/errors\u0026quot;.Wrap]: https:// godoc.org/github.com/pkg/errors#Wrap\n  å¦‚æœå®¢æˆ·ç«¯éœ€è¦æ£€æµ‹é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨å·²ä½¿ç”¨åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„é”™è¯¯ errors.Newï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªé”™è¯¯å˜é‡ã€‚\ngo // package foo func Open() error { return errors.New(\u0026quot;could not open\u0026quot;) } // package bar func use() { if err := foo.Open(); err != nil { if err.Error() == \u0026quot;could not open\u0026quot; { // handle } else { panic(\u0026quot;unknown error\u0026quot;) } } } go // package foo var ErrCouldNotOpen = errors.New(\u0026quot;could not open\u0026quot;) func Open() error { return ErrCouldNotOpen } // package bar if err := foo.Open(); err != nil { if errors.Is(err, foo.ErrCouldNotOpen) { // handle } else { panic(\u0026quot;unknown error\u0026quot;) } } å¦‚æœæ‚¨æœ‰å¯èƒ½éœ€è¦å®¢æˆ·ç«¯æ£€æµ‹çš„é”™è¯¯ï¼Œå¹¶ä¸”æƒ³å‘å…¶ä¸­æ·»åŠ æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå®ƒä¸æ˜¯é™æ€å­—ç¬¦ä¸²ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ã€‚\ngo func open(file string) error { return fmt.Errorf(\u0026quot;file %q not found\u0026quot;, file) } func use() { if err := open(\u0026quot;testfile.txt\u0026quot;); err != nil { if strings.Contains(err.Error(), \u0026quot;not found\u0026quot;) { // handle } else { panic(\u0026quot;unknown error\u0026quot;) } } } go type errNotFound struct { file string } func (e errNotFound) Error() string { return fmt.Sprintf(\u0026quot;file %q not found\u0026quot;, e.file) } func open(file string) error { return errNotFound{file: file} } func use() { if err := open(\u0026quot;testfile.txt\u0026quot;); err != nil { if _, ok := err.(errNotFound); ok { // handle } else { panic(\u0026quot;unknown error\u0026quot;) } } } ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯ç±»å‹æ—¶è¦å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å·²æˆä¸ºç¨‹åºåŒ…å…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚æœ€å¥½å…¬å¼€åŒ¹é…å™¨åŠŸèƒ½ä»¥æ£€æŸ¥é”™è¯¯ã€‚\ngo // package foo type errNotFound struct { file string } func (e errNotFound) Error() string { return fmt.Sprintf(\u0026quot;file %q not found\u0026quot;, e.file) } func IsNotFoundError(err error) bool { _, ok := err.(errNotFound) return ok } func Open(file string) error { return errNotFound{file: file} } // package bar if err := foo.Open(\u0026quot;foo\u0026quot;); err != nil { if foo.IsNotFoundError(err) { // handle } else { panic(\u0026quot;unknown error\u0026quot;) } } é”™è¯¯åŒ…è£… (Error Wrapping) ä¸€ä¸ªï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰è°ƒç”¨å¤±è´¥æ—¶ï¼Œæœ‰ä¸‰ç§ä¸»è¦çš„é”™è¯¯ä¼ æ’­æ–¹å¼ï¼š\n å¦‚æœæ²¡æœ‰è¦æ·»åŠ çš„å…¶ä»–ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦ç»´æŠ¤åŸå§‹é”™è¯¯ç±»å‹ï¼Œåˆ™è¿”å›åŸå§‹é”™è¯¯ã€‚ æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ [\u0026quot;pkg/errors\u0026quot;.Wrap] ä»¥ä¾¿é”™è¯¯æ¶ˆæ¯æä¾›æ›´å¤šä¸Šä¸‹æ–‡ ,\u0026quot;pkg/errors\u0026quot;.Cause å¯ç”¨äºæå–åŸå§‹é”™è¯¯ã€‚ å¦‚æœè°ƒç”¨è€…ä¸éœ€è¦æ£€æµ‹æˆ–å¤„ç†çš„ç‰¹å®šé”™è¯¯æƒ…å†µï¼Œä½¿ç”¨ [fmt.Errorf]ã€‚  å»ºè®®åœ¨å¯èƒ½çš„åœ°æ–¹æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä»¥ä½¿æ‚¨è·å¾—è¯¸å¦‚â€œè°ƒç”¨æœåŠ¡ fooï¼šè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ›´æœ‰ç”¨çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¯¸å¦‚â€œè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ¨¡ç³Šé”™è¯¯ã€‚\nåœ¨å°†ä¸Šä¸‹æ–‡æ·»åŠ åˆ°è¿”å›çš„é”™è¯¯æ—¶ï¼Œè¯·é¿å…ä½¿ç”¨â€œfailed toâ€ä¹‹ç±»çš„çŸ­è¯­ä»¥ä¿æŒä¸Šä¸‹æ–‡ç®€æ´ï¼Œè¿™äº›çŸ­è¯­ä¼šé™ˆè¿°æ˜æ˜¾çš„å†…å®¹ï¼Œå¹¶éšç€é”™è¯¯åœ¨å †æ ˆä¸­çš„æ¸—é€è€Œé€æ¸å †ç§¯ï¼š\ngo s, err := store.New() if err != nil { return fmt.Errorf( \u0026quot;failed to create new store: %v\u0026quot;, err) } go s, err := store.New() if err != nil { return fmt.Errorf( \u0026quot;new store: %v\u0026quot;, err) } failed to x: failed to y: failed to create new store: the error x: y: new store: the error ä½†æ˜¯ï¼Œä¸€æ—¦å°†é”™è¯¯å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œå°±åº”è¯¥æ˜ç¡®æ¶ˆæ¯æ˜¯é”™è¯¯æ¶ˆæ¯ï¼ˆä¾‹å¦‚ä½¿ç”¨erræ ‡è®°ï¼Œæˆ–åœ¨æ—¥å¿—ä¸­ä»¥â€Failedâ€ä¸ºå‰ç¼€ï¼‰ã€‚\nå¦è¯·å‚è§ [Don\u0026rsquo;t just check errors, handle them gracefully]. ä¸è¦åªæ˜¯æ£€æŸ¥é”™è¯¯ï¼Œè¦ä¼˜é›…åœ°å¤„ç†é”™è¯¯\ngodoc.org/github.com/pkg/errors#Cause [Don\u0026rsquo;t just check errors, handle them gracefully]: https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully\nå¤„ç†ç±»å‹æ–­è¨€å¤±è´¥ type assertion çš„å•ä¸ªè¿”å›å€¼å½¢å¼é’ˆå¯¹ä¸æ­£ç¡®çš„ç±»å‹å°†äº§ç”Ÿ panicã€‚å› æ­¤ï¼Œè¯·å§‹ç»ˆä½¿ç”¨â€œcomma okâ€çš„æƒ¯ç”¨æ³•ã€‚\ngolang.org/ref/spec#Type_assertions\ngo t := i.(string) go t, ok := i.(string) if !ok { // ä¼˜é›…åœ°å¤„ç†é”™è¯¯ } ä¸è¦ panic åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç å¿…é¡»é¿å…å‡ºç° panicã€‚panic æ˜¯ cascading failures çº§è”å¤±è´¥çš„ä¸»è¦æ ¹æº ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¯¥å‡½æ•°å¿…é¡»è¿”å›é”™è¯¯ï¼Œå¹¶å…è®¸è°ƒç”¨æ–¹å†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚\ngo func run(args []string) { if len(args) == 0 { panic(\u0026quot;an argument is required\u0026quot;) } // ... } func main() { run(os.Args[1:]) } go func run(args []string) error { if len(args) == 0 { return errors.New(\u0026quot;an argument is required\u0026quot;) } // ... return nil } func main() { if err := run(os.Args[1:]); err != nil { fmt.Fprintln(os.Stderr, err) os.Exit(1) } } panic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ã€‚ä»…å½“å‘ç”Ÿä¸å¯æ¢å¤çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šnil å¼•ç”¨ï¼‰æ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚ç¨‹åºåˆå§‹åŒ–æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼šç¨‹åºå¯åŠ¨æ—¶åº”ä½¿ç¨‹åºä¸­æ­¢çš„ä¸è‰¯æƒ…å†µå¯èƒ½ä¼šå¼•èµ· panicã€‚\ngo var _statusTemplate = template.Must(template.New(\u0026quot;name\u0026quot;).Parse(\u0026quot;_statusHTML\u0026quot;)) å³ä½¿åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨t.Fatalæˆ–è€…t.FailNowè€Œä¸æ˜¯ panic æ¥ç¡®ä¿å¤±è´¥è¢«æ ‡è®°ã€‚\ngo // func TestFoo(t *testing.T) f, err := ioutil.TempFile(\u0026quot;\u0026quot;, \u0026quot;test\u0026quot;) if err != nil { panic(\u0026quot;failed to set up test\u0026quot;) } go // func TestFoo(t *testing.T) f, err := ioutil.TempFile(\u0026quot;\u0026quot;, \u0026quot;test\u0026quot;) if err != nil { t.Fatal(\u0026quot;failed to set up test\u0026quot;) } ä½¿ç”¨ go.uber.org/atomic\nä½¿ç”¨ [sync/atomic] åŒ…çš„åŸå­æ“ä½œå¯¹åŸå§‹ç±»å‹ (int32, int64ç­‰ï¼‰è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¾ˆå®¹æ˜“å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œæ¥è¯»å–æˆ–ä¿®æ”¹å˜é‡ã€‚\ngo.uber.org/atomic é€šè¿‡éšè—åŸºç¡€ç±»å‹ä¸ºè¿™äº›æ“ä½œå¢åŠ äº†ç±»å‹å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªæ–¹ä¾¿çš„atomic.Boolç±»å‹ã€‚\ngodoc.org/ go.uber.org/atomic [sync/atomic]: https:// golang.org/pkg/sync/atomic/\ngo type foo struct { running int32 // atomic } func (f* foo) start() { if atomic.SwapInt32(\u0026amp;f.running, 1) == 1 { // already runningâ€¦ return } // start the Foo } func (f *foo) isRunning() bool { return f.running == 1 // race! } go type foo struct { running atomic.Bool } func (f *foo) start() { if f.running.Swap(true) { // already runningâ€¦ return } // start the Foo } func (f *foo) isRunning() bool { return f.running.Load() } é¿å…å¯å˜å…¨å±€å˜é‡ ä½¿ç”¨é€‰æ‹©ä¾èµ–æ³¨å…¥æ–¹å¼é¿å…æ”¹å˜å…¨å±€å˜é‡ã€‚ æ—¢é€‚ç”¨äºå‡½æ•°æŒ‡é’ˆåˆé€‚ç”¨äºå…¶ä»–å€¼ç±»å‹\ngo // sign. go var _timeNow = time.Now func sign(msg string) string { now := _timeNow() return signWithTime(msg, now) } go // sign. go type signer struct { now func() time.Time } func newSigner() *signer { return \u0026amp;signer{ now: time.Now, } } func (s *signer) Sign(msg string) string { now := s.now() return signWithTime(msg, now) } go // sign_test. go func TestSign(t *testing.T) { oldTimeNow := _timeNow _timeNow = func() time.Time { return someFixedTime } defer func() { _timeNow = oldTimeNow }() assert.Equal(t, want, sign(give)) } go // sign_test. go func TestSigner(t *testing.T) { s := newSigner() s.now = func() time.Time { return someFixedTime } assert.Equal(t, want, s.Sign(give)) } é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹ è¿™äº›åµŒå…¥çš„ç±»å‹æ³„æ¼å®ç°ç»†èŠ‚ã€ç¦æ­¢ç±»å‹æ¼”åŒ–å’Œæ¨¡ç³Šçš„æ–‡æ¡£ã€‚\nå‡è®¾æ‚¨ä½¿ç”¨å…±äº«çš„ AbstractList å®ç°äº†å¤šç§åˆ—è¡¨ç±»å‹ï¼Œè¯·é¿å…åœ¨å…·ä½“çš„åˆ—è¡¨å®ç°ä¸­åµŒå…¥ AbstractListã€‚ ç›¸åï¼Œåªéœ€æ‰‹åŠ¨å°†æ–¹æ³•å†™å…¥å…·ä½“çš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å°†å§”æ‰˜ç»™æŠ½è±¡åˆ—è¡¨ã€‚\ngo type AbstractList struct {} // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *AbstractList) Add(e Entity) { // ... } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *AbstractList) Remove(e Entity) { // ... } go // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { *AbstractList } go // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { list *AbstractList } // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *ConcreteList) Add(e Entity) { l.list.Add(e) } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *ConcreteList) Remove(e Entity) { l.list.Remove(e) } go å…è®¸ ç±»å‹åµŒå…¥ ä½œä¸ºç»§æ‰¿å’Œç»„åˆä¹‹é—´çš„æŠ˜è¡·ã€‚ å¤–éƒ¨ç±»å‹è·å–åµŒå…¥ç±»å‹çš„æ–¹æ³•çš„éšå¼å‰¯æœ¬ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•å§”æ‰˜ç»™åµŒå…¥å®ä¾‹çš„åŒä¸€æ–¹æ³•ã€‚\ngolang.org/doc/effective_ go.html#embedding\nç»“æ„è¿˜è·å¾—ä¸ç±»å‹åŒåçš„å­—æ®µã€‚ æ‰€ä»¥ï¼Œå¦‚æœåµŒå…¥çš„ç±»å‹æ˜¯ publicï¼Œé‚£ä¹ˆå­—æ®µæ˜¯ publicã€‚ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼Œå¤–éƒ¨ç±»å‹çš„æ¯ä¸ªæœªæ¥ç‰ˆæœ¬éƒ½å¿…é¡»ä¿ç•™åµŒå…¥ç±»å‹ã€‚\nå¾ˆå°‘éœ€è¦åµŒå…¥ç±»å‹ã€‚ è¿™æ˜¯ä¸€ç§æ–¹ä¾¿ï¼Œå¯ä»¥å¸®åŠ©æ‚¨é¿å…ç¼–å†™å†—é•¿çš„å§”æ‰˜æ–¹æ³•ã€‚\nå³ä½¿åµŒå…¥å…¼å®¹çš„æŠ½è±¡åˆ—è¡¨ interfaceï¼Œè€Œä¸æ˜¯ç»“æ„ä½“ï¼Œè¿™å°†ä¸ºå¼€å‘äººå‘˜æä¾›æ›´å¤§çš„çµæ´»æ€§æ¥æ”¹å˜æœªæ¥ï¼Œä½†ä»ç„¶æ³„éœ²äº†å…·ä½“åˆ—è¡¨ä½¿ç”¨æŠ½è±¡å®ç°çš„ç»†èŠ‚ã€‚\ngo // AbstractList æ˜¯å„ç§å®ä½“åˆ—è¡¨çš„é€šç”¨å®ç°ã€‚ type AbstractList interface { Add(Entity) Remove(Entity) } // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { AbstractList } go // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { list AbstractList } // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *ConcreteList) Add(e Entity) { l.list.Add(e) } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *ConcreteList) Remove(e Entity) { l.list.Remove(e) } æ— è®ºæ˜¯ä½¿ç”¨åµŒå…¥å¼ç»“æ„è¿˜æ˜¯ä½¿ç”¨åµŒå…¥å¼æ¥å£ï¼ŒåµŒå…¥å¼ç±»å‹éƒ½ä¼šé™åˆ¶ç±»å‹çš„æ¼”åŒ–.\n å‘åµŒå…¥å¼æ¥å£æ·»åŠ æ–¹æ³•æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ åˆ é™¤åµŒå…¥ç±»å‹æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å³ä½¿ä½¿ç”¨æ»¡è¶³ç›¸åŒæ¥å£çš„æ›¿ä»£æ–¹æ³•æ›¿æ¢åµŒå…¥ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚  å°½ç®¡ç¼–å†™è¿™äº›å§”æ‰˜æ–¹æ³•æ˜¯ä¹å‘³çš„ï¼Œä½†æ˜¯é¢å¤–çš„å·¥ä½œéšè—äº†å®ç°ç»†èŠ‚ï¼Œç•™ä¸‹äº†æ›´å¤šçš„æ›´æ”¹æœºä¼šï¼Œè¿˜æ¶ˆé™¤äº†åœ¨æ–‡æ¡£ä¸­å‘ç°å®Œæ•´åˆ—è¡¨æ¥å£çš„é—´æ¥æ€§æ“ä½œã€‚\né¿å…ä½¿ç”¨å†…ç½®åç§° goè¯­è¨€è§„èŒƒlanguage specification æ¦‚è¿°äº†å‡ ä¸ªå†…ç½®çš„ï¼Œ ä¸åº”åœ¨ goé¡¹ç›®ä¸­ä½¿ç”¨çš„åç§°æ ‡è¯†[predeclared identifiers]ã€‚\næ ¹æ®ä¸Šä¸‹æ–‡çš„ä¸åŒï¼Œå°†è¿™äº›æ ‡è¯†ç¬¦ä½œä¸ºåç§°é‡å¤ä½¿ç”¨ï¼Œ å°†åœ¨å½“å‰ä½œç”¨åŸŸï¼ˆæˆ–ä»»ä½•åµŒå¥—ä½œç”¨åŸŸï¼‰ä¸­éšè—åŸå§‹æ ‡è¯†ç¬¦ï¼Œæˆ–è€…æ··æ·†ä»£ç ã€‚ åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼›åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ä»£ç å¯èƒ½ä¼šå¼•å…¥æ½œåœ¨çš„ã€éš¾ä»¥æ¢å¤çš„é”™è¯¯ã€‚\ngolang.org/ref/spec [predeclared identifiers]: https:// golang.org/ref/spec#Predeclared_identifiers\ngo var error string // `error` ä½œç”¨åŸŸéšå¼è¦†ç›– // or func handleErrorMessage(error string) { // `error` ä½œç”¨åŸŸéšå¼è¦†ç›– } go var errorMessage string // `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›– // or func handleErrorMessage(msg string) { // `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›– } go type Foo struct { // è™½ç„¶è¿™äº›å­—æ®µåœ¨æŠ€æœ¯ä¸Šä¸æ„æˆé˜´å½±ï¼Œä½†`error`æˆ–`string`å­—ç¬¦ä¸²çš„é‡æ˜ å°„ç°åœ¨æ˜¯ä¸æ˜ç¡®çš„ã€‚ error error string string } func (f Foo) Error() error { // `error` å’Œ `f.error` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.error } func (f Foo) String() string { // `string` and `f.string` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.string } go type Foo struct { // `error` and `string` ç°åœ¨æ˜¯æ˜ç¡®çš„ã€‚ err error str string } func (f Foo) Error() error { return f.err } func (f Foo) String() string { return f.str } æ³¨æ„ï¼Œç¼–è¯‘å™¨åœ¨ä½¿ç”¨é¢„å…ˆåˆ†éš”çš„æ ‡è¯†ç¬¦æ—¶ä¸ä¼šç”Ÿæˆé”™è¯¯ï¼Œ ä½†æ˜¯è¯¸å¦‚ go vetä¹‹ç±»çš„å·¥å…·ä¼šæ­£ç¡®åœ°æŒ‡å‡ºè¿™äº›å’Œå…¶ä»–æƒ…å†µä¸‹çš„éšå¼é—®é¢˜ã€‚\né¿å…ä½¿ç”¨ init() å°½å¯èƒ½é¿å…ä½¿ç”¨init()ã€‚å½“init()æ˜¯ä¸å¯é¿å…æˆ–å¯å–çš„ï¼Œä»£ç åº”å…ˆå°è¯•ï¼š\n æ— è®ºç¨‹åºç¯å¢ƒæˆ–è°ƒç”¨å¦‚ä½•ï¼Œéƒ½è¦å®Œå…¨ç¡®å®šã€‚ é¿å…ä¾èµ–äºå…¶ä»–init()å‡½æ•°çš„é¡ºåºæˆ–å‰¯ä½œç”¨ã€‚è™½ç„¶init()é¡ºåºæ˜¯æ˜ç¡®çš„ï¼Œä½†ä»£ç å¯ä»¥æ›´æ”¹ï¼Œ å› æ­¤init()å‡½æ•°ä¹‹é—´çš„å…³ç³»å¯èƒ½ä¼šä½¿ä»£ç å˜å¾—è„†å¼±å’Œå®¹æ˜“å‡ºé”™ã€‚ é¿å…è®¿é—®æˆ–æ“ä½œå…¨å±€æˆ–ç¯å¢ƒçŠ¶æ€ï¼Œå¦‚æœºå™¨ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€ç¨‹åºå‚æ•°/è¾“å…¥ç­‰ã€‚ é¿å…I/Oï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œç³»ç»Ÿè°ƒç”¨ã€‚  ä¸èƒ½æ»¡è¶³è¿™äº›è¦æ±‚çš„ä»£ç å¯èƒ½å±äºè¦ä½œä¸ºmain()è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­çš„å…¶ä»–åœ°æ–¹ï¼‰ï¼Œ æˆ–è€…ä½œä¸ºmain()æœ¬èº«çš„ä¸€éƒ¨åˆ†å†™å…¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‰“ç®—ç”±å…¶ä»–ç¨‹åºä½¿ç”¨çš„åº“åº”è¯¥ç‰¹åˆ«æ³¨æ„å®Œå…¨ç¡®å®šæ€§ï¼Œ è€Œä¸æ˜¯æ‰§è¡Œâ€œinit magicâ€\ngo type Foo struct { // ... } var _defaultFoo Foo func init() { _defaultFoo = Foo{ // ... } } go var _defaultFoo = Foo{ // ... } // or, ä¸ºäº†æ›´å¥½çš„å¯æµ‹è¯•æ€§: var _defaultFoo = defaultFoo() func defaultFoo() Foo { return Foo{ // ... } } go type Config struct { // ... } var _config Config func init() { // Bad: åŸºäºå½“å‰ç›®å½• cwd, _ := os.Getwd() // Bad: I/O raw, _ := ioutil.ReadFile( path.Join(cwd, \u0026quot;config\u0026quot;, \u0026quot;config.yaml\u0026quot;), ) yaml.Unmarshal(raw, \u0026amp;_config) } go type Config struct { // ... } func loadConfig() Config { cwd, err := os.Getwd() // handle err raw, err := ioutil.ReadFile( path.Join(cwd, \u0026quot;config\u0026quot;, \u0026quot;config.yaml\u0026quot;), ) // handle err var config Config yaml.Unmarshal(raw, \u0026amp;config) return config } è€ƒè™‘åˆ°ä¸Šè¿°æƒ…å†µï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œinit()å¯èƒ½æ›´å¯å–æˆ–æ˜¯å¿…è¦çš„ï¼Œå¯èƒ½åŒ…æ‹¬ï¼š\n  ä¸èƒ½è¡¨ç¤ºä¸ºå•ä¸ªèµ‹å€¼çš„å¤æ‚è¡¨è¾¾å¼ã€‚\n  å¯æ’å…¥çš„é’©å­ï¼Œå¦‚database/sqlã€ç¼–ç ç±»å‹æ³¨å†Œè¡¨ç­‰ã€‚\n  å¯¹google Cloud Functionså’Œå…¶ä»–å½¢å¼çš„ç¡®å®šæ€§é¢„è®¡ç®—çš„ä¼˜åŒ–ã€‚\ngoogle.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations\n  è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡ è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡\nåœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨åˆå§‹åŒ–è¦è¿½åŠ çš„åˆ‡ç‰‡æ—¶ä¸ºmake()æä¾›ä¸€ä¸ªå®¹é‡å€¼ã€‚\ngo for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } go for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0, size) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } BenchmarkBad-4 100000000 2.48s Benchmark good-4 100000000 0.21s ä¸»å‡½æ•°é€€å‡ºæ–¹å¼(Exit) goç¨‹åºä½¿ç”¨os.Exit æˆ–è€… [log.Fatal*] ç«‹å³é€€å‡º (ä½¿ç”¨panicä¸æ˜¯é€€å‡ºç¨‹åºçš„å¥½æ–¹æ³•ï¼Œè¯· don\u0026rsquo;t panic.)\ngolang.org/pkg/os/#Exit [log.Fatal*]: https:// golang.org/pkg/log/#Fatal\n**ä»…åœ¨mainï¼ˆï¼‰**ä¸­è°ƒç”¨å…¶ä¸­ä¸€ä¸ª os.Exit æˆ–è€… log.Fatal*ã€‚æ‰€æœ‰å…¶ä»–å‡½æ•°åº”å°†é”™è¯¯è¿”å›åˆ°ä¿¡å·å¤±è´¥ä¸­ã€‚\ngo func main() { body := readFile(path) fmt.Println(body) } func readFile(path string) string { f, err := os.Open(path) if err != nil { log.Fatal(err) } b, err := ioutil.ReadAll(f) if err != nil { log.Fatal(err) } return string(b) } go func main() { body, err := readFile(path) if err != nil { log.Fatal(err) } fmt.Println(body) } func readFile(path string) (string, error) { f, err := os.Open(path) if err != nil { return \u0026quot;\u0026quot;, err } b, err := ioutil.ReadAll(f) if err != nil { return \u0026quot;\u0026quot;, err } return string(b), nil } åŸåˆ™ä¸Šï¼šé€€å‡ºçš„å…·æœ‰å¤šç§åŠŸèƒ½çš„ç¨‹åºå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š\n ä¸æ˜æ˜¾çš„æ§åˆ¶æµï¼šä»»ä½•å‡½æ•°éƒ½å¯ä»¥é€€å‡ºç¨‹åºï¼Œå› æ­¤å¾ˆéš¾å¯¹æ§åˆ¶æµè¿›è¡Œæ¨ç†ã€‚ éš¾ä»¥æµ‹è¯•ï¼šé€€å‡ºç¨‹åºçš„å‡½æ•°ä¹Ÿå°†é€€å‡ºè°ƒç”¨å®ƒçš„æµ‹è¯•ã€‚è¿™ä½¿å¾—å‡½æ•°å¾ˆéš¾æµ‹è¯•ï¼Œå¹¶å¼•å…¥äº†è·³è¿‡  go test å°šæœªè¿è¡Œçš„å…¶ä»–æµ‹è¯•çš„é£é™©ã€‚ è·³è¿‡æ¸…ç†ï¼šå½“å‡½æ•°é€€å‡ºç¨‹åºæ—¶ï¼Œä¼šè·³è¿‡å·²ç»è¿›å…¥deferé˜Ÿåˆ—é‡Œçš„å‡½æ•°è°ƒç”¨ã€‚è¿™å¢åŠ äº†è·³è¿‡é‡è¦æ¸…ç†ä»»åŠ¡çš„é£é™©ã€‚  ä¸€æ¬¡æ€§é€€å‡º å¦‚æœå¯èƒ½çš„è¯ï¼Œä½ çš„mainï¼ˆï¼‰å‡½æ•°ä¸­æœ€å¤šä¸€æ¬¡ è°ƒç”¨ os.Exitæˆ–è€…log.Fatalã€‚å¦‚æœæœ‰å¤šä¸ªé”™è¯¯åœºæ™¯åœæ­¢ç¨‹åºæ‰§è¡Œï¼Œè¯·å°†è¯¥é€»è¾‘æ”¾åœ¨å•ç‹¬çš„å‡½æ•°ä¸‹å¹¶ä»ä¸­è¿”å›é”™è¯¯ã€‚ è¿™ä¼šç¼©çŸ­ main()å‡½æ•°ï¼Œå¹¶å°†æ‰€æœ‰å…³é”®ä¸šåŠ¡é€»è¾‘æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„ã€å¯æµ‹è¯•çš„å‡½æ•°ä¸­ã€‚\ngo package main func main() { args := os.Args[1:] if len(args) != 1 { log.Fatal(\u0026quot;missing file\u0026quot;) } name := args[0] f, err := os.Open(name) if err != nil { log.Fatal(err) } defer f.Close() // å¦‚æœæˆ‘ä»¬è°ƒç”¨log.Fatal åœ¨è¿™æ¡çº¿ä¹‹å // f.Close å°†ä¼šè¢«æ‰§è¡Œ. b, err := ioutil.ReadAll(f) if err != nil { log.Fatal(err) } // ... } go package main func main() { if err := run(); err != nil { log.Fatal(err) } } func run() error { args := os.Args[1:] if len(args) != 1 { return errors.New(\u0026quot;missing file\u0026quot;) } name := args[0] f, err := os.Open(name) if err != nil { return err } defer f.Close() b, err := ioutil.ReadAll(f) if err != nil { return err } // ... } æ€§èƒ½ æ€§èƒ½æ–¹é¢çš„ç‰¹å®šå‡†åˆ™åªé€‚ç”¨äºé«˜é¢‘åœºæ™¯ã€‚\nä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmt å°†åŸè¯­è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä»å­—ç¬¦ä¸²è½¬æ¢æ—¶ï¼Œstrconvé€Ÿåº¦æ¯”fmtå¿«ã€‚\ngo for i := 0; i \u0026lt; b.N; i++ { s := fmt.Sprint(rand.Int()) } go for i := 0; i \u0026lt; b.N; i++ { s := strconv.Itoa(rand.Int()) } BenchmarkFmtSprint-4 143 ns/op 2 allocs/op BenchmarkStrconv-4 64.2 ns/op 1 allocs/op é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢ ä¸è¦åå¤ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceã€‚ç›¸åï¼Œè¯·æ‰§è¡Œä¸€æ¬¡è½¬æ¢å¹¶æ•è·ç»“æœã€‚\ngo for i := 0; i \u0026lt; b.N; i++ { w.Write([]byte(\u0026quot;Hello world\u0026quot;)) } go data := []byte(\u0026quot;Hello world\u0026quot;) for i := 0; i \u0026lt; b.N; i++ { w.Write(data) } BenchmarkBad-4 50000000 22.2 ns/op Benchmark good-4 500000000 3.25 ns/op æŒ‡å®šå®¹å™¨å®¹é‡ å°½å¯èƒ½æŒ‡å®šå®¹å™¨å®¹é‡ï¼Œä»¥ä¾¿ä¸ºå®¹å™¨é¢„å…ˆåˆ†é…å†…å­˜ã€‚è¿™å°†åœ¨æ·»åŠ å…ƒç´ æ—¶æœ€å°åŒ–åç»­åˆ†é…ï¼ˆé€šè¿‡å¤åˆ¶å’Œè°ƒæ•´å®¹å™¨å¤§å°ï¼‰ã€‚\næŒ‡å®šMapå®¹é‡æç¤º åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨ make() åˆå§‹åŒ–çš„æ—¶å€™æä¾›å®¹é‡ä¿¡æ¯\ngo make(map[T1]T2, hint) å‘make()æä¾›å®¹é‡æç¤ºä¼šåœ¨åˆå§‹åŒ–æ—¶å°è¯•è°ƒæ•´mapçš„å¤§å°ï¼Œè¿™å°†å‡å°‘åœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ä¸ºmapé‡æ–°åˆ†é…å†…å­˜ã€‚\næ³¨æ„ï¼Œä¸slicesä¸åŒã€‚map capacityæç¤ºå¹¶ä¸ä¿è¯å®Œå…¨çš„æŠ¢å å¼åˆ†é…ï¼Œè€Œæ˜¯ç”¨äºä¼°è®¡æ‰€éœ€çš„hashmap bucketçš„æ•°é‡ã€‚ å› æ­¤ï¼Œåœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ï¼Œç”šè‡³åœ¨æŒ‡å®šmapå®¹é‡æ—¶ï¼Œä»å¯èƒ½å‘ç”Ÿåˆ†é…ã€‚\ngo m := make(map[string]os.FileInfo) files, _ := ioutil.ReadDir(\u0026quot;./files\u0026quot;) for _, f := range files { m[f.Name()] = f } go files, _ := ioutil.ReadDir(\u0026quot;./files\u0026quot;) m := make(map[string]os.FileInfo, len(files)) for _, f := range files { m[f.Name()] = f } m æ˜¯åœ¨æ²¡æœ‰å¤§å°æç¤ºçš„æƒ…å†µä¸‹åˆ›å»ºçš„ï¼› åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å¤šåˆ†é…ã€‚\nm æ˜¯æœ‰å¤§å°æç¤ºåˆ›å»ºçš„ï¼›åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å°‘çš„åˆ†é…ã€‚\næŒ‡å®šåˆ‡ç‰‡å®¹é‡ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨make()åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æä¾›å®¹é‡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿½åŠ åˆ‡ç‰‡æ—¶ã€‚\ngo make([]T, length, capacity) ä¸mapsä¸åŒï¼Œslice capacityä¸æ˜¯ä¸€ä¸ªæç¤ºï¼šç¼–è¯‘å™¨å°†ä¸ºæä¾›ç»™make()çš„sliceçš„å®¹é‡åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œ è¿™æ„å‘³ç€åç»­çš„append()`æ“ä½œå°†å¯¼è‡´é›¶åˆ†é…ï¼ˆç›´åˆ°sliceçš„é•¿åº¦ä¸å®¹é‡åŒ¹é…ï¼Œåœ¨æ­¤ä¹‹åï¼Œä»»ä½•appendéƒ½å¯èƒ½è°ƒæ•´å¤§å°ä»¥å®¹çº³å…¶ä»–å…ƒç´ ï¼‰ã€‚\ngo for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } go for n := 0; n \u0026lt; b.N; n++ { data := make([]int, 0, size) for k := 0; k \u0026lt; size; k++{ data = append(data, k) } } BenchmarkBad-4 100000000 2.48s Benchmark good-4 100000000 0.21s è§„èŒƒ ä¸€è‡´æ€§ æœ¬æ–‡ä¸­æ¦‚è¿°çš„ä¸€äº›æ ‡å‡†éƒ½æ˜¯å®¢è§‚æ€§çš„è¯„ä¼°ï¼Œæ˜¯æ ¹æ®åœºæ™¯ã€ä¸Šä¸‹æ–‡ã€æˆ–è€…ä¸»è§‚æ€§çš„åˆ¤æ–­ï¼›\nä½†æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œä¿æŒä¸€è‡´.\nä¸€è‡´æ€§çš„ä»£ç æ›´å®¹æ˜“ç»´æŠ¤ã€æ˜¯æ›´åˆç†çš„ã€éœ€è¦æ›´å°‘çš„å­¦ä¹ æˆæœ¬ã€å¹¶ä¸”éšç€æ–°çš„çº¦å®šå‡ºç°æˆ–è€…å‡ºç°é”™è¯¯åæ›´å®¹æ˜“è¿ç§»ã€æ›´æ–°ã€ä¿®å¤ bug\nç›¸åï¼Œåœ¨ä¸€ä¸ªä»£ç åº“ä¸­åŒ…å«å¤šä¸ªå®Œå…¨ä¸åŒæˆ–å†²çªçš„ä»£ç é£æ ¼ä¼šå¯¼è‡´ç»´æŠ¤æˆæœ¬å¼€é”€ã€ä¸ç¡®å®šæ€§å’Œè®¤çŸ¥åå·®ã€‚æ‰€æœ‰è¿™äº›éƒ½ä¼šç›´æ¥å¯¼è‡´é€Ÿåº¦é™ä½ã€ä»£ç å®¡æŸ¥ç—›è‹¦ã€è€Œä¸”å¢åŠ  bug æ•°é‡ã€‚\nå°†è¿™äº›æ ‡å‡†åº”ç”¨äºä»£ç åº“æ—¶ï¼Œå»ºè®®åœ¨ packageï¼ˆæˆ–æ›´å¤§ï¼‰çº§åˆ«è¿›è¡Œæ›´æ”¹ï¼Œå­åŒ…çº§åˆ«çš„åº”ç”¨ç¨‹åºé€šè¿‡å°†å¤šä¸ªæ ·å¼å¼•å…¥åˆ°åŒä¸€ä»£ç ä¸­ï¼Œè¿åäº†ä¸Šè¿°å…³æ³¨ç‚¹ã€‚\nç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ go è¯­è¨€æ”¯æŒå°†ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªç»„å†…ã€‚\ngo import \u0026quot;a\u0026quot; import \u0026quot;b\u0026quot; go import ( \u0026quot;a\u0026quot; \u0026quot;b\u0026quot; ) è¿™åŒæ ·é€‚ç”¨äºå¸¸é‡ã€å˜é‡å’Œç±»å‹å£°æ˜ï¼š\ngo const a = 1 const b = 2 var a = 1 var b = 2 type Area float64 type Volume float64 go const ( a = 1 b = 2 ) var ( a = 1 b = 2 ) type ( Area float64 Volume float64 ) ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚ä¸è¦å°†ä¸ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚\ngo type Operation int const ( Add Operation = iota + 1 Subtract Multiply EnvVar = \u0026quot;MY_ENV\u0026quot; ) go type Operation int const ( Add Operation = iota + 1 Subtract Multiply ) const EnvVar = \u0026quot;MY_ENV\u0026quot; åˆ†ç»„ä½¿ç”¨çš„ä½ç½®æ²¡æœ‰é™åˆ¶ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å®ƒä»¬ï¼š\ngo func f() string { var red = color.New(0xff0000) var green = color.New(0x00ff00) var blue = color.New(0x0000ff) ... } go func f() string { var ( red = color.New(0xff0000) green = color.New(0x00ff00) blue = color.New(0x0000ff) ) ... } import åˆ†ç»„ å¯¼å…¥åº”è¯¥åˆ†ä¸ºä¸¤ç»„ï¼š\n æ ‡å‡†åº“ å…¶ä»–åº“  é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ goimports åº”ç”¨çš„åˆ†ç»„ã€‚\ngo import ( \u0026quot;fmt\u0026quot; \u0026quot;os\u0026quot; \u0026quot; go.uber.org/atomic\u0026quot; \u0026quot; golang.org/x/sync/errgroup\u0026quot; ) go import ( \u0026quot;fmt\u0026quot; \u0026quot;os\u0026quot; \u0026quot; go.uber.org/atomic\u0026quot; \u0026quot; golang.org/x/sync/errgroup\u0026quot; ) åŒ…å å½“å‘½ååŒ…æ—¶ï¼Œè¯·æŒ‰ä¸‹é¢è§„åˆ™é€‰æ‹©ä¸€ä¸ªåç§°ï¼š\n å…¨éƒ¨å°å†™ã€‚æ²¡æœ‰å¤§å†™æˆ–ä¸‹åˆ’çº¿ã€‚ å¤§å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é‡å‘½åã€‚ ç®€çŸ­è€Œç®€æ´ã€‚è¯·è®°ä½ï¼Œåœ¨æ¯ä¸ªä½¿ç”¨çš„åœ°æ–¹éƒ½å®Œæ•´æ ‡è¯†äº†è¯¥åç§°ã€‚ ä¸ç”¨å¤æ•°ã€‚ä¾‹å¦‚net/urlï¼Œè€Œä¸æ˜¯net/urlsã€‚ ä¸è¦ç”¨â€œcommonâ€ï¼Œâ€œutilâ€ï¼Œâ€œsharedâ€æˆ–â€œlibâ€ã€‚è¿™äº›æ˜¯ä¸å¥½çš„ï¼Œä¿¡æ¯é‡ä¸è¶³çš„åç§°ã€‚  å¦è¯·å‚é˜… Package Names å’Œ [ go åŒ…æ ·å¼æŒ‡å—].\ngolang.org/package-names [ go åŒ…æ ·å¼æŒ‡å—]: https://rakyll.org/style-packages/\nå‡½æ•°å æˆ‘ä»¬éµå¾ª go ç¤¾åŒºå…³äºä½¿ç”¨ MixedCaps ä½œä¸ºå‡½æ•°å çš„çº¦å®šã€‚æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œä¸ºäº†å¯¹ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œåˆ†ç»„ï¼Œå‡½æ•°åå¯èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šTestMyFunction_WhatIsBeingTested.\ngolang.org/doc/effective_ go.html#mixed-caps\nå¯¼å…¥åˆ«å å¦‚æœç¨‹åºåŒ…åç§°ä¸å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸åŒ¹é…ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å¯¼å…¥åˆ«åã€‚\ngo import ( \u0026quot;net/http\u0026quot; client \u0026quot;example.com/client- go\u0026quot; trace \u0026quot;example.com/trace/v2\u0026quot; ) åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œé™¤éå¯¼å…¥ä¹‹é—´æœ‰ç›´æ¥å†²çªï¼Œå¦åˆ™åº”é¿å…å¯¼å…¥åˆ«åã€‚\ngo import ( \u0026quot;fmt\u0026quot; \u0026quot;os\u0026quot; nettrace \u0026quot; golang.net/x/trace\u0026quot; ) go import ( \u0026quot;fmt\u0026quot; \u0026quot;os\u0026quot; \u0026quot;runtime/trace\u0026quot; nettrace \u0026quot; golang.net/x/trace\u0026quot; ) å‡½æ•°åˆ†ç»„ä¸é¡ºåº  å‡½æ•°åº”æŒ‰ç²—ç•¥çš„è°ƒç”¨é¡ºåºæ’åºã€‚ åŒä¸€æ–‡ä»¶ä¸­çš„å‡½æ•°åº”æŒ‰æ¥æ”¶è€…åˆ†ç»„ã€‚  å› æ­¤ï¼Œå¯¼å‡ºçš„å‡½æ•°åº”å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨struct, const, varå®šä¹‰çš„åé¢ã€‚\nåœ¨å®šä¹‰ç±»å‹ä¹‹åï¼Œä½†åœ¨æ¥æ”¶è€…çš„å…¶ä½™æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€ä¸ª newXYZ()/NewXYZ()\nç”±äºå‡½æ•°æ˜¯æŒ‰æ¥æ”¶è€…åˆ†ç»„çš„ï¼Œå› æ­¤æ™®é€šå·¥å…·å‡½æ•°åº”åœ¨æ–‡ä»¶æœ«å°¾å‡ºç°ã€‚\ngo func (s *something) Cost() { return calcCost(s.weights) } type something struct{ ... } func calcCost(n []int) int {...} func (s *something) Stop() {...} func newSomething() *something { return \u0026amp;something{} } go type something struct{ ... } func newSomething() *something { return \u0026amp;something{} } func (s *something) Cost() { return calcCost(s.weights) } func (s *something) Stop() {...} func calcCost(n []int) int {...} å‡å°‘åµŒå¥— ä»£ç åº”é€šè¿‡å°½å¯èƒ½å…ˆå¤„ç†é”™è¯¯æƒ…å†µ/ç‰¹æ®Šæƒ…å†µå¹¶å°½æ—©è¿”å›æˆ–ç»§ç»­å¾ªç¯æ¥å‡å°‘åµŒå¥—ã€‚å‡å°‘åµŒå¥—å¤šä¸ªçº§åˆ«çš„ä»£ç çš„ä»£ç é‡ã€‚\ngo for _, v := range data { if v.F1 == 1 { v = process(v) if err := v.Call(); err == nil { v.Send() } else { return err } } else { log.Printf(\u0026quot;Invalid v: %v\u0026quot;, v) } } go for _, v := range data { if v.F1 != 1 { log.Printf(\u0026quot;Invalid v: %v\u0026quot;, v) continue } v = process(v) if err := v.Call(); err != nil { return err } v.Send() } ä¸å¿…è¦çš„ else å¦‚æœåœ¨ if çš„ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½è®¾ç½®äº†å˜é‡ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºå•ä¸ª ifã€‚\ngo var a int if b { a = 100 } else { a = 10 } go a := 10 if b { a = 100 } é¡¶å±‚å˜é‡å£°æ˜ åœ¨é¡¶å±‚ï¼Œä½¿ç”¨æ ‡å‡†varå…³é”®å­—ã€‚è¯·å‹¿æŒ‡å®šç±»å‹ï¼Œé™¤éå®ƒä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸åŒã€‚\ngo var _s string = F() func F() string { return \u0026quot;A\u0026quot; } go var _s = F() // ç”±äº F å·²ç»æ˜ç¡®äº†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰å¿…è¦æ˜¾å¼æŒ‡å®š_s çš„ç±»å‹ // è¿˜æ˜¯é‚£ç§ç±»å‹ func F() string { return \u0026quot;A\u0026quot; } å¦‚æœè¡¨è¾¾å¼çš„ç±»å‹ä¸æ‰€éœ€çš„ç±»å‹ä¸å®Œå…¨åŒ¹é…ï¼Œè¯·æŒ‡å®šç±»å‹ã€‚\ngo type myError struct{} func (myError) Error() string { return \u0026quot;error\u0026quot; } func F() myError { return myError{} } var _e error = F() // F è¿”å›ä¸€ä¸ª myError ç±»å‹çš„å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¦ error ç±»å‹ å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€ åœ¨æœªå¯¼å‡ºçš„é¡¶çº§varså’Œconstsï¼Œ å‰é¢åŠ ä¸Šå‰ç¼€_ï¼Œä»¥ä½¿å®ƒä»¬åœ¨ä½¿ç”¨æ—¶æ˜ç¡®è¡¨ç¤ºå®ƒä»¬æ˜¯å…¨å±€ç¬¦å·ã€‚\nä¾‹å¤–ï¼šæœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œåº”ä»¥errå¼€å¤´ã€‚\nåŸºæœ¬ä¾æ®ï¼šé¡¶çº§å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸã€‚ä½¿ç”¨é€šç”¨åç§°å¯èƒ½å¾ˆå®¹æ˜“åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯çš„å€¼ã€‚\ngo // foo. go const ( defaultPort = 8080 defaultUser = \u0026quot;user\u0026quot; ) // bar. go func Bar() { defaultPort := 9090 ... fmt.Println(\u0026quot;Default port\u0026quot;, defaultPort) // We will not see a compile error if the first line of // Bar() is deleted. } go // foo. go const ( _defaultPort = 8080 _defaultUser = \u0026quot;user\u0026quot; ) ç»“æ„ä½“ä¸­çš„åµŒå…¥ åµŒå…¥å¼ç±»å‹ï¼ˆä¾‹å¦‚ mutexï¼‰åº”ä½äºç»“æ„ä½“å†…çš„å­—æ®µåˆ—è¡¨çš„é¡¶éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œå°†åµŒå…¥å¼å­—æ®µä¸å¸¸è§„å­—æ®µåˆ†éš”å¼€ã€‚\ngo type Client struct { version int http.Client } go type Client struct { http.Client version int } å†…åµŒåº”è¯¥æä¾›åˆ‡å®çš„å¥½å¤„ï¼Œæ¯”å¦‚ä»¥è¯­ä¹‰ä¸Šåˆé€‚çš„æ–¹å¼æ·»åŠ æˆ–å¢å¼ºåŠŸèƒ½ã€‚ å®ƒåº”è¯¥åœ¨å¯¹ç”¨æˆ·ä¸åˆ©å½±å“çš„æƒ…å†µä¸‹å®Œæˆè¿™é¡¹å·¥ä½œï¼ˆå¦è¯·å‚è§ï¼šé¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹Avoid Embedding Types in Public Structsï¼‰ã€‚\nåµŒå…¥ ä¸åº”è¯¥:\n çº¯ç²¹æ˜¯ä¸ºäº†ç¾è§‚æˆ–æ–¹ä¾¿ã€‚ ä½¿å¤–éƒ¨ç±»å‹æ›´éš¾æ„é€ æˆ–ä½¿ç”¨ã€‚ å½±å“å¤–éƒ¨ç±»å‹çš„é›¶å€¼ã€‚å¦‚æœå¤–éƒ¨ç±»å‹æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ï¼Œåˆ™åœ¨åµŒå…¥å†…éƒ¨ç±»å‹ä¹‹ååº”è¯¥ä»ç„¶æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ã€‚ ä½œä¸ºåµŒå…¥å†…éƒ¨ç±»å‹çš„å‰¯ä½œç”¨ï¼Œä»å¤–éƒ¨ç±»å‹å…¬å¼€ä¸ç›¸å…³çš„å‡½æ•°æˆ–å­—æ®µã€‚ å…¬å¼€æœªå¯¼å‡ºçš„ç±»å‹ã€‚ å½±å“å¤–éƒ¨ç±»å‹çš„å¤åˆ¶å½¢å¼ã€‚ æ›´æ”¹å¤–éƒ¨ç±»å‹çš„APIæˆ–ç±»å‹è¯­ä¹‰ã€‚ åµŒå…¥å†…éƒ¨ç±»å‹çš„éè§„èŒƒå½¢å¼ã€‚ å…¬å¼€å¤–éƒ¨ç±»å‹çš„å®ç°è¯¦ç»†ä¿¡æ¯ã€‚ å…è®¸ç”¨æˆ·è§‚å¯Ÿæˆ–æ§åˆ¶ç±»å‹å†…éƒ¨ã€‚ é€šè¿‡åŒ…è£…çš„æ–¹å¼æ”¹å˜å†…éƒ¨å‡½æ•°çš„ä¸€èˆ¬è¡Œä¸ºï¼Œè¿™ç§åŒ…è£…æ–¹å¼ä¼šç»™ç”¨æˆ·å¸¦æ¥ä¸€äº›æ„æ–™ä¹‹å¤–æƒ…å†µã€‚  ç®€å•åœ°è¯´ï¼Œæœ‰æ„è¯†åœ°å’Œæœ‰ç›®çš„åœ°åµŒå…¥ã€‚ä¸€ç§å¾ˆå¥½çš„æµ‹è¯•ä½“éªŒæ˜¯ï¼Œ \u0026ldquo;æ˜¯å¦æ‰€æœ‰è¿™äº›å¯¼å‡ºçš„å†…éƒ¨æ–¹æ³•/å­—æ®µéƒ½å°†ç›´æ¥æ·»åŠ åˆ°å¤–éƒ¨ç±»å‹\u0026rdquo; å¦‚æœç­”æ¡ˆæ˜¯someæˆ–noï¼Œä¸è¦åµŒå…¥å†…éƒ¨ç±»å‹-è€Œæ˜¯ä½¿ç”¨å­—æ®µã€‚\ngo type A struct { // Bad: A.Lock() and A.Unlock() ç°åœ¨å¯ç”¨ // ä¸æä¾›ä»»ä½•åŠŸèƒ½æ€§å¥½å¤„ï¼Œå¹¶å…è®¸ç”¨æˆ·æ§åˆ¶æœ‰å…³Açš„å†…éƒ¨ç»†èŠ‚ã€‚ sync.Mutex } go type countingWriteCloser struct { // good: Write() åœ¨å¤–å±‚æä¾›ç”¨äºç‰¹å®šç›®çš„ï¼Œ // å¹¶ä¸”å§”æ‰˜å·¥ä½œåˆ°å†…éƒ¨ç±»å‹çš„Write()ä¸­ã€‚ io.WriteCloser count int } func (w *countingWriteCloser) Write(bs []byte) (int, error) { w.count += len(bs) return w.WriteCloser.Write(bs) } go type Book struct { // Bad: æŒ‡é’ˆæ›´æ”¹é›¶å€¼çš„æœ‰ç”¨æ€§ io.ReadWriter // other fields } // later var b Book b.Read(...) // panic: nil pointer b.String() // panic: nil pointer b.Write(...) // panic: nil pointer go type Book struct { // good: æœ‰ç”¨çš„é›¶å€¼ bytes.Buffer // other fields } // later var b Book b.Read(...) // ok b.String() // ok b.Write(...) // ok go type Client struct { sync.Mutex sync.WaitGroup bytes.Buffer url.URL } go type Client struct { mtx sync.Mutex wg sync.WaitGroup buf bytes.Buffer url url.URL } ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ä½“ åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œåº”è¯¥æŒ‡å®šå­—æ®µåç§°ã€‚ç°åœ¨ç”±  go vet å¼ºåˆ¶æ‰§è¡Œã€‚\ngolang.org/cmd/vet/\ngo k := User{\u0026quot;John\u0026quot;, \u0026quot;Doe\u0026quot;, true} go k := User{ FirstName: \u0026quot;John\u0026quot;, LastName: \u0026quot;Doe\u0026quot;, Admin: true, } ä¾‹å¤–ï¼šå¦‚æœæœ‰ 3 ä¸ªæˆ–æ›´å°‘çš„å­—æ®µï¼Œåˆ™å¯ä»¥åœ¨æµ‹è¯•è¡¨ä¸­çœç•¥å­—æ®µåç§°ã€‚\ngo tests := []struct{ op Operation want string }{ {Add, \u0026quot;add\u0026quot;}, {Subtract, \u0026quot;subtract\u0026quot;}, } æœ¬åœ°å˜é‡å£°æ˜ å¦‚æœå°†å˜é‡æ˜ç¡®è®¾ç½®ä¸ºæŸä¸ªå€¼ï¼Œåˆ™åº”ä½¿ç”¨çŸ­å˜é‡å£°æ˜å½¢å¼ (:=)ã€‚\ngo var s = \u0026quot;foo\u0026quot; go s := \u0026quot;foo\u0026quot; ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œvar ä½¿ç”¨å…³é”®å­—æ—¶é»˜è®¤å€¼ä¼šæ›´æ¸…æ™°ã€‚ä¾‹å¦‚ï¼Œå£°æ˜ç©ºåˆ‡ç‰‡ã€‚\ngolang/ go/wiki/CodeReviewComments#declaring-empty-slices\ngo func f(list []int) { filtered := []int{} for _, v := range list { if v \u0026gt; 10 { filtered = append(filtered, v) } } } go func f(list []int) { var filtered []int for _, v := range list { if v \u0026gt; 10 { filtered = append(filtered, v) } } } nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slice nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é•¿åº¦ä¸º 0 çš„ sliceï¼Œè¿™æ„å‘³ç€ï¼Œ\n  æ‚¨ä¸åº”æ˜ç¡®è¿”å›é•¿åº¦ä¸ºé›¶çš„åˆ‡ç‰‡ã€‚åº”è¯¥è¿”å›nil æ¥ä»£æ›¿ã€‚\n  goodgo if x == \u0026quot;\u0026quot; { return []int{} } go if x == \u0026quot;\u0026quot; { return nil }   è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œè¯·å§‹ç»ˆä½¿ç”¨len(s) == 0ã€‚è€Œé nilã€‚\n  goodgo func isEmpty(s []string) bool { return s == nil } go func isEmpty(s []string) bool { return len(s) == 0 }   é›¶å€¼åˆ‡ç‰‡ï¼ˆç”¨varå£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨make()åˆ›å»ºã€‚\n  goodgo nums := []int{} // or, nums := make([]int) if add1 { nums = append(nums, 1) } if add2 { nums = append(nums, 2) } go var nums []int if add1 { nums = append(nums, 1) } if add2 { nums = append(nums, 2) } è®°ä½ï¼Œè™½ç„¶nilåˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„åˆ‡ç‰‡ï¼Œä½†å®ƒä¸ç­‰äºé•¿åº¦ä¸º0çš„åˆ‡ç‰‡ï¼ˆä¸€ä¸ªä¸ºnilï¼Œå¦ä¸€ä¸ªä¸æ˜¯ï¼‰ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚åºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¸¤ä¸ªåˆ‡ç‰‡çš„å¤„ç†æ–¹å¼å¯èƒ½ä¸åŒã€‚\nç¼©å°å˜é‡ä½œç”¨åŸŸ å¦‚æœæœ‰å¯èƒ½ï¼Œå°½é‡ç¼©å°å˜é‡ä½œç”¨èŒƒå›´ã€‚é™¤éå®ƒä¸ å‡å°‘åµŒå¥—çš„è§„åˆ™å†²çªã€‚\ngo err := ioutil.WriteFile(name, data, 0644) if err != nil { return err } go if err := ioutil.WriteFile(name, data, 0644); err != nil { return err } å¦‚æœéœ€è¦åœ¨ if ä¹‹å¤–ä½¿ç”¨å‡½æ•°è°ƒç”¨çš„ç»“æœï¼Œåˆ™ä¸åº”å°è¯•ç¼©å°èŒƒå›´ã€‚\ngo if data, err := ioutil.ReadFile(name); err == nil { err = cfg.Decode(data) if err != nil { return err } fmt.Println(cfg) return nil } else { return err } go data, err := ioutil.ReadFile(name) if err != nil { return err } if err := cfg.Decode(data); err != nil { return err } fmt.Println(cfg) return nil é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜ç¡®(Avoid Naked Parameters) å‡½æ•°è°ƒç”¨ä¸­çš„æ„ä¹‰ä¸æ˜ç¡®çš„å‚æ•°å¯èƒ½ä¼šæŸå®³å¯è¯»æ€§ã€‚å½“å‚æ•°åç§°çš„å«ä¹‰ä¸æ˜æ˜¾æ—¶ï¼Œè¯·ä¸ºå‚æ•°æ·»åŠ  C æ ·å¼æ³¨é‡Š (/* ... */)\ngo // func printInfo(name string, isLocal, done bool) printInfo(\u0026quot;foo\u0026quot;, true, true) go // func printInfo(name string, isLocal, done bool) printInfo(\u0026quot;foo\u0026quot;, true /* isLocal */, true /* done */) å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯å°†ä¸Šé¢çš„ bool ç±»å‹æ¢æˆè‡ªå®šä¹‰ç±»å‹ã€‚å°†æ¥ï¼Œè¯¥å‚æ•°å¯ä»¥æ”¯æŒä¸ä»…ä»…å±€é™äºä¸¤ä¸ªçŠ¶æ€ï¼ˆtrue/falseï¼‰ã€‚\ngo type Region int const ( UnknownRegion Region = iota Local ) type Status int const ( StatusReady Status= iota + 1 StatusDone // Maybe we will have a StatusInProgress in the future. ) func printInfo(name string, region Region, status Status) ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰ go æ”¯æŒä½¿ç”¨ [åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼](https:// golang.org/ref/spec#raw_string_lit)ï¼Œä¹Ÿå°±æ˜¯ \u0026quot; ` \u0026quot; æ¥è¡¨ç¤ºåŸç”Ÿå­—ç¬¦ä¸²ï¼Œåœ¨éœ€è¦è½¬ä¹‰çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¥æ›¿æ¢ã€‚\nå¯ä»¥è·¨è¶Šå¤šè¡Œå¹¶åŒ…å«å¼•å·ã€‚ä½¿ç”¨è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é¿å…æ›´éš¾é˜…è¯»çš„æ‰‹å·¥è½¬ä¹‰çš„å­—ç¬¦ä¸²ã€‚\ngo wantError := \u0026quot;unknown name:\\\u0026quot;test\\\u0026quot;\u0026quot; go wantError := `unknown error:\u0026quot;test\u0026quot;` åˆå§‹åŒ–ç»“æ„ä½“ ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ åˆå§‹åŒ–ç»“æ„æ—¶ï¼Œå‡ ä¹åº”è¯¥å§‹ç»ˆæŒ‡å®šå­—æ®µåã€‚ç›®å‰ç”± go vetå¼ºåˆ¶æ‰§è¡Œã€‚\ngolang.org/cmd/vet/\ngo k := User{\u0026quot;John\u0026quot;, \u0026quot;Doe\u0026quot;, true} go k := User{ FirstName: \u0026quot;John\u0026quot;, LastName: \u0026quot;Doe\u0026quot;, Admin: true, } ä¾‹å¤–ï¼šå½“æœ‰3ä¸ªæˆ–æ›´å°‘çš„å­—æ®µæ—¶ï¼Œæµ‹è¯•è¡¨ä¸­çš„å­—æ®µåmayå¯ä»¥çœç•¥ã€‚\ngo tests := []struct{ op Operation want string }{ {Add, \u0026quot;add\u0026quot;}, {Subtract, \u0026quot;subtract\u0026quot;}, } çœç•¥ç»“æ„ä¸­çš„é›¶å€¼å­—æ®µ åˆå§‹åŒ–å…·æœ‰å­—æ®µåçš„ç»“æ„æ—¶ï¼Œé™¤éæä¾›æœ‰æ„ä¹‰çš„ä¸Šä¸‹æ–‡ï¼Œå¦åˆ™å¿½ç•¥å€¼ä¸ºé›¶çš„å­—æ®µã€‚ ä¹Ÿå°±æ˜¯ï¼Œè®©æˆ‘ä»¬è‡ªåŠ¨å°†è¿™äº›è®¾ç½®ä¸ºé›¶å€¼\ngo user := User{ FirstName: \u0026quot;John\u0026quot;, LastName: \u0026quot;Doe\u0026quot;, MiddleName: \u0026quot;\u0026quot;, Admin: false, } go user := User{ FirstName: \u0026quot;John\u0026quot;, LastName: \u0026quot;Doe\u0026quot;, } è¿™æœ‰åŠ©äºé€šè¿‡çœç•¥è¯¥ä¸Šä¸‹æ–‡ä¸­çš„é»˜è®¤å€¼æ¥å‡å°‘é˜…è¯»çš„éšœç¢ã€‚åªæŒ‡å®šæœ‰æ„ä¹‰çš„å€¼ã€‚\nåœ¨å­—æ®µåæä¾›æœ‰æ„ä¹‰ä¸Šä¸‹æ–‡çš„åœ°æ–¹åŒ…å«é›¶å€¼ã€‚ä¾‹å¦‚ï¼Œè¡¨é©±åŠ¨æµ‹è¯• ä¸­çš„æµ‹è¯•ç”¨ä¾‹å¯ä»¥å—ç›Šäºå­—æ®µçš„åç§°ï¼Œå³ä½¿å®ƒä»¬æ˜¯é›¶å€¼çš„ã€‚\ngo tests := []struct{ give string want int }{ {give: \u0026quot;0\u0026quot;, want: 0}, // ... } å¯¹é›¶å€¼ç»“æ„ä½¿ç”¨ var å¦‚æœåœ¨å£°æ˜ä¸­çœç•¥äº†ç»“æ„çš„æ‰€æœ‰å­—æ®µï¼Œè¯·ä½¿ç”¨ var å£°æ˜ç»“æ„ã€‚\ngo user := User{} go var user User è¿™å°†é›¶å€¼ç»“æ„ä¸é‚£äº›å…·æœ‰ç±»ä¼¼äºä¸º[åˆå§‹åŒ– Maps]åˆ›å»ºçš„,åŒºåˆ«äºéé›¶å€¼å­—æ®µçš„ç»“æ„åŒºåˆ†å¼€æ¥ï¼Œ å¹¶ä¸æˆ‘ä»¬æ›´å–œæ¬¢çš„declare empty slicesæ–¹å¼ç›¸åŒ¹é…ã€‚\nåˆå§‹åŒ– Struct å¼•ç”¨ åœ¨åˆå§‹åŒ–ç»“æ„å¼•ç”¨æ—¶ï¼Œè¯·ä½¿ç”¨\u0026amp;T{}ä»£æ›¿new(T)ï¼Œä»¥ä½¿å…¶ä¸ç»“æ„ä½“åˆå§‹åŒ–ä¸€è‡´ã€‚\ngo sval := T{Name: \u0026quot;foo\u0026quot;} // inconsistent sptr := new(T) sptr.Name = \u0026quot;bar\u0026quot; go sval := T{Name: \u0026quot;foo\u0026quot;} sptr := \u0026amp;T{Name: \u0026quot;bar\u0026quot;} åˆå§‹åŒ– Maps å¯¹äºç©º map è¯·ä½¿ç”¨ make(..) åˆå§‹åŒ–ï¼Œ å¹¶ä¸” map æ˜¯é€šè¿‡ç¼–ç¨‹æ–¹å¼å¡«å……çš„ã€‚ è¿™ä½¿å¾— map åˆå§‹åŒ–åœ¨è¡¨ç°ä¸Šä¸åŒäºå£°æ˜ï¼Œå¹¶ä¸”å®ƒè¿˜å¯ä»¥æ–¹ä¾¿åœ°åœ¨ make åæ·»åŠ å¤§å°æç¤ºã€‚\ngo var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = map[T1]T2{} m2 map[T1]T2 ) go var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = make(map[T1]T2) m2 map[T1]T2 ) å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼çš„ã€‚\nå£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥å·®åˆ«éå¸¸å¤§ã€‚\nåœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œè¯·åœ¨åˆå§‹åŒ–æ—¶æä¾› map å®¹é‡å¤§å°ï¼Œè¯¦ç»†è¯·çœ‹ æŒ‡å®šMapå®¹é‡æç¤ºã€‚\nå¦å¤–ï¼Œå¦‚æœ map åŒ…å«å›ºå®šçš„å…ƒç´ åˆ—è¡¨ï¼Œåˆ™ä½¿ç”¨ map literals(map åˆå§‹åŒ–åˆ—è¡¨) åˆå§‹åŒ–æ˜ å°„ã€‚\ngo m := make(map[T1]T2, 3) m[k1] = v1 m[k2] = v2 m[k3] = v3 go m := map[T1]T2{ k1: v1, k2: v2, k3: v3, } åŸºæœ¬å‡†åˆ™æ˜¯ï¼šåœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ map åˆå§‹åŒ–åˆ—è¡¨ æ¥æ·»åŠ ä¸€ç»„å›ºå®šçš„å…ƒç´ ã€‚å¦åˆ™ä½¿ç”¨ make (å¦‚æœå¯ä»¥ï¼Œè¯·å°½é‡æŒ‡å®š map å®¹é‡)ã€‚\nå­—ç¬¦ä¸² string format å¦‚æœä½ åœ¨å‡½æ•°å¤–å£°æ˜Printf-style å‡½æ•°çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œè¯·å°†å…¶è®¾ç½®ä¸ºconstå¸¸é‡ã€‚\nè¿™æœ‰åŠ©äº go vetå¯¹æ ¼å¼å­—ç¬¦ä¸²æ‰§è¡Œé™æ€åˆ†æã€‚\ngo msg := \u0026quot;unexpected values %v, %v\\n\u0026quot; fmt.Printf(msg, 1, 2) go const msg = \u0026quot;unexpected values %v, %v\\n\u0026quot; fmt.Printf(msg, 1, 2) å‘½å Printf æ ·å¼çš„å‡½æ•° å£°æ˜Printf-style å‡½æ•°æ—¶ï¼Œè¯·ç¡®ä¿ go vetå¯ä»¥æ£€æµ‹åˆ°å®ƒå¹¶æ£€æŸ¥æ ¼å¼å­—ç¬¦ä¸²ã€‚\nè¿™æ„å‘³ç€æ‚¨åº”å°½å¯èƒ½ä½¿ç”¨é¢„å®šä¹‰çš„Printf-style å‡½æ•°åç§°ã€‚ go vetå°†é»˜è®¤æ£€æŸ¥è¿™äº›ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Printf ç³»åˆ—ã€‚\ngolang.org/cmd/vet/#hdr-Printf_family\nå¦‚æœä¸èƒ½ä½¿ç”¨é¢„å®šä¹‰çš„åç§°ï¼Œè¯·ä»¥ f ç»“æŸé€‰æ‹©çš„åç§°ï¼šWrapfï¼Œè€Œä¸æ˜¯Wrapã€‚ go vetå¯ä»¥è¦æ±‚æ£€æŸ¥ç‰¹å®šçš„ Printf æ ·å¼åç§°ï¼Œä½†åç§°å¿…é¡»ä»¥fç»“å°¾ã€‚\n$ go vet -printfuncs=wrapf,statusf å¦è¯·å‚é˜… go vet: Printf family check.\ngo-vet-printf-family-check/\nç¼–ç¨‹æ¨¡å¼ è¡¨é©±åŠ¨æµ‹è¯• å½“æµ‹è¯•é€»è¾‘æ˜¯é‡å¤çš„æ—¶å€™ï¼Œé€šè¿‡ subtests ä½¿ç”¨ table é©±åŠ¨çš„æ–¹å¼ç¼–å†™ case ä»£ç çœ‹ä¸Šå»ä¼šæ›´ç®€æ´ã€‚\ngolang.org/subtests\ngo // func TestSplitHostPort(t *testing.T) host, port, err := net.SplitHostPort(\u0026quot;192.0.2.0:8000\u0026quot;) require.NoError(t, err) assert.Equal(t, \u0026quot;192.0.2.0\u0026quot;, host) assert.Equal(t, \u0026quot;8000\u0026quot;, port) host, port, err = net.SplitHostPort(\u0026quot;192.0.2.0:http\u0026quot;) require.NoError(t, err) assert.Equal(t, \u0026quot;192.0.2.0\u0026quot;, host) assert.Equal(t, \u0026quot;http\u0026quot;, port) host, port, err = net.SplitHostPort(\u0026quot;:8000\u0026quot;) require.NoError(t, err) assert.Equal(t, \u0026quot;\u0026quot;, host) assert.Equal(t, \u0026quot;8000\u0026quot;, port) host, port, err = net.SplitHostPort(\u0026quot;1:8\u0026quot;) require.NoError(t, err) assert.Equal(t, \u0026quot;1\u0026quot;, host) assert.Equal(t, \u0026quot;8\u0026quot;, port) go // func TestSplitHostPort(t *testing.T) tests := []struct{ give string wantHost string wantPort string }{ { give: \u0026quot;192.0.2.0:8000\u0026quot;, wantHost: \u0026quot;192.0.2.0\u0026quot;, wantPort: \u0026quot;8000\u0026quot;, }, { give: \u0026quot;192.0.2.0:http\u0026quot;, wantHost: \u0026quot;192.0.2.0\u0026quot;, wantPort: \u0026quot;http\u0026quot;, }, { give: \u0026quot;:8000\u0026quot;, wantHost: \u0026quot;\u0026quot;, wantPort: \u0026quot;8000\u0026quot;, }, { give: \u0026quot;1:8\u0026quot;, wantHost: \u0026quot;1\u0026quot;, wantPort: \u0026quot;8\u0026quot;, }, } for _, tt := range tests { t.Run(tt.give, func(t *testing.T) { host, port, err := net.SplitHostPort(tt.give) require.NoError(t, err) assert.Equal(t, tt.wantHost, host) assert.Equal(t, tt.wantPort, port) }) } å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨ test table çš„æ–¹å¼åœ¨ä»£ç é€»è¾‘æ‰©å±•çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–°å¢ test caseï¼Œéƒ½ä¼šæ˜¾å¾—æ›´åŠ çš„æ¸…æ™°ã€‚\næˆ‘ä»¬éµå¾ªè¿™æ ·çš„çº¦å®šï¼šå°†ç»“æ„ä½“åˆ‡ç‰‡ç§°ä¸ºtestsã€‚ æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç§°ä¸ºttã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é¼“åŠ±ä½¿ç”¨giveå’Œwantå‰ç¼€è¯´æ˜æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥å’Œè¾“å‡ºå€¼ã€‚\ngo tests := []struct{ give string wantHost string wantPort string }{ // ... } for _, tt := range tests { // ... } åŠŸèƒ½é€‰é¡¹ åŠŸèƒ½é€‰é¡¹æ˜¯ä¸€ç§æ¨¡å¼ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å£°æ˜ä¸€ä¸ªä¸é€æ˜ Option ç±»å‹ï¼Œè¯¥ç±»å‹åœ¨æŸäº›å†…éƒ¨ç»“æ„ä¸­è®°å½•ä¿¡æ¯ã€‚æ‚¨æ¥å—è¿™äº›é€‰é¡¹çš„å¯å˜ç¼–å·ï¼Œå¹¶æ ¹æ®å†…éƒ¨ç»“æ„ä¸Šçš„é€‰é¡¹è®°å½•çš„å…¨éƒ¨ä¿¡æ¯é‡‡å–è¡ŒåŠ¨ã€‚\nå°†æ­¤æ¨¡å¼ç”¨äºæ‚¨éœ€è¦æ‰©å±•çš„æ„é€ å‡½æ•°å’Œå…¶ä»–å…¬å…± API ä¸­çš„å¯é€‰å‚æ•°ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›åŠŸèƒ½ä¸Šå·²ç»å…·æœ‰ä¸‰ä¸ªæˆ–æ›´å¤šå‚æ•°çš„æƒ…å†µä¸‹ã€‚\ngo // package db func Open( addr string, cache bool, logger *zap.Logger ) (*Connection, error) { // ... } go // package db type Option interface { // ... } func WithCache(c bool) Option { // ... } func WithLogger(log *zap.Logger) Option { // ... } // Open creates a connection. func Open( addr string, opts ...Option, ) (*Connection, error) { // ... } å¿…é¡»å§‹ç»ˆæä¾›ç¼“å­˜å’Œè®°å½•å™¨å‚æ•°ï¼Œå³ä½¿ç”¨æˆ·å¸Œæœ›ä½¿ç”¨é»˜è®¤å€¼ã€‚\ngo db.Open(addr, db.DefaultCache, zap.NewNop()) db.Open(addr, db.DefaultCache, log) db.Open(addr, false /* cache */, zap.NewNop()) db.Open(addr, false /* cache */, log) åªæœ‰åœ¨éœ€è¦æ—¶æ‰æä¾›é€‰é¡¹ã€‚\ngo db.Open(addr) db.Open(addr, db.WithLogger(log)) db.Open(addr, db.WithCache(false)) db.Open( addr, db.WithCache(false), db.WithLogger(log), ) Our suggested way of implementing this pattern is with an Option interface that holds an unexported method, recording options on an unexported options struct.\næˆ‘ä»¬å»ºè®®å®ç°æ­¤æ¨¡å¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª Option æ¥å£ï¼Œè¯¥æ¥å£ä¿å­˜ä¸€ä¸ªæœªå¯¼å‡ºçš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªæœªå¯¼å‡ºçš„ options ç»“æ„ä¸Šè®°å½•é€‰é¡¹ã€‚\ngo type options struct { cache bool logger *zap.Logger } type Option interface { apply(*options) } type cacheOption bool func (c cacheOption) apply(opts *options) { opts.cache = bool(c) } func WithCache(c bool) Option { return cacheOption(c) } type loggerOption struct { Log *zap.Logger } func (l loggerOption) apply(opts *options) { opts.logger = l.Log } func WithLogger(log *zap.Logger) Option { return loggerOption{Log: log} } // Open creates a connection. func Open( addr string, opts ...Option, ) (*Connection, error) { options := options{ cache: defaultCache, logger: zap.NewNop(), } for _, o := range opts { o.apply(\u0026amp;options) } // ... } æ³¨æ„: è¿˜æœ‰ä¸€ç§ä½¿ç”¨é—­åŒ…å®ç°è¿™ä¸ªæ¨¡å¼çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ä¸Šé¢çš„æ¨¡å¼ä¸ºä½œè€…æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå¹¶ä¸”æ›´å®¹æ˜“å¯¹ç”¨æˆ·è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•ã€‚ç‰¹åˆ«æ˜¯ï¼Œåœ¨ä¸å¯èƒ½è¿›è¡Œæ¯”è¾ƒçš„æƒ…å†µä¸‹å®ƒå…è®¸åœ¨æµ‹è¯•å’Œæ¨¡æ‹Ÿä¸­å¯¹é€‰é¡¹è¿›è¡Œæ¯”è¾ƒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…è®¸é€‰é¡¹å®ç°å…¶ä»–æ¥å£ï¼ŒåŒ…æ‹¬ fmt.Stringerï¼Œå…è®¸ç”¨æˆ·è¯»å–é€‰é¡¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚\nè¿˜å¯ä»¥å‚è€ƒä¸‹é¢èµ„æ–™ï¼š\n  Self-referential functions and the design of options\n  Functional options for friendly APIs\n  Linting æ¯”ä»»ä½• \u0026ldquo;blessed\u0026rdquo; linter é›†æ›´é‡è¦çš„æ˜¯ï¼Œlintåœ¨ä¸€ä¸ªä»£ç åº“ä¸­å§‹ç»ˆä¿æŒä¸€è‡´ã€‚\næˆ‘ä»¬å»ºè®®è‡³å°‘ä½¿ç”¨ä»¥ä¸‹lintersï¼Œå› ä¸ºæˆ‘è®¤ä¸ºå®ƒä»¬æœ‰åŠ©äºå‘ç°æœ€å¸¸è§çš„é—®é¢˜ï¼Œå¹¶åœ¨ä¸éœ€è¦è§„å®šçš„æƒ…å†µä¸‹ä¸ºä»£ç è´¨é‡å»ºç«‹ä¸€ä¸ªé«˜æ ‡å‡†ï¼š\n  errcheck ä»¥ç¡®ä¿é”™è¯¯å¾—åˆ°å¤„ç†\n  goimports æ ¼å¼åŒ–ä»£ç å’Œç®¡ç† imports\n  [ golint] æŒ‡å‡ºå¸¸è§çš„æ–‡ä½“é”™è¯¯\n  [ govet] åˆ†æä»£ç ä¸­çš„å¸¸è§é”™è¯¯\n  [staticcheck] å„ç§é™æ€åˆ†ææ£€æŸ¥\ngodoc.org/ golang.org/x/tools/cmd/ goimports [ golint]: https://github.com/ golang/lint [ govet]: https:// golang.org/cmd/vet/ [staticcheck]: https://staticcheck.io/\n  Lint Runners æˆ‘ä»¬æ¨è golangci-lint ä½œä¸º go-to lintçš„è¿è¡Œç¨‹åºï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºå®ƒåœ¨è¾ƒå¤§çš„ä»£ç åº“ä¸­çš„æ€§èƒ½ä»¥åŠèƒ½å¤ŸåŒæ—¶é…ç½®å’Œä½¿ç”¨è®¸å¤šè§„èŒƒã€‚è¿™ä¸ªrepoæœ‰ä¸€ä¸ªç¤ºä¾‹é…ç½®æ–‡ä»¶[. golangci.yml]å’Œæ¨èçš„linterè®¾ç½®ã€‚\ngolangci-lint æœ‰[various-linters]å¯ä¾›ä½¿ç”¨ã€‚å»ºè®®å°†ä¸Šè¿°lintersä½œä¸ºåŸºæœ¬setï¼Œæˆ‘ä»¬é¼“åŠ±å›¢é˜Ÿæ·»åŠ å¯¹ä»–ä»¬çš„é¡¹ç›®æœ‰æ„ä¹‰çš„ä»»ä½•é™„åŠ lintersã€‚\ngolangci/ golangci-lint [. golangci.yml]: https://github.com/uber- go/guide/blob/master/. golangci.yml [various-linters]: https:// golangci-lint.run/usage/linters/\nStargazers over time [![Stargazers over time](https://starchart.cc/xxjwxc/uber_ go_guide_cn.svg)](https://starchart.cc/xxjwxc/uber_ go_guide_cn)\n","date":"2021-10-20T22:00:08+08:00","image":"https://zcj-git520.github.io/p/uber-go-%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/1_hu7c5d570e6f1bb8cc35e9c2f13acb3eec_11753_120x120_fill_q75_box_smart1.jpg","permalink":"https://zcj-git520.github.io/p/uber-go-%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/","title":"Uber go è¯­è¨€ç¼–ç è§„èŒƒ"},{"content":"è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€  ç¨‹åºé€šè¿‡ç¼–è¯‘æˆä¸ºä¸€å †çš„æœºå™¨æŒ‡ä»¤å†™å…¥å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¨‹åºåœ¨è¿è¡Œæ˜¯ä¼šå°†å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åœ¨è®¡ç®—æœºçš„å†…å­˜ä¸­ åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒä¸­å¤„äºä»£ç æ®µã€‚ ç¨‹åºä¸­çš„å±€éƒ¨å˜é‡ã€å‡½æ•°çš„å‚æ•°ã€å‡½æ•°çš„è¿”å›å€¼ç­‰æ•°æ®ä¼šä¿å­˜åœ¨è™šæ‹Ÿåœ°å€çš„æ ˆä¸­(æ ˆæ˜¯å…ˆè¿›åå‡ºçš„æ•°æ®ç»“æ„) æ ˆç©ºé—´çš„ç¼–è¯‘å™¨åˆ†é…å’Œé‡Šæ”¾ã€‚ ç¨‹åºçš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ä¼šä¿å­˜åœ¨è™šæ‹Ÿåœ°å€çš„æ•°æ®æ®µ åŠ¨æ€åˆ†é…å†…å­˜çš„åœ°å€ä¼šä¿å­˜åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´çš„å †ä¸Šã€‚å †ç©ºé—´æ˜¯åŠ¨æ€å¼€è¾Ÿçš„å†…å­˜ç©ºé—´ï¼Œéœ€è¦ä¸»åŠ¨å¼€è¾Ÿå’Œé‡Šæ”¾ã€‚æˆ–è€… è°ƒç”¨GCé‡Šæ”¾ \r  å †å†…å­˜ç®¡ç†  å †å†…å­˜ç©ºé—´ä¸æ˜¯ç¼–è¯‘å™¨åˆ†é…ï¼Œè€Œæ˜¯æœ‰ç¨‹åºåŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´ã€‚  æ‰‹åŠ¨åƒåœ¾å›æ”¶  éœ€è¦ç¨‹åºä¸»åŠ¨é‡Šæ”¾æ²¡æœ‰ç”¨çš„æ•°æ®æ‰€åœ¨çš„å †ç©ºé—´ã€‚å¦‚ï¼šc++ä¸­è°ƒç”¨new()å‡½æ•°å‘è®¡ç®—æœºç”³è¯·å¼€è¾Ÿå†…å­˜ç©ºé—´åï¼Œä½¿ç”¨deleteæˆ–delete[]é‡Šæ”¾ä¸éœ€è¦çš„ å †å†…å­˜ç©ºé—´ã€‚è¿™ä¸€ç±»æ˜¯æ‰‹åŠ¨å†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚æ‰‹åŠ¨å†…å­˜åˆ†é…ä½¿ç”¨ä¸æ°å½“ä¹Ÿä¼šé€ æˆï¼šå†…å­˜æ³„éœ² æ‚¬æŒ‚æŒ‡é’ˆçš„é—®é¢˜   è¿‡æ—©é‡Šæ”¾ä¼šé€ æˆæ‚¬æŒ‚æŒ‡é’ˆï¼ˆé‡æŒ‡é’ˆï¼‰ï¼šæå‰é‡Šæ”¾äº†åŠ¨æ€çš„å †å†…å­˜çš„ç©ºé—´ï¼Œå½“ç¨‹åºè®¿é—®è¿™æ®µåœ°å€æ—¶ä¼šæŠ¥é”™ã€‚å› ä¸ºè¿™æ®µæå‰é‡Šæ”¾çš„å†…å­˜ç©ºé—´è¢«æ¸…ç©ºã€ é‡æ–°åˆ†é…æˆ–è€…è¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚é‡Šæ”¾æŒ‡é’ˆæ—¶å°†æŒ‡é’ˆèµ‹å€¼ä¸ºNULLï¼Œåœ¨è®¿é—®æ—¶å¯¹æŒ‡é’ˆè¿›è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºNULL ä¸é‡Šæ”¾å†…å­˜ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼šå †å†…å­˜éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œå½“ç¨‹åºè¿è¡Œç»“æŸä¸é‡Šæ”¾ï¼Œè¿™æ®µå†…å­˜å°±ä¼šè¢«ä¸€ç›´å ç”¨ã€‚å¦‚æœ ä¸€ç›´åœ¨åˆ†é…ä¸é‡Šæ”¾ä¼šä¸€ç›´å ç”¨è®¡ç®—æœºçš„å†…å­˜ï¼Œç›´åˆ°å†…å­˜è¢«å å®Œã€‚å°†newä¸deleteé…å¥—ä½¿ç”¨ï¼Œä½¿ç”¨å·¥å…·æ£€æµ‹æˆ–è€…æ‰“å°å‡ºå †ä¿¡æ¯  è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼ˆGCï¼‰  åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨é‡Šæ”¾æ²¡æœ‰ç”¨çš„æ•°æ®æ‰€åœ¨çš„å †ç©ºé—´ï¼ˆåƒåœ¾å›æ”¶).åœ¨è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­èƒ½ä»æ ˆæˆ–è€…æ•°æ®æ®µçš„æ ¹èŠ‚ç‚¹è¿½è¸ªä¸åˆ°çš„æ•°æ®ä¸ºæ²¡ç”¨çš„æ•°æ® ï¼ˆå†…å­˜åƒåœ¾ï¼‰ï¼Œå¸¸ç”¨çš„ç®—æ³•ï¼šæ ‡è®°æ³•, è®¡æ•°æ³•  æ ‡è®°æ³•å›æ”¶  æ ‡è®°æ³•ï¼šå°†æ ˆæˆ–è€…æ•°æ®æ®µä½œä¸ºæ ¹ï¼ˆrootï¼‰è¿›è¡Œè¿½è¸ª,å°†èƒ½è¿½è¸ªå¾—çš„æ•°æ®ï¼ˆå †ç©ºé—´ï¼‰è¿›è¡Œæ ‡è®°ã€‚æ²¡æœ‰è¢«æ ‡è®°çš„æ•°æ® ï¼ˆå †ç©ºé—´ï¼‰å°±æ˜¯åƒåœ¾ï¼Œå°†è¿™éƒ¨åˆ†åƒåœ¾è¿›è¡Œå›æ”¶ã€‚ä¸‰è‰²æŠ½è±¡ï¼š   åƒåœ¾å›æ”¶å¼€å§‹æ—¶ï¼Œå°†æ‰€æœ‰æ•°æ®ä¸ºç™½è‰² åƒåœ¾å›æ”¶å¼€å§‹æ—¶ï¼Œå°†æ‰€æœ‰çš„æ ˆæˆ–è€…æ•°æ®æ®µçš„æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºç°è‰² åœ¨æ ¹æ®æ ¹èŠ‚ç‚¹è¿›è¡Œè¿½è¸ªï¼Œç›´åˆ°æ‰€æœ‰çš„æ•°æ®èŠ‚ç‚¹è¿½è¸ªç»“æŸåå°†æ ¹èŠ‚ç‚¹ç½®ä¸ºé»‘è‰²ï¼Œåœ¨å°†æ ¹èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹è¿›è¡Œè¿½è¸ª æ‰€æœ‰çš„æ•°æ®èŠ‚ç‚¹éƒ½è¿½è¸ªå®Œåï¼Œä¼šå‰©ä¸‹é»‘è‰²å’Œç™½è‰²çš„æ•°æ®èŠ‚ç‚¹ã€‚é»‘è‰²è¡¨ç¤ºæœ‰ç”¨çš„æ•°æ®ã€‚ç™½è‰²ä¸ºæ— ç”¨çš„æ•°æ®ã€‚å°†ç™½è‰²çš„æ•°æ®è¿›è¡Œå›æ”¶ï¼ˆå †ç©ºé—´çš„é‡Šæ”¾ï¼‰ \r   æ ‡è®°æ³•å®ç°ç®€å•ï¼Œä½†æ˜¯ä¼šé€ æˆå†…å­˜çš„ç¢ç‰‡åŒ–(å†…å­˜å—ä¸­æ˜¯å¯ä½¿ç”¨å°å†…å­˜å—ï¼Œé€ æˆå¤§å†…å­˜å—ä¸èƒ½ä½¿ç”¨è¿™å—å†…å­˜ï¼Œè¿™äº›å°å°å†…å­˜å—ä¹Ÿä¸èƒ½ä½¿ç”¨) å› ä¸ºå†…å­˜ç¢ç‰‡åŒ–çš„é—®é¢˜è¯ç”Ÿäº†   æ ‡è®°æ•´ç†æ³•ï¼Œå°±æ˜¯æ ‡è®°æ³•ä¹‹åï¼Œå°†æœ‰ç”¨çš„æ•°æ®å †å†…å­˜ç©ºé—´ç§»åŠ¨åœ¨ä¸€èµ·ï¼Œé‡Šæ”¾æ›´å¤šè¿ç»­çš„å †ç©ºé—´,ä½†æ˜¯è¿™ç§åšæ³•å¸¦æ¥ å¾ˆå¤§çš„å¼€é”€ï¼Œå› ä¸ºéœ€è¦ä¸æ–­çš„æ‰«æå†…å­˜å’Œç§»åŠ¨å†…å­˜ å¤åˆ¶å›æ”¶æ³•ã€‚å°†å †å†…å­˜åˆ†ä¸ºfromå’ŒToä¸¤ä¸ªç›¸åŒçš„å †å†…å­˜ç©ºé—´ã€‚ç¨‹åºæ‰§è¡Œæ—¶ï¼Œä½¿ç”¨fromçš„å †ç©ºé—´ã€‚åƒåœ¾å›æ”¶æ—¶ä¼šæ‰«æfrom çš„å †å†…å­˜ç©ºé—´ï¼Œå°†æœ‰ç”¨çš„æ•°æ®å¤åˆ¶åˆ°Toçš„å †ç©ºé—´ä¸Šã€‚åƒåœ¾å›æ”¶ç»“æŸæ—¶ï¼Œå°†Toå †ç©ºé—´è®¾ç½®ä¸ºFromå †ç©ºé—´ã€‚å°†åŸæ¥çš„from å †ç©ºé—´å…¨éƒ¨å›æ”¶åç½®ä¸ºTonå †ç©ºé—´ã€‚ä½†æ˜¯å¤åˆ¶å›æ”¶æ³•åªä¼šä½¿ç”¨ä¸€èˆ¬çš„å †å†…å­˜ç©ºé—´ï¼Œé€ æˆå †å†…å­˜ç©ºé—´åˆ©ç”¨ç‡ä¸é«˜ \r åˆ†ä»£æ³•å›æ”¶ï¼šå¤§éƒ¨åˆ†å¯¹è±¡éƒ½ä¼šåœ¨å¹´è½»æ—¶å€™æ­»äº¡ï¼ˆå¼±åˆ†ä»£å‡è¯´ï¼‰æŠŠæ–°å»ºçš„å¯¹è±¡ç§°ä¹‹ä¸ºæ–°ç”Ÿä»£å¯¹è±¡ã€‚ç»è¿‡ç‰¹å®šæ¬¡æ•°çš„GC(åƒåœ¾å›æ”¶)æ•°æ®ä¾ç„¶æœ‰ç”¨çš„å¯¹è±¡ç§°ä¸º è€å¹´ä»£å¯¹è±¡ã€‚è€Œå¤§éƒ¨åˆ†ä¼šåœ¨æ–°ç”Ÿä»£å¯¹è±¡å°±ä¼šåƒåœ¾å›æ”¶äº†ï¼Œåœ¨ç»“åˆå¤åˆ¶å›æ”¶æ³•ä½¿ç”¨ \r  è®¡æ•°æ³•å›æ”¶  å¼•ç”¨è®¡æ•°æŒ‡çš„æ˜¯å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šæ›´æ–°å¼•ç”¨æ¬¡æ•°ã€‚å¯¹è±¡å¼•ç”¨è¶Šå¤šï¼Œè®¡æ•°è¶Šå¤§ï¼Œå½“è®¡æ•°ä¸º0æ—¶ï¼Œå›æ”¶è¯¥å¯¹è±¡ï¼ˆå †å†…å­˜ç©ºé—´ï¼‰ å¼•ç”¨è®¡æ•°æ³•å¯ä»¥åœ¨è¿è¡Œä¸­æ›´æ–°å¯¹è±¡çš„è®¡æ•°ï¼Œå¯ä»¥åŠæ—¶åˆ¤æ–­è®¡æ•°ä¸º 0çš„å¯¹è±¡ï¼Œç„¶åå¯¹å…¶åŠæ—¶å›æ”¶ï¼Œ ä½†æ˜¯é¢‘ç¹çš„æ›´æ–°å¼•ç”¨è®¡æ•°ä¹Ÿä¼šå¸¦æ¥èµ„æºæ¶ˆè€— \r  åƒåœ¾å›æ”¶æ¨¡å¼  å¢é‡å¼çš„åƒåœ¾å›æ”¶æ¨¡å¼ï¼šSWTæ˜¯ç”¨æˆ·æ‰¿ç¨‹åºåœä¸‹å·¥ä½œå¤„ç†åƒåœ¾å›æ”¶ï¼Œä½†æ˜¯ä¸ºäº†æé«˜cpuæ‰§è¡Œæ•ˆç‡ï¼Œä¼šå‡å°‘SWTçš„æ—¶é—´ï¼Œç»åƒåœ¾å›æ”¶å·¥ä½œåˆ†å¤šæ¬¡è¿›è¡Œï¼ˆç”¨æˆ·ç¨‹åºä¸åƒåœ¾å›æ”¶äº¤æ›¿æ‰§è¡Œï¼‰ ä¸‰è‰²ä¸å˜å¼ï¼šåœ¨å¢é‡å¼åƒåœ¾å›æ”¶æ¨¡å¼åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œä¼šé€ æˆç”¨æˆ·ç¨‹åºå¯¹æ ‡è‰²çš„æ•°æ®è¿›è¡Œæ›´æ”¹ï¼Œå½“åœ¨æ¬¡æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œå¯èƒ½ä¼šå°†æœ‰ç”¨çš„æ•°æ®å½“ä½œåƒåœ¾å›æ”¶äº†ï¼Œåœ¨æ ‡è‰²æ³•ä¸­ï¼Œå½“é»‘è‰²æ•°æ®èŠ‚ç‚¹å¯ä»¥å¼•ç”¨ç™½è‰²çš„æ•°æ®èŠ‚ç‚¹ï¼Œä½†æ˜¯æ²¡æœ‰ç°è‰²èŠ‚ç‚¹èƒ½å¼•ç”¨è¿™ä¸ªç™½è‰²èŠ‚ç‚¹ï¼Œç™½è‰²æ•°æ®èŠ‚ç‚¹å°±è¢«å½“ä½œåƒåœ¾è¢«å›æ”¶ é¿å…è¿™æ ·çš„å‘ç”Ÿï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å»ºç«‹è¯»å†™å±éšœã€‚åœ¨ä¸‰è‰²ä¸­ç¡®ä¿é»‘è‰²çš„æ•°æ®èŠ‚ç‚¹ä¸å¼•ç”¨ç™½è‰²çš„æ•°æ®èŠ‚ç‚¹ï¼Œå°±ä¸ä¼šè¯¯åˆ¤æœ‰ç”¨çš„æ•°æ®å½“ä½œåƒåœ¾å›æ”¶äº†ï¼Œè¿™ç§å«åšï¼šå¼ºä¸‰è‰²ä¸å˜å¼ å¦‚æœå½“é»‘è‰²çš„æ•°æ®èŠ‚ç‚¹èƒ½å¼•ç”¨ç™½è‰²æ•°æ®èŠ‚ç‚¹ï¼ŒåŒæ—¶ç¡®ä¿å›æ”¶èŠ‚ç‚¹ä¹Ÿèƒ½å¼•ç”¨ç™½è‰²èŠ‚ç‚¹ï¼Œä¹Ÿèƒ½é¿å…æœ‰ç”¨çš„æ•°æ®è¢«å½“ä½œåƒåœ¾å›æ”¶ï¼Œè¿™å«ï¼šå¼±ä¸‰è‰²ä¸å˜å¼ \r å¹¶è¡Œåƒåœ¾å›æ”¶ï¼šåœ¨å¤šæ ¸ä¸‹ï¼Œä½¿ç”¨å¤šçº¿ç¨‹å¯¹åƒåœ¾å›æ”¶ï¼Œéœ€è¦åšå¥½çš„è´Ÿè½½å‡è¡¡å’Œè§„é¿æ•°é‡å¤å¤„ç†å¸¦æ¥çš„é—®é¢˜ï¼Œå¦‚åœ¨å¤åˆ¶å›æ”¶ä¸­ï¼Œå¯èƒ½å°†åŒæ ·çš„æ•°æ®ä»fromå¤åˆ¶åˆ°to å¹¶å‘åƒåœ¾å›æ”¶ï¼šåƒåœ¾å›æ”¶ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œå¯èƒ½ä¼šé€ æˆåƒåœ¾å›æ”¶ä¸ç”¨æˆ·ç¨‹åºçš„èµ„æºç«äº‰ç­‰é—®é¢˜ç­‰ ä¸»ä½“å¹¶å‘å›æ”¶ï¼šåœ¨æ—¶åˆ»ä½¿ç”¨swtå›æ”¶ï¼Œåœ¨è«æ—¶åˆ»åˆä½¿ç”¨å¹¶å‘åƒåœ¾å›æ”¶ ä¸»ä½“å¹¶å‘å¢é‡å¼å›æ”¶: æ˜¯èåˆäº†å¢é‡å¼çš„åƒåœ¾å›æ”¶æ¨¡å¼å’Œä¸»ä½“å¹¶å‘å›æ”¶æ¨¡å¼ \r  å†…å­˜é€ƒé€¸  æ‚¬æŒ‚æŒ‡é’ˆï¼šå› å†…å­˜å›æ”¶é”™è¯¯å¯¼è‡´  ä¾‹å¦‚ï¼šint *suspend_pointer{int i= 2; return \u0026amp;i;}   å†…å­˜é€ƒé€¸åˆ†æï¼šç¨‹åºåœ¨ç¼–è¯‘é˜¶æ®µæ ¹æ®ä»£ç ä¸­çš„æ•°æ®æµï¼Œå¯¹ä»£ç ä¸­çš„é‚£äº›å˜é‡éœ€è¦åœ¨æ ˆä¸­åˆ†é… é‚£äº›åœ¨å †ä¸Šåˆ†é…è¿›è¡Œé™æ€åˆ†é…çš„æ–¹æ³• é€ƒé€¸åˆ†æçš„ä¸¤ä¸ªåŸåˆ™ï¼š  æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½å­˜æ´»åœ¨å †ä¸­ æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½åœ¨æ ˆå¯¹è±¡å›æ”¶åå­˜æ´»    å‚è€ƒæ–‡çŒ® 1.https://www.zhihu.com/people/kylin-lab\n","date":"2021-10-18T22:00:38+08:00","image":"https://zcj-git520.github.io/p/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/6_hu61bd622d583377d86db238f2ea3bdaa9_262966_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/","title":"å†…å­˜ç®¡ç†"},{"content":"go Channel  ï¼ˆDo not communicate by sharing memory; instead, share memory by communicatingï¼‰  CSPå¹¶å‘æ¨¡å‹  CSP å³é€šä¿¡é¡ºåºè¿›ç¨‹ã€äº¤è°ˆå¾ªåºç¨‹åºï¼Œåˆè¢«è¯‘ä¸ºäº¤æ¢æ¶ˆæ¯çš„å¾ªåºç¨‹åº(communicating sequential processes)ï¼Œå®ƒæ˜¯ä¸€ç§ç”¨æ¥æè¿°å¹¶å‘æ€§ç³»ç»Ÿä¹‹é—´è¿›è¡Œäº¤äº’çš„æ¨¡å‹ã€‚ go Channeæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å‹ï¼Œæ˜¯æœ‰ç‰¹å®šç±»å‹çš„é˜Ÿåˆ—ã€‚æ˜¯é“¾æ¥goroutine(åç¨‹)çš„é€šä¿¡æœºåˆ¶ï¼Œé€šè¿‡é€šä¿¡å…±äº«å†…å­˜è€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜è€Œå®ç°é€šä¿¡. Channel æ”¶å‘æ“ä½œå‡éµå¾ªäº†å…ˆè¿›å…ˆå‡ºçš„è®¾è®¡ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š  å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›    \r\nchannel æ•°æ®ç»“æ„å®šä¹‰ï¼š type hchan struct { // é˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ•°é‡ qcount uint // total data in the queue //ç¯å½¢é˜Ÿåˆ—çš„å¤§å°(æœ€å¤§å­˜å‚¨æ•°é‡ ) dataqsiz uint // size of the circular queue // å­˜æ”¾ç¯å½¢é˜Ÿåˆ—çš„æ•°æ®ï¼Œæ•°ç»„ buf unsafe.Pointer // points to an array of dataqsiz elements // å…ƒç´ çš„å¤§å° elemsize uint16 // æ˜¯å¦å…³é—­çš„æ ‡è¯† closed uint32 // å…ƒç´ çš„ç±»å‹(æŒ‡å‘ç±»å‹çš„å…ƒæ•°æ® ) elemtype *_type // element type // å½“å‰å‘é€æ•°æ®åœ¨ç¯å½¢é˜Ÿåˆ—çš„ç´¢å¼• sendx uint // send index // å½“å‰æ¥å—æ•°æ®åœ¨ç¯å½¢é˜Ÿåˆ—çš„ç´¢å¼• recvx uint // receive index // æ¥æ”¶è€…ç­‰å¾…é˜Ÿåˆ—ï¼ˆ\u0026lt;-chï¼‰é˜»å¡åœ¨channelçš„åç¨‹é˜Ÿåˆ— recvq waitq // list of recv waiters // å‘é€è€…ç­‰å¾…é˜Ÿåˆ—ï¼ˆch\u0026lt;- dataï¼‰é˜»å¡åœ¨channelçš„åç¨‹é˜Ÿåˆ— sendq waitq // list of send waiters //é”ä¿æŠ¤hchanä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠå‡ ä¸ª //åœ¨è¿™ä¸ªé€šé“ä¸Šé˜»å¡sudogsä¸­çš„å­—æ®µ //ä¿æŒè¿™ä¸ªé”æ—¶ä¸è¦æ”¹å˜å¦ä¸€ä¸ªGçš„çŠ¶æ€ //(ç‰¹åˆ«æ˜¯ï¼Œä¸è¦å‡†å¤‡ä¸€ä¸ªG)ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šæ­»é” //æ ˆæ”¶ç¼©ã€‚ lock mutex // ä¿æŠ¤hchanä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä¿æŒåç¨‹çš„çŠ¶æ€ä¸è¢«æ›´æ”¹ï¼Œé¿å…é€ æˆæ ˆæ”¶ç¼©å¼•èµ·çš„æ­»é”ï¼Œä½¿ç”¨äº’æ–¥é”è§£å†³ç¨‹åºä¸­å¯èƒ½å­˜åœ¨çš„çº¿ç¨‹ç«äº‰é—®é¢˜æ˜¯å¾ˆå¸¸è§çš„ } å‘é€è€…/æ¥æ”¶è€…ç­‰å¾…é˜Ÿåˆ—çš„ç»“æ„ï¼šä¸€ä¸ªåŒå‘é“¾è¡¨ type waitq struct { first *sudog last *sudog } channel sudog(ç­‰å¾…é˜Ÿåˆ—)ç»“æ„å¦‚ä¸‹ type sudog struct { // The following fields are protected by the hchan.lock of the // channel this sudog is blocking on. shrinkstack depends on // this for sudogs involved in channel ops. //ä»¥ä¸‹å­—æ®µå—hchanä¿æŠ¤ã€‚é”çš„ //è¿™ä¸ªsudogæ­£åœ¨é˜»å¡ã€‚shrinkstackå–å†³äº //è¿™æ˜¯ä¸ºæ¶‰åŠé€šé“æ“ä½œçš„sudogsã€‚ g *g // ç­‰å¾…çš„åç¨‹åç¨‹ next *sudog prev *sudog // æ•°æ®å…ƒç´ (å¯ä»¥æŒ‡å‘å †æ ˆ)ï¼Œç­‰å¾…å‘é€/æ¥æ”¶çš„æ•°æ® elem unsafe.Pointer // data element (may point to stack) // The following fields are never accessed concurrently. // For channels, waitlink is only accessed by g. // For semaphores, all fields (including the ones above) // are only accessed when holding a semaRoot lock. //ä¸‹é¢çš„å­—æ®µæ°¸è¿œä¸ä¼šå¹¶å‘è®¿é—®ã€‚ //å¯¹äºé€šé“ï¼Œwaitlinkåªè¢«gè®¿é—®ã€‚ //å¯¹äºä¿¡å·é‡ï¼Œæ‰€æœ‰çš„å­—æ®µ(åŒ…æ‹¬ä¸Šé¢çš„å­—æ®µ) //åªåœ¨æŒæœ‰semaRooté”æ—¶è®¿é—®ã€‚ acquiretime int64 releasetime int64 ticket uint32 // isSelect indicates g is participating in a select, so // g.selectDone must be CAS'd to win the wake-up race. // è¡¨ç¤ºgè¢«é€‰æ‹© isSelect bool // success indicates whether communication over channel c // succeeded. It is true if the goroutine was awoken because a // value was delivered over channel c, and false if awoken // because c was closed. //æˆåŠŸè¡¨ç¤ºæ˜¯å¦é€šè¿‡é€šé“cé€šä¿¡ // æˆåŠŸäº†ã€‚ å¦‚æœ goroutine è¢«å”¤é†’æ˜¯å› ä¸ºä¸€ä¸ª // å€¼é€šè¿‡é€šé“ c ä¼ é€’ï¼Œå¦‚æœè¢«å”¤é†’åˆ™è¿”å› false // å› ä¸º c è¢«å…³é—­äº† success bool // c å› å…³é—­è€Œå”¤é†’ parent *sudog // semaRoot binary tree waitlink *sudog // g.waiting list or semaRoot waittail *sudog // semaRoot // ç­‰å¾…çš„channelè¢«å”¤é†’ c *hchan // channel }  ç»“æ„å¦‚å›¾æ‰€ç¤º \r  channel åˆ›å»º  channel å’Œ åˆ‡ç‰‡ã€mapä¸€æ ·ï¼Œéœ€è¦ä½¿ç”¨make(chan type, int )æ‰èƒ½ä½¿ç”¨,åº”ä¸ºmake()ä¼šè°ƒç”¨makeChan()åˆå§‹åŒ–  makechå‡½æ•°æºç å¦‚ä¸‹: // å‚æ•°ç±»å‹ï¼šåˆ›å»ºchançš„ç±»å‹å’Œç¯å‹ç¼“å†²åŒºçš„æ•°é‡ func makechan(t *chantype, size int) *hchan { elem := t.elem // compiler checks this but be safe. if elem.size \u0026gt;= 1\u0026lt;\u0026lt;16 { throw(\u0026quot;makechan: invalid channel element type\u0026quot;) } if hchanSize%maxAlign != 0 || elem.align \u0026gt; maxAlign { throw(\u0026quot;makechan: bad alignment\u0026quot;) } //åˆ¤æ–­ç¯å‹ç¼“å†²åŒºæ˜¯å¦æº¢å‡º mem, overflow := math.MulUintptr(elem.size, uintptr(size)) if overflow || mem \u0026gt; maxAlloc-hchanSize || size \u0026lt; 0 { panic(plainError(\u0026quot;makechan: size out of range\u0026quot;)) } // Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers. // buf points into the same allocation, elemtype is persistent. // SudoG's are referenced from their owning thread so they can't be collected. // TODO(dvyukov,rlh): Rethink when collector can move allocated objects. var c *hchan switch { case mem == 0: // Queue or element size is zero. // å½“é˜Ÿåˆ—æˆ–è€…å…ƒç´ å¤§å°ä¸º0æ—¶ï¼Œå®šä¹‰æ— ç¼“å†²chanï¼ˆåŒæ­¥chanï¼‰ c = (*hchan)(mallocgc(hchanSize, nil, true)) // Race detector uses this location for synchronization. // Race ç«äº‰æ£€æŸ¥åˆ©ç”¨è¿™ä¸ªåœ°å€æ¥è¿›è¡ŒåŒæ­¥æ“ä½œ c.buf = c.raceaddr() case elem.ptrdata == 0: // Elements do not contain pointers. // Allocate hchan and buf in one call. // å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆæ—¶ã€‚ä¸€æ¬¡åˆ†é… hchan å’Œ buf çš„å†…å­˜ã€‚ c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) c.buf = add(unsafe.Pointer(c), hchanSize) default: // Elements contain pointers. // å®šä¹‰å¸¦ç¼“å­˜çš„chanæˆ–è€…å¼‚æ­¥çš„chan c = new(hchan) c.buf = mallocgc(mem, elem, true) } c.elemsize = uint16(elem.size) // chanå…ƒç´ çš„å¤§å° c.elemtype = elem // chanå…ƒç´ çš„ç±»å‹ c.dataqsiz = uint(size) // chanç¼“å­˜åŒºå¤§å° lockInit(\u0026amp;c.lock, lockRankHchan) //åˆå§‹åŒ–äº’æ–¥é” if debugChan { print(\u0026quot;makechan: chan=\u0026quot;, c, \u0026quot;; elemsize=\u0026quot;, elem.size, \u0026quot;; dataqsiz=\u0026quot;, size, \u0026quot;\\n\u0026quot;) } return c }  channelåˆ›å»ºè¿‡ç¨‹ï¼š   ç¼–è¯‘æ£€æŸ¥ã€ç¼“å†²åŒºå¤§å°æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦æº¢å‡º åˆ¤æ–­chançš„ç±»å‹\n1ã€å½“åˆ›å»ºæ— ç¼“å†²chanæ—¶,è°ƒç”¨mallocgc()åœ¨å †ä¸Šä¸ºchanå¼€è¾ŸhchanSizeçš„bufç¼“å­˜å†…å­˜ç©ºé—´\n2ã€åˆ›å»ºå¸¦ç¼“å†²çš„chanæ—¶,åˆ¤æ–­å…ƒç´ çš„ç±»å‹æ˜¯å¦ä¸ºæŒ‡é’ˆç±»å‹ï¼Œè‹¥ä¸æ˜¯ï¼Œåˆ™mallocgc()åœ¨å †ä¸Šä¸ºchanå’Œbufç¼“å†²åŒºæ•°ç»„å¼€è¾Ÿä¸€æ®µå¤§å°ä¸º hchanSize+memè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚è‹¥æ˜¯åˆ™è°ƒç”¨mallocgc()åœ¨å †ä¸Šåˆ†åˆ«ä¸ºchanå’Œbufç¼“å†²åŒºåˆ†é…è¿ç»­å†…å­˜ç©ºé—´ã€‚ \r  channel å‘é€æ•°æ®ä¸æ¥æ”¶æ•°æ® channel å‘é€æ•°æ®  chan \u0026lt;- data  chanå‘é€æ•°æ®æºç å¦‚ä¸‹: func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { // åˆ¤æ–­chanæ˜¯å¦è¢«åˆå§‹åŒ–ï¼Œå‘chanä¸ºnilçš„chanå‘é€æ•°æ®å°†ä¼šæ°¸ä¹…é˜»å¡ if c == nil { if !block { return false } // ä½¿å½“å‰çš„groutineä¼‘çœ  gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2) throw(\u0026quot;unreachable\u0026quot;) } if debugChan { print(\u0026quot;chansend: chan=\u0026quot;, c, \u0026quot;\\n\u0026quot;) } // æ£€æŸ¥åœ¨æ²¡æœ‰è·å–é”çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´å‘é€å¤±è´¥çš„éé˜»å¡æ“ä½œ if raceenabled { racereadpc(c.raceaddr(), callerpc, funcPC(chansend)) } // Fast path: check for failed non-blocking operation without acquiring the lock. // // After observing that the channel is not closed, we observe that the channel is // not ready for sending. Each of these observations is a single word-sized read // (first c.closed and second full()). // Because a closed channel cannot transition from 'ready for sending' to // 'not ready for sending', even if the channel is closed between the two observations, // they imply a moment between the two when the channel was both not yet closed // and not ready for sending. We behave as if we observed the channel at that moment, // and report that the send cannot proceed. // // It is okay if the reads are reordered here: if we observe that the channel is not // ready for sending and then observe that it is not closed, that implies that the // channel wasn't closed during the first observation. However, nothing here // guarantees forward progress. We rely on the side effects of lock release in // chanrecv() and closechan() to update this thread's view of c.closed and full(). if !block \u0026amp;\u0026amp; c.closed == 0 \u0026amp;\u0026amp; full(c) { return false } var t0 int64 if blockprofilerate \u0026gt; 0 { t0 = cputicks() } // è·å¾—åŒæ­¥é” lock(\u0026amp;c.lock) // å½“chanå…³é—­æ—¶,é‡Šæ”¾é”ï¼Œå¹¶panic // å‘ä¹Ÿå…³é—­çš„chanå‘é€æ¶ˆæ¯,ä¼šå¼•å‘panic if c.closed != 0 { unlock(\u0026amp;c.lock) panic(plainError(\u0026quot;send on closed channel\u0026quot;)) } // å¦‚æœæ¥æ”¶é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œç›´æ¥å‘é€ç»™æ¥æ”¶è€…ï¼ˆæœ‰ç¼“å­˜åŒºæ—¶ï¼Œä¼šç»•è¿‡ç¼“å­˜åŒºï¼‰ if sg := c.recvq.dequeue(); sg != nil { // Found a waiting receiver. We pass the value we want to send // directly to the receiver, bypassing the channel buffer (if any). send(c, sg, ep, func() { unlock(\u0026amp;c.lock) }, 3) return true } if c.qcount \u0026lt; c.dataqsiz { // æ²¡æœ‰æ¥æ”¶è€…ï¼Œå½“æœ‰ç¼“å­˜åŒºæ—¶ï¼Œå°†è¦å‘é€çš„å…ƒç´ æ”¾å…¥é˜Ÿåˆ—ä¸­ // Space is available in the channel buffer. Enqueue the element to send. qp := chanbuf(c, c.sendx) // è·å–ç¼“å­˜åœ°å€ if raceenabled { racenotify(c, c.sendx, nil) } typedmemmove(c.elemtype, qp, ep) c.sendx++ // æŒ‡å‘ä¸‹ä¸€ä¸ªå­˜å‚¨çš„ä½ç½® if c.sendx == c.dataqsiz { c.sendx = 0 } c.qcount++ // ç¼“å­˜æ•°é‡ç›¸åŠ  unlock(\u0026amp;c.lock) return true } if !block { unlock(\u0026amp;c.lock) return false } // ç¼“å­˜åŒºæ»¡äº†ï¼Œå°†å½“å‰å‘é€åç¨‹åŠ å…¥åˆ°ç­‰å¾…sendé˜Ÿåˆ— // Block on the channel. Some receiver will complete our operation for us. gp := getg() // è·å–å½“å‰çš„gå‘é€åç¨‹ mysg := acquireSudog()// åˆ›å»ºsudogç­‰å¾…é˜Ÿåˆ— mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil // æŠŠå½“å‰çš„å‘é€åç¨‹ä¸ç­‰å¾…é˜Ÿåˆ—ç»‘å®š mysg.g = gp mysg.isSelect = false mysg.c = c gp.waiting = mysg gp.param = nil // åŠ å…¥åˆ°å‘é€ç­‰å¾…é˜Ÿåˆ—ä¸­ c.sendq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. atomic.Store8(\u0026amp;gp.parkingOnChan, 1) gopark(chanparkcommit, unsafe.Pointer(\u0026amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, 2) // Ensure the value being sent is kept alive until the // receiver copies it out. The sudog has a pointer to the // stack object, but sudogs aren't considered as roots of the // stack tracer. KeepAlive(ep) // someone woke us up. // å‘é€åç¨‹è¢«å”¤é†’ï¼Œè§£é™¤ç­‰å¾…é˜Ÿåˆ—çš„é˜»å¡çŠ¶æ€ // åˆ¤æ–­çš„ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦åœ¨ä¼‘çœ  if mysg != gp.waiting { throw(\u0026quot;G waiting list is corrupted\u0026quot;) } gp.waiting = nil gp.activeStackChans = false closed := !mysg.success gp.param = nil if mysg.releasetime \u0026gt; 0 { blockevent(mysg.releasetime-t0, 2) } mysg.c = nil releaseSudog(mysg) // é‡Šæ”¾ç­‰å¾…é˜Ÿåˆ— if closed { if c.closed == 0 { throw(\u0026quot;chansend: spurious wakeup\u0026quot;) } panic(plainError(\u0026quot;send on closed channel\u0026quot;)) } return true }  channel å‘é€æ•°æ®æ€»ç»“   åˆ¤æ–­chanæ˜¯å¦è¢«åˆå§‹åŒ–ï¼Œå‘chanä¸ºnilçš„chanå‘é€æ•°æ®å°†ä¼šæ°¸ä¹…é˜»å¡ æ£€æŸ¥åœ¨æ²¡æœ‰è·å–é”ï¼Œ åœ¨æ²¡æœ‰è·å–é”çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´å‘é€å¤±è´¥çš„éé˜»å¡æ“ä½œ æ£€æŸ¥chanæ˜¯å¦å…³é—­ï¼Œå‘ä¹Ÿå…³é—­çš„chanå‘é€æ¶ˆæ¯,ä¼šå¼•å‘panic å¦‚æœæ¥æ”¶é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œç›´æ¥å‘é€ç»™æ¥æ”¶è€…ï¼ˆæœ‰ç¼“å­˜åŒºæ—¶ï¼Œä¼šç»•è¿‡ç¼“å­˜åŒºï¼‰ æ²¡æœ‰æ¥æ”¶è€…ï¼Œå½“æœ‰ç¼“å­˜åŒºæ—¶ï¼Œå°†è¦å‘é€çš„å…ƒç´ æ”¾å…¥é˜Ÿåˆ—ä¸­ ç¼“å­˜åŒºæ»¡äº†ï¼Œå°†å½“å‰åç¨‹åŠ å…¥åˆ°sendç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶é˜»å¡ å½“å‘é€åç¨‹è¢«å”¤é†’ï¼Œè§£é™¤ç­‰å¾…é˜Ÿåˆ—çš„é˜»å¡çŠ¶æ€ï¼Œé‡Šæ”¾ç­‰å¾…é˜Ÿåˆ— \r  channel æ¥æ”¶æ•°æ®  \u0026lt;- data  chan æ¥æ”¶æ•°æ®æºç å¦‚ä¸‹: func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { // raceenabled: don't need to check ep, as it is always on the stack // or is new memory allocated by reflect. if debugChan { print(\u0026quot;chanrecv: chan=\u0026quot;, c, \u0026quot;\\n\u0026quot;) } // åˆ¤æ–­chanæ˜¯å¦åˆå§‹åŒ–ï¼Œè‹¥æ²¡æœ‰åˆå§‹åŒ–ï¼Œæ¥æ”¶channelæ•°æ®å°†é˜»å¡ if c == nil { if !block { return } gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\u0026quot;unreachable\u0026quot;) } // æ£€æŸ¥chanæ˜¯å¦ä¸ºç©ºï¼Œæ˜¯å¦å…³é—­ // Fast path: check for failed non-blocking operation without acquiring the lock. if !block \u0026amp;\u0026amp; empty(c) { // After observing that the channel is not ready for receiving, we observe whether the // channel is closed. // // Reordering of these checks could lead to incorrect behavior when racing with a close. // For example, if the channel was open and not empty, was closed, and then drained, // reordered reads could incorrectly indicate \u0026quot;open and empty\u0026quot;. To prevent reordering, // we use atomic loads for both checks, and rely on emptying and closing to happen in // separate critical sections under the same lock. This assumption fails when closing // an unbuffered channel with a blocked send, but that is an error condition anyway. if atomic.Load(\u0026amp;c.closed) == 0 { // chanå…³é—­ï¼Œå°±è¿”å› // Because a channel cannot be reopened, the later observation of the channel // being not closed implies that it was also not closed at the moment of the // first observation. We behave as if we observed the channel at that moment // and report that the receive cannot proceed. return } // The channel is irreversibly closed. Re-check whether the channel has any pending data // to receive, which could have arrived between the empty and closed checks above. // Sequential consistency is also required here, when racing with such a send. if empty(c) { // å¦‚æœchanä¸ºç©º // The channel is irreversibly closed and empty. // // channel ä¸å¯é€†çš„å…³é—­äº†ä¸”ä¸ºç©º if raceenabled { raceacquire(c.raceaddr()) } if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } } var t0 int64 if blockprofilerate \u0026gt; 0 { t0 = cputicks() } lock(\u0026amp;c.lock) // chan å…³é—­äº†ï¼Œæ¸…ç†ç¼“å†²åŒº if c.closed != 0 \u0026amp;\u0026amp; c.qcount == 0 { if raceenabled { raceacquire(c.raceaddr()) } unlock(\u0026amp;c.lock) if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } // æ‰¾åˆ°ä¸€ä¸ªç­‰å¾…çš„å‘ä»¶äººã€‚å¦‚æœç¼“å†²åŒºå¤§å°ä¸º 0ï¼Œåˆ™ç›´æ¥ä»å‘é€æ–¹æ¥æ”¶å€¼ã€‚å¦åˆ™ï¼Œä»é˜Ÿåˆ—çš„å¤´éƒ¨æ¥æ”¶ // å¹¶å°†å‘é€è€…çš„å€¼æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆä¸¤è€…éƒ½æ˜ å°„åˆ° // ç›¸åŒçš„ç¼“å†²åŒºæ§½ï¼Œå› ä¸ºé˜Ÿåˆ—å·²æ»¡ï¼‰ // å¦‚æœæ˜¯æ— ç¼“å†²é˜Ÿåˆ—ï¼Œç›´æ¥ä»å‘é€æ–¹å–å€¼ // å¦‚æœæ˜¯å¾…ç¼“å†²çš„åŒºï¼Œå°±ä»ç¼“å†²åŒºå¤´éƒ¨è·å–å€¼ï¼Œå¹¶å°†å‘é€ç€çš„å€¼ä¿å­˜åœ¨ç¼“å†²åŒºå if sg := c.sendq.dequeue(); sg != nil { // Found a waiting sender. If buffer is size 0, receive value // directly from sender. Otherwise, receive from head of queue // and add sender's value to the tail of the queue (both map to // the same buffer slot because the queue is full). recv(c, sg, ep, func() { unlock(\u0026amp;c.lock) }, 3) return true, true } // æ²¡æœ‰å‘é€çš„åç¨‹ï¼Œä½†æ˜¯ç¼“å†²åŒºæœ‰å…ƒç´ ï¼Œç›´æ¥è·å–ç¼“å†²åŒºå¤´éƒ¨çš„å€¼ if c.qcount \u0026gt; 0 { // Receive directly from queue qp := chanbuf(c, c.recvx) if raceenabled { racenotify(c, c.recvx, nil) } if ep != nil { typedmemmove(c.elemtype, ep, qp) } typedmemclr(c.elemtype, qp) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- unlock(\u0026amp;c.lock) return true, true } if !block { unlock(\u0026amp;c.lock) return false, false } // å½“æ²¡æœ‰å‘é€æ•°æ®çš„çš„åç¨‹ï¼Œä¸”ç¼“å†²åŒºå€¼ï¼Œå°±å°†æ¥æ”¶çš„åç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ // no sender available: block on this channel. gp := getg() // è·å–å½“å‰æ¥æ”¶åç¨‹ mysg := acquireSudog() // åˆ›å»ºç­‰å¾…é˜Ÿåˆ— mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil gp.waiting = mysg // å°†æ¥é€å†™åç¨‹ä¸ç­‰å¾…é˜Ÿåˆ—ç»‘å®š mysg.g = gp mysg.isSelect = false mysg.c = c gp.param = nil // æ”¾å…¥åœ¨åç¨‹çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ c.recvq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. atomic.Store8(\u0026amp;gp.parkingOnChan, 1) gopark(chanparkcommit, unsafe.Pointer(\u0026amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, 2) //å½“æ¥æ”¶åç¨‹è¢«å”¤é†’æ—¶ï¼Œè§£é™¤é˜»å¡çŠ¶æ€ // someone woke us up if mysg != gp.waiting { throw(\u0026quot;G waiting list is corrupted\u0026quot;) } gp.waiting = nil gp.activeStackChans = false if mysg.releasetime \u0026gt; 0 { blockevent(mysg.releasetime-t0, 2) } success := mysg.success gp.param = nil mysg.c = nil releaseSudog(mysg) // é‡Šæ”¾ç­‰å¾…é˜Ÿåˆ—å†…å­˜ return true, success }  channel å‘é€æ•°æ®æ€»ç»“   åˆ¤æ–­chanæ˜¯å¦åˆå§‹åŒ–ï¼Œè‹¥æ²¡æœ‰åˆå§‹åŒ–ï¼Œæ¥æ”¶channelæ•°æ®å°†é˜»å¡ æ£€æŸ¥chanæ˜¯å¦ä¸ºç©ºï¼Œæ˜¯å¦å…³é—­ å½“æœ‰å‘é€åç¨‹ï¼Œå¦‚æœæ˜¯æ— ç¼“å†²é˜Ÿåˆ—ï¼Œç›´æ¥ä»å‘é€æ–¹å–å€¼,å¦‚æœæ˜¯å¾…ç¼“å†²çš„åŒºï¼Œå°±ä»ç¼“å†²åŒºå¤´éƒ¨è·å–å€¼ï¼Œå¹¶å°†å‘é€ç€çš„å€¼ä¿å­˜åœ¨ç¼“å†²åŒºå å½“æ²¡æœ‰å‘é€åç¨‹ï¼Œä½†æ˜¯æœ‰ç¼“å†²åŒºæœ‰å…ƒç´ ï¼Œç›´æ¥è·å–ç¼“å†²åŒºå¤´éƒ¨çš„å€¼ å½“æ²¡æœ‰å‘é€æ•°æ®çš„çš„åç¨‹ï¼Œä¸”ç¼“å†²åŒºå€¼ï¼Œå°±å°†æ¥æ”¶çš„åç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ å½“æ¥æ”¶åç¨‹è¢«å”¤é†’æ—¶ï¼Œè§£é™¤é˜»å¡çŠ¶æ€ï¼Œé‡Šæ”¾ç­‰å¾…é˜Ÿåˆ—å†…å­˜ \r  channel å…³é—­  close(chan)  chan å…³é—­æºç å¦‚ä¸‹: func closechan(c *hchan) { // åˆ¤æ–­chanæ˜¯å¦åˆå§‹åŒ–ï¼Œæ²¡æœ‰åˆå§‹åŒ–ï¼Œå…³é—­æ²¡æœ‰åˆå§‹åŒ–çš„chan,ç›´æ¥panic if c == nil { panic(plainError(\u0026quot;close of nil channel\u0026quot;)) } // åˆ¤æ–­chanæ˜¯å¦ä¹Ÿè¢«å…³é—­ï¼Œå…³é—­ä¹Ÿå…³é—­çš„chan,ä¹Ÿä¼šå‘é€panic lock(\u0026amp;c.lock) if c.closed != 0 { unlock(\u0026amp;c.lock) panic(plainError(\u0026quot;close of closed channel\u0026quot;)) } if raceenabled { callerpc := getcallerpc() racewritepc(c.raceaddr(), callerpc, funcPC(closechan)) racerelease(c.raceaddr()) } c.closed = 1 var glist gList // é‡Šæ”¾æ‰€æœ‰çš„æ¥æ”¶chanï¼Œå¹¶å°†æ‰€æœ‰çš„æ¥æ”¶é˜Ÿåˆ—åŠ å…¥åˆ°å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­ // release all readers for { sg := c.recvq.dequeue() if sg == nil { break } if sg.elem != nil { typedmemclr(c.elemtype, sg.elem) sg.elem = nil } if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = unsafe.Pointer(sg) sg.success = false if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } // é‡Šæ”¾æ‰€æœ‰çš„å‘é€chan,å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq ä¸­çš„ sudog æ”¾å…¥å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­ // release all writers (they will panic) for { sg := c.sendq.dequeue() if sg == nil { break } sg.elem = nil if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = unsafe.Pointer(sg) sg.success = false if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } unlock(\u0026amp;c.lock) æœ€åä¼šä¸ºæ‰€æœ‰è¢«é˜»å¡çš„ goroutine è°ƒç”¨ goready è§¦å‘è°ƒåº¦ã€‚å°†æ‰€æœ‰ glist ä¸­çš„ goroutine çŠ¶æ€ä» _Gwaiting è®¾ç½®ä¸º _Grunnable çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚ // Ready all Gs now that we've dropped the channel lock. for !glist.empty() { gp := glist.pop() gp.schedlink = 0 goready(gp, 3) } }  channel å…³é—­æ€»ç»“   åˆ¤æ–­chanæ˜¯å¦åˆå§‹åŒ–ï¼Œæ²¡æœ‰åˆå§‹åŒ–ï¼Œå…³é—­æ²¡æœ‰åˆå§‹åŒ–çš„chan,ç›´æ¥panic åˆ¤æ–­chanæ˜¯å¦ä¹Ÿè¢«å…³é—­ï¼Œå…³é—­ä¹Ÿå…³é—­çš„chan,ä¹Ÿä¼šå‘é€panic å…ˆé‡Šæ”¾æ‰€æœ‰çš„æ¥æ”¶chanï¼Œå¹¶å°†æ‰€æœ‰çš„æ¥æ”¶é˜Ÿåˆ—åŠ å…¥åˆ°å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­ é‡Šæ”¾æ‰€æœ‰çš„å‘é€chan,å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq ä¸­çš„ sudog æ”¾å…¥å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­ æœ€åä¼šä¸ºæ‰€æœ‰è¢«é˜»å¡çš„ goroutine è°ƒç”¨ goready è§¦å‘è°ƒåº¦ã€‚å°†æ‰€æœ‰ glist ä¸­çš„goroutine çŠ¶æ€ä» _Gwaiting è®¾ç½®ä¸º _Grunnable çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚  ","date":"2021-10-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/go-channel%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/3_huc32f323c0433538c753e80bb5a9a01bb_276268_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/go-channel%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/","title":"Go Channelçš„æ·±å…¥ç†è§£"},{"content":"é—®é¢˜  åœ¨æ”¶é›†æœåŠ¡çš„è®¿é—®è®°å½•æ—¶ï¼Œéœ€è¦å°†è®¿é—®è®°å½•ä¿å­˜ï¼Œå®šä¹‰ç»“æ„ä½“å¦‚ä¸‹    type accessData struct { RemoteAddr string // è¿œç¨‹è®¿é—®ä¸»æœºåœ°å€ RequestURI string //è®¿é—®çš„è·¯ç”± ServerName string // è®¿é—®çš„æœåŠ¡åç§° AccessDate string //è®¿é—®çš„æ—¶é—´ RunStatus bool //æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ RunError error //è¿è¡ŒæŠ¥é”™ï¼šæŠ¥é”™ä¿¡æ¯. ServerParam interface{} // è®¿é—®æœåŠ¡çš„å‚æ•° }   é€šè¿‡ç»“æ„ä½“è½¬jsonï¼ŒåŒæ—¶é€šè¿‡getè¯·æ±‚å¾—åˆ°å›¾ä¸‹ç»“æœ \r\n  \u0026ldquo;RunError\u0026rdquo;: {},è¢«jsonè½¬ä¸º{}çš„å­—ç¬¦ï¼Œ æ‰“å°ç»“æ„ä½“ï¼Œå‘ç°é”™è¯¯ä¿¡æ¯æ˜¯æœ‰çš„ï¼š{192.168.1.101:53364 /v1/alarms/out/d GetOutAlarms 2021-10-12 10:09:42 false æ²¡æœ‰è¿™ä¸ªæŠ¥è­¦ğŸ†”id },è¯´æ˜æ˜¯error è½¬jsoné—®é¢˜\né—®é¢˜åˆ†æä¸è§£å†³  é—®é¢˜åˆ†ææŸ¥çœ‹errorç±»å‹å®šä¹‰å‘ç°ï¼šerrorç±»å‹åªæ˜¯ä¸€ä¸ªæ¥å£ã€‚å®ƒå¯ä»¥åŒ…å«ä»»ä½•å®ç°å®ƒçš„å…·ä½“ç±»å‹çš„å€¼ è§£å†³ï¼šå°†ç»“æ„ä½“ä¸­é”™è¯¯è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼ŒåŒæ—¶ç”¨err.Error()è¿”å›æ˜¯é”™è¯¯çš„å­—ç¬¦ä¸²  type accessData struct { RemoteAddr string // è¿œç¨‹è®¿é—®ä¸»æœºåœ°å€ RequestURI string //è®¿é—®çš„è·¯ç”± ServerName string // è®¿é—®çš„æœåŠ¡åç§° AccessDate string //è®¿é—®çš„æ—¶é—´ RunStatus bool //æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ RunError string //è¿è¡ŒæŠ¥é”™ï¼šæŠ¥é”™ä¿¡æ¯. ServerParam interface{} // è®¿é—®æœåŠ¡çš„å‚æ•° } type error interface { Error() string }   ç»“æœå¦‚å›¾\n  \r\n  ","date":"2021-10-09T22:00:38+08:00","image":"https://zcj-git520.github.io/p/golang/2_hu3607656af67f333528ae9e7b0ed06a62_30106_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/golang/","title":"go errorç±»å‹è½¬json"},{"content":"go åç¨‹goroutine  åç¨‹æ˜¯ç”¨æˆ·çº§çš„çº¿ç¨‹ï¼Œæœ‰ç”¨æˆ·è‡ªå·±è°ƒåº¦ï¼Œä½¿ç”¨åç¨‹ä½¿å¾—ç¨‹åºè°ƒåº¦æ›´åŠ çµæ´»ã€‚åŒæ—¶æ¯”çº¿ç¨‹æ›´è½»é‡ï¼Œå ç”¨çš„æ ˆå†…å­˜æ›´å°‘ã€‚goè¯­è¨€å¤©ç”Ÿæ”¯æŒé«˜å¹¶å‘ï¼Œgoä½¿ç”¨åç¨‹goroutineçš„è°ƒåº¦å™¨ã€‚goroutine çš„æ ˆå†…å­˜æœ€å°å€¼ä¸º2kb(_StackMin = 2048),å®ƒä¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œå¯ä»¥éšéœ€æ±‚å¢å¤§å’Œç¼©å°ã€‚goroutine ç»´æŠ¤ç€å¾ˆå¤§çš„å†…å­˜ï¼Œæ— éœ€é¢‘ç¹å¼€è¾Ÿå†…å­˜ï¼Œgoroutineæ˜¯ä½¿ç”¨M:næ¨¡å‹ï¼Œåœ¨ç”¨æˆ·æ€åˆ‡æ¢åç¨‹ï¼ŒåŠ ä¸Šåˆ›å»ºåç¨‹ä»£ä»·ä½ï¼Œä½¿å¾—cpuçš„åˆ©ç”¨ç‡å¤§å¤§æå‡ï¼Œcupçš„æ€§èƒ½å¤§å¹…åº¦çš„è¢«åˆ©ç”¨ã€‚  goroutine è°ƒåº¦å™¨GPMæ¨¡å‹ G  G å°±æ˜¯goroutineåç¨‹  type g struct { // Stack parameters. // stack describes the actual stack memory: [stack.lo, stack.hi). // stackguard0 is the stack pointer compared in the Go stack growth prologue. // It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption. // stackguard1 is the stack pointer compared in the C stack growth prologue. // It is stack.lo+StackGuard on g0 and gsignal stacks. // It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash). // è®°å½•è¯¥goroutineä½¿ç”¨çš„æ ˆ stack stack // offset known to runtime/cgo //ä¸‹é¢ä¸¤ä¸ªæˆå‘˜ç”¨äºæ ˆæº¢å‡ºæ£€æŸ¥ï¼Œå®ç°æ ˆçš„è‡ªåŠ¨ä¼¸ç¼©ï¼ŒæŠ¢å è°ƒåº¦ä¹Ÿä¼šç”¨åˆ°stackguard0 stackguard0 uintptr // offset known to liblink stackguard1 uintptr // offset known to liblink _panic *_panic // innermost panic - offset known to liblink _defer *_defer // innermost defer // æ­¤goroutineæ­£åœ¨è¢«å“ªä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œ m *m // current m; offset known to arm liblink //è¿™ä¸ªå­—æ®µè·Ÿè°ƒåº¦åˆ‡æ¢æœ‰å…³ï¼ŒGåˆ‡æ¢æ—¶ç”¨æ¥ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œä¿å­˜ä»€ä¹ˆï¼Œçœ‹ä¸‹é¢gobufç»“æ„ä½“ sched gobuf syscallsp uintptr // if status==Gsyscall, syscallsp = sched.sp to use during gc syscallpc uintptr // if status==Gsyscall, syscallpc = sched.pc to use during gc stktopsp uintptr // expected sp at top of stack, to check in traceback param unsafe.Pointer // passed parameter on wakeupï¼Œwakeupå”¤é†’æ—¶ä¼ é€’çš„å‚æ•° // çŠ¶æ€Gidle,Grunnable,Grunning,Gsyscall,Gwaiting,Gdead atomicstatus uint32 stackLock uint32 // sigprof/scang lock; TODO: fold in to atomicstatus goid int64 //schedlinkå­—æ®µæŒ‡å‘å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªgï¼Œ //æ‰€æœ‰ä½äºå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„gå½¢æˆä¸€ä¸ªé“¾è¡¨ schedlink guintptr waitsince int64 // approx time when the g become blocked waitreason waitReason // if status==Gwaitingï¼Œgè¢«é˜»å¡çš„åŸå›  //æŠ¢å ä¿¡å·ï¼Œstackguard0 = stackpreemptï¼Œå¦‚æœéœ€è¦æŠ¢å è°ƒåº¦ï¼Œè®¾ç½®preemptä¸ºtrue preempt bool // preemption signal, duplicates stackguard0 = stackpreempt paniconfault bool // panic (instead of crash) on unexpected fault address preemptscan bool // preempted g does scan for gc gcscandone bool // g has scanned stack; protected by _Gscan bit in status gcscanvalid bool // false at start of gc cycle, true if G has not run since last scan; TODO: remove? throwsplit bool // must not split stack raceignore int8 // ignore race detection events sysblocktraced bool // StartTrace has emitted EvGoInSyscall about this goroutine sysexitticks int64 // cputicks when syscall has returned (for tracing) traceseq uint64 // trace event sequencer tracelastp puintptr // last P emitted an event for this goroutine // å¦‚æœè°ƒç”¨äº† LockOsThreadï¼Œé‚£ä¹ˆè¿™ä¸ª g ä¼šç»‘å®šåˆ°æŸä¸ª m ä¸Š lockedm muintptr sig uint32 writebuf []byte sigcode0 uintptr sigcode1 uintptr sigpc uintptr // åˆ›å»ºè¿™ä¸ªgoroutineçš„goè¡¨è¾¾å¼çš„pc gopc uintptr // pc of go statement that created this goroutine ancestors *[]ancestorInfo // ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors) startpc uintptr // pc of goroutine function racectx uintptr waiting *sudog // sudog structures this g is waiting on (that have a valid elem ptr); in lock order cgoCtxt []uintptr // cgo traceback context labels unsafe.Pointer // profiler labels timer *timer // cached timer for time.Sleep,ä¸º time.Sleep ç¼“å­˜çš„è®¡æ—¶å™¨ selectDone uint32 // are we participating in a select and did someone win the race? // Per-G GC state // gcAssistBytes is this G's GC assist credit in terms of // bytes allocated. If this is positive, then the G has credit // to allocate gcAssistBytes bytes without assisting. If this // is negative, then the G must correct this by performing // scan work. We track this in bytes to make it fast to update // and check for debt in the malloc hot path. The assist ratio // determines how this corresponds to scan work debt. gcAssistBytes int64 }  ä¿å­˜ç€goroutineæ‰€æœ‰ä¿¡æ¯ä»¥åŠæ ˆä¿¡æ¯ï¼Œgobufç»“æ„ä½“ï¼šcpué‡Œçš„å¯„å­˜å™¨ä¿¡æ¯  P processorå¤„ç†å™¨  è°ƒåº¦åç¨‹Gå’Œçº¿ç¨‹Mçš„å…³è”  P çš„ç»“æ„ä½“å¦‚ä¸‹ï¼š type p struct { //allpä¸­çš„ç´¢å¼• id int32 //pçš„çŠ¶æ€ status uint32 // one of pidle/prunning/... link puintptr schedtick uint32 // incremented on every scheduler call-\u0026gt;æ¯æ¬¡schedulerè°ƒç”¨+1 syscalltick uint32 // incremented on every system call-\u0026gt;æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨+1 sysmontick sysmontick // last tick observed by sysmon //æŒ‡å‘ç»‘å®šçš„ mï¼Œå¦‚æœ p æ˜¯ idle çš„è¯ï¼Œé‚£è¿™ä¸ªæŒ‡é’ˆæ˜¯ nil m muintptr // back-link to associated m (nil if idle) mcache *mcache raceprocctx uintptr //ä¸åŒå¤§å°å¯ç”¨deferç»“æ„æ±  deferpool [5][]*_defer // pool of available defer structs of different sizes (see panic.go) deferpoolbuf [5][32]*_defer // Cache of goroutine ids, amortizes accesses to runtimeÂ·sched.goidgen. goidcache uint64 goidcacheend uint64 //æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼Œå¯ä»¥æ— é”è®¿é—® // Queue of runnable goroutines. Accessed without lock. runqhead uint32 //é˜Ÿåˆ—å¤´ runqtail uint32 //é˜Ÿåˆ—å°¾ //æ•°ç»„å®ç°çš„å¾ªç¯é˜Ÿåˆ— runq [256]guintptr // runnext, if non-nil, is a runnable G that was ready'd by // the current G and should be run next instead of what's in // runq if there's time remaining in the running G's time // slice. It will inherit the time left in the current time // slice. If a set of goroutines is locked in a // communicate-and-wait pattern, this schedules that set as a // unit and eliminates the (potentially large) scheduling // latency that otherwise arises from adding the ready'd // goroutines to the end of the run queue. // runnext éç©ºæ—¶ï¼Œä»£è¡¨çš„æ˜¯ä¸€ä¸ª runnable çŠ¶æ€çš„ Gï¼Œ //è¿™ä¸ª G è¢« å½“å‰ G ä¿®æ”¹ä¸º ready çŠ¶æ€ï¼Œç›¸æ¯” runq ä¸­çš„ G æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚ //å¦‚æœå½“å‰ G è¿˜æœ‰å‰©ä½™çš„å¯ç”¨æ—¶é—´ï¼Œé‚£ä¹ˆå°±åº”è¯¥è¿è¡Œè¿™ä¸ª G //è¿è¡Œä¹‹åï¼Œè¯¥ G ä¼šç»§æ‰¿å½“å‰ G çš„å‰©ä½™æ—¶é—´ runnext guintptr // Available G's (status == Gdead) //ç©ºé—²çš„g gFree struct { gList n int32 } sudogcache []*sudog sudogbuf [128]*sudog tracebuf traceBufPtr // traceSweep indicates the sweep events should be traced. // This is used to defer the sweep start event until a span // has actually been swept. traceSweep bool // traceSwept and traceReclaimed track the number of bytes // swept and reclaimed by sweeping in the current sweep loop. traceSwept, traceReclaimed uintptr palloc persistentAlloc // per-P to avoid mutex _ uint32 // Alignment for atomic fields below // Per-P GC state gcAssistTime int64 // Nanoseconds in assistAlloc gcFractionalMarkTime int64 // Nanoseconds in fractional mark worker (atomic) gcBgMarkWorker guintptr // (atomic) gcMarkWorkerMode gcMarkWorkerMode // gcMarkWorkerStartTime is the nanotime() at which this mark // worker started. gcMarkWorkerStartTime int64 // gcw is this P's GC work buffer cache. The work buffer is // filled by write barriers, drained by mutator assists, and // disposed on certain GC state transitions. gcw gcWork // wbBuf is this P's GC write barrier buffer. // // TODO: Consider caching this in the running G. wbBuf wbBuf runSafePointFn uint32 // if 1, run sched.safePointFn at next safe point pad cpu.CacheLinePad }  è®°å½•ç€Pçš„ä¿¡æ¯ï¼Œä»¥åŠGçš„çŠ¶æ€ç­‰ã€‚åŒæ—¶Pæ˜¯æœ‰ç€æœ¬åœ°é˜Ÿåˆ—ï¼Œå­˜æ”¾ç€å¸¦å¾…è¿è¡Œçš„G,æœ¬åœ°é˜Ÿåˆ—ä¸èƒ½è¶…è¿‡256ä¸ªã€‚ Pçš„æ•°é‡ï¼šæ˜¯ç”±ç¯å¢ƒå˜é‡ $GOMAXPROCS æˆ–è€…æ˜¯ç”± runtime çš„æ–¹æ³• GOMAXPROCS() å†³å®šã€‚åœ¨ç¨‹åºå¯åŠ¨å¼åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰ GOMAXPROCS(å¯é…ç½®) ä¸ª  M æ˜¯å†…æ ¸æ€çº¿ç¨‹çš„æŠ½è±¡  ä¸»è¦çš„å·¥ä½œæ‰§è¡Œåç¨‹Gæˆ–è€…åœ¨è°ƒåº¦Gåˆ°Pä¸­  Mçš„ç»“æ„ä½“å¦‚ä¸‹ï¼š type m struct { // ç³»ç»Ÿç®¡ç†çš„ä¸€ä¸ªgï¼Œæ‰§è¡Œè°ƒåº¦ä»£ç æ—¶ä½¿ç”¨çš„ã€‚æ¯”å¦‚æ‰§è¡Œç”¨æˆ·çš„goroutineæ—¶ï¼Œå°±éœ€è¦æŠŠæŠŠç”¨æˆ· // çš„æ ˆä¿¡æ¯æ¢åˆ°å†…æ ¸çº¿ç¨‹çš„æ ˆï¼Œä»¥ä¾¿èƒ½å¤Ÿæ‰§è¡Œç”¨æˆ·goroutine g0 *g // goroutine with scheduling stack morebuf gobuf // gobuf arg to morestack divmod uint32 // div/mod denominator for arm - known to liblink // Fields not known to debuggers. procid uint64 // for debuggers, but offset not hard-coded //å¤„ç†signalçš„ g gsignal *g // signal-handling g goSigStack gsignalStack // Go-allocated signal handling stack sigmask sigset // storage for saved signal mask //çº¿ç¨‹çš„æœ¬åœ°å­˜å‚¨TLSï¼Œè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆOSçº¿ç¨‹èƒ½è¿è¡ŒMå…³é”®åœ°æ–¹ tls [6]uintptr // thread-local storage (for x86 extern register) //go å…³é”®å­—è¿è¡Œçš„å‡½æ•° mstartfn func() //å½“å‰è¿è¡Œçš„ç”¨æˆ·goroutineçš„gç»“æ„ä½“å¯¹è±¡ curg *g // current running goroutine caughtsig guintptr // goroutine running during fatal signal //å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pï¼Œå¦‚æœæ²¡æœ‰å°±ä¸ºnil p puintptr // attached p for executing go code (nil if not executing go code) //æš‚å­˜ä¸å½“å‰Mæ½œåœ¨å…³è”çš„P nextp puintptr //Mä¹‹å‰è°ƒç”¨çš„P oldp puintptr // the p that was attached before executing a syscall id int64 mallocing int32 throwing int32 //å½“å‰Mæ˜¯å¦å…³é—­æŠ¢å å¼è°ƒåº¦ preemptoff string // if != \u0026quot;\u0026quot;, keep curg running on this m locks int32 dying int32 profilehz int32 //Mçš„è‡ªæ—‹çŠ¶æ€ï¼Œä¸ºtrueæ—¶Må¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œæ­£åœ¨ä»å…¶ä»–çº¿ç¨‹å·G; ä¸ºfalseï¼Œä¼‘çœ çŠ¶æ€ spinning bool // m is out of work and is actively looking for work blocked bool // m is blocked on a note newSigstack bool // minit on C thread called sigaltstack printlock int8 incgo bool // m is executing a cgo call freeWait uint32 // if == 0, safe to free g0 and delete m (atomic) fastrand [2]uint32 needextram bool traceback uint8 ncgocall uint64 // number of cgo calls in total ncgo int32 // number of cgo calls currently in progress cgoCallersUse uint32 // if non-zero, cgoCallers in use temporarily cgoCallers *cgoCallers // cgo traceback if crashing in cgo call //æ²¡æœ‰goroutineè¿è¡Œæ—¶ï¼Œå·¥ä½œçº¿ç¨‹ç¡çœ  //é€šè¿‡è¿™ä¸ªæ¥å”¤é†’å·¥ä½œçº¿ç¨‹ park note // ä¼‘çœ é” //è®°å½•æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„é“¾è¡¨ alllink *m // on allm schedlink muintptr //å½“å‰çº¿ç¨‹å†…å­˜åˆ†é…çš„æœ¬åœ°ç¼“å­˜ mcache *mcache //å½“å‰Mé”å®šçš„Gï¼Œ lockedg guintptr createstack [32]uintptr // stack that created this thread. lockedExt uint32 // tracking for external LockOSThread lockedInt uint32 // tracking for internal lockOSThread nextwaitm muintptr // next m waiting for lock waitunlockf func(*g, unsafe.Pointer) bool waitlock unsafe.Pointer waittraceev byte waittraceskip int startingtrace bool syscalltick uint32 //æ“ä½œç³»ç»Ÿçº¿ç¨‹id thread uintptr // thread handle freelink *m // on sched.freem // these are here because they are too large to be on the stack // of low-level NOSPLIT functions. libcall libcall libcallpc uintptr // for cpu profiler libcallsp uintptr libcallg guintptr syscall libcall // stores syscall parameters on windows vdsoSP uintptr // SP for traceback while in VDSO call (0 if not in call) vdsoPC uintptr // PC for traceback while in VDSO call dlogPerM mOS }  è®°å½•ç€Mçš„çº¿ç¨‹çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸€äº›P,Gä»¥åŠä¿¡å·å’Œè‡ªæ—‹é”ç­‰ä¿¡æ¯ m æ•°é‡ï¼šå¯ä»¥é€šè¿‡SetMaxThreadså‡½æ•°ï¼Œè®¾ç½® M çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º10000(sched.maxmcount = 10000)ï¼Œå’ŒPä¸€æ ·åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºã€‚  å…¨å±€é˜Ÿåˆ—ï¼ˆgQueueï¼‰  Pçš„æœ¬åœ°é˜Ÿåˆ—å¯ä»¥å­˜æ”¾ç€ä¸è¶…è¿‡256ä¸ªå¾…æ‰§è¡Œçš„G,Pæ˜¯æœ‰é™çš„ï¼Œå½“Gè¿‡å¤šæ—¶ï¼Œå³å½“Pæœ¬åœ°é˜Ÿåˆ—å­˜æ”¾ä¸ä¸‹æ—¶ï¼Œå°±éœ€è¦å°†Gå­˜æ”¾åœ¨å…¨å±€é˜Ÿåˆ—ä¸­ã€‚  å…¨å±€é˜Ÿåˆ—ç»“æ„å¦‚ä¸‹ï¼š type gQueue struct { head guintptr //é˜Ÿåˆ—å¤´ tail guintptr //é˜Ÿåˆ—å°¾ } Gã€Pã€Mã€gQueueå…³ç³»  Pä¸Mæ²¡æœ‰æ•°é‡å…³ç³»ï¼Œå½“ä¸€ä¸ªMå¤„äºé˜»å¡æ—¶ï¼ŒPå…ˆæ‰¾ç©ºé—²M,æ²¡æœ‰ç©ºé—²çš„Må°±åˆ›å»ºæ–°çš„M Gä¼˜å…ˆå­˜æ”¾åœ¨Pæœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå½“Pä¸­Gæ»¡æ—¶ï¼Œä¼šå°†Pä¸­å‰ä¸€åŠGå­˜æ”¾åœ¨å…¨å±€ä¸­ã€‚å½“Pç©ºé—²æ—¶æ—¶ï¼Œä¼šä»å…¨å±€ä¸­æ‹¿å–Gæ”¾åœ¨æœ¬åœ°é˜Ÿåˆ—ã€‚å…¨å±€æ²¡æœ‰Gæ—¶ï¼Œä¼šä»å…¶Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­æ‹¿å–ä¸€åŠåˆ°æœ¬åœ°é˜Ÿåˆ—ã€‚ å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š\n\r  åˆ›å»ºgoroutine newproc()å‡½æ•°  goroutine æ˜¯ç”±å‡½æ•°newprocå‡½æ•°è¿›è¡Œåˆ›å»ºçš„ï¼Œnewprocæºç å¦‚ä¸‹  // å‚æ•°ï¼šåç¨‹å‡½æ•°çš„å‚æ•°å çš„å­—èŠ‚æ•°å’Œåç¨‹å…¥å£å‡½æ•°çš„funcvalæŒ‡é’ˆ func newproc(siz int32, fn *funcval) { // è·å¾—åç¨‹å‚æ•°çš„åœ°å€= fnå‡½æ•°åœ°å€+åç§»å€¼ argp := add(unsafe.Pointer(\u0026amp;fn), sys.PtrSize) gp := getg() // è·å¾—å½“å‰Gçš„æŒ‡é’ˆ //è°ƒç”¨è€…çš„pcï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œå®Œæ­¤å‡½æ•°è¿”å›è°ƒç”¨è€…æ—¶çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ pc := getcallerpc() // åˆ‡æ¢åˆ°ï¼ˆç³»ç»Ÿæ ˆï¼‰g0æ ˆä¸­ systemstack(func() { //æ‰§è¡Œè°ƒç”¨newproc1()å‡½æ•°æ‰§è¡Œåˆ›å»ºåç¨‹ newg := newproc1(fn, argp, siz, gp, pc) _p_ := getg().m.p.ptr() // æŠŠå½“å‰çš„Gå­˜æ”¾åœ¨runqé˜Ÿåˆ—ä¸­ runqput(_p_, newg, true) // å¦‚æœå½“å‰ç”±ç©ºé—²çš„P,æ²¡æœ‰ç¡çœ çš„M,ä¸»åç¨‹å¼€å§‹è¿è¡Œæ—¶ if mainStarted { wakep() // åˆ›å»ºm,å¹¶è®¾ç½®ä¸ºæ´»è·ƒçŠ¶æ€ } }) }  åœ¨newprocå‡½æ•°ä¸­ä¸ºä»€ä¹ˆè¦åˆ‡æ¢åœ¨g0æ ˆä¸­æ‰§è¡Œå‘¢ï¼Ÿæ˜¯å› ä¸ºnewproc1()å‡½æ•°ä¸æ”¯æŒæ ˆå¢é•¿ï¼Œåç¨‹çš„æ ˆç©ºé—´å°(å‡ KB)ï¼Œä¸ºäº†é˜²æ­¢è¿è¡Œåç¨‹å‡½æ•°æ—¶æ ˆæº¢å‡ºï¼Œéœ€è¦åœ¨g0çš„æ ˆä¸Šè¿è¡Œï¼Œg0æ˜¯åˆ†é…åœ¨çº¿ç¨‹çš„æ ˆç©ºé—´(4MB)ä¸Šã€‚g0çš„æ ˆç©ºé—´å¾ˆå¤§ï¼Œè¿è¡Œåç¨‹å‡½æ•°æ—¶æ ˆä¸æº¢å‡ºã€‚  newproc1()å‡½æ•°  newproc1()æ˜¯åˆ›å»ºåç¨‹ æºç å¦‚ä¸‹ï¼š  å‚æ•°ï¼šåç¨‹å…¥å£ã€å‚æ•°é¦–åœ°å€ã€å‚æ•°å¤§å°ã€çˆ¶åç¨‹æŒ‡é’ˆã€è¿”å›åœ°å€ func newproc1(fn *funcval, argp unsafe.Pointer, narg int32, callergp *g, callerpc uintptr) *g { _g_ := getg() // è·å¾—å½“å‰çš„G if fn == nil { _g_.m.throwing = -1 // do not dump full stacks throw(\u0026quot;go of nil func value\u0026quot;) } // ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ä¼šç¦æ­¢å½“å‰mè¢«æŠ¢å  acquirem() // disable preemption because it can be holding p in a local var siz := narg siz = (siz + 7) \u0026amp;^ 7 // We could allocate a larger initial stack if necessary. // Not worth it: this is almost always an error. // 4*sizeof(uintreg): extra space added below // sizeof(uintreg): caller's LR (arm) or return address (x86, in gostartcall). if siz \u0026gt;= _StackMin-4*sys.RegSize-sys.RegSize { throw(\u0026quot;newproc: function arguments too large for new goroutine\u0026quot;) } _p_ := _g_.m.p.ptr() // å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„G,å¦‚æœæ²¡æœ‰ç©ºé—²çš„G,å°±ä¼šåˆ›å»ºæ–°çš„G,åˆ†é…æ ˆç©ºé—´,å¹¶æ·»åŠ åˆ°å…¨å±€allgsä¸­ newg := gfget(_p_) // å¦‚æœæ²¡æœ‰ç©ºé—²çš„G if newg == nil { // å°±ä¼šåˆ›å»ºæ–°çš„G,åˆ†é…æ ˆç©ºé—´å¤§å°ä¸ºæœ€å°çš„2KB newg = malg(_StackMin) // è®¾ç½®çŠ¶æ€ä¸ºç­‰å¾… casgstatus(newg, _Gidle, _Gdead) //å¹¶æ·»åŠ åˆ°å…¨å±€allgsä¸­ allgadd(newg) // publishes with a g-\u0026gt;status of Gdead so GC scanner doesn't look at uninitialized stack. } if newg.stack.hi == 0 { throw(\u0026quot;newproc1: newg missing stack\u0026quot;) } if readgstatus(newg) != _Gdead { throw(\u0026quot;newproc1: new g is not Gdead\u0026quot;) } totalSize := 4*sys.RegSize + uintptr(siz) + sys.MinFrameSize // extra space in case of reads slightly beyond frame totalSize += -totalSize \u0026amp; (sys.SpAlign - 1) // align to spAlign sp := newg.stack.hi - totalSize spArg := sp if usesLR { // caller's LR *(*uintptr)(unsafe.Pointer(sp)) = 0 prepGoExitFrame(sp) spArg += sys.MinFrameSize } if narg \u0026gt; 0 { // å¦‚æœåç¨‹å…¥å£å‡½æ•°ç”±å‚æ•°ï¼Œä¼šå°†å‚æ•°ç§»åŠ¨åœ¨åç¨‹æ ˆä¸­ memmove(unsafe.Pointer(spArg), argp, uintptr(narg)) // This is a stack-to-stack copy. If write barriers // are enabled and the source stack is grey (the // destination is always black), then perform a // barrier copy. We do this *after* the memmove // because the destination stack may have garbage on // it. if writeBarrier.needed \u0026amp;\u0026amp; !_g_.m.curg.gcscandone { f := findfunc(fn.fn) stkmap := (*stackmap)(funcdata(f, _FUNCDATA_ArgsPointerMaps)) if stkmap.nbit \u0026gt; 0 { // We're in the prologue, so it's always stack map index 0. bv := stackmapdata(stkmap, 0) bulkBarrierBitmap(spArg, spArg, uintptr(bv.n)*sys.PtrSize, 0, bv.bytedata) } } } // åˆå§‹åŒ–newg.schedè°ƒåº¦ç›¸å…³çš„ä¿¡æ¯ memclrNoHeapPointers(unsafe.Pointer(\u0026amp;newg.sched), unsafe.Sizeof(newg.sched)) newg.sched.sp = sp //è®¾ç½®ä¸ºåç¨‹æ ˆæŒ‡é’ˆ newg.stktopsp = sp // è®¾ç½®ä¸ºæŒ‡å‘åç¨‹å…¥å£å‡½æ•°çš„å…¥å£ï¼Œå½“åç¨‹è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œè¿è¡Œåç¨‹å‡½æ•° newg.sched.pc = funcPC(goexit) + sys.PCQuantum // +PCQuantum so that previous instruction is in same function newg.sched.g = guintptr(unsafe.Pointer(newg)) gostartcallfn(\u0026amp;newg.sched, fn) // è®¾ç½®ä¸ºçˆ¶åç¨‹è°ƒç”¨newprocå‡½æ•°ç»“æŸåçš„è¿”å›åœ°å€ newg.gopc = callerpc newg.ancestors = saveAncestors(callergp) // è®¾ç½®startpcä¸ºåç¨‹å…¥å­”å‡½æ•°çš„èµ·å§‹åœ°å€ newg.startpc = fn.fn if _g_.m.curg != nil { newg.labels = _g_.m.curg.labels } if isSystemGoroutine(newg, false) { atomic.Xadd(\u0026amp;sched.ngsys, +1) } // è®¾ç½®åç¨‹ä¸ºè¿è¡ŒçŠ¶æ€ casgstatus(newg, _Gdead, _Grunnable) if _p_.goidcache == _p_.goidcacheend { // Sched.goidgen is the last allocated id, // this batch must be [sched.goidgen+1, sched.goidgen+GoidCacheBatch]. // At startup sched.goidgen=0, so main goroutine receives goid=1. _p_.goidcache = atomic.Xadd64(\u0026amp;sched.goidgen, _GoidCacheBatch) _p_.goidcache -= _GoidCacheBatch - 1 _p_.goidcacheend = _p_.goidcache + _GoidCacheBatch } // ç»™åç¨‹èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„goid newg.goid = int64(_p_.goidcache) _p_.goidcache++ if raceenabled { newg.racectx = racegostart(callerpc) } if trace.enabled { traceGoCreate(newg, newg.startpc) } // å…è®¸å½“å‰mè¢«æŠ¢å  releasem(_g_.m) return newg } å›¾ç¤ºå¦‚ä¸‹\n\r\n æ€»ç»“goroutineåˆ›å»ºè¿‡ç¨‹   ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ä¼šç¦æ­¢å½“å‰mè¢«æŠ¢å  å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„G,å¦‚æœæ²¡æœ‰ç©ºé—²çš„G,å°±ä¼šåˆ›å»ºæ–°çš„G,åˆ†é…æ ˆç©ºé—´,çŠ¶æ€ä¸ºç­‰å¾…å¹¶æ·»åŠ åˆ°å…¨å±€allgsä¸­ å¦‚æœåç¨‹å…¥å£å‡½æ•°ç”±å‚æ•°ï¼Œä¼šå°†å‚æ•°ç§»åŠ¨åœ¨åç¨‹æ ˆä¸­ åˆå§‹åŒ–newg.schedè°ƒåº¦ç›¸å…³çš„ä¿¡æ¯ï¼Œè®¾ç½®çŠ¶æ€è¿è¡Œ å¾—åˆ°å”¯ä¸€çš„goid, å¹¶æ·»åŠ åˆ°runqé˜Ÿåˆ—ä¸­ å¦‚æœå½“å‰æœ‰ç©ºé—²çš„P,æ²¡æœ‰ç¡çœ çš„M,å¹¶ä¸”ä¸»åç¨‹å¼€å§‹è¿è¡Œæ—¶ï¼Œå°±ä¼šåˆ›å»ºæ–°çš„æ´»è·ƒçš„M å½“gè¿è¡Œç»“æŸåï¼Œè®¾ç½®å…è®¸å½“å‰mè¢«æŠ¢å   goroutineçš„è®©å‡ºä¸æ¢å¤ã€è°ƒåº¦ã€æŠ¢å ã€ç›‘æ§ goroutine è®©å‡ºä¸æ¢å¤  åç¨‹çš„è®©å‡ºæ˜¯ç”±å‡½æ•°gopark()æ‰§è¡Œçš„  æºç å¦‚ä¸‹ï¼š func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) { if reason != waitReasonSleep { checkTimeouts() // timeouts may expire while two goroutines keep the scheduler busy } // ç¦æ­¢å½“å‰mè¢«æŠ¢å  mp := acquirem() gp := mp.curg status := readgstatus(gp) // åˆ¤æ–­åç¨‹çš„æ˜¯å¦åœ¨è¿è¡ŒçŠ¶æ€ if status != _Grunning \u0026amp;\u0026amp; status != _Gscanrunning { throw(\u0026quot;gopark: bad g status\u0026quot;) } mp.waitlock = lock mp.waitunlockf = unlockf gp.waitreason = reason mp.waittraceev = traceEv mp.waittraceskip = traceskip // è§£é™¤å¯¹mçš„æŠ¢å  releasem(mp) // can't do anything that might move the G between Ms here. // ä¸èƒ½åšä»»ä½•å¯èƒ½åœ¨ Ms ä¹‹é—´ç§»åŠ¨ G çš„äº‹æƒ…ã€‚ // ä¿å­˜åç¨‹ï¼Œåˆ‡æ¢åœ¨go mcall(park_m) } func park_m(gp *g) { _g_ := getg() if trace.enabled { traceGoPark(_g_.m.waittraceev, _g_.m.waittraceskip) } //æ›´æ”¹åç¨‹ç”±è¿è¡ŒçŠ¶æ€åˆ°ç­‰å¾…çŠ¶æ€ casgstatus(gp, _Grunning, _Gwaiting) dropg() \u0026quot;\u0026quot;\u0026quot; func dropg() { _g_ := getg() // æŠŠmå½“å‰æ‰§è¡Œçš„ç½®ä¸ºnil(mä¸åœ¨è¿è¡Œè¿™ä¸ªå½“å‰å†™åç¨‹ï¼Œåç¨‹å°±æŒ‚èµ·äº†) setMNoWB(\u0026amp;_g_.m.curg.m, nil) setGNoWB(\u0026amp;_g_.m.curg, nil) } \u0026quot;\u0026quot;\u0026quot; if fn := _g_.m.waitunlockf; fn != nil { ok := fn(gp, _g_.m.waitlock) _g_.m.waitunlockf = nil _g_.m.waitlock = nil if !ok { if trace.enabled { traceGoUnpark(gp, 2) } casgstatus(gp, _Gwaiting, _Grunnable) execute(gp, true) // Schedule it back, never returns. } } schedule() // å¯»æ‰¾ä¸‹ä¸€ä¸ªG } //åœ¨Gä¸­ç”±å®šæ—¶è°ƒç”¨å›è°ƒå‡½æ•°f type timer struct { // If this timer is on a heap, which P's heap it is on. // puintptr rather than *p to match uintptr in the versions // of this struct defined in other packages. pp puintptr // Timer wakes up at when, and then at when+period, ... (period \u0026gt; 0 only) // each time calling f(arg, now) in the timer goroutine, so f must be // a well-behaved function and not block. // // when must be positive on an active timer. when int64 period int64 f func(interface{}, uintptr) arg interface{} seq uintptr // What to set the when field to in timerModifiedXX status. nextwhen int64 // The status field holds one of the values below. status uint32 } // Mark gp ready to run. // å°†ç­‰å¾…åç¨‹çŠ¶æ€ç½®ä¸ºè¿è¡Œçš„çŠ¶æ€ func ready(gp *g, traceskip int, next bool) { if trace.enabled { traceGoUnpark(gp, traceskip) } status := readgstatus(gp) // Mark runnable. _g_ := getg() //// ç¦æ­¢å½“å‰mè¢«æŠ¢å  mp := acquirem() // disable preemption because it can be holding p in a local var if status\u0026amp;^_Gscan != _Gwaiting { dumpgstatus(gp) throw(\u0026quot;bad g-\u0026gt;status in ready\u0026quot;) } // status is Gwaiting or Gscanwaiting, make Grunnable and put on runq casgstatus(gp, _Gwaiting, _Grunnable) // æŠŠåç¨‹ç­‰å¾…çš„è½¬æ€ç½®ä¸ºå¯è¿è¡ŒçŠ¶æ€ runqput(_g_.m.p.ptr(), gp, next) // æ·»åŠ åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ wakep()// å¦‚æœæ²¡æœ‰å¯æ‰§è¡Œçš„M,å°±åˆ›å»ºæ–°çš„m releasem(mp) // é‡Šæ”¾å½“å‰çš„m } å¦‚å›¾æ‰€ç¤º \r\n æ€»ç»“   gopark()æ˜¯è®©å‡ºå‡½æ•°ï¼Œç¦æ­¢å½“å‰mè¢«æŠ¢å ï¼Œåˆ¤æ–­å½“å‰çš„åç¨‹çŠ¶æ€æ˜¯å¦ä¸ºè¿è¡ŒçŠ¶æ€ã€‚ dropg()è®©å½“å‰çš„mä¸åœ¨æ‰§è¡Œå½“å‰çš„G,ä¿®æ”¹å½“å‰gçš„çŠ¶æ€ä¸ºç­‰å¾…(åç¨‹æŒ‚èµ·)ï¼Œè°ƒç”¨schedule() å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯æ‰§è¡ŒG timers ç­‰å¾…çš„gä¸­æ•°æ®ç»“æ„ï¼Œå®šæ—¶è°ƒç”¨å›è°ƒå‡½æ•°fï¼Œå°†gç½®ä¸ºäº†è¿è¡ŒçŠ¶æ€ ready()å‡½æ•°æ˜¯å°†å”¤é†’ç­‰å¾…G,å°†Gçš„çŠ¶æ€æ›´æ”¹ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶æ·»åŠ åœ¨è¿è¡Œçš„é˜Ÿåˆ—ä¸­mï¼Œå¦‚æœæ²¡æœ‰å¯æ‰§è¡Œçš„M,å°±åˆ›å»ºæ–°çš„m  goroutine ç›‘æ§  ä½¿ç”¨checkTimers()æ£€æŸ¥åˆ°æ—¶é—´è¿è¡Œçš„å”¤é†’g  æºç å¦‚ä¸‹ checkTimers(pp *p, now int64) (rnow, pollUntil int64, ran bool) { // If it's not yet time for the first timer, or the first adjusted // timer, then there is nothing to do. next := int64(atomic.Load64(\u0026amp;pp.timer0When)) nextAdj := int64(atomic.Load64(\u0026amp;pp.timerModifiedEarliest)) if next == 0 || (nextAdj != 0 \u0026amp;\u0026amp; nextAdj \u0026lt; next) { next = nextAdj } if next == 0 { // No timers to run or adjust. return now, 0, false } if now == 0 { now = nanotime() } if now \u0026lt; next { // Next timer is not ready to run, but keep going // if we would clear deleted timers. // This corresponds to the condition below where // we decide whether to call clearDeletedTimers. if pp != getg().m.p.ptr() || int(atomic.Load(\u0026amp;pp.deletedTimers)) \u0026lt;= int(atomic.Load(\u0026amp;pp.numTimers)/4) { return now, next, false } } lock(\u0026amp;pp.timersLock) if len(pp.timers) \u0026gt; 0 { adjusttimers(pp, now) for len(pp.timers) \u0026gt; 0 { // Note that runtimer may temporarily unlock // pp.timersLock. if tw := runtimer(pp, now); tw != 0 { if tw \u0026gt; 0 { pollUntil = tw } break } ran = true } } // If this is the local P, and there are a lot of deleted timers, // clear them out. We only do this for the local P to reduce // lock contention on timersLock. if pp == getg().m.p.ptr() \u0026amp;\u0026amp; int(atomic.Load(\u0026amp;pp.deletedTimers)) \u0026gt; len(pp.timers)/4 { clearDeletedTimers(pp) } unlock(\u0026amp;pp.timersLock) return now, pollUntil, ran }  åç¨‹çš„ç›‘æ§æ˜¯ç”±ä¸“é—¨çš„ç›‘æ§åç¨‹ç¨‹æ¥è¿è¡Œï¼Œç›‘æ§åç¨‹æ˜¯ç”±ä¸»åç¨‹åˆ›å»ºè€Œæ¥ ï¼Œç›‘æ§åç¨‹ä¸gpmä¸­çš„åç¨‹ä¸ä¸€æ ·ï¼Œå®ƒä¸æ˜¯ç”±gpmè¿›è¡Œè°ƒåº¦ï¼Œå½“ç„¶äº†ä¹Ÿä¸éœ€è¦P, ç›‘æ§timerï¼Œå¹¶æŒ‰éœ€è°ƒæ•´gçš„ä¼‘çœ æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰å¯æ‰§è¡Œçš„M,å°±åˆ›å»ºæ–°çš„mæ‰§è¡Œè¢«å”¤é†’çš„G, ç¡®ä¿è¢«å”¤é†’gè¢«æ‰§è¡Œã€‚ å¦‚å›¾ \r  goroutine æŠ¢å   å¯¹è¿è¡Œè¿‡é•¿çš„gè¿›è¡ŒæŠ¢å ï¼Œå³å½“gè¿è¡Œæ—¶é—´è¶…è¿‡è¿è¡Œé˜ˆå€¼çš„gå¼ºåˆ¶è®©å‡ºm è¿è¡Œæ—¶é—´æ˜¯ç”±Pçš„ç»“æ„syscalltickã€schedtickã€timer0Whenç­‰è®°å½•ã€‚ é€šè¿‡æ ˆå¢é•¿æ—¶ï¼šå½“stackguard = stackPreempt,ä¸æ‰§è¡Œæ ˆå¢é•¿ï¼Œè€Œæ˜¯æ‰§è¡Œåç¨‹è°ƒåº¦, è¿™æ ·å°±è®©åç¨‹è®©å‡ºæ ˆã€‚ è¿™ç§æŠ¢å ä¾èµ–æ ˆå¢é•¿ï¼Œæœ‰ç¼ºé™·ã€‚æ‰€ä»¥æœ‰asyncPreempté€šè¿‡ä¿¡å·æ–¹å¼è¿›è¡Œå¼‚æ­¥æŠ¢å \nå¦‚å›¾æ‰€ç¤º \r  goroutine è°ƒåº¦  è°ƒç”¨schedule()å‡½æ•°è¿›è¡Œåç¨‹çš„è°ƒåº¦  æºç å¦‚ä¸‹ï¼š func schedule() { _g_ := getg() // è·å¾—å½“å‰çš„G if _g_.m.locks != 0 { throw(\u0026quot;schedule: holding locks\u0026quot;) } // åˆ¤æ–­å½“å‰çš„Må’Œå½“å‰çš„Gæ˜¯å¦ç»‘å®š if _g_.m.lockedg != 0 { // å¦‚æœå½“å‰çš„Mç»‘å®šG,å°±é˜»å¡m(ä¼‘çœ M) stoplockedm() execute(_g_.m.lockedg.ptr(), false) // Never returns. } // We should not schedule away from a g that is executing a cgo call, // since the cgo call is using the m's g0 stack. if _g_.m.incgo { throw(\u0026quot;schedule: in cgo\u0026quot;) } top: pp := _g_.m.p.ptr() pp.preempt = false // åˆ¤æ–­Gcæ˜¯å¦åœ¨ç­‰å¾…æ‰§è¡Œ if sched.gcwaiting != 0 { //æ˜¯åœ¨ç­‰å¾…æ‰§è¡Œï¼Œå…ˆæ‰§è¡Œgcï¼Œæ‰§è¡Œå®Œåœ¨æ‰§è¡Œåç»­æ“ä½œ gcstopm() goto top } if pp.runSafePointFn != 0 { runSafePointFn() } // Sanity check: if we are spinning, the run queue should be empty. // Check this before calling checkTimers, as that might call // goready to put a ready goroutine on the local run queue. if _g_.m.spinning \u0026amp;\u0026amp; (pp.runnext != 0 || pp.runqhead != pp.runqtail) { throw(\u0026quot;schedule: spinning with local work\u0026quot;) } //æ£€æŸ¥æ˜¯å¦æœ‰è¦è¢«æ‰§è¡Œçš„Timer checkTimers(pp, 0) var gp *g var inheritTime bool // Normal goroutines will check for need to wakeP in ready, // but GCworkers and tracereaders will not, so the check must // be done here instead. // æ™®é€šçš„ goroutine ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦åœ¨å‡†å¤‡å¥½æ—¶å”¤é†’ï¼Œ // ä½† GCworkers å’Œè·Ÿè¸ªè¯»å–å™¨ä¸ä¼šï¼Œæ‰€ä»¥æ£€æŸ¥å¿…é¡» // åœ¨è¿™é‡Œå®Œæˆã€‚ tryWakeP := false if trace.enabled || trace.shutdown { gp = traceReader() if gp != nil { casgstatus(gp, _Gwaiting, _Grunnable) traceGoUnpark(gp, 0) tryWakeP = true } } if gp == nil \u0026amp;\u0026amp; gcBlackenEnabled != 0 { gp = gcController.findRunnableGCWorker(_g_.m.p.ptr()) tryWakeP = tryWakeP || gp != nil } if gp == nil { // Check the global runnable queue once in a while to ensure fairness. // Otherwise two goroutines can completely occupy the local runqueue // by constantly respawning each other. / æ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥ä¸€ä¸‹å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä»¥ç¡®ä¿å…¬å¹³ã€‚ // å¦åˆ™ä¸¤ä¸ª goroutine å¯ä»¥å®Œå…¨å ç”¨æœ¬åœ°è¿è¡Œé˜Ÿåˆ— // é€šè¿‡ä¸æ–­ç›¸äº’é‡ç”Ÿã€‚ // æœ‰%61çš„æ¦‚ç‡æŠŠGä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æ¬ç§»åˆ°æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ï¼Œä¿éšœæœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ— æœ‰Gè¿è¡Œï¼Œå…¨å±€é˜Ÿåˆ—ä¹Ÿèƒ½æ”¾åœ¨æœ¬éƒ½é˜Ÿåˆ—ä¸­ if _g_.m.p.ptr().schedtick%61 == 0 \u0026amp;\u0026amp; sched.runqsize \u0026gt; 0 { lock(\u0026amp;sched.lock) gp = globrunqget(_g_.m.p.ptr(), 1) unlock(\u0026amp;sched.lock) } } if gp == nil { // æ²¡æœ‰å¾…è¿è¡Œçš„G å°±ç°åœ¨æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—æŸ¥æ‰¾ gp, inheritTime = runqget(_g_.m.p.ptr()) // We can see gp != nil here even if the M is spinning, // if checkTimers added a local goroutine via goready. } if gp == nil { // æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰ï¼Œå°±è°ƒç”¨findrunnable()ï¼Œç›´åˆ°æœ‰å¾…æ‰§è¡Œçš„gæ‰è¿”å›(å…ˆåœ¨æœ¬åœ° è¿è¡Œé˜Ÿåˆ—ï¼Œå…¨å±€é˜Ÿåˆ—ã€ç­‰å¾…çš„io, å…¶ä»–çš„P) gp, inheritTime = findrunnable() // blocks until work is available } // This thread is going to run a goroutine and is not spinning anymore, // so if it was marked as spinning we need to reset it now and potentially // start a new spinning M. if _g_.m.spinning { resetspinning() } if sched.disable.user \u0026amp;\u0026amp; !schedEnabled(gp) { // Scheduling of this goroutine is disabled. Put it on // the list of pending runnable goroutines for when we // re-enable user scheduling and look again. lock(\u0026amp;sched.lock) if schedEnabled(gp) { // Something re-enabled scheduling while we // were acquiring the lock. unlock(\u0026amp;sched.lock) } else { sched.disable.runnable.pushBack(gp) sched.disable.n++ unlock(\u0026amp;sched.lock) goto top } } // If about to schedule a not-normal goroutine (a GCworker or tracereader), // wake a P if there is one. if tryWakeP { wakep() } // åˆ¤æ–­è·å¾—çš„Gæœ‰æ²¡æœ‰ç»‘å®šçš„M,æœ‰å°±é˜»å¡g, å†æ¬¡è¿›è¡Œè°ƒåº¦ if gp.lockedm != 0 { // Hands off own p to the locked m, // then blocks waiting for a new p. startlockedm(gp) goto top } // ä½¿ç”¨executeå‡½æ•°è®©mæ‰§è¡Œg execute(gp, inheritTime) } å¦‚å›¾æ‰€ç¤º \r\n æ€»ç»“   åˆ¤æ–­å½“å‰çš„Må’Œå½“å‰çš„Gæ˜¯å¦ç»‘å®šï¼Œå¦‚æœå½“å‰çš„Mç»‘å®šG,å°±é˜»å¡m(ä¼‘çœ M) åˆ¤æ–­Gcæ˜¯å¦åœ¨ç­‰å¾…æ‰§è¡Œï¼Œæ˜¯åœ¨ç­‰å¾…æ‰§è¡Œï¼Œå…ˆæ‰§è¡Œgcï¼Œæ‰§è¡Œå®Œåœ¨æ‰§è¡Œåç»­æ“ä½œ æ£€æŸ¥æ˜¯å¦æœ‰è¦è¢«æ‰§è¡Œçš„Timer æ™®é€šçš„ goroutine ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦åœ¨å‡†å¤‡å¥½æ—¶å”¤é†’ï¼Œä½† GCworkers å’Œè·Ÿè¸ªè¯»å–å™¨ä¸ä¼šï¼Œæ‰€ä»¥æ£€æŸ¥å¿…é¡» æœ‰%61çš„æ¦‚ç‡æŠŠGä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æ¬ç§»åˆ°æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ï¼Œä¿éšœæœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—æœ‰Gè¿è¡Œï¼Œå…¨å±€é˜Ÿåˆ—ä¹Ÿèƒ½æ”¾åœ¨æœ¬éƒ½é˜Ÿåˆ—ä¸­ æ²¡æœ‰å¾…è¿è¡Œçš„Gå°±ç°åœ¨æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—æŸ¥æ‰¾ï¼Œæœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰ï¼Œå°±è°ƒç”¨findrunnable()ï¼Œç›´åˆ°æœ‰å¾…æ‰§è¡Œçš„gæ‰è¿”å›(å…ˆåœ¨æœ¬åœ° è¿è¡Œé˜Ÿåˆ—ï¼Œå…¨å±€é˜Ÿåˆ—ã€ç­‰å¾…çš„io, å…¶ä»–çš„Pä¸­åˆ†é…G) åˆ¤æ–­è·å¾—çš„Gæœ‰æ²¡æœ‰ç»‘å®šçš„M,æœ‰å°±é˜»å¡g, å†æ¬¡è¿›è¡Œè°ƒåº¦ ä½¿ç”¨executeå‡½æ•°è®©mæ‰§è¡Œg,å¾…è¿è¡Œgç»‘å®šm,è°ƒç”¨gogo(\u0026amp;gp.sched)åç¨‹çš„ç°åœºæ¢å¤ç­‰  è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥  å‡å°‘çº¿ç¨‹çš„åˆ›å»ºä¸é”€æ¯cupçš„å¼€é”€ï¼ŒGPMæ˜¯çº¿ç¨‹çš„å¤ç”¨ã€‚å³å½“æ²¡æœ‰ å¯è¿è¡Œçš„Gæ—¶ï¼Œå°†Mä¼‘çœ ,Pç©ºé—²ã€‚å½“æœ‰å¯æ‰§è¡ŒGæ˜¯æ‰¾ç©ºé—²çš„Pï¼Œåœ¨å°†Må”¤é†’ï¼Œæ‰§è¡ŒGï¼Œç›´åˆ° main.main é€€å‡ºï¼Œruntime.main æ‰§è¡Œ Defer å’Œ Panic å¤„ç†ï¼Œæˆ–è°ƒç”¨ runtime.exit é€€å‡ºç¨‹åº work stealing æœºåˆ¶ï¼šå½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„ G æ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„ P å·å– Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚ hand off æœºåˆ¶ï¼š\n1.å½“æœ¬çº¿ç¨‹å› ä¸º G è¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ P è½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚\n2.åˆ©ç”¨å¹¶è¡Œï¼šGOMAXPROCS è®¾ç½® P çš„æ•°é‡ï¼Œæœ€å¤šæœ‰ GOMAXPROCS ä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCS ä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚ GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„ CPU æ ¸è¿›è¡Œå¹¶è¡Œã€‚ 3.æŠ¢å ï¼šåœ¨ coroutine ä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡º CPU æ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨ Go ä¸­ï¼Œä¸€ä¸ª goroutine æœ€å¤šå ç”¨ CPU 10msï¼Œé˜²æ­¢å…¶ä»– goroutine è¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯ goroutine ä¸åŒäº coroutine çš„ä¸€ä¸ªåœ°æ–¹ã€‚\n4.å…¨å±€ G é˜Ÿåˆ—ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€ G é˜Ÿåˆ—ï¼Œä½†åŠŸèƒ½å·²ç»è¢«å¼±åŒ–äº†ï¼Œå½“ M æ‰§è¡Œ work stealing ä»å…¶ä»– P å·ä¸åˆ° G æ—¶ï¼Œå®ƒå¯ä»¥ä»å…¨å±€ G é˜Ÿåˆ—è·å– Gã€‚ è°ƒåº¦å¦‚å›¾æ‰€ç¤º\n\r  å‚è€ƒæ–‡çŒ® 1ã€https://www.jianshu.com/p/fa696563c38a 2.https://www.zhihu.com/people/kylin-lab\n","date":"2021-10-06T22:00:38+08:00","image":"https://zcj-git520.github.io/p/go-goroutine%E4%B8%8Egmp%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/1_huda718813a1636432ee91da972c85e460_240629_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/go-goroutine%E4%B8%8Egmp%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/","title":"go goroutineä¸gmpæ¨¡å‹çš„æ·±å…¥ç†è§£"},{"content":"ç†è§£è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹  è¿›ç¨‹æ˜¯ç¨‹åºä¸€æ¬¡åŠ¨æ€æ‰§è¡Œè¿‡ç¨‹ã€è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æº(å†…å­˜ã€ioèµ„æºã€cpuç­‰)å’Œèµ„æºè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚ç¨‹åºæ˜¯æŒ‡ä»¤ã€æ•°æ®åŠå…¶ç»„ç»‡å½¢å¼çš„æè¿°ï¼Œè¿›ç¨‹æ˜¯ç¨‹åºçš„å®ä½“ã€‚ è¿›ç¨‹æ˜¯ç”± è¿›ç¨‹æ§åˆ¶å—PCBã€ç›¸å…³ç¨‹åºæ®µå’Œè¯¥ç¨‹åºæ®µè¿›è¡Œæ“ä½œçš„æ•°æ®ç»“æ„é›†ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚ è¿›ç¨‹çš„äº”ä¸­çŠ¶æ€ï¼šåˆ›å»ºã€å°±ç»ªã€è¿è¡Œã€é˜»å¡ã€ç»ˆæ­¢ äº”ç§çŠ¶æ€è½¬æ¢å¦‚å›¾æ‰€ç¤ºï¼š \r  çº¿ç¨‹  çº¿ç¨‹æ˜¯cupè°ƒåº¦å’Œåˆ†é…çš„åŸºæœ¬å•ä½ä¹Ÿæ˜¯cupæ‰§è¡Œçš„æœ€å°å•ä½, æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œå…±äº«å †ç©ºé—´ã€‚  è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»  ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºå’Œæ’¤é”€å¤šä¸ªçº¿ç¨‹ï¼Œ ä¸€ä¸ªè¿›ç¨‹å¿…é¡»æœ‰ä¸€ä¸ªçº¿ç¨‹(ä¸»çº¿ç¨‹), çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æœ‰èµ„æºï¼Œè¿›ç¨‹æ˜¯çº¿ç¨‹çš„å®¹å™¨ï¼Œå…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š\n\r  å¹¶å‘ä¸å¹¶è¡Œ å¹¶å‘  å¹¶å‘ï¼šå¤šè¿›ç¨‹(çº¿ç¨‹)ç¨‹åºåœ¨ä¸€ä¸ªæ ¸cupä¸²è¡Œè¿è¡Œï¼Œå½“ä¸€ä¸ªè¿›ç¨‹(çº¿ç¨‹)é˜»å¡çš„æ—¶å€™ï¼Œåˆ‡æ¢åˆ°å¦å¤–ç­‰å¾…æ‰§è¡Œçš„è¿›ç¨‹(çº¿ç¨‹) å¦‚å›¾\n\r  å¹¶è¡Œ  å¹¶è¡Œï¼šå¤šçº¿ç¨‹ç¨‹åºåœ¨å¤šæ ¸cupå¹¶è¡Œè¿è¡Œï¼Œå¦‚å›¾\n\r  ç”¨æˆ·æ€å’Œå†…æ ¸æ€(ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´) ç‰¹æƒçº§åˆ’åˆ†  cpuä¸€å…±æœ‰0ï½4å››ä¸ªç‰¹æƒçº§ï¼ŒR0çº§æœ€é«˜ï¼ŒR3çº§æœ€ä½ã€‚ç”¨æˆ·æ€æŒ‡çš„æ˜¯ï¼šç¨‹åºè¿è¡Œåœ¨R3çº§ä»¥ä¸Šï¼Œé€šå¸¸åœ¨åº”ç”¨ç¨‹åºä¸­è¿è¡Œï¼Œå†…æ ¸æ€æ˜¯æŒ‡ï¼šç¨‹åºè¿è¡Œåœ¨R0çº§ä»¥ä¸Šï¼Œé€šå¸¸åœ¨å†…æ ¸ä¸­è¿è¡Œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å†™çš„åº”ç”¨ç¨‹åºå°±æ˜¯è¿è¡Œåœ¨R3çº§è¡£ä»¥ä¸Šã€‚  3ä¸­ç§ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢   ç³»ç»Ÿè°ƒç”¨ï¼šç”¨æˆ·æ€è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç”³è¯·ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ç¨‹åºå®Œæˆå·¥ä½œï¼Œæ¯”å¦‚å‰ä¾‹ä¸­fork()å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªåˆ›å»ºæ–°è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚è€Œç³»ç»Ÿè°ƒç”¨çš„æœºåˆ¶å…¶æ ¸å¿ƒè¿˜æ˜¯ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿä¸ºç”¨æˆ·ç‰¹åˆ«å¼€æ”¾çš„ä¸€ä¸ªä¸­æ–­æ¥å®ç°ï¼Œä¾‹å¦‚Linuxçš„int 80hä¸­æ–­ã€‚\n  å¼‚å¸¸ï¼šå½“CPUåœ¨æ‰§è¡Œè¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºæ—¶ï¼Œå‘ç”Ÿäº†æŸäº›äº‹å…ˆä¸å¯çŸ¥çš„å¼‚å¸¸ï¼Œè¿™æ—¶ä¼šè§¦å‘ç”±å½“å‰è¿è¡Œè¿›ç¨‹åˆ‡æ¢åˆ°å¤„ç†æ­¤å¼‚å¸¸çš„å†…æ ¸ç›¸å…³ç¨‹åºä¸­ï¼Œä¹Ÿå°±è½¬åˆ°äº†å†…æ ¸æ€ï¼Œæ¯”å¦‚ç¼ºé¡µå¼‚å¸¸ã€‚\n  å¤–å›´è®¾å¤‡çš„ä¸­æ–­ï¼š å½“å¤–å›´è®¾å¤‡å®Œæˆç”¨æˆ·è¯·æ±‚çš„æ“ä½œåï¼Œä¼šå‘CPUå‘å‡ºç›¸åº”çš„ä¸­æ–­ä¿¡å·ï¼Œè¿™æ—¶CPUä¼šæš‚åœæ‰§è¡Œä¸‹ä¸€æ¡å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤è½¬è€Œå»æ‰§è¡Œä¸ä¸­æ–­ä¿¡å·å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œå¦‚æœå…ˆå‰æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºï¼Œé‚£ä¹ˆè¿™ä¸ªè½¬æ¢çš„è¿‡ç¨‹è‡ªç„¶ä¹Ÿå°±å‘ç”Ÿäº†ç”±ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ã€‚æ¯”å¦‚ç¡¬ç›˜è¯»å†™æ“ä½œçš„å®Œæˆï¼Œç³»ç»Ÿä¼šåˆ‡æ¢åˆ°ç¡¬ç›˜è¯»å†™çš„ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œåç»­æ“ä½œç­‰ã€‚\n  ç”¨æˆ·æ€ä¸å†…æ ¸æ€ç»“æ„å¦‚å›¾ï¼š\n\r\n  ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ˜¯éœ€è¦å¼€é”€\n  æ¥æºï¼šlinuxç”¨æˆ·æ€å’Œå†…æ ¸æ€ç†è§£(https://www.cnblogs.com/weifeng1463/p/11660260.html)\n  è¿›ç¨‹ä¸çº¿ç¨‹ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„å¼€é”€   å¤šè¿›ç¨‹(çº¿ç¨‹)å¯ä»¥æé«˜cpuçš„åˆ©ç”¨ç‡ï¼Œå‡å°‘ç¨‹åºé˜»å¡å¸¦æ¥cpué—²ç½®çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æå‡cpuçš„è¿è¡Œæ—¶é—´ç‰‡ï¼Œä½†æ˜¯è¿‡å¤šçš„åˆ›å»ºè¿›ç¨‹(çº¿ç¨‹)ä¹Ÿä¼šèŠ±è´¹é¢å¤–çš„cpuæ—¶é—´ç‰‡è¿›è¡Œè¿›ç¨‹(çº¿ç¨‹)çš„èŠ±é”€ã€‚è¿›ç¨‹çš„åˆ›å»ºã€å°±ç»ªã€è¿è¡Œã€é˜»å¡ã€ç»ˆæ­¢ï¼Œè¿™äº›éƒ½ä¼šå¸¦æ¥cupèŠ±é”€ã€‚ä¾‹å¦‚åœ¨32ä½çš„æ“ä½œç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªè¿›ç¨‹éœ€è¦å¼€è¾Ÿ4GBçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹éœ€è¦å ç”¨çº¦4MBçš„å†…å­˜ã€‚\n\r\n  è¿›ç¨‹(çº¿ç¨‹)çš„è°ƒåº¦ä¹Ÿä¼šå¸¦æ¥cupçš„èŠ±é”€ã€‚cupè¿›ç¨‹(çº¿ç¨‹)çš„è°ƒåº¦å°±æ˜¯è¿›ç¨‹(çº¿ç¨‹)åˆ‡æ¢ï¼Œè¿›ç¨‹(çº¿ç¨‹)çš„åˆ‡æ¢å°±ä¼šè¿›è¡Œçº¿ç¨‹åœ¨å†…æ ¸æ€çš„è°ƒåº¦ã€‚cupåˆ‡æ¢çš„å†…æ ¸æ€çš„çº¿ç¨‹ï¼Œä¸æ“ä½œç”¨æˆ·æ€çš„çº¿ç¨‹ï¼Œç”¨æˆ·æ€çº¿ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨è§¦å‘å†…æ ¸çº¿ç¨‹ã€‚\n  ä¸ºå‡å°‘cpuå†…æ ¸æ€çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œæ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨(ç”¨æˆ·æ€è¿›ç¨‹(çº¿ç¨‹):å†…æ ¸æ€è¿›ç¨‹(çº¿ç¨‹))1:1ï¼Œç”¨æˆ·æ€ç›´æ¥é€šè¿‡ç³»ç»Ÿï¼Œç›´æ¥ä¸å†…æ ¸æ€çš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”ã€‚å¦‚å›¾\n\r\n  ç”¨æˆ·æ€ä¸€ä¸ªè¿›ç¨‹(çº¿ç¨‹)å¯¹åº”ä¸€ä¸ªå†…æ ¸æ€çš„è¿›ç¨‹(çº¿ç¨‹)æ˜¯å‡å°‘äº†å†…æ ¸æ€ä¸­è¿›ç¨‹(çº¿ç¨‹)åˆ‡æ¢çš„èŠ±é”€ï¼Œä½†æ˜¯ä¹Ÿå¢åŠ äº†å†…æ ¸æ€ä¸­è¿›ç¨‹(çº¿ç¨‹)åˆ›å»ºçš„å¼€é”€ã€‚å‡å°‘å†…æ ¸æ€ä¸­è¿›ç¨‹(çº¿ç¨‹)åˆ‡æ¢ä¸åˆ›å»ºå¸¦æ¥çš„å¼€é”€ï¼Œæ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨(ç”¨æˆ·æ€è¿›ç¨‹(çº¿ç¨‹):å†…æ ¸æ€è¿›ç¨‹(çº¿ç¨‹))N:1ï¼Œå‡å°‘å†…æ ¸æ€ä¸­è¿›ç¨‹(çº¿ç¨‹)çš„åˆ›å»ºï¼ŒåŒæ—¶åœ¨ç”¨æˆ·æ€è¿›è¡Œçº¿ç¨‹çš„ä¹‹é—´çš„åˆ‡æ¢ï¼Œä¸ç‰µè¿å†…æ ¸æ€çº¿ç¨‹çš„åˆ‡æ¢ï¼Œå‡å°‘cupçš„èŠ±é”€ã€‚ \r\n  è™½ç„¶N:1å‡å°‘å†…æ ¸æ€ä¸­è¿›ç¨‹(çº¿ç¨‹)åˆ‡æ¢ä¸åˆ›å»ºå¸¦æ¥çš„å¼€é”€ï¼Œä½†æ˜¯å½“ç”¨æˆ·æ€çš„è¿›ç¨‹(çº¿ç¨‹)é˜»å¡æ—¶ï¼Œå…¶ä»–è¿›ç¨‹(çº¿ç¨‹)å°±åªèƒ½ç­‰å¾…ï¼Œè¿™é€ æˆä¸å•çº¿ç¨‹ä¸€æ ·çš„é—®é¢˜ã€‚æ“ä½œç³»ç»Ÿç»“åˆ1:1å’Œn:1æ¨¡å‹çš„æœ‰ç‚¹å½¢æˆn:mæ¨¡å‹ï¼Œå†…æ ¸æ€ä¸­è¿›ç¨‹(çº¿ç¨‹)è¿›å…¥é˜»å¡çŠ¶æ€æ—¶ï¼Œ ç”¨æˆ·æ€çš„è¿›ç¨‹(çº¿ç¨‹)åˆ‡æ¢å¦ä¸€ä¸ªå†…æ ¸æ€ä¸­çš„çº¿ç¨‹ã€‚\n\r\n  åç¨‹  åç¨‹å’Œçº¿ç¨‹ä¸€æ ·æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œå…±äº«å †ç©ºé—´ï¼Œæ˜¯ç”¨æˆ·çº§çš„çº¿ç¨‹ï¼Œæ˜¯æœ‰ç”¨æˆ·è‡ªå·±è°ƒåº¦ã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åˆ›å»ºå¤šä¸ªåç¨‹ï¼Œåç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚åˆ›å»ºä¸€ä¸ªåç¨‹åªéœ€è¦å ç”¨4~5kBçš„è™šæ‹Ÿå†…å­˜ï¼Œåˆ›å»ºåç¨‹çš„å¼€é”€ç›¸æ¯”è¿›ç¨‹ä¸çº¿ç¨‹ä½å¤ªå¤šäº†ã€‚\n\r  å‚è€ƒæ–‡çŒ® 1ã€https://zhuanlan.zhihu.com/p/337978321 2ã€https://www.jianshu.com/p/fa696563c38a\n","date":"2021-09-28T22:00:38+08:00","image":"https://zcj-git520.github.io/p/c/c/10_hu5bb3a4baa791897c79c1df91e792ef0e_243913_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/c/c-/","title":"è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹"},{"content":"goland åŸºç¡€ä¹‹map mapçš„å†…éƒ¨ç»“æ„  go mapæ˜¯ä½¿ç”¨çš„å“ˆå¸Œè¡¨æ„å»ºçš„ mapçš„ç»“æ„å¯åˆ†ä¸ºï¼šhmapçš„ç»“æ„ä½“å’Œbmap(æ¡¶)ï¼Œhmapç»“æ„ä½“è®°å½•è¿™mapçš„åŸºç¡€ä¿¡æ¯(åŒ…æ‹¬mapå­˜å‚¨ä¸ªæ•°ï¼Œ æ¡¶çš„ä¸ªæ•°ï¼Œhashç§å­ï¼Œæ¡¶çš„æ•°æ®ï¼Œæ‰©å®¹æ—¶æ—§æ¡¶çš„æ•°æ®ä»¥åŠè¿ç§»ä¸ªæ•°ï¼ˆmapæ‰©å®¹ä¸æ˜¯ä¸€æ¬¡æ€§è¿ç§»å®Œï¼‰) æºç å¦‚ä¸‹    å®šä¹‰hmapçš„ç»“æ„ï¼š type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. // Make sure this stays in sync with the compiler's definition. // map å­˜å‚¨å…ƒç´ çš„è®¡æ•° count int // # live cells == size of map. Must be first (used by len() builtin) flags uint8 // mapçš„çŠ¶æ€æ ‡è¯†ï¼Œæ¡¶æ˜¯å¦åœ¨å¢æ”¹ï¼Œæ‰©å®¹æˆ–è€…ç¼©å®¹ //æ¡¶çš„ä¸ªæ•°/é‡‡ç”¨çš„ä¸è¿ç®—æ³•è®¡ç®—æ¡¶çš„ä¸ªæ•°ï¼Œæ¡¶çš„ä¸ªæ•°ä¸º2çš„æ•´æ•°æ¬¡å¹‚ B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) //æº¢å‡ºçš„æ¡¶çš„æ•°é‡çš„è¿‘ä¼¼å€¼ noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details hash0 uint32 // hash seed //æŒ‡å‘æ¡¶æ•°æ®çš„æŒ‡é’ˆ buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. // æŒ‡å‘æ—§æ¡¶æ•°æ®çš„æŒ‡é’ˆ oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing //æ‰©å®¹è®¡æ•° nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) // ä¿å­˜æº¢å‡ºæ¡¶çš„é“¾è¡¨å’Œæœªä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°ç»„çš„é¦–åœ°å€ extra *mapextra // optional fields } // æ¡¶çš„å®ç°ç»“æ„ type bmap struct { // å½“å‰ç‰ˆæœ¬bucketCntçš„å€¼æ˜¯8ï¼Œä¸€ä¸ªæ¡¶æœ€å¤šå­˜å‚¨8ä¸ªkey-valueå¯¹ tophash [bucketCnt]uint8 }  bmapå­˜å‚¨ç»“æ„å¦‚å›¾æ‰€ç¤º\n\r å‰8ä¸ªæ˜¯hashå€¼ï¼Œ8ä¸ªkeyå’Œ8ä¸ªvalueã€åé¢æ˜¯æº¢å‡ºæ¡¶çš„æŒ‡é’ˆ æº¢å‡ºæ¡¶æ˜¯å‡å°‘mapæ‰©å®¹æ¬¡æ•°ï¼Œæº¢å‡ºæ¡¶çš„ç»“æ„ä¸bmapæ¡¶çš„ç»“æ„ä¸€æ ·çš„ æº¢å‡ºæ¡¶çš„åŸºç¡€ç»“æ„ï¼š    type mapextra struct { // If both key and elem do not contain pointers and are inline, then we mark bucket // type as containing no pointers. This avoids scanning such maps. // However, bmap.overflow is a pointer. In order to keep overflow buckets // alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow. // overflow and oldoverflow are only used if key and elem do not contain pointers. // overflow contains overflow buckets for hmap.buckets. // oldoverflow contains overflow buckets for hmap.oldbuckets. // The indirection allows to store a pointer to the slice in hiter. overflow *[]*bmap //è®°å½•å·²ç»è¢«ä½¿ç”¨çš„æº¢å‡ºæ¡¶ oldoverflow *[]*bmap // æ‰©å®¹é˜¶æ®µæ—§çš„æº¢å‡ºæ¡¶ // nextOverflow holds a pointer to a free overflow bucket. nextOverflow *bmap //æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„æº¢å‡ºæ¡¶ }  å½“æ¡¶çš„ä¸ªæ•°å¤§äº2çš„4æ¬¡æ–¹æ—¶å°±ä¼šä½¿ç”¨æº¢å‡ºæ¡¶æºç å¦‚ä¸‹  func makeBucketArray(t *maptype, b uint8, dirtyalloc unsafe.Pointer) (buckets unsafe.Pointer, nextOverflow *bmap) { // æ¡¶çš„ä¸ªæ•° base := bucketShift(b) nbuckets := base // For small b, overflow buckets are unlikely. // Avoid the overhead of the calculation. if b \u0026gt;= 4 { // ä½¿ç”¨æº¢å‡ºæ¡¶ // Add on the estimated number of overflow buckets // required to insert the median number of elements // used with this value of b. nbuckets += bucketShift(b - 4)//è®¡ç®—æº¢å‡ºæ¡¶çš„æ•°é‡å’Œä¸æ˜¯æº¢å‡ºæ¡¶çš„æ•°é‡çš„å’Œ sz := t.bucket.size * nbuckets up := roundupsize(sz) if up != sz { nbuckets = up / t.bucket.size //å¾—å‡ºæ¡¶çš„æ•°é‡ } } if dirtyalloc == nil { // æ²¡æœ‰è¢«åˆ›å»ºæ¡¶ï¼Œç”³è¯·åˆ›å»ºæ¡¶çš„ï¼Œè¿”å›æ¡¶çš„é¦–åœ°å€ buckets = newarray(t.bucket, int(nbuckets)) } else { // dirtyalloc was previously generated by // the above newarray(t.bucket, int(nbuckets)) // but may not be empty. buckets = dirtyalloc size := t.bucket.size * nbuckets if t.bucket.ptrdata != 0 { memclrHasPointers(buckets, size) } else { memclrNoHeapPointers(buckets, size) } } if base != nbuckets { // We preallocated some overflow buckets. // To keep the overhead of tracking these overflow buckets to a minimum, // we use the convention that if a preallocated overflow bucket's overflow // pointer is nil, then there are more available by bumping the pointer. // We need a safe non-nil pointer for the last overflow bucket; just use buckets. //ç©ºé—²æ¡¶çš„åœ°å€ nextOverflow = (*bmap)(add(buckets, base*uintptr(t.bucketsize))) last := (*bmap)(add(buckets, (nbuckets-1)*uintptr(t.bucketsize))) last.setoverflow(t, (*bmap)(buckets)) } return buckets, nextOverflow }  å¦‚å›¾æ‰€ç¤º\n\r ä½¿ç”¨mapæ—¶éœ€è¦make(map[type]type,len,cap)æ‰èƒ½ä½¿ç”¨ã€‚ make æºç å¦‚ä¸‹ï¼š    func makemap(t *maptype, hint int, h *hmap) *hmap { // åˆ¤æ–­æ˜¯å¦è¶…è¿‡å†…å­˜çš„é™åˆ¶ mem, overflow := math.MulUintptr(uintptr(hint), t.bucket.size) if overflow || mem \u0026gt; maxAlloc { hint = 0 } // initialize Hmap if h == nil { h = new(hmap) } h.hash0 = fastrand()// è·å–éšæœºçš„hashå€¼ // Find the size parameter B which will hold the requested # of elements. // For hint \u0026lt; 0 overLoadFactor returns false since hint \u0026lt; bucketCnt. B := uint8(0) for overLoadFactor(hint, B) { B++ } h.B = B // allocate initial hash table // if B == 0, the buckets field is allocated lazily later (in mapassign) // If hint is large zeroing this memory could take a while. if h.B != 0 { var nextOverflow *bmap // åˆ›å»ºmapçš„å­˜å‚¨æ•°æ®ï¼Œè¿”å›çš„æ¡¶çš„æ•°æ®çš„åœ°å€ï¼Œä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶çš„åœ°å€ h.buckets, nextOverflow = makeBucketArray(t, h.B, nil) if nextOverflow != nil { h.extra = new(mapextra) h.extra.nextOverflow = nextOverflow } } return h }   mapçš„å®Œæ•´ç»“æ„å¦‚å›¾ï¼š \r\nmapæ‰©å®¹ æ‰©å®¹æ¡ä»¶     å½“è´Ÿè½½å› å­(loadFactorNum*(bucketShift(B)/loadFactorDen\u0026gt;6.5 -\u0026gt; ç¿»å€æ‰©å®¹\n  å½“è´Ÿè½½å› å­å°äº6.5ï¼Œä½†æ˜¯æº¢å‡ºæ¡¶çš„æ•°é‡å¤§äº2çš„15æ¬¡æ–¹ -\u0026gt; ç­‰é‡æ‰©å®¹\n  æºä»£ç å¦‚ä¸‹ï¼š\n    // overLoadFactor reports whether count items placed in 1\u0026lt;\u0026lt;B buckets is over loadFactor. // è´Ÿè½½å› å­å¤§äº6.5 func overLoadFactor(count int, B uint8) bool { return count \u0026gt; bucketCnt \u0026amp;\u0026amp; uintptr(count) \u0026gt; loadFactorNum*(bucketShift(B)/loadFactorDen) } // æº¢å‡ºæ¡¶è¿‡å¤šæ—¶ func tooManyOverflowBuckets(noverflow uint16, B uint8) bool { // If the threshold is too low, we do extraneous work. // If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory. // \u0026quot;too many\u0026quot; means (approximately) as many overflow buckets as regular buckets. // See incrnoverflow for more details. if B \u0026gt; 15 { B = 15 } // The compiler doesn't see here that B \u0026lt; 16; mask B to generate shorter shift code. return noverflow \u0026gt;= uint16(1)\u0026lt;\u0026lt;(B\u0026amp;15) } // æ‰©å®¹æºç  func hashGrow(t *maptype, h *hmap) { // If we've hit the load factor, get bigger. // Otherwise, there are too many overflow buckets, // so keep the same number of buckets and \u0026quot;grow\u0026quot; laterally. bigger := uint8(1) if !overLoadFactor(h.count+1, h.B) { //ç­‰é‡æ‰©å®¹ bigger = 0 h.flags |= sameSizeGrow } oldbuckets := h.buckets newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, nil)// ä»æ–°åˆ†é…æ•°æ®åœ°å€ flags := h.flags \u0026amp;^ (iterator | oldIterator) if h.flags\u0026amp;iterator != 0 { // è¿­ä»£çš„æ—¶å€™æ¬è¿æ—§æ¡¶ flags |= oldIterator } // commit the grow (atomic wrt gc) h.B += bigger // æ¡¶çš„ä¸ªæ•° h.flags = flags h.oldbuckets = oldbuckets h.buckets = newbuckets h.nevacuate = 0 h.noverflow = 0 // æº¢å‡ºæ¡¶é’»ä¾¿ä¸ºæ—§æº¢å‡ºæ¡¶ if h.extra != nil \u0026amp;\u0026amp; h.extra.overflow != nil { // Promote current overflow buckets to the old generation. if h.extra.oldoverflow != nil { throw(\u0026quot;oldoverflow is not nil\u0026quot;) } h.extra.oldoverflow = h.extra.overflow h.extra.overflow = nil } if nextOverflow != nil { if h.extra == nil { h.extra = new(mapextra) } h.extra.nextOverflow = nextOverflow } // the actual copying of the hash table data is done incrementally // by growWork() and evacuate(). } å‚è€ƒæ–‡çŒ® 1.https://www.zhihu.com/people/kylin-lab\n","date":"2021-09-20T22:00:38+08:00","image":"https://zcj-git520.github.io/p/go-map%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/3_hu50c7ad8b87ebb1655f26b2166388bb8a_150234_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/go-map%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/","title":"go mapçš„æ·±å…¥ç†è§£"},{"content":"æœåŠ¡å™¨é…ç½®(æœåŠ¡å™¨å¹³å°ï¼šx86) Rsyslogç®€ä»‹  Rsyslogæ˜¯ä¸€ä¸ª syslogd çš„å¤šçº¿ç¨‹å¢å¼ºç‰ˆï¼Œåœ¨syslogçš„åŸºç¡€ä¸Šæ‰©å±•äº†å¾ˆå¤šå…¶ä»–åŠŸèƒ½ï¼Œå¦‚æ•°æ®åº“æ”¯æŒ(MySQL, PostgreSQLã€Oracleç­‰)ã€æ—¥å¿—å†…å®¹ç­›é€‰ã€å®šä¹‰æ—¥å¿—æ ¼å¼æ¨¡æ¿ç­‰ã€‚é™¤äº†é»˜è®¤çš„udpåè®®å¤–ï¼Œrsyslogè¿˜æ”¯æŒtcpåè®®æ¥æ¥æ”¶æ—¥å¿—ã€‚ ç›®å‰çš„linuxçš„å‘è¡Œç‰ˆéƒ½åˆ‡æ¢ä¸ºrsyslog  å®‰è£…Rsyslog  Linuxçš„å‘è¡Œç‰ˆä¸­é¢„å…ˆå®‰è£…äº†Rsyslog,æ— éœ€å®‰è£…ï¼Œrsyslogd â€“v æŸ¥çœ‹ç‰ˆæœ¬ è‹¥æœªå®‰è£…ï¼Œä»¥ä¸‹æ˜¯å®‰è£…æ­¥éª¤ï¼š 1.ubuntuï¼šsudo apt install rsyslog 2.CentOSï¼šyum install rsyslog  Rsyslog.confé…ç½®æ–‡ä»¶è¯¦è§£ é…ç½®æ–‡ä»¶ä½ç½®ï¼š/etc/rsyslog.conf #### MODULES #### #å®šä¹‰æ—¥å¿—çš„æ¨¡å—ã€‚ $ModLoad imuxsock #imuxsockä¸ºæ¨¡å—åï¼Œæ”¯æŒæœ¬åœ°ç³»ç»Ÿæ—¥å¿—çš„æ¨¡å—ã€‚ $ModLoad imjournal #imjournalä¸ºæ¨¡å—åï¼Œæ”¯æŒå¯¹ç³»ç»Ÿæ—¥å¿—çš„è®¿é—®ã€‚ #$ModLoad imklog #imklogä¸ºæ¨¡å—åï¼Œæ”¯æŒå†…æ ¸æ—¥å¿—çš„æ¨¡å—ã€‚ #$ModLoad immark #immarkä¸ºæ¨¡å—åï¼Œæ”¯æŒæ—¥å¿—æ ‡è®°ã€‚ # Provides UDP syslog reception #æä¾›udp syslogçš„æ¥æ”¶ã€‚ #$ModLoad imudp #imudpä¸ºæ¨¡å—åï¼Œæ”¯æŒudpåè®®ã€‚ #$UDPServerRun 514 #å…è®¸514ç«¯å£æ¥æ”¶ä½¿ç”¨udpå’Œtcpè½¬å‘æ¥çš„æ—¥å¿—ã€‚ # Provides TCP syslog reception #æä¾›tcp syslogçš„æ¥æ”¶ã€‚ #$ModLoad imtcp #imtcpä¸ºæ¨¡å—åï¼Œæ”¯æŒtcpåè®®ã€‚ #$InputTCPServerRun 514 #### GLOBAL DIRECTIVES #### #å®šä¹‰å…¨å±€æ—¥å¿—æ ¼å¼çš„æŒ‡ä»¤ã€‚ # Where to place auxiliary files $WorkDirectory /var/lib/rsyslog #å·¥ä½œç›®å½•ã€‚ # Use default timestamp format $ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat #å®šä¹‰æ—¥å¿—æ ¼å¼é»˜è®¤æ¨¡æ¿ã€‚ $IncludeConfig /etc/rsyslog.d/*.conf #æ‰€æœ‰é…ç½®æ–‡ä»¶è·¯å¾„ã€‚ $OmitLocalLogging on #çœç•¥æœ¬åœ°ç™»å½•ã€‚ # File to store the position in the journal $IMJournalStateFile imjournal.state #### RULES #### #kern.* /dev/console #è®°å½•æ‰€æœ‰æ—¥å¿—ç±»å‹çš„infoçº§åˆ«ä»¥åŠå¤§äºinfoçº§åˆ«çš„ä¿¡æ¯åˆ°messagesæ–‡ä»¶ï¼Œä½†æ˜¯mailé‚®ä»¶ä¿¡æ¯ï¼ŒauthprivéªŒè¯æ–¹é¢çš„ä¿¡æ¯å’Œcornæ—¶é—´å’Œä»»åŠ¡ç›¸å…³ä¿¡æ¯é™¤å¤–ã€‚ *.info;mail.none;authpriv.none;cron.none /var/log/messages # authprivéªŒè¯ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯å­˜æ”¾åœ¨/var/log/secureã€‚ authpriv.* /var/log/secure #é‚®ä»¶çš„æ‰€æœ‰ä¿¡æ¯å­˜åœ¨/var/log/maillogï¼›è¿™é‡Œæœ‰ä¸€ä¸ªâ€œ-â€ç¬¦å·è¡¨ç¤ºæ˜¯ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼è®°å½• mail.* -/var/log/maillog #ä»»åŠ¡è®¡åˆ’æœ‰å…³çš„ä¿¡æ¯å­˜æ”¾åœ¨/var/log/cronã€‚ cron.* /var/log/cron #è®°å½•æ‰€æœ‰çš„â‰¥emergçº§åˆ«ä¿¡æ¯ï¼Œå‘é€ç»™æ¯ä¸ªç™»å½•åˆ°ç³»ç»Ÿçš„æ—¥å¿—ã€‚ *.emerg :omusrmsg:* #è®°å½•uucpï¼Œnews.critç­‰å­˜æ”¾åœ¨/var/log/spooler uucp,news.crit /var/log/spooler #æœ¬åœ°æœåŠ¡å™¨çš„å¯åŠ¨çš„æ‰€æœ‰æ—¥å¿—å­˜æ”¾åœ¨/var/log/boot.log local7.* /var/log/boot.log ä»¥ä¸‹ä¸ºï¼šrsyslog å®¢æœç«¯çš„é…ç½® #å‘é€æ—¥å¿—ï¼Œ@è¡¨ç¤ºä¼ è¾“åè®®ï¼ˆ@è¡¨ç¤ºudpï¼Œ@@è¡¨ç¤ºtcpï¼‰ï¼Œåé¢æ˜¯ipå’Œç«¯å£ã€‚ #*.* @@remote-host:514 é…ç½®æœåŠ¡å™¨  ä½¿ç”¨sudo vi /etc/rsyslog.conf æ‰“å¼€é…ç½®æ–‡ä»¶  é€‰æ‹©ä¼ è¾“çš„åè®® 1.ä½¿ç”¨udpä¼ è¾“æ—¥å¿—ï¼Œé…ç½®æ—¶å°†å‰é¢çš„#å»æ‰å³å¯\n$ModLoad imudp\n$UDPServerRun 514\n2.ä½¿ç”¨tcpä¼ è¾“åè®®, å°†#å»ç‚¹å³å¯\n$ModLoad imtcp\n$InputTCPServerRun 514\né…ç½®å¦‚å›¾ï¼š\r\n æ³¨æ˜ï¼š\n514/5014ç«¯å£å·å¯ä»¥è‡ªå·±é…ç½®ï¼Œé»˜è®¤ä¸º514.\nrsyslogåå°è¿›ç¨‹æ˜¯å¯ä»¥åŒæ—¶ç›‘å¬TCP/UDPè¿æ¥çš„  é…ç½®æ¥æ”¶æ—¥å¿—æ¨¡æ¿  åœ¨GLOBAL DIRECTIVESå†…å®¹å—çš„å‰é¢å¢åŠ æ¥æ”¶æ—¥å¿—æ¨¡æ¿ æ¨¡æ¿å¦‚ä¸‹ï¼š\n$template RemoteLogs,\u0026quot;/var/log/%HOSTNAME%/%PROGRAMNAME%.log\u0026quot;\n*.* ?RemoteLogs\n\u0026amp; ~ æ³¨æ˜ï¼š\n1ã€$template RemoteLogsæŒ‡ä»¤ï¼ˆâ€œRemoteLogsâ€ å¯ä»¥ä¸ºå…¶å®ƒçš„æè¿°çš„åå­—ï¼‰è¿«ä½¿rsyslogåå°è¿›ç¨‹éš”å¼€æœ¬åœ°/var/log/ä¸‹æ–‡ä»¶å»å†™æ—¥å¿—ä¿¡æ¯ã€‚è€Œæ—¥å¿—æ–‡ä»¶ååˆ™ä¾æ®å‘é€è¿œç¨‹æ—¥å¿—çš„æœºå™¨ååŠåº”ç”¨ç¨‹åºåæ¥å®šä¹‰ã€‚\n2ã€*.* ?RemoteLogsï¼‰æš—å«è¿è¡Œç”¨æ¨¡æ¿RemoteLogsäºæ‰€æœ‰çš„æ¥æ”¶æ—¥å¿—ã€‚\n3ã€\u0026amp; ~åˆ™å‘Šè¯‰rsyslogåå°è¿›ç¨‹åœæ­¢è¿›ä¸€æ­¥çš„å»å¤„ç†æ—¥å¿—ä¿¡æ¯,å³ä¸å¯¹å®ƒä»¬è¿›è¡Œæœ¬åœ°åŒ–å†™å…¥ï¼Œå®ƒæ˜¯ä»£è¡¨ä¸€ä¸ªé‡å®šå‘è§„åˆ™ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€è¡Œï¼Œåˆ™æ„å‘³ç€æ¥æ”¶åˆ°çš„æ—¥å¿—ä¼šå†™å…¥ä¸¤æ¬¡ï¼Œä¸€æ¬¡å¦‚å‰ä¸¤è¡Œå†™çš„æ–¹å¼å†™ï¼Œç¬¬äºŒæ¬¡åˆ™ä»¥æœ¬åœ°æ—¥å¿—è®°å½•çš„æ–¹å¼å†™å…¥ã€‚è¿è¡Œè¿™ä¸ªè§„åˆ™çš„å¦ä¸€ä¸ªç»“è®ºåˆ™æ˜¯æ—¥å¿—æœåŠ¡å™¨è‡ªå·±çš„æ—¥å¿—ä¿¡æ¯åªä¼šå†™å…¥åˆ°ä¾ç…§æœºå™¨ä¸»æœºåå‘½åçš„æ–‡ä»¶ä¸­ã€‚ \r è®¾ç½®åï¼Œä¼šæŒ‰ç…§æ¨¡æ¿æ ¼å¼ä¿å­˜æ—¥å¿— \r  è®¾ç½®å®Œæˆï¼Œä¿å­˜ æ£€æŸ¥Rsyslogé…ç½®  ä½¿ç”¨å‘½ä»¤ï¼šrsyslogd -f /etc/rsyslog.conf -N1 é…ç½®ä¿¡æ¯æ­£ç¡®æœ‰å¦‚ä¸‹æç¤º: \r è‹¥é…ç½®ä¿¡æ¯æœ‰è¯¯ï¼Œåˆ™éœ€è¦åœ¨æ›´æ”¹é…ç½®æ–‡ä»¶  é‡å¯RSyslogæœåŠ¡  Debian,Ubuntuæˆ–CentOS/RHEL 6ä½¿ç”¨:sudo service rsyslog restart Fedora æˆ– CentOS/RHEL 7ä½¿ç”¨ï¼šsudo systemctl restart rsyslog ä½¿ç”¨ï¼šsudo lsof -i :[ç«¯å£å·]ï¼ŒæŸ¥çœ‹æœåŠ¡æ˜¯å¦å¼€å¯å’Œtcp/udpè¿æ¥æƒ…å†µ \r æˆ–ä½¿ç”¨sudo netstat -pantu | grep rsyslog \r  æŸ¥çœ‹æ—¥å¿—  å¯åŠ¨å®¢æˆ·ç«¯ï¼Œè¿›å…¥é…ç½®æ–‡ä»¶æ¨¡æ¿ä¸­æ—¥å¿—ä¿å­˜çš„ä½ç½®ï¼š\n\r\n\r è‹¥æ²¡æœ‰ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ï¼šsudo tcpdump host å®¢æˆ·ç«¯ip æŸ¥çœ‹æ˜¯å¦è½¬å‘æ—¥å¿—ï¼Œæœ‰åˆ™æ˜¯ä¿å­˜æ¨¡æ¿å‡ºé—®é¢˜ï¼Œæ²¡æœ‰å¯èƒ½çš„æœåŠ¡ç«¯é…ç½®æˆ–è€…å®¢æˆ·ç«¯é…ç½®å‡ºé—®é¢˜\n\r  å®¢æˆ·ç«¯é…ç½® å¹³å°ï¼šx86  å¹³å°æ˜¯ä½¿ç”¨çš„rsyslog ä½¿ç”¨sudo vi /etc/rsyslog.conf æ‰“å¼€é…ç½®æ–‡ä»¶ é…ç½®ï¼š\nå‘é€æ—¥å¿—ï¼Œ@è¡¨ç¤ºä¼ è¾“åè®®ï¼ˆ@è¡¨ç¤ºudpï¼Œ@@è¡¨ç¤ºtcpï¼‰ï¼Œåé¢æ˜¯ipå’Œç«¯å£ã€‚\n*.* @@remote-host:514  \r\n æ£€æŸ¥ä¸é‡å¯æœåŠ¡å’Œx86æœåŠ¡å™¨å¹³å°ä¸€æ ·  å¹³å°å¼€å‘æ¿  æ¿å­æ˜¯ä½¿ç”¨çš„syslog ä½¿ç”¨å‘½ä»¤ï¼špsè¿›è¡ŒæŸ¥çœ‹è¿›ç¨‹\n\r æ‰¾åˆ°syslogdæœåŠ¡ï¼Œè‹¥æœªæ‰¾åˆ°ï¼Œå¯èƒ½ä¸æ”¯æŒsyslogæœåŠ¡ ä½¿ç”¨å‘½ä»¤ï¼šsyslogd â€“h æŸ¥çœ‹syslogdæ”¯æŒçš„æœåŠ¡\n\r  é…ç½®å®¢æˆ·ç«¯ 1.ç»“æŸä¹‹å‰çš„syslogdæœåŠ¡ï¼Œé€šè¿‡ä½¿ç”¨kill è¿›ç¨‹å· ç»“æŸè¿›ç¨‹\n\r 2.é€šè¿‡syslogdæä¾›çš„æœåŠ¡æ˜¯é€šè¿‡ -L â€“R æœåŠ¡å™¨çš„ip:port\næ³¨æ˜ï¼šé»˜è®¤ç«¯å£ä¸ºï¼š514,ç«¯å£å·åº”è¯¥ä¸æœåŠ¡å™¨é…ç½®çš„ç«¯å£å·ä¸€è‡´\n3.å¯åŠ¨syslogdæœåŠ¡ï¼š/sbin/syslogd -f /etc/syslog.conf -L -R 172.16.193.204:514 4.é€šè¿‡tcpdump host 172.16.193.204 æŸ¥çœ‹æ—¥å¿—æ˜¯å¦è¢«è½¬å‘åˆ°æœåŠ¡å™¨\n\r\n æ³¨æ˜ï¼šå¼€å‘æ¿çš„syslogæ”¯æŒUDPä¼ è¾“ï¼Œéœ€è¦å¼€å‘æ¿çš„æ—¥å¿—æ–‡ä»¶éœ€è¦åœ¨æœåŠ¡å™¨æ‰“å¼€UDP  ","date":"2021-09-20T22:00:38+08:00","image":"https://zcj-git520.github.io/p/syslog%E6%97%A5%E5%BF%97%E8%BD%AC%E5%8F%91%E9%85%8D%E7%BD%AE/8_hu442c80cfdca83249146ebd0d5822289f_88346_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/syslog%E6%97%A5%E5%BF%97%E8%BD%AC%E5%8F%91%E9%85%8D%E7%BD%AE/","title":"syslogæ—¥å¿—è½¬å‘é…ç½®"},{"content":"åˆ‡ç‰‡çš„å†…éƒ¨ç»“æ„  åˆ‡ç‰‡çš„ç»“æ„å¯åˆ†ä¸ºï¼šæ•°ç»„ï¼Œæ•°æ®ï¼ˆå…ƒç´ ï¼‰çš„åœ°å€\u0026amp;dataã€ä¹Ÿå­˜å…ƒç´ ä¸ªæ•°lenã€å¯ä»¥å­˜å‚¨å¤šå°‘å…ƒç´ cap æºç å¦‚ä¸‹    å®šä¹‰åˆ‡ç‰‡çš„ç»“æ„ï¼š type slice struct { array unsafe.Pointer len int cap int }  å¦‚å›¾æ‰€ç¤º  \ravatar\r\n var data [] int å£°æ˜ä¸€ä¸ªåˆ‡ç‰‡ï¼Œç›¸å½“äºç”Ÿæˆåˆ‡ç‰‡çš„ç»“æ„ï¼Œdataåœ°å€æŒ‡é’ˆä¸ºnil, lenå’Œcapéƒ½ä¸º0ã€‚è¿™å°±å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆï¼Œnilåˆ‡ç‰‡ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ğŸ˜„ ç»“æ„å¦‚å›¾  \ravatar\r\n ä½¿ç”¨åˆ‡ç‰‡æ—¶éœ€è¦make([]type,len,cap)æˆ–è€…åˆå§‹åŒ–[]type{}æ‰èƒ½ä½¿ç”¨ï¼Œè¿™æ˜¯å› ä¸ºåœ¨åœ¨ç”Ÿæˆåˆ‡ç‰‡çš„ç»“æ„æ—¶ï¼ŒåŒæ—¶ä¹Ÿå¼€è¾Ÿäº†ä¸€æ®µæ–°çš„å†…å­˜ï¼Œç±»å‹ä¸ºtype, ç»“æ„é•¿åº¦ä¸ºcap,åŒæ—¶å€¼è¿›è¡Œåˆå§‹åŒ–ã€‚ make æºç å¦‚ä¸‹ï¼š    func makeslice(et *_type, len, cap int) unsafe.Pointer { mem, overflow := math.MulUintptr(et.size, uintptr(cap)) // åˆ¤æ–­æ˜¯å¦è¶Šç•Œ if overflow || mem \u0026gt; maxAlloc || len \u0026lt; 0 || len \u0026gt; cap { // NOTE: Produce a 'len out of range' error instead of a // 'cap out of range' error when someone does make([]T, bignumber). // 'cap out of range' is true too, but since the cap is only being // supplied implicitly, saying len is clearer. // See golang.org/issue/4085. mem, overflow := math.MulUintptr(et.size, uintptr(len)) if overflow || mem \u0026gt; maxAlloc || len \u0026lt; 0 { panicmakeslicelen() // è¶Šç•Œç›´æ¥ panic } panicmakeslicecap() // è¶Šç•Œç›´æ¥ panic } return mallocgc(mem, et, true) //å¼€è¾Ÿå†…å­˜ }  \ravatar\r\n   ä¹Ÿå¯ä»¥é€šè¿‡åº•å±‚æ•°ç»„åˆå§‹åŒ–ï¼Œåˆ‡ç‰‡çš„dataæŒ‡é’ˆæŒ‡å‘å°±æ˜¯ç›¸åŒç±»å‹çš„åº•å±‚æ•°ç»„ï¼›é€šè¿‡slince := array[n:m],è¡¨ç¤ºå®šä¹‰äº†ä¸€ä¸ªç±»å‹å’Œarrayç›¸åŒï¼Œlenä¸ºm-n,capé»˜è®¤ä¸ºarrayçš„é•¿åº¦çš„åˆ‡ç‰‡ã€‚åˆ‡ç‰‡å’Œæ•°ç»„éƒ½æŒ‡å‘äº†ç›¸åŒçš„åœ°å€ã€‚å¤šä¸ªåˆ‡ç‰‡å¯ä»¥å…±ç”¨åŒä¸€ä¸ªåº•å±‚æ•°ç»„ã€‚ \ravatar\r\n  é€šè¿‡append å‡½æ•°å‘åˆ‡ç‰‡å¢åŠ åˆ‡ç‰‡çš„å…ƒç´ ï¼Œå¢åŠ äº†len, cap ä¸å˜ã€‚\nåˆ‡ç‰‡æ‰©å®¹   åœ¨èµ„æºå……è£•çš„æ¡ä»¶ä¸‹ï¼Œåˆ‡ç‰‡æ˜¯å¯ä»¥é€šè¿‡appendä¸æ–­å¢åŠ å…ƒç´ ï¼Œå½“lenä¸ªæ•°å¢åŠ åˆ°capä¸€æ ·æ—¶ï¼Œåœ¨å¢åŠ å…ƒç´ æ—¶ï¼Œå°±éœ€è¦å¢åŠ åˆ‡ç‰‡çš„å®¹é‡capï¼Œé‚£é—®é¢˜æ¥äº†ï¼Œåˆ‡ç‰‡æ˜¯æ€ä¹ˆæ‰©å®¹çš„å‘¢ï¼Ÿ\næ‰©å®¹è§„åˆ™ï¼ˆé¢„ä¼°è§„åˆ™ï¼‰     å½“éœ€è¦æ‰©å®¹çš„æ•°é‡æ¯”ä¹‹å‰capçš„ä¸¤å€éƒ½å¤§ï¼Œåˆ™æ‰©å®¹ä¸ºéœ€è¦æ‰©å®¹çš„æ•°é‡\n  å½“éœ€è¦æ‰©å®¹çš„æ•°é‡æ¯”ä¹‹å‰capçš„ä¸¤å€éƒ½å¤§å°ï¼Œä¹‹å‰çš„capå°äº1024 ç›´æ¥æ‰©å¤§ä¹‹å‰çš„2å€\n  å½“éœ€è¦æ‰©å®¹çš„æ•°é‡æ¯”ä¹‹å‰capçš„ä¸¤å€éƒ½å¤§å°ï¼Œä¹‹å‰çš„capå¤§äº1024 ç›´æ¥æ‰©å¤§ä¹‹å‰çš„1.25å€\n  ä¼ªä»£ç å¦‚ä¸‹\n if oldcap2 \u0026lt; newcap æ—¶ï¼Œ æ‰©å®¹ä¸ºnewcap else{ if oldcap \u0026lt; 1024 newcap = 2oldcap ; else newcap = 1.25*oldcap }\n   æºä»£ç å¦‚ä¸‹ï¼š\n    newcap := old.cap doublecap := newcap + newcap //ä¸¤å€çš„oldcap if cap \u0026gt; doublecap { //å½“éœ€è¦æ‰©å®¹çš„æ•°é‡æ¯”ä¹‹å‰capçš„ä¸¤å€éƒ½å¤§ï¼Œåˆ™æ‰©å®¹ä¸ºéœ€è¦æ‰©å®¹çš„æ•°é‡ newcap = cap } else { //å½“éœ€è¦æ‰©å®¹çš„æ•°é‡æ¯”ä¹‹å‰capçš„ä¸¤å€éƒ½å¤§å°ï¼Œä¹‹å‰çš„capå°äº1024 ç›´æ¥æ‰©å¤§ä¹‹å‰çš„2å€ if old.cap \u0026lt; 1024 { newcap = doublecap } else { // Check 0 \u0026lt; newcap to detect overflow // and prevent an infinite loop. å½“éœ€è¦æ‰©å®¹çš„æ•°é‡æ¯”ä¹‹å‰capçš„ä¸¤å€éƒ½å¤§å°ï¼Œä¹‹å‰çš„capå¤§äº1024 ç›´æ¥æ‰©å¤§ä¹‹å‰çš„1.25å€ for 0 \u0026lt; newcap \u0026amp;\u0026amp; newcap \u0026lt; cap { newcap += newcap / 4 } // Set newcap to the requested cap when // the newcap calculation overflowed. if newcap \u0026lt;= 0 { newcap = cap } } } æ‰©å®¹è°ƒæ•´  åœ¨é¢„ä¼°æ‰©å®¹åï¼Œä¼šæ ¹æ®å†…å­˜å¯¹é½ï¼ˆå‡å°‘å†…å­˜æµªè´¹ï¼‰åœ¨è¿›è¡Œè°ƒæ•´ï¼Œä»£ç ï¼šcapmem := roundupsize(uintptr(newcap) * uintptr(et.size))newcapå°±æ˜¯å‰æ–‡ä¸­è®¡ç®—å‡ºçš„newcapï¼Œet.sizeä»£è¡¨sliceä¸­ä¸€ä¸ªå…ƒç´ çš„å¤§å°ï¼Œcapmemè®¡ç®—å‡ºæ¥çš„å°±æ˜¯æ­¤æ¬¡æ‰©å®¹éœ€è¦ç”³è¯·çš„å†…å­˜å¤§å°ã€‚roundupsizeå‡½æ•°å°±æ˜¯å¤„ç†å†…å­˜å¯¹é½çš„å‡½æ•° æºç å¦‚ä¸‹   var overflow bool var lenmem, newlenmem, capmem uintptr switch { case et.size == 1: //ä¾‹å¦‚byte å¤§å°ä¸º1ï¼Œ æ‰©å®¹çš„å¤§å°ä¸ºå‘ä¸Šå–æ•´çš„æ•°å€¼ lenmem = uintptr(old.len) newlenmem = uintptr(cap) capmem = roundupsize(uintptr(newcap)) overflow = uintptr(newcap) \u0026gt; maxAlloc newcap = int(capmem) case et.size == sys.PtrSize: lenmem = uintptr(old.len) * sys.PtrSize newlenmem = uintptr(cap) * sys.PtrSize capmem = roundupsize(uintptr(newcap) * sys.PtrSize) overflow = uintptr(newcap) \u0026gt; maxAlloc/sys.PtrSize newcap = int(capmem / sys.PtrSize) case isPowerOfTwo(et.size): //å¤„ç†2çš„å€æ•° var shift uintptr if sys.PtrSize == 8 { // Mask shift for better code generation. shift = uintptr(sys.Ctz64(uint64(et.size))) \u0026amp; 63 } else { shift = uintptr(sys.Ctz32(uint32(et.size))) \u0026amp; 31 } lenmem = uintptr(old.len) \u0026lt;\u0026lt; shift newlenmem = uintptr(cap) \u0026lt;\u0026lt; shift capmem = roundupsize(uintptr(newcap) \u0026lt;\u0026lt; shift) overflow = uintptr(newcap) \u0026gt; (maxAlloc \u0026gt;\u0026gt; shift) newcap = int(capmem \u0026gt;\u0026gt; shift) default: lenmem = uintptr(old.len) * et.size newlenmem = uintptr(cap) * et.size capmem, overflow = math.MulUintptr(et.size, uintptr(newcap)) capmem = roundupsize(capmem) newcap = int(capmem / et.size) } // The check of overflow in addition to capmem \u0026gt; maxAlloc is needed // to prevent an overflow which can be used to trigger a segfault // on 32bit architectures with this example program: // // type T [1\u0026lt;\u0026lt;27 + 1]int64 // // var d T // var s []T // // func main() { // s = append(s, d, d, d, d) // print(len(s), \u0026quot;\\n\u0026quot;) // } if overflow || capmem \u0026gt; maxAlloc { panic(errorString(\u0026quot;growslice: cap out of range\u0026quot;)) } ### æ‰©å®¹åå†…å­˜åˆ†é… * åˆ†é… å¤§äºcapçš„å†…å­˜ï¼Œæ²¡æœ‰æ•°æ®æŒ‡é’ˆï¼ŒmemclrNoHeapPointersåˆ›å»º * æºç å¦‚ä¸‹ï¼š \u0026gt; var p unsafe.Pointer if et.ptrdata == 0 { p = mallocgc(capmem, nil, false) // The append() that calls growslice is going to overwrite from old.len to cap (which will be the new length). // Only clear the part that will not be overwritten. memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem) } else { // Note: can't use rawmem (which avoids zeroing of memory), because then GC can scan uninitialized memory. p = mallocgc(capmem, et, true) //åˆ†é…å†…å­˜åœ°å€ if lenmem \u0026gt; 0 \u0026amp;\u0026amp; writeBarrier.enabled { // Only shade the pointers in old.array since we know the destination slice p // only contains nil pointers because it has been cleared during alloc. bulkBarrierPreWriteSrcOnly(uintptr(p), uintptr(old.array), lenmem-et.size+et.ptrdata) } } memmove(p, old.array, lenmem) //æ•°æ®è¿ç§» return slice{p, old.len, newcap} } ","date":"2021-09-15T22:00:38+08:00","image":"https://zcj-git520.github.io/p/go-%E5%88%87%E7%89%87%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/s4_hu1fce009c184102799b4a69d72efc8ec2_68940_120x120_fill_box_smart1_3.png","permalink":"https://zcj-git520.github.io/p/go-%E5%88%87%E7%89%87%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/","title":"go åˆ‡ç‰‡çš„æ·±å…¥ç†è§£"},{"content":"ä¸ºä»€ä¹ˆå†™åšå®¢  æ€»ç»“å¼€å‘ä¸­é‡åˆ°çš„é—®é¢˜ã€‚å·¥ä½œè¿‡åå‘ç°è‡ªå·±å¹¶ä¸æ“…é•¿å¯¹çŸ¥è¯†ç‚¹çš„æ€»ç»“ï¼Œå¯¼è‡´æ€»æ˜¯é‡åˆ°ç›¸åŒçš„é—®é¢˜ï¼Œè¿‡æ®µæ—¶é—´éœ€è¦é‡æ–°æŸ¥æ‰¾è§£å†³æ–¹æ¡ˆ è®°å½•å­¦ä¹ çš„çŸ¥è¯†ï¼Œä¸æ–­çš„æ¸©ä¹ ã€‚å­¦çš„ä¸œè¥¿è¿‡äºç¢ç‰‡åŒ–ï¼Œå¯¼è‡´çŸ¥è¯†ä¸æˆä½“ç³»ã€‚æ—¶é—´é•¿äº†ï¼Œç¢ç‰‡çš„çŸ¥è¯†ä¹Ÿå¿˜è®°äº† æå‡è‡ªå·±çš„ä¸“ä¸šæŠ€èƒ½ã€‚é€šè¿‡å†™åšå®¢æå‡è‡ªå·±çš„èƒ½åŠ› å½¢æˆè‡ªå·±çš„æŠ€æœ¯æ ˆï¼Œé‡åˆ°çš„å¿—åŒé“åˆçš„æœ‹å‹  ä¸ºä»€ä¹ˆé€‰æ‹©hugoæ¥æ­å»ºè‡ªå·±çš„åšå®¢  Hugoæ˜¯ç”±Goè¯­è¨€å®ç°çš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨ã€‚ç®€å•ã€æ˜“ç”¨ã€é«˜æ•ˆã€æ˜“æ‰©å±•ã€å¿«é€Ÿéƒ¨ç½²ã€‚ æ“ä½œç®€å•ï¼Œä½¿ç”¨Markdownç›´æ¥ç”Ÿæˆé™æ€ç½‘é¡µ å…è´¹ä¸”ä»¥ç»´æŠ¤, åœ¨githubä¸Šå°±å¯ä¾›ä»–äººè®¿é—®ï¼Œæ— éœ€è´­ä¹°æœåŠ¡å™¨ï¼Œç»´æŠ¤ç®€å• å‘è¡¨æ–‡ç« ç›´æ¥pushåˆ°è‡ªå·±ä»“åº“å³å¯  ä¸‹è½½hogoçš„æºç   git clone https://github.com/gohugoio/hugo.git\ngit branch æŸ¥çœ‹å•å‰ä»£ç çš„åˆ†æ”¯\ngit branch -a æŸ¥çœ‹å…¨éƒ¨åˆ†æ”¯\ngit checkout branch åˆ‡æ¢åˆ†æ”¯\ngit branch åˆ†æ”¯å åˆ›å»ºè‡ªå·±çš„æœ¬åœ°åˆ†å­\n ç¼–è¯‘æºç   åœ¨masteråˆ†æ”¯ä¸‹ï¼Œåœ¨main.go çš„ç›®å½•ä¸‹ä½¿ç”¨å‘½ä»¤: go build åœ¨ç›®å½•ä¸‹ç”Ÿæˆhugo.exe åœ¨cmdä¸‹ä½¿ç”¨hugo æŸ¥çœ‹æ˜¯å¦ç¼–è¯‘æˆåŠŸ ç¼–è¯‘æˆåŠŸ ä¼šæ‰“å°hugoçš„ç‰ˆæœ¬ å®‰è£…æˆåŠŸ  ç”Ÿæˆç«™ç‚¹  ä½¿ç”¨å‘½ä»¤ï¼šhugo new site /ç›®å½• cd /ç›®å½• æŸ¥çœ‹åˆ°   â–¸ archetypes/ â–¸ content/ â–¸ layouts/ â–¸ static/ config.toml   åˆ›å»ºç«™ç‚¹æˆåŠŸ  åˆ›å»ºmdæ–‡ç«   ä½¿ç”¨å‘½ä»¤: hugo new æ–‡ç« å.md åœ¨content/ ä¸‹ç”Ÿæˆè¯¥mdæ–‡ä»¶  é€‰æ‹©åšå®¢ä¸»é¢˜æ¨¡æ¿  hugo æä¾›å¾ˆå¤šçš„ä¸»é¢˜åšå®¢æ¨¡æ¿ï¼šhttps://themes.gohugo.io/ åˆ›å»ºthemeæ–‡ä»¶å¤¹ï¼Œå°†ä¸»é¢˜æ¨¡æ¿æ”¾åœ¨é‡Œé¢ ï¼šmkdir themes è¿›å…¥è¯¥æ–‡ä»¶å¤¹ï¼šcd themes ä¸‹è½½ä¸»é¢˜ï¼Œä½¿ç”¨git clone ä¸»é¢˜æ¨¡æ¿ ï¼šgit clone https://github.com/spf13/hyde.git  é…ç½®config.tomlæ–‡ä»¶  config.toul æ–‡ä»¶hugo çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é…ç½®ä¸»é¢˜æ¨¡æ¿ï¼Œä¸ªäººä¿¡æ¯ç­‰(ä¸»é¢˜æ¨¡æ¿ä¸­ç›¸åº”çš„é…ç½®æ–‡ä»¶)å¦‚   baseurl = \u0026quot;http://****.com/\u0026quot; //å‘å¸ƒçš„ç½‘ç«™ languageCode = \u0026quot;ja\u0026quot; //ä½¿ç”¨çš„è¯­è¨€ title = \u0026quot;xxxx.COM\u0026quot; //ç½‘ç«™åç§°ç­‰ [Params] subtitle = \u0026quot;I would like to be a layer 3 switch.\u0026quot; facebook = \u0026quot;https://facebook.com/foobar\u0026quot; twitter = \u0026quot;https://twitter.com/foobar\u0026quot; github = \u0026quot;https://github.com/foobar\u0026quot; profile = \u0026quot;/images/profile.png\u0026quot; copyright = \u0026quot;Written by Asuka Suzuki\u0026quot; analytics = \u0026quot;UA-XXXXXXXX-X\u0026quot;    è¿è¡Œ æœ¬åœ°è¿è¡Œ  ä½¿ç”¨å‘½ä»¤ï¼šhugo server \u0026ndash;buildDrafts é…ç½®æ­£ç¡®åˆ™ä¼šå‡ºç°ï¼š http://localhost:1313/ (bind address 127.0.0.1) ç‚¹å‡»åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ  æ¨é€åˆ°gitgub  é¦–å…ˆåœ¨GitHubä¸Šåˆ›å»ºä¸€ä¸ªRepositoryï¼Œå‘½åä¸ºï¼šgithubç”¨æˆ·å.github.io ä¿®æ”¹config.toml é…ç½®æ–‡ä»¶ï¼šå°†baseurl = \u0026ldquo;http://githubç”¨æˆ·å.github.io\u0026rdquo; ä½¿ç”¨å‘½ä»¤ï¼šhugo \u0026ndash;buildDrafts åœ¨æœ¬åœ°ç”Ÿæˆpublicçš„æ–‡ä»¶å¤¹ \u0026ndash;buildDrafts å‚æ•°çš„ä¸»ç”¨æ˜¯å°†ä½ çš„æ–‡ç« åœ¨ä¸»é¢˜ä¸­å‡ºç°   cd public è¿›å…¥åˆ°publicæ–‡ä»¶å¤¹ $ git init åˆå§‹åŒ–æœ¬åœ°ä»“åº“ $ git remote add origin https://github.com/githubç”¨æˆ·å/githubç”¨æˆ·å.github.io //æ·»åŠ åŸåˆ›ä»“åº“ æˆ–è€…ç›´æ¥ git clone $ git add -A $ git commit -m \u0026quot;first commit\u0026quot; $ git push -u origin master //æ¨åˆ°è¿œç«¯   ä½¿ç”¨ \u0026ldquo;http://githubç”¨æˆ·å.github.io\u0026quot;å°±å¯è®¿é—®  ","date":"2021-09-04T10:05:40+08:00","permalink":"https://zcj-git520.github.io/p/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E4%BB%BD%E5%8D%9A%E5%AE%A2/","title":"æˆ‘çš„ç¬¬ä¸€ä»½åšå®¢"}]